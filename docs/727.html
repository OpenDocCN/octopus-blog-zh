<html>
<head>
<title>Dynamically setting TeamCity version numbers based on the current branch - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>基于当前分支机构- Octopus部署动态设置TeamCity版本号</h1>
<blockquote>原文：<a href="https://octopus.com/blog/teamcity-version-numbers-based-on-branches#2019-09-26">https://octopus.com/blog/teamcity-version-numbers-based-on-branches#2019-09-26</a></blockquote>
                        <p>当您使用TeamCity构建一个包含多个分支的项目时，根据分支的不同，最好有不同的构建号。例如，除了简单的TeamCity构建号，如<code>15</code>、<code>16</code>等等，您可能有:</p>

<ul>
<li>分支<code>master</code> : <code>1.6.15</code>。</li>
<li>分支<code>release-1.5</code> : <code>1.5.15</code>(从分支名称开始的主要/次要构建)。</li>
<li>分支<code>develop</code> : <code>2.0.15</code>(不同的次要构建)。</li>
<li>分支<code>feature-rainbows</code> : <code>2.0.15-rainbows</code>(特征分支为标签)。</li>
</ul>

<p>它看起来是这样的:</p>

<p><img src="../Images/2d5ea1890fb79b8cc585cb3c32839ba0.png" alt="TeamCity builds with build numbers based on the branch" data-original-src="https://i.octopus.com/blog/migrated/2014-11-13_10_38_55-Projects_--_TeamCity_rdnevn.png"/></p>

<p>处理像<a href="http://nvie.com/posts/a-successful-git-branching-model/"> GitFlow </a>这样的分支工作流，并使用这些版本格式，对于TeamCity来说是相当容易的，在这篇博文中，我将向你展示如何操作。您自己的版本控制策略可能会有所不同，但是希望这篇文章能够帮助您开始。</p>

<h2>背景</h2>

<p>首先，我们关心两个内置的TeamCity参数:</p>

<ul>
<li><code>build.counter</code>:这是自动递增的构建计数器(上面的15和16)。</li>
<li>这是完整的版本号。默认是<code>%build.counter%</code>，但可以更复杂。</li>
</ul>

<p><code>build.number</code>的格式和<code>build.counter</code>的值在TeamCity UI中定义:</p>

<p><img src="../Images/7ddc59e95d320789e98ada9f774ee54f.png" alt="Build number and build counter in TeamCity" data-original-src="https://i.octopus.com/blog/migrated/2014-11-13_10_41_36-Build_test_package_Configuration_--_TeamCity_gd5wvf.png"/></p>

<p>然而，您也可以在构建期间使用<a href="https://confluence.jetbrains.com/display/TCD7/Build+Script+Interaction+with+TeamCity">服务消息</a>动态设置它。也就是说，您的构建脚本可以将以下文本写入stdout:</p>

<pre><code>##teamcity[buildNumber '1.1.15']
</code></pre>

<p>这将覆盖内部版本号，然后新值将被传递给内部版本中的其余步骤。</p>

<h2>把它放在一起</h2>

<p>根据分支名称是<code>master</code>还是<code>develop</code>，我们将使用不同的主/次构建号。为此，我们将在TeamCity中定义两个参数。这些需要成为TeamCity中的<strong>系统</strong>参数，以便他们可以构建脚本。</p>

<p><img src="../Images/fc3bf95bd9374b51f76733354154ab63.png" alt="Adding the major/minor build number parameters" data-original-src="https://i.octopus.com/blog/migrated/2014-11-13_10_40_43-Build_test_package_Configuration_--_TeamCity_flqn4j.png"/></p>

<p>为了根据分支名称动态设置构建号，我将添加一个PowerShell脚本步骤作为我的构建中的第一个构建步骤:</p>

<p><img src="../Images/fdbd69249928285e521532e504e79f0d.png" alt="Using a PowerShell script build step to set the build number" data-original-src="https://i.octopus.com/blog/migrated/2014-11-13_10_44_22-Build_test_package_Configuration_--_TeamCity_ig52le.png"/></p>

<p>最后，下面是PowerShell脚本:</p>

<pre><code># These are project build parameters in TeamCity
# Depending on the branch, we will use different major/minor versions
$majorMinorVersionMaster = "%system.MajorMinorVersion.Master%"
$majorMinorVersionDevelop = "%system.MajorMinorVersion.Develop%"

# TeamCity's auto-incrementing build counter; ensures each build is unique
$buildCounter = "%build.counter%" 

# This gets the name of the current Git branch. 
$branch = "%teamcity.build.branch%"

# Sometimes the branch will be a full path, e.g., 'refs/heads/master'. 
# If so we'll base our logic just on the last part.
if ($branch.Contains("/")) 
{
  $branch = $branch.substring($branch.lastIndexOf("/")).trim("/")
}

Write-Host "Branch: $branch"

if ($branch -eq "master") 
{
 $buildNumber = "${majorMinorVersionMaster}.${buildCounter}"
}
elseif ($branch -eq "develop") 
{
 $buildNumber = "${majorMinorVersionDevelop}.${buildCounter}"
}
elseif ($branch -match "release-.*") 
{
 $specificRelease = ($branch -replace 'release-(.*)','$1')
 $buildNumber = "${specificRelease}.${buildCounter}"
}
else
{
 # If the branch starts with "feature-", just use the feature name
 $branch = $branch.replace("feature-", "")
 $buildNumber = "${majorMinorVersionDevelop}.${buildCounter}-${branch}"
}

Write-Host "##teamcity[buildNumber '$buildNumber']"
</code></pre>

<p>既然<code>%build.number%</code>是基于分支的，那么您的TeamCity构建就有了一个一致的构建号，可以在您的其余构建步骤中使用。例如，如果您使用的是OctoPack，那么内部版本号可以用作<code>OctoPackPackageVersion</code> MSBuild参数的值，这样您的NuGet包就可以匹配内部版本号。</p>

<h3>了解更多信息</h3>



                    
                    
</body>
</html>