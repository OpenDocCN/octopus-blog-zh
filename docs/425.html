<html>
<head>
<title>Multi-environment deployments with GitHub Actions and Octopus - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>使用GitHub操作和Octopus - Octopus部署的多环境部署</h1>
<blockquote>原文：<a href="https://octopus.com/blog/multi-environment-deployments-github-actions#2022-12-05">https://octopus.com/blog/multi-environment-deployments-github-actions#2022-12-05</a></blockquote>
                        <p>GitHub Actions允许开发人员在GitHub存储库中执行DevOps操作。GitHub社区维护集成了第三方工具和存储库的模板，如Jenkins或Amazon弹性容器注册中心(ECR)。</p>

<p>虽然GitHub Actions提供了一个包含的解决方案，但像Octopus Deploy这样的专用连续交付工具为您提供了一些好处，如环境、可视化环境的仪表板以及用于一致用户体验的标准化步骤模板库。</p>

<p>在本文中，我将向您展示如何在GitHub Actions工作流中构建Docker图像，将图像发布到Amazon Elastic Container Registry(ECR ),并使用Octopus将图像部署到Amazon Elastic Kubernetes Service(EKS)上的web应用程序。</p>

<h2 id="prerequisites">先决条件</h2>

<p>要跟进，您需要:</p>

<ul>
<li>亚马逊网络服务(AWS)帐户</li>
<li>GitHub账户</li>
</ul>

<p>这个帖子使用了<a href="https://github.com/OctopusSamples/octopus-underwater-app" rel="nofollow"> Octopus水下应用库</a>。您可以派生存储库并跟随它。或者，github-octopus分支包含完成本文步骤所需的模板文件。你必须用你自己的价值观来取代一些价值观，但我在这篇文章中列出了我的价值观作为参考。</p>

<h2 id="amazon-web-services-setup">亚马逊网络服务设置</h2>

<p>要为GitHub操作设置AWS，您需要创建一个访问键和一个ECR存储库来存储图像。</p>

<p>要创建访问密钥，请转到<strong>亚马逊控制台</strong>，然后<strong> IAM </strong>，然后<strong>用户</strong>、<code>[your user]</code>，然后<strong>安全凭证</strong>，然后<strong>创建访问密钥</strong>。</p>

<p>您的浏览器下载一个包含访问密钥ID和秘密访问密钥的文件。Jenkins使用这些值向Amazon认证。</p>

<p>要创建存储库，请转到<strong>亚马逊控制台</strong>，然后是<strong> ECR </strong>，然后是<strong>创建存储库</strong>。</p>

<p>您需要为发布的每个图像建立一个图像存储库。给存储库起一个您想让图像起的名字。</p>

<p>你会在<strong>亚马逊ECR </strong>下看到你的仓库，然后是<strong>仓库</strong>。记下它所在的区域，在URI场。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-03/multi-environment-deployments-github-actions/ecr-repository.png" class="zoom" data-title=""><img src="../Images/d2135610fe05d1ef8445094aabaa602e.png" class="img-fluid center" alt="ECR Repository" data-original-src="https://i.octopus.com/blog/2022-03/multi-environment-deployments-github-actions/ecr-repository.png"/>T2】</a></p>

<h3 id="aws-cluster-setup">AWS集群设置</h3>

<p>按照我们文章中的步骤在AWS中设置集群，<a href="https://octopus.com/blog/eks-cluster-aws">在AWS中创建EKS集群</a>。</p>

<h2 id="github-setup">GitHub设置</h2>

<p>对于这个示例，您使用一个示例web应用程序来显示名为simple-octo的水下章鱼动画。</p>

<p>在<code>https://github.com/OctopusSamples/octopus-underwater-app</code>分叉存储库。</p>

<p>转到<strong>设置</strong>，然后是<strong>机密</strong>，然后是<strong>新储存库机密</strong>。</p>

<ul>
<li><strong> REPO_NAME </strong> -您创建的AWS ECR存储库的名称</li>
<li><strong> AWS_ACCESS_KEY_ID </strong> -之前的访问密钥ID</li>
<li><strong>AWS _ SECRET _ ACCESS _ KEY</strong>-之前的秘密访问密钥</li>
<li><strong>八达通服务器</strong> -你的八达通服务器网址</li>
<li><strong> OCTOPUS_APIKEY </strong> -你的OCTOPUS实例APIKEY          <ul>
<li>要创建一个，进入<strong>你的用户名</strong>，然后<strong>个人资料</strong>，然后<strong>我的API密匙</strong>，然后<strong>新API密匙</strong></li>
</ul>
</li>
</ul>

<p>您需要在存储库中创建一个工作流文件。GitHub Actions工作流包含对代码库执行操作的说明。几个预构建的步骤模板允许您在代码存储库上执行许多不同的任务。在本例中，您使用一个step模板来构建代码并将其推送到AWS ECR存储库，然后从Octopus部署它。</p>

<p>在。根文件夹的github/workflow目录。将以下代码粘贴到main.yml文件中:</p>

<pre><code>on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

name: AWS ECR push

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest

    steps:
    - name: Install Octopus CLI
      uses: OctopusDeploy/install-octopus-cli-action@v1.1.1
      with:
          version: latest
    - name: Checkout
      uses: actions/checkout@v2

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-2

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v1

    - name: Build, tag, and push the image to Amazon ECR
      id: build-image
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        ECR_REPOSITORY: ${{ secrets.REPO_NAME }}
        IMAGE_TAG: "latest"

      run: |
        # Build a docker container and push it to ECR 
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
        echo "Pushing image to ECR..."
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
        echo "::set-output name=image::$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"

    - name: create Octopus release
      run: octo create-release --project underwater-octo-github --version 0.0.i --server=${{ secrets.OCTOPUS_SERVER }} --apiKey=${{ secrets.OCTOPUS_APIKEY }}

    - name: deploy Octopus release
      run: octo deploy-release --project underwater-octo-github --version=latest --deployto Development --server=${{ secrets.OCTOPUS_SERVER }} --apiKey=${{ secrets.OCTOPUS_APIKEY }}    


</code></pre>

<p>GitHub Actions在主分支的push或pull请求上创建一个动作。这些步骤包括检查代码、认证并登录AWS，然后构建、标记并把图像推送到Amazon ECR。GitHub Actions可以使用类似的step模板推送到其他云存储库，如Google或Microsoft。</p>

<p>提交您的更改并转到<strong>操作</strong>选项卡，然后单击提交消息的标题。您可以看到工作流程完成时的各个阶段。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-03/multi-environment-deployments-github-actions/githubactions-success.png" class="zoom" data-title=""><img src="../Images/de03e2ce8f6c78da1e9fcb2c02badb30.png" class="img-fluid center" alt="GitHub Actions Success" data-original-src="https://i.octopus.com/blog/2022-03/multi-environment-deployments-github-actions/githubactions-success.png"/>T2】</a></p>

<p>去你的Amazon ECR仓库查看图片。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-03/multi-environment-deployments-github-actions/ecr-success.png" class="zoom" data-title=""><img src="../Images/90c61ad130e7f91f53eae179ce6d336b.png" class="img-fluid center" alt="ECR Success" data-original-src="https://i.octopus.com/blog/2022-03/multi-environment-deployments-github-actions/ecr-success.png"/>【T34】T2】</a></p>

<h2 id="octopus-deploy-setup">Octopus部署设置</h2>

<p>在您的Octopus Deploy实例中，通过转到<strong>项目</strong>创建一个项目，然后<strong>添加项目</strong>。添加<code>aws-github</code>作为标题，点击<strong>保存</strong>。</p>

<p>通过前往<strong>基础设施</strong>，然后<strong>环境</strong>，然后<strong>添加环境</strong>来设置开发环境。给它起个名字，点击<strong>保存</strong>。</p>

<p>对测试和生产环境重复这些步骤。</p>

<p>然后，您需要设置Amazon帐户来部署到EKS。</p>

<p>转到<strong>基础设施</strong>，然后<strong>账户</strong>，然后<strong>添加账户</strong>，然后<strong> AWS账户</strong>。给它起个名字，并填写前面的<strong>访问密钥ID </strong>和<strong>秘密访问密钥</strong>。</p>

<p>通过转到<strong>基础设施</strong>，然后<strong>部署目标</strong>，然后<strong>添加部署目标</strong>，然后<strong> Kubernetes集群</strong>，然后<strong>添加</strong>，在Octopus Deploy中将您的AWS Kubernetes集群设置为部署目标。</p>

<p>您可以<a href="https://octopus.com/docs/infrastructure/deployment-targets#adding-deployment-targets">遵循我们的文档</a>中的步骤，这些文档指出了要添加的字段以设置部署目标。在本节中，您将为部署目标指定一个目标角色。这将在后面的Octopus部署步骤中引用。</p>

<h2 id="deploying-to-eks-step">部署到EKS步骤</h2>

<p>在您的<code>aws-github</code>项目中，转到<strong>流程</strong>，然后<strong>添加部署步骤</strong>，然后<strong> Kubernetes </strong>，然后<strong>部署Kubernetes容器</strong>。添加您之前分配给部署目标的目标角色。</p>

<p>将以下YAML添加到YAML部分:</p>

<pre><code>apiVersion: apps/v1
kind: Deployment
metadata:
  name: octopus-underwater-app-github
  labels:
    app: octopus-underwater-app
spec:
  selector:
    matchLabels:
        app: octopus-underwater-app
  replicas: 3
  strategy:
    type: RollingUpdate
  template:
    metadata:
      labels:
        app: octopus-underwater-app
    spec:
      containers:
        - name: octopus-underwater-app
          image: 720766170633.dkr.ecr.us-east-2.amazonaws.com/octopus-underwater-app:latest
          ports:
            - containerPort: 80
              protocol: TCP
          imagePullPolicy: Always

</code></pre>

<p>导航回Octopus实例<strong>项目概述</strong>以查看部署到开发环境的版本。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-03/multi-environment-deployments-github-actions/development-success.png" class="zoom" data-title=""> T45 </a></p>

<p>现在，当您准备好的时候，您就可以将产品发布到测试和生产环境中了。点击<strong>部署</strong>进行发布。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-03/multi-environment-deployments-github-actions/production-success.png" class="zoom" data-title=""> T50 </a></p>

<p>您需要本地端口转发来检查服务。使用此命令检查web应用程序。端口28015是根据Kubernetes文档中的示例选择的:</p>

<pre><code>kubectl port-forward deployment/octopus-underwater-app-github  28015:80
</code></pre>

<p>在浏览器中转到IP地址<code>http://127.0.0.1:28021/</code>查看您的web应用程序。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-03/multi-environment-deployments-github-actions/octopus-underwater-app.png" class="zoom" data-title=""><img src="../Images/d2a6013193a19547914dbd9ebcda334a.png" class="img-fluid center" alt="Octopus Underwater App" data-original-src="https://i.octopus.com/blog/2022-03/multi-environment-deployments-github-actions/octopus-underwater-app.png"/></a>T2】</p>

<h2 id="conclusion">结论</h2>

<p>在本文中，您使用GitHub Actions和Octopus Deploy将一个web应用程序部署到亚马逊EKS。当您使用Octopus Deploy作为CI/CD工具链中的一个阶段时，您将受益于一个专用的持续交付工具。</p>

<p>Octopus Deploy集成了几个云存储库，并内置了对发布管理的支持。GitHub Actions有社区开发的步骤模板。使用这些工具的体验可能因模板而异。通过其UI，Octopus Deploy为step模板提供了标准化的体验。Octopus还集成了不同的存储库和云提供商。</p>

<p>查看我们关于使用GitHub Actions、Kubernetes和Octopus Deploy进行部署的其他帖子:</p>



<p><a href="https://oc.to/GithubActionsWorkflowGenerator" rel="nofollow">试用我们免费的GitHub Actions工作流工具</a>，帮助您快速为您的GitHub Actions部署生成可定制的工作流。</p>

<p>您还可以了解更多关于使用GitHub构建<a href="https://octopus.com/github">和使用Octopus </a>部署的信息，并在GitHub Marketplace 中使用我们的<a href="https://github.com/marketplace?query=octopus&amp;type=actions&amp;verification=verified_creator" rel="nofollow">验证操作。</a></p>

<h2 id="watch-our-github-actions-webinar">观看我们的GitHub行动网络研讨会</h2>

<iframe src="https://www.youtube.com/embed/gLkAs_Cy5t4" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen="">VIDEO</iframe>

<p>阅读我们的<a href="https://octopus.com/blog/tag/CI%20Series">持续集成系列</a>的其余部分。</p>

<p>愉快的部署！</p>

                    
                    
</body>
</html>