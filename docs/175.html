<html>
<head>
<title>Booting Tomcat in Docker with the manager app - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>使用管理器应用程序- Octopus Deploy在Docker中启动Tomcat</h1>
<blockquote>原文：<a href="https://octopus.com/blog/deployable-tomcat-docker-containers#2021-08-12">https://octopus.com/blog/deployable-tomcat-docker-containers#2021-08-12</a></blockquote>
                        <p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-05/deployable-tomcat-docker-containers/tomcat-docker.png" class="zoom" data-title=""><img src="../Images/f3f41277df9533f3bc288c9dbfdee433.png" class="img-fluid center" alt="Booting Tomcat in Docker with the manager app" data-original-src="https://i.octopus.com/blog/2020-05/deployable-tomcat-docker-containers/tomcat-docker.png"/>T2】</a></p>

<p>当使用Tomcat测试Java部署时，官方的Tomcat Docker映像提供了一种方便的方法来启动和运行服务器。但是，要加载和访问管理器应用程序，有一些技巧。</p>

<p>在这篇博客文章中，我们将讨论如何引导Tomcat Docker映像来接受新的部署。</p>

<h2 id="define-a-user">定义用户</h2>

<p>首先，我们需要定义一个可以访问manager应用程序的Tomcat用户。该用户在名为<code>tomcat-users.xml</code>的文件中定义，将被分配<code>manager-gui</code>和<code>manager-script</code>角色，这两个角色授予对经理HTML界面以及API的访问权限:</p>

<pre><code class="language-xml">&lt;tomcat-users&gt;
  &lt;role rolename="manager-gui"/&gt;
  &lt;role rolename="manager-script"/&gt;
  &lt;user username="tomcat" password="s3cret" roles="manager-gui,manager-script"/&gt;
&lt;/tomcat-users&gt;
</code></pre>

<h2 id="expose-the-manager">揭发经理</h2>

<p>默认情况下，管理器应用程序将只接受来自<code>localhost</code>的流量。请记住，从Docker映像的上下文来看，<code>localhost</code>意味着容器的环回接口，而不是主机的环回接口。启用端口转发后，到公开端口的流量通过容器的外部接口进入Docker容器，默认情况下会被阻止。这里我们有一个禁用了网络过滤的管理器应用程序<code>context.xml</code>文件的副本:</p>

<pre><code class="language-xml">&lt;Context antiResourceLocking="false" privileged="true" &gt;
  &lt;!--
    &lt;Valve className="org.apache.catalina.valves.RemoteAddrValve"
         allow="127\.\d+\.\d+\.\d+|::1|0:0:0:0:0:0:0:1" /&gt;
  --&gt;
  &lt;Manager sessionAttributeValueClassNameFilter="java\.lang\.(?:Boolean|Integer|Long|Number|String)|org\.apache\.catalina\.filters\.CsrfPreventionFilter\$LruCache(?:\$1)?|java\.util\.(?:Linked)?HashMap"/&gt;     
&lt;/Context&gt;
</code></pre>

<p><a href="https://pythonspeed.com/articles/docker-connection-refused/" rel="nofollow">这篇博客文章</a>提供了更多关于码头工人与转发端口联网的细节。</p>

<h2 id="run-the-container">运行容器</h2>

<p>需要跨越的最后一个障碍是，Tomcat Docker映像默认情况下不加载任何应用程序。默认应用程序，如管理器应用程序，保存在一个名为<code>/usr/local/tomcat/webapps.dist</code>的目录中。我们需要将这个目录移动到<code>/usr/local/tomcat/webapps</code>。这是通过覆盖启动容器时使用的命令来实现的。</p>

<p>下面的命令映射我们上面创建的两个定制XML文件(在本例中保存到<code>/tmp</code>，将<code>/usr/local/tomcat/webapps.dist</code>移动到<code>/usr/local/tomcat/webapps</code>，最后启动Tomcat:</p>

<pre><code>sudo docker run \
  --name tomcat \
  -it \
  -p 8080:8080 \
  -v /tmp/tomcat-users.xml:/usr/local/tomcat/conf/tomcat-users.xml \
  -v /tmp/context.xml:/tmp/context.xml \
  tomcat:9.0 \
  /bin/bash -c "mv /usr/local/tomcat/webapps /usr/local/tomcat/webapps2; mv /usr/local/tomcat/webapps.dist /usr/local/tomcat/webapps; cp /tmp/context.xml /usr/local/tomcat/webapps/manager/META-INF/context.xml; catalina.sh run"
</code></pre>

<h2 id="access-the-manager-application">访问管理应用程序</h2>

<p>要打开管理器应用程序，请打开URL http://localhost:8080/manager/html。输入<code>tomcat</code>作为用户名，输入<code>s3cret</code>作为密码:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-05/deployable-tomcat-docker-containers/tomcat.png" class="zoom" data-title=""><img src="../Images/dc5226bafc39f81e202b226df0b84f5f.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2020-05/deployable-tomcat-docker-containers/tomcat.png"/></a>T2】</p>

<h2 id="conclusion">结论</h2>

<p>Tomcat映像维护人员选择不启用默认应用程序作为安全预防措施<a href="https://tomcat.apache.org/tomcat-9.0-doc/security-howto.html#Default_web_applications" rel="nofollow"/>，但是通过两个自定义配置文件和覆盖Docker命令，可以用一个全功能的管理器应用程序来引导Tomcat。</p>

<p>在本文中，我们提供了示例配置文件和Docker命令，以便在运行Tomcat之前恢复默认应用程序。</p>

                    
                    
</body>
</html>