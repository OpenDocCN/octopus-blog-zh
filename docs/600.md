# 发布、部署和可变快照- Octopus 部署

> 原文：<https://octopus.com/blog/releases-and-snapshots>

作为一个自动化的发布管理和部署解决方案，Octopus 区分了**项目**、**发布**和**部署**。

一个**项目**就像是一个模板，用来决定部署什么。它包含:

这个想法是你定义你的项目一次，然后创建这个项目的许多版本。

然后，一个**版本**仅仅是一个 NuGet 包的选择(ID 和版本)。由于一个项目可以有许多步骤，一个单一的发布通常会有许多包。例如,“Contoso 网站”项目的“1.0”版本可能会引用 NuGet 包“Contoso。Web.1.0.315.nupkg "和" Contoso。Mailer.1.0.201.nupkg "。

一个**部署**是当一个**版本**被部署到一个**环境**(比如开发、测试、试运行或生产)时发生的事情。单个版本可以在许多环境中部署多次。

这种设计的好处在于，您可以保证部署到测试环境中的包与部署到生产环境中的包是相同的。发布实际上是一个“发布候选”，它有一个系统跟踪的生命周期。Octopus web UI 允许您查看一个版本的生命周期——谁创建了它，谁将它部署到每个环境中。

## 快照

当**发布**被创建时，它是只读的。您可以编辑发行版本号(因为它实际上只是一个标签)和发行说明，但是一旦部署了一个发行版本，您就不能更改包的版本。

另一方面，一个项目的**可以被**编辑。您可能会决定更改项目变量。或者您可以决定添加一个新的步骤，即一个新的 NuGet 包来部署。

问题是，在编辑一个项目之后，当您试图部署一个旧版本时会发生什么？您可能已经创建了包含两个 NuGet 包的 1.0 版，并将其部署到 Staging。然后，有人通过添加要部署的新 NuGet 包来编辑项目。您的 1.0 版本没有为 NuGet 包选择版本，并且您没有在 Staging 中部署它，所以您也不想将它部署到生产中。

为了解决这个问题，Octopus 在创建一个版本时会创建一个项目步骤和变量的“快照”。您可以创建发布`1.0`，然后修改项目以准备发布`1.1`，而不中断发布`1.0`。对大多数人来说，这似乎很直观，因为它允许旧版本不受新版本变化的影响。该快照包含:

*   所有变量的副本
*   所有步骤的副本(获取包 ID 和版本)

## 令人惊讶的是

尽管仔细想想，这似乎是一种合乎逻辑的方法，但它有点出乎意料，容易让人措手不及。有人可能创建了一个版本，然后编辑了一个变量，但是当他们重新部署这个版本时，却发现这个新变量没有任何效果。答案很简单，就是**创建一个新的发布**(例如`1.0-patch1`)，这将导致任何更改都在一个新的快照中被拾取。

## 解决方法

Octopus 有两个变化来帮助解决这个问题。首先，当编辑步骤或变量时，我们将显示一个提示，告诉人们他们需要创建一个新的版本。这样，当重新部署没有任何效果时，就不会感到惊讶了。

其次，我正在想办法减少一个项目需要编辑的次数。一个常见的问题是，当您添加一台新机器时——比方说，一台新的生产前端 web 服务器来帮助处理负载——您需要编辑项目步骤，以指定您的 web 包必须部署到新机器上。这也意味着创建一个全新的版本。

将来，这些步骤将引用用户可定义的“角色”，如“网络服务器”、“电子邮件发送者”、“计算工作者”等。当您将机器添加到环境中时，您将能够将机器“标记”为服务于一个或多个这些角色。变量的工作原理是一样的，因为一个变量可以作用于一个角色。这样，机器可以在不影响任何现有版本的情况下从一个环境中进出。只需将机器添加到一个角色，重新部署当前版本，就可以开始了。

“角色”的引入对 Octopus 的架构来说是一个很大的改变，特别是因为我们需要确保现有的版本(包含直接指向机器的步骤的快照)在这个过程中不会被破坏。我正在一个分支机构中进行这一改变，随着进展，我将继续在博客上发表更多关于这一改变的内容。