<html>
<head>
<title>Running end-to-end tests in Jenkins - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>在Jenkins - Octopus部署中运行端到端测试</h1>
<blockquote>原文：<a href="https://octopus.com/blog/jenkins-running-endtoend-tests#2022-05-19">https://octopus.com/blog/jenkins-running-endtoend-tests#2022-05-19</a></blockquote>
                        <p>端到端(E2E)测试代表了自动化测试的最后阶段。E2E测试是长期运行的，尤其是与可以在几秒钟内完成数千次检查的单元测试相比。它们通常由外部工具执行，这些外部工具通过公共接口(如网页或HTTP APIs)与测试中的应用程序进行交互。</p>

<p>在本文中，您将学习如何使用Cypress运行E2E测试来验证与网页的交互，以及如何使用Newman(Postman的命令行测试运行程序)来验证HTTP APIs。</p>

<h2 id="prerequisites">先决条件</h2>

<p>要跟进这篇文章，您需要一个Jenkins实例。</p>

<p>有关在您选择的环境中安装Jenkins的说明，您可以参考我们的指南:</p>



<p>无论是<a href="https://www.cypress.io" rel="nofollow"> Cypress </a>还是<a href="https://learning.postman.com/docs/running-collections/using-newman-cli/command-line-integration-with-newman" rel="nofollow"> Newman </a>(邮差命令行测试运行器)都需要你安装Node.js，<a href="https://nodejs.org/en/download/" rel="nofollow"> Node.js网站</a>提供下载，或者提供<a href="https://nodejs.org/en/download/package-manager/" rel="nofollow">安装指导给包管理者</a>。</p>

<h2 id="how-to-run-browser-tests-with-cypress">如何用Cypress运行浏览器测试</h2>

<p>Cypress是一个浏览器自动化工具，它允许你以与最终用户非常相似的方式与网页交互，例如通过点击按钮和链接、填写表格和滚动页面。您还可以验证页面的内容，以确保显示正确的结果。</p>

<p><a href="https://docs.cypress.io/guides/getting-started/writing-your-first-test" rel="nofollow"> Cypress文档提供了一个第一次测试的例子</a>，它已经被保存到<a href="https://github.com/OctopusSamples/junit-cypress-test" rel="nofollow">JUnit-Cypress-test GitHub repo</a>中。测试如下所示:</p>

<pre><code class="language-javascript">describe('My First Test', () =&gt; {
  it('Does not do much!', () =&gt; {
    expect(true).to.equal(true)
  })
})
</code></pre>

<p>该测试被配置为在<code>cypress.json</code>文件中生成一个JUnit报告文件:</p>

<pre><code class="language-json">{
  "reporter": "junit",
   "reporterOptions": {
      "mochaFile": "cypress/results/results.xml",
      "toConsole": true
   }
}
</code></pre>

<p>Cypress作为开发依赖项包含在<code>package.json</code>文件中:</p>

<pre><code class="language-json">{
  "name": "cypress-test",
  "version": "0.0.1",
  "description": "A simple cypress test",
  "devDependencies": {
    "cypress": "8.6.0"
  }
}
</code></pre>

<p>您可以使用下面的管道运行Cypress测试:</p>

<pre><code class="language-groovy">pipeline {
  // This pipeline requires the following plugins:
  // * Git: https://plugins.jenkins.io/git/
  // * Workflow Aggregator: https://plugins.jenkins.io/workflow-aggregator/
  // * JUnit: https://plugins.jenkins.io/junit/
  agent 'any'
  stages {
    stage('Checkout') {
      steps {
        script {
            checkout([$class: 'GitSCM', branches: [[name: '*/master']], userRemoteConfigs: [[url: 'https://github.com/OctopusSamples/junit-cypress-test.git']]])
        }
      }
    }
    stage('Dependencies') {
      steps {
        sh(script: 'npm install')        
      }
    }
    stage('Test') {
      steps {
        sh(script: 'NO_COLOR=1 node_modules/.bin/cypress run || true')          
      }
    }
  }
  post {
    always {
      junit(testResults: 'cypress/results/results.xml', allowEmptyResults : true)
      archiveArtifacts(artifacts: 'cypress/videos/sample_spec.js.mp4', fingerprint: true) 
    }
  }
}
</code></pre>

<p><code>Dependencies</code>阶段将Cypress下载到项目目录:</p>

<pre><code class="language-groovy">    stage('Dependencies') {
      steps {
        sh(script: 'npm install')        
      }
    }
</code></pre>

<p><code>Test</code>阶段将<code>NO_COLOR</code>环境变量设置为<code>1</code>,从输出中去除ANSI颜色代码，然后运行Cypress。如果有任何测试失败，Cypress会返回一个非零的退出代码，但是我们通过追加<code>|| true</code>来确保该命令总是返回true，从而将构建通过或失败的决定推迟到测试处理器。</p>

<p>您可以在Jenkins 中的<a href="https://octopus.com/blog/jenkins-running-unit-tests">运行单元测试中了解更多关于处理失败测试的信息:</a></p>

<pre><code class="language-groovy">    stage('Test') {
      steps {
        sh(script: 'NO_COLOR=1 node_modules/.bin/cypress run || true')          
      }
    }
</code></pre>

<p><code>post</code>阶段处理JUnit报告文件，并将生成的测试视频保存为工件:</p>

<pre><code class="language-groovy">  post {
    always {
      junit(testResults: 'cypress/results/results.xml', allowEmptyResults : true)
      archiveArtifacts(artifacts: 'cypress/videos/sample_spec.js.mp4', fingerprint: true) 
    }
  }
</code></pre>

<p>然后，您可以使用公开单元测试的同一个接口深入研究测试结果:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-02/jenkins-running-endtoend-tests/cypress-test-result.png" class="zoom" data-title=""><img src="../Images/de2b597945f625224abd25da1a237e7e.png" class="img-fluid center" alt="Cypress test results" data-original-src="https://i.octopus.com/blog/2022-02/jenkins-running-endtoend-tests/cypress-test-result.png"/>T2】</a></p>

<p>视频工件捕获测试输出:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-02/jenkins-running-endtoend-tests/cypress-video.png" class="zoom" data-title=""><img src="../Images/f615f1d71a0efd89620976e03c117275.png" class="img-fluid center" alt="Cypress video" data-original-src="https://i.octopus.com/blog/2022-02/jenkins-running-endtoend-tests/cypress-video.png"/>T2】</a></p>

<h2 id="how-to-run-api-tests-with-newman">如何用Newman运行API测试</h2>

<p>Newman是Postman的命令行测试程序。测试脚本从Postman导出为JSON文件。查询GitHub API的示例已保存在<a href="https://github.com/OctopusSamples/junit-newman-test" rel="nofollow">JUnit-Newman-test GitHub Repo</a>中:</p>

<pre><code class="language-json">{
  "info": {
    "_postman_id": "f9b1443b-c23d-4738-901d-092cba2fc3d6",
    "name": "GitHub",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "GitHub API",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"response must be valid and have a body\", ",
              "function () {\n",
              " pm.response.to.be.ok;\n",
              " pm.response.to.be.withBody;\n",
              " pm.response.to.be.json;\n",
              "\n",
              " pm.expect(pm.response.json().quote != \"\").to.be.true;\n",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "http://api.github.com/repos/OctopusSamples/junit-newman-test/git/trees/main",
          "protocol": "http",
          "host": [
            "api",
            "github",
            "com"
          ],
          "path": [
            "repos",
            "OctopusSamples",
            "junit-newman-test",
            "git",
            "trees",
            "main"
          ]
        }
      },
      "response": []
    }
  ]
}
</code></pre>

<p>Newman作为开发依赖项保存在<code>package.json</code>文件中:</p>

<pre><code class="language-json">{
  "devDependencies": {
    "newman": "^5.3.0"
  }
}
</code></pre>

<p>您可以使用下面的管道运行Newman测试:</p>

<pre><code class="language-groovy">pipeline {
  // This pipeline requires the following plugins:
  // * Git: https://plugins.jenkins.io/git/
  // * Workflow Aggregator: https://plugins.jenkins.io/workflow-aggregator/
  // * JUnit: https://plugins.jenkins.io/junit/
  agent 'any'
  stages {
    stage('Checkout') {
      steps {
        script {
            checkout([$class: 'GitSCM', branches: [[name: '*/main']], userRemoteConfigs: [[url: 'https://github.com/OctopusSamples/junit-newman-test.git']]])
        }
      }
    }
    stage('Dependencies') {
      steps {
        sh(script: 'npm install')        
      }
    }
    stage('Test') {
      steps {
        sh(script: 'node_modules/.bin/newman run GitHubTree.json --reporters cli,junit --reporter-junit-export results.xml || true')          
      }
    }
  }
  post {
    always {
      junit(testResults: 'results.xml', allowEmptyResults : true)
    }
  }
}
</code></pre>

<p><code>Dependencies</code>阶段将纽曼下载到工作目录:</p>

<pre><code class="language-groovy">    stage('Dependencies') {
      steps {
        sh(script: 'npm install')        
      }
    }
</code></pre>

<p><code>Test</code>阶段运行Newman，使用<code>--reporters cli,junit</code>参数启用JUnit reporter，并使用<code>--reporter-junit-export results.xml</code>参数将结果保存为JUnit报告文件。</p>

<p>如果任何测试失败，Newman将返回一个非零的退出代码，因此为了将构建的成功或失败推迟到测试处理器，您需要确保命令总是使用<code>|| true</code>返回true。</p>

<p>您可以在<a href="https://octopus.com/blog/jenkins-running-unit-tests">在Jenkins中运行单元测试</a>中了解更多关于处理失败测试的信息:</p>

<pre><code class="language-groovy">    stage('Test') {
      steps {
        sh(script: 'node_modules/.bin/newman run GitHubTree.json --reporters cli,junit --reporter-junit-export results.xml || true')          
      }
    }
</code></pre>

<p><code>post</code>阶段处理JUnit报告文件:</p>

<pre><code class="language-groovy">  post {
    always {
      junit(testResults: 'results.xml', allowEmptyResults : true)
    }
  }
</code></pre>

<p>测试结果将通过Jenkins web用户界面提供:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-02/jenkins-running-endtoend-tests/newman-test-results.png" class="zoom" data-title=""><img src="../Images/a46f0d0fafc3951ed81c4d2f47125280.png" class="img-fluid center" alt="Newman Test Results" data-original-src="https://i.octopus.com/blog/2022-02/jenkins-running-endtoend-tests/newman-test-results.png"/>T2】</a></p>

<h2 id="conclusion">结论</h2>

<p>E2E测试允许您通过应用程序的公共接口来验证应用程序，作为自动化测试的最后阶段。与单元测试不同，E2E测试通常由外部工具来编排。例如，Cypress提供了通过web浏览器自动化交互的能力，Newman提供了用HTTP APIs编写脚本和验证交互的能力。</p>

<p>在本文中，您学习了如何:</p>

<ul>
<li>运行基于Cypress浏览器的测试</li>
<li>运行纽曼API测试</li>
<li>将结果收集为JUnit报告文件</li>
<li>处理测试结果</li>
</ul>

<p>试试我们免费的Jenkins管道生成器工具用Groovy语法创建一个管道文件。这是您启动管道项目所需的一切。</p>

<h2 id="watch-our-jenkins-pipeline-webinar">观看我们的詹金斯管道网络研讨会</h2>

<iframe src="https://www.youtube.com/embed/D_7AHTML_xw" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen="">VIDEO</iframe>

<p>我们定期举办网络研讨会。请参见<a href="https://octopus.com/events">网络研讨会第</a>页，了解关于即将举办的活动和实时流媒体录制的详细信息。</p>

<p>阅读我们的<a href="https://octopus.com/blog/tag/CI%20Series">持续集成系列</a>的其余部分。</p>

<p>愉快的部署！</p>

                    
                    
</body>
</html>