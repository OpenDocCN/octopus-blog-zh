<html>
<head>
<title>Using AWS Secrets Manager with Octopus - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>使用AWS Secrets Manager和Octopus - Octopus Deploy</h1>
<blockquote>原文：<a href="https://octopus.com/blog/using-aws-secrets-manager-with-octopus#2021-11-21">https://octopus.com/blog/using-aws-secrets-manager-with-octopus#2021-11-21</a></blockquote>
                        <p>我已经编写了几个step模板，扩展了Octopus的功能，以与秘密管理器集成，最后一个是<a href="https://octopus.com/blog/using-google-cloud-secret-manager-with-octopus"> Google Cloud Secret Manager </a>。在这篇文章中，我将介绍另一个主要的云提供商，Amazon Web Services (AWS)。</p>

<p>我浏览了<a href="https://library.octopus.com/step-templates/5d5bd3ae-09a0-41ac-9a45-42a96ee6206a/actiontemplate-aws-secrets-manager-retrieve-secrets" rel="nofollow">AWS Secrets Manager-Retrieve Secrets</a>步骤模板，该模板旨在从AWS Secrets Manager中检索机密，以便在您的部署或操作手册中使用。</p>



<h2 id="getting-started">入门指南</h2>

<p>这篇文章假设读者对定制步骤模板和Octopus社区库比较熟悉。</p>

<p>此外，这篇文章没有详细介绍AWS Secrets Manager的概念或如何设置Secrets Manager。你可以通过阅读亚马逊的<a href="https://docs.aws.amazon.com/secretsmanager/latest/userguide/intro.html" rel="nofollow">用户指南</a>了解更多信息。</p>

<p>本文中的步骤模板使用<strong> AWS命令行接口</strong> (AWS CLI)，从<a href="https://aws.amazon.com/secrets-manager/" rel="nofollow"> AWS秘密管理器</a>中检索秘密，这是一个AWS命令行工具。在该步骤能够成功检索机密之前，<strong> AWS CLI </strong>工具必须在部署目标或工作者上可用。step模板已经在Windows和Linux上测试过(安装了PowerShell核心)。</p>

<h2 id="authenticating-with-aws">向AWS认证</h2>

<p>在从AWS Secrets Manager中检索机密之前，您必须通过AWS的身份验证。在他们的<a href="https://docs.aws.amazon.com/secretsmanager/latest/userguide/auth-and-access.html" rel="nofollow">认证和访问控制指南</a>中，亚马逊描述了他们如何使用<a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/introduction.html" rel="nofollow"> IAM权限</a>来控制对秘密的访问:</p>

<blockquote class="blockquote">
<p>通过使用IAM权限策略，您可以控制哪些用户或服务可以访问您的机密。权限策略描述了谁可以对哪些资源执行哪些操作。</p>
</blockquote>

<p>在Octopus中，您可以使用具有适当权限的<a href="https://octopus.com/docs/infrastructure/accounts/aws"> AWS帐户</a>进行AWS认证。</p>

<p>要了解有关使用AWS Secrets Manager将IAM权限策略附加到机密或身份的更多信息，请查看<a href="https://docs.aws.amazon.com/secretsmanager/latest/userguide/auth-and-access_examples.html" class="alert-link" rel="nofollow">权限策略示例</a></p>


<h2 id="retrieving-secrets">找回秘密</h2>

<p><a href="https://library.octopus.com/step-templates/5d5bd3ae-09a0-41ac-9a45-42a96ee6206a/actiontemplate-aws-secrets-manager-retrieve-secrets" rel="nofollow"> AWS机密管理器-检索机密</a>步骤模板:</p>

<ul>
<li>从AWS机密管理器中检索一个或多个机密</li>
<li>从每个秘密中提取一个或多个键/值对</li>
<li>为检索到的每个键/值对创建敏感的输出变量</li>
</ul>

<p>像大多数云提供商一样，AWS Secrets Manager通过使用版本标识符和一个或多个分级标签来支持<a href="https://docs.aws.amazon.com/secretsmanager/latest/userguide/getting-started.html#term_version" rel="nofollow">版本化的机密</a>。这是有用的，因为它可以定期轮换你的秘密。</p>

<p>转移标签在循环过程中跟踪不同的版本。AWS秘密总是有一个带有分级标签<code>AWSCURRENT</code>的版本，这是当前的秘密值。</p>


<p>AWS Secrets Manager中的一个秘密可以存储多个值。Amazon建议使用带有键/值对的JSON文本字符串，例如:</p>

<pre><code class="language-json">{
  "hostname"   : "test01.example-database.net",
  "hostport"   : "3458",
  "user"       : "octo_admin_user",
  "pwd"        : "M4eXT4a$uPeA$3cRetP@s5w0rd!"
}
</code></pre>

<p>此步骤模板设计用于从一个或多个机密中检索多个键/值对。</p>

<p>检索单个机密及其键/值对需要:</p>

<ul>
<li>有权访问机密的AWS帐户</li>
<li>默认AWS <a href="https://docs.aws.amazon.com/general/latest/gr/rande.html#ec2_region" rel="nofollow">区域</a>代码</li>
<li>名称和<em>可选地</em>秘密的版本和存储在秘密中的特定键/值对的名称，以便为其创建变量</li>
</ul>

<p>step模板有一个高级特性，支持一次检索多个秘密。这需要在新的一行中输入每个秘密。</p>

<p>对于检索到的每个秘密和键/值对，创建一个<a href="https://octopus.com/docs/projects/variables/output-variables#sensitive-output-variables">敏感输出变量</a>用于后续步骤。默认情况下，任务日志中只会显示已创建变量的数量。要查看任务日志中的变量名，将<strong>打印输出变量名</strong>参数更改为<code>True</code>。</p>

<h3 id="parameters">步骤模板参数</h3>

<p>步骤模板使用以下参数:</p>

<ul>
<li><p><strong> AWS账户</strong>:一个<a href="https://octopus.com/docs/infrastructure/accounts/aws"> AWS账户</a>，有权限从秘密管理器中访问秘密。</p>
</li>
<li><p><strong> AWS区域</strong>:指定默认区域。查看<a href="https://docs.aws.amazon.com/general/latest/gr/rande.html#ec2_region" rel="nofollow"> AWS区域和端点</a>文档，获取可用区域代码的当前列表。</p>
</li>
<li><p><strong>要检索的机密名称</strong>:指定要从AWS Secrets Manager返回的机密名称，格式:<code>SecretName SecretVersionId SecretVersionStage | KeyNames | OutputVariableName</code>其中:</p>
<ul>
<li><strong> SecretName </strong>:要检索的秘密的名称。您可以指定机密的<code>Amazon Resource Name (ARN)</code>或友好名称。</li>
<li><strong> SecretVersionId </strong>:您想要检索的秘密版本的唯一标识符。如果未指定该值，则检索当前版本。</li>
<li><strong> SecretVersionStage </strong>:您想要通过附加到版本的staging标签检索的秘密版本。如果未指定该值，则使用默认的分段标签值<code>AWSCURRENT</code>。<em>注意:</em>如果未指定<strong> SecretVersionId </strong>，该值将被忽略。</li>
<li><strong> KeyNames </strong>:存储在您希望检索其值的秘密中的密钥的名称。可以检索由空格分隔的多个字段。或者，您可以使用特殊关键字<code>all</code>或<code>*</code>指定所有字段。</li>
<li><strong> OutputVariableName </strong>是<em>可选</em> Octopus <a href="https://octopus.com/docs/projects/variables/output-variables">输出变量</a>的名称，用于存储秘密值。如果指定了多个键/值对，则将键/值名称附加到该值。</li>
</ul>
<p>如果同时指定了<strong> SecretVersionId </strong>和<strong> SecretVersionStage </strong>，它们必须指向同一个秘密版本，否则AWS通常会返回一个<code>NotFound</code>错误。</p>

<p><strong>注:</strong>通过在新的一行中输入每个秘密，可以检索多个秘密。更多信息参见<a href="#secret-retrieval-examples">示例</a>。</p>
</li>
<li><p><strong>打印输出变量名</strong>:将章鱼<a href="https://octopus.com/docs/projects/variables/output-variables">输出变量名</a>写入任务日志。默认:<code>False</code>。</p>
</li>
</ul>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-11/using-aws-secrets-manager-with-octopus/aws-secrets-manager-retrieve-secrets-step-parameters.png" class="zoom" data-title=""><img src="../Images/b0b6235e41f4f6cd128b5ccb012d3cea.png" class="img-fluid center" alt="Parameters for the step" data-original-src="https://i.octopus.com/blog/2021-11/using-aws-secrets-manager-with-octopus/aws-secrets-manager-retrieve-secrets-step-parameters.png"/>T2】</a></p>

<h3 id="secret-retrieval-examples">秘密检索示例</h3>

<p>让我们以AWS Secrets Manager中存储的名为<strong>octo samples-user credentials</strong>的秘密为例，它有两个键/值对:</p>



<p>以下是检索机密及其键/值对的一些方法:</p>

<ol>
<li><p><code>OctoSamples-usercredentials | Username | octousername</code></p>
<p>这将检索秘密并从名为<code>Username</code>的键/值中提取值，并将其保存到名为<code>octousername</code>的敏感输出变量中。</p>
</li>
<li><p><code>OctoSamples-usercredentials | Username Password | octocreds</code></p>
<p>这将检索秘密，并从名为<code>Username</code>和<code>Password</code>的键/值中提取值，并将它们保存到名为<code>octocreds.Username</code>和<code>octocreds.Password</code>的两个敏感输出变量中。</p>
</li>
<li><p><code>OctoSamples-usercredentials | * | octocreds</code></p>
<p>这将检索秘密，并从秘密中提取所有键/值，并将它们保存到前缀为的敏感输出变量<em>中。</em></p>
</li>
<li><p><code>OctoSamples-usercredentials | all</code></p>
<p>这将检索秘密，并从秘密中提取所有键/值，并将它们保存到前缀为<code>OctoSamples-usercredentials</code>的敏感输出变量<em>。</em></p>
</li>
</ol>

<h3 id="using-the-step">使用步骤</h3>

<p><strong> AWS机密管理器-检索机密</strong>步骤以与其他步骤相同的方式添加到<a href="https://octopus.com/docs/projects/steps#adding-steps-to-your-deployment-processes">部署和运行手册流程中。</a></p>

<p>将步骤添加到流程后，填写步骤中的参数:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-11/using-aws-secrets-manager-with-octopus/aws-secrets-manager-retrieve-secrets-step-in-process.png" class="zoom" data-title=""><img src="../Images/2fc84394d36462146a371bf3e9df6436.png" class="img-fluid center" alt="AWS Secrets Manager - Retrieve Secrets step used in a process" data-original-src="https://i.octopus.com/blog/2021-11/using-aws-secrets-manager-with-octopus/aws-secrets-manager-retrieve-secrets-step-in-process.png"/>T2】</a></p>

<p>填写参数后，您可以在操作手册或部署流程中执行该步骤。在成功执行时，在匹配机密中找到的键/值对中的任何值都被存储为敏感的输出变量。如果将步骤配置为打印变量名，它们会出现在任务日志中:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-11/using-aws-secrets-manager-with-octopus/aws-secrets-manager-retrieve-secrets-step-output-variable.png" class="zoom" data-title=""><img src="../Images/0fb36bcdce4f0f2b3c2298f6403e7436.png" class="img-fluid center" alt="AWS Secrets Manager - Retrieve secrets step output variables task log" data-original-src="https://i.octopus.com/blog/2021-11/using-aws-secrets-manager-with-octopus/aws-secrets-manager-retrieve-secrets-step-output-variable.png"/>T2】</a></p>

<p>在后续步骤中，创建的输出变量可以在您的部署或runbook中使用。</p>

<p><strong>提示:</strong>对于任何输出变量名，记得用您的步骤名替换<code>AWS Secrets Manager - Retrieve Secrets</code>。</p>


<h2 id="conclusion">结论</h2>

<p>AWS Secrets Manager-Retrieve Secrets步骤模板演示了与AWS Secrets Manager集成并利用Octopus部署或runbooks中存储的秘密是很容易的。</p>

<p>愉快的部署！</p>

                    
                    
</body>
</html>