<html>
<head>
<title>Using GitLab feeds with Octopus Deploy - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>使用带有Octopus Deploy的GitLab提要</h1>
<blockquote>原文：<a href="https://octopus.com/blog/gitlab-external-feeds#2022-07-18">https://octopus.com/blog/gitlab-external-feeds#2022-07-18</a></blockquote>
                        <p>Octopus Deploy有一个<a href="https://octopus.com/docs/packaging-applications/package-repositories/built-in-repository">内置存储库</a>，支持多种<a href="https://octopus.com/docs/packaging-applications#supported-formats">包类型</a>。然而，一些客户更喜欢使用第三方存储库，或者使用内置于他们的持续集成(CI)工具中的存储库。</p>

<p>在这篇文章中，我演示了如何使用GitLab的内置注册表作为外部提要来使用Octopus部署您的项目。</p>

<h2 id="gitlab-registries">GitLab注册表</h2>

<p>GitLab支持多种注册表类型:</p>

<ul>
<li>包注册表</li>
<li>集装箱登记处</li>
<li>基础设施注册</li>
</ul>

<p>在本文中，我将介绍包和容器注册。</p>

<h3 id="package-registry">包注册表</h3>

<p><a href="https://docs.gitlab.com/ee/user/packages/package_registry/" rel="nofollow"> GitLab包注册表</a>支持多种包类型，但是，Octopus只支持以下GitLab包注册表类型作为外部提要:</p>



<h4 id="maven">专家</h4>

<p>Maven存储库通常与Java应用程序相关联，尽管它们可以更通用地使用(稍后将详细介绍)。我们的<a href="https://bitbucket.org/octopussamples/petclinic/src/master/" rel="nofollow"> PetClinic </a>示例应用程序包含了演示GitLab的Maven注册功能所需的大部分组件。唯一缺少的是向Maven注册中心认证的机制。<a href="https://docs.gitlab.com/ee/user/packages/maven_repository/#create-maven-packages-with-gitlab-cicd-by-using-maven" rel="nofollow"> GitLab的文档</a>向您展示了如何通过添加一个包含以下内容的<code>ci_settings.xml</code>文件来轻松实现这一点:</p>

<pre><code class="language-xml">&lt;settings  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.1.0 http://maven.apache.org/xsd/settings-1.1.0.xsd"&gt;
  &lt;servers&gt;
    &lt;server&gt;
      &lt;id&gt;gitlab-maven&lt;/id&gt;
      &lt;configuration&gt;
        &lt;httpHeaders&gt;
          &lt;property&gt;
            &lt;name&gt;Job-Token&lt;/name&gt;
            &lt;value&gt;${env.CI_JOB_TOKEN}&lt;/value&gt;
          &lt;/property&gt;
        &lt;/httpHeaders&gt;
      &lt;/configuration&gt;
    &lt;/server&gt;
  &lt;/servers&gt;
&lt;/settings&gt;
</code></pre>

<p>添加这些内容之后，您就可以定义您的构建定义了。</p>

<p>GitLab使用基于YAML的方法来配置构建定义。下面是PetClinic应用程序的示例构建定义:</p>

<pre><code class="language-yaml">stages:
    - set-version
    - java-build
    - maven-push

set-version:
  stage: set-version
  tags:
    - shell
  script:
    - dayOfYear=$(date +%j)
    - hour=$(date +%H)
    - minutes=$(date +%M)
    - seconds=$(date +%S)
    - year=$(date +%y)
    - echo "1.0.$year$dayOfYear.$hour$minutes$seconds" &gt;&gt; version.txt
  artifacts:
    paths:
      [ version.txt ]

java-build:
  stage: java-build
  tags:
    - shell
  script:
    - VERSION_NUMBER=$(cat version.txt)
    - mvn clean package -DskipTests=true -Dproject.versionNumber=$VERSION_NUMBER
  artifacts:
    paths:
      - "$CI_PROJECT_DIR/target/*.war"

maven-push:
  stage: maven-push
  tags:
    - shell
  variables:
    GROUP: "com.octopus"
    VERSION: $VERSION_NUMBER
    REPO_PROJECT_ID: $CI_PROJECT_ID
  script:
    - VERSION_NUMBER=$(cat version.txt)
    - mvn deploy:deploy-file -s ci_settings.xml -DgroupId=$GROUP 
      -Dversion=$VERSION_NUMBER
      -Dfile=$CI_PROJECT_DIR/target/petclinic.web.$VERSION_NUMBER.war
      -Durl=${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/maven
      -DrepositoryId=gitlab-maven
      -DpomFile=pom.xml
    - zip -r $CI_PROJECT_DIR/petclinic.mysql.flyway.$VERSION_NUMBER.zip $CI_PROJECT_DIR/flyway
    - mvn deploy:deploy-file -s ci_settings.xml
      -DgroupId=$GROUP
      -DartifactId=petclinic.mysql.flyway
      -Dpackaging=zip
      -Dfile=$CI_PROJECT_DIR/petclinic.mysql.flyway.$VERSION_NUMBER.zip
      -DrepositoryId=gitlab-maven
      -Durl=${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/maven
      -DartifactId=petclinic.mysql.flyway
      -Dversion=$VERSION_NUMBER
</code></pre>

<p>PetClinic应用程序由两个主要组件组成:</p>

<ul>
<li>Java web应用程序</li>
<li><a href="https://flywaydb.org/" rel="nofollow"> Flyway </a>，用于执行数据库更新</li>
</ul>

<p>要使用Octopus部署这两者，首先需要将它们添加到Maven注册表中，这样Octopus就可以找到并部署它们。</p>

<p>构建定义的<code>maven-push</code>部分是工件上传到Maven注册中心的地方。注意，脚本部分定义了2个<code>mvn deploy:deploy-file</code>命令。第一个<code>deploy</code>命令将在<code>java-build</code>阶段编译的<code>.war</code>文件上传到注册表。</p>

<p>与web组件不同，Flyway已经编译好了，你只需要压缩然后上传到注册表。<code>zip</code>命令压缩<code>flyway</code>文件夹的内容。</p>

<p>接下来，使用马特·卡斯珀森在<a href="https://octopus.com/blog/deploy-and-consume-zip-files-from-maven">上发布的关于从Maven </a>部署和使用ZIP文件的指导，将<code>.zip</code>文件上传到Maven注册表。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-07/gitlab-external-feeds/gitlab-maven-packages.png" class="zoom" data-title=""><img src="../Images/83769064f41138bf59a542d1b44da66a.png" class="img-fluid center" alt="package registry showing 2 packages" data-original-src="https://i.octopus.com/blog/2022-07/gitlab-external-feeds/gitlab-maven-packages.png"/>T2】</a></p>

<h4 id="nuget">努格特</h4>

<p>因为。NET应用程序中，最常用的注册表类型是NuGet。的。NET core示例应用程序<a href="https://github.com/OctopusSamples/OctoPetShop" rel="nofollow"> OctoPetShop </a>很适合这个演示。</p>

<p>使用以下构建定义(该定义利用了GitLab的Docker-in-Docker (DIND)特性):</p>

<pre><code class="language-yaml">image: ubuntu:latest

stages:
    - set-version
    - build-dotnet
    - package-dotnet
    - push-packages

set-version:
  stage: set-version
  script:
    - dayOfYear=$(date +%j)
    - hour=$(date +%H)
    - minutes=$(date +%M)
    - seconds=$(date +%S)
    - year=$(date +%y)
    - echo "1.0.$year$dayOfYear.$hour$minutes$seconds" &gt;&gt; version.txt
  artifacts:
    paths:
      [ version.txt ]

build-dotnet:
  stage: build-dotnet
  image: mcr.microsoft.com/dotnet/core/sdk:3.1
  script:
    - VERSION_NUMBER=$(cat version.txt)
    - dotnet build OctopusSamples.OctoPetShop.Database/OctopusSamples.OctoPetShop.Database.csproj --output "$CI_PROJECT_DIR/output/OctopusSamples.OctoPetShop.Database"
    - dotnet publish OctopusSamples.OctoPetShop.ProductService/OctopusSamples.OctoPetShop.ProductService.csproj --output "$CI_PROJECT_DIR/output/OctopusSamples.OctoPetShop.ProductService"
    - dotnet publish OctopusSamples.OctoPetShop.ShoppingCartService/OctopusSamples.OctoPetShop.ShoppingCartService.csproj --output "$CI_PROJECT_DIR/output/OctopusSamples.OctoPetShop.ShoppingCartService"
    - dotnet publish OctopusSamples.OctoPetShop.Web/OctopusSamples.OctoPetShop.Web.csproj --output "$CI_PROJECT_DIR/output/OctopusSamples.OctoPetShop.Web"

  artifacts:
    paths:
      - "$CI_PROJECT_DIR/output/"

package-dotnet:
  stage: package-dotnet
  image: octopuslabs/gitlab-octocli
  script: 
    - VERSION_NUMBER=$(cat version.txt)
    - octo pack --id=OctopusSamples.OctoPetShop.ProductService --version=$VERSION_NUMBER --basePath="$CI_PROJECT_DIR/output/OctopusSamples.OctoPetShop.ProductService" --outFolder="$CI_PROJECT_DIR/packages" --format="NuPkg"
    - octo pack --id=OctopusSamples.OctoPetShop.Database --version=$VERSION_NUMBER --basePath="$CI_PROJECT_DIR/output/OctopusSamples.OctoPetShop.Database" --outFolder="$CI_PROJECT_DIR/packages" --format="NuPkg"
    - octo pack --id=OctopusSamples.OctoPetShop.ShoppingCartService --version=$VERSION_NUMBER --basePath="$CI_PROJECT_DIR/output/OctopusSamples.OctoPetShop.ShoppingCartService" --outFolder="$CI_PROJECT_DIR/packages" --format="NuPkg"
    - octo pack --id=OctopusSamples.OctoPetShop.Web --version=$VERSION_NUMBER --basePath="$CI_PROJECT_DIR/output/OctopusSamples.OctoPetShop.Web" --outFolder="$CI_PROJECT_DIR/packages" --format="NuPkg"
  artifacts:
    paths:
      - "$CI_PROJECT_DIR/packages/"


push-packages:
  stage: push-packages
  image: mcr.microsoft.com/dotnet/core/sdk:3.1
  script:
    - dotnet nuget add source "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/nuget/index.json" --name gitlab --username gitlab-ci-token --password $CI_JOB_TOKEN --store-password-in-clear-text
    - dotnet nuget push "$CI_PROJECT_DIR/packages/*.nupkg" --source gitlab
</code></pre>

<p>默认情况下，web应用程序的<code>IsPackable</code>属性设置为false。您可以使用Octopus Deploy GitLab CLI映像将编译后的应用程序打包到NuGet包中，而不是弄乱项目属性。在创建了<code>.nupkg</code>文件之后，可以使用<code>dotnet</code>命令将包推入GitLab NuGet注册表。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-07/gitlab-external-feeds/gitlab-nuget-packages.png" class="zoom" data-title=""><img src="../Images/2554e12a4512989cd653d57cc17cde37.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2022-07/gitlab-external-feeds/gitlab-nuget-packages.png"/>T2】</a></p>

<h3 id="container-registry">集装箱登记处</h3>

<p>除了包注册表，GitLab还有一个容器注册表。为了演示如何使用容器注册中心，您可以再次使用OctoPetShop应用程序:</p>

<pre><code class="language-yaml">image: ubuntu:latest

stages:
    - set-version
    - build-docker

set-version:
  stage: set-version
  script:
    - dayOfYear=$(date +%j)
    - hour=$(date +%H)
    - minutes=$(date +%M)
    - seconds=$(date +%S)
    - year=$(date +%y)
    - echo "1.0.$year$dayOfYear.$hour$minutes$seconds" &gt;&gt; version.txt
  artifacts:
    paths:
      [ version.txt ]

build-docker:
    stage: build-docker
    image: docker:1.11
    services:
      - docker:dind
    before_script:
      - docker info
    script:
      - VERSION_NUMBER=$(cat version.txt)
      - docker build -t $CI_REGISTRY/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/octopetshop.database:$VERSION_NUMBER ./OctopusSamples.OctoPetShop.Database/ 
      - docker build -t $CI_REGISTRY/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/octopetshop.productservice:$VERSION_NUMBER ./OctopusSamples.OctoPetShop.ProductService/ 
      - docker build -t $CI_REGISTRY/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/octopetshop.shoppingcartservice:$VERSION_NUMBER ./OctopusSamples.OctoPetShop.ShoppingCartService/ 
      - docker build -t $CI_REGISTRY/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/octopetshop.web:$VERSION_NUMBER ./OctopusSamples.OctoPetShop.Web/ 
      - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
      - docker push $CI_REGISTRY/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/octopetshop.database:$VERSION_NUMBER
      - docker push $CI_REGISTRY/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/octopetshop.productservice:$VERSION_NUMBER
      - docker push $CI_REGISTRY/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/octopetshop.shoppingcartservice:$VERSION_NUMBER
      - docker push $CI_REGISTRY/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/octopetshop.web:$VERSION_NUMBER
</code></pre>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-07/gitlab-external-feeds/gitlab-container-packages.png" class="zoom" data-title=""><img src="../Images/6f813fab21f23f364fea8245d2496883.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2022-07/gitlab-external-feeds/gitlab-container-packages.png"/>T2】</a></p>

<h2 id="connecting-gitlab-registries-as-external-feeds">将GitLab注册表作为外部提要进行连接</h2>

<p>除了内置的存储库之外，Octopus Deploy还支持使用<a href="https://octopus.com/docs/packaging-applications/package-repositories">外部提要</a>来获取用于部署的包。</p>

<p>要添加外部提要，请转到您的Octopus仪表盘，点击<strong>库</strong>，然后点击<strong>外部提要</strong>，再点击<strong>添加提要</strong>。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-07/gitlab-external-feeds/octopus-add-external-feed.png" class="zoom" data-title=""><img src="../Images/9d75aa3b3635be235e1fd1ab76f3241c.png" class="img-fluid center" alt="Octopus dashboard on Library tab with External Feeds and ADD FEED highlighted in the UI." data-original-src="https://i.octopus.com/blog/2022-07/gitlab-external-feeds/octopus-add-external-feed.png"/>T2】</a></p>

<h3 id="adding-a-gitlab-maven-feed">添加GitLab Maven提要</h3>

<p>要添加GitLab Maven注册表，您需要与提要相关联的项目或组ID。这篇文章展示了项目的水平。要获取项目ID，请在GitLab中导航到该项目，ID会显示在初始屏幕上:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-07/gitlab-external-feeds/gitlab-project-id.png" class="zoom" data-title=""><img src="../Images/d270b9a4e4960fb6f0d13430a4293f0c.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2022-07/gitlab-external-feeds/gitlab-project-id.png"/>T2】</a></p>

<p>填写Octopus中的表单字段:</p>

<ul>
<li><strong>进给类型</strong> : <code>Maven Feed</code></li>
<li><strong> Name </strong>:给feed起一个名字，比如<code>GitLab Petclinic Maven Feed</code></li>
<li><strong>网址</strong> : <code>https://[gitlabserver]/api/v4/projects/[project or group id]/packages/maven</code></li>
<li>(可选)<strong>凭证</strong>:访问提要的用户名和密码</li>
</ul>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-07/gitlab-external-feeds/octopus-add-maven-feed.png" class="zoom" data-title=""><img src="../Images/a26cc525dc16d768ffd5f29d3ad2701c.png" class="img-fluid center" alt="Octopus dashboard showing Create Feeds screen under External Feeds section" data-original-src="https://i.octopus.com/blog/2022-07/gitlab-external-feeds/octopus-add-maven-feed.png"/>T2】</a></p>

<p>点击<strong>保存并测试</strong>以确保进给功能正常。使用“组:工件”格式输入包的名称。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-07/gitlab-external-feeds/octopus-test-maven-feed.png" class="zoom" data-title=""><img src="../Images/045fa213a355d0a6adf9a9aac4d50ed7.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2022-07/gitlab-external-feeds/octopus-test-maven-feed.png"/>T2】</a></p>

<h3 id="adding-a-gitlab-nuget-feed">添加GitLab NuGet提要</h3>

<p>与Maven提要类似，您需要与提要相关联的项目或组ID。</p>

<p>填写表单字段:</p>

<ul>
<li><strong>进给类型</strong> : <code>NuGet Feed</code></li>
<li><strong>名称</strong>:给提要起一个名字，例如<code>GitLab OctoPetShop Nuget Feed</code></li>
<li><strong>网址</strong> : <code>https://[gitlabserver]/api/v4/projects/[project or group id]/packages/nuget/index.json</code></li>
<li>(可选)<strong>凭证</strong>:访问提要的用户名和密码</li>
</ul>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-07/gitlab-external-feeds/octopus-add-nuget-feed.png" class="zoom" data-title=""><img src="../Images/16172b35b85e291a002a964b873dcd4b.png" class="img-fluid center" alt="Octopus dashboard showing Create Feeds screen under External Feeds section" data-original-src="https://i.octopus.com/blog/2022-07/gitlab-external-feeds/octopus-add-nuget-feed.png"/>T2】</a></p>

<p>点击<strong>保存并测试</strong>以确保进给功能正常。输入包的名称(可以是部分名称):</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-07/gitlab-external-feeds/octopus-test-nuget-feed.png" class="zoom" data-title=""><img src="../Images/c59166372a49fb9c353aed20d39b90c1.png" class="img-fluid center" alt="Octopus External Feed" data-original-src="https://i.octopus.com/blog/2022-07/gitlab-external-feeds/octopus-test-nuget-feed.png"/>T2】</a></p>

<h3 id="adding-a-gitlab-container-feed">添加GitLab容器提要</h3>

<p>与其他两种提要类型不同，容器提要不需要项目或组ID。但是，它确实需要知道服务器上的哪个端口被配置为托管容器注册中心。</p>

<p>填写表单字段:</p>

<ul>
<li><strong>进给类型</strong> : <code>Docker Container Registry</code></li>
<li><strong>名称</strong>:给feed起一个名字，比如<code>GitLab Container Registry</code></li>
<li><strong>网址</strong> : <code>https://[gitlabserver]:[port]</code></li>
<li><strong>凭证</strong>:访问提要的用户名和密码</li>
</ul>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-07/gitlab-external-feeds/octopus-add-container-feed.png" class="zoom" data-title=""><img src="../Images/96a48b69cb89b033cc66e3f8c4ab16a0.png" class="img-fluid center" alt="Octopus dashboard showing Create Feeds screen under External Feeds section" data-original-src="https://i.octopus.com/blog/2022-07/gitlab-external-feeds/octopus-add-container-feed.png"/>T2】</a></p>

<p>点击<strong>保存并测试</strong>以确保进给功能正常。输入包的名称(可以是部分名称):</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-07/gitlab-external-feeds/octopus-test-container-feed.png" class="zoom" data-title=""><img src="../Images/81874a4491f6ee0a0d8688e4b38aa42c.png" class="img-fluid center" alt="Octopus External Feed" data-original-src="https://i.octopus.com/blog/2022-07/gitlab-external-feeds/octopus-test-container-feed.png"/>T2】</a></p>

<h2 id="conclusion">结论</h2>

<p>在许多情况下，使用Octopus Deploy的内置存储库会让您受益匪浅。但是，如果你需要跨空间的东西，又不想重复，也有替代方案。在这篇文章中，我向您展示了如何使用GitLab的内置注册表作为外部提要来使用Octopus部署您的项目。</p>

<p>愉快的部署！</p>

                    
                    
</body>
</html>