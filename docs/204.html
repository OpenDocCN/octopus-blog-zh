<html>
<head>
<title>Deploying to Google Cloud Run - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>部署到Google Cloud Run - Octopus部署</h1>
<blockquote>原文：<a href="https://octopus.com/blog/deploying-to-google-cloud-run#2022-07-05">https://octopus.com/blog/deploying-to-google-cloud-run#2022-07-05</a></blockquote>
                        <p>Google Cloud Run是谷歌云平台(GCP)上相对较新的平台即服务(PaaS)产品。它允许您运行和缩放容器图像，同时只为处理请求的时间付费。</p>

<p>在本文中，我将介绍如何在Cloud Run中部署一个示例应用程序，并使用流量整形规则来执行部署策略，如feature branches、canary和blue/green。</p>

<h2 id="deploying-a-sample-application">部署示例应用程序</h2>

<p>让我们从部署一个名为<a href="https://github.com/OctopusSamples/RandomQuotes-Java" rel="nofollow">随机报价</a>的示例应用程序开始。这个Java Spring web应用程序已经被推送到Docker Hub，我在撰写本文时使用的最新标签是<code>octopussamples/randomquotesjava:0.1.189</code>。</p>

<p>当部署到Cloud Run时，您需要从将Docker映像推送到Google容器注册中心(GCR)开始。云运行不支持外部注册表。</p>

<p>使用传统的<code>docker</code> CLI工具，您可以使用以下命令拉和推映像，确保用包含您的云运行服务的项目ID替换<code>cloudrun-314201</code>:</p>

<pre><code>docker pull octopussamples/randomquotesjava:0.1.189
docker tag octopussamples/randomquotesjava:0.1.189 gcr.io/cloudrun-314201/randomquotesjava:0.1.189
docker push gcr.io/cloudrun-314201/randomquotesjava:0.1.189
</code></pre>

<p>其他像<code>skopeo</code>这样的工具复制Docker图片更方便。以下命令会将映像从Docker Hub注册表直接复制到GCR:</p>

<pre><code>skopeo copy docker://octopussamples/randomquotesjava:0.1.189 docker://gcr.io/cloudrun-314201/randomquotesjava:0.1.189
</code></pre>

<p>如果您尝试从外部注册表引用Docker映像，您会收到以下错误:</p>
<pre><code>ERROR: (gcloud.beta.run.services.replace) Expected a Container Registry image path like [region.]gcr.io/repo-path[:tag and/or @digest] or an Artifact Registry image path like [region-]docker.pkg.dev/repo-path[:tag and/or @digest], but obtained octopussamples/randomquotesjava:0.1.189
</code></pre>


<p>接下来，在名为<code>service.yaml</code>的文件中定义服务YAML资源。</p>

<p>如果你熟悉库伯内特，YAML的结构看起来会很熟悉。它遵循所有Kubernetes资源使用的<code>apiVersion</code>、<code>kind</code>、<code>metadata</code>和<code>spec</code>布局。事实上，您在这里定义的服务是<a href="https://knative.dev/docs/reference/api/serving-api/" rel="nofollow"> Knative </a>的一部分，因为Cloud Run是Knative服务的托管实现:</p>

<pre><code class="language-yaml">apiVersion: serving.knative.dev/v1
kind: Service
metadata:
  name: randomquotes
spec:
  template:
    spec:
      containers:
        - image: gcr.io/cloudrun-314201/randomquotesjava:0.1.189
          ports:
            - name: http1
              containerPort: 80
</code></pre>

<ul>
<li>属性定义了服务的名称。</li>
<li>属性引用了我们复制到GCR的Docker图像。</li>
<li>可以将<code>spec.template.spec.containers[0].ports.name</code>属性设置为<code>h2c</code>来表示端口由HTTP2公开，或者设置为<code>http1</code>来表示端口由HTTP1公开。</li>
<li><code>spec.template.spec.containers[0].ports.containerPort</code>属性定义了容器公开的接收web流量的端口。</li>
</ul>

<p>要部署此服务，请运行命令:</p>

<pre><code class="language-bash">gcloud beta run services replace service.yaml --platform managed
</code></pre>

<p>部署服务后，您会收到一个类似于<code>https://randomquotes-5od2layuca-ts.a.run.app</code>的URL，可以用来访问它。打开URL可能会导致显示以下错误:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-08/deploying-to-google-cloud-run/forbidden.png" class="zoom" data-title=""><img src="../Images/e3dca87a8a5a4f465f729dd425d71232.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2021-08/deploying-to-google-cloud-run/forbidden.png"/>T2】</a></p>

<p>解决方案是给<code>allUsers</code>用户<code>Cloud Run Invoker</code>权限:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-08/deploying-to-google-cloud-run/permissions.png" class="zoom" data-title=""><img src="../Images/160470c9bc620d515a9b657c8609d7a5.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2021-08/deploying-to-google-cloud-run/permissions.png"/>T2】</a></p>

<p>然后，您可以打开您的web应用程序:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-08/deploying-to-google-cloud-run/randomquotes.png" class="zoom" data-title=""><img src="../Images/524a5a9d6e295ed1769accb5d462612a.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2021-08/deploying-to-google-cloud-run/randomquotes.png"/>T2】</a></p>

<h2 id="feature-branch-deployments">功能分支部署</h2>

<p>要部署从功能分支创建的映像，首先将其复制到GCR。这里您有一个带有标签<code>0.1.200-blueheader</code>的特征分支图像，您可以使用命令将它复制到GCR:</p>

<pre><code>skopeo copy docker://octopussamples/randomquotesjava:0.1.200-blueheader docker://gcr.io/cloudrun-314201/randomquotesjava:0.1.200-blueheader
</code></pre>

<p>分配给服务的URL基于服务名称。在下面的YAML中，您需要更改服务名称以包含要素分支名称:</p>

<pre><code class="language-yaml">apiVersion: serving.knative.dev/v1
kind: Service
metadata:
  name: randomquotes-blueheader
spec:
  template:
    spec:
      containers:
        - image: gcr.io/cloudrun-314201/randomquotesjava:0.1.200-blueheader
          ports:
            - name: http1
              containerPort: 80
</code></pre>

<p>同样，使用以下命令部署该服务:</p>

<pre><code class="language-bash">gcloud beta run services replace service.yaml --platform managed
</code></pre>

<p>返回的URL将类似于<code>https://randomquotes-blueheader-5od2layuca-ts.a.run.app</code>。</p>

<p>通过重命名服务，您现在可以将功能分支与主线部署并行运行:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-08/deploying-to-google-cloud-run/blueheader.png" class="zoom" data-title=""><img src="../Images/0ffea763fb6ac785fb4272812436c399.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2021-08/deploying-to-google-cloud-run/blueheader.png"/>T2】</a></p>

<h2 id="canary-and-bluegreen-deployments">淡黄色和蓝/绿色部署</h2>

<p>要执行淡黄色或蓝绿色部署，您可以使用服务修订。修订的名称在<code>spec.template.metadata.name</code>属性中定义。它必须以服务名为前缀，并且只能使用小写字母、数字或破折号。</p>

<p>这里我们定义了一个名为<code>randomquotes-0-1-189</code>的版本:</p>

<pre><code class="language-yaml">apiVersion: serving.knative.dev/v1
kind: Service
metadata:
  name: randomquotes
spec:
  template:
    metadata:
      name: randomquotes-0-1-189
    spec:
      containers:
        - image: gcr.io/cloudrun-314201/randomquotesjava:0.1.189
          ports:
            - name: http1
              containerPort: 80
</code></pre>

<p>默认情况下，此修订版在部署时将接收100%的流量。</p>

<p>现在让我们部署一个新版本:</p>

<pre><code class="language-yaml">apiVersion: serving.knative.dev/v1
kind: Service
metadata:
  name: randomquotes
spec:
  template:
    metadata:
      name: randomquotes-0-1-200-blueheader
    spec:
      containers:
        - image: gcr.io/cloudrun-314201/randomquotesjava:0.1.200-blueheader
          ports:
            - name: http1
              containerPort: 80
  traffic:
  - revisionName: randomquotes-0-1-200-blueheader
    percent: 0
  - revisionName: randomquotes-0-1-189
    percent: 100
</code></pre>

<p>此新版本已被设置为不接收流量，而是将100%的流量重定向到以前的版本:</p>

<p>【T2 <img src="../Images/446544bb5442f48f8ece438fdb004882.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2021-08/deploying-to-google-cloud-run/trafficsplitstart.png"/></p>

<p>如果您认为以前的版本是蓝绿色部署的蓝色部分，则新版本将是绿色部分。您可以通过为其指定标签来访问此新版本:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-08/deploying-to-google-cloud-run/tag.png" class="zoom" data-title=""><img src="../Images/db51f203696694cf4be201467fc03c77.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2021-08/deploying-to-google-cloud-run/tag.png"/>T2】</a></p>

<p>这个新版本可以通过一个类似<code>https://green---randomquotes-5od2layuca-ts.a.run.app/</code>的URL打开，在将任何主要流量导向它之前进行测试。</p>

<p>金丝雀部署可以通过逐渐将更多流量导向绿色堆栈来实现。以下命令将10%的流量导向新版本:</p>

<pre><code>gcloud run services update-traffic randomquotes --platform managed --to-revisions=randomquotes-0-1-200-blueheader=10,randomquotes-0-1-189=90
</code></pre>

<p>可以重复此命令，直到100%的流量都被定向到新版本。在更传统的蓝/绿部署中，在新堆栈上的任何测试完成后，100%的流量会立即切换到新版本。</p>

<p>测试完成后，我们可以用下面的命令删除<code>green</code>标签:</p>

<pre><code>gcloud run services update-traffic randomquotes --platform managed --remove-tags green
</code></pre>

<h2 id="conclusion">结论</h2>

<p>Google Cloud Run是一个部署网络应用的便捷平台，只有在处理请求时才会产生费用。云运行提供自动扩展来处理传入的请求，流量路由规则允许您实施蓝/绿和金丝雀风格的部署。</p>

<p>这篇文章介绍了如何将Docker镜像复制到GCR，然后部署一个服务。我们操纵修订版和流量规则来实现蓝/绿和金丝雀部署。我们还研究了如何使用标签来访问一个没有流量的版本。</p>

<p>愉快的部署！</p>

                    
                    
</body>
</html>