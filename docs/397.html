<html>
<head>
<title>Creating workers on a Kubernetes cluster - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>在Kubernetes集群- Octopus部署上创建工人</h1>
<blockquote>原文：<a href="https://octopus.com/blog/kubernetes-workers#2021-12-16">https://octopus.com/blog/kubernetes-workers#2021-12-16</a></blockquote>
                        <p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-03/kubernetes-workers/blogimage-create-workers-on-a-kubernetes-cluster-2021.png" class="zoom" data-title=""><img src="../Images/c55c1bb2ceb9d0c8b44d64ffaab572e9.png" class="img-fluid center" alt="Create workers on a Kubernetes cluster" data-original-src="https://i.octopus.com/blog/2021-03/kubernetes-workers/blogimage-create-workers-on-a-kubernetes-cluster-2021.png"/>T2】</a></p>

<p>客户经常问他们是否可以在Kubernetes (K8s)集群中运行一个Octopus worker。你想这么做有几个原因:为该集群创建一个专用的worker，或者简单地创建一组worker来与Octopus Deploy一起使用。使用<a href="https://hub.docker.com/r/octopusdeploy/tentacle" rel="nofollow">触手图像</a>，这是可能的，但是你甚至可以用它来部署Octopus本身。</p>

<p>在这篇文章中，我演示了如何部署触手容器作为Octopus实例上的工作器。</p>

<h2 id="create-a-worker-pool">创建工人池</h2>

<p>首先，我们需要为我们的容器工人创建一个新的工人池:</p>

<ol>
<li>在Octopus门户网站中，导航至<strong>基础设施</strong>选项卡。</li>
<li>选择<strong>工人池</strong>。</li>
<li>然后点击<strong>添加工人池</strong>。</li>
<li>为该池命名，然后单击<strong>保存</strong>。</li>
</ol>

<p>创建好我们的池后，我们可以继续操作手册了。</p>

<h2 id="create-an-external-feed">创建外部源</h2>

<p>要配置Octopus Deploy来部署映像，我们首先需要创建一个<a href="https://octopus.com/docs/packaging-applications/package-repositories">外部提要</a>，因为内置的存储库只是一个NuGet提要类型。</p>

<p>在这篇文章中，我创建了一个指向Docker Hub的外部提要。还支持其他docker提要，如Artifactory和Nexus。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-03/kubernetes-workers/octopus-docker-hub-feed.png" class="zoom" data-title=""><img src="../Images/3c503cb17a3b2d1a438b97cbb968c852.png" class="img-fluid center" alt="Octopus Docker Hub Feed" data-original-src="https://i.octopus.com/blog/2021-03/kubernetes-workers/octopus-docker-hub-feed.png"/>T2】</a></p>

<h2 id="create-a-runbook">创建一本操作手册</h2>

<p>应使用<a href="https://octopus.com/docs/runbooks">操作手册</a>开展基础设施活动。这篇文章假设你熟悉在Octopus中创建<a href="https://octopus.com/docs/projects">项目</a>，所以我们将跳过这一部分。</p>

<ol>
<li>在您的项目中创建一个操作手册。我叫矿<strong>创造K8s的工人</strong>。</li>
<li>向您的流程添加一个<strong>部署Kubernetes容器</strong>步骤。</li>
</ol>

<p>这个步骤模板很大，所以我们将检查最少的组件来使它工作。</p>

<h3 id="deployment-section">部署科</h3>

<p>至少要填写以下内容:</p>

<ul>
<li><strong>部署名称</strong>:K8s内部署的名称。</li>
<li><strong>副本</strong>:要运行的容器数量。我把我的设置为3，所以我有三个工人。</li>
</ul>

<h3 id="containers-section">Containers section</h3>

<p>点击<strong>添加容器</strong>，填写以下组件:</p>

<ul>
<li><strong>名称</strong>:容器的名称</li>
<li><strong>包装图像</strong>          <ul>
<li><strong> Package feed </strong>:选择您为图像配置的feed(在我的例子中是Docker Hub)</li>
<li><strong>包ID </strong> : <code>octopusdeploy/tentacle</code></li>
</ul>
</li>
<li><strong>环境变量</strong>:点击<strong>添加环境变量</strong>，添加如下:          <ul>
<li><strong> ServerApiKey </strong>:注册工人的API键</li>
<li>服务器Url :你的Octopus实例的Url</li>
<li><strong>接受_EULA </strong> : <code>Y</code></li>
<li><strong> TargetWorkerPool </strong>:要添加的池的名称</li>
<li><strong> ServerPort </strong> : <code>10943</code>(设置这个环境变量为轮询模式配置worker)</li>
<li><strong>空间</strong>:要添加工作者的空间的名称(变量<code>#{Octopus.Space.Name}</code>的八进制数将获取当前空间的名称)</li>
</ul>
</li>
</ul>

<p>Windows K8s群集将主机名限制为16个字符。如果您使用的是Windows K8s，请使用下游API特性并添加一个额外的环境变量，<strong>target name</strong>:metadata . name<br/><a href="#" data-featherlight="https://i.octopus.com/blog/2021-03/kubernetes-workers/octopus-container-targetname.png" class="zoom" data-title=""><img src="../Images/fe6520300ddf056fc4e8bd8035e27288.png" class="img-fluid center" alt="Pod and Container Field Environment Variables" data-original-src="https://i.octopus.com/blog/2021-03/kubernetes-workers/octopus-container-targetname.png"/></a></p>


<p>上面没有列出的任何内容都使用表单默认值。</p>

<h2 id="execute-the-runbook">执行操作手册</h2>

<p>点击<strong>运行</strong>在您选择的环境中运行操作手册。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-03/kubernetes-workers/octopus-runbook-success.png" class="zoom" data-title=""> T39 </a></p>

<p>运行手册成功完成后，选择<strong>基础设施</strong>选项卡，您将看到工人已被添加到<strong>工人池</strong>。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-03/kubernetes-workers/octopus-worker-pool.png" class="zoom" data-title="">T46【T47】T1】</a></p>

<p>我们可以通过在员工身上升级Calamari来验证功能。使用省略号菜单选择<strong>升级3名工人的鱿鱼</strong>选项。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-03/kubernetes-workers/octopus-upgrade-workers.png" class="zoom" data-title=""><img src="../Images/a2120cb80c824d3b27491aa084fcdd39.png" class="img-fluid center" alt="Upgrading Octopus workers" data-original-src="https://i.octopus.com/blog/2021-03/kubernetes-workers/octopus-upgrade-workers.png"/></a>T2】</p>

<h2 id="conclusion">结论</h2>

<p>在本文中，我演示了如何使用Octopus Deploy将workers部署到Kubernetes集群。</p>

<p>愉快的部署！</p>

                    
                    
</body>
</html>