<html>
<head>
<title>Reliably deploying large Azure Web Apps - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>可靠地部署大型Azure Web应用——Octopus Deploy</h1>
<blockquote>原文：<a href="https://octopus.com/blog/reliably-deploying-large-azure-web-apps#2022-07-21">https://octopus.com/blog/reliably-deploying-large-azure-web-apps#2022-07-21</a></blockquote>
                        <p>在Octopus Deploy 3.0中，我们发布了对部署Azure Web应用的一流支持。与直接从Visual Studio发布不同，您可以管理特定于环境的配置，并以受控的方式通过环境提升您的应用程序版本。</p>

<p>我们一直在与一些客户合作，他们部署Azure Web应用变得不可靠。当向Azure部署大型web应用程序时，或者当通过缓慢或有损耗的网络连接进行部署时，尤其如此。在这些情况下，部署到现有的Azure Web应用程序可能会变得不可靠，在某些情况下会挂起，通常需要多次尝试才能成功部署。我希望不言而喻- <em>这不是我们想要的那种体验<strong>任何人</strong>使用Octopus Deploy </em> -我们都是为了<strong>愉快的部署！</strong></p>

<p>如果你对Azure Web应用的不可靠、缓慢或挂起的部署有困难，这篇文章是为你准备的。总而言之:</p>



<h2>在被窝里探索一下...</h2>

<p>当你用Octopus部署Azure Web应用时，我们将通常的Octopus优点应用到你的<a href="http://docs.octopusdeploy.com/display/OD/Configuration+files">配置文件</a>，运行你的<a href="http://docs.octopusdeploy.com/display/OD/Custom+scripts">定制脚本</a>，然后依靠<a href="http://www.iis.net/learn/publish/using-web-deploy/introduction-to-web-deploy"> WebDeploy </a>将结果文件同步到Azure。我们使用微软的<a href="https://www.nuget.org/packages/Microsoft.Web.Deployment/">。Web.Deployment </a>直接在代码中获取包，而不是分发给<code>MsDeploy.exe</code>。</p>

<h2>时间戳而不是校验和<a name="timestamp"/></h2>

<p>在Octopus 3.0中，我们决定将<strong>校验和</strong>作为与WebDeploy同步文件的默认(也是唯一的选择)。使用校验和，我们将只部署<strong>实际上改变了</strong>的文件，而不需要任何特殊的配置。这减少了后续部署到同一个web应用程序所需的时间和带宽。这对于中等规模的应用程序来说确实很好，但是，正如我们发现的，对于大型应用程序来说，这变得极其缓慢和不可靠。</p>

<p>如果你发现自己处于这种情况，你可以使用<a href="https://octopus.com/downloads/3.3.3"> Octopus Deploy 3.3.3 </a>或更新版本，切换到使用<strong>时间戳</strong>进行文件比较，而不是使用<strong>校验和</strong>。</p>

<p><img src="../Images/db213c5fa09925d9d5f988fea917271d.png" alt="Timestamp" data-original-src="https://i.octopus.com/blog/201604-2016-04-0416_06_40-deploypackage-octopusdeploy-ET3U.png"/></p>

<p>如果你有任何现有的Azure Web应用程序步骤，你将需要<strong>更新它们以使用时间戳并创建一个新版本</strong>。默认情况下，你创建的任何新Azure Web应用步骤都将使用<strong>时间戳</strong>，但是如果更适合你的需要，你可以随时切换到<strong>校验和</strong>。</p>

<p>如果你更喜欢校验和，我们计划将<a href="#future">升级到<code>Microsoft.Web.Deployment.3.6.0</code>，它有几个针对校验和比较的错误修复。</a></p>

<h3>保留时间戳</h3>

<p>使用时间戳进行文件比较的缺点是可靠性——你很容易得到误报——这就是校验和如此吸引人的原因。<strong>如果您使用的是NuGet包</strong>，文件的时间戳将在解压缩时丢失，这意味着每个文件看起来都比<em>更新</em>，并且无论是否更改，都会上传- <a href="https://github.com/OctopusDeploy/Issues/issues/829">更多详细信息</a>。要解决这个问题，可以考虑使用<a href="http://docs.octopusdeploy.com/display/OD/Supported+Packages"> zip包</a>——我们已经进行了自动测试，证明时间戳在您的部署中端到端地保留。</p>

<h2>尝试部署到新的插槽并切换<a name="slot"/></h2>

<p>我们通常将这些称为<a href="http://docs.octopusdeploy.com/display/OD/Blue-green+deployments">蓝绿色部署</a>，在这里，您部署web应用程序的新副本，运行冒烟测试，切换插槽，最后删除旧插槽。在现有插槽上进行部署很方便，但无法提供与蓝绿色部署相同的停机时间。</p>

<p>我们已经为<a href="http://docs.octopusdeploy.com/display/OD/Using+Deployment+Slots+with+Azure+Web+Apps">写了一个简短的指南，使用Azure Web Apps </a>的部署槽。对于在部署过程中实现一个额外步骤的成本来说，这是在部署期间保持web应用程序正常运行的一个非常好的模式。</p>

<p><img src="../Images/c3f63d6311f33800b93a180d13965808.png" alt="Blue green deployments with Azure Web Apps" data-original-src="https://i.octopus.com/blog/201604-2016-04-0416_10_29-azurewebblue-greensampledeploymentprocess-octopusdeploy-L4KB.png"/></p>

<p>当您部署到一个全新的插槽时，WebDeploy将只上传所有内容，实际上不需要进行文件比较，从而使大型Web应用部署更加可靠。</p>

<h2>Azure Web应用部署的未来<a name="future"/></h2>

<p>我们希望确保您可以在最终版本发布后立即将您的ASP.NET核心1应用部署到Azure应用服务中。我们已经支持<a href="http://docs.octopusdeploy.com/display/OD/JSON+Configuration+Variables+Feature"> JSON配置文件</a>，以及使用<a href="http://docs.octopusdeploy.com/display/OD/Supported+Packages"> zip包</a>的<a href="https://octopus.com/blog/aspnet-core-build-and-deploy">构建和部署管道</a>。</p>

<p>接下来:</p>

<ul>
<li>我们正计划升级到<code>Microsoft.Web.Deployment.3.6.0</code> ( <a href="https://azure.microsoft.com/en-us/blog/web-deploy-3-6-beta-released/">测试版发布说明</a>)——关注这个<a href="https://github.com/OctopusDeploy/Issues/issues/2422"> GitHub问题</a>如果你有兴趣:<ul>
<li>部署到<code>wwwroot</code>以上的文件夹</li>
<li>代理支持</li>
<li>使用校验和同步的错误修复</li>
</ul></li>
<li>我们将对JSON配置文件实现更深层次的支持</li>
</ul>

<h2>还有问题吗？</h2>

<p>如果您仍然遇到Azure应用服务部署不可靠的问题，请联系我们的<a href="https://octopus.com/support">支持团队</a>，我们将与您一起解决您遇到的具体问题。</p>

                    
                    
</body>
</html>