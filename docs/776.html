<html>
<head>
<title>Using the HTTPd Docker image - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>使用HTTPd Docker映像- Octopus部署</h1>
<blockquote>原文：<a href="https://octopus.com/blog/using-httpd-docker-image#2022-09-12">https://octopus.com/blog/using-httpd-docker-image#2022-09-12</a></blockquote>
                        <p>Apache HTTP服务器是最流行的web服务器之一。据维基百科报道，2022年3月，它要么是使用最多的，要么是第二多的网络服务器。一张<a href="https://hub.docker.com/_/httpd" rel="nofollow">官方HTTPd Docker图片</a>可以在Docker Hub上找到，已经被下载了超过10亿次，使其成为最受欢迎的Docker图片之一。</p>

<p>在本文中，我将向您展示如何开始使用HTTPd映像来托管您自己的网站或构建嵌入HTTPd的自定义Docker映像。</p>

<h2 id="getting-started">入门指南</h2>

<p>使用HTTPd映像最简单的方法是让它托管来自本地工作站的静态web内容。将以下HTML代码保存到名为<code>index.html</code>的文件中:</p>

<pre><code class="language-html">&lt;html&gt;
    &lt;body&gt;
        Hello from Octopus!
    &lt;/body&gt;
&lt;/html&gt;
</code></pre>

<p>然后运行HTTPd Docker映像，将<code>index.html</code>文件挂载到容器中的<code>/usr/local/apache2/htdocs/index.html</code>下:</p>

<pre><code class="language-bash">docker run -p 8080:80 -v "$PWD/index.html":/usr/local/apache2/htdocs/index.html httpd:2.4
</code></pre>

<p>然后您可以打开<code>http://localhost:8080/</code>查看网页。</p>

<p>以这种方式安装文件需要将单个web资产打包并分发到任何新的服务器，这很不方便。更好的解决方案是构建一个嵌入静态web文件的定制Docker映像。</p>

<h2 id="creating-custom-images-based-on-httpd">基于HTTPd创建自定义图像</h2>

<p>要创建自己的Docker图像，请将以下文本保存到名为<code>Dockerfile</code>的文件中:</p>

<pre><code class="language-dockerfile">FROM httpd:2.4
COPY index.html /usr/local/apache2/htdocs/index.html
</code></pre>

<p><code>Dockerfile</code>包含构建自定义Docker映像的说明。这里您使用<code>FROM</code>命令将您的映像基于HTTPd映像，然后使用<code>COPY</code>命令将您的<code>index.html</code>文件复制到<code>/usr/local/apache2/htdocs</code>目录下的新映像中。</p>

<p>使用以下命令构建新映像:</p>

<pre><code class="language-bash">docker build . -t myhttpd
</code></pre>

<p>这构建了一个名为<code>myhttpd</code>的新图像。使用以下命令运行新映像:</p>

<pre><code class="language-bash">docker run -p 8080:80 myhttpd
</code></pre>

<p>注意，这次您没有挂载任何目录。然而，当你打开<code>http://localhost:8080/index.html</code>时，你的定制HTML页面会显示出来，因为它嵌入在你的定制图像中。</p>

<p>HTTPd不仅仅能够托管静态网站。要释放HTTPd的全部潜力，您必须添加定制的配置文件。</p>

<h2 id="advanced-httpd-configuration">高级HTTPd配置</h2>

<p>使用以下命令提取HTTPd映像中嵌入的标准配置文件:</p>

<pre><code class="language-bash">docker run --rm httpd:2.4 cat /usr/local/apache2/conf/httpd.conf &gt; my-httpd.conf
</code></pre>

<p>生成的文件很大，有500多行代码，所以我不会在这里列出。</p>

<p>要让HTTPd加载额外的配置文件，可以在该文件的末尾添加一条指令，指示HTTPd加载指定目录中的文件:</p>

<pre><code>IncludeOptional conf/sites/*.conf
</code></pre>

<p>用以下内容创建一个名为<code>health-check.conf</code>的文件。这个配置使HTTPd能够监听端口90，并用200 OK响应来响应<code>/health</code>路径上的请求。此响应模拟web服务器的运行状况检查，客户端可以使用该检查来确定服务器是否启动并运行:</p>

<pre><code>LoadModule rewrite_module modules/mod_rewrite.so
Listen 90

&lt;VirtualHost *:90&gt;
  &lt;Location /health&gt;
      ErrorDocument 200 "Healthy"
      RewriteEngine On
      RewriteRule .* - [R=200]
  &lt;/Location&gt;
&lt;/VirtualHost&gt;
</code></pre>

<p>然后更新<code>DockerFile</code>以创建目录<code>/usr/local/apache2/conf/sites/</code>，将<code>health-check.conf</code>文件复制到该目录，并用包含<code>IncludeOptional</code>指令的副本覆盖原始配置文件:</p>

<pre><code class="language-dockerfile">FROM httpd:2.4
RUN mkdir -p /usr/local/apache2/conf/sites/
COPY health-check.conf /usr/local/apache2/conf/sites/health-check.conf
COPY my-httpd.conf /usr/local/apache2/conf/httpd.conf
</code></pre>

<p>使用以下命令构建新映像:</p>

<pre><code class="language-bash">docker build . -t myhttpd
</code></pre>

<p>使用命令运行Docker映像。请注意，您公开了一个新端口来提供对运行状况检查端点的访问:</p>

<pre><code class="language-bash">docker run -p 8080:80 -p 9090:90 myhttpd
</code></pre>

<p>然后打开<a href="http://localhost:9090/health" rel="nofollow">http://localhost:9090/health</a>进入健康检查页面。</p>

<h2 id="choosing-httpd-variants">选择HTTPd变体</h2>

<p>HTTPd图像基于Debian或Alpine。Alpine经常被用作Docker图像的轻量级基础。要查看Docker图像的大小，必须首先将它们下载到您的本地工作站:</p>

<pre><code class="language-bash">docker pull httpd:2.4
docker pull httpd:2.4-alpine
</code></pre>

<p>然后，您可以使用以下命令查找图像大小:</p>

<pre><code class="language-bash">docker image ls
</code></pre>

<p>从这里你可以看到Alpine的变体在尺寸上要小得多，基于Debian的imaged重145MB，Alpine image重55MB。</p>

<p>要使用Alpine变体，请将您的自定义图像基于<code>httpd:2.4-alpine</code>图像:</p>

<pre><code class="language-dockerfile">FROM httpd:2.4-alpine
RUN mkdir -p /usr/local/apache2/conf/sites/
COPY health-check.conf /usr/local/apache2/conf/sites/health-check.conf
COPY my-httpd.conf /usr/local/apache2/conf/httpd.conf
</code></pre>

<h2 id="conclusion">结论</h2>

<p>HTTPd是一个流行的web服务器，官方的HTTPd Docker映像允许DevOps团队在Docker中托管定制的web应用程序。通过对HTTPd配置文件进行一些小的调整，还可以使用全系列的<a href="https://httpd.apache.org/docs/current/mod/" rel="nofollow"> HTTPd模块</a>，解锁许多高级功能。</p>

<p>在本文中，您了解了如何创建托管静态web应用程序的自定义Docker映像，添加了高级HTTPd配置文件来提供健康检查端点，并比较了Debian和Alpine HTTPd映像的大小。</p>

<p>您可能还想了解:</p>



<h2 id="resources">资源</h2>



<h2 id="learn-more">了解更多信息</h2>

<p>如果您想在AWS平台(如EKS和ECS)上构建和部署容器化的应用程序，请尝试使用<a href="https://octopusworkflowbuilder.octopus.com/#/" rel="nofollow"> Octopus Workflow Builder </a>。构建器使用GitHub Actions工作流构建的示例应用程序填充GitHub存储库，并使用示例部署项目配置托管的Octopus实例，这些项目展示了最佳实践，如漏洞扫描和基础架构代码(IaC)。</p>

<p>愉快的部署！</p>

                    
                    
</body>
</html>