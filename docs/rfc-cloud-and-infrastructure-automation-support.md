# RFC -云和基础设施自动化支持- Octopus 部署

> 原文：<https://octopus.com/blog/rfc-cloud-and-infrastructure-automation-support>

Octopus 有许多客户在云 IaaS 环境中进行基础设施自动化，如 Amazon EC2 和 Azure。我们知道许多客户正在使用 Octopus Deploy 作为这方面的核心组件，但我们也从与人们的交谈中了解到，这在一些领域会引起一些摩擦。我们有一些可以添加到产品中的想法，可以使这变得更容易，但这是一个巨大的领域，我们知道每个人的做法略有不同，所以我们希望您的反馈。

我们所知道的是，我们不可能提供一个适合大多数人的简单界面，有太多的变量和不同的模式。我们还知道，想要走这条路的客户是一群非常笨拙的人，他们不害怕在编写一些脚本来管理机器时弄脏自己的手。

最后，我们知道客户希望使用 Octopus Deploy 来完成更多的流程编排工作，这就是我们想要解决的问题。

## 两种思想流派

谈到基础架构自动化，我们看到了两种截然不同的模式，这是关于环境是作为部署的一部分进行更改，还是以更松散的方式进行更改。

### 场景 1 -将环境与部署联系起来。

一个新的版本即将上线。全新的实例被创建和配置，tentacles 被安装并注册到 Octopus 服务器。该版本被部署到新的机器上，新的机器被放入负载平衡的服务器池中，运行旧版本的实例被从服务器池中删除，并被 Octopus 注销和销毁。

目前这方面的主要问题是 Octopus 在部署开始时评估部署目标机器。因此，如果您的部署中有一个创建新机器的 PowerShell 步骤，它们不会是部署的一部分。因此，部署的编排需要在 Octopus 之外进行。许多人为此使用他们的构建服务器，运行脚本来创建环境，然后通过 Octopus API 调用部署。这是可行的，但是对于部署的控制权在哪里，这有点违背直觉。

### 场景 2 -单独管理环境

另一种方法是单独定义和管理环境。在非常有弹性的环境中，机器可以根据需要自动添加或删除，这种情况很常见。

例如，AWS CloudFormation 模板存储在源代码控制中。该文件定义了环境的形式及其围绕自动扩展的行为和策略。当配置改变时，运行脚本将新配置推送到 AWS，使 EC2 根据需要添加、移除或改变机器。

虽然这对于今天的人们来说是可行的，但是它需要为新实例部署和运行额外的脚本来请求任何部署。此外，当实例被销毁时，Octopus 将继续轮询它们以执行运行状况检查，因此会创建计划任务来注销已取消配置的机器。

## 输入环境策略

场景#2 中问题的解决方案是在每个环境的基础上建立一些行为规则。

### 动态注册

如果计算机不响应运行状况检查或者在部署时无法联系到，那么允许对环境进行动态注册将会使计算机被取消注册并被“遗忘”。如果动态环境中的机器没有响应，Octopus 会将它从环境中移除，并停止尝试接近它。Octopus 可以在环境页面上保留一个“最近移除的”机器的列表，作为一个可视的指示。

### 自动部署

为环境启用自动部署将在计算机联机时启动新的部署。如果一个新的机器实例是由于自动伸缩或机器回收策略而创建的，那么当注册了触手 Octopus 时，它将评估它应该拥有什么版本，并为它创建一个部署。这在间歇性连接的环境中也很有用，可能会错过发布(例如，我们有一些客户需要将 VPN 部署到经常离线的客户端机器上)。

## 重新评估机器步骤

场景#1 的一个简单解决方案是 Octopus 能够在部署中途重新评估部署目标。创建新机器的 PowerShell 脚本可以在一个变量中设置新的实例名称，该变量可用于重新定位部署。

## 对 IaaS 平台的直接支持

上面概述的功能是一些基本的功能，这些功能将为我们的许多客户提供更多的场景。为了更深入地了解各种 IaaS 平台，我们认为最好在我们的库中发布 Step 模板，并可能发布一些开源脚本、工具和示例项目，以帮助您最好地定制 Octopus Deploy 项目来满足您的需求。

## 我们需要您的反馈

如果您正在进行基础设施自动化，这些选项会让您的生活和/或脚本更容易吗？如果你想知道如何做，这会有帮助吗？如果你正在做的事情完全没有得到这些想法的帮助，我们错过了什么？