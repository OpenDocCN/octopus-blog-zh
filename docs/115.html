<html>
<head>
<title>Using classes in custom step templates - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>在自定义步骤模板中使用类- Octopus Deploy</h1>
<blockquote>原文：<a href="https://octopus.com/blog/classes-in-custom-step-templates#2021-08-12">https://octopus.com/blog/classes-in-custom-step-templates#2021-08-12</a></blockquote>
                        <p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-06/classes-in-custom-step-templates/blogimage-using-classes-in-custom-step-template-2021.png" class="zoom" data-title=""><img src="../Images/6941727176a2f59aa49b34c396022597.png" class="img-fluid center" alt="powershell logo and database beside an open laptop showing code on screen" data-original-src="https://i.octopus.com/blog/2021-06/classes-in-custom-step-templates/blogimage-using-classes-in-custom-step-template-2021.png"/>T2】</a></p>

<p>我最近决定创建一个新的<a href="https://library.octopus.com/step-templates/ae9d0024-a5aa-4aa8-95a9-cba53c291054/actiontemplate-sql-deploy-dacpac-with-aad-auth-support" rel="nofollow"> DACPAC </a>步骤模板，以支持<a href="https://docs.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/overview" rel="nofollow"> Azure Active Directory托管身份认证</a>(修改现有模板会带来重大变化)。</p>

<p>在这篇文章中，我将向您展示我是如何用PowerShell和一个自定义类来完成这个任务的。</p>

<h2 id="preparation">准备</h2>

<p>首先，您需要提供一个Azure SQL Server和一个Azure VM。本文假设您熟悉这些类型的资源的供应，并且不会涉及这些主题。</p>

<h3 id="configuring-the-vm-for-a-managed-identity">为托管身份配置虚拟机</h3>

<p>创建Azure VM后，您需要将其配置为使用托管身份特性。</p>

<p>导航到虚拟机资源并单击左侧窗格中的<strong>标识</strong>。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-06/classes-in-custom-step-templates/azure-vm-identity.png" class="zoom" data-title=""><img src="../Images/c82a524cc4c6c705f941a44a2d2d6d9e.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2021-06/classes-in-custom-step-templates/azure-vm-identity.png"/>T2】</a></p>

<p>在身份面板上，将上的<strong>状态</strong>切换到<strong>。</strong></p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-06/classes-in-custom-step-templates/azure-vm-managed-identity.png" class="zoom" data-title=""><img src="../Images/b50874ab7c2fe77c6ee97e5989392719.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2021-06/classes-in-custom-step-templates/azure-vm-managed-identity.png"/>T2】</a></p>

<p>虚拟机现在可以向Azure资源(如Azure SQL Server)进行身份验证。</p>

<h3 id="configuring-azure-sql-server-for-managed-identity-authentication">为托管身份认证配置Azure SQL Server</h3>

<p>有两种方法可以向SQL server授予托管身份的身份验证:</p>

<ul>
<li>将虚拟机管理的身份配置为Azure SQL Server的活动目录管理员。</li>
<li>将受管身份作为外部登录添加到数据库。</li>
</ul>

<h4 id="configuring-active-directory-admin">配置Active Directory管理员</h4>

<p>导航到Azure SQL Server资源并点击<strong>活动目录管理</strong>。</p>

<p>由于您只能将一个帐户配置为活动目录管理员，所以我不建议在生产中使用这种方法。</p>


<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-06/classes-in-custom-step-templates/azure-sql-aad-admin.png" class="zoom" data-title=""><img src="../Images/df15e1b5e789d39f0bd535d46ff2f732.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2021-06/classes-in-custom-step-templates/azure-sql-aad-admin.png"/>T2】</a></p>

<p>在<strong>活动目录管理</strong>屏幕上，点击<strong>设置管理</strong>。选择您的虚拟机并点击<strong>选择</strong>。该帐户现在将显示为选定的管理员帐户。点击<strong>保存</strong>保存您的更改。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-06/classes-in-custom-step-templates/azure-sql-select-admin.png" class="zoom" data-title=""><img src="../Images/5633be5aeec6e4abd002b86757ff3beb.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2021-06/classes-in-custom-step-templates/azure-sql-select-admin.png"/>T2】</a></p>

<h4 id="adding-managed-identity-as-an-external-login-to-the-database">将受管身份作为外部登录添加到数据库</h4>

<p>使用类似SQL Server Management Studio (SSMS)的工具，您可以执行一个脚本来授予虚拟机权限。</p>

<p>选择要添加权限的数据库，注意<code>USER</code>是虚拟机的名称，并运行以下命令:</p>

<pre><code class="language-sql">CREATE USER [Octo-AAD-Worker] FROM EXTERNAL PROVIDER
ALTER ROLE db_owner ADD MEMBER [Octo-AAD-Worker]
</code></pre>

<p>检查您是否针对正确的数据库执行脚本。</p>


<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-06/classes-in-custom-step-templates/azure-sql-user-script.png" class="zoom" data-title=""><img src="../Images/6733adc7b6ee8d4b2632c04421d8ad5c.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2021-06/classes-in-custom-step-templates/azure-sql-user-script.png"/>T2】</a></p>

<p>您的VM现在拥有所选数据库的<code>db_owner</code>角色。</p>

<h3 id="testing-connectivity">测试连通性</h3>

<p>要验证受管身份是否正常工作，请执行以下操作:</p>

<ol>
<li>登录Azure VM并打开PowerShell或PowerShell ISE。</li>
<li>运行以下脚本来验证它正在连接:</li>
</ol>

<pre><code class="language-PowerShell">$response = Invoke-WebRequest -Uri 'http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&amp;resource=https%3A%2F%2Fdatabase.windows.net%2F' -Method GET -Headers @{Metadata="true"}
$content = $response.Content | ConvertFrom-Json
$AccessToken = $content.access_token

$connectionString = "Data Source=aad-sql-test.database.windows.net; Initial Catalog=TestDB2;"

$sqlConnection = New-Object System.Data.SqlClient.SqlConnection
$sqlConnection.ConnectionString = $connectionString
$sqlConnection.AccessToken = $AccessToken

$command = $sqlConnection.CreateCommand()
$command.CommandType = [System.Data.CommandType]'Text'
$command.CommandText = "SELECT @@VERSION"

$sqlConnection.Open()

$command.ExecuteNonQuery();

$sqlConnection.Close()
</code></pre>

<p>这个脚本应该成功，没有错误消息，并将返回一个<code>-1</code>，在这种情况下，这意味着成功。</p>

<p>该脚本调用内部Azure身份服务来返回用于对数据库服务器进行身份验证的访问令牌。</p>

<h2 id="dacpac-step-template">DACPAC步骤模板</h2>

<p>DACPAC步骤模板使用。NET对象与SQL Server交互，而不是调用<code>sqlpackage.exe</code>命令行程序。为了建立与数据库服务器的连接，代码创建了一个<a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.sqlserver.dac.dacservices?view=sql-dacfx-150" rel="nofollow"> DacServices </a>对象，将一个连接字符串传递给构造函数。</p>

<p>与上面的脚本类似，使用托管身份进行身份验证需要一个不能添加到连接字符串本身的访问令牌。上面的脚本显示,<a href="https://docs.microsoft.com/en-us/dotnet/api/system.data.sqlclient.sqlconnection?view=dotnet-plat-ext-5.0" rel="nofollow"> SqlConnection </a>对象包含属性<code>AccessToken</code>,该属性是为身份验证目的而分配的。然而<code>DacServices</code>不包含这样的属性。</p>

<p>要使用托管身份认证方法，您必须使用一个<a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.sqlserver.dac.dacservices.-ctor?view=sql-dacfx-150#Microsoft_SqlServer_Dac_DacServices__ctor_System_String_Microsoft_SqlServer_Dac_IUniversalAuthProvider_" rel="nofollow">重载构造函数</a>实例化一个<code>DacServices</code>对象，该构造函数接受一个实现<code>Microsoft.SqlServer.Dac.IUniversalAuthProvider</code>接口的对象。</p>

<h3 id="creating-classes-in-powershell">在PowerShell中创建类</h3>

<p>从PowerShell版本5开始，您可以在PowerShell本身中创建自定义类:</p>

<pre><code class="language-PowerShell">class AzureADAuth : Microsoft.SqlServer.Dac.IUniversalAuthProvider
{
    [string] GetValidAccessToken()
    {
      # Call Azure API to retrieve the token
      $response = Invoke-WebRequest -Uri 'http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&amp;resource=https%3A%2F%2Fdatabase.windows.net%2F' -Method GET -Headers @{Metadata="true"} -UseBasicParsing
      $content = $response.Content | ConvertFrom-Json
      $azureAccessToken = $content.access_token
      # Return access token
      return $azureAccessToken
    }
}
</code></pre>

<p>在代码执行之前评估的<em>类</em>定义可能会出现问题。尽管在类定义之前加载了适当的程序集，但是如果PowerShell找不到类型，它就会失败。如果DLL在全局程序集缓存(GAC)中，它可能会工作，但是，对于step模板，您不能这样假设。</p>

<pre><code>+ class AzureADAuth : Microsoft.SqlServer.Dac.IUniversalAuthProvider
+                     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Unable to find type [Microsoft.SqlServer.Dac.IUniversalAuthProvider].
    + CategoryInfo          : ParserError: (:) [], ParentContainsErrorRecordException
    + FullyQualifiedErrorId : TypeNotFound
</code></pre>

<h4 id="alternate-class-creation-method">替代类创建方法</h4>

<p>我发现我可以通过使用C#语法在字符串变量中定义类来创建类！我也可以在添加类型时传入依赖程序集引用:</p>

<pre><code class="language-Powershell"># Define C# class
$authClass = @"
public class AzureADAuth : Microsoft.SqlServer.Dac.IUniversalAuthProvider
{
    public string GetValidAccessToken()
    {
        System.Net.HttpWebRequest request = (System.Net.HttpWebRequest)System.Net.WebRequest.Create("http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&amp;resource=https://database.windows.net/");
        request.Headers["Metadata"] = "true";
        request.Method = "GET";
        string accessToken = null;

        System.Net.HttpWebResponse response = (System.Net.HttpWebResponse)request.GetResponse();

        System.IO.StreamReader streamResponse = new System.IO.StreamReader(response.GetResponseStream());
        string stringResponse = streamResponse.ReadToEnd();
        System.Web.Script.Serialization.JavaScriptSerializer j = new System.Web.Script.Serialization.JavaScriptSerializer();
        System.Collections.Generic.Dictionary&lt;string, string&gt; list = (System.Collections.Generic.Dictionary&lt;string, string&gt;) j.Deserialize(stringResponse, typeof(System.Collections.Generic.Dictionary&lt;string, string&gt;));
        accessToken = list["access_token"];

        return accessToken;
    }
}
"@

# Create new object
Add-Type -TypeDefinition $authClass -ReferencedAssemblies @("$($DacDLL.FullName)", "System.Net", "System.Web.Extensions", "System.Collections")

$dacServices = New-Object Microsoft.SqlServer.Dac.DacServices $connectionString, $azureAuth
</code></pre>

<p>由于DACPAC步骤模板很长，本文只包括与类创建相关的代码部分。这里不包括搜索<code>$DacDLL</code>的值。</p>


<h3 id="deployment">部署</h3>

<p>测试我们的代码显示了使用托管身份方法的成功部署。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-06/classes-in-custom-step-templates/octopus-deployment.png" class="zoom" data-title=""><img src="../Images/3dcd2d526918ad9b0ed84e5100c41ba3.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2021-06/classes-in-custom-step-templates/octopus-deployment.png"/>T2】</a></p>

<h2 id="conclusion">结论</h2>

<p>在这篇文章中，我演示了在PowerShell中创建定制类，包括接口的实现。希望这对你以后使用PowerShell的工作有所帮助。</p>

<p>愉快的部署！</p>

                    
                    
</body>
</html>