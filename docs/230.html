<html>
<head>
<title>DevOps, runbooks, and kubectl - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>DevOps、runbooks和kubectl - Octopus部署</h1>
<blockquote>原文：<a href="https://octopus.com/blog/devops-runbooks-and-kubectl#2021-11-05">https://octopus.com/blog/devops-runbooks-and-kubectl#2021-11-05</a></blockquote>
                        <p>可以肯定地说,<a href="https://www.theregister.co.uk/2018/02/22/ibm_java_cto_john_duimovich_interview/" rel="nofollow">开发人员不应该学习Docker、K8s或30种其他东西来部署一个应用</a>是我们许多人都同意的观点。</p>

<p>实话实说吧，Kubernetes并不容易。但是有办法让支持它不那么痛苦。Octopus中的Runbook功能允许您编写多年来为Octopus部署提供动力的相同流程的脚本，以管理整个环境中的日常维护和紧急操作(事件响应)任务，而无需创建部署。</p>

<p>在这篇博文中，我们看一个简单的操作手册，并强调创建可重用操作手册相对于手动脚本和专门调试的优势。</p>

<p>Octopus 2021 Q3包括对Kubernetes部署的更新支持，以及针对Google Cloud、AWS和Azure用户的runbooks。在我们的<a href="https://octopus.com/blog/octopus-release-2021-q3" class="alert-link">发布公告</a>中了解更多信息。</p>


<h2 id="a-simple-kubernetes-runbook-example">一个简单的Kubernetes runbook示例</h2>

<p>在支持Kubernetes集群时，列出Kubernetes pods以查看其状态是常见的第一步。这听起来很简单，很容易认为这个过程只不过是运行<code>kubectl get pods</code>。但是有了操作手册，就有可能丰富这个诊断过程。</p>

<p>下面是一个<strong> Get Pods </strong>脚本的示例，您可以将其创建为操作手册的一部分:</p>

<pre><code class="language-PowerShell">$arguments = @("get", "pods")

if ($Format -ieq "YAML") {$arguments += @("-o", "yaml")}
if ($Format -ieq "JSON") {$arguments += @("-o", "json")}

$result = &amp; Start-Process `
    -FilePath 'kubectl.exe' `
    -ArgumentList $arguments `
    -NoNewWindow `
    -Wait `
    -RedirectStandardOutput "result.txt"

Get-Content "result.txt"

New-OctopusArtifact "result.txt"

# Add some intelligence to guide the troubleshooter
$notRunning = &amp; kubectl get pods -o json |
    ConvertFrom-JSON |
    Select -ExpandProperty items |
    Where-Object {$_.status.phase -ne "Running"}

if ($notRunning.Count -ne 0) {
    Write-Host "The following pods are not in a Running state. These are worth investigating further."
    $notRunning |
    ForEach-Object {Write-Host "$($_.metadata.name) is not running."}
}
</code></pre>

<p>我们通过构建一个要传递给<code>kubectl</code>的参数数组来开始这个脚本。基本参数是<code>get pods</code>，但是根据名为<code>Format</code>的提示变量的值，我们也可以在JSON或YAML中获得pod的详细信息。对<code>kubectl</code>调用的响应被保存到一个名为<code>result.txt</code>的文件中。</p>

<p><code>New-OctopusArtifact</code> Cmdlet获取文件并将其保存为Octopus工件，在流程完成后，可以从任务摘要中获得该工件。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-09/devops-runbooks-and-kubectl/task-summary.png" class="zoom" data-title=""><img src="../Images/2a09d21e7668221aeadf8c1bda2c13c2.png" class="img-fluid center" alt="Screenshot of Task Summary page in Octopus showing Step 1 Get Pods" data-original-src="https://i.octopus.com/blog/2021-09/devops-runbooks-and-kubectl/task-summary.png"/>T2】</a></p>

<p>然后，脚本再次调用<code>kubectl</code>，这一次寻找不处于运行状态的pod。输出中会列出找到的任何pod。</p>

<p>这个脚本并不特别复杂或巧妙，但是它强调了使用runbooks的许多好处。</p>



<p>至少，与Kubernetes集群交互需要安装<code>kubectl</code>命令行工具。根据集群的不同，您可能还需要额外的身份验证可执行文件。</p>

<p>根据我的经验，<em>支持笔记本电脑</em>是放在桌子下面的东西，无论是在办公室还是在那个星期被呼叫的人的家里。如果事情做得正确，笔记本电脑很少使用，更新更不频繁。当您考虑用于与Kubernetes交互的命令行工具的范围时，这是一个问题，其中一些工具(如<code>helm</code>)在版本控制方面可能特别多变。</p>

<p>通过从runbook执行<code>kubectl</code>和其他Kubernetes CLI工具，您不再需要安装本地工具。您所需要的只是一个web浏览器，以及配置了所需工具的Octopus服务器(或Workers)。</p>

<h2 id="no-additional-permissions-required">不需要额外权限</h2>

<p>如果您遵循最佳安全实践，那么您的Kubernetes集群将不会只有一个管理员帐户，而是为集群中的每个功能区域提供有限的服务帐户。这些帐户的密码将经常刷新，以限制任何泄露的凭据的潜在损害。</p>

<p>但是，您如何与您的支持团队分享这些凭证呢？</p>

<p>使用操作手册减轻了最终用户维护基础架构凭据的负担。每个Kubernetes目标可以根据需要对集群进行或多或少的访问，Octopus权限可以限制谁可以在哪个目标上运行哪个runbook。</p>

<h2 id="enrich-kubernetes-scripts-with-business-intelligence">用商业智能丰富Kubernetes脚本</h2>

<p><code>kubectl</code>是一个大锤子，如果您有所需的权限，它几乎可以在Kubernetes集群上做任何事情。但是它永远不会拥有特定于您的用例的商业智能。</p>

<p>在上面的示例脚本中，我们专门向Kubernetes查询了处于非运行状态的pod。对Kubernetes来说，不运行的pod只是pod可能处于的一种状态，但在您的业务中，这可能是进行故障诊断时首先要寻找的。</p>

<p>这种商业知识往往是在漫长的支持之夜中来之不易的，然后通过个人之间的战争故事来分享。但是有了操作手册，它就可以变成一个标准流程，任何人都可以看到。</p>

<h2 id="detailed-kubernetes-audit-trails">详细的Kubernetes审计跟踪</h2>

<p>停机期间的首要任务是让集群重新联机。但是第二天就花在了尝试逆向工程问题的根本原因上。</p>

<ul>
<li>为什么那些特殊的豆荚被重启了？</li>
<li>日志文件里有什么？</li>
<li>在被删除之前，pod使用了多少资源？</li>
</ul>

<p>当运行<code>kubectl</code>的本地终端关闭时，这些问题的答案往往会丢失。</p>

<p>使用runbooks，每个查询的结果都记录在日志文件中，每个操作的历史记录都记录在审计日志中。您还可以确保<code>kubectl delete pod</code>是<em>总是在<code>kubectl logs</code>或<code>kubectl describe pod</code>之前</em>，使得被删除的pod的状态易于在第二天查看。</p>

<h2 id="a-common-context">共同的背景</h2>

<p>连续部署的最佳实践包括在整个环境中推动变化。高可用性意味着将您的生产基础架构跨可用性区域或地区分布，跨多个云提供商部署，或者拥有混合的内部和云基础架构。</p>

<p>Octopus长期以来支持多个云提供商和内部部署，通过目标和环境捕获拓扑结构。Runbooks利用相同的上下文，允许在现有基础架构上执行任务，而无需重新定义基础架构。</p>

<h2 id="conclusion">结论</h2>

<p>在这样一个世界里，你需要学习30种不同的东西来部署一个应用程序，Octopus努力为你提供一个简单的<strong>部署</strong>按钮。</p>

<p>借助Runbooks，推动Octopus部署的经过实战检验的流程现在也可用于DevOps支持和维护任务。</p>

<p>愉快的部署！</p>

                    
                    
</body>
</html>