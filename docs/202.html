<html>
<head>
<title>Deploying to Google App Engine - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>部署到Google应用引擎- Octopus Deploy</h1>
<blockquote>原文：<a href="https://octopus.com/blog/deploying-to-google-app-engine#2021-12-16">https://octopus.com/blog/deploying-to-google-app-engine#2021-12-16</a></blockquote>
                        <p>谷歌应用引擎(GAE)是由谷歌云平台(GCP)提供的最初的平台即服务(PaaS)产品之一。</p>

<p>GAE托管着用各种不同语言编写的web应用程序。它还提供网络路由、作业调度、持久数据存储和任务队列。</p>

<p>在本文中，我将介绍如何将一个示例应用程序部署到GAE，并操纵网络来实现常见的部署场景，如蓝/绿、金丝雀和特性分支部署。</p>

<h2 id="a-simple-deployment">简单的部署</h2>

<p>GAE为Java提供了两种部署:</p>

<ul>
<li>部署由GAE编译的源代码</li>
<li>部署已编译的应用程序</li>
</ul>

<p>允许GAE编译您的源代码是很方便的，尽管在这个例子中我使用了一个已经被我们的CI系统编译过的JAR文件。</p>

<p>在GAE，部署已编译应用程序的能力是Java独有的。Node、Python、Ruby和PHP等其他运行时通常不会生成编译后的应用程序。Go是一个明显的例外，在这种情况下，你需要部署你的源代码，让GAE为你编译。</p>


<p>我们的示例应用程序是一个简单的Java Spring web应用程序，名为Random Quotes。这个应用程序的源代码可以在GitHub 中找到<a href="https://github.com/OctopusSamples/RandomQuotes-Java" rel="nofollow">。这个应用程序生成一个自包含的JAR文件来托管应用程序和一个内置的web服务器。</a></p>

<p>要部署应用程序，您需要在GCP项目中创建一个相应的GAE应用程序资源。以下步骤显示了通过web控制台创建的应用程序资源。第一步是选择托管应用程序资源的位置:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-08/deploying-to-google-app-engine/location.png" class="zoom" data-title=""><img src="../Images/5dca722ebb593fbd5b26f57eb347cba1.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2021-08/deploying-to-google-app-engine/location.png"/>T2】</a></p>

<p>然后定义将托管您的web应用程序的环境:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-08/deploying-to-google-app-engine/language.png" class="zoom" data-title=""><img src="../Images/125e1e24a666352a3fbaee51bf0ccbd5.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2021-08/deploying-to-google-app-engine/language.png"/>T2】</a></p>

<p>在创建GAE实例时，提供了一些关于后续步骤的说明。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-08/deploying-to-google-app-engine/instructions.png" class="zoom" data-title=""><img src="../Images/c003df936212616ee14cc2838452e687.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2021-08/deploying-to-google-app-engine/instructions.png"/>T2】</a></p>

<p>该过程的最终结果是创建了下图所示的<strong>应用程序</strong>:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-08/deploying-to-google-app-engine/modules_hierarchy.svg" class="zoom" data-title=""><img src="../Images/df0f8ed0329fddd58ff5f54ca61828df.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2021-08/deploying-to-google-app-engine/modules_hierarchy.svg"/>T2】</a></p>

<p>每个项目只能有一个应用程序资源。如果您尝试创建另一个应用程序，比如在不同的地区，您会看到如下错误:</p>
<pre><code>ERROR: (gcloud.app.create) The project [mattctest] already contains an App Engine application. You can deploy your application using `gcloud app deploy`.
</code></pre>


<p>创建应用程序资源后，您就可以部署web应用程序了。一个应用程序资源可以承载许多服务，其中每个服务运行您自己的应用程序。</p>

<p>服务是在一个名为<code>app.yaml</code>的文件中定义的(有点混乱)。下面是一个示例<code>app.yaml</code>文件，您可以使用它来定义和部署您的Java web应用程序:</p>

<pre><code class="language-yaml">runtime: java11
service: default
instance_class: F2
</code></pre>

<p>运行时是定义将承载您的代码的平台的必需属性。我找不到一个明确的运行时列表，但是<code>java</code>、<code>java8</code>和<code>java11</code>都包含在文档和示例的不同地方。我在这里使用<code>java11</code>，因为Java 11是GAE <a href="https://cloud.google.com/appengine/docs/standard/runtimes" rel="nofollow">第二代</a>的一部分。</p>

<p>部署到GAE的第一个服务必须被称为<code>default</code>，所以我在<code>service</code>字段中定义了这个名称。</p>

<p>如果您尝试使用非默认名称部署服务，您会得到以下错误:</p>
<pre><code>The first service (module) you upload to a new application must be the 'default' service (module).
</code></pre>


<p>您还需要使用比默认情况下提供的稍微大一点的<a href="https://cloud.google.com/appengine/docs/standard#instance_classes" rel="nofollow">实例</a>。这是在<code>instance_class</code>属性中定义的。F2实例提供了512MB的内存，这是您的web应用程序所需要的。</p>

<p>使用以下命令编译Java应用程序:</p>

<pre><code>./mvnw package
</code></pre>

<p>这将在<code>target</code>目录下创建一个JAR文件。</p>

<p>在编写本文时，示例应用程序的版本是0.1.9，所以JAR文件被称为<code>target/randomquotes.0.1.9.jar</code>。</p>

<p>要部署web应用程序，请运行以下命令，替换项目名称以匹配您的环境:</p>

<pre><code>gcloud app deploy .\target\randomquotes.0.1.9.jar --appyaml .\app.yaml --project mattctest
</code></pre>

<p>然后部署编译后的应用程序。部署日志将类似https://[project name]. UC . r . appspot . com/的URL返回到实时服务，您可以在web浏览器中打开该服务:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-08/deploying-to-google-app-engine/randomquotes.png" class="zoom" data-title=""><img src="../Images/110098e5b447bd5366a3768a7891d8c7.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2021-08/deploying-to-google-app-engine/randomquotes.png"/>T2】</a></p>

<h2 id="deploying-a-feature-branch">部署功能分支</h2>

<p>一种常见的部署模式是让特性分支与主线分支并行部署。为了模拟这种情况，部署web应用程序的<a href="https://github.com/OctopusSamples/RandomQuotes-Java/tree/blueheader" rel="nofollow"> blueheader </a>分支，它会将横幅的背景颜色更改为蓝色。</p>

<p>这个分支的<code>app.yaml</code>文件如下所示:</p>

<pre><code class="language-yaml">runtime: java11
service: blueheader
instance_class: F2

env_variables:
  SERVER_SERVLET_CONTEXT_PATH: "/blueheader"
</code></pre>

<p>我给这个服务起了一个新名字，以匹配特性分支的名字。我还定义了<code>SERVER_SERVLET_CONTEXT_PATH</code>环境变量，将其设置为<code>/blueheader</code>。这定义了web应用程序期望从中接收流量的上下文路径。这允许您测试一些流量路由规则，这意味着您可以从类似https://[project name]. UC . r . appspot . com/blue header的URL(与https://blue header-dot-[project name]. UC . r . appspot . com的唯一服务URL相反)访问新服务。</p>

<p>为了将子目录<code>blueheader</code>路由到新服务，创建一个名为<code>displatch.yaml</code>的文件，包含以下内容。这些调度规则定义了如何将流量从URL路由到服务:</p>

<pre><code class="language-yaml">dispatch:
  - url: "*/"
    service: default

  - url: "*/blueheader"
    service: blueheader

  - url: "*/blueheader/*"
    service: blueheader
</code></pre>

<p>这是通过以下命令部署的:</p>

<pre><code>gcloud app deploy dispatch.yaml --project mattctest
</code></pre>

<p>现在可以在URL https://[project name]. UC . r . appspot . com/blue header打开功能分支:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-08/deploying-to-google-app-engine/blueheader.png" class="zoom" data-title=""><img src="../Images/2fc1e78eee2de1237f4870232748830d.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2021-08/deploying-to-google-app-engine/blueheader.png"/>T2】</a></p>

<h2 id="traffic-splitting-canary-and-bluegreen-deployments">流量分割、金丝雀和蓝/绿部署</h2>

<p>现在，让我们看看如何使用流量分流来实施淡黄色和蓝/绿色部署。</p>

<p>为此，您需要将<code>pom.xml</code>文件中的应用程序版本升级到<code>0.1.10</code>:</p>

<pre><code class="language-xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;project  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;
    &lt;version&gt;0.1.10&lt;/version&gt;
    ...
&lt;/project&gt;
</code></pre>

<p>然后，使用以下命令重新打包该应用程序:</p>

<pre><code>./mvnw package
</code></pre>

<p>使用以下命令部署新版本:</p>

<pre><code>gcloud app deploy .\target\randomquotes.0.1.10.jar --appyaml .\app.yaml --project mattctest --no-promote
</code></pre>

<p><code>--no-promote</code>选项确保这个新版本不接收任何流量，所以打开https://[project name]. UC . r . appspot . com/还是会显示之前版本的web app。</p>

<p>在<strong>版本</strong>选项卡中，有一个按钮叫做<strong>分流</strong>:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-08/deploying-to-google-app-engine/splittraffic.png" class="zoom" data-title=""><img src="../Images/f4dd8badfa6deadd28bb99fdaec44576.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2021-08/deploying-to-google-app-engine/splittraffic.png"/>T2】</a></p>

<p>单击此按钮允许您在服务版本之间定向流量。在下面的截图中，你可以看到流量在最新的两个版本之间对半分割。您已经随机分割了流量，因为这允许您刷新URL并查看两个版本。但是，如果您正在执行生产canary部署，您可能会基于cookie或IP地址将用户定向到同一版本，这样每个请求就不会被路由到随机版本:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-08/deploying-to-google-app-engine/traffic.png" class="zoom" data-title=""><img src="../Images/25f4ad45fa831b55e2c4950a3bb59a05.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2021-08/deploying-to-google-app-engine/traffic.png"/></a>T2】</p>

<p>现在对https://[project name]. UC . r . appspot . com/的请求50%返回0.1.9版本，50%返回0.1.10版本。</p>

<p>金丝雀部署是通过逐渐增加新版本服务的流量来实现的。完成任何测试后，蓝/绿部署只需将流量100%切换到新版本。您可以使用类似https://[version]-dot-[project name]. UC . r . appspot . com/的URL测试任何流量分流规则之外的特定版本。</p>

<h2 id="conclusion">结论</h2>

<p>Google App Engine为托管web应用程序提供了一个灵活的平台。网络路由和流量分流功能允许执行复杂的部署流程，如功能分支、金丝雀和蓝/绿。</p>

<p>在这篇博文中，我部署了一个简单的Java web应用程序，并演示了如何执行高级部署模式。</p>

<p>愉快的部署！</p>

                    
                    
</body>
</html>