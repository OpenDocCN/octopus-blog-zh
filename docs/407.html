<html>
<head>
<title>Maintaining your own version of the Azure CLI - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>维护您自己版本的Azure CLI - Octopus Deploy</h1>
<blockquote>原文：<a href="https://octopus.com/blog/maintaining-own-version-azure-cli#2022-07-26">https://octopus.com/blog/maintaining-own-version-azure-cli#2022-07-26</a></blockquote>
                        <p>Octopus Deploy之前支持Azure命令行界面(CLI)作为其<a href="https://github.com/OctopusDeploy/WorkerTools" rel="nofollow">定制工人工具</a>的一部分。然而，从Octopus 2021.1开始，Octopus不再保持当前的Azure CLI版本。如果您的部署使用预捆绑版本，您将收到一条警告，建议您维护您的工作映像。</p>

<p>提供了与Octopus Deploy捆绑在一起的Azure工具，以方便需要针对Azure目标运行脚本的用户。Octopus捆绑了Azure资源管理器PowerShell模块(AzureRM)和Azure CLI的版本。从Octopus 2021.1开始，我们建议使用运行部署所需的版本来维护您自己的Worker容器。通过这种方式，提供的工具与部署指定的需求相匹配。</p>

<p>在这篇文章中，我将向您展示如何使用最新的Azure CLI版本创建自定义Docker映像，如何在Docker Hub上托管它，以及如何在Octopus部署中使用它。</p>

<h2 id="installing-and-pushing-a-custom-container">安装和推送自定义容器</h2>

<p>首先，创建一个Dockerfile文件，指定操作系统和Azure CLI安装命令。将安装最新版本的CLI(2 . 28 . 0)。</p>

<pre><code>FROM ubuntu:18.04

ARG DEBIAN_FRONTEND=noninteractive
ARG Azure_Cli_Version=2.28.0\*

# Install wget, apt-utils, and software-properties-common
RUN apt-get update &amp;&amp; \
apt-get install -y wget apt-utils &amp;&amp; \
apt-get install -y software-properties-common

# Install the Azure CLI
RUN wget --quiet -O - https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor | tee /etc/apt/trusted.gpg.d/microsoft.asc.gpg &gt; /dev/null &amp;&amp; \
echo "deb [arch=amd64] https://packages.microsoft.com/repos/azure-cli/ bionic main" | tee /etc/apt/sources.list.d/azure-cli.list &amp;&amp; \
apt-get update &amp;&amp; \
apt-get install -y azure-cli=${Azure_Cli_Version}

# Tidy up
RUN apt-get clean
</code></pre>

<p>如果需要，该文档可以包括其他形式的工具。</p>

<p>我们建议每个人维护他们的工具版本，以获得一致的部署结果。</p>

<p>运行Docker buildx命令来构建映像并将其推送到Docker Hub。(请注意，这些说明是针对M1 Mac电脑的。)</p>

<p>使用多个平台确保Octopus Deploy将下载适当的版本。</p>

<pre><code>docker buildx build --platform linux/amd64,linux/arm64,linux/arm/v7 -t terenceocto/azcli:latest --push .
</code></pre>

<p>成功后，Docker将在Docker Hub上托管映像。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-08/maintaining-own-version-azure-cli/docker-success.png" class="zoom" data-title=""><img src="../Images/1e49e58c3c1a3efb7b53004184730a6b.png" class="img-fluid center" alt="docker success" data-original-src="https://i.octopus.com/blog/2022-08/maintaining-own-version-azure-cli/docker-success.png"/>T2】</a></p>

<h2 id="confirming-success">确认成功</h2>

<p>通过<a href="https://octopus.com/docs/projects/steps/execution-containers-for-workers">指定自定义容器</a>，可以使用内置的Azure CLI来显示和确认CLI的版本号。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-08/maintaining-own-version-azure-cli/az-cli-old.png" class="zoom" data-title=""><img src="../Images/51b1deca3356f007ae2af7f9b68cce66.png" class="img-fluid center" alt="az cli old" data-original-src="https://i.octopus.com/blog/2022-08/maintaining-own-version-azure-cli/az-cli-old.png"/>T2】</a></p>

<p>使用定制容器指令，在Octopus UI中指定新的定制图像，并再次打印出版本。Azure CLI现在是最新版本。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-08/maintaining-own-version-azure-cli/az-cli-new.png" class="zoom" data-title=""><img src="../Images/cf28680c9f0bb2fce0b36df1a6bc1767.png" class="img-fluid center" alt="az cli new" data-original-src="https://i.octopus.com/blog/2022-08/maintaining-own-version-azure-cli/az-cli-new.png"/></a>T2】</p>

<h2 id="conclusion">结论</h2>

<p>从Octopus 2021.1开始，Azure CLI和其他工具不再是最新的。您应该为您的映像提供支持您的部署的工具。</p>

<p>在本文中，您学习了如何使用最新的Azure CLI设置Docker映像，并在Octopus部署中使用它。</p>

<p>愉快的部署！</p>

                    
                    
</body>
</html>