<html>
<head>
<title>Configuring Jenkins in Azure and deploying with Octopus - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>在Azure中配置Jenkins并使用Octopus - Octopus Deploy部署</h1>
<blockquote>原文：<a href="https://octopus.com/blog/configuring-jenkins-azure-deploying-octopus#2022-05-13">https://octopus.com/blog/configuring-jenkins-azure-deploying-octopus#2022-05-13</a></blockquote>
                        <p>Jenkins是市场上最受欢迎的持续集成(CI)平台。它是开源和免费的，让你自动构建和测试你的代码。</p>

<p>您可以将它与Octopus Deploy一起使用来自动管理发布和部署。</p>

<p>在这篇文章中，我将向您展示如何配置一个Jenkins实例，将一个包推送到Octopus Deploy实例，以及将一个web应用程序部署到Azure。</p>

<h2 id="before-you-start">开始之前</h2>

<p>要跟进这篇文章，你需要:</p>





<h2 id="setting-up-jenkins-for-octopus-deploy">为Octopus部署设置Jenkins</h2>

<p>设置完Jenkins后，转到Jenkins实例的URL来访问UI。</p>

<p>在UI中，进入<strong>管理Jenkins </strong>，然后进入<strong>管理插件</strong>，在<strong>可用</strong>下搜索Octopus Deploy插件，安装插件。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-05/configuring-jenkins-azure-deploying-octopus/octopus-plugin.png" class="zoom" data-title=""><img src="../Images/a62a1aca3006605bced5a7429627416d.png" class="img-fluid center" alt="Octopus Plugin" data-original-src="https://i.octopus.com/blog/2022-05/configuring-jenkins-azure-deploying-octopus/octopus-plugin.png"/>T2】</a></p>

<p>现在需要在Octopus部署实例中生成一个API键。</p>

<p>在Octopus中，进入你的<strong>用户名</strong>，然后<strong>个人资料</strong>，然后<strong>我的API密匙</strong>，创建一个密匙。Jenkins使用这个值。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-05/configuring-jenkins-azure-deploying-octopus/octopus-api-key.png" class="zoom" data-title=""><img src="../Images/557e90de5d133cd96c53b6680da38755.png" class="img-fluid center" alt="Octopus API Key" data-original-src="https://i.octopus.com/blog/2022-05/configuring-jenkins-azure-deploying-octopus/octopus-api-key.png"/>T2】</a></p>

<p>接下来，进入<strong>管理詹金斯</strong>，然后<strong>配置系统</strong>。</p>

<p>在Octopus Deploy插件设置下，添加Octopus Deploy实例的URL，并添加API密钥。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-05/configuring-jenkins-azure-deploying-octopus/octopus-url.png" class="zoom" data-title=""><img src="../Images/725438a1272dc9d95d01f435279da2d7.png" class="img-fluid center" alt="Octopus URL" data-original-src="https://i.octopus.com/blog/2022-05/configuring-jenkins-azure-deploying-octopus/octopus-url.png"/>T2】</a></p>

<p>Jenkins让你的编译包在Octopus中可用，随时可以部署。</p>

<p>进入Jenkins主页，点击<strong>新项目</strong>，然后点击<strong>自由式项目</strong>，并分配以下设置，创建一个新作业:</p>

<h3 id="source-code-management">源代码管理</h3>

<p>Git: <code>https://github.com/OctopusSamples/RandomQuotes-JS.git</code>构建说明符:<code>*/master</code></p>

<h3 id="build-triggers">构建触发器</h3>

<p>轮询供应链:<code>H/5 * * * *</code></p>

<h3 id="build-step-execute-shell">构建步骤-执行shell</h3>

<p>您必须在虚拟机上安装npm和Node.js。</p>

<pre><code>npm install
npm tests
</code></pre>

<h3 id="build-step-octopus-deploy-package-application">构建步骤Octopus部署:打包应用程序</h3>

<ul>
<li>Octopus部署CLI:默认</li>
<li>包ID: <code>RandomQuotes</code></li>
<li>版本号:<code>1.0.${BUILD_NUMBER}</code></li>
<li>包格式:zip</li>
<li>包包含路径:<code>${WORKSPACE}/**</code></li>
<li>包输出文件夹:<code>${WORKSPACE}</code></li>
</ul>

<h3 id="build-step-octopus-deploy-push-packages">构建步骤Octopus部署:推送包</h3>

<ul>
<li>Octopus部署CLI:默认</li>
<li>章鱼部署连接:奥克托-詹金斯</li>
<li>包路径:<code>${WORKSPACE}/RandomQuotes.1.0.${BUILD_NUMBER}.zip</code></li>
</ul>

<p>点击<strong>保存</strong>。</p>

<p>回到<strong>仪表板</strong>并点击<strong>立即构建</strong>开始工作。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-05/configuring-jenkins-azure-deploying-octopus/jenkins-build-now.png" class="zoom" data-title=""><img src="../Images/b29393315eeeece45434ff834e8b23a3.png" class="img-fluid center" alt="Jenkins Build Now" data-original-src="https://i.octopus.com/blog/2022-05/configuring-jenkins-azure-deploying-octopus/jenkins-build-now.png"/>T2】</a></p>

<p>构建开始后，导航到构建号并检查其进度。如果每个步骤都通过了，您会看到一个成功状态。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-05/configuring-jenkins-azure-deploying-octopus/jenkins-success.png" class="zoom" data-title=""><img src="../Images/64d4ba29d68454dcd8f1a67e2509257a.png" class="img-fluid center" alt="Jenkins Success" data-original-src="https://i.octopus.com/blog/2022-05/configuring-jenkins-azure-deploying-octopus/jenkins-success.png"/>T2】</a></p>

<p>Jenkins将包上传到Octopus Deploy实例，您可以在<strong>库</strong>下找到该实例，然后在<strong>包</strong>下找到该实例。软件包版本对应于Jenkins中的最新内部版本号。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-05/configuring-jenkins-azure-deploying-octopus/octopus-package.png" class="zoom" data-title=""><img src="../Images/0ac83de5df5a2559a30ddb41bae61527.png" class="img-fluid center" alt="Octopus Package" data-original-src="https://i.octopus.com/blog/2022-05/configuring-jenkins-azure-deploying-octopus/octopus-package.png"/>T2】</a></p>

<h2 id="configuring-an-azure-account">配置Azure帐户</h2>

<p>您需要配置一个Azure帐户和web应用程序作为从Octopus部署的目标。也可以使用其他目标，比如AWS或者Linux和Windows服务器。</p>

<p>通过导航到<a href="https://portal.azure.com/" rel="nofollow"> Azure门户</a>在Azure中创建一个帐户。</p>

<h3 id="create-service-principal-account-in-azure">使用Azure门户创建Azure服务主体</h3>

<iframe src="https://www.youtube.com/embed/QDwDi17Dkfs" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen="">VIDEO</iframe>

<ol>
<li>在Azure门户中，打开菜单，导航到<strong> Azure Active Directory </strong>，然后导航到<strong>属性</strong>，并复制来自<strong>租户ID </strong>字段的值。这是您的<strong>租户ID </strong>。</li>
<li>接下来你需要你的<strong>应用ID </strong>:</li>
</ol>

<ul>
<li>如果你创建了一个AAD注册的应用，导航到<strong> Azure Active Directory </strong>，然后<strong>应用注册</strong>，点击<strong>查看所有应用</strong>。选择应用程序并复制<strong>应用程序ID </strong>。请注意，Azure UI默认为<strong>拥有的应用</strong>标签。点击<strong>所有应用</strong>选项卡查看所有应用注册。</li>
<li>如果您尚未创建已注册的应用程序，请导航至<strong> Azure Active Directory </strong>，然后导航至<strong>应用程序注册</strong>，点击<strong>新注册</strong>，并为您的应用程序添加详细信息，然后点击<strong>保存</strong>。记下<strong>应用ID </strong>。</li>
</ul>

<ol>
<li>通过导航到<strong>证书&amp;机密</strong>，然后导航到<strong>新客户端机密</strong>，生成一次性密码。添加新密码，输入描述，点击<strong>保存</strong>。记下显示的应用程序密码，以便在Octopus中使用。如果您不想接受默认的密码一年到期，您可以更改到期日期。</li>
</ol>

<p>您现在拥有以下内容:</p>

<ul>
<li>租户ID</li>
<li>应用程序ID</li>
<li>应用程序密码/机密</li>
</ul>

<p>这意味着您可以<a href="#add-service-principal-account">在Octopus </a>中添加服务主账户。</p>

<p>接下来，您需要配置您的<a href="#resource-permissions">资源权限</a>。</p>

<h3 id="resource-permissions">资源权限</h3>

<p>资源权限确保你的注册应用可以使用你的Azure资源。</p>

<ol>
<li>在Azure门户中，导航到<strong>资源组</strong>并选择您希望注册的应用程序访问的资源组。如果资源组不存在，通过转到<strong>主页</strong>，然后<strong>资源组</strong>，然后<strong>创建</strong>来创建一个资源组。创建之后，记下资源组的Azure订阅ID。</li>
<li>点击<strong>访问控制(IAM) </strong>选项。在<strong>角色分配</strong>下，如果您的应用未列出，请点击<strong>添加角色分配</strong>。选择适当的角色(<strong> Contributor </strong>是一个常见选项)，并搜索您的新应用程序名称。从搜索结果中选择它，然后点击<strong>保存</strong>。</li>
</ol>

<p>下一步是设置一个Azure web应用程序<a href="#web-application-setup">并配置其属性。</a></p>

<h3 id="web-application-setup">Web应用程序设置</h3>

<ol>
<li>在你的<strong>资源组</strong>中点击<strong>创建</strong>，然后<strong> Web App </strong>。</li>
<li>在运行时堆栈和操作系统下创建Windows节点应用程序。</li>
<li>记下你的Azure应用名称，因为这将是你的web应用的地址:<code>[your-site].azurewebsites.net</code>。</li>
</ol>

<h3 id="add-service-principal-account">在八达通上加入服务主账户</h3>

<p>您可以使用以下值将您的帐户添加到Octopus:</p>

<ul>
<li>应用程序ID</li>
<li>租户ID</li>
<li>应用程序密码/密钥</li>
</ul>

<ol>
<li>导航至<strong>基础设施</strong>，然后导航至<strong>账户</strong></li>
<li>选择<strong>添加账户</strong>，然后选择<strong> Azure订阅</strong></li>
<li>在Octopus中给帐户起一个你想要的名字</li>
<li>给账户一个描述</li>
<li>添加您的Azure订阅ID -这可以在Azure门户的<strong>订阅</strong>下找到</li>
<li>添加<strong>应用ID </strong>、<strong>租户ID </strong>和<strong>应用密码/关键字</strong></li>
</ol>

<p>点击<strong>保存并测试</strong>以确认帐户可以与Azure交互。Octopus尝试使用帐户凭证来访问Azure资源管理(ARM) API，并列出该订阅中的资源组。</p>

<p>您可能需要将目标Azure数据中心的IP地址列入白名单。请参见<a href="https://octopus.com/docs/deployments/azure">通过防火墙部署到Azure</a>了解更多详细信息。</p>

<p>新创建的服务主体可能需要几分钟才能通过凭据测试。如果您已经仔细检查了您的凭据值，请等待15分钟，然后重试。</p>


<h2 id="configuring-octopus-to-deploy-to-azure">配置Octopus以部署到Azure</h2>

<p>在您的Octopus实例中，通过转到<strong>基础设施</strong>，然后转到<strong>环境</strong>，再转到<strong>添加环境</strong>来添加生产环境。</p>

<p>转到<strong>基础设施</strong>，然后<strong>部署目标</strong>并添加一个Azure Web应用。分配生产环境，并为目标设置一个角色(例如，<code>azure</code>)。</p>

<p>选择您之前设置的Azure帐户，并选择您的Azure Web应用程序。点击<strong>保存</strong>。</p>

<p>进入<strong>项目</strong>创建一个项目，然后<strong>添加项目</strong>。</p>

<p>转到<strong>工序</strong>部分。添加一个<strong>部署Azure App服务步骤</strong>。</p>

<h3 id="on-behalf-of">代表</h3>

<ol>
<li>选择角色(例如，<code>azure</code>)</li>
</ol>

<h3 id="deployments">部署</h3>

<ol start="2">
<li>选择从zip、Java WAR或NuGet包部署</li>
<li>从内置库中选择包</li>
</ol>

<p>其他一切使用默认设置。</p>

<p>转到您的项目并创建一个发布。点击<strong>保存</strong>，然后<strong>部署到生产</strong>，然后<strong>部署</strong>，等待部署完成。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-05/configuring-jenkins-azure-deploying-octopus/octopus-success.png" class="zoom" data-title=""><img src="../Images/89ccce4bacea905aa4eb871f9712c1aa.png" class="img-fluid center" alt="Octopus Success" data-original-src="https://i.octopus.com/blog/2022-05/configuring-jenkins-azure-deploying-octopus/octopus-success.png"/>T2】</a></p>

<p>转到您的站点URL <code>[your-site].azurewebsites.net</code>来查看部署的web应用程序。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-05/configuring-jenkins-azure-deploying-octopus/randomquotes.png" class="zoom" data-title=""> T45 </a></p>

<h2 id="post-build">后期制作</h2>

<p>Octopus Deploy Jenkins插件也可以用于在Jenkins中创建发布和部署。</p>

<p>在Jenkins作业的仪表板中，转到<strong>配置</strong>，并添加以下步骤:</p>

<h3 id="post-build-action-create-release">后期生成操作:创建发布</h3>

<ul>
<li>Octopus部署CLI:默认</li>
<li>八达通服务器:<code>Octo-Jenkins</code></li>
<li>项目名称:<code>jenkins</code></li>
<li>发布版本:<code>0.0.i</code></li>
<li>是否在创建后部署此版本？选中该框</li>
</ul>

<p>点击<strong>保存</strong>，返回作业仪表盘，点击<strong>立即构建</strong>。Jenkins触发包的构建，并在Octopus Deploy中开始构建后的发布和部署步骤。</p>

<h2 id="conclusion">结论</h2>

<p>在本文中，您设置并使用了一个Jenkins实例来构建并推送一个包到Octopus Deploy。您使用这个包将web应用程序部署到Azure Web应用程序。</p>

<p>这篇文章向你展示了Jenkins如何集成Octopus Deploy来自动管理发布和部署。</p>

<p>尝试我们免费的Jenkins管道生成器工具来用Groovy语法创建一个管道文件。这是您启动管道项目所需的一切。</p>

<p>有关持续集成(CI)和构建服务器的更多信息，<a href="https://octopus.com/blog/tag/CI%20Series">请查看我们的CI博客系列</a>。</p>

<p>愉快的部署！</p>

                    
                    
</body>
</html>