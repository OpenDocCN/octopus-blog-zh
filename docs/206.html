<html>
<head>
<title>Deploying to Octopus from Jenkins Using Pipelines - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>使用管道从Jenkins部署到Octopus-Octopus Deploy</h1>
<blockquote>原文：<a href="https://octopus.com/blog/deploying-to-octopus-from-jenkins#2022-07-15">https://octopus.com/blog/deploying-to-octopus-from-jenkins#2022-07-15</a></blockquote>
                        <p>在<a href="/blog/installing-jenkins-from-scratch">之前的博客文章</a>中，我向您展示了如何使用构建Maven项目并将其发布到Octopus所需的工具建立并运行Jenkins的基本实例。</p>

<p>在这篇博文中，我们将看看如何使用<a href="https://jenkins.io/doc/book/pipeline/" rel="nofollow"> Jenkins Pipelines </a>构建一个<code>Jenkinsfile</code>，它将使用这些工具构建一个WAR文件，将其推送到Octopus，并部署到Tomcat服务器。</p>

<h2 id="creating-a-tomcat-deployment-project-in-octopus">在Octopus中创建Tomcat部署项目</h2>

<p>第一步是在Octopus中创建一个新项目，将Java web应用程序部署到Tomcat。</p>

<p>为此，我们将有一个名为<code>Thymeleaf Demo</code>的Octopus项目，只有一个<code>Deploy to Tomcat via Manager</code>步骤。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2017-11/deploy-to-tomcat.png" class="zoom" data-title=""><img src="../Images/d1c1ea927b4e28dd6e41146cbf5a1608.png" class="img-fluid center" alt="Deploy to Tomcat step" data-original-src="https://i.octopus.com/blog/2017-11/deploy-to-tomcat.png"/>T2】</a></p>

<p>这一步将把名为<code>demo</code>的包从内置提要部署到位于<code>http://localhost:38080/manager</code>的Tomcat实例。</p>

<p>注意，在这一点上，我们可能在内置库中有一个名为<code>demo</code>的包，也可能没有。创建步骤时，我们可以在包可用之前引用它。</p>

<p><code>Tomcat Manager URL</code>是相对于执行部署的触手而言的。因为触手通常会安装在托管Tomcat的机器上，所以URL主机名通常是<code>localhost</code>。</p>


<p><a href="#" data-featherlight="https://i.octopus.com/blog/2017-11/tomcat-step.png" class="zoom" data-title=""><img src="../Images/6e0d0d057c16585e122c79f5e16493d5.png" class="img-fluid center" alt="Tomcat step" data-original-src="https://i.octopus.com/blog/2017-11/tomcat-step.png"/>T2】</a></p>

<h2 id="saving-api-keys">保存API密钥</h2>

<p>我们的<code>Jekninsfile</code>将在使用Octo CLI工具时使用Octopus API密钥。然而，我们不想将API键保存到<code>Jenkinsfile</code>中，因为这个文件应该被签入到源代码控制中。</p>

<p>幸运的是，我们可以在Jenkins中保存像API密钥这样的秘密信息，并从<code>Jenkinsfile</code>中引用它。</p>

<p>点击<span class="path">凭证➜系统</span>，然后点击<span class="path">全局凭证➜添加凭证</span>。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2017-11/jenkins-credentials.png" class="zoom" data-title=""><img src="../Images/203a350dbd47d135735a305ed5eca4ed.png" class="img-fluid center" alt="Jenkins credentials" data-original-src="https://i.octopus.com/blog/2017-11/jenkins-credentials.png"/>T2】</a></p>

<p>从<code>Kind</code>列表中选择<code>Secret Text</code>，在<code>Secret</code>字段中粘贴API key，在<code>ID</code>字段中输入<code>OctopusAPIKey</code>。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2017-11/api-key.png" class="zoom" data-title=""><img src="../Images/e87da2db55c339c271218c599b4c903f.png" class="img-fluid center" alt="API Key" data-original-src="https://i.octopus.com/blog/2017-11/api-key.png"/>【T34】T2】</a></p>

<h2 id="creating-the-jenkinsfile">创建Jenkinsfile</h2>

<p>A <code>Jenkinsfile</code>描述了Jenkins将遵循的构建和部署项目的流程。在我们的例子中,<code>Jenkinsfile</code>将描述如何用Maven构建一个项目，如何将生成的WAR文件推送到Octopus，然后如何在Octopus中创建和部署一个版本。</p>

<p>来看看完整的<code>Jenkinsfile</code>。</p>

<pre><code class="language-groovy">pipeline {
    agent any
    tools {
        maven 'Maven 3.5.2'
        jdk 'Java 9'
    }
    stages {
        stage ('Initialize') {
            steps {
                sh '''
                    echo "PATH = ${PATH}"
                    echo "M2_HOME = ${M2_HOME}"
                '''
            }
        }

        stage ('Build') {
            steps {
                sh 'mvn package'
            }
        }

        stage ('Deploy to Octopus') {
            steps {
                withCredentials([string(credentialsId: 'OctopusAPIKey', variable: 'APIKey')]) {
                    sh """
                        ${tool('Octo CLI')}/Octo push --package target/demo.0.0.1-SNAPSHOT.war --replace-existing --server https://youroctopusserver --apiKey ${APIKey}
                        ${tool('Octo CLI')}/Octo create-release --project "Thymeleaf Demo" --server https://youroctopusserver --apiKey ${APIKey}
                        ${tool('Octo CLI')}/Octo deploy-release --project "Thymeleaf Demo" --version latest --deployto Integration --server https://youroctopusserver --apiKey ${APIKey}
                    """
                }
            }
        }
    }
}
</code></pre>

<p>首先，我们需要公开我们的构建将使用的工具。在我们的例子中，我们需要使用在<a href="/blog/installing-jenkins-from-scratch">之前的博客文章</a>中定义的Java和Maven工具。</p>

<p>在<code>Jenkinsfile</code>中使用的名称需要与我们在Jenkins中给工具的名称相匹配。</p>


<pre><code>tools {
    maven 'Maven 3.5.2'
    jdk 'Java 9'
}
</code></pre>

<p>我们可以看到这些工具在<code>Initialize</code>阶段修改了环境变量<code>PATH</code>和<code>M2</code>。</p>

<pre><code>stage ('Initialize') {
    steps {
        sh '''
            echo "PATH = ${PATH}"
            echo "M2_HOME = ${M2_HOME}"
        '''
    }
}
</code></pre>

<p>执行构建时，这些<code>echo</code>命令在输出中显示以下文本。您可以看到<code>Java 9</code>和<code>Maven 3.5.2</code>工具是如何添加到<code>PATH</code>环境变量中的。</p>

<pre><code>[Java_Demo_master-MGS2PX56MOUS3SDGT4NCJIWUFLV7GTCUYZIZ6SVGHQVXJPBCSCFA] Running shell script
+ echo PATH = /var/lib/jenkins/tools/hudson.model.JDK/Java_9/bin:/var/lib/jenkins/tools/hudson.tasks.Maven_MavenInstallation/Maven_3.5.2/bin:/var/lib/jenkins/tools/hudson.model.JDK/Java_9/bin:/var/lib/jenkins/tools/hudson.tasks.Maven_MavenInstallation/Maven_3.5.2/bin:/usr/local/bin:/usr/bin:/bin:/usr/local/games:/usr/games:/snap/bin
PATH = /var/lib/jenkins/tools/hudson.model.JDK/Java_9/bin:/var/lib/jenkins/tools/hudson.tasks.Maven_MavenInstallation/Maven_3.5.2/bin:/var/lib/jenkins/tools/hudson.model.JDK/Java_9/bin:/var/lib/jenkins/tools/hudson.tasks.Maven_MavenInstallation/Maven_3.5.2/bin:/usr/local/bin:/usr/bin:/bin:/usr/local/games:/usr/games:/snap/bin
+ echo M2_HOME = /var/lib/jenkins/tools/hudson.tasks.Maven_MavenInstallation/Maven_3.5.2
M2_HOME = /var/lib/jenkins/tools/hudson.tasks.Maven_MavenInstallation/Maven_3.5.2
</code></pre>

<p>在<code>Build</code>阶段，我们执行Maven构建。</p>

<pre><code>stage ('Build') {
    steps {
        sh 'mvn package'
    }
}
</code></pre>

<p>最后的<code>Deploy to Octopus</code>阶段是我们推送Maven构建的WAR文件，在Octopus中创建一个发布，并将该发布部署到<code>Integration</code>环境中。</p>

<pre><code>stage ('Deploy to Octopus') {
    steps {
        withCredentials([string(credentialsId: 'OctopusAPIKey', variable: 'APIKey')]) {
            sh """
                ${tool('Octo CLI')}/Octo push --package target/demo.0.0.1-SNAPSHOT.war --replace-existing --server https://youroctopusserver --apiKey ${APIKey}
                ${tool('Octo CLI')}/Octo create-release --project "Thymeleaf Demo" --server https://youroctopusserver --apiKey ${APIKey}
                ${tool('Octo CLI')}/Octo deploy-release --project "Thymeleaf Demo" --version latest --deployto Integration --server https://youroctopusserver --apiKey ${APIKey}
            """
        }
    }
}
</code></pre>

<p>注意，我们已经使用<code>withCredentials</code>将保存在Jenkins中的Octopus API密匙<code>OctopusAPIKey</code>作为变量<code>APIKey</code>公开。我们在这个<code>withCredentials</code>块中运行的任何脚本都可以访问由Jenkins维护的秘密。</p>

<pre><code>withCredentials([string(credentialsId: 'OctopusAPIKey', variable: 'APIKey')]) {
    sh """
        ...
    """
}
</code></pre>

<p>在<code>withCredentials</code>块中，我们针对Octo CLI执行三个命令:<code>push</code>、<code>create-release</code>和<code>deploy-release</code>。</p>

<p>如果你还记得<a href="/blog/installing-jenkins-from-scratch">之前的博文</a>，那么<code>Octo CLI</code>被定义为一个定制工具。我们可以通过调用<code>${tool('Octo CLI')}/Octo</code>来引用这个工具。</p>

<p>将这个<code>Jenkinsfile</code>与我们的Java代码一起检入，我们就可以创建一个Jenkins项目来使用它了。</p>

<h2 id="creating-a-jenkins-pipeline-project">创建詹金斯管道项目</h2>

<p>为了使用我们的Java项目及其关联的<code>Jenkinsfile</code>，我们需要在Jenkins中创建一个新的<code>Multibranch Pipeline</code>项目。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2017-11/multibranch-pipeline.png" class="zoom" data-title=""><img src="../Images/94c9d915290145bb6295aae7ed462a35.png" class="img-fluid center" alt="Multibranch pipeline" data-original-src="https://i.octopus.com/blog/2017-11/multibranch-pipeline.png"/>T2】</a></p>

<p>在这个项目中我们唯一需要改变的设置是<code>Project Repository</code>，我已经将它设置为<code>https://github.com/OctopusDeploy/ThymeleafSpringDemo</code>。这个repo持有一个演示的Spring Java web应用程序，并且有一个上面描述的<code>Jenkinsfile</code>的副本。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2017-11/java-demo.png" class="zoom" data-title=""><img src="../Images/05f285461aad592c2efbe3f597a5a1f9.png" class="img-fluid center" alt="Java Demo" data-original-src="https://i.octopus.com/blog/2017-11/java-demo.png"/>T2】</a></p>

<h2 id="building-and-deploying">构建和部署</h2>

<p>一旦构建完成，这就是我们的<code>Jenkinsfile</code>的结果。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2017-11/pipeline-build.png" class="zoom" data-title=""><img src="../Images/5ddc728b5e535164106e7bd59cb6dc4f.png" class="img-fluid center" alt="Pipeline Build" data-original-src="https://i.octopus.com/blog/2017-11/pipeline-build.png"/>T2】</a></p>

<p>在Octopus中，WAR文件被推送到内置库中。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2017-11/octopus-library.png" class="zoom" data-title=""><img src="../Images/7f414ff82628dc41fbf90c6f2efa00bc.png" class="img-fluid center" alt="Octopus library" data-original-src="https://i.octopus.com/blog/2017-11/octopus-library.png"/>T2】</a></p>

<p>并且已经创建和部署了一个版本。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2017-11/octopus-release.png" class="zoom" data-title=""><img src="../Images/54a86770308946e40d32d272384c0483.png" class="img-fluid center" alt="Octopus Release" data-original-src="https://i.octopus.com/blog/2017-11/octopus-release.png"/>T2】</a></p>

<p>然后将应用程序部署到Tomcat。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2017-11/tomcat-manager.png" class="zoom" data-title=""><img src="../Images/af6d85ce7d72fc878cea7287aa2895c5.png" class="img-fluid center" alt="Tomcat manager" data-original-src="https://i.octopus.com/blog/2017-11/tomcat-manager.png"/>T2】</a></p>

<h2 id="conclusion">结论</h2>

<p>Jenkins管道是一种描述构建过程的强大方式，通过使用Octo CLI作为定制工具，将Octopus集成到您的构建管道中是非常容易的。</p>

<p>如果您对Java应用程序的自动化部署感兴趣，<a href="https://octopus.com/downloads">下载Octopus Deploy的试用版</a>，并查看我们的文档。</p>

                    
                    
</body>
</html>