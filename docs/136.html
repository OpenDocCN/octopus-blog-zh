<html>
<head>
<title>Constructing build information - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>构建构建信息- Octopus部署</h1>
<blockquote>原文：<a href="https://octopus.com/blog/constructing-build-information#2022-01-19">https://octopus.com/blog/constructing-build-information#2022-01-19</a></blockquote>
                        <p>构建服务器传统上是一种内部工具，但是，许多组织决定将他们的构建卸载到云上。</p>

<p>Azure DevOps、Jenkins (CloudBees)以及最近的TeamCity等大牌公司都创建了他们流行的构建平台的云版本。像AppVeyor、Travis CI、Circle CI、GitHub Actions和GitLab这样的纯在线技术也越来越受欢迎。</p>

<p>对于已经开发了插件或集成的技术，推送构建信息就像将任务添加到流程中一样简单。</p>

<p>对于那些唯一的选择是集成Octopus CLI(运行时或容器)的技术，让提交信息显示出来可能会令人困惑。</p>

<p>在这篇文章中，我演示了如何构建将构建信息推送到Octopus Deploy所需的文件。</p>

<h2 id="gitlab">GitLab</h2>

<p>在这篇文章中，我使用GitLab作为构建服务器，因为我以前没有使用过它。</p>

<p>这篇文章关注的是生成<a href="https://octopus.com/docs/packaging-applications/build-servers/build-information">构建信息</a>并将其上传到Octopus Deploy的单一任务。它不包括使用GitLab构建应用程序。</p>

<h3 id="variables">变量</h3>

<p>在开始构建定义之前，您需要创建在流程中使用的变量:</p>

<ul>
<li>GitLab个人访问令牌</li>
<li>Octopus部署API密钥</li>
<li>Octopus部署服务器URL</li>
<li>Octopus部署空间名称</li>
</ul>

<h4 id="gitlab-personal-access-token">GitLab个人访问令牌</h4>

<p>为了收集您正在执行的构建的提交，您需要对GitLab进行API调用。API端点受到保护，需要访问令牌才能成功调用它。</p>

<h5 id="creating-a-personal-access-token">创建个人访问令牌</h5>

<p>要创建访问令牌，请单击右上角的您的个人资料，然后选择<strong>编辑个人资料</strong>。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-08/constructing-build-information/gitlab-edit-profile.png" class="zoom" data-title=""><img src="../Images/7c1d55c790d1771682c43183676a7bb4.png" class="img-fluid center" alt="GitLab dashboard showing profile menu open and Edit profile highlighted in the drop down." data-original-src="https://i.octopus.com/blog/2021-08/constructing-build-information/gitlab-edit-profile.png"/>T2】</a></p>

<p>点击左侧菜单中的<strong>访问令牌</strong>。给你的令牌起个名字，至少要有<strong> read_api </strong>权限。</p>

<p><strong>截止日期</strong>是可选的。将其留空会创建一个永不过期的令牌。</p>

<p>点击<strong>创建个人访问令牌</strong>。当令牌显示时，将其存储在安全的地方-该值仅显示一次。</p>

<p>【T2 <img src="../Images/0c8a67c28be6d6cc3e6e9df8ab78345e.png" class="img-fluid center" alt="GitLab dashboard open on Access Tokens page with Token name field and read_api fields highlighted." data-original-src="https://i.octopus.com/blog/2021-08/constructing-build-information/gitlab-access-token.png"/></p>

<h5 id="creating-a-variable-for-personal-access-token">为个人访问令牌创建变量</h5>

<p>获得令牌后，导航回项目并单击<strong>设置</strong>，然后单击<strong> CI/CD </strong>。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-08/constructing-build-information/gitlab-settings-cicd.png" class="zoom" data-title=""><img src="../Images/eb2e82da01e35de81bf396f7dc864c09.png" class="img-fluid center" alt="GitLab dashboard drop down menu open, with Settings highlighted and Settings drop down menu with CI?CD highlighted." data-original-src="https://i.octopus.com/blog/2021-08/constructing-build-information/gitlab-settings-cicd.png"/>T2】</a></p>

<p>滚动到<strong>变量</strong>部分，点击<strong>展开</strong>。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-08/constructing-build-information/gitlab-variables-expand.png" class="zoom" data-title=""><img src="../Images/59a0e8aff0e7c2636c710637d99a3065.png" class="img-fluid center" alt="GitLab dashboard open with the Expand button highlighted in the Variables section." data-original-src="https://i.octopus.com/blog/2021-08/constructing-build-information/gitlab-variables-expand.png"/>T2】</a></p>

<p>点击<strong>添加变量</strong>并填写详细信息。对于这个例子，我使用<code>GITLAB_PAT</code>作为<strong>键</strong>和我们上面为<strong>值</strong>生成的令牌。</p>

<p>勾选<strong>掩码变量</strong>选项，确保令牌不会在构建期间显示在任何消息中。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-08/constructing-build-information/gitlab-add-variable.png" class="zoom" data-title=""><img src="../Images/c9f938cdf0591c58af12576c2c936988.png" class="img-fluid center" alt="GitLab dashboard open on the Add variable section with Mask variable tick box selected and highlighted." data-original-src="https://i.octopus.com/blog/2021-08/constructing-build-information/gitlab-add-variable.png"/>T2】</a></p>

<h4 id="octopus-variables">章鱼变量</h4>

<p>对Octopus变量重复上面的<strong>添加变量</strong>过程。这篇文章假设你熟悉<a href="https://octopus.com/docs/octopus-rest-api/how-to-create-an-api-key">创建一个API键</a>:</p>

<ul>
<li>Octopus部署API密钥</li>
<li>Octopus部署服务器URL</li>
<li>Octopus部署空间名称</li>
</ul>

<h3 id="build-yaml">建设YAML</h3>

<p>对于GitLab，构建是使用YAML在一个特殊的文件中定义的，<code>.gitlab-ci.yml</code>位于您的库的根目录中。您的流程将包括两个阶段:</p>

<ul>
<li>建筑信息</li>
<li>推送-构建-信息</li>
</ul>

<h4 id="build-information">建筑信息</h4>

<p>构建信息阶段包括构建用于上传构建信息的文件。我用PowerShell Core来构建文件，Ubuntu默认没有。我没有安装PowerShell Core，而是使用了GitLab Docker runner功能。镜像<code>mcr.microsoft.com/dotnet/core/sdk:3.1</code>是安装了PowerShell核心的。</p>

<pre><code class="language-yaml">build-information:
    stage: build-information
    image: mcr.microsoft.com/dotnet/core/sdk:3.1
</code></pre>

<h5 id="gitlab-commits-api">GitLab提交API</h5>

<p>提交API需要您之前作为变量创建的访问令牌。这个令牌需要作为流程中API调用的头提供。这些变量可以在代码中以环境变量的形式访问。变量<code>GITLAB_PAT</code>是我们创建的变量，而<code>CI_PROJECT_ID</code>是GitLab 预定义的<a href="https://docs.gitlab.com/ee/ci/variables/predefined_variables.html" rel="nofollow">。</a></p>

<pre><code class="language-powershell">$headers = @{ "PRIVATE-TOKEN" = $env:GITLAB_PAT}

# Get commits from GitLab
$commits = (Invoke-RestMethod -Method Get -Uri "https://gitlab.com/api/v4/projects/$($env:CI_PROJECT_ID)/repository/commits?first_parent=true" -Headers $headers)
</code></pre>

<h5 id="build-information-object">构建信息对象</h5>

<p>为了存储构建信息，创建一个PowerShell <a href="https://docs.microsoft.com/en-us/powershell/scripting/learn/deep-dives/everything-about-hashtable" rel="nofollow">哈希表</a>对象。<code>Commits</code>部分被定义为哈希表中的一个数组:</p>

<pre><code class="language-powershell">$jsonPayload = @{
    PackageId = "OctoPetShop.Web"
    Version = "1.0.21132.111113"
    Branch = $env:CI_COMMIT_BRANCH
    BuildUrl = $env:CI_JOB_URL
    BuildNumber = $env:CI_JOB_ID
    BuildEnvironment = "GitLabCI"
    VcsCommitNumber = $env:CI_COMMIT_SHA
    VcsType = "Git"
    VcsRoot = $env:CI_PROJECT_URL
    Commits = @()
}
</code></pre>

<p>接下来，遍历commits API调用的结果，并将它们添加到数组中:</p>

<pre><code class="language-powershell">foreach ($commit in $commits)
{
    $commitInfo = @{
        Id = $commit.id
        LinkUrl = $commit.web_url
        Comment = $commit.message
    }
    $jsonPayload.Commits += $commitInfo
}
</code></pre>

<p>最后，将PowerShell哈希表转换为JSON字符串，并将其写入文件:</p>

<pre><code class="language-powershell">Add-Content -Path "BuildInformation.json" -Value "$($jsonPayload | ConvertTo-JSON -Depth 10)"
</code></pre>

<p>您需要将该文件作为一个工件包含进来，以便在以后的过程中使用。为此，在舞台YAML中加入一个<code>artifacts</code>组件:</p>

<pre><code class="language-yaml">artifacts:
    paths: [ BuildInformation.json ]
</code></pre>

<h4 id="push-build-information">推送-构建-信息</h4>

<p>将构建信息推送到Octopus由脚本中的一个命令组成，并使用前一阶段创建的<code>BuildInformation.json</code>:</p>

<pre><code class="language-yaml">push-build-information:
    stage: push-build-information
    image: octopuslabs/gitlab-octocli
    script:
        - octo build-information --package-id=OctoPetShop.Web --version=1.0.21132.111113 --file=BuildInformation.json --server="$OCTOPUS_SERVER_URL" --apiKey="$OCTOPUS_API_KEY" --space="$OCTOPUS_SPACE_NAME"
</code></pre>

<h4 id="gitlab-ci.yml-file">。gitlab-ci.yml文件</h4>

<p>完成后，你的YAML应该看起来像这样:</p>

<pre><code class="language-yaml">image: ubuntu:latest

stages:
    - build-information
    - push-build-information

build-information:
    stage: build-information
    image: mcr.microsoft.com/dotnet/core/sdk:3.1
    script:
        - |
          pwsh -c '$headers = @{ "PRIVATE-TOKEN" = $env:GITLAB_PAT}

          # Get commits from GitLab
          $commits = (Invoke-RestMethod -Method Get -Uri "https://gitlab.com/api/v4/projects/$($env:CI_PROJECT_ID)/repository/commits?first_parent=true" -Headers $headers)

          # Create payload
          $jsonPayload = @{
            PackageId = "OctoPetShop.Web"
            Version = "1.0.21132.111113"
            Branch = $env:CI_COMMIT_BRANCH
            BuildUrl = $env:CI_PIPELINE_URL
            BuildNumber = $env:CI_PIPELINE_ID
            BuildEnvironment = "GitLabCI"
            VcsCommitNumber = $env:CI_COMMIT_SHA
            VcsType = "Git"
            VcsRoot = $env:CI_PROJECT_URL
            Commits = @()
          }

          # Loop through commits and add to collection
          foreach ($commit in $commits)
          {
            $commitInfo = @{
              Id = $commit.id
              LinkUrl = $commit.web_url
              Comment = $commit.message
            }
            $jsonPayload.Commits += $commitInfo
          }

          # Write information to file
          Add-Content -Path "BuildInformation.json" -Value "$($jsonPayload | ConvertTo-JSON -Depth 10)"'
    artifacts:
      paths: [ BuildInformation.json ]

push-build-information:
    stage: push-build-information
    image: octopuslabs/gitlab-octocli
    script:
        - octo build-information --package-id=OctoPetShop.Web --version=1.0.21132.111113 --file=BuildInformation.json --server="$OCTOPUS_SERVER_URL" --apiKey="$OCTOPUS_API_KEY" --space="$OCTOPUS_SPACE_NAME"
</code></pre>

<h2 id="executing-the-build">执行构建</h2>

<p>在构建被触发后，您将看到类似这样的内容(为了简洁起见，图片显示了日志的最后一部分):</p>

<p>构建-信息<a href="#" data-featherlight="https://i.octopus.com/blog/2021-08/constructing-build-information/gitlab-build-information-stage.png" class="zoom" data-title=""> <img src="../Images/2bfac60ea0e2779e529aabc02fdcbb48.png" class="img-fluid center" alt="GitLab build information log" data-original-src="https://i.octopus.com/blog/2021-08/constructing-build-information/gitlab-build-information-stage.png"/> </a></p>

<p>推-建-信息<a href="#" data-featherlight="https://i.octopus.com/blog/2021-08/constructing-build-information/gitlab-push-build-information-stage.png" class="zoom" data-title=""> <img src="../Images/8fbfa29d339ecb28d7b4e8d65f630947.png" class="img-fluid center" alt="GitLab build information log" data-original-src="https://i.octopus.com/blog/2021-08/constructing-build-information/gitlab-push-build-information-stage.png"/> </a></p>

<p>导航到OctoPetShop的构建信息。Web在Octopus Deploy中，您可以看到您的构建信息已经上传。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-08/constructing-build-information/octopus-build-information.png" class="zoom" data-title=""><img src="../Images/a0f09107b38b1495fb16fbc7fc4bc5c7.png" class="img-fluid center" alt="Octopus Build Information Repository dashboard showing build information for OctoPetShop.Web with list of commits." data-original-src="https://i.octopus.com/blog/2021-08/constructing-build-information/octopus-build-information.png"/></a>T2】</p>

<h2 id="conclusion">结论</h2>

<p>在这篇文章中，我演示了如何为构建信息构建文件，以及如何使用Octopus Deploy CLI上传它。</p>

<p>愉快的部署！</p>

                    
                    
</body>
</html>