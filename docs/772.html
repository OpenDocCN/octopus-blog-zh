<html>
<head>
<title>Three ways to use custom Terraform plugins - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>使用自定义Terraform插件的三种方法——Octopus Deploy</h1>
<blockquote>原文：<a href="https://octopus.com/blog/using-custom-tf-plugins#2021-08-12">https://octopus.com/blog/using-custom-tf-plugins#2021-08-12</a></blockquote>
                        <p><a href="#" data-featherlight="https://i.octopus.com/blog/2019-11/using-custom-tf-plugins/terraform-plugins.png" class="zoom" data-title=""><img src="../Images/6b285e47c0079d20a1416e6f2dec6b5b.png" class="img-fluid center" alt="Custom Terraform Plugins" data-original-src="https://i.octopus.com/blog/2019-11/using-custom-tf-plugins/terraform-plugins.png"/>T2】</a></p>

<p>Hashicorp GitHub仓库中正在进行关于支持Terraform定制插件仓库的讨论。尽管现在只有官方的Terraform插件可以按需下载，而定制插件需要手动分发。</p>

<p>在本帖中，我们将看看从Terraform模板中访问自定义插件的三种不同方式。</p>

<h2 id="the-sample-project">示例项目</h2>

<p>为了演示如何加载自定义插件，我们将创建一个非常简单的Terraform模板，它使用了<a href="https://github.com/OctopusDeploy/terraform-provider-octopusdeploy" rel="nofollow"> Octopus插件</a>。</p>

<p>为了添加对Octopus provider的依赖，我们在一个名为<code>octopus.tf</code>的文件中有以下代码:</p>

<pre><code class="language-hcl">provider "octopusdeploy" {
  address = "${var.address}"
  apikey  = "${var.apikey}"
  space   = "${var.space}"
}
</code></pre>

<p>然后在名为<code>variables.tf</code>的文件中定义变量:</p>

<pre><code class="language-hcl">variable "address" {
  default = "http://myserver"
}
variable "apikey" {
  default = "API-YOURAPIKEYGOESHERE"
}
variable "space" {
  default = "Default"
}
</code></pre>

<p>有了本地目录中的这两个文件，我们运行<code>terraform init</code>。结果是失败的，因为Terraform不知道如何获得Octopus插件。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2019-11/using-custom-tf-plugins/failure.png" class="zoom" data-title=""><img src="../Images/1e2dab163ef042e3584c70679d3f7e91.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2019-11/using-custom-tf-plugins/failure.png"/>T2】</a></p>

<p>没有可用的插件，init命令失败。</p>

<h2 id="making-the-plugin-globally-available">使插件全球可用</h2>

<p>解决该错误的第一个选项是将插件文件保存到Windows中的<code>~\AppData\Roaming\terraform.d\plugins</code>或Linux和MacOS中的<code>~/.terraform.d/plugins</code>。</p>

<p>你必须小心文件名。对于Windows，Octopus插件将具有文件名<code>terraform-provider-octopusdeploy_v0.5.0.exe</code>，对于Linux和MacOS，文件名将为<code>terraform-provider-octopusdeploy_v0.5.0</code>(用插件版本替换<code>0.5.0</code>)。任何其他文件名都将导致一个关于注册表服务不可访问的模糊错误。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2019-11/using-custom-tf-plugins/bad-filename.png" class="zoom" data-title=""><img src="../Images/d79ce6022c2630512898341cb6357a12.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2019-11/using-custom-tf-plugins/bad-filename.png"/>T2】</a></p>

<p><em>一个意外的文件名会产生这个无用的错误。</em></p>

<p>但是当您有正确的文件名时，<code>init</code>命令将成功完成。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2019-11/using-custom-tf-plugins/success.png" class="zoom" data-title=""><img src="../Images/e87604e222e0300931abeb225a38bb2e.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2019-11/using-custom-tf-plugins/success.png"/>T2】</a></p>

<p>使用正确的文件名，init命令成功。</p>

<h2 id="saving-the-plugin-alongside-the-templates">将插件保存在模板旁边</h2>

<p>下一个选项是将插件保存在模板文件旁边的<code>.terraform/plugins/&lt;arch&gt;</code>目录中。<code>&lt;arch&gt;</code>目录名与下表中的一个相匹配。同样，对于Windows，插件的文件名必须是<code>terraform-provider-octopusdeploy_v0.5.0.exe</code>，对于Linux和MacOS，插件的文件名必须是<code>terraform-provider-octopusdeploy_v0.5.0</code>。</p>

<table class="table">
<thead>
<tr>
<th>操作系统（Operating System）</th>
<th>拱门</th>
</tr>
</thead>
<tbody>
<tr>
<td>Windows 32位</td>
<td><code>windows_386</code></td>
</tr>
<tr>
<td>Windows 64位</td>
<td><code>windows_amd64</code></td>
</tr>
<tr>
<td>Linux 32位</td>
<td><code>linux_386</code></td>
</tr>
<tr>
<td>Linux 64位</td>
<td><code>linux_amd64</code></td>
</tr>
<tr>
<td>MacOS 64位</td>
<td><code>darwin_amd64</code></td>
</tr>
</tbody>
</table>

<h2 id="the-plugin-dir-option">插件目录选项</h2>

<p>最后一个选项是将插件可执行文件保存在您选择的文件夹中，并使用<code>--plugin-dir</code>参数引用它。</p>

<p>当您使用<code>--plugin-dir</code>参数时，对目录名没有特殊要求。这里我调用了<code>terraform init --plugin-dir C:\Users\Matthew\Desktop\plugins\whatever</code>来证明目录名没有意义。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2019-11/using-custom-tf-plugins/plugin-dir-whatever.png" class="zoom" data-title=""><img src="../Images/37e06fc1a20c10f9d26b871db968f126.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2019-11/using-custom-tf-plugins/plugin-dir-whatever.png"/>T2】</a></p>

<p>plugin-dir选项将获取任何包含正确插件的目录。</p>

<h2 id="conclusion">结论</h2>

<p>在Terraform实现对定制插件库的支持之前，最终用户将不得不自己部署插件可执行文件。在这里，我们看到这些插件可以保存在:</p>

<ul>
<li><code>~\AppData\Roaming\terraform.d\plugins</code>用于Windows或<code>~/.terraform.d/plugins</code>用于Linux和MacOS。</li>
<li><code>.terraform/plugins/&lt;arch&gt;</code>傍模板文件。</li>
<li>任何被<code>--plugin-dir</code>选项引用的目录。</li>
</ul>

                    
                    
</body>
</html>