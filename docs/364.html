<html>
<head>
<title>Building a Docker image in Jenkinsfile and publishing to ECR - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>在Jenkinsfile中构建Docker映像并发布到ECR - Octopus Deploy</h1>
<blockquote>原文：<a href="https://octopus.com/blog/jenkins-docker-ecr#2022-05-19">https://octopus.com/blog/jenkins-docker-ecr#2022-05-19</a></blockquote>
                        <p>在本文中，您将学习如何使用Jenkins构建Octopus Deploy underwater app并将其推送到Amazon Elastic Container Registry(ECR)。</p>

<h2 id="prerequisites">先决条件</h2>

<p>要跟进，您需要:</p>

<ul>
<li>亚马逊网络服务(AWS)帐户</li>
<li>詹金斯的例子</li>
<li>GitHub账户</li>
</ul>

<p>有关在您选择的环境中安装Jenkins的说明，您可以参考我们的指南:</p>



<p>这个帖子使用了<a href="https://github.com/OctopusSamples/octopus-underwater-app" rel="nofollow"> Octopus水下应用库</a>。您可以派生存储库并跟随它。</p>

<p>或者，jenkins-ecr分支包含模板文件来完成本文中的步骤。你需要用你自己的价值观来代替一些价值观。我把我的价值观写在这篇文章里作为参考。</p>

<h2 id="amazon-web-services-setup">亚马逊网络服务设置</h2>

<p>要为Jenkins设置AWS，您需要创建一个访问密钥和一个ECR存储库来存储图像。</p>

<p>要创建访问密钥，请前往<strong>亚马逊控制台</strong>，然后<strong> IAM </strong>，然后<strong>用户</strong>、【你的用户】、<strong>安全凭证</strong>，以及<strong>创建访问密钥</strong>。</p>

<p>您的浏览器将下载一个包含访问密钥ID和秘密访问密钥的文件。这些值将在Jenkins中用于向Amazon认证。</p>

<p>要创建存储库，请转到<strong>亚马逊控制台</strong>，然后是<strong> ECR </strong>，然后是<strong>创建存储库</strong>。</p>

<p>您需要为发布的每个图像建立一个图像存储库。给存储库起一个您想让图像起的名字。</p>

<p>你会在<strong>亚马逊ECR </strong>下看到你的仓库，然后是<strong>仓库</strong>。记下它所在的区域，在URI场。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-02/jenkins-docker-ecr/ecr-repository.png" class="zoom" data-title=""><img src="../Images/4db8aa071a7f4fc1354822624d863613.png" class="img-fluid center" alt="ECR Repository" data-original-src="https://i.octopus.com/blog/2022-02/jenkins-docker-ecr/ecr-repository.png"/>T2】</a></p>

<h2 id="jenkins-setup">Jenkins设置</h2>

<p>首先，你需要安装一些插件来与Docker和Amazon交互。</p>

<p>进入<strong>仪表板</strong>，然后<strong>管理詹金斯</strong>，然后<strong>管理插件</strong>。</p>

<p>您需要以下插件:</p>



<p>你可以在<strong>可用的</strong>标签中搜索这些插件。安装后，它们出现在<strong>已安装</strong>选项卡中。</p>

<p>您使用一个Jenkinsfile来编译、构建、测试和推送图像到Amazon ECR。Jenkinsfile是定义Jenkins管道的配置文件。Jenkins Pipeline是Jenkins对工件执行的一系列步骤，以实现期望的结果。在这种情况下，它是映像到Amazon ECR的克隆、构建、测试和推送。</p>

<p>使用Jenkinsfile的强大之处在于将它签入源代码控制中，以管理文件的不同版本。</p>

<p>在您的Jenkins实例中，转到<strong>管理Jenkins </strong>，然后<strong>管理凭证</strong>，然后<strong> Jenkins存储</strong>，然后<strong>全局凭证(无限制)</strong>，最后<strong>添加凭证</strong>。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-02/jenkins-docker-ecr/manage-credentials.png" class="zoom" data-title=""><img src="../Images/27ec68cd8c40fd0c2528a6cec45019da.png" class="img-fluid center" alt="Manage Credentials" data-original-src="https://i.octopus.com/blog/2022-02/jenkins-docker-ecr/manage-credentials.png"/>T2】</a></p>

<p>填写以下字段，将其他所有内容保留为默认值:</p>

<ul>
<li><strong>种类</strong> - AWS凭证</li>
<li><strong>ID</strong>-AWS-凭据，例如</li>
<li><strong>访问密钥ID </strong> -之前的访问密钥ID</li>
<li><strong>秘密访问密钥</strong> -之前的秘密访问密钥</li>
</ul>

<p>点击<strong>确定</strong>保存。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-02/jenkins-docker-ecr/input-key.png" class="zoom" data-title=""><img src="../Images/6be8d0c522684ce32a87e3897960fde4.png" class="img-fluid center" alt="Input Key" data-original-src="https://i.octopus.com/blog/2022-02/jenkins-docker-ecr/input-key.png"/>T2】</a></p>

<p>转到<strong>詹金斯仪表板</strong>，然后是<strong>新项目</strong>。</p>

<p>给你的管线命名，选择<strong>管线</strong>项，然后<strong>确定</strong>。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-02/jenkins-docker-ecr/add-pipeline.png" class="zoom" data-title=""> T38 </a></p>

<p>填写管道的以下字段，其他内容保持默认:</p>

<ul>
<li><strong>GITScm轮询的GitHub hook触发器</strong> -勾选该框</li>
<li><strong>定义</strong> -来自SCM的管道脚本</li>
<li><strong>单片机</strong> - Git</li>
<li><strong>存储库URL</strong>——分叉回购和jenkins-ecr分支的URL</li>
<li><strong>凭证</strong> -存储库的区域</li>
<li><strong>分支说明符</strong> - <code>*/jenkins-ecr</code></li>
</ul>

<p>点击<strong>保存</strong>。</p>

<h2 id="github-setup">GitHub设置</h2>

<p>对于这个示例，您使用一个示例web应用程序，该应用程序显示一个带有有用链接的水下动画场景。</p>

<p>您需要设置一个webhook，以便Jenkins知道存储库何时更新。为此，转到<strong>设置</strong>，然后转到<strong> Webhooks </strong>。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-02/jenkins-docker-ecr/webhook.png" class="zoom" data-title=""><img src="../Images/f66da9da376548eebd78cb774f23c23c.png" class="img-fluid center" alt="web-hook" data-original-src="https://i.octopus.com/blog/2022-02/jenkins-docker-ecr/webhook.png"/>T2】</a></p>

<p>填写以下字段，其他内容保持默认。</p>

<ul>
<li><strong>有效负载URL </strong> - <code>http://[jenkins-url]/github-webhook/</code></li>
<li><strong>内容类型</strong> - <code>application/json</code></li>
<li><strong>您希望哪个事件触发此webhook？</strong> -选择<strong>刚推事件</strong></li>
</ul>

<p>点击<strong>添加webhook </strong>保存。</p>

<p>将Jenkins文件添加到存储库的根级别。您需要参考您的Amazon ECR存储库。请注意以下所需的更改:</p>

<pre><code>
pipeline {
    agent any
    options {
        skipStagesAfterUnstable()
    }
    stages {
         stage('Clone repository') { 
            steps { 
                script{
                checkout scm
                }
            }
        }

        stage('Build') { 
            steps { 
                script{
                 app = docker.build("underwater")
                }
            }
        }
        stage('Test'){
            steps {
                 echo 'Empty'
            }
        }
        stage('Deploy') {
            steps {
                script{
                        docker.withRegistry('https://720766170633.dkr.ecr.us-east-2.amazonaws.com', 'ecr:us-east-2:aws-credentials') {
                    app.push("${env.BUILD_NUMBER}")
                    app.push("latest")
                    }
                }
            }
        }
    }
}
</code></pre>

<p>Jenkinsfile由不同的阶段组成。Jenkins将按顺序运行这些阶段，如果构建失败，您将看到哪个阶段失败了。</p>

<p>将您的代码提交给GitHub。该提交将在Jenkins中触发一个构建作业。转到您的Jenkins实例URL查看构建。</p>

<p>我必须通过点击<strong> Build now </strong>按钮来触发Jenkins作业。在此之后，webhook触发器在每次推送时都起作用。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-02/jenkins-docker-ecr/jenkins-success.png" class="zoom" data-title=""><img src="../Images/7c1880e68eb0c067819517d3738e2a0e.png" class="img-fluid center" alt="Jenkins Success" data-original-src="https://i.octopus.com/blog/2022-02/jenkins-docker-ecr/jenkins-success.png"/>T2】</a></p>

<p>构建完成后，转到Amazon ECR，查看构建并推送到存储库的新映像。它用Jenkins build号和<code>latest</code>标记最新的推送。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-02/jenkins-docker-ecr/ecr-success.png" class="zoom" data-title=""><img src="../Images/f8c9b056a894e9f23d8fa21413c7d4b3.png" class="img-fluid center" alt="ECR Success" data-original-src="https://i.octopus.com/blog/2022-02/jenkins-docker-ecr/ecr-success.png"/>T2】</a></p>

<h2 id="conclusion">结论</h2>

<p>在本文中，您设置了一个Jenkins管道来构建GitHub存储库，并将其推送到Amazon ECR。Jenkinsfile可以推送到其他容器注册中心，比如Google和微软提供的注册中心。根据构建要求，它还可以包括其他阶段。</p>

<p>在映像被推送之后，您可以使用像Octopus Deploy这样的工具将映像部署到目标环境。如果你还没有使用Octopus Deploy，你可以<a href="https://octopus.com/start">注册免费试用</a>。</p>

<p>查看我们关于使用Jenkins、Kubernetes和Octopus Deploy进行部署的其他帖子:</p>



<p><a href="https://oc.to/JenkinsPipelineGenerator" rel="nofollow">试试我们免费的Jenkins管道生成器工具</a>用Groovy语法创建一个管道文件。这是您启动管道项目所需的一切。</p>

<h2 id="watch-our-jenkins-pipeline-webinar">观看我们的詹金斯管道网络研讨会</h2>

<iframe src="https://www.youtube.com/embed/D_7AHTML_xw" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen="">VIDEO</iframe>

<p>我们定期举办网络研讨会。请参见<a href="https://octopus.com/events">网络研讨会第</a>页，了解有关即将举办的活动和实时流媒体录制的详细信息。</p>

<p>阅读我们的<a href="https://octopus.com/blog/tag/CI%20Series">持续集成系列</a>的其余部分。</p>

<p>愉快的部署！</p>

                    
                    
</body>
</html>