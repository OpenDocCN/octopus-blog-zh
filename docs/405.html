<html>
<head>
<title>Using local images with minikube - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>通过minikube - Octopus Deploy使用本地映像</h1>
<blockquote>原文：<a href="https://octopus.com/blog/local-images-minikube#2022-11-01">https://octopus.com/blog/local-images-minikube#2022-11-01</a></blockquote>
                        <p>minikube为DevOps团队提供了一个本地开发Kubernetes集群。在本地开发Kubernetes应用程序通常需要构建和部署本地Docker映像。虽然minikube将下载托管在外部Docker注册表上的任何Docker映像，但公开本地构建的映像需要将映像加载到minikube集群中，并注意一些抛出无用错误消息的边缘情况。</p>

<p>在本文中，我将向您展示如何将本地构建的Docker映像部署到minikube。</p>

<h2 id="building-the-docker-images">构建Docker图像</h2>

<p>章鱼水下样本应用程序提供了一个简单的Docker图像用于测试。运行以下命令来克隆git repo:</p>

<pre><code class="language-bash">git clone https://github.com/OctopusSamples/octopus-underwater-app.git
</code></pre>

<p>输入项目目录:</p>

<pre><code class="language-bash">cd octopus-underwater-app
</code></pre>

<p>然后使用以下命令构建映像:</p>

<pre><code class="language-bash">docker build . -t underwater
</code></pre>

<p>最后，使用以下命令运行Docker映像:</p>

<pre><code class="language-bash">docker run -p 5000:80 underwater
</code></pre>

<p>然后在<code>http://localhost:5000</code>可以获得示例web应用程序。</p>

<h2 id="pushing-images-to-minikube">将图像推送到minikube</h2>

<p>使用以下命令将本地映像推送到minikube是一个简单的过程:</p>

<pre><code class="language-bash">minikube image load underwater
</code></pre>

<h2 id="deploying-the-image">部署映像</h2>

<p>要部署映像，请将以下YAML保存到名为<code>underwater.yaml</code>的文件中:</p>

<pre><code class="language-yaml">apiVersion: apps/v1
kind: Deployment
metadata:
  name: underwater
  labels:
    app: web
spec:
  selector:
    matchLabels:
      app: web
  replicas: 1
  strategy:
    type: RollingUpdate
  template:
    metadata:
      labels:
        app: web
    spec:
      containers:
        - name: underwater
          image: underwater
          imagePullPolicy: Never
          ports:
            - containerPort: 80
</code></pre>

<p>然后使用以下命令部署应用程序:</p>

<pre><code class="language-bash">kubectl apply -f underwater.yaml
</code></pre>

<p>然后，应用程序被成功部署到minikube集群。</p>

<p>需要注意的是，Docker图像没有标签，这意味着它有默认标签<code>latest</code>。因此，上面YAML中的<code>image</code>属性可以替换为以下文本，因为这两个图像引用是等效的:</p>

<pre><code>image: underwater:latest
</code></pre>

<p>使用带有<code>latest</code>标签的图像有特殊含义，需要将<code>imagePullPolicy</code>设置为<code>Never</code>(或<code>IfNotPresent</code>)。要了解原因，您需要了解默认的图像拉取策略。</p>

<h2 id="using-latest-images">使用最新图像</h2>

<p>Kubernetes文档提供了关于<a href="https://kubernetes.io/docs/concepts/containers/images/#imagepullpolicy-defaulting" rel="nofollow">默认图像拉取策略</a>的建议:</p>

<blockquote class="blockquote">             <ul>
<li>如果省略imagePullPolicy字段，并且容器图像的标记为:latest，imagePullPolicy将自动设置为Always</li>
<li>如果省略imagePullPolicy字段，并且不指定容器图像的标记，imagePullPolicy将自动设置为Always。</li>
<li>如果省略imagePullPolicy字段，并且为容器图像指定的标记不是:latest，则imagePullPolicy会自动设置为IfNotPresent。</li>
</ul>
</blockquote>

<p>为了理解这一点的重要性，部署以下没有设置<code>imagePullPolicy</code>值的YAML:</p>

<pre><code class="language-yaml">apiVersion: apps/v1
kind: Deployment
metadata:
  name: underwater
  labels:
    app: web
spec:
  selector:
    matchLabels:
      app: web
  replicas: 1
  strategy:
    type: RollingUpdate
  template:
    metadata:
      labels:
        app: web
    spec:
      containers:
        - name: underwater
          image: underwater
          ports:
            - containerPort: 80
</code></pre>

<p>使用以下命令查看由此部署创建的单元的状态:</p>

<pre><code class="language-bash">kubectl get pods
</code></pre>

<p>您会看到状态为<code>ImagePullBackOff</code>:</p>

<pre><code class="language-bash">NAME                          READY   STATUS             RESTARTS   AGE
underwater-847d6f9646-pvzxb   0/1     ImagePullBackOff   0          15m
</code></pre>

<p>这是因为您部署了一个带有<code>latest</code>标签的图像，并且没有指定<code>imagePullPolicy</code>，这意味着使用了默认值<code>Always</code>。这反过来意味着minikube试图下载图片<code>docker.io/underwater:latest</code>，因为没有注册的图片默认为<code>docker.io</code>。图像<code>docker.io/underwater:latest</code>不存在，因此出现<code>ImagePullBackOff</code>错误。</p>

<p>有两种方法可以解决这个问题:</p>

<ul>
<li>将<code>imagePullPolicy</code>设置为<code>Never</code>或<code>IfNotPresent</code></li>
<li>为图像添加标签，例如<code>docker build . -t underwaterapp:0.0.1</code>和<code>minikube image load underwater:0.0.1</code></li>
</ul>

<h2 id="conclusion">结论</h2>

<p>在minikube中使用本地构建的Docker映像是一个简单的过程，但是您需要了解有关映像拉取策略的规则，以确保Kubernetes不会试图从默认的Docker注册表中下载不存在的映像。</p>

<p>愉快的部署！</p>

                    
                    
</body>
</html>