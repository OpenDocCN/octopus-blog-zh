<html>
<head>
<title>SNI in Tomcat - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>SNI在Tomcat -章鱼部署</h1>
<blockquote>原文：<a href="https://octopus.com/blog/sni-in-tomcat#2022-07-15">https://octopus.com/blog/sni-in-tomcat#2022-07-15</a></blockquote>
                        <p>服务器名称指示(SNI)已经在Tomcat 8.5和9中实现，这意味着证书可以映射到传入请求的主机名。这允许Tomcat在单个HTTPS端口上使用不同的证书进行响应。</p>

<p>这篇博客文章着眼于如何在Tomcat 9中配置SNI。</p>

<h2 id="creating-self-signed-certificates">创建自签名证书</h2>

<p>在本例中，我们将创建两个自签名证书。这是通过<code>openssl</code>命令完成的。</p>

<p>下面的输出显示了如何为“Internet Widgets”公司创建第一个自签名证书。</p>

<pre><code>$ openssl req -x509 -newkey rsa:4096 -keyout widgets.key -out widgets.crt -days 365
Generating a 4096 bit RSA private key
......++
........++
writing new private key to 'widgets.key'
Enter PEM pass phrase:
Verifying - Enter PEM pass phrase:
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) []:AU
State or Province Name (full name) []:QLD
Locality Name (eg, city) []:Brisbane
Organization Name (eg, company) []:Internet Widgets
Organizational Unit Name (eg, section) []:
Common Name (eg, fully qualified host name) []:
Email Address []:
Octopuss-MBP-2:Development matthewcasperson$ ls
widgets.crt     widgets.key
</code></pre>

<p>然后，我们为“Acme”公司创建第二个自签名证书。</p>

<pre><code>$ openssl req -x509 -newkey rsa:4096 -keyout acme.key -out acme.crt -days 365
Generating a 4096 bit RSA private key
..............................++
.....................................................................++
writing new private key to 'acme.key'
Enter PEM pass phrase:
Verifying - Enter PEM pass phrase:
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) []:Au
State or Province Name (full name) []:QLD
Locality Name (eg, city) []:Brisbane
Organization Name (eg, company) []:Acme
Organizational Unit Name (eg, section) []:
Common Name (eg, fully qualified host name) []:
Email Address []:
Octopuss-MBP-2:Development matthewcasperson$ ls
acme.crt        acme.key        widgets.crt     widgets.key
</code></pre>

<p>将文件<code>acme.crt</code>、<code>acme.key</code>、<code>widgets.crt</code>和<code>widgets.key</code>复制到Tomcat 9 <code>conf</code>目录中。</p>

<h2 id="configuring-the-connector">配置<code>&lt;Connector&gt;</code></h2>

<p>在<code>conf/server.xml</code>文件中，我们将添加一个新的<code>&lt;Connector&gt;</code>元素来引用这些证书。</p>

<pre><code class="language-xml">&lt;Connector SSLEnabled="true" defaultSSLHostConfigName="acme.com" port="62000" protocol="org.apache.coyote.http11.Http11AprProtocol"&gt;
  &lt;SSLHostConfig hostName="acme.com"&gt;
    &lt;Certificate certificateFile="${catalina.base}/conf/acme.crt" certificateKeyFile="${catalina.base}/conf/acme.key" certificateKeyPassword="Password01!" type="RSA"/&gt;
  &lt;/SSLHostConfig&gt;
  &lt;SSLHostConfig hostName="widgets.com"&gt;
    &lt;Certificate certificateFile="${catalina.base}/conf/widgets.crt" certificateKeyFile="${catalina.base}/conf/widgets.key" certificateKeyPassword="Password01!" type="RSA"/&gt;
  &lt;/SSLHostConfig&gt;
&lt;/Connector&gt;
</code></pre>

<p>这个配置块有几个重要的方面，所以我们将逐一介绍。</p>

<p><code>defaultSSLHostConfigName="acme.com"</code>属性已经将<code>&lt;SSLHostConfig hostName="acme.com"&gt;</code>定义为默认值。这意味着，当请求来自不是<code>acme.com</code>或<code>widgets.com</code>的主机时，将使用<code>acme.com</code>证书生成响应。您必须至少配置一台默认主机。</p>

<p><code>protocol="org.apache.coyote.http11.Http11AprProtocol"</code>属性将Tomcat配置为使用Apache Portable Runtime (APR ),这意味着在生成HTTPS响应时将使用openssl引擎。通常，使用openssl会比使用原生Java协议获得更好的性能。Tomcat文档有更多关于可用协议的细节。</p>

<p>然后，我们有了每个主机名的证书配置。这是<code>acme.com</code>主机名的配置。</p>

<pre><code class="language-xml">&lt;SSLHostConfig hostName="acme.com"&gt;
  &lt;Certificate certificateFile="${catalina.base}/conf/acme.crt" certificateKeyFile="${catalina.base}/conf/acme.key" certificateKeyPassword="Password01!" type="RSA"/&gt;
&lt;/SSLHostConfig&gt;
</code></pre>

<p><code>certificateFile="${catalina.base}/conf/acme.crt"</code>和<code>certificateKeyFile="${catalina.base}/conf/acme.key"</code>属性定义了证书和私钥相对于CATALINA_BASE目录的位置。<a href="https://tomcat.apache.org/tomcat-9.0-doc/RUNNING.txt" rel="nofollow"> Tomcat文档</a>有关于CATALINA_BASE引用的更多细节:</p>

<blockquote class="blockquote">
<p>CATALINA_HOME环境变量应该设置为Tomcat的“二进制”发行版的根目录位置。</p>
<p>CATALINA_BASE环境变量指定Tomcat的“活动配置”的根目录的位置。它是可选的。默认等于CATALINA_HOME。</p>
</blockquote>

<h2 id="testing-the-connection">测试连接</h2>

<p>由于我们实际上并不拥有<code>acme.com</code>或<code>widgets.com</code>域名，我们将编辑<code>hosts</code>文件以将这些地址解析为<code>localhost</code>。在Mac和Linux操作系统上，这个文件位于<code>/etc/hosts</code>下。</p>

<p>将下面几行添加到<code>hosts</code>文件中会将这些域指向localhost。我们还将抛出<code>somethingelse.com</code>主机名来查看一个未映射的主机返回哪个证书。</p>

<pre><code>127.0.0.1 acme.com
127.0.0.1 widgets.com
127.0.0.1 somethingelse.com
</code></pre>

<p>我们现在可以打开链接<a href="https://widgets.com:62000" rel="nofollow">https://widgets.com:62000</a>。在Firefox中，我们可以看到这个请求有以下证书细节。注意显示<code>Internet Widgets</code>的<code>Verified by</code>字段。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2017-11/widgets-com.png" class="zoom" data-title=""><img src="../Images/f0b6d9ec9b17903b6c0e7d86e27904a8.png" class="img-fluid center" alt="widgets.com certificate" data-original-src="https://i.octopus.com/blog/2017-11/widgets-com.png"/>T2】</a></p>

<p>然后打开<a href="https://acme.com:62000" rel="nofollow">https://acme.com:62000</a>。<code>Verified by</code>字段现在显示<code>Acme</code>。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2017-11/acme-com.png" class="zoom" data-title=""><img src="../Images/e28b0a1f4ebfb302268824d18f8cbca9.png" class="img-fluid center" alt="acme.com certificate" data-original-src="https://i.octopus.com/blog/2017-11/acme-com.png"/>T2】</a></p>

<p>现在打开https://somethingelse.com:62000。<code>Verified by</code>字段仍然显示<code>Acme</code>，因为该证书是默认的，用于任何没有定义特定映射的主机。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2017-11/somethingelse-com.png" class="zoom" data-title=""><img src="../Images/aa203d9b89df706696ae531276459fd6.png" class="img-fluid center" alt="somethingelse.com certificate" data-original-src="https://i.octopus.com/blog/2017-11/somethingelse-com.png"/>T2】</a></p>

<h2 id="conclusion">结论</h2>

<p>因此我们可以看到，单个端口上的单个Tomcat实例可以根据被请求的主机使用多个不同的证书进行响应。这就是SNI给web服务器带来的好处。</p>

<p>如果您对Java应用程序的自动化部署感兴趣，<a href="https://octopus.com/downloads">下载Octopus Deploy </a>的试用版，并查看我们的文档。</p>

                    
                    
</body>
</html>