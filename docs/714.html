<html>
<head>
<title>SQL Server and PowerShell: Practical Examples - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>SQL Server和PowerShell:实践示例- Octopus Deploy</h1>
<blockquote>原文：<a href="https://octopus.com/blog/sql-server-powershell#2021-08-12">https://octopus.com/blog/sql-server-powershell#2021-08-12</a></blockquote>
                        <p><a href="#" data-featherlight="https://i.octopus.com/blog/2019-11/sql-server-powershell/sql-server-powershell-examples.png" class="zoom" data-title=""><img src="../Images/afe4213c5dbdf48bc953f45ddfe4468e.png" class="img-fluid center" alt="SQL Server and PowerShell: Practical Examples" data-original-src="https://i.octopus.com/blog/2019-11/sql-server-powershell/sql-server-powershell-examples.png"/>T2】</a></p>

<p>Octopus Deploy的目标之一一直是帮助简化自动化应用程序部署，而应用程序部署通常需要在此过程中进行数据库管理。在这篇文章中，我的目标是提供一些使用PowerShell进行SQL Server数据库管理的常见示例，以便更直接地集成到部署中。</p>

<p>所有这些例子的源代码都可以在<a href="https://github.com/OctopusSamples/sql-server-powershell-examples" rel="nofollow"> GitHub </a>上找到。如果你遇到任何问题或者有修改的建议，请随意张贴到GitHub库的问题列表或者发送一个请求！</p>



<h2 id="installing-the-sql-server-powershell-module">安装SQL Server PowerShell模块</h2>

<p>微软建议使用<strong> SqlServer </strong>模块从PowerShell与SqlServer进行交互。下面的例子中并没有用到它，但是它包含了许多对SQL Server管理有用的cmdlets。</p>

<p>可以使用以下命令从PowerShell Gallery安装<strong> SqlServer </strong>模块:</p>

<pre><code class="language-ps">Install-Module -Name SqlServer
</code></pre>

<p>此外，如果已经安装了此模块，并且您使用的是PowerShell 5.0或更高版本，则可以使用以下命令对其进行更新:</p>

<pre><code class="language-ps">Update-Module -Name SqlServer
</code></pre>

<p>如果您使用的是早于5.0的PowerShell版本，请使用以下命令:</p>

<pre><code class="language-ps">Uninstall-Module -Name SqlServer
Install-Module -Name SqlServer
</code></pre>

<p>关于安装<strong> SqlServer </strong>模块的更多信息，请参见本微软文档:<a href="https://docs.microsoft.com/en-us/sql/powershell/download-sql-server-ps-module" rel="nofollow">安装SQL Server PowerShell模块</a>。</p>

<h2 id="test-connectivity-to-sql-server">测试与SQL Server的连接</h2>

<p>测试SQL Server数据库连接的最简单方法之一是使用连接字符串和基本的<strong> SqlClient </strong>类:</p>

<pre><code class="language-ps">try
{
    # This is a simple user/pass connection string.
    # Feel free to substitute "Integrated Security=True" for system logins.
    $connString = "Data Source=YourInstance;Database=YourDB;User ID=YourUser;Password=YourPassword"

    #Create a SQL connection object
    $conn = New-Object System.Data.SqlClient.SqlConnection $connString

    #Attempt to open the connection
    $conn.Open()
    if($conn.State -eq "Open")
    {
        # We have a successful connection here
        # Notify of successful connection
        Write-Host "Test connection successful"
        $conn.Close()
    }
    # We could not connect here
    # Notify connection was not in the "open" state
}
catch
{
    # We could not connect here
    # Notify there was an error connecting to the database
}
</code></pre>

<p>在部署开始时对连接进行测试，您就知道可以对SQL Server进行所需的调用了。</p>

<h2 id="create-sql-server-login">创建SQL Server登录名</h2>

<p>为了在服务器或实例中正确分离权限，您可能需要为应用程序或相关服务创建新的登录。来自SQL Server模块的cmdlet将完成此任务:</p>

<pre><code class="language-ps"># To run in a non-interactive mode, such as through an Octopus deployment, you will most likely need to pass the new login credentials as a PSCredential object.
$pass = ConvertTo-SecureString "Th!sI5Y0urP4ss" -AsPlainText -Force

# Create the PSCredential object
$loginCred = New-Object System.Management.Automation.PSCredential("NewUser",$pass)

# Create login using the Add-SqlLogin cmdlet
Add-SqlLogin -ServerInstance YourInstance -LoginPSCredential $loginCred -LoginType SqlLogin
</code></pre>

<p>此cmdlet极大地简化了SQL Server登录的创建，并灵活地使用内置标志，如<code>-MustChangePasswordAtNextLogin</code>或<code>-ConnectionTimeout.</code>如果您在Octopus部署过程中使用此命令，您可能会发现包含以下标志很有用:</p>

<ul>
<li><code>-Enable</code>确保稍后在您的部署中登录可用。</li>
<li><code>-GrantConnectSql</code>允许登录连接到数据库引擎。</li>
</ul>

<p>更多信息，参见<a href="https://docs.microsoft.com/en-us/powershell/module/sqlserver/Add-SqlLogin" rel="nofollow"> Add-SqlLogin参考</a>。</p>

<h2 id="create-sql-server-database-and-assign-an-owner">创建SQL Server数据库并分配所有者</h2>

<p>令人惊讶的是，Microsoft并没有提供现成的cmdlet来创建数据库，因此有两条主要途径可以在没有预先备份的情况下启动并运行数据库。两者都相当简单。使用以下命令之一可以创建新的空白数据库:</p>

<p>对您的实例直接运行SQL来创建数据库:</p>

<pre><code class="language-ps"># This query could also come from a file
Invoke-Sqlcmd -Query "CREATE DATABASE YourDB" -ServerInstance YourInstance
</code></pre>

<p>或者，使用SQL Server管理对象(SMO)对象来完成繁重的工作:</p>

<pre><code class="language-ps">#Name your database
$dbname = "YourDB"
# Create a SQL Server database object
$srv = New-Object Microsoft.SqlServer.Management.Smo.Server("YourInstance")
if($null -ne $srv.Databases[$dbname])
{
    $db = New-Object Microsoft.SqlServer.Management.Smo.Database($srv, $dbname)

    # Create the database
    $db.Create()
}
</code></pre>

<p>如果您<em>有想要恢复的数据库备份，而不是创建空白数据库，那么<strong>Restore-SQL database</strong>cmdlet是您的好朋友:</em></p>

<pre><code class="language-ps">$backupFile = "\\SQLBackups\YourDBBackup.bak"
Restore-SqlDatabase -ServerInstance YourInstance -Database YourDB -BackupFile $backupFile
</code></pre>

<p>关于<strong>Restore-SQL database</strong>cmdlet的更多信息可以在这个微软文档中找到:<a href="https://docs.microsoft.com/en-us/powershell/module/sqlserver/restore-sqldatabase?view=sqlserver-ps" rel="nofollow"> Restore-SqlDatabase </a>。</p>

<p>现在您的数据库已经就绪，让我们将数据库所有者改为<code>NewOwner</code>:</p>

<pre><code class="language-ps"># Here we'll need a user with administrative privileges to set the owner.
# Let's say that $SqlAdmin contains the username and $SqlAdminPass contains the password as a secure string.
$dbname = "YourDB"

# Create the server connection object
$conn = New-Object Microsoft.SqlServer.Management.Common.ServerConnection("YourInstance", $SqlAdmin, $SqlAdminPass)

# Create the server object
$srv = New-Object Microsoft.SqlServer.Management.Smo.Server($conn)

# Check to see if a database with that name already exists
if($null -ne $srv.Databases[$dbname])
{
    # If it does not exist, create it
    $db = New-Object Microsoft.SqlServer.Management.Smo.Database($srv, $dbname)
    $db.SetOwner("NewOwner")
}
else
{
    # There was an error creating the database object
}
</code></pre>

<h2 id="run-a-sql-script-from-a-file">从文件运行SQL脚本</h2>

<p>新数据库就绪后，可能需要对设置进行更改，或者某些表缺少默认数据。PowerShell可以直接从文件运行SQL脚本来解决这些问题。让我们假设<code>alter_script.sql</code>在一个已知的位置(可能在您的Octopus部署中的一个包内)。可以使用以下命令直接从PowerShell运行该脚本:</p>

<pre><code class="language-ps"># Assumes you are working from the package directory
Invoke-Sqlcmd -InputFile .\alter_script.sql -ServerInstance YourInstance -Database YourDB
</code></pre>

<p>其他的<code>Invoke-Sqlcmd</code>信息可以在这个微软文档中找到:<a href="https://docs.microsoft.com/en-us/powershell/module/sqlserver/invoke-sqlcmd" rel="nofollow"> Invoke-Sqlcmd cmdlet </a>。</p>

<h2 id="run-inline-sql-commands">运行内联SQL命令</h2>

<p>最后，您可能需要运行一些SQL查询来验证数据库包含正确的数据(检查一切正常)。PowerShell能够直接从控制台窗口运行内联SQL查询。让我们运行一个快速查询来检查表中的行数:</p>

<pre><code class="language-ps">$rowcount = "SELECT COUNT(*) FROM YourTable"
Invoke-Sqlcmd -ServerInstance YourInstance -Database YourDatabase -Query $rowcount
</code></pre>

<h2 id="conclusion">结论</h2>

<p>无论您是在每次从Octopus部署一个版本时自动配置新数据库，还是对现有数据库运行一次性命令，PowerShell和SQL Server模块都是完成这项工作的合适工具。</p>

<p>你还有其他的场景或具体问题吗？在这里留下评论或者加入我们的<a href="https://octopus.com/slack">社区松弛期</a>。</p>

<h2 id="references">参考</h2>



                    
                    
</body>
</html>