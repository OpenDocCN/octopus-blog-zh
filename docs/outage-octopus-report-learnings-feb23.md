# octopus.com 停电-报告和学习-八达通部署

> 原文：<https://octopus.com/blog/outage-octopus-report-learnings-feb23>

从世界协调时 2023 年 1 月 25 日星期三下午 3:37 到世界协调时 2023 年 1 月 26 日星期四下午 3:44，部分地区的客户无法访问 octopus.com/signin,博客、文档和其他网址，因为他们返回了 HTTP 404(未找到页面)响应。这主要影响了美国和欧盟，对亚洲地区也有一些间歇性的影响。

在本帖中，我们详细描述了事情的经过、我们的反应和我们的收获。

## 事件是如何开始的

1 月 25 日，作为 DNS 和路由提供商迁移计划的一部分，我们对`octopus.com`和`octopusdeploy.com`域名进行了定期维护。在这一步迁移中，一个 Azure 前门(AFD)配置文件中的路由设置被转移到另一个 AFD 配置文件。新的 AFD 配置文件未按预期运行。

我们发现新的 AFD 配置文件错误地路由了某些地区的请求子集，导致 HTTP 404 响应。我们在状态页面上公布了计划维护的服务中断。

我们将此视为意外事件，因为维护没有按计划进行，并且存在复杂因素:

*   Azure 的网络中断
*   AFD 中的内部路由问题
*   新晶片在我们的应用中产生了显著的噪声
*   这个问题发生在澳大利亚的公共假期，我们的许多工程师都在那里工作

对 AFD 配置文件的更改无法安全回滚。

## 按键计时

| 事件 | 期间 |
| --- | --- |
| 检测时间 | 10 小时 21 分钟 |
| 事件申报时间 | 13 小时 27 分 |
| 解决问题的时间 | 37 小时 44 分钟 |

## 事故时间表

*(以下所有日期和时间均以 UTC 表示)*

### 2023 年 1 月 25 日星期三

***02:00*** 一名 Octopus 工程师部署了对`octopus.com`和`octopusdeploy.com`域的更改，在 Azure 前门配置文件之间移动相关路由，作为迁移项目的一部分。

***02:39*** 工程师将 AFD WAF 从预防模式切换到检测模式，因为它阻塞了有效流量。

***07:05***Azure 的网络中断掩盖了这个问题——参见我们的[章鱼云连接中断报告](https://octopus.com/blog/cloud-connectivity-disruption-report-learnings)。

***12:21*** 欧盟地区的一名应用支持工程师报告称在`octopus.com`域上遇到间歇性 404。

***12:43*** Azure 的网络中断问题得到全面解决。

***14:06*** 报告第一个面向客户的问题。

***14:06 - 15:27*** 应用支持工程师调查了该问题，并确定该问题是间歇性的，影响了欧盟和美国地区的客户。

***15:27*** 状态页面更新:宣布发生事件。

***15:27 - 17:06*** 调查显示，受影响航线的 web app 和数据库均无明显负载。新的 AFD 档案报告了对 CNAME 记录的警告。

***17:06*** 随叫随到工程师确定问题出在 AFD，因为端点动态解析为 2 个 IP 地址，其中一个 IP 地址始终返回 404。

***17:22*** 状态页面更新:我们正在继续调查此问题。

***17:35*** 天蓝色支持票以“严重性:B”提出。

***18:32*** 状态页面更新:已确定受影响地区。

***20:32*** 事件被上报给负责 AFD 迁移项目的工程师。

***20:32 - 21:42*** 我们调查了 AFD 中 2 个域关于 CNAME 记录的警告。

***21:36*** 状态页面更新:内部升级。

***21:42*** 我们与 Azure 支持代表通了电话，他们建议有关 CNAME 记录的警告可能是根本问题。

***21:42 - 22:26*** 基于 CNAME 变平是根本原因的假设，试图采取缓解措施。

***22:26*** 根据从受影响端点解析的 2 个 IP 地址之一的成功请求，CNAME 扁平化被排除为原因。它还成功地对以前的 AFD 概况进行了大约一年的工作。我们的工程师重点关注 AFD 剖面中的故障线路。

***22:37*** 有 Azure 的支持票升级为“严重性:A”。

***22:37 - 02:01*** 我们的工程师与 Azure 支持代表密切合作，为 Azure 提供足够的信息来识别和重现问题。

***22:59*** 状态页面更新:云提供商升级。

### 2023 年 1 月 26 日星期四

***02:01*** 发现了一个新的潜在根本原因，导致向原始 DNS 提供商提出支持请求。

一名 Azure 应用程序支持工程师注意到 AFD 配置文件中有大量的 404 请求，这是由于将 WAF 的模式设置为`detection`而不是`prevention`。

***03:12*** 由于时间太长，没有明确的解决途径，事件在内部升级，以召集高级工程管理人员。

***04:15*** 发现路线问题:重新关注 AFD 配置文件。

***04:19*** 状态页面更新:事件状态更改为已识别。

***05:42*** 以前的云提供商建议他们的主机解析到正确的 IP 地址，并建议请求公共解析器刷新他们的 DNS 缓存。

***05:43*** 建议在 AFD 中使用`www`子域控制请求解析的潜在缓解措施。

***07:06*** Azure 建议 AFD 不能支持 CNAME 扁平化。

***07:13*** 内部上报，涉及信托&安全和安保部门。

***07:31*** Azure 确认他们看到的唯一解决途径是将所有 DNS 记录移动到 Azure DNS。Azure 确认他们会将正确的配置同步到所有边缘节点。

***08:49*** 我们为`www.octopus.com`创建了一个新的 AFD 端点，并通过现有的 DNS 提供商添加了一个来自 CNAME 的重定向。

***08:53*** 更新应用服务接受新的原点头。

***09:26*** 禁用从`www.octopus.com`到`octopus.com`的 app 级重定向。

***10:05*** 更新了受影响的 SSO 服务的配置。

***10:07*** 将根 octopus.com 改为 CNAME，并创建了一个从`octopus.com`到`www.octopus.com`的 302 重定向。

***10:18*** 测试显示先前中断的路线再次工作。

***11:07*** 状态页面更新:事件状态更改为`Monitoring`，并发布了如何解决的建议。

***11:10*** 内部报告显示，受影响的欧盟地区从“大部分不工作”转变为“大部分工作”。

***11:49*** 内部报告显示`octopus.com`还是 404ing。

***12:19*** 确认 AFD 内部的路由问题仍在发生，尽管本应应用一个包罗万象的规则。

***12:36*** 试图通过创建一组明确的规则来强制 AFD 路由某些 URL。

***12:38*** 状态页面更新:事件状态改回`identified`。

***13:23*** Azure 证实他们重现了该问题，并与一个产品小组合作进行修复。

***14:30*** 可用性测试开始报告成功。

***14:53*** Azure 证实一小时前应用了一个修复程序。

***15:07*** 状态页面更新:事件状态改回监控。

***15:44*** 状态页面更新:事件已解决。

## 技术细节

出现 404 是因为客户的请求被发送到了错误的 web 应用程序。这 404 个反应具有地区特异性和间歇性。找出错误路由的确切原因非常复杂。我们需要深入研究 Azure 前门(AFD)中 DNS 提供商和端点路由之间的关系。

### 我们观察到的

`octopus.com`域的特定 AFD 端点`octo-public-prod-endpoint-f2e5gmecbdf3bfg9.z01.azurefd.net`被动态解析为 2 个 IP 地址之一。两个 IP 地址中的一个在所有相关路由`/signin`、`/docs`和`/blog`上返回 404，而另一个 IP 地址工作正常。

这表明 CNAME 警告不太可能是原因，因为一些流量被成功路由。

我们发现 AFD 路由解析的 2 个 IP 地址不同于预期接收此流量的 web 应用程序的 A-B 对的 IP 地址。

### 发生了什么

当路由改变发生时，AFD 不更新它的所有节点，所以一些 AFD 节点仍然将流量定向到不正确的 web 应用。受影响的端点在迁移前解析到不正确的应用程序。没有对 CNAME 记录的控制，AFD 就不能权威地更新扁平化的 A 记录。

我们在 AFD 上建立了一个 CNAME 记录，让他们对该子域上的所有请求进行权威控制。受影响端点上不正确的 IP 地址解析行为仍在继续。

在 Azure 通知我们他们已经进行了内部更改后，AFD 内部的错误路由停止了。

有两个不相关的因素:

*   来自晶圆的 404 个错误
*   顶点域上的 CNAME 平坦化

在实践中，删除代理和切换到 AFD 的 WAF 与这个问题无关。然而，他们制造了巨大的噪音，掩盖了真正的问题。

类似地，在顶点域上使用 CNAME 展平使得原因不清楚。CNAME 扁平化是指 DNS 提供商为底层 IP 地址的动态解析创建一系列 A 记录，而不是单个 CNAME 记录。你可以在 Cloudflare 的这个[讲解器里了解更多。](https://blog.cloudflare.com/introducing-cname-flattening-rfc-compliant-cnames-at-a-domains-root/)

基于我们对问题的最佳理解，我们在受影响的域上创建了一个`www`子域。我们在这个子域上创建了一个 CNAME 记录，让 AFD 对解决该域的所有请求进行权威控制。然后，我们将流量从受影响的域重定向到适当的`www`子域。

这种缓解最初有所帮助，但 AFD 端点中不正确的 IP 地址解析再次出现。在 Azure 通知他们对我们的 AFD 档案进行了更改后，IP 问题得到了解决。

我们知道 Azure 将受影响的 AFD 档案“从传统平台转移到最新平台”，但在撰写本文时，我们尚未得到官方确认。

在我们了解问题之后，我们考虑回滚 AFD 配置文件的更改。我们决定不这样做，因为我们知道只有 AFD 节点的子集会更新，使一些区域处于中断状态。

## 后续步骤

为了帮助我们更深入地了解这一事件，我们就此问题与我们的 Azure 客户经理进行了接洽。

解决后，我们立即解决了`www`子域缓解的影响，特别是在 CORS、静态资产和 SEO 方面。

在我们回到稳定状态后，我们继续迁移项目。我们对项目进行了调整，使其与 Azure 紧密合作，以确保我们的更改按预期进行。在我们进行迁移的过程中，我们继续有计划的停机时间。基于我们的经验，我们可以设计回滚安全的迁移步骤。这有助于我们在出现意外行为时立即回滚，从而将计划停机的影响降至最低。

我们进行了一次事故回顾，并确定了需要改进的地方:

*   开发过程:我们正在审查开发过程中的质量控制，以确定在将更改应用到生产环境之前，我们可以在哪里发现问题。

*   长期运行事件的事件响应流程:我们以前从未经历过如此长时间的事件。我们开始找不到合适的待命工程师来管理事故。我们正在调查其他内部和外部团队如何管理这些情况，并相应地更新我们的待命名单和指南。

## 结论

Octopus Deploy 非常重视服务可用性。解决这一事件的时间比我们预期的要长。我们对此次停电给我们的客户带来的不便深表歉意。