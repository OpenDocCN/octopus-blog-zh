# 八达通部署 2.0 中的加密-八达通部署

> 原文：<https://octopus.com/blog/encryption-in-2.0>

我们在 UserVoice 上有一些相关的建议，我想在 Octopus 2.0 中提出来:

我想用这篇博文来分享我们将如何解决这些需求。Octopus 2.0 将支持许多与加密相关的不同场景。

1.  **加密数据库**
    Octopus 中的 RavenDB 数据库需要加密，以允许客户“勾选”Octopus，用于需要在磁盘上加密任何配置信息的环境。例如，PCI-DSS 环境中的客户。
2.  **安全/敏感变量**
    在 Octopus UI 中创建的一些变量可能也需要加密。例如，客户可能会创建一个变量来表示连接到数据库时使用的管理员密码。这超越了磁盘加密——这些值不应该由 REST API 返回，也不应该出现在活动日志中。它们应该是“只写”的。
3.  **敏感内部 Octopus 设置的存储**
    例如，用于触手 X.509 证书的私钥目前存储在注册表中，使用 Base64 编码。这些值也应该加密。

为了实现这一点，我们将依靠两级加密。AES128 将使用“主密钥”来对称加密值。主密钥本身将使用 [DPAPI](http://msdn.microsoft.com/en-us/library/ms995355.aspx) 进行非对称加密。

## 万能钥匙

当 Octopus 第一次启动时，它会生成一个随机字符串，用作**主密钥**。这个主密钥将使用 DPAPI 加密，并存储在 Octopus 配置文件中。

每当你开启八达通管理工具时，八达通会提示你备份你的主密码。直到你点击类似于“我已经备份了我的主密钥”的东西，每次你打开管理工具时，你将继续得到提示。要备份您的密钥，我们只需将主密钥公开为未加密密钥的 Base64 编码表示。你可以把它打印出来或者粘贴到记事本中，然后保存在你喜欢的任何地方。

![Backing up your master key](img/f652833d50009605ed8eeded78ad62cd.png)

## 加密数据库

RavenDB 附带了一个[包，可以对数据库](http://ravendb.net/docs/2.0/server/extending/bundles/encryption)进行加密。当我们在嵌入式模式下运行 Raven 时，我们将自动启用这个包，并使用我们的**主密钥**作为 Raven 加密包的密钥。这确保了所有文档和索引都被加密。由于在创建 Octopus 数据库时需要启用这个包(以后不能启用)，所以这不会是一个选择加入/选择退出特性。它将被开箱。

在客户使用外部 RavenDB 数据库的场景中，将由他们来启用这个包并管理他们自己的密钥。

但是，以下内容将不会包含在 Raven 的加密包中:

*   渡鸦附件
*   日志文件

对于附件，我们将使用 AES128 和我们的主密钥自己加密和解密。然而，我们不会加密日志文件。以纯文本格式存储日志对于调试有很大的价值，而且因为我们会防止敏感变量出现在日志中(见下文)，所以没有理由加密它们。

## 安全/敏感变量

当你创建一个变量时，你可以勾选一个使它“安全”的框。安全变量一旦被写入就不能被读取；它在 UI 中总是显示为'*** *【T6]'，并且该值不能从 REST API 中获得。然而，当发送到触手时，它将作为一个变量可用。**

这些安全变量的值将使用主密钥和 AES128 加密存储。没有被标记为安全的变量只是将它们的值存储为纯文本。

在处理任何活动日志时，我们将从 [TeamCity 处理密码参数](http://confluence.jetbrains.com/display/TCD7/Typed+Parameters)的方式中获得灵感:任何安全变量的值都将被自动屏蔽。例如，如果用户不小心编写了这样的 Deploy.ps1 脚本:

```
Write-Host "Password is $MyPassword" 
```

Octopus 会看到安全值出现在日志中，并在日志条目通过网络发送或保存之前，自动将其替换为“ ******* ”。在用户界面中，您将看到:

```
Password is *************** 
```

这将通过使用`string.Replace()`来完成。当然，这确实意味着用户可以编写一个脚本来生成一个随机值，然后查找' ******* '来找出哪个是密码，如果密码只是简单的“hello”，则掩码可能会出现在错误的位置，从而暴露自己，但总的来说，该功能是一个额外的保护层，而不是 100%的防呆措施。

## 备份和恢复

目前，备份是通过 RavenDB 的 Smuggler API 使用文档的“导入”和“导出”来执行的。它生成的文件只是一个 GZIP 压缩的 JSON 文档列表。

我们的备份文件也需要加密，所以我们将从 smuggler 那里获取备份文件，添加活动日志和任何其他需要备份的文件，并将它们全部压缩到一个`System.IO.Packaging`包中。然后我们将使用主密钥对其进行加密。

当您从备份中恢复时，您需要输入主密钥，该密钥应该在设置 Octopus 时已经备份/打印/保存。然后，我们将在您的配置文件中设置主密钥，并执行恢复。

## 摘要

我们对这些问题的解决方案将涉及几个方面。我们将通过 Raven 包自动加密 Raven 中的所有文档。我们还将允许变量被标记为“安全的”，这将影响它们在 UI 中的显示方式。

我们所有的加密都将依赖于 AES128，使用随机生成的主密钥，主密钥本身将使用 DPAPI 存储，因此如果攻击者设法查看您的配置文件，他们仍然无法读取密钥，除非他们在您的 Octopus 服务器上运行代码。这一变化的唯一缺点是需要备份您的主密钥，我们将尽最大努力创造良好的用户体验。

这项功能目前正处于规划阶段，所以如果你的环境中这些功能很重要，我很乐意在下面的评论中得到你的反馈。