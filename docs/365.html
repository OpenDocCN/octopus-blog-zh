<html>
<head>
<title>How to install Jenkins on Docker - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>如何在Docker - Octopus部署上安装Jenkins</h1>
<blockquote>原文：<a href="https://octopus.com/blog/jenkins-docker-install-guide#2022-05-19">https://octopus.com/blog/jenkins-docker-install-guide#2022-05-19</a></blockquote>
                        <p>Docker在通用应用程序包的竞争中胜出。每个主要的操作系统都支持Docker映像，所有的云提供商都支持部署Docker映像，每个主要的工具或平台都提供官方的Docker映像。詹金斯也不例外，提供图片<a href="https://hub.docker.com/r/jenkins/jenkins" rel="nofollow">詹金斯/詹金斯</a>。</p>

<p>在这篇文章中，你将学习如何从Docker镜像运行Jenkins，配置它，定制它，并使用镜像来代替传统的基于包的安装。</p>

<h2 id="prerequisites">先决条件</h2>

<p>要运行Docker映像，您必须安装Docker。<a href="https://docs.docker.com/get-docker/" rel="nofollow"> Docker提供了在Linux、macOS和Windows上安装的详细说明</a>。</p>

<p>请注意，虽然最近版本的Windows获得了对运行Docker映像的本机支持，但Jenkins只提供基于Linux的Docker映像。Windows和macOS可以通过虚拟化运行Linux Docker映像，因此这里显示的大多数命令同样适用于所有操作系统，但本文将重点关注Linux。</p>

<h2 id="getting-started-with-the-jenkins-docker-image">Jenkins Docker图像入门</h2>

<p>安装Docker后，可以使用以下命令运行Jenkins:</p>

<pre><code class="language-bash">docker run -p 8080:8080 -p 50000:50000 -v jenkins_home:/var/jenkins_home jenkins/jenkins:lts-jdk11
</code></pre>

<p>让我们分解这个命令，以了解它在做什么。</p>

<p><code>docker run</code>用于运行一个Docker镜像作为容器。</p>

<p>您可以将Docker映像视为一个只读工件，其中包含运行特定应用程序所需的文件。与大多数应用程序工件不同，Docker映像包含一个完整的操作系统和支持正在运行的核心应用程序所需的所有相关系统工具。在Jenkins的例子中，这意味着Docker映像包含支持最小Linux操作系统所需的文件，以及运行Jenkins所需的Java版本。</p>

<p>容器是操作系统中的一个隔离环境，Docker映像在其中执行。尽管Docker通常不提供虚拟机所提供的那种隔离保证，但容器确实提供了一种轻松并行运行可信代码的方式。</p>

<p><code>-p</code>参数将本地端口映射到Docker容器公开的端口。第一个参数是本地端口，后跟一个冒号，然后是容器端口。</p>

<p>于是参数<code>-p 8080:8080</code>将本地端口8080映射到容器端口8080(也就是<a href="https://www.jenkins.io/doc/book/security/services/#web-ui" rel="nofollow"> web端口</a>),<code>-p 50000:50000</code>将本地端口50000映射到容器端口50000(也就是<a href="https://www.jenkins.io/doc/book/security/services/#tcp-agent-listener-port" rel="nofollow">代理端口</a>)。这意味着您可以在本地机器上打开http://localhost:8080，Docker将流量定向到容器托管的web服务器。</p>

<p>参数<code>-v jenkins_home:/var/jenkins_home</code>创建一个名为<code>jenkins_home</code>的卷，如果它还不存在的话，并把它挂载到容器内的路径<code>/var/jenkins_home</code>下。</p>

<p>虽然Docker映像是只读的，但Docker容器公开了一个读/写文件系统，允许任何正在运行的应用程序保存更改。但是，这些更改对于容器来说是本地的，如果容器被破坏，这些更改就会丢失。或者，如果您想要使用不同的容器，例如，如果您想要升级到较新版本的Jenkins，对旧容器的更改也会丢失。</p>

<p>Docker卷允许容器在容器生命周期之外保存数据，并与不同的容器共享数据。您可以将卷视为登录企业网络时通常会在会话中看到的网络驱动器。通过将可变数据保存到卷中，您可以销毁并重新创建Jenkins容器，或者基于较新的Docker映像创建新的容器，同时保留您对Jenkins配置所做的任何更改。</p>

<p>最后一个参数<code>jenkins/jenkins:lts-jdk11</code>是Docker图像的名称。这个特殊的图片可以在Dockerhub 上找到，Dockerhub是众多Docker注册中心中的一个，可以用来存放Docker图片。</p>



<p>注意，与Docker标签相关联的图像可以随着时间而改变。许多注册中心使用“浮动”标签来表示图像的最新版本。在Jenkins图像的情况下，带有标签<code>lts-jdk11</code>的图像随着每次LTS发布而更新。</p>

<p>为了确保您的本地机器有最新的映像，您必须手动运行<code>docker pull jenkins/jenkins:lts-jdk11</code>。但是请注意，任何现有的容器都将继续使用旧的映像，您必须创建一个新的容器来引用任何更新的映像。</p>

<p>更具体的标签，像<code>2.303.2-lts-jdk11</code>，一般不会被覆盖，所以没有理由在这些图像上运行<code>docker pull</code>。</p>

<p>要查看此命令创建的容器，请运行:</p>

<pre><code class="language-bash">docker container ls
</code></pre>

<p>您将看到容器的基本细节，以及一个(通常很幽默的)名称，如<code>nostalgic_tharp</code>:</p>

<pre><code>CONTAINER ID   IMAGE                       COMMAND                  CREATED              STATUS              PORTS                                                                                      NAMES
801f4e834173   jenkins/jenkins:lts-jdk11   "/sbin/tini -- /usr/…"   About a minute ago   Up About a minute   0.0.0.0:8080-&gt;8080/tcp, :::8080-&gt;8080/tcp, 0.0.0.0:50000-&gt;50000/tcp, :::50000-&gt;50000/tcp   nostalgic_tharp
</code></pre>

<p>要定义容器名，请传递参数<code>--name</code>:</p>

<pre><code class="language-bash">docker run -d --name jenkins -p 8080:8080 -p 50000:50000 jenkins/jenkins:lts-jdk11
</code></pre>

<p>第一次引导Jenkins时，Docker日志将包含如下消息:</p>

<pre><code class="language-bash">Jenkins initial setup is required. An admin user has been created and a password generated.
Please use the following password to proceed to installation:

1883c809f01b4ed585fb5c3e0156543a

This may also be found at: /var/jenkins_home/secrets/initialAdminPassword
</code></pre>

<p>这个由数字和字母组成的随机字符串是初始管理员密码，是完成Jenkins配置所必需的。</p>

<p>当您在日志中看到以下消息时，打开<a href="http://localhost:8080" rel="nofollow"> http://localhost:8080 </a>:</p>

<pre><code class="language-bash">Jenkins is fully up and running
</code></pre>

<p>现在您有机会完成Jenkins实例的初始配置。请看一下<a href="https://octopus.com/blog/jenkins-install-guide-windows-linux">之前关于传统Jenkins安装的帖子</a>，了解完成初始配置的更多细节。</p>

<p>您可能已经注意到，使用上面的命令运行Docker会将您的终端附加到容器输出流。要<a href="https://docs.docker.com/language/nodejs/run-containers/#run-in-detached-mode" rel="nofollow">在后台运行Docker图像</a>，使用<code>-d</code>或<code>--detach</code>参数:</p>

<pre><code class="language-bash">docker run -d -p 8080:8080 -p 50000:50000 -v jenkins_home:/var/jenkins_home jenkins/jenkins:lts-jdk11
</code></pre>

<h2 id="adding-additional-software-to-the-jenkins-server">向Jenkins服务器添加附加软件</h2>

<p>因为Jenkins是用Java编写的，所以通过运行Jenkins Docker映像创建的默认服务器拥有编译和测试Java应用程序所需的大部分软件。</p>

<p>要构建用其他语言编写的应用程序，您需要将外部Jenkins代理与所需的软件连接起来，并在这些软件上运行作业。使用代理是一种可伸缩的解决方案，如果您在生产环境中使用Jenkins，那么您应该考虑这种解决方案。</p>

<p>对于本地测试，一个更方便的解决方案是构建一个定制的Docker映像，其中内置了所需的工具。为此，您需要创建一个名为<code>Dockerfile</code>的文件，内容如下:</p>

<pre><code class="language-dockerfile">FROM jenkins/jenkins:lts-jdk11
USER root
RUN apt update &amp;&amp; \
    apt install -y --no-install-recommends gnupg curl ca-certificates apt-transport-https &amp;&amp; \
    curl -sSfL https://apt.octopus.com/public.key | apt-key add - &amp;&amp; \
    sh -c "echo deb https://apt.octopus.com/ stable main &gt; /etc/apt/sources.list.d/octopus.com.list" &amp;&amp; \
    apt update &amp;&amp; apt install -y octopuscli
USER jenkins
</code></pre>

<p><code>Dockerfile</code>文件用于构建新的Docker映像。你可以从<a href="https://docs.docker.com/engine/reference/builder/" rel="nofollow"> Docker文档</a>中找到<code>Dockerfile</code>中可用命令的完整参考。上面的示例使用了一小部分命令，但展示了一个基于Jenkins提供的图像的典型自定义图像。</p>

<p>该文件以<code>FROM</code>命令开始，该命令指示Docker从提供的图像构建新图像。这意味着您的新映像已经安装并配置了Jenkins和任何支持工具:</p>

<pre><code class="language-dockerfile">FROM jenkins/jenkins:lts-jdk11
</code></pre>

<p>为了安装新软件，您必须切换到<code>root</code>用户。就像普通的Linux操作系统一样，只有特权用户才能从软件包管理器安装新软件:</p>

<pre><code class="language-dockerfile">USER root
</code></pre>

<p>下一个命令执行软件安装。本示例使用来自<a href="https://octopus.com/downloads/octopuscli#linux"> Octopus网站</a>的说明安装Octopus CLI:</p>

<pre><code class="language-dockerfile">RUN apt update &amp;&amp; \
    apt install -y --no-install-recommends gnupg curl ca-certificates apt-transport-https &amp;&amp; \
    curl -sSfL https://apt.octopus.com/public.key | apt-key add - &amp;&amp; \
    sh -c "echo deb https://apt.octopus.com/ stable main &gt; /etc/apt/sources.list.d/octopus.com.list" &amp;&amp; \
    apt update &amp;&amp; apt install -y octopuscli
</code></pre>

<p>让一个普通用户帐户运行Docker容器中的应用程序被认为是最佳实践。<code>jenkins</code>用户是在基本映像中创建的，因此您可以使用最后一个命令切换回该用户:</p>

<pre><code class="language-dockerfile">USER jenkins
</code></pre>

<p>要使用<code>Dockerfile</code>构建新的Docker映像，请运行:</p>

<pre><code class="language-bash">docker build . -t myjenkins
</code></pre>

<p>该命令构建一个名为<code>myjenkins</code>的新映像。要运行新映像，首先使用<code>jenkins_home</code>卷停止任何现有容器:</p>

<pre><code class="language-bash">docker container stop nostalgic_tharp
</code></pre>

<p>然后运行您的新映像，挂载现有的<code>jenkins_home</code>卷，以保留您现有的所有Jenkins配置:</p>

<pre><code class="language-bash">docker run -p 8080:8080 -p 50000:50000 -v jenkins_home:/var/jenkins_home myjenkins
</code></pre>

<h2 id="installing-additional-jenkins-plugins">安装附加的Jenkins插件</h2>

<p>安装新插件最简单的方法是使用Jenkins web UI。任何新插件都存储到外部卷，因此即使您创建、销毁和更新容器，它们也是可用的。</p>

<p>您还可以通过调用包含在基础Jenkins映像中的<code>jenkins-plugin-cli</code>脚本来自动化安装插件的过程，作为自定义Docker映像的一部分。</p>

<p>这里有一个<code>Dockerfile</code>安装<a href="https://plugins.jenkins.io/octopusdeploy/" rel="nofollow"> Octopus Jenkins插件</a>的例子:</p>

<pre><code class="language-dockerfile">FROM jenkins/jenkins:lts-jdk11
USER root
RUN apt update &amp;&amp; \
    apt install -y --no-install-recommends gnupg curl ca-certificates apt-transport-https &amp;&amp; \
    curl -sSfL https://apt.octopus.com/public.key | apt-key add - &amp;&amp; \
    sh -c "echo deb https://apt.octopus.com/ stable main &gt; /etc/apt/sources.list.d/octopus.com.list" &amp;&amp; \
    apt update &amp;&amp; apt install -y octopuscli
RUN jenkins-plugin-cli --plugins octopusdeploy:3.1.6
USER jenkins
</code></pre>

<p>这个<code>Dockerfile</code>类似于前面的例子，但是包括一个新的<code>RUN</code>语句来安装Octopus插件:</p>

<pre><code class="language-dockerfile">RUN jenkins-plugin-cli --plugins octopusdeploy:3.1.6
</code></pre>

<p>插件ID ( <code>octopusdeploy</code>)和版本(<code>3.1.6</code>)可从<a href="https://plugins.jenkins.io/octopusdeploy/" rel="nofollow"> Jenkins插件网站</a>找到:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-01/jenkins-docker-install-guide/jenkins-plugin.png" class="zoom" data-title=""><img src="../Images/35e095533867f30e7b5ac6cbaf9f9492.png" class="img-fluid center" alt="Jenkins Plugin Website with the ID octopus deploy and version 3.1.6 highlighted" data-original-src="https://i.octopus.com/blog/2022-01/jenkins-docker-install-guide/jenkins-plugin.png"/>T2】</a></p>

<h2 id="publishing-the-custom-docker-image">发布自定义Docker图像</h2>

<p>要发布您的自定义Docker图像，您需要一个Docker注册表帐户。DockerHub 是一个受欢迎的选择，它提供公共图像的免费托管。</p>

<p><a href="https://hub.docker.com/signup" rel="nofollow">创建一个免费账户</a>，然后使用命令登录:</p>

<pre><code class="language-bash">docker login
</code></pre>

<p>要构建可以发布到DockerHub的映像，运行以下命令，用您的DockerHub用户名替换<code>username</code>:</p>

<pre><code class="language-bash">docker build . -t username/myjenkins
</code></pre>

<p>使用以下命令发布图像:</p>

<pre><code>docker push username/myjenkins
</code></pre>

<p>我的DockerHub用户名是<code>mcasperson</code>，所以我运行这些命令来构建和发布一个图像:</p>

<pre><code class="language-bash">docker build . -t mcasperson/myjenkins
docker push mcasperson/myjenkins
</code></pre>

<p>然后我的自定义Docker图像就可以从<a href="https://hub.docker.com/r/mcasperson/myjenkins" rel="nofollow"> DockerHub </a>获得了。</p>

<h2 id="passing-java-arguments">传递Java参数</h2>

<p>高级Jenkins配置通常通过传递Java参数来执行，通常是以系统属性的形式。</p>

<p>Jenkins Docker映像允许在<code>JAVA_OPTS</code>环境变量中定义Java参数。这个环境变量由启动Jenkins 的<a href="https://github.com/jenkinsci/docker/blob/master/jenkins.sh" rel="nofollow"> Docker映像脚本读取，并作为Java参数传递。</a></p>

<p>要定义<code>JAVA_OPTS</code>环境变量，请将<code>--env</code>参数传递给<code>docker run</code>命令:</p>

<pre><code class="language-bash">docker run -p 8080:8080 -p 50000:50000 -v jenkins_home:/var/jenkins_home --env JAVA_OPTS=-Dhudson.footerURL=http://mycompany.com jenkins/jenkins:lts-jdk11
</code></pre>

<p>Jenkins系统属性列表可在<a href="https://www.jenkins.io/doc/book/managing/system-properties/" rel="nofollow"> Jenkins文档</a>中找到。</p>

<h2 id="passing-jenkins-arguments">传递詹金斯论点</h2>

<p>除了系统属性之外，Jenkins还接受许多应用程序参数。</p>

<p>应用程序参数通过将它们附加到Docker run命令的末尾来定义。以下示例传递了配置Jenkins监听端口8081的参数<code>--httpPort</code>:</p>

<pre><code class="language-bash">docker run -p 8080:8081 -p 50000:50000 -v jenkins_home:/var/jenkins_home jenkins/jenkins:lts-jdk11 --httpPort=8081
</code></pre>

<p>应用程序参数也可以在<code>JENKINS_OPTS</code>环境变量中定义:</p>

<pre><code class="language-bash">docker run -p 8080:8081 -p 50000:50000 -v jenkins_home:/var/jenkins_home --env JENKINS_OPTS=--httpPort=8081 jenkins/jenkins:lts-jdk11 
</code></pre>

<p>在<a href="https://github.com/jenkinsci/winstone#command-line-options" rel="nofollow"> Winstone GitHub库</a>中可以找到应用参数列表。Winstone是Jenkins中默认的嵌入式servlet容器。</p>

<h2 id="backup-the-docker-volume">备份Docker卷</h2>

<p>您可以运行以下命令来备份保存在托管<code>/var/jenkins_home</code>目录的Docker卷中的数据。它将卷挂载到一个新的容器中，将当前工作目录挂载到容器的<code>/backup</code>目录中，并创建一个名为<code>backup.tar</code>的归档文件，其中包含<code>/var/jenkins</code>目录的内容:</p>

<pre><code class="language-bash">docker run --rm -v jenkins_home:/var/jenkins_home -v $(pwd):/backup ubuntu tar cvf /backup/backup.tar /var/jenkins_home
</code></pre>

<p>这个命令可以在Jenkins容器运行时运行，因为Docker卷可以在运行的容器之间共享。然而，<a href="https://docs.cloudbees.com/docs/admin-resources/latest/backup-restore/best-practices" rel="nofollow">建议您在执行备份之前停止Jenkins</a>:</p>

<blockquote class="blockquote">
<p>尽管Jenkins利用了COW，但建议您在执行备份之前尽可能停止Jenkins，因为管道工作流XML文件可能会在不一致的状态下被捕获(例如，如果备份没有在该确切时刻拍摄每个文件的“即时快照”)。</p>
</blockquote>

<h2 id="running-docker-images-as-services">将Docker图像作为服务运行</h2>

<p>当底层操作系统重启时，Jenkins的生产实例必须自动重启。然而，这不是您使用上面显示的Docker命令启动的容器的默认行为，因此任何Jenkins容器在OS重启后都将保持停止状态。</p>

<p>要解决这个问题，您可以将Docker容器作为systemd服务运行。这允许您管理Jenkins容器，就像管理安装了包管理器的Jenkins实例一样。</p>

<p>要创建新的systemd服务，请将以下内容保存到文件<code>/etc/systemd/system/docker-jenkins.service</code>:</p>

<pre><code>[Unit]
Description=Jenkins

[Service]
SyslogIdentifier=docker-jenkins
ExecStartPre=-/usr/bin/docker create -m 0b -p 8080:8080 -p 50000:50000 --restart=always --name jenkins jenkins/jenkins:lts-jdk11
ExecStart=/usr/bin/docker start -a jenkins
ExecStop=-/usr/bin/docker stop --time=0 jenkins

[Install]
WantedBy=multi-user.target
</code></pre>

<p>要加载新的服务文件，请运行以下命令:</p>

<pre><code class="language-bash">sudo systemctl daemon-reload
</code></pre>

<p>要启动该服务，请运行命令:</p>

<pre><code class="language-bash">sudo systemctl start docker-jenkins
</code></pre>

<p>要使服务能够在重启时运行，请运行以下命令:</p>

<pre><code class="language-bash">sudo systemctl enable docker-jenkins
</code></pre>

<p>要查看服务日志，请运行命令:</p>

<pre><code class="language-bash">sudo journalctl -u docker-jenkins -f
</code></pre>

<h2 id="conclusion">结论</h2>

<p>从Docker映像运行Jenkins提供了一种在自包含的预配置环境中启动Jenkins的便捷方法。</p>

<p>在这篇文章中，你学会了如何:</p>

<ul>
<li>把詹金斯放在码头集装箱里</li>
<li>安装附加工具和插件</li>
<li>传递Java系统属性和Jenkins应用程序参数</li>
<li>备份Docker卷</li>
<li>将Docker容器配置为systemd服务</li>
</ul>

<p>然而，在工作站或服务器上运行Docker镜像仅仅是个开始。在下一篇文章中，您将学习如何将Jenkins部署到Kubernetes集群中。</p>

<p><a href="https://oc.to/JenkinsPipelineGenerator" rel="nofollow">试试我们免费的Jenkins管道生成器工具</a>用Groovy语法创建一个管道文件。这是您启动管道项目所需的一切。</p>

<h2 id="watch-our-jenkins-pipeline-webinar">观看我们的詹金斯管道网络研讨会</h2>

<iframe src="https://www.youtube.com/embed/D_7AHTML_xw" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen="">VIDEO</iframe>

<p>我们定期举办网络研讨会。请参见<a href="https://octopus.com/events">网络研讨会第</a>页，了解即将举办的活动和现场直播的详细信息。</p>

<p>阅读我们的<a href="https://octopus.com/blog/tag/CI%20Series">持续集成系列</a>的其余部分。</p>

<p>愉快的部署！</p>

                    
                    
</body>
</html>