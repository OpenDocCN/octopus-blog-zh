<html>
<head>
<title>PowerShell and exit code 0 - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>PowerShell和退出代码0 - Octopus部署</h1>
<blockquote>原文：<a href="https://octopus.com/blog/powershell-exit-codes#2019-09-26">https://octopus.com/blog/powershell-exit-codes#2019-09-26</a></blockquote>
                        <p>Octopus Deploy有两种不同的方式来执行PowerShell脚本。最初，我们在AppDomain中托管PowerShell并调用管道。那种方法有问题，所以现在我们简单地调用PowerShell.exe的脚本并通过管道传输结果。</p>

<p>当我改变我们的方法时，我遇到的一个问题是PowerShell使用<a href="http://en.wikipedia.org/wiki/Exit_status">返回代码</a>的方式。我(错误地)假设，如果脚本运行成功，将返回0，如果失败(异常、无效语法等)。)代码将是非零的。</p>

<p>这里有一个测试。在PowerShell中创建此文件:</p>

<pre><code># Call a command that doesn't exist
rubbish
</code></pre>

<p>现在，运行它并打印它返回的返回代码:</p>

<p><img src="../Images/186f50c3c7fccb1b5276082adc7007f1.png" alt="Exits with code 0" data-original-src="https://i.octopus.com/blog/migrated/13/01-no-command-exists.png"/></p>

<p>现在，试试这个脚本:</p>

<pre><code># Parser error
!
</code></pre>

<p><img src="../Images/9c7dc021ab200e0a7f5ecd30f8942313.png" alt="Exits with code 0" data-original-src="https://i.octopus.com/blog/migrated/13/02-parser-error.png"/></p>

<p>另一个:</p>

<pre><code># Invalid argument
New-Item -Dwarf Sneezy
</code></pre>

<p><img src="../Images/36117550e4c88cf673294242a5e42e98.png" alt="Exits with code 0" data-original-src="https://i.octopus.com/blog/migrated/13/03-no-parameter.png"/></p>

<p>显然，PowerShell中的退出代码0可以表示从“脚本运行良好”到“您的脚本完全崩溃，PowerShell将被卸载”的任何内容。有人可能会认为这是正确的行为，因为PowerShell成功地完成了它的工作(运行脚本)，但脚本是不正确的，这不是PowerShell的错。就我个人而言，我不同意这种方法。这就像C#编译器为不能编译的代码返回退出代码0，因为代码不好并不是编译器的错。</p>

<p>所以，我不能仅仅依靠退出代码来告诉Octopus脚本失败了。</p>

<p>然而，所有这些类型的错误确实会写入到<a href="http://www.cplusplus.com/reference/cstdio/stderr/">的stderr流</a>，而<em>的stderr流</em>是好的，所以我认为，如果脚本正在写入到<code>stderr</code>，则脚本存在某种问题，我们可以使用写入到<code>stderr</code>的信号来使脚本失败。我在章鱼1.4就是这么做的。</p>

<p>但是这在实践中并不是很好，事实证明人们大量使用<code>stderr</code>是因为他们不想让部署失败。所以我收到了很多关于脚本运行“正常”但被视为失败的错误报告。</p>

<p>现在，我不对返回代码做任何事情(哦，除了如果<code>$LastExitCode</code>不为零，我会设置PowerShell退出代码)。当脚本运行时，由您来检查错误并返回适当的退出代码。<a href="http://weblogs.asp.net/soever/archive/2010/07/14/returning-an-exit-code-from-a-powershell-script.aspx"> PowerShell让这一切变得非常简单</a>。</p>

<p>然而，对<code>stderr</code>的写入将会在您的部署日志中产生一个警告。如果有警告，你可以使用特殊的章鱼变量<code>OctopusTreatWarningsAsErrors</code>让章鱼停止部署。因此，这是一种即使PowerShell以代码0退出，也可以在写入<code>stderr</code>时让Octopus失败的方法。</p>

<h3>了解更多信息</h3>



                    
                    
</body>
</html>