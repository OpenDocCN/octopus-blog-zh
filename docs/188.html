<html>
<head>
<title>Deploying a Lambda with CloudFormation - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>使用CloudFormation部署Lambda-Octopus部署</h1>
<blockquote>原文：<a href="https://octopus.com/blog/deploying-lambda-cloudformation#2022-07-04">https://octopus.com/blog/deploying-lambda-cloudformation#2022-07-04</a></blockquote>
                        <p>Lambda是AWS提供的无服务器功能即服务(FaaS)。Lambdas提供了可伸缩性、高可用性，以及可伸缩至零的能力，从而降低了不常用部署的成本。</p>

<p>像大多数AWS资源一样，Lambdas可以访问VPC来与数据库或EC2实例等其他资源进行交互。</p>

<p>在本文中，您将部署一个简单的Lambda，然后在上一篇文章中提供的带有私有和公共子网的<a href="https://octopus.com/blog/aws-vpc-public-private"> VPC的基础上，使用CloudFormation在一个可以访问互联网的VPC中部署一个Lambda。</a></p>

<h2 id="a-simple-lambda-cloudformation-template">一个简单的Lambda CloudFormation模板</h2>

<p>部署Lambda可以简单到创建一个日志组来捕获Lambda的输出，通过IAM角色授予Lambda对日志组的访问权限，然后定义Lambda本身。部署这些资源的模板示例如下所示:</p>

<pre><code class="language-yaml">Parameters:
  Tag:
    Type: String
  LambdaS3Bucket:
    Type: String
  LambdaS3Key:
    Type: String
  LambdaName:
    Type: String

Resources: 
  AppLogGroup:
    Type: "AWS::Logs::LogGroup"
    Properties:
      LogGroupName: !Sub "/aws/lambda/${LambdaName}"

  IamRoleLambdaExecution:
    Type: "AWS::IAM::Role"
    Properties:
      Path: "/"
      RoleName: !Sub "${LambdaName}-role"  
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
        - Effect: "Allow"
          Principal:
            Service:
            - "lambda.amazonaws.com"
          Action: "sts:AssumeRole"
      ManagedPolicyArns: 
      - "arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole"
      Policies:
      - PolicyName: !Sub "${LambdaName}-policy"
        PolicyDocument:
          Version: "2012-10-17"
          Statement:
          - Effect: "Allow"
            Action:
            - "logs:CreateLogStream"
            - "logs:CreateLogGroup"
            - "logs:PutLogEvents"
            Resource:
            - !Sub "arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/${LambdaName}*:*"

  MyLambda:
    Type: "AWS::Lambda::Function"
    Properties:
        Code:
          S3Bucket: !Ref "LambdaS3Bucket"
          S3Key: !Ref "LambdaS3Key"
        Description: "My Lambda"
        FunctionName: !Ref "LambdaName"
        Handler: "not.used.in.provided.runtime"
        MemorySize: 256
        PackageType: "Zip"
        Role: !GetAtt "IamRoleLambdaExecution.Arn"
        Runtime: "provided"
        Timeout: 30
</code></pre>

<p>Lambda生成的日志放在一个新的日志组中，由<a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-logs-loggroup.html" rel="nofollow"> AWS <span> Logs </span> LogGroup </a>资源表示:</p>

<pre><code class="language-yaml">  AppLogGroup:
    Type: "AWS::Logs::LogGroup"
    Properties:
      LogGroupName: !Sub "/aws/lambda/${LambdaName}"
</code></pre>

<p>要授予Lambda写入上述日志组的权限，您必须创建一个可由Lambda承担的新IAM角色，并包括写入日志组的权限:</p>

<pre><code class="language-yaml">  IamRoleLambdaExecution:
    Type: "AWS::IAM::Role"
    Properties:
      Path: "/"
      RoleName: !Sub "${LambdaName}-role"  
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
        - Effect: "Allow"
          Principal:
            Service:
            - "lambda.amazonaws.com"
          Action: "sts:AssumeRole"
      ManagedPolicyArns: 
      - "arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole"
      Policies:
      - PolicyName: !Sub "${LambdaName}-policy"
        PolicyDocument:
          Version: "2012-10-17"
          Statement:
          - Effect: "Allow"
            Action:
            - "logs:CreateLogStream"
            - "logs:CreateLogGroup"
            - "logs:PutLogEvents"
            Resource:
            - !Sub "arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/${LambdaName}*:*"
</code></pre>

<p>最后一步是创建Lambda本身，由<a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-lambda-function.html" rel="nofollow"> AWS <span> Lambda </span>函数</a>资源表示。</p>

<p>兰达斯部署已经上传到S3桶的代码。CloudFormation不执行文件上传，因此这必须在部署模板之前单独执行。</p>

<p>下面的示例Lambda被配置为部署一个本地编译的二进制文件，通常用Go之类的语言编写，或者使用GraalVM之类的编译器。</p>

<p>其他语言，如Java、DotNET Core、Python、PHP和Node.js，需要它们自己的<a href="https://docs.aws.amazon.com/lambda/latest/dg/lambda-runtimes.html" rel="nofollow">唯一运行时</a>，这影响了CloudFormation模板中的<a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-lambda-function.html#cfn-lambda-function-runtime" rel="nofollow"> <code>Runtime</code> </a>和<a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-lambda-function.html#cfn-lambda-function-handler" rel="nofollow"> <code>Handler</code> </a>属性:</p>

<pre><code class="language-yaml">MyLambda:
  Type: "AWS::Lambda::Function"
  Properties:
      Code:
        S3Bucket: !Ref "LambdaS3Bucket"
        S3Key: !Ref "LambdaS3Key"
      Description: "My Lambda"
      FunctionName: !Ref "LambdaName"
      Handler: "not.used.in.provided.runtime"
      MemorySize: 256
      PackageType: "Zip"
      Role: !GetAtt "IamRoleLambdaExecution.Arn"
      Runtime: "provided"
      Timeout: 30
</code></pre>

<h2 id="placing-a-lambda-in-a-vpc">在VPC中放置一个λ</h2>

<p>在一个更复杂的场景中，您的Lambda将被授权访问一个VPC，以便访问像数据库或EC2实例这样的共享资源。</p>

<p>下面的模板建立在前面的示例基础上，演示了一个混合了<a href="https://octopus.com/blog/aws-vpc-public-private">公共和私有子网</a>的VPC，然后部署了一个具有<a href="https://docs.aws.amazon.com/lambda/latest/dg/configuration-vpc.html" rel="nofollow"> VPC访问</a>的Lambda:</p>

<pre><code class="language-yaml">Parameters:
  Tag:
    Type: String
  LambdaS3Bucket:
    Type: String
  LambdaS3Key:
    Type: String
  LambdaName:
    Type: String

Resources: 
  VPC:
    Type: "AWS::EC2::VPC"
    Properties:
      CidrBlock: "10.0.0.0/16"
      InstanceTenancy: "default"
      Tags:
      - Key: "Name"
        Value: !Ref "Tag"

  InternetGateway:
    Type: "AWS::EC2::InternetGateway"

  VPCGatewayAttachment:
    Type: "AWS::EC2::VPCGatewayAttachment"
    Properties:
      VpcId: !Ref "VPC"
      InternetGatewayId: !Ref "InternetGateway"

  SubnetA:
    Type: "AWS::EC2::Subnet"
    Properties:
      AvailabilityZone: !Select 
        - 0
        - !GetAZs 
          Ref: 'AWS::Region'
      VpcId: !Ref "VPC"
      CidrBlock: "10.0.0.0/24"

  SubnetB:
    Type: "AWS::EC2::Subnet"
    Properties:
      AvailabilityZone: !Select 
        - 1
        - !GetAZs 
          Ref: 'AWS::Region'
      VpcId: !Ref "VPC"
      CidrBlock: "10.0.1.0/24"

  SubnetC:
    Type: "AWS::EC2::Subnet"
    Properties:
      AvailabilityZone: !Select 
        - 1
        - !GetAZs 
          Ref: 'AWS::Region'
      VpcId: !Ref "VPC"
      CidrBlock: "10.0.2.0/24"

  RouteTable:
    Type: "AWS::EC2::RouteTable"
    Properties:
      VpcId: !Ref "VPC"

  InternetRoute:
    Type: "AWS::EC2::Route"
    Properties:
      DestinationCidrBlock: "0.0.0.0/0"
      GatewayId: !Ref InternetGateway
      RouteTableId: !Ref RouteTable

  SubnetARouteTableAssociation:
    Type: "AWS::EC2::SubnetRouteTableAssociation"
    Properties:
      RouteTableId: !Ref RouteTable
      SubnetId: !Ref SubnetA

  EIP:
    Type: "AWS::EC2::EIP"
    Properties:
      Domain: "vpc"

  Nat:
    Type: "AWS::EC2::NatGateway"
    Properties:
      AllocationId: !GetAtt "EIP.AllocationId"
      SubnetId: !Ref "SubnetA"

  NatRouteTable:
    Type: "AWS::EC2::RouteTable"
    Properties:
      VpcId: !Ref "VPC"

  NatRoute:
    Type: "AWS::EC2::Route"
    Properties:
      DestinationCidrBlock: "0.0.0.0/0"
      NatGatewayId: !Ref "Nat"
      RouteTableId: !Ref "NatRouteTable"

  SubnetBRouteTableAssociation:
    Type: "AWS::EC2::SubnetRouteTableAssociation"
    Properties:
      RouteTableId: !Ref NatRouteTable
      SubnetId: !Ref SubnetB

  SubnetCRouteTableAssociation:
    Type: "AWS::EC2::SubnetRouteTableAssociation"
    Properties:
      RouteTableId: !Ref NatRouteTable
      SubnetId: !Ref SubnetC

  InstanceSecurityGroup:
    Type: "AWS::EC2::SecurityGroup"
    Properties:
      GroupName: "Example Security Group"
      GroupDescription: "Lambda Traffic"
      VpcId: !Ref "VPC"
      SecurityGroupEgress:
      - IpProtocol: "-1"
        CidrIp: "0.0.0.0/0"

  InstanceSecurityGroupIngress:
    Type: "AWS::EC2::SecurityGroupIngress"
    DependsOn: "InstanceSecurityGroup"
    Properties:
      GroupId: !Ref "InstanceSecurityGroup"
      IpProtocol: "tcp"
      FromPort: "0"
      ToPort: "65535"
      SourceSecurityGroupId: !Ref "InstanceSecurityGroup"

  AppLogGroup:
    Type: "AWS::Logs::LogGroup"
    Properties:
      LogGroupName: !Sub "/aws/lambda/${LambdaName}"

  IamRoleLambdaExecution:
    Type: "AWS::IAM::Role"
    Properties:
      Path: "/"
      RoleName: !Sub "${LambdaName}-role"  
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
        - Effect: "Allow"
          Principal:
            Service:
            - "lambda.amazonaws.com"
          Action: "sts:AssumeRole"
      ManagedPolicyArns: 
      - "arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole"
      Policies:
      - PolicyName: !Sub "${LambdaName}-policy"
        PolicyDocument:
          Version: "2012-10-17"
          Statement:
          - Effect: "Allow"
            Action:
            - "logs:CreateLogStream"
            - "logs:CreateLogGroup"
            - "logs:PutLogEvents"
            Resource:
            - !Sub "arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/${LambdaName}*:*"

  MyLambda:
    Type: "AWS::Lambda::Function"
    Properties:
        Code:
          S3Bucket: !Ref "LambdaS3Bucket"
          S3Key: !Ref "LambdaS3Key"
        Description: "My Lambda"
        FunctionName: !Ref "LambdaName"
        Handler: "not.used.in.provided.runtime"
        MemorySize: 256
        PackageType: "Zip"
        Role: !GetAtt "IamRoleLambdaExecution.Arn"
        Runtime: "provided"
        Timeout: 30
        VpcConfig:
            SecurityGroupIds:
            - !Ref "InstanceSecurityGroup"
            SubnetIds:
            - !Ref "SubnetB"
            - !Ref "SubnetC"

Outputs:
  VpcId:
    Description: The VPC ID
    Value: !Ref VPC
</code></pre>

<p>本模板的大部分内容定义了构建带有私有和公有子网的VPC所需的资源，以及构建网络基础设施(如internet网关和NAT网关)以提供对VPC子网中任何其它资源的internet访问。这些资源在<a href="https://octopus.com/blog/aws-vpc-public-private">我们关于用CloudFormation </a>创建混合AWS VPC的帖子中有详细介绍。</p>

<p>然后创建一个安全组，由<a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-ec2-security-group.html" rel="nofollow">AWS<span>EC2</span>security group</a>资源表示，以定义应用于该VPC中资源的网络规则。此示例包括允许所有出站流量的规则:</p>

<pre><code class="language-yaml">  InstanceSecurityGroup:
    Type: "AWS::EC2::SecurityGroup"
    Properties:
      GroupName: "Example Security Group"
      GroupDescription: "Lambda Traffic"
      VpcId: !Ref "VPC"
      SecurityGroupEgress:
      - IpProtocol: "-1"
        CidrIp: "0.0.0.0/0"
</code></pre>

<p>共享安全组的资源被允许使用以下安全组入口规则相互通信，该规则由<a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-ec2-security-group-ingress.html" rel="nofollow">AWS<span>EC2</span>SecurityGroupIngress</a>资源表示。这允许相关资源相互访问，而不需要它们具有已知的IP地址或被放置在特殊的CIDR块中:</p>

<pre><code class="language-yaml">  InstanceSecurityGroupIngress:
    Type: "AWS::EC2::SecurityGroupIngress"
    DependsOn: "InstanceSecurityGroup"
    Properties:
      GroupId: !Ref "InstanceSecurityGroup"
      IpProtocol: "tcp"
      FromPort: "0"
      ToPort: "65535"
      SourceSecurityGroupId: !Ref "InstanceSecurityGroup"
</code></pre>

<p>日志组和IAM角色与本文开头描述的简单示例相同。</p>

<p>Lambda略有变化，增加了一个新的<code>VPCConfig</code>属性，允许Lambda访问VPC内部的资源。</p>

<p>值得注意的是，Lambda被授权访问私有子网<code>SubnetB</code>和<code>SubnetC</code>，这些子网没有连接互联网网关:</p>

<pre><code class="language-yaml">  MyLambda:
    Type: "AWS::Lambda::Function"
    Properties:
        Code:
          S3Bucket: !Ref "LambdaS3Bucket"
          S3Key: !Ref "LambdaS3Key"
        Description: "My Lambda"
        FunctionName: !Ref "LambdaName"
        Handler: "not.used.in.provided.runtime"
        MemorySize: 256
        PackageType: "Zip"
        Role: !GetAtt "IamRoleLambdaExecution.Arn"
        Runtime: "provided"
        Timeout: 30
        VpcConfig:
            SecurityGroupIds:
            - !Ref "InstanceSecurityGroup"
            SubnetIds:
            - !Ref "SubnetB"
            - !Ref "SubnetC"
</code></pre>

<h2 id="conclusion">结论</h2>

<p>Lambda很容易部署，只需要少量的支持资源，如日志组和IAM角色，就可以对Lambda进行监控和调试。</p>

<p>对于更复杂的场景，其中lambda必须能够访问其他资源，如VPC中的数据库或EC2实例，可以配置lambda对指定子网的网络访问，并使用安全组控制网络流量。</p>

<p>在这篇文章中，您了解了如何执行简单的Lambda部署，然后看到了一个更复杂的例子，它在Lambda的基础上构建了一个VPC。</p>

<p>我们有<a href="https://octopus.com/blog/tag/CloudFormation">其他关于云形成模板的帖子</a>你可能也会觉得有帮助。</p>

<p>阅读我们的<a href="https://octopus.com/blog/tag/Runbooks%20Series"> Runbooks系列</a>的其余部分。</p>

<p>愉快的部署！</p>

                    
                    
</body>
</html>