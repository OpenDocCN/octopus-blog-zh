<html>
<head>
<title>Variable substitution in files with Octopus 2.3 - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Octopus 2.3 - Octopus Deploy文件中的变量替换</h1>
<blockquote>原文：<a href="https://octopus.com/blog/variable-substition-in-files#2015-09-25">https://octopus.com/blog/variable-substition-in-files#2015-09-25</a></blockquote>
                        <p>Octopus对变量提供了丰富的支持，这些变量的作用范围可以是特定的机器、环境和角色。在部署时，通过将变量名与<code>&lt;appSetting&gt;</code>和<code>&lt;connectionString&gt;</code>元素的名称相匹配，这些也可以被替换到XML <em> App.config </em>和<em> Web.config </em>文件中。</p>

<p>在Octopus 2.3中，我们将它扩展到其他类型的文件，使用在整个应用程序中工作的相同的变量语法。</p>

<p>我们的示例应用程序是一个提要监控服务，它在一个JSON文件中保存了一个目标服务器列表，该文件是:</p>

<pre>
{
  "Servers": [{
    "Name": "localhost",
    "Port": 1567
  }]
}
</pre>

<p>部署应用程序时，我们希望根据目标部署环境配置列表。UAT环境中的服务器被称为<em> FOREXUAT01 </em>和<em> FOREXUAT02 </em>。</p>

<p><img alt="Variables" src="../Images/28b0d06dfa6bc833900f965092429e2e.png" data-original-src="https://i.octopus.com/blog/migrated/Variables_wlixps.png"/></p>

<p>我们隐式地建立了一个包含两个条目的<code>ServerEndpoints</code>集合，UAT环境中的每台服务器都有一个条目。</p>

<p>我们可以在部署时运行的模板文件中迭代这些。为了不妨碍开发，我们称它为<em> Config.json.template </em>。</p>

<pre>
{
  "Servers": [
    #{each server in ServerEndpoints}
      {
        "Name": "#{server.Name}",
        "Port": #{server.Port}
      }#{unless Octopus.Template.Each.Last},#{/unless}
    #{/each}
  ]
}
</pre>

<p>您可能熟悉简单形式的<code>#{Variable}</code>语法。这个例子使用了一些在Octopus 2.0中增加的新特性，包括<code>#{each}</code>和<code>#{unless}</code>。</p>

<p>随着<em> Config.json.template </em>包含在我们应用的NuGet包中，下一步是启用部署特性。</p>

<p><img alt="Enabling the feature" src="../Images/48d029edf35d534a10d9c2c93de11f1c.png" data-original-src="https://i.octopus.com/blog/migrated/EnableFeature_rjgtmv.png"/></p>

<p>该特性易于配置，接受Octopus将在其中执行变量替换的文件列表。</p>

<p><img alt="Configuring substitutions" src="../Images/2ce1d808702069af3f0d28e53b0d1ba9.png" data-original-src="https://i.octopus.com/blog/migrated/Configuration_mzq39d.png"/></p>

<p>由于我们使用了与目标文件不同的模板名称，我们还将添加一个PowerShell片段，用模板文件的内容替换原来的<em> Config.json </em>。</p>

<p><img alt="PostDeploy" src="../Images/9104582573508aa68d147ecff789a830.png" data-original-src="https://i.octopus.com/blog/migrated/PostDeploy_psbavj.png"/></p>

<p>该模板现在将作为我们部署过程的一部分运行。</p>

<p><img alt="Execution" src="../Images/693afc143257ed24228bc7fe34b128a1.png" data-original-src="https://i.octopus.com/blog/migrated/Execution_g0iep8.png"/></p>

<p>生成的JSON文件是(空白被稍微清除了一点):</p>

<pre>
{
  "Servers": [
    {
      "Name": "forexuat01.local",
      "Port": 1566
    },
    {
      "Name": "forexuat02.local",
      "Port": 1566
    }
  ]
}
</pre>

<p>愉快的部署！</p>

                    
                    
</body>
</html>