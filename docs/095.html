<html>
<head>
<title>Building the Apache Portable Runtime (APR) - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>构建Apache可移植运行时(APR) - Octopus部署</h1>
<blockquote>原文：<a href="https://octopus.com/blog/building-apr-for-tomcat#2022-07-15">https://octopus.com/blog/building-apr-for-tomcat#2022-07-15</a></blockquote>
                        <p>Tomcat使用Apache Portable Runtime (APR) 来提供许多增强的特性和性能。例如，为了获得OpenSSL为HTTPS提供的增强性能，APR需要存在。</p>

<p>Tomcat为Windows用户提供了APR的预编译版本，但是Linux用户经常被要求从他们的操作系统分发包库中安装APR。</p>

<p>这些是可从Centos 7的<a href="https://fedoraproject.org/wiki/EPEL" rel="nofollow"> EPEL回购</a>获得的APR和Tomcat原生包:</p>

<pre><code>$ yum info apr
Loaded plugins: fastestmirror, langpacks
Determining fastest mirrors
 * base: centos.mirror.ausnetservers.net.au
 * epel: fedora.melbourneitmirror.net
 * extras: mirror.nsw.coloau.com.au
 * updates: mirror.nsw.coloau.com.au
Installed Packages
Name        : apr
Arch        : x86_64
Version     : 1.4.8
Release     : 3.el7
Size        : 221 k
Repo        : installed
From repo   : anaconda
Summary     : Apache Portable Runtime library
URL         : http://apr.apache.org/
License     : ASL 2.0 and BSD with advertising and ISC and BSD
Description : The mission of the Apache Portable Runtime (APR) is to provide a
            : free library of C data structures and routines, forming a system
            : portability layer to as many operating systems as possible,
            : including Unices, MS Win32, BeOS and OS/2.

Available Packages
Name        : apr
Arch        : i686
Version     : 1.4.8
Release     : 3.el7
Size        : 107 k
Repo        : base/7/x86_64
Summary     : Apache Portable Runtime library
URL         : http://apr.apache.org/
License     : ASL 2.0 and BSD with advertising and ISC and BSD
Description : The mission of the Apache Portable Runtime (APR) is to provide a
            : free library of C data structures and routines, forming a system
            : portability layer to as many operating systems as possible,
            : including Unices, MS Win32, BeOS and OS/2.

$ yum info tomcat-native
Loaded plugins: fastestmirror, langpacks
Loading mirror speeds from cached hostfile
 * base: centos.mirror.ausnetservers.net.au
 * epel: fedora.melbourneitmirror.net
 * extras: mirror.nsw.coloau.com.au
 * updates: mirror.nsw.coloau.com.au
Installed Packages
Name        : tomcat-native
Arch        : x86_64
Version     : 1.1.34
Release     : 1.el7
Size        : 172 k
Repo        : installed
From repo   : epel
Summary     : Tomcat native library
URL         : http://tomcat.apache.org/tomcat-8.0-doc/apr.html
License     : ASL 2.0
Description : Tomcat can use the Apache Portable Runtime to provide superior
            : scalability, performance, and better integration with native server
            : technologies.  The Apache Portable Runtime is a highly portable library
            : that is at the heart of Apache HTTP Server 2.x.  APR has many uses,
            : including access to advanced IO functionality (such as sendfile, epoll
            : and OpenSSL), OS level functionality (random number generation, system
            : status, etc), and native process handling (shared memory, NT pipes and
            : Unix sockets).  This package contains the Tomcat native library which
            : provides support for using APR in Tomcat.
</code></pre>

<p>所以我们可以访问提供APR版本1.4.8和Tomcat原生版本1.1.34的包。但是安装了这些软件包后，Tomcat 9.01会报告以下错误:</p>

<pre><code>org.apache.catalina.core.AprLifecycleListener.init An incompatible version [1.1.34] of the APR based Apache Tomcat Native library is installed, while Tomcat requires version [1.2.14]
</code></pre>

<p>这意味着我们可以从Centos软件包管理器安装的版本对于Tomcat的更高版本来说不够新。</p>

<p>解决方法是自己编译这些库。这听起来很复杂，但实际上很简单。</p>

<p>首先，您需要安装开发工具和Java开发工具包。在Centos中，这是通过以下命令完成的:</p>

<pre><code>sudo yum groupinstall "Development Tools"
sudo yum install java-1.8.0-openjdk-devel
</code></pre>

<p>接下来运行下面的脚本，它将下载、提取、编译和安装Tomcat所需的各种库。</p>

<p>这个脚本中的URL指向[https://Tomcat . Apache . org/download-Native . CGI](Tomcat Native)库和<a href="https://apr.apache.org/download.cgi" class="alert-link" rel="nofollow"> APR </a>库的镜像。您可以更改这些URL以指向一个更近的服务器，或者如果此处列出的服务器已关闭，则指向一个不同的服务器。</p>


<pre><code>#!/usr/bin/env bash
cd /tmp
wget http://apache.mirror.amaze.com.au//apr/apr-1.6.3.tar.gz
tar -zxvf apr-1.6.3.tar.gz
cd apr-1.6.3
./configure
make
make install

cd /tmp
wget http://apache.mirror.amaze.com.au//apr/apr-util-1.6.1.tar.gz
tar -zxvf apr-util-1.6.1.tar.gz
cd apr-util-1.6.1
./configure --with-apr=/usr/local/apr
make
make install

cd /tmp
wget http://apache.melbourneitmirror.net/tomcat/tomcat-connectors/native/1.2.14/source/tomcat-native-1.2.14-src.tar.gz
tar -zxvf tomcat-native-1.2.14-src.tar.gz
cd tomcat-native-1.2.14-src/native
./configure --with-apr=/usr/local/apr --with-java-home=/usr/lib/jvm/java-1.8.0-openjdk
make
make install
</code></pre>

<p>最后，在Tomcat目录下创建一个名为<code>bin/setenv.sh</code>的文件，内容如下。这允许Tomcat找到由上面的脚本编译的库。</p>

<pre><code>CATALINA_OPTS="-Djava.library.path=/usr/local/apr/lib"
</code></pre>

<p>完成这些更改后，您应该会在<code>logs/catalina.out</code>文件中看到以下消息。这表明Tomcat成功地加载了APR库。</p>

<pre><code>31-Oct-2017 18:21:08.930 INFO [main] org.apache.catalina.core.AprLifecycleListener.lifecycleEvent Loaded APR based Apache Tomcat Native library [1.2.14] using APR version [1.6.3].
</code></pre>

<p>如果您对将Java应用程序自动部署到Tomcat感兴趣，<a href="https://octopus.com/downloads">下载Octopus Deploy </a>的试用版，并查看一下<a href="https://octopus.com/docs/deployments/java/deploying-java-applications">我们的文档</a>。</p>

                    
                    
</body>
</html>