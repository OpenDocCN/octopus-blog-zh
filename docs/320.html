<html>
<head>
<title>Infrastructure as code in Azure with Octopus Deploy and Pulumi: Part two - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>使用Octopus Deploy和Pulumi将基础设施作为代码:第二部分——Octopus Deploy</h1>
<blockquote>原文：<a href="https://octopus.com/blog/iac-azure-octopus-pulumi-part-2#2021-08-12">https://octopus.com/blog/iac-azure-octopus-pulumi-part-2#2021-08-12</a></blockquote>
                        <p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-04/iac-azure-octopus-pulumi-part-2/blogimage-infrastructure-development-azure-pulumi-2.png" class="zoom" data-title=""><img src="../Images/080e5211a812dc41654a54ac75d4f977.png" class="img-fluid center" alt="Infrastructure as code in Azure with Octopus Deploy and Pulumi: Part two" data-original-src="https://i.octopus.com/blog/2021-04/iac-azure-octopus-pulumi-part-2/blogimage-infrastructure-development-azure-pulumi-2.png"/>T2】</a></p>

<p>在本系列关于使用Pulumi和Octopus Deploy进行基础设施开发的第一部分中，我向您展示了如何使用一个新项目配置Pulumi，并使用Pulumi SDK编写代码，该SDK使用Go指定Azure。</p>

<p>在这篇文章中，我将讨论部署，并向您展示如何用Octopus Deploy打包和部署第一部分中的Go代码。</p>

<h2 id="using-a-github-repo">使用GitHub repo</h2>

<p>有不同的场景可用于构建和打包应用程序:</p>

<ul>
<li>构建服务器。</li>
<li>从藏物仓库里取出一个包裹。</li>
<li>拉上包裹的拉链。</li>
<li>加上很多其他的。</li>
</ul>

<p>在这篇文章中，我们使用GitHub，它涵盖了一个免费的通用场景。</p>

<h3 id="creating-a-github-repo">创建GitHub Repo</h3>

<p>首先，创建一个新的GitHub repo:</p>

<ol>
<li>登录<a href="https://www.github.com" rel="nofollow">github.com</a>。</li>
<li>在存储库下，单击<strong>新建</strong>。</li>
<li>给存储库起一个名字，例如，我用了名字<code>pulumi-azure-resource-group</code>。</li>
<li>因为这个存储库没有任何敏感信息，所以保留它<code>public</code>也没问题。</li>
<li>点击<strong>创建存储库</strong>。</li>
</ol>

<h3 id="pulling-down-the-repo-locally-and-pushing-the-code">本地拉下回购，推送代码</h3>

<ol>
<li>克隆GitHub repo并将您的Pulumi项目(来自<a href="/blog/iac-azure-octopus-pulumi-part-1">第一部分</a>)复制到您的本地repo中。</li>
<li>提交并将代码推送到GitHub repo。</li>
</ol>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-04/iac-azure-octopus-pulumi-part-2/images/2.png" class="zoom" data-title=""><img src="../Images/d0937d2285bd6da750641a538270f06b.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2021-04/iac-azure-octopus-pulumi-part-2/images/2.png"/>T2】</a></p>

<h3 id="create-a-version">创建一个版本</h3>

<p>为了让Octopus Deploy从GitHub获取外部提要，GitHub repo需要一个从repo内部代码构建的版本。</p>

<ol>
<li>在GitHub repo中，在<strong>发布</strong>下，点击<strong>创建新发布</strong>。</li>
</ol>

<p>【T2 <img src="../Images/5cb815ea1927dc377a86bb25fe673cc4.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2021-04/iac-azure-octopus-pulumi-part-2/images/3.png"/></p>

<ol start="2">
<li>给版本一个名称和版本号。</li>
<li>点击<strong>发布发布</strong>。这将创建一个版本。</li>
</ol>

<h2 id="configuring-an-octopus-project-for-pulumi">为Pulumi配置Octopus项目</h2>

<p>代码现在已经编写好了，被推送到GitHub，并准备好打包使用Octopus Deploy进行部署。为此，创建一个新项目并使用Pulumi社区步骤模板。</p>

<h3 id="create-an-external-feed">创建外部源</h3>

<ol>
<li>登入八达通网站。</li>
<li>转到<strong> <span class="path">库➜外部进给</span> </strong>。</li>
<li>点击<strong>添加进给</strong>。</li>
<li>对于<strong>馈送类型</strong>，选择<strong> GitHub库馈送</strong>。</li>
<li>给它起名叫<code>Pulumi Azure Resource Group</code>。</li>
</ol>

<p>您不必添加任何凭据，因为回购是公开的。</p>

<h3 id="create-a-new-project-and-project-group">创建新项目和项目组</h3>

<ol>
<li>导航到<strong>项目</strong>。</li>
<li>点击<strong>添加组</strong>。</li>
<li>将群组命名为<code>Pulumi</code>。</li>
<li>在新组中，添加一个名为<strong> Golang-Pulumi </strong>的新项目。</li>
</ol>

<h3 id="creating-project-variables">创建项目变量</h3>

<p>为了将Pulumi步骤模板部署到Azure，它需要对Azure进行身份验证。通过使用类型为<strong> Azure Account </strong>的项目变量来实现这一点。</p>

<ol>
<li>导航到您创建的项目，在<strong>变量</strong>下，点击<strong>项目</strong>。</li>
<li>创建一个新的帐户类型变量<strong> Azure Account </strong>。确保变量名为<strong> Azure </strong>，因为步骤模板在项目变量中搜索变量名为<strong> Azure </strong>的变量。</li>
<li>选择有权部署资源的Azure帐户。</li>
<li>保存变量。</li>
</ol>

<h3 id="add-a-deploy-a-package-step">添加部署包步骤</h3>

<ol>
<li>从您的项目中选择<strong>流程</strong>并点击<strong>添加步骤</strong>。</li>
<li>选择<strong>包</strong>，然后选择<strong>部署包</strong>。</li>
<li>点击<strong>配置功能</strong>，选择<strong>自定义安装目录</strong>。</li>
<li>取消勾选<strong>。净配置变量</strong>和<strong>。网络配置转换</strong>并点击<strong>确定</strong>。</li>
<li>指定名称、目标角色和包详细信息。确保包细节指向GitHub提要和存储Pulumi Azure项目的repo。</li>
<li>对于自定义安装目录，选择Pulumi Azure代码将驻留的位置。这也是Pulumi步骤创建Azure资源组的地方。</li>
<li>保存该步骤。</li>
</ol>

<h3 id="add-a-run-pulumi-linux-step">添加一个运行Pulumi (Linux)步骤</h3>

<ol>
<li><p>从您的项目中，选择<strong>流程</strong>并点击<strong>添加步骤</strong>。</p>
</li>
<li><p>选择<strong> <span class="path">社区步骤➜ Pulumi ➜运行Pulumi (Linux) </span> </strong>并安装该步骤。</p>
</li>
<li><p>指定名称和目标角色。</p>
</li>
<li><p>为运行Pulumi (Linux)步骤模板添加参数:</p>
<ul>
<li><strong>栈名</strong>:Pulumi中项目的全称，使用以下格式:<code>OrganizationName/ProjectName/StackName</code>。比如我的是<code>AdminTurnedDevOps/azure-go-new-resource-group/dev</code>。您可以在Pulumi门户中找到您的堆栈名称的信息。</li>
<li><strong>创建堆栈</strong>:您可以忽略此选项，因为堆栈已经存在。</li>
<li><strong>命令</strong>:普鲁米有几个命令，但是你只需要<code>pulumi up</code>。不必键入完整的命令，只需键入<code>up</code>。</li>
<li><strong>命令参数</strong>:命令参数<code>--yes</code>是必需的。例如，当您从命令行运行Pulumi时，有一个创建资源的选项。两个选项是<code>yes</code>或<code>no</code>。因为我们在步骤模板中没有这些弹出窗口，所以我们使用了<code>--yes</code>标志。</li>
<li><strong> Pulumi访问令牌</strong>:这是一个API密钥，可以在Pulumi门户的设置下生成。</li>
<li><strong> Pulumi工作目录</strong>:工作目录是您从<strong> Deploy a Package </strong>步骤复制代码的地方。</li>
<li><strong>恢复依赖关系</strong>:该步骤用于NodeJS恢复依赖关系。您没有使用NodeJS，所以取消选中该框。</li>
</ul>
</li>
<li><p>完成后，保存该步骤。</p>
</li>
</ol>

<h2 id="deploying-the-code">部署代码</h2>

<p>现在是时候创建一个新版本，并运行持续部署过程，使用Pulumi和Octopus Deploy创建一个新的Azure资源组。</p>

<ol>
<li>在Octopus项目中，点击<strong>创建发布</strong>。</li>
<li>点击<strong>保存</strong>。</li>
<li>通过点击<strong>部署到</strong>并选择环境，部署到您选择的环境。</li>
<li>点击<strong>展开</strong>。</li>
</ol>

<p>现在，您已经使用Octopus Deploy和Pulumi成功地创建了一个Azure资源组。</p>

<h2 id="conclusion">结论</h2>

<p>将Octopus Deploy和Pulumi等工具结合起来，您可以从开始到结束自动执行整个工作流程，而无需手动流程。</p>

<h2 id="watch-the-webinar">观看网络研讨会</h2>

<iframe src="https://www.youtube.com/embed/SA3-efF5PWk" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen="">VIDEO</iframe>

<p>我们定期举办网络研讨会。请参见<a href="https://octopus.com/events">网络研讨会第</a>页，了解以往网络研讨会的档案以及即将举办的网络研讨会的详细信息。</p>

<p>愉快的部署！</p>

                    
                    
</body>
</html>