<html>
<head>
<title>PowerShell and IIS: 20 practical examples - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>PowerShellå’ŒIIS: 20ä¸ªå®ä¾‹- Octopuséƒ¨ç½²</h1>
<blockquote>åŸæ–‡ï¼š<a href="https://octopus.com/blog/iis-powershell#2021-07-07">https://octopus.com/blog/iis-powershell#2021-07-07</a></blockquote>
                        <p>åœ¨Octopus Deployï¼Œæˆ‘ä»¬ç”¨IISåšäº†å¤§é‡å·¥ä½œã€‚å¦‚æœæŠŠæˆ‘ä»¬æ‰€æœ‰å®¢æˆ·çš„éƒ¨ç½²é¥æµ‹æ•°æ®åŠ èµ·æ¥ï¼Œæˆ‘ä»¬å·²ç»å®Œæˆäº†è¶…è¿‡ä¸€ç™¾ä¸‡ä¸ªç½‘ç«™å’ŒæœåŠ¡çš„éƒ¨ç½²ã€‚åœ¨è¿™ä¸€è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å­¦åˆ°äº†å¾ˆå¤šä¸œè¥¿ï¼ŒåŒ…æ‹¬å¦‚ä½•ä½¿ç”¨PowerShell IISæ¨¡å—ï¼Œå®ƒä»¬å¦‚ä½•åœ¨å¹•åå·¥ä½œï¼Œä»¥åŠå¦‚ä½•å¯é åœ°ä½¿ç”¨å®ƒä»¬ã€‚æˆ‘åœ¨è¿™ç¯‡æ–‡ç« ä¸­çš„ç›®æ ‡æ˜¯åˆ†äº«è¿™äº›çŸ¥è¯†ï¼Œå¹¶å»ºç«‹ä¸€ä¸ªå•ä¸€çš„åœ°æ–¹ï¼Œå½“äººä»¬éœ€è¦ä½¿ç”¨PowerShell IISæ¨¡å—æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºä»–ä»¬æŒ‡æ˜æ–¹å‘ã€‚</p>

<p>è¿™ç¯‡æ–‡ç« åŒ…æ‹¬:</p>

<ul>
<li><code>applicationHost.config</code>æ–‡ä»¶å’ŒIISé…ç½®çš„å·¥ä½œåŸç†ã€‚</li>
<li>Windows Server 2016/Windows 10ä¸­å¼•å…¥çš„æ–°<code>IISAdministration</code> PowerShellæ¨¡å—ã€‚</li>
<li>è‡ªWindows 2008ä»¥æ¥ä½¿ç”¨çš„è¾ƒæ—§çš„<code>WebAdministration</code> PowerShellæ¨¡å—ã€‚</li>
<li>æˆ‘ä»¬ä»æ•°ç™¾ä¸‡ä¸ªä½¿ç”¨PowerShell IISæ¨¡å—çš„å®é™…éƒ¨ç½²ä¸­å­¦åˆ°äº†ä»€ä¹ˆã€‚</li>
<li>å¾ˆå¤šå¾ˆå¤šå®é™…ä¾‹å­ï¼Œ2008-2016å¹´åœ¨æ‰€æœ‰Windows Server OSä¸Šæµ‹è¯•ï¼Œè¿˜æœ‰å…³äºNano Serverçš„ä¿¡æ¯ã€‚</li>
</ul>

<p>æ‰€æœ‰è¿™äº›ä¾‹å­çš„æºä»£ç éƒ½å­˜åœ¨äºä¸€ä¸ª<a href="https://github.com/OctopusDeploy/PowerShell-IIS-Examples" rel="nofollow"> GitHubåº“</a>ä¸­ï¼Œæˆ‘ä»¬åœ¨è¿è¡Œä¸åŒç‰ˆæœ¬Windows Server OSçš„æµ‹è¯•æœºå™¨ä¸Šè‡ªåŠ¨è¿è¡Œè¿™äº›ä¾‹å­ï¼Œæ‰€ä»¥æˆ‘å¯¹å®ƒä»¬çš„å·¥ä½œç›¸å½“æœ‰ä¿¡å¿ƒã€‚å½“ç„¶ï¼Œå¦‚æœæ‚¨é‡åˆ°ä»»ä½•éº»çƒ¦ï¼Œå¯ä»¥åœ¨GitHubåº“çš„é—®é¢˜åˆ—è¡¨ä¸­å‘å¸ƒé—®é¢˜ï¼Œæˆ–è€…å‘æˆ‘ä»¬å‘é€è¯·æ±‚ï¼ğŸ˜„</p>

<p>åœ¨æˆ‘ä»¬è¿›å…¥å®é™…ä¾‹å­ä¹‹å‰ï¼Œè¿™ç¯‡æ–‡ç« çš„å¼€å¤´æœ‰ç›¸å½“å¤šçš„ç†è®ºã€‚æœ‰å¾ˆå¤šç½‘ç«™å±•ç¤ºäº†å¦‚ä½•å®ŒæˆåŸºæœ¬çš„IISä»»åŠ¡ï¼›åœ¨è¿™ç¯‡æ–‡ç« çš„ç»“å°¾ï¼Œæˆ‘çš„ç›®æ ‡æ˜¯<strong>è®©ä½ æˆä¸ºè‡ªåŠ¨åŒ–IISé…ç½®çš„ä¸“å®¶</strong>å¹¶ä¸”ä¾‹å­æŠŠå®ƒæ”¾åˆ°äº†ä¸Šä¸‹æ–‡ä¸­ã€‚</p>



<h2 id="how-iis-configuration-is-stored">å¦‚ä½•å­˜å‚¨IISé…ç½®</h2>

<p>å¦‚æœä½ æ‰“å¼€<strong> IISç®¡ç†å™¨</strong>ç”¨æˆ·ç•Œé¢ï¼Œæµè§ˆä»»ä½•ç½‘ç«™æˆ–åº”ç”¨ç¨‹åºæ± ï¼Œä½ ä¼šå‘ç°ä½ å¯ä»¥è°ƒæ•´çš„æ—‹é’®å’Œåˆ»åº¦ç›˜å¹¶ä¸çŸ­ç¼ºã€‚æœ‰æˆåƒä¸Šä¸‡ç§å¯èƒ½çš„è®¾ç½®ï¼Œä»ä½¿ç”¨ä»€ä¹ˆæ ·çš„èº«ä»½éªŒè¯æ–¹æ³•ï¼Œåˆ°åº”è¯¥å¦‚ä½•ç¼–å†™æ—¥å¿—æ–‡ä»¶ï¼Œåˆ°è¿è¡Œæ‚¨çš„è¿›ç¨‹çš„åº”ç”¨ç¨‹åºæ± åº”è¯¥å¤šä¹…å›æ”¶ä¸€æ¬¡ã€‚</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2017-03/iis-powershell-iis-manager.png" class="zoom" data-title=""><img src="../Images/c59dbb924484c041d37a5608a3413247.png" class="img-fluid center" alt="IIS Manager, the main user interface for graphical management of IIS" data-original-src="https://i.octopus.com/blog/2017-03/iis-powershell-iis-manager.png"/>T2ã€‘</a></p>

<p>æ‰€æœ‰è¿™äº›è®¾ç½®éƒ½åœ¨å“ªé‡Œï¼Ÿ</p>

<p>è‡ªIIS 7 (Windows 2008)ä»¥æ¥ï¼Œå‡ ä¹æ‰€æœ‰è¿™äº›è®¾ç½®éƒ½ä½äºä»¥ä¸‹ä¸¤ä¸ªä½ç½®ä¹‹ä¸€:</p>

<ul>
<li>ä¸åº”ç”¨ç¨‹åºä¸€èµ·éƒ¨ç½²çš„<code>web.config</code>æ–‡ä»¶ã€‚</li>
<li>ä¸€ä¸ª<code>applicationHost.config</code>æ–‡ä»¶ï¼Œå®ƒæ˜¯æœåŠ¡å™¨èŒƒå›´çš„ã€‚</li>
</ul>

<p>å¦‚æœä½ æ˜¯ä¸€ä¸ªASP.NETå¼€å‘è€…ï¼Œä½ è‚¯å®šå¯¹<code>web.config</code>æ–‡ä»¶å¾ˆç†Ÿæ‚‰ï¼Œä½†æ˜¯ä½ å¯èƒ½ä»¥å‰æ²¡è§è¿‡<code>applicationHost.config</code>ã€‚æ‚¨é€šå¸¸ä¼šåœ¨ä»¥ä¸‹ä½ç½®æ‰¾åˆ°å®ƒ:</p>

<pre><code>C:\Windows\System32\inetsrv\config\applicationHost.config
</code></pre>

<p>å¦‚æœæ‚¨ä½¿ç”¨IISï¼Œå€¼å¾—èŠ±æ—¶é—´ä»”ç»†æŸ¥çœ‹ä¸€ä¸‹è¿™ä¸ªæ–‡ä»¶ï¼Œå› ä¸ºæ‚¨ä¼šå‘ç°å„ç§æœ‰è¶£çš„è®¾ç½®ã€‚ä¾‹å¦‚ï¼Œä¸‹é¢æ˜¯å¦‚ä½•å®šä¹‰åº”ç”¨ç¨‹åºæ± çš„:</p>

<pre><code class="language-xml">&lt;configuration&gt;
    &lt;!-- snip --&gt;
    &lt;system.applicationHost&gt;
        &lt;!-- snip --&gt;
        &lt;applicationPools&gt;
            &lt;add name="DefaultAppPool" managedRuntimeVersion="v4.0" /&gt;
            &lt;add name=".NET v2.0 Classic" managedRuntimeVersion="v2.0" managedPipelineMode="Classic" /&gt;
            &lt;add name=".NET v2.0" managedRuntimeVersion="v2.0" /&gt;
            &lt;add name=".NET v4.5 Classic" managedRuntimeVersion="v4.0" managedPipelineMode="Classic" /&gt;
            &lt;add name=".NET v4.5" managedRuntimeVersion="v4.0" /&gt;
            &lt;add name="OctoFX AppPool" autoStart="false" startMode="AlwaysRunning"&gt;
                &lt;processModel identityType="LocalSystem" /&gt;
            &lt;/add&gt;
</code></pre>

<p>å’Œç½‘ç«™:</p>

<pre><code class="language-xml">&lt;configuration&gt;
    &lt;!-- snip --&gt;
    &lt;system.applicationHost&gt;
        &lt;!-- snip --&gt;
        &lt;sites&gt;
            &lt;site name="Default Web Site" id="1"&gt;
                &lt;application path="/" applicationPool="Default Web Site"&gt;
                    &lt;virtualDirectory path="/" physicalPath="C:\inetpub\wwwroot" /&gt;
                &lt;/application&gt;
                &lt;bindings&gt;
                    &lt;binding protocol="http" bindingInformation="*:80:" /&gt;
                &lt;/bindings&gt;
            &lt;/site&gt;
</code></pre>

<p>ä¸ºä»€ä¹ˆç†Ÿæ‚‰<code>applicationHost.config</code>æ–‡ä»¶å¾ˆé‡è¦ï¼Ÿå—¯ï¼Œå½’ç»“èµ·æ¥å°±æ˜¯:</p>

<blockquote class="blockquote">
<p>æˆ‘ä»¬ä¸‹é¢è®¨è®ºçš„æ‰€æœ‰IISçš„PowerShellæ¨¡å—éƒ½åªæ˜¯ç”¨äºç¼–è¾‘è¿™ä¸ªå¤§XMLæ–‡ä»¶çš„åŒ…è£…å™¨ã€‚</p>
</blockquote>

<p>å¦‚æœæ‚¨ç†è§£äº†è¿™ä¸€ç‚¹ï¼Œæ‚¨ä¼šå‘ç°ç†è§£PowerShell IISæ¨¡å—çš„å·¥ä½œæ–¹å¼ä¼šå®¹æ˜“å¾—å¤šï¼Œå¹¶ä¸”æ‚¨å°†èƒ½å¤Ÿè§£å†³å¦‚ä½•é…ç½®ä¸æ˜æ˜¾çš„è®¾ç½®ã€‚</p>

<h2 id="iis-powershell-modules-and-os-versions">IIS PowerShellæ¨¡å—å’Œæ“ä½œç³»ç»Ÿç‰ˆæœ¬</h2>

<p>IISåœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šä¾èµ–äºWindowså†…æ ¸æä¾›çš„æœåŠ¡ï¼Œå› æ­¤IISçš„æ¯ä¸ªç‰ˆæœ¬éƒ½ä¸Windowsçš„ä¸€ä¸ªç‰ˆæœ¬ç›¸ç»“åˆã€‚å› ä¸ºIISçš„æ¯ä¸ªç‰ˆæœ¬éƒ½å¸¦æ¥äº†æ–°çš„ç‰¹æ€§ï¼Œæ‰€ä»¥åœ¨æä¾›PowerShellæ¨¡å—æ–¹é¢æœ‰ä¸åŒçš„å°è¯•ã€‚ä¸‹è¡¨æ¦‚è¿°äº†è¿™äº›ç»„åˆä¸­çš„æ¯ä¸€ç§:</p>

<table class="table">
<thead>
<tr>
<th>æ“ä½œç³»ç»Ÿ</th>
<th>IISç‰ˆæœ¬</th>
<th>PowerShellæ¨¡å—</th>
</tr>
</thead>
<tbody>
<tr>
<td>Windows Server 2008</td>
<td>ä¸ƒ</td>
<td><code>Add-PsSnapIn WebAdministration</code></td>
</tr>
<tr>
<td>Windows Server 2008 R2ç‰ˆ</td>
<td>7.5</td>
<td><code>Import-Module WebAdministration</code></td>
</tr>
<tr>
<td>Windows Server 2012</td>
<td>8</td>
<td><code>Import-Module WebAdministration</code></td>
</tr>
<tr>
<td>Windows Server 2012 R2ç‰ˆ</td>
<td>8.5</td>
<td><code>Import-Module WebAdministration</code></td>
</tr>
<tr>
<td>Windows Server 2016</td>
<td>10</td>
<td><code>Import-Module WebAdministration</code>æˆ–<br/>æˆ–<code>Import-Module IISAdministration</code></td>
</tr>
<tr>
<td>Windows Server 2016 - Nano</td>
<td>10</td>
<td><code>Import-Module IISAdministration</code></td>
</tr>
</tbody>
</table>

<p>è®©æˆ‘ä»¬å¿«é€Ÿæµè§ˆä¸€ä¸‹å†å²ã€‚</p>

<h3 id="iis-7-and-the-webadministration-snapin">IIS 7å’Œwebç®¡ç†â€œç®¡ç†å•å…ƒâ€</h3>

<p>IIS 6æ”¯æŒè¿è¡ŒASP.NETåº”ç”¨ç¨‹åºï¼Œä½†å®ƒæ˜¯åœ¨éæ‰˜ç®¡(éã€‚NET)ä»£ç ï¼Œæ‰€æœ‰æ¨¡å—å’Œæ‰©å±•éƒ½æ˜¯éæ‰˜ç®¡çš„ã€‚IIS 7æ˜¯IISæ”¯æŒçš„ç¬¬ä¸€ä¸ªç‰ˆæœ¬ã€‚NETæ¨¡å—å’Œæ–°çš„é›†æˆç®¡é“æ¨¡å¼ã€‚Windows Server 2008é™„å¸¦äº†IIS 7ï¼Œä½†æ˜¯PowerShellæ˜¯å¦‚ä½•å®‰è£…çš„ï¼Ÿ</p>

<p>PowerShell 1.0ä½¿ç”¨äº†SnapIns ( <strong>æ¨¡å—</strong>åœ¨PowerShell 2.0ä¸­å¼•å…¥)ï¼Œä½†æ˜¯å¤§éƒ¨åˆ†æ”¯æŒçš„å‘½ä»¤ä¸åæ¥çš„æ¨¡å—ç‰ˆæœ¬ä¸­ä½¿ç”¨çš„å‘½ä»¤ç›¸åŒã€‚åœ¨Windows 2008(R2ä¹‹å‰)ä¸Šï¼Œæ‚¨å¯ä»¥åŠ è½½PowerShell IISæ”¯æŒ:</p>

<pre><code class="language-powershell">Add-PsSnapIn WebAdministration
# Use commands like: Get-Website, New-Website, New-WebAppPool
</code></pre>

<p>æ›´å¤æ‚çš„æ˜¯ï¼ŒPowerShell 2.0å¯ä»¥åœ¨Windows Server 2008ä¸Šå‡çº§ï¼Œä½†PowerShell IISæ¨¡å—ä¸èƒ½ï¼Œæ‚¨ä»ç„¶éœ€è¦ä½¿ç”¨ç®¡ç†å•å…ƒã€‚</p>

<h3 id="iis-7.5-and-the-webadministration-module">IIS 7.5+å’Œwebç®¡ç†æ¨¡å—</h3>

<p>Windows Server 2008 R2äº2011å¹´å‘å¸ƒï¼ŒåŒ…å«PowerShell 2.0 <strong> FC </strong>ï¼Œè¿™æ„å‘³ç€IISå‘½ä»¤ç°åœ¨å¯ä»¥ä½œä¸ºä¸€ä¸ªæ¨¡å—ä½¿ç”¨ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åŠ è½½å®ƒä»¬:</p>

<pre><code class="language-powershell">Import-Module WebAdministration
# Use commands like: Get-Website, New-Website, New-WebAppPool
</code></pre>

<h3 id="iis-10-and-the-iisadministration-module">IIS 10å’ŒIISAdministrationæ¨¡å—</h3>

<p>Windows Server 2016/Windows 10è‡ªå¸¦çš„IIS 10ä¸ºä½ æä¾›äº†ä¸¤ç§é€‰æ‹©ã€‚æ‚¨å¯ä»¥ç»§ç»­ä½¿ç”¨æ—§æ¨¡å—:</p>

<pre><code class="language-powershell">Import-Module WebAdministration
# Use commands like: Get-Website, New-Website, New-WebAppPool - same as before
</code></pre>

<p>æˆ–è€…æ‚¨å¯ä»¥ä½¿ç”¨<a href="https://www.iis.net/learn/get-started/whats-new-in-iis-10/iisadministration-powershell-cmdlets" rel="nofollow">å…¨æ–°çš„</a> <code>IISAdministration</code>æ¨¡å—:</p>

<pre><code class="language-powershell">Import-Module IISAdministration 
# Use commands like: Get-IISSite, New-IISSite, New-IISAppPool
</code></pre>

<p>ä¸ºä»€ä¹ˆè¦æ”¹å˜ï¼Ÿä¸‹å›¾è§£é‡Šäº†æ¯ä¸ªæ¨¡å—æ˜¯å¦‚ä½•æ„å»ºçš„ã€‚</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2017-03/iis-powershell-architecture.png" class="zoom" data-title=""><img src="../Images/4e59c0d7c1cf4bb1873998637f8e3cef.png" class="img-fluid center" alt="Diagram of the PowerShell IIS module architecture choices in Windows Server 2016" data-original-src="https://i.octopus.com/blog/2017-03/iis-powershell-architecture.png"/>T2ã€‘</a></p>

<p>å½“IIS 7å‘å¸ƒæ—¶ï¼Œä¸ºäº†æ›´å®¹æ˜“åœ°ä»æ‰˜ç®¡ä»£ç ä¸­ä½¿ç”¨<code>applicationHost.config</code>ï¼Œå¾®è½¯åˆ›å»ºäº†ä¸€ä¸ªåä¸º<code>Microsoft.Web.Administration.dll</code>çš„. NETåº“ã€‚ä½ å¯ä»¥åœ¨GACä¸­æ‰¾åˆ°å®ƒï¼Œä½ å¯ä»¥ä»C#ä»£ç ä¸­å¼•ç”¨å®ƒå¹¶<a href="https://www.iis.net/learn/manage/scripting/how-to-use-microsoftwebadministration" rel="nofollow">ä½¿ç”¨å®ƒ:</a></p>

<pre><code class="language-csharp">using (var manager = new ServerManager())
{
    foreach (var site in manager.Sites)
    {
        Console.WriteLine("Site: " + site.Name);
    }
}
</code></pre>

<p>å¦‚æœæ‚¨æµè§ˆç±»åº“æ–‡æ¡£ï¼Œæ‚¨ä¼šå‘ç°å®ƒå¾ˆå¤§ç¨‹åº¦ä¸Šæ˜¯XMLé…ç½®æ–‡ä»¶çš„åŒ…è£…ã€‚ä¾‹å¦‚ï¼Œ<code>Application</code>ç±»ç»§æ‰¿è‡ª<code>ConfigurationElement</code>åŸºç±»ã€‚</p>

<p>å‡ºäºæŸç§åŸå› ï¼Œ<code>WebAdministration</code> PowerShellæ¨¡å—ä»æœªç›´æ¥æ„å»ºåœ¨è¿™ä¸ªç±»åº“ä¹‹ä¸Šï¼Œè€Œæ˜¯å¤åˆ¶äº†å®ƒçš„å¤§éƒ¨åˆ†ã€‚å½“ä½ åœ¨åç¼–è¯‘å™¨ä¸­è§‚å¯Ÿå®ƒæ—¶ï¼Œè¿™ç§é‡å¤æ˜¯éå¸¸æ˜æ˜¾çš„ã€‚</p>

<p>æœ‰äº†æ–°çš„<code>IISAdministration</code>æ¨¡å—ï¼Œå¾®è½¯åŸºæœ¬ä¸Šå·²ç»:</p>

<ul>
<li>åœ¨<code>Microsoft.Web.Administration</code> DLLçš„åŸºç¡€ä¸Šé‡æ–°æ„å»ºå®ƒ</li>
<li>å·²åˆ é™¤<code>IIS:\</code>é©±åŠ¨å™¨PowerShellæä¾›ç¨‹åºã€‚</li>
<li>åˆ›å»ºäº†æ–°çš„<code>IIS*</code>cmdletï¼Œæä¾›äº†è¿›å…¥<code>Microsoft.Web.Administration</code>ç±»çš„â€œè·³è½¬ç‚¹â€ã€‚</li>
</ul>

<p>ä½œä¸ºç”¨æˆ·ï¼Œ<code>IISAdministration</code>ç‰ˆæœ¬çš„æ¨¡å—æœ‰ä¸€ä¸ªå¾ˆå¤§çš„ä¼˜åŠ¿ï¼›å‘½ä»¤è¿”å›çš„ç±»å‹æ›´åŠ æœ‰ç”¨ã€‚è™½ç„¶å®ƒä»¬ä»ç„¶æ˜¯XMLåŒ…è£…å™¨ï¼Œä½†æ˜¯å®ƒä»¬ç”¨æœ‰ç”¨çš„å±æ€§å’Œæ–¹æ³•è¿›è¡Œäº†ä¿®é¥°ï¼Œä½¿å¾—å¯¹è±¡æ›´åŠ å¯ç”¨ï¼Œè€Œä¸ä¾èµ–äºå‘½ä»¤:</p>

<pre><code class="language-powershell">Import-Module IISAdministration
$site = Get-IISSite -Name "Default Web Site"
$site.ServerAutoStart = $true   # Make the website start when the server starts
$site.Applications.Count        # How many applications belong to the site?
$site.Bindings[0].Protocol      # Get the protocol (HTTP/HTTPS) of the first binding
</code></pre>

<p>å¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯æ—§çš„<code>WebAdministration</code>ï¼Œé‚£ä¹ˆæ‚¨å‡ ä¹å¿…é¡»ä½¿ç”¨PowerShell CmdLetsæˆ–é‡‡ç”¨XMLæ¥åšæ‰€æœ‰äº‹æƒ…ã€‚ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œæ²¡æœ‰åŠæ³•ä»<code>Get-Website</code>è¿”å›çš„ç«™ç‚¹å¯¼èˆªåˆ°å®ƒçš„åº”ç”¨ç¨‹åºã€‚è¿™ä¸ªæ–°æ¨¡å—åœ¨PowerShellç®¡é“ä¸­ä¹Ÿèƒ½æ›´å¥½åœ°å·¥ä½œã€‚</p>

<p>æ€»çš„æ¥è¯´ï¼Œè™½ç„¶æˆ‘è®¤ä¸ºå¾®è½¯åœ¨æ–°æ¨¡å—ä¸­çš„é‡æ„æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ä¸¾æªï¼Œä½†æˆ‘å¸Œæœ›å®ƒä¸æ˜¯ä¸€ä¸ªçªç ´æ€§çš„å˜åŒ–ã€‚æˆ‘å¯ä»¥æƒ³è±¡è¿™ç®€åŒ–äº†ä»–ä»¬çš„ç»´æŠ¤ï¼Œä½†ä»–ä»¬æ²¡æœ‰æ„å»ºä¸€æµçš„PowerShell/IISä½“éªŒï¼Œè€Œæ˜¯æ„å»ºäº†ä¸€äº›è¿”å›çš„cmdletsã€‚NETå¯¹è±¡ï¼Œç„¶åå¯¹å®ƒä»¬è¿›è¡Œæ ‡å‡†çš„æ–¹æ³•è°ƒç”¨ã€‚</p>

<h3 id="nano-server-broke-everything">çº³ç±³æœåŠ¡å™¨æ‰“ç ´äº†ä¸€åˆ‡ï¼</h3>

<p>ä¹Ÿè®¸è¿™æœ‰ç‚¹è‹›åˆ»ï¼Œä½†ä¹Ÿæœ‰ä¸€å®šçš„é“ç†ã€‚äº‹æƒ…æ˜¯è¿™æ ·çš„:</p>

<ol>
<li>Nano Serveræ˜¯ä¸€ä¸ªéå¸¸ç²¾ç®€çš„Windowsç‰ˆæœ¬ï¼Œè®¾è®¡ç”¨äºå®¹å™¨æˆ–ä½œä¸ºVMï¼›å°±æ˜¯å‡ ç™¾MBï¼Œç¬é—´å¼€æœºã€‚æˆ‘å¯¹æ­¤éå¸¸å…´å¥‹ã€‚</li>
<li>NanoæœåŠ¡å™¨æ— æ³•å®Œå…¨è¿è¡Œã€‚NETæ¡†æ¶ï¼Œå®ƒåªèƒ½è¿è¡Œã€‚ç½‘èŠ¯ã€‚</li>
<li>PowerShellæ„å»ºäºã€‚NETæ¡†æ¶ã€‚</li>
<li>ä¸ºäº†èƒ½å¤Ÿåœ¨NanoæœåŠ¡å™¨(å’ŒLinuxï¼)ï¼Œä»–ä»¬åœ¨ä¸Šé‡å»ºäº†PowerShellã€‚ç½‘èŠ¯ã€‚</li>
<li>æ—§çš„<code>WebAdministration</code>æ¨¡å—ä¹Ÿéœ€è¦å®Œæ•´çš„ã€‚NETæ¡†æ¶ã€‚ä»–ä»¬å°†ä¸€ä¸ªç‰ˆæœ¬çš„<code>Microsoft.Web.Administration.dll</code>ç§»æ¤åˆ°ã€‚NET Core(æ¯•ç«Ÿï¼Œå®ƒåªæ˜¯ä¸€ä¸ªå¤§çš„XMLåŒ…è£…å™¨)æ‰€ä»¥<code>IISAdministration</code>æ¨¡å—å¯ä»¥å·¥ä½œï¼Œä½†æ˜¯ä»–ä»¬ä»æ¥æ²¡æœ‰ç§»æ¤è¿‡<code>WebAdministration</code>æ¨¡å—ã€‚</li>
<li>å¾®è½¯æ²¡æœ‰å°†WebAdministrationç§»æ¤åˆ°NanoæœåŠ¡å™¨çš„è®¡åˆ’ã€‚</li>
</ol>

<p>è¿™æ„å‘³ç€å¦‚æœä½ çš„è„šæœ¬éœ€è¦åœ¨NanoæœåŠ¡å™¨ä¸Šè¿è¡Œï¼Œä½ åªèƒ½ä½¿ç”¨<code>IISAdministration</code>æ¨¡å—ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“å¹¶å–œæ¬¢çš„æ—§çš„<code>WebAdministration</code>æ¨¡å—ä¸å†å·¥ä½œäº†ã€‚</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2017-03/iis-powershell-nano.png" class="zoom" data-title=""><img src="../Images/cbbb88b4aa214cc510a92b8856dacae3.png" class="img-fluid center" alt="Nano Server supports IISAdministration, but not WebAdministration" data-original-src="https://i.octopus.com/blog/2017-03/iis-powershell-nano.png"/>T2ã€‘</a></p>

<h3 id="writing-scripts-that-run-on-multiple-oss">ç¼–å†™åœ¨å¤šç§æ“ä½œç³»ç»Ÿä¸Šè¿è¡Œçš„è„šæœ¬</h3>

<p>åœ¨Octopusï¼Œæˆ‘ä»¬éƒ¨ç½²IISç½‘ç«™çš„ä»£ç å¿…é¡»æ”¯æŒæ‰€æœ‰è¿™äº›æ“ä½œç³»ç»Ÿã€‚æˆ‘ä»¬å‘ç°çš„åŠ è½½<code>WebAdministration</code>æ¨¡å—çš„æœ€ç®€å•å’Œæœ€å¯é çš„æ–¹æ³•æ˜¯ï¼Œä¸ç®¡ä½ ä½¿ç”¨çš„æ˜¯ä»€ä¹ˆæ“ä½œç³»ç»Ÿ:</p>

<pre><code class="language-powershell">Add-PSSnapin WebAdministration -ErrorAction SilentlyContinue
Import-Module WebAdministration -ErrorAction SilentlyContinue
# Use commands like: Get-Website, New-Website, New-WebAppPool
</code></pre>

<p>å¦‚æœä½ æƒ³ç¡®å®šä½ å·²ç»åŠ è½½äº†è‡³å°‘ä¸€ä¸ªæ¨¡å—(IISå¯èƒ½æ²¡æœ‰å®‰è£…)ï¼Œä½ å¯ä»¥<a href="https://github.com/OctopusDeploy/Calamari/blob/master/source/Calamari/Scripts/Octopus.Features.IISWebSite_BeforePostDeploy.ps1#L33-L45" rel="nofollow">çœ‹çœ‹æˆ‘ä»¬åœ¨Octopus </a>ä¸­æ˜¯æ€ä¹ˆåšçš„ã€‚</p>

<p>ä»¥è¿™ç§æ–¹å¼ç¼–å†™çš„è„šæœ¬åº”è¯¥å¯ä»¥åœ¨æ“ä½œç³»ç»Ÿä¹‹é—´ç§»æ¤ï¼Œé™¤éä½ åœ¨NanoæœåŠ¡å™¨ä¸Šè¿è¡Œå®ƒã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨éœ€è¦ä½¿ç”¨æ–°æ¨¡å—ï¼Œè€Œä¸æ˜¯<code>IIS*</code>cmdletã€‚</p>

<h2 id="recap-iis-theory">é‡è¿°IISç†è®º</h2>

<h3 id="sites-applications-and-virtual-directories">ç«™ç‚¹ã€åº”ç”¨ç¨‹åºå’Œè™šæ‹Ÿç›®å½•</h3>

<p>æˆ‘ä»¬å°†åœ¨è¿™ç¯‡æ–‡ç« ä¸­å¤§é‡ä½¿ç”¨è¿™äº›æœ¯è¯­ï¼Œæ‰€ä»¥æˆ‘è®¤ä¸ºæœ‰å¿…è¦ç¨å¾®å›é¡¾ä¸€ä¸‹ã€‚è®©æˆ‘ä»¬çœ‹çœ‹è¿™ä¸ªIISæœåŠ¡å™¨:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2017-03/iis-powershell-sites-apps-vdirs.png" class="zoom" data-title=""><img src="../Images/720a471f5e161a200ab372dfa8c38a70.png" class="img-fluid center" alt="IIS server with many sites, applications, and virtual directories" data-original-src="https://i.octopus.com/blog/2017-03/iis-powershell-sites-apps-vdirs.png"/>T2ã€‘</a></p>

<p>è¿™é‡Œæˆ‘ä»¬æœ‰ä¸€ä¸ªIISæœåŠ¡å™¨ï¼Œå®ƒæœåŠ¡äºå¤šä¸ª<strong>ç½‘ç«™</strong>(ç½‘ç«™1å’Œç½‘ç«™2)ã€‚æ¯ä¸ªç½‘ç«™éƒ½æœ‰ç»‘å®šï¼ŒæŒ‡å®šå®ƒç›‘å¬çš„åè®®(HTTP/HTTPSï¼Œæœ‰æ—¶æ˜¯å…¶ä»–)ã€ç«¯å£(80/443/å…¶ä»–)å’Œä¸»æœºå¤´ã€‚</p>

<p>Website2è¿˜æœ‰å¾ˆå¤š<strong>åº”ç”¨</strong> (App1ï¼ŒApp1.1ï¼ŒApp1.2ï¼ŒApp2)å’Œ<strong>è™šæ‹Ÿç›®å½•</strong> (App.1.1.vdir1ï¼Œvdir1ï¼ŒVdir1.1ï¼ŒVdir2)ã€‚</p>

<p>ä¸è¦è®©IISç®¡ç†å™¨çš„æˆªå›¾æ¬ºéª—äº†ä½ ã€‚åœ¨å¹•åï¼ŒIISå¯¹è¿™äº›ç«™ç‚¹ã€åº”ç”¨ç¨‹åºå’Œè™šæ‹Ÿç›®å½•ä¹‹é—´çš„å…³ç³»æœ‰ç€å®Œå…¨ä¸åŒçš„çœ‹æ³•ã€‚æ¥è‡ª<a href="https://www.iis.net/learn/get-started/planning-your-iis-architecture/understanding-sites-applications-and-virtual-directories-on-iis" rel="nofollow">IISå›¢é˜Ÿ</a>:</p>

<blockquote class="blockquote">
<p>ç®€è€Œè¨€ä¹‹ï¼Œç«™ç‚¹åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªåº”ç”¨ç¨‹åºï¼Œåº”ç”¨ç¨‹åºåŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªè™šæ‹Ÿç›®å½•ï¼Œè™šæ‹Ÿç›®å½•æ˜ å°„åˆ°è®¡ç®—æœºä¸Šçš„ç‰©ç†ç›®å½•ã€‚</p>
</blockquote>

<p>è¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ¥ç†è§£ï¼Œä½†è¿™å¾ˆé‡è¦ã€‚IISç®¡ç†å™¨æ˜¾ç¤ºäº†ä¸Šé¢çš„æ ‘ï¼Œå› ä¸ºè¿™æ˜¯ç”¨æˆ·è€ƒè™‘ä»–ä»¬çš„ç«™ç‚¹ã€åº”ç”¨ç¨‹åºå’Œvdirsçš„æ–¹å¼ï¼Œä½†ä¸‹é¢æ˜¯IIS <em>å®é™…ä¸Š</em>å¦‚ä½•å¯¹æ•°æ®å»ºæ¨¡:</p>

<ul>
<li>ç«™ç‚¹:<strong>ç½‘ç«™1 </strong></li>
<li>ç½‘ç«™:<strong>ç½‘ç«™2 </strong>          <ul>
<li>åº”ç”¨:<strong> / </strong>          <ul>
<li>è™šæ‹Ÿç›®å½•:<strong> / </strong></li>
<li>è™šæ‹Ÿç›®å½•:<strong> /Vdir1 </strong></li>
<li>è™šæ‹Ÿç›®å½•:<strong> /Vdir1/Vdir1.1 </strong></li>
<li>è™šæ‹Ÿç›®å½•:<strong> /Vdir2 </strong></li>
</ul>
</li>
<li>åº”ç”¨:<strong> /App1 </strong></li>
<li>åº”ç”¨:<strong> /App1/App1.1 </strong>          <ul>
<li>è™šæ‹Ÿç›®å½•:<strong> / </strong></li>
<li>è™šæ‹Ÿç›®å½•:<strong> /App1.1.vdir1 </strong></li>
</ul>
</li>
<li>åº”ç”¨:<strong> /App1/App1.1/App1.2 </strong></li>
<li>åº”ç”¨:<strong> /App2 </strong></li>
<li>åº”ç”¨:<strong> /Vdir1/Vdir1ã€‚é™„å½•3 </strong></li>
</ul>
</li>
</ul>

<p>è¿™æ˜¯å¾®è½¯çš„å¯¹è±¡æ¨¡å‹ã€‚ç½‘ç»œç®¡ç†ã€‚NETç¨‹åºé›†æä¾›çš„æ¨¡å‹ï¼Œä½†å®ƒä¹Ÿæ˜¯XMLåœ¨<code>applicationHost.config</code>ä¸­ä½¿ç”¨çš„æ¨¡å‹:</p>

<pre><code class="language-xml">&lt;sites&gt;
    &lt;site name="Website2" id="2"&gt;
        &lt;application path="/" applicationPool="MyAppPool"&gt;
            &lt;virtualDirectory path="/" physicalPath="..." /&gt;
            &lt;virtualDirectory path="/Vdir1" physicalPath="..." /&gt;
            &lt;virtualDirectory path="/Vdir1/Vdir1.1" physicalPath="..." /&gt;
            &lt;virtualDirectory path="/Vdir2" physicalPath="..." /&gt;
        &lt;/application&gt;
        &lt;application path="/App1" applicationPool="MyAppPool"&gt;
            &lt;virtualDirectory path="/" physicalPath="..." /&gt;
        &lt;/application&gt;
        &lt;application path="/App1/App1.1" applicationPool="MyAppPool"&gt;
            &lt;virtualDirectory path="/" physicalPath="..." /&gt;
            &lt;virtualDirectory path="/App1.1.vdir1" physicalPath="..." /&gt;
        &lt;/application&gt;
        &lt;application path="/App1/App1.1/App1.2" applicationPool="MyAppPool"&gt;
            &lt;virtualDirectory path="/" physicalPath="..." /&gt;
        &lt;/application&gt;
        &lt;application path="/App2" applicationPool="MyAppPool"&gt;
            &lt;virtualDirectory path="/" physicalPath="..." /&gt;
        &lt;/application&gt;
        &lt;application path="/Vdir1/Vdir1.App3" applicationPool="MyAppPool"&gt;
            &lt;virtualDirectory path="/" physicalPath="..." /&gt;
        &lt;/application&gt;
        ...
</code></pre>

<p>ä¸€äº›æ³¨æ„äº‹é¡¹:</p>

<ul>
<li>åœ¨IISä¸­ï¼Œå¯¹è±¡æ¨¡å‹å¹¶ä¸åƒIISç®¡ç†å™¨ä¸­çš„æ ‘é‚£æ ·ç–¯ç‹‚ã€‚ç½‘ç«™æœ‰åº”ç”¨ç¨‹åºã€‚åº”ç”¨ç¨‹åºæœ‰è™šæ‹Ÿç›®å½•ã€‚å°±æ˜¯è¿™æ ·ã€‚é€šè¿‡å­˜å‚¨è·¯å¾„æ¥æ¨¡æ‹Ÿæ·±åº¦åµŒå¥—çš„å…³ç³»ã€‚</li>
<li>å°½ç®¡IISç®¡ç†å™¨æ˜¾ç¤ºVDir1å†…éƒ¨æœ‰ä¸€ä¸ªåº”ç”¨ç¨‹åºï¼Œä½†å®é™…ä¸Šè¯¥åº”ç”¨ç¨‹åºå±äºè¯¥ç«™ç‚¹ã€‚</li>
<li>Website1åªæ˜¯ä¸€ä¸ªç«™ç‚¹ï¼Œæ²¡æœ‰ä»»ä½•åº”ç”¨ç¨‹åºæˆ–è™šæ‹Ÿç›®å½•ï¼Œä½†è¿™åªæ˜¯IISç®¡ç†å™¨è®©æˆ‘ä»¬çš„ç”Ÿæ´»åˆå˜å¾—ç®€å•äº†ã€‚å®é™…ä¸Šæœ‰ä¸€ä¸ªåº”ç”¨ç¨‹åºå’Œä¸€ä¸ªè™šæ‹Ÿç›®å½•ï¼Œå®ƒä»¬åªæ˜¯ä½¿ç”¨â€œ/â€ä½œä¸ºè·¯å¾„ã€‚</li>
<li>æ‰€æœ‰è¿™äº›ä¸œè¥¿çš„ç‰©ç†è·¯å¾„å®é™…ä¸Šæ˜¯ç”±è™šæ‹Ÿç›®å½•å®šä¹‰çš„ã€‚</li>
</ul>

<p>web administrationPowerShellæ¨¡å—å®é™…ä¸Šåšäº†ç›¸å½“å¤§çš„åŠªåŠ›æ¥éšè—è¿™ä¸€ç‚¹ï¼Œæ‚¨å¯ä»¥åƒIIS Managerä¸€æ ·å¯¼èˆªIISã€‚ä½†æ˜¯æ–°çš„<strong> IISAdministration </strong>æ¨¡å—æ”¾å¼ƒäº†è¿™ä¸ªæ¼æ´ç™¾å‡ºçš„æŠ½è±¡ï¼Œä»¥è¿™ç§æ–¹å¼å‘ä½ å±•ç¤ºä¸–ç•Œã€‚</p>

<h3 id="location-sections">ä½ç½®éƒ¨åˆ†</h3>

<p>IISé…ç½®çš„ä¸€ä¸ªä»¤äººå›°æƒ‘çš„è¡Œä¸ºæ˜¯ï¼Œå½“æ‚¨åœ¨IISç®¡ç†å™¨ä¸­è¿›è¡Œæ›´æ”¹æ—¶ï¼Œä¸åŒçš„è®¾ç½®ä¼šå­˜å‚¨åœ¨ä¸åŒçš„ä½ç½®:</p>

<ul>
<li>åœ¨ä¸Šé¢æ˜¾ç¤ºçš„<code>&lt;sites&gt;</code>å…ƒç´ ä¸­ã€‚</li>
<li>åœ¨applicationHost.configçš„<code>&lt;location&gt;</code>éƒ¨åˆ†ä¸­</li>
<li>åœ¨æ‚¨è‡ªå·±çš„web.configæ–‡ä»¶ä¸­ã€‚</li>
</ul>

<p>ä¾‹å¦‚ï¼Œå½“ä½ æ”¹å˜ä¸€ä¸ªç½‘ç«™çš„ç‰©ç†è·¯å¾„æˆ–ç»‘å®šæ—¶ï¼Œå®ƒä¼šå­˜å‚¨åœ¨<code>&lt;sites&gt;</code>ä¸­ã€‚</p>

<p>å½“ä½ æ”¹å˜è®¾ç½®ï¼Œæ¯”å¦‚æ˜¯å¦å¯ç”¨ç›®å½•æµè§ˆï¼Œè¿™å°†è¿›å…¥è™šæ‹Ÿç›®å½•çš„ç‰©ç†è·¯å¾„ä¸­çš„<code>web.config</code>æ–‡ä»¶(è®°ä½ï¼Œç½‘ç«™å’Œåº”ç”¨éƒ½æœ‰è™šæ‹Ÿç›®å½•ï¼).</p>

<p>å½“æ‚¨æ›´æ”¹èº«ä»½éªŒè¯æ¨¡å¼(åŒ¿åã€åŸºæœ¬ã€Windowsç­‰)æ—¶ã€‚)åº”è¯¥é€‚ç”¨ï¼Œè¿™æ˜¯å†™åœ¨<code>applicationHost.config</code>åº•éƒ¨çš„<code>&lt;location&gt;</code>éƒ¨åˆ†:</p>

<pre><code class="language-xml">&lt;location path="Website2/Vdir1"&gt;
    &lt;system.webServer&gt;
        &lt;security&gt;
            &lt;authentication&gt;
                &lt;anonymousAuthentication enabled="false" /&gt;
            &lt;/authentication&gt;
        &lt;/security&gt;
    &lt;/system.webServer&gt;
&lt;/location&gt; 
</code></pre>

<p>ä¼¼ä¹é€‚ç”¨çš„è§„åˆ™æ˜¯:</p>

<ol>
<li>å¦‚æœå®ƒæ˜¯ä¸€ä¸ªè®¾ç½®ï¼Œåº”è¯¥æ˜¯å®ƒæ‰€åº”ç”¨çš„ä¸œè¥¿çš„æœ¬åœ°è®¾ç½®ï¼Œå®ƒè¢«å­˜å‚¨åœ¨ã€‚ä¾‹å¦‚ï¼Œå½“æˆ‘æ›´æ”¹<strong>ç½‘ç«™2 </strong>çš„åº”ç”¨ç¨‹åºæ± æ—¶ï¼Œæˆ‘ä¸å¸Œæœ›å®ƒä¹Ÿæ›´æ”¹åˆ†é…ç»™å…¶ä¸­åº”ç”¨ç¨‹åºçš„åº”ç”¨ç¨‹åºæ± ã€‚</li>
<li>å¦‚æœè¿™æ˜¯ä¸€ä¸ªåº”ç”¨ç¨‹åºå¼€å‘äººå‘˜å¯èƒ½æƒ³è¦è‡ªå·±è®¾ç½®çš„è®¾ç½®ï¼Œå®ƒä¼šè½¬åˆ°web.configã€‚</li>
<li>å¦‚æœè¿™æ˜¯ä¸€ä¸ªç”±IISç®¡ç†å‘˜è®¾ç½®çš„è®¾ç½®ï¼Œè€Œä¸æ˜¯ç”±åº”ç”¨ç¨‹åºå¼€å‘äººå‘˜è®¾ç½®çš„ï¼Œä½†è¿™æ˜¯ä»–ä»¬æœŸæœ›<em>æ²¿ç€è·¯å¾„</em>ç»§æ‰¿çš„ä¸œè¥¿ï¼Œé‚£ä¹ˆå°±ç”¨<code>applicationHost.config</code>ä¸­çš„<code>&lt;location&gt;</code>æ¥è®¾ç½®ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘åœ¨æ ¹ç½‘ç«™ç¦ç”¨åŒ¿åèº«ä»½éªŒè¯ï¼Œæˆ‘å¸Œæœ›è¿™é€‚ç”¨äºå®ƒä¸‹é¢çš„æ‰€æœ‰å†…å®¹ã€‚å¦‚æœæˆ‘ä¸ºä¸€ä¸ªè™šæ‹Ÿç›®å½•é‡æ–°å¯ç”¨å®ƒï¼Œæˆ‘å¸Œæœ›è¯¥è·¯å¾„ä¸‹çš„å…¶ä»–åº”ç”¨ç¨‹åºå’Œè™šæ‹Ÿç›®å½•ç»§æ‰¿æ–°å€¼ã€‚</li>
</ol>

<p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œä½ å®é™…ä¸Šå¯¹è§„åˆ™#3æœ‰ä¸€äº›æ§åˆ¶ã€‚IIS <em>é”å®š</em>æŸäº›è®¾ç½®ï¼Œä¾‹å¦‚è®¤è¯è®¾ç½®ï¼Œè¿™æ ·å®ƒä»¬å°±ä¸ä¼šè¢«æ¶æ„çš„åº”ç”¨ç¨‹åºå¼€å‘è€…è¦†ç›–ã€‚ä½†æ˜¯ä½ å¯ä»¥è‡ªå·±è§£é”å®ƒä»¬ï¼Œå…è®¸å•ä¸ªåº”ç”¨ç¨‹åºåœ¨è‡ªå·±çš„web.configæ–‡ä»¶ä¸­è¦†ç›–å®ƒä»¬ã€‚</p>

<p>æœ€ç®€å•çš„æ–¹æ³•æ˜¯åœ¨IISç®¡ç†å™¨ä¸­è¿›è¡Œæ›´æ”¹ï¼Œç„¶åæŸ¥çœ‹æ˜¯applicationHost.configè¿˜æ˜¯æ‚¨çš„web.configå‘ç”Ÿäº†æ›´æ”¹ã€‚</p>

<h2 id="iis-drive-provider-vs.cmdlets">IIS:\é©±åŠ¨å™¨æä¾›ç¨‹åºä¸CmdLets</h2>

<p>ä½¿ç”¨PowerShell IISæ¨¡å—æœ‰ä¸¤ç§å—æ”¯æŒçš„èŒƒä¾‹:</p>

<ul>
<li><code>IIS:\</code>é©±åŠ¨PowerShellæä¾›ç¨‹åºï¼Œå®ƒè®©æ‚¨å¯ä»¥åƒä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿä¸€æ ·ä½¿ç”¨IISã€‚</li>
<li>åŸºäºä»»åŠ¡çš„åŠ©æ‰‹cmdletsï¼Œå¦‚<code>New-Website</code>ã€‚</li>
</ul>

<p>äº‹å®ä¸Šï¼Œå¦‚æœæ‚¨åç¼–è¯‘cmdletï¼Œå¤§å¤šæ•°cmdletå®é™…ä¸Šéƒ½åŒ…è£…äº†IISé©±åŠ¨æ–¹æ³•ã€‚å½“æ‚¨è°ƒç”¨<code>New-Website</code>æ—¶ï¼Œcmdletå®é™…ä¸Šä¼šè¿™æ ·åš:</p>

<pre><code class="language-powershell"># When you call this
New-Website -Name "MySite" -Port 8080 -PhysicalPath "C:\Test"

# It actually generates and calls:
New-Item -Path "IIS:\Sites\MySite" -Type Site -Bindings @{protocol="http";bindingInformation="*:8080:"}
Set-ItemProperty -Path "IIS:\Sites\MySite" -name PhysicalPath -value "C:\Test"
</code></pre>

<p>åœ¨Octopusï¼Œæˆ‘ä»¬å‘ç°è™½ç„¶æˆ‘ä»¬ç»å¸¸ä»cmdletæ–¹æ³•å¼€å§‹ï¼Œä½†æˆ‘ä»¬çš„è„šæœ¬é€šå¸¸éƒ½è½¬å‘ä½¿ç”¨<code>IIS</code> driveæ–¹æ³•ï¼Œå› ä¸ºå®ƒå…è®¸æ›´é«˜çº§çš„è®¾ç½®ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆä¸‹é¢æ˜¾ç¤ºçš„å¤§å¤šæ•°ä¾‹å­ä½¿ç”¨è¿™ç§æ–¹æ³•ã€‚</p>

<p>æ³¨æ„ï¼Œ<code>IIS:\</code>é©±åŠ¨æ–¹æ³•æ˜¯ä¸è¢«IISAdministration æ¨¡å—æ”¯æŒçš„<strong>ï¼Œå®ƒå®é™…ä¸Šå·²ç»è¿‡æ—¶äº†ã€‚</strong></p>

<h2 id="retry-retry-retry">é‡è¯•ï¼Œé‡è¯•ï¼Œé‡è¯•</h2>

<p>æ­£å¦‚æˆ‘å·²ç»è®¨è®ºè¿‡çš„ï¼Œæ‰€æœ‰çš„PowerShell IISæ¨¡å—å®é™…ä¸Šåªæ˜¯XMLæ–‡ä»¶çš„åŒ…è£…å™¨ã€‚å¹¶ä¸”å½“å¤šä¸ªè¿›ç¨‹è¯»å†™æ–‡ä»¶æ—¶ï¼Œæ–‡ä»¶ä¸ä¼šåšå¾—å¾ˆå¥½ã€‚å„ç§ä¸œè¥¿å¯ä»¥é”å®šæ–‡ä»¶ï¼Œç—…æ¯’æ‰«æç¨‹åºï¼Œå¤‡ä»½è§£å†³æ–¹æ¡ˆï¼ŒIISé‡å¯ï¼Œæœ‰äººä½¿ç”¨IISç®¡ç†å™¨ç”¨æˆ·ç•Œé¢ã€‚åœ¨Octopusçš„ä¸€æ®µæ—¶é—´é‡Œï¼Œæˆ‘ä»¬æœ€æŒä¹…çš„æ”¯æŒé—®é¢˜ä¹‹ä¸€æ˜¯å½“æ–‡ä»¶è¢«é”å®šæ—¶å‡ºç°çš„é—®é¢˜ã€‚</p>

<p>å®é™…ä¸Šï¼Œåœ¨æ•°ç™¾ä¸‡å®¢æˆ·éƒ¨ç½²ä¸­ï¼Œå”¯ä¸€å¯é åœ°ä¸ºæˆ‘ä»¬å·¥ä½œçš„è§£å†³æ–¹æ¡ˆâ€”â€”å¹¶ä¸”æ‘†è„±äº†æ”¯æŒæŠ•è¯‰â€”â€”æ˜¯é‡è¯•ã€‚å¾ˆå¤šã€‚æˆ‘ä»¬æ˜¯è¿™æ ·åšçš„ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå¯ä»¥é‡è¯•æ‰§è¡ŒPowerShellå—çš„å‡½æ•°:</p>

<pre><code class="language-powershell">function Execute-WithRetry([ScriptBlock] $command) {
    $attemptCount = 0
    $operationIncomplete = $true
    $maxFailures = 5

    while ($operationIncomplete -and $attemptCount -lt $maxFailures) {
        $attemptCount = ($attemptCount + 1)

        if ($attemptCount -ge 2) {
            Write-Host "Waiting for $sleepBetweenFailures seconds before retrying..."
            Start-Sleep -s $sleepBetweenFailures
            Write-Host "Retrying..."
        }

        try {
            # Call the script block
            &amp; $command

            $operationIncomplete = $false
        } catch [System.Exception] {
            if ($attemptCount -lt ($maxFailures)) {
                Write-Host ("Attempt $attemptCount of $maxFailures failed: " + $_.Exception.Message)
            } else {
                throw
            }
        }
    }
}
</code></pre>

<p>ç„¶åï¼Œæˆ‘ä»¬ä½¿ç”¨IISæ‰§è¡Œçš„æ¯ä¸ªæ“ä½œéƒ½åŒ…å«åœ¨è¿™ä¸ªå‡½æ•°ä¸­:</p>

<pre><code class="language-powershell"># Start App Pool
Execute-WithRetry { 
    $state = Get-WebAppPoolState $applicationPoolName
    if ($state.Value -eq "Stopped") {
        Write-Host "Application pool is stopped. Attempting to start..."
        Start-WebAppPool $applicationPoolName
    }
}
</code></pre>

<h2 id="examples">ä¾‹å­</h2>

<p>è¿™ç¯‡æ–‡ç« çš„å…¶ä½™éƒ¨åˆ†å°†ç”¨æ¥å±•ç¤ºå¤§é‡å¦‚ä½•ä½¿ç”¨PowerShell IISæ¨¡å—çš„çœŸå®ä¾‹å­ã€‚</p>

<h3 id="creating-sites-simple">åˆ›å»ºç«™ç‚¹(ç®€å•)</h3>


 
 
  
<pre><code class="language-powershell">Import-Module WebAdministration

New-Website -Name "Website1" -Port 80 -IPAddress "*" -HostHeader "" -PhysicalPath "C:\Sites\Website1"
</code></pre>
  
  
<pre><code class="language-powershell">Import-Module IISAdministration

New-IISSite -Name "Website1" -BindingInformation "*:80:" -PhysicalPath "C:\Sites\Website1"

# Examples of -BindingInformation:
#    "*:80:"                - Listens on port 80, any IP address, any hostname
#    "10.0.0.1:80:"         - Listens on port 80, specific IP address, any host
#    "*:80:myhost.com"      - Listens on port 80, specific hostname
</code></pre>
  
 


<h3 id="creating-sites-advanced">åˆ›å»ºç½‘ç«™(é«˜çº§)</h3>

<p>æœ€æœ‰å¯èƒ½çš„æ˜¯ï¼Œå½“ä½ åˆ›å»ºä¸€ä¸ªçœŸå®çš„ç«™ç‚¹æ—¶ï¼Œä½ ä¼šæƒ³è¦æŒ‡å®šä¸€äº›é¢å¤–çš„è®¾ç½®ã€‚ä¸ºæ­¤ï¼Œæ‚¨å¯ä»¥åœ¨åˆ›å»ºç«™ç‚¹åè·å–å®ƒï¼Œå¹¶æ·»åŠ é¢å¤–çš„è®¾ç½®ã€‚ç”±äºæˆ‘ä»¬æ­£åœ¨è¿›è¡Œå¤šé¡¹æ›´æ”¹ï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨å»¶è¿Ÿæäº¤å°†å®ƒä»¬ä¸€æ¬¡æ€§å†™å…¥applicationHost.configã€‚</p>

<p>è¿™é‡Œæˆ‘ä»¬å°†æ·»åŠ ä¸€ä¸ªé¢å¤–çš„ç»‘å®šï¼Œå¹¶è®¾ç½®ç«™ç‚¹ID:</p>


 
 
  
<pre><code class="language-powershell">Import-Module WebAdministration

New-Item -Path "IIS:\Sites" -Name "Website1" -Type Site -Bindings @{protocol="http";bindingInformation="*:8021:"}
Set-ItemProperty -Path "IIS:\Sites\Website1" -name "physicalPath" -value "C:\Sites\Website1"
Set-ItemProperty -Path "IIS:\Sites\Website1" -Name "id" -Value 4
New-ItemProperty -Path "IIS:\Sites\Website1" -Name "bindings" -Value (@{protocol="http";bindingInformation="*:8022:"}, @{protocol="http";bindingInformation="*:8023:"})

Start-Website -Name "Website1"
</code></pre>
  
  
<pre><code class="language-powershell">Import-Module IISAdministration

$manager = Get-IISServerManager
$site = $manager.Sites.Add("Website1", "http", "*:8022:", "C:\Sites\Website1")
$site.Id = 4
$site.Bindings.Add("*:8023:", "http")
$site.Bindings.Add("*:8024:", "http")
$manager.CommitChanges()
</code></pre>
  
 


<h3 id="creating-applications-in-virtual-directories">åœ¨è™šæ‹Ÿç›®å½•ä¸­åˆ›å»ºåº”ç”¨ç¨‹åº</h3>

<p>å¤§å¤šæ•°æ—¶å€™ï¼Œå½“äººä»¬æƒ³åˆ°å°†ä¸€ä¸ª. NETåº”ç”¨ç¨‹åºéƒ¨ç½²åˆ°ä¸€ä¸ª<em>è™šæ‹Ÿç›®å½•</em>æ—¶ï¼Œä»–ä»¬æŒ‡çš„æ˜¯åœ¨ä¸€ä¸ªç½‘ç«™ä¸‹é¢åˆ›å»ºä¸€ä¸ª<em>åº”ç”¨ç¨‹åº</em>ã€‚ä¸‹é¢çš„ä¾‹å­åˆ›å»ºäº†ä¸€ä¸ªå¯ä»¥åœ¨<code>http://site/MyApp</code>çœ‹åˆ°çš„åº”ç”¨ç¨‹åºã€‚æˆ‘ä»¬è¿˜åˆ†é…äº†ä¸€ä¸ªåº”ç”¨ç¨‹åºæ± :</p>


 
 
  
<pre><code class="language-powershell">Import-Module WebAdministration

New-Item -Type Application -Path "IIS:\Sites\Website1\MyApp" -physicalPath "C:\Sites\MyApp"
</code></pre>
  
  
<pre><code class="language-powershell">Import-Module IISAdministration

$manager = Get-IISServerManager
$app = $manager.Sites["Website1"].Applications.Add("/MyApp", "C:\Sites\MyApp")
$manager.CommitChanges()
</code></pre>
  
 


<h3 id="creating-application-pools">åˆ›å»ºåº”ç”¨ç¨‹åºæ± </h3>

<p>æ‚¨éœ€è¦å°†æ¯ä¸ªåº”ç”¨ç¨‹åº(ç½‘ç«™æˆ–è™šæ‹Ÿç›®å½•ä¸­çš„åº”ç”¨ç¨‹åº)åˆ†é…åˆ°ä¸€ä¸ª<em>åº”ç”¨ç¨‹åºæ± </em>ã€‚åº”ç”¨ç¨‹åºæ± å®šä¹‰äº†å¤„ç†åº”ç”¨ç¨‹åºè¯·æ±‚çš„å¯æ‰§è¡Œè¿›ç¨‹ã€‚</p>

<p>IISé™„å¸¦äº†ä¸€äº›å·²ç»ä¸ºå…¬å…±é€‰é¡¹å®šä¹‰çš„åº”ç”¨ç¨‹åºæ± ï¼Œä½†æ˜¯æˆ‘æ€»æ˜¯å»ºè®®ä¸ºæ‚¨éƒ¨ç½²çš„æ¯ä¸ªç½‘ç«™æˆ–åº”ç”¨ç¨‹åºåˆ›å»ºæ‚¨è‡ªå·±çš„åº”ç”¨ç¨‹åºæ± ã€‚è¿™æä¾›äº†åº”ç”¨ç¨‹åºä¹‹é—´çš„è¿›ç¨‹çº§éš”ç¦»ï¼Œå¹¶å…è®¸æ‚¨å›´ç»•æ¯ä¸ªåº”ç”¨ç¨‹åºå¯ä»¥åšä»€ä¹ˆæ¥è®¾ç½®ä¸åŒçš„æƒé™ã€‚ä¸‹é¢çš„ç¤ºä¾‹æ˜¾ç¤ºäº†è®¸å¤šå¸¸è§çš„åº”ç”¨ç¨‹åºæ± è®¾ç½®ã€‚å¯¹äºIISç®¡ç†æ¨¡å—ï¼Œæ²¡æœ‰å†…ç½®çš„CmdLetsæ¥åˆ›å»ºåº”ç”¨ç¨‹åºæ± ï¼Œæ‰€ä»¥æ‚¨å¿…é¡»ç›´æ¥ä½¿ç”¨<code>ServerManager</code>å¯¹è±¡æ¥åˆ›å»º:</p>


 
 
  
<pre><code class="language-powershell">Import-Module WebAdministration

New-Item -Path "IIS:\AppPools" -Name "My Pool" -Type AppPool

# What version of the .NET runtime to use. Valid options are "v2.0" and
# "v4.0". IIS Manager often presents them as ".NET 4.5", but these still
# use the .NET 4.0 runtime so should use "v4.0". For a "No Managed Code"
# equivalent, pass an empty string.
Set-ItemProperty -Path "IIS:\AppPools\My Pool" -name "managedRuntimeVersion" -value "v4.0"

# If your ASP.NET app must run as a 32-bit process even on 64-bit machines
# set this to $true. This is usually only important if your app depends
# on some unmanaged (non-.NET) DLL's.
Set-ItemProperty -Path "IIS:\AppPools\My Pool" -name "enable32BitAppOnWin64" -value $false

# Starts the application pool automatically when a request is made. If you
# set this to false, you have to manually start the application pool or
# you will get 503 errors.
Set-ItemProperty -Path "IIS:\AppPools\My Pool" -name "autoStart" -value $true

# What account does the application pool run as?
# "ApplicationPoolIdentity" = best
# "LocalSysten" = bad idea!
# "NetworkService" = not so bad
# "SpecificUser" = useful if the user needs special rights. See other examples
# below for how to do this.
Set-ItemProperty -Path "IIS:\AppPools\My Pool" -name "processModel" -value @{identitytype="ApplicationPoolIdentity"}

# Older applications may require "Classic" mode, but most modern ASP.NET
# apps use the integrated pipeline.
#
# On newer versions of PowerShell, setting the managedPipelineMode is easy -
# just use a string:
#
#   Set-ItemProperty -Path "IIS:\AppPools\My Pool 3" `
#      -name "managedPipelineMode" `
#      -value "Integrated"
#
# However, the combination of PowerShell and the IIS module in Windows
# Server 2008 and 2008 R2 requires you to specify the value as an integer.
#
#  0 = Integrated
#  1 = Classic
#
# If you hate hard-coding magic numbers you can do this (or use the string
# if 2008 support isn't an issue for you):
#  
#   Add-Type -Path "${env:SystemRoot}\System32\inetsrv\Microsoft.Web.Administration.dll"
#   $pipelineMode = [Microsoft.Web.Administration.ManagedPipelineMode]::Integrated
#   Set-ItemProperty -Path "..." -name "managedPipelineMode" -value ([int]$pipelineMode)
#
# If this DLL doesn't exist, you'll need to install the IIS Management
# Console role service.
Set-ItemProperty -Path "IIS:\AppPools\My Pool" -name "managedPipelineMode" -value 0

# This setting was added in IIS 8. It's different to autoStart (which means
# "start the app pool when a request is made") in that it lets you keep
# an app pool running at all times even when there are no requests.
# Since it was added in IIS 8 you may need to check the OS version before
# trying to set it.
#
# "AlwaysRunning" = application pool loads when Windows starts, stays running
# even when the application/site is idle.
# "OnDemand" = IIS starts it when needed. If there are no requests, it may
# never be started.
if ([Environment]::OSVersion.Version -ge (new-object 'Version' 6,2)) {
    Set-ItemProperty -Path "IIS:\AppPools\My Pool" -name "startMode" -value "OnDemand"
}
</code></pre>
  
  
<pre><code class="language-powershell">Import-Module IISAdministration

$manager = Get-IISServerManager
$pool = $manager.ApplicationPools.Add("My Pool")

# Older applications may require "Classic" mode, but most modern ASP.NET
# apps use the integrated pipeline
$pool.ManagedPipelineMode = "Integrated"

# What version of the .NET runtime to use. Valid options are "v2.0" and
# "v4.0". IIS Manager often presents them as ".NET 4.5", but these still
# use the .NET 4.0 runtime so should use "v4.0". For a "No Managed Code"
# equivalent, pass an empty string.
$pool.ManagedRuntimeVersion = "v4.0"

# If your ASP.NET app must run as a 32-bit process even on 64-bit machines
# set this to $true. This is usually only important if your app depends
# on some unmanaged (non-.NET) DLL's.
$pool.Enable32BitAppOnWin64 = $false

# Starts the application pool automatically when a request is made. If you
# set this to false, you have to manually start the application pool or
# you will get 503 errors.
$pool.AutoStart = $true

# "AlwaysRunning" = application pool loads when Windows starts, stays running
# even when the application/site is idle.
# "OnDemand" = IIS starts it when needed. If there are no requests, it may
# never be started.
$pool.StartMode = "OnDemand"

# What account does the application pool run as?
# "ApplicationPoolIdentity" = best
# "LocalSysten" = bad idea!
# "NetworkService" = not so bad
# "SpecificUser" = useful if the user needs special rights
$pool.ProcessModel.IdentityType = "ApplicationPoolIdentity"

$manager.CommitChanges()
</code></pre>
  
 


<h3 id="assigning-application-pools">åˆ†é…åº”ç”¨ç¨‹åºæ± </h3>

<p>ä¸€æ—¦å®šä¹‰äº†åº”ç”¨ç¨‹åºæ± ï¼Œå°±å¿…é¡»å‘å…¶åˆ†é…åº”ç”¨ç¨‹åºã€‚ä»¥ä¸‹ç¤ºä¾‹æ˜¾ç¤ºäº†å¦‚ä½•å°†è™šæ‹Ÿç›®å½•ä¸­çš„ç½‘ç«™æˆ–åº”ç”¨ç¨‹åºåˆ†é…åˆ°æ–°çš„åº”ç”¨ç¨‹åºæ± :</p>


 
 
  
<pre><code class="language-powershell">Import-Module WebAdministration

# Assign the application pool to a website
Set-ItemProperty -Path "IIS:\Sites\Website1" -name "applicationPool" -value "My Pool"

# Assign the application pool to an application in a virtual directory
Set-ItemProperty -Path "IIS:\Sites\Website1\MyApp" -name "applicationPool" -value "My Pool"
</code></pre>
  
  
<pre><code class="language-powershell">Import-Module IISAdministration

$manager = Get-IISServerManager

# Assign to a website
$website = $manager.Sites["Website1"]
$website.Applications["/"].ApplicationPoolName = "My Pool"

# Assign to an application in a virtual directory
$website = $manager.Sites["Website1"]
$website.Applications["/MyApp"].ApplicationPoolName = "My Pool"

$manager.CommitChanges()
</code></pre>
  
 


<h3 id="check-whether-sites-virtual-directories-or-application-pools-already-exist">æ£€æŸ¥ç«™ç‚¹ã€è™šæ‹Ÿç›®å½•æˆ–åº”ç”¨ç¨‹åºæ± æ˜¯å¦å·²ç»å­˜åœ¨</h3>

<p>åœ¨é¡¹ç›®è¿‡ç¨‹ä¸­ï¼Œæ‚¨å°†å¤šæ¬¡å°†åº”ç”¨ç¨‹åºé‡æ–°éƒ¨ç½²åˆ°IISï¼Œå› æ­¤æ‚¨ä¸èƒ½å‡è®¾è„šæœ¬æ˜¯ç¬¬ä¸€æ¬¡è¿è¡Œã€‚ä»¥ä¸‹ç¤ºä¾‹æ˜¾ç¤ºäº†åœ¨è¿›è¡Œæ›´æ”¹ä¹‹å‰æ£€æŸ¥ç«™ç‚¹ã€åº”ç”¨ç¨‹åºæˆ–åº”ç”¨ç¨‹åºæ± æ˜¯å¦å·²ç»å­˜åœ¨çš„æ¨¡å¼:</p>


 
 
  
<pre><code class="language-powershell">Import-Module WebAdministration

# The pattern here is to use Test-Path with the IIS:\ drive provider

if ((Test-Path "IIS:\AppPools\My Pool") -eq $False) {
    # Application pool does not exist, create it...
    # ...
}

if ((Test-Path "IIS:\Sites\Website1") -eq $False) {
    # Site does not exist, create it...
    # ...
}

if ((Test-Path "IIS:\Sites\Website1\MyApp") -eq $False) {
    # App/virtual directory does not exist, create it...
    # ...
}
</code></pre>
  
  
<pre><code class="language-powershell">Import-Module IISAdministration

$manager = Get-IISServerManager

# The pattern here is to get the things you want, then check if they are null

if ($manager.ApplicationPools["My Pool"] -eq $null) {
    # Application pool does not exist, create it...
    # ...
}

if ($manager.Sites["Website1"] -eq $null) {
    # Site does not exist, create it...
    # ...
}

if ($manager.Sites["Website1"].Applications["/MyApp"] -eq $null) {
    # App/virtual directory does not exist, create it...
    # ...
}

$manager.CommitChanges()
</code></pre>
  
 


<h3 id="change-physical-path-of-a-site-or-application">æ›´æ”¹ç«™ç‚¹æˆ–åº”ç”¨ç¨‹åºçš„ç‰©ç†è·¯å¾„</h3>

<p>å½“éƒ¨ç½²ä¸€ä¸ªåº”ç”¨ç¨‹åºçš„æ–°ç‰ˆæœ¬æ—¶ï¼Œæˆ‘çš„åå¥½(ä»¥åŠOctopus Deployçš„å·¥ä½œæ–¹å¼)æ˜¯éƒ¨ç½²åˆ°ç£ç›˜ä¸Šä¸€ä¸ªå…¨æ–°çš„æ–°æ–‡ä»¶å¤¹ï¼Œç„¶åæ›´æ–°IISä»¥æŒ‡å‘å®ƒã€‚æ‰€ä»¥ä½ ä»:</p>

<pre><code>C:\Sites\Website1\1.0   &lt;--- IIS points here
</code></pre>

<p>æ‚¨éƒ¨ç½²æ–°ç‰ˆæœ¬:</p>

<pre><code>C:\Sites\Website1\1.0   &lt;--- IIS points here
C:\Sites\Website1\1.1
</code></pre>

<p>ç„¶åï¼Œæ‚¨å¯ä»¥å¯¹é…ç½®æ–‡ä»¶ç­‰è¿›è¡Œä»»ä½•å¿…è¦çš„æ›´æ”¹ã€‚ç„¶åæ›´æ–°IISä»¥æŒ‡å‘å®ƒ:</p>

<pre><code>C:\Sites\Website1\1.0
C:\Sites\Website1\1.1   &lt;--- Now IIS points here
</code></pre>

<p>å¦‚æœæ‚¨éœ€è¦å¿«é€Ÿå›æ»šï¼Œæ‚¨å¯ä»¥å°†æ—§æ–‡ä»¶å¤¹ç•™åœ¨ç£ç›˜ä¸Šï¼Œå¹¶æŒ‡å‘å®ƒ:</p>

<pre><code>C:\Sites\Website1\1.0   &lt;--- IIS points here (we rolled back manually)
C:\Sites\Website1\1.1   
</code></pre>


 
 
  
<pre><code class="language-powershell">Import-Module WebAdministration

# The pattern here is to use Test-Path with the IIS:\ drive provider

Set-ItemProperty -Path "IIS:\Sites\Website1" -name "physicalPath" -value "C:\Sites\Website1\1.1"
Set-ItemProperty -Path "IIS:\Sites\Website1\MyApp" -name "physicalPath" -value "C:\Sites\Website1\1.1"
</code></pre>
  
  
<pre><code class="language-powershell">Import-Module IISAdministration

$manager = Get-IISServerManager

# Remember, in the IIS Administration view of the world, sites contain
# applications, and applications contain virtual directories, and it is
# virtual directories that point at a physical path on disk.

# Change for a top-level website
$manager.Sites["Website1"].Applications["/"].VirtualDirectories["/"].PhysicalPath = "C:\Sites\Website1\1.1"

# Change for an app within a website
$manager.Sites["Website1"].Applications["/MyApp"].VirtualDirectories["/"].PhysicalPath = "C:\Sites\Website1\1.1"

$manager.CommitChanges()
</code></pre>
  
 


<h3 id="changing-authentication-methods">æ›´æ”¹èº«ä»½éªŒè¯æ–¹æ³•</h3>

<p>IISæ”¯æŒå¤šç§èº«ä»½éªŒè¯æ–¹æ³•ã€‚å¦‚ä¸Šæ‰€è¿°ï¼Œé»˜è®¤æƒ…å†µä¸‹è¿™äº›<em>è¢«é”å®š</em>åˆ°<code>applicationHost.config</code>ï¼Œå¦‚æœæ‚¨æƒ³è¦è‡ªåŠ¨å¯ç”¨å®ƒä»¬ï¼Œä¸‹é¢çš„ç¤ºä¾‹æ˜¾ç¤ºäº†å¦‚ä½•å¯ç”¨/ç¦ç”¨:</p>

<ul>
<li>åŒ¿åè®¤è¯</li>
<li>åŸºæœ¬è®¤è¯</li>
<li>æ‘˜è¦è®¤è¯</li>
<li>Windowsèº«ä»½éªŒè¯</li>
</ul>

<p>IISç®¡ç†å™¨è¿˜å°†<code>ASP.NET impersonation</code>å’Œ<code>Forms authentication</code>æ˜¾ç¤ºä¸ºåŒä¸€çº§åˆ«çš„è®¾ç½®ï¼Œä½†è¿™äº›å®é™…ä¸Šæ˜¯åœ¨ä½ çš„åº”ç”¨ç¨‹åºçš„<code>web.config</code>æ–‡ä»¶ä¸­è®¾ç½®çš„ï¼Œæ‰€ä»¥æˆ‘åœ¨è¿™é‡Œçœç•¥äº†å®ƒä»¬:</p>


 
 
  
<pre><code class="language-powershell">Import-Module WebAdministration

# The pattern here is to use Test-Path with the IIS:\ drive provider.

Set-WebConfigurationProperty `
    -Filter "/system.webServer/security/authentication/windowsAuthentication" `
    -Name "enabled" `
    -Value $true `
    -Location "Website1/MyApp" `
    -PSPath IIS:\    # We are using the root (applicationHost.config) file

# The section paths are:
#
#  Anonymous: system.webServer/security/authentication/anonymousAuthentication
#  Basic:     system.webServer/security/authentication/basicAuthentication
#  Windows:   system.webServer/security/authentication/windowsAuthentication
</code></pre>
  
  
<pre><code class="language-powershell">Import-Module IISAdministration

$manager = Get-IISServerManager

# ServerManager makes it easy to get the various config files that belong to
# an app, or at the applicationHost level. Since this setting is locked
# to applicationHost, we need to get the applicationHost configuration.
$config = $manager.GetApplicationHostConfiguration()

# Note that we have to specify the name of the site or application we are
# editing, since we are working with individual &lt;location&gt; sections within
# the global applicationHost.config file.
$section = $config.GetSection(`
    "system.webServer/security/authentication/windowsAuthentication", `
    "Website1")
$section.Attributes["enabled"].Value = $true

# The section paths are:
#
#  Anonymous: system.webServer/security/authentication/anonymousAuthentication
#  Basic:     system.webServer/security/authentication/basicAuthentication
#  Windows:   system.webServer/security/authentication/windowsAuthentication

# Changing options for an application in a virtual directory is similar,
# just specify the site name and app name together:
$section = $config.GetSection(`
    "system.webServer/security/authentication/windowsAuthentication", `
    "Website1/MyApp")
$section.Attributes["enabled"].Value = $true

$manager.CommitChanges()
</code></pre>
  
 


<h3 id="changing-logging-settings">æ›´æ”¹æ—¥å¿—è®°å½•è®¾ç½®</h3>

<p>HTTPè¯·æ±‚æ—¥å¿—è®°å½•ç”±IISæä¾›ï¼Œå¯ä»¥åœ¨æœåŠ¡å™¨èŒƒå›´å†…æŒ‡å®šï¼Œä¹Ÿå¯ä»¥åœ¨å•ä¸ªç«™ç‚¹çº§åˆ«æŒ‡å®šã€‚åº”ç”¨ç¨‹åºå’Œè™šæ‹Ÿç›®å½•å¯ä»¥ç¦ç”¨æ—¥å¿—è®°å½•ï¼Œä½†å®ƒä»¬è‡ªå·±ä¸èƒ½è¿›è¡Œä»»ä½•æ—¥å¿—è®°å½•ã€‚ä»¥ä¸‹ç¤ºä¾‹æ˜¾ç¤ºäº†å¦‚ä½•åœ¨ç«™ç‚¹çº§åˆ«è®¾ç½®æ—¥å¿—è®°å½•ã€‚</p>

<p>æ—¥å¿—è®°å½•è®¾ç½®å­˜å‚¨åœ¨ç«™ç‚¹ä¸‹é¢çš„<code>applicationHost.config</code>ä¸­:</p>

<pre><code class="language-xml">&lt;system.applicationHost&gt;
    &lt;!-- ... --&gt;
    &lt;sites&gt;
        &lt;site name="Default Web Site" id="1"&gt;
            &lt;bindings&gt;
                &lt;binding protocol="http" bindingInformation="*:80:" /&gt;
            &lt;/bindings&gt;
            &lt;logFile logFormat="IIS" directory="%SystemDrive%\inetpub\logs\LogFiles1" period="Hourly" /&gt;
        &lt;/site&gt;
        &lt;siteDefaults&gt;
            &lt;logFile logFormat="W3C" directory="%SystemDrive%\inetpub\logs\LogFiles" /&gt;
            &lt;traceFailedRequestsLogging directory="%SystemDrive%\inetpub\logs\FailedReqLogFiles" /&gt;
        &lt;/siteDefaults&gt;
        &lt;!-- ... --&gt;
</code></pre>


 
 
  
<pre><code class="language-powershell">Import-Module WebAdministration

$settings = @{ `
    logFormat="W3c";                `   # Formats:   W3c, Iis, Ncsa, Custom
    enabled=$true;                  `
    directory="C:\Sites\Logs";      `
    period="Daily";                 `
}

Set-ItemProperty "IIS:\Sites\Website1" -name "logFile" -value $settings
</code></pre>
  
  
<pre><code class="language-powershell">Import-Module IISAdministration

$manager = Get-IISServerManager

$site = $manager.Sites["Website1"]
$logFile = $site.LogFile
$logFile.LogFormat = "W3c"               # Formats:   W3c, Iis, Ncsa, Custom
$logFile.Directory = "C:\Sites\Logs"     
$logFile.Enabled = $true
$logFile.Period = "Daily"

$manager.CommitChanges()
</code></pre>
  
 


<h3 id="running-application-pools-as-a-specific-user">ä»¥ç‰¹å®šç”¨æˆ·èº«ä»½è¿è¡Œåº”ç”¨ç¨‹åºæ± </h3>

<p>æ‚¨é€šå¸¸å¯ä»¥é€šè¿‡è¿è¡Œæ‚¨çš„åº”ç”¨ç¨‹åºæ± ä½œä¸º<code>ApplicationPoolIdentity</code>å¸æˆ·æ¥è·å¾—ã€‚è¿™å°†ä¸ºæ¯ä¸ªä¸åŒçš„åº”ç”¨ç¨‹åºæ± è‡ªåŠ¨åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿå¸æˆ·ï¼Œå°†å®ƒä»¬å½¼æ­¤éš”ç¦»å¼€æ¥ã€‚åœ¨æœ¬åœ°æœºå™¨ä¸Šï¼Œæ‚¨å¯ä»¥å‘æ¯ä¸ªå•ç‹¬çš„åº”ç”¨ç¨‹åºæ± æˆäºˆå¯¹èµ„æº(å¦‚æ–‡ä»¶ç³»ç»Ÿ)çš„è®¿é—®æƒã€‚å¯¹äºè¿œç¨‹èµ„æº(å¦‚ä¸åŒæœºå™¨ä¸Šçš„SQL Server)ï¼Œåº”ç”¨ç¨‹åºæ± æ ‡è¯†å……å½“ç½‘ç»œæœåŠ¡ï¼Œå› æ­¤æ‚¨å¯ä»¥åœ¨æœºå™¨çº§åˆ«æˆäºˆè®¿é—®æƒé™ã€‚äº†è§£å…³äº<a href="https://www.iis.net/learn/manage/configuring-security/application-pool-identities" rel="nofollow">åº”ç”¨ç¨‹åºæ± æ ‡è¯†</a>çš„æ›´å¤šä¿¡æ¯ã€‚</p>

<p>ä¸ºäº†æ›´å¥½åœ°æ§åˆ¶åº”ç”¨ç¨‹åºæ± çš„åŠŸèƒ½ï¼Œæ‚¨åº”è¯¥åœ¨ç‰¹å®šçš„è‡ªå®šä¹‰ç”¨æˆ·å¸æˆ·ä¸‹è¿è¡Œå®ƒã€‚æ‚¨éœ€è¦ä½¿ç”¨<a href="https://msdn.microsoft.com/en-us/library/k6h9cz8h.aspx" rel="nofollow"> <code>aspnet_regiis</code> </a>æ¥ä¸ºæ‚¨çš„è‡ªå®šä¹‰å¸æˆ·æä¾›ä½œä¸ºåº”ç”¨ç¨‹åºæ± è¿è¡Œå’Œæ‰§è¡ŒASP.NETè¯·æ±‚æ‰€éœ€çš„æ‰€æœ‰æƒé™ã€‚ç„¶åï¼Œæ‚¨å¯ä»¥å°†åº”ç”¨ç¨‹åºæ± è®¾ç½®ä¸ºä»¥è¯¥ç”¨æˆ·èº«ä»½è¿è¡Œ:</p>


 
 
  
<pre><code class="language-powershell">Import-Module WebAdministration

New-Item -Path "IIS:\AppPools" -Name "My Pool" -Type AppPool

$identity = @{  `
    identitytype="SpecificUser"; `
    username="My Username"; `
    password="My Password" `
}
Set-ItemProperty -Path "IIS:\AppPools\My Pool" -name "processModel" -value $identity
</code></pre>
  
  
<pre><code class="language-powershell">Import-Module IISAdministration

$manager = Get-IISServerManager
$pool = $manager.ApplicationPools.Add("My Pool")
$pool.ProcessModel.IdentityType = "SpecificUser"
$pool.ProcessModel.Username = "My User"
$pool.ProcessModel.Password = "Password"

$manager.CommitChanges()
</code></pre>
  
 


<h2 id="summary">æ‘˜è¦</h2>

<p>å¦‚æœæ‚¨ç¬¬ä¸€æ¬¡ç€æ‰‹è‡ªåŠ¨åŒ–æ‚¨çš„IISéƒ¨ç½²ï¼Œæˆ‘å¸Œæœ›æ‚¨ä¼šå‘ç°æœ¬æ–‡ä¸­çš„èƒŒæ™¯ä¿¡æ¯å’Œç¤ºä¾‹å¾ˆæœ‰ç”¨ã€‚æ­£å¦‚æˆ‘æåˆ°çš„ï¼Œè¿™äº›ä¾‹å­åœ¨GitHubåº“çš„<a href="https://github.com/OctopusDeploy/PowerShell-IIS-Examples" rel="nofollow">ä¸­ï¼Œæˆ‘ä»¬åœ¨Windows 2008 R2åˆ°Windows Server 2016ä¸Šè¿è¡Œå®ƒä»¬ã€‚å¦‚æœä½ å‘ç°ä»»ä½•é—®é¢˜æˆ–è€…å¯¹è¿™ç¯‡æ–‡ç« åº”è¯¥åŒ…æ‹¬çš„å…¶ä»–ä¾‹å­æœ‰æƒ³æ³•ï¼Œè¯·åœ¨è¯„è®ºä¸­å‘Šè¯‰æˆ‘æˆ–è€…å‘é€ä¸€ä¸ªè¯·æ±‚ï¼</a></p>

<h2 id="learn-more">äº†è§£æ›´å¤šä¿¡æ¯</h2>



                    
                    
</body>
</html>