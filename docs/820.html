<html>
<head>
<title>Deploying a Vault to WildFly - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>将存储库部署到WildFly - Octopus部署</h1>
<blockquote>原文：<a href="https://octopus.com/blog/wildfly-vault#2022-08-09">https://octopus.com/blog/wildfly-vault#2022-08-09</a></blockquote>
                        <p>在处理密码等敏感信息时，<a href="https://octopus.com/docs/projects/variables/sensitive-variables"> Octopus Deploy为您提供加密和保存这些值的能力</a>以确保它们的安全。</p>

<p>如果这些密码是用于数据库服务器之类的外部系统，通常需要解密密码，并将其以纯文本形式存储在某个配置文件中，以便实际使用密码。但是以纯文本的形式保存敏感信息并不理想，因为这使得它容易受到许多简单的攻击，例如在编辑配置文件时监视他人，或者在聊天系统中共享、通过电子邮件发送或发布到帮助论坛，或者检查版本控制系统的历史时捕捉内容文件的内容。</p>

<p>WildFly通过将敏感信息放入保险库中来缓解这些漏洞。</p>

<p>虽然保险库被认为是安全的，但将敏感信息放入保险库仍然是值得的，因为这意味着配置文件的普通观察者将无法提取密码。</p>


<p>作为为Java提供一流支持的举措的一部分，我们正计划提供将Octopus变量导出到WildFly vault的能力。在这篇博文中，我将向你介绍如何在今天实现这一目标。</p>

<h2 id="exporting-variables">导出变量</h2>

<p>如果您曾经使用过WildFly附带的<code>vault</code>脚本，您会知道要存储在vault中的每个值都必须一次添加一个。这很乏味，而且很难维护。为了提供一种更快的方式将安全值放入保险库中，我们编写了一个<a href="https://github.com/OctopusDeploy/JBossDeployment/blob/master/create-vault.groovy" rel="nofollow"> Groovy脚本</a>，它从一个CSV文件中获取值。</p>

<p>但是首先我们需要从Octopus中获取安全值并保存到一个CSV文件中。幸运的是，Powershell附带了<code>Export-Csv</code>命令，这使得事情变得微不足道。下面的代码可以在Octopus的脚本步骤中定义，以将一组键/值对导出到CSV文件。然后它调用<code>create-vault.groovy</code>脚本将CSV文件转换成WildFly vault。保险库密码保存在名为<code>VaultPassword</code>的输出变量中，CSV文件被删除。</p>

<pre><code class="language-powershell">try {
    # Dump all available variables
    # $OctopusParameters.GetEnumerator() | sort-object Name  | Export-Csv -Path "C:\variables.csv"

    # Dump only a few variables
    $variables = @{"wildfly_slave_password" = $wildfly_slave_password}
    $variables.GetEnumerator() | Select Key,Value  | Export-Csv -Path "C:\variables.csv"

    cd C:\Apps\JBossDeployment
    $vaultPassword = &amp;groovy create-vault.groovy `
      --keystore-file C:\wildfly_dc\wildfly-11.0.0.Alpha1\domain\configuration\keystore.vault `
      --keystore-password Password01 `
      --enc-dir C:\wildfly_dc\wildfly-11.0.0.Alpha1\domain\configuration\vault `
      --csv C:\variables.csv

    Set-OctopusVariable -name "VaultPassword" -value $vaultPassword
}
finally {
    rm "C:\variables.csv"
}
</code></pre>

<p>一旦这个脚本运行，我们将有一个名为<code>C:\wildfly_dc\wildfly-11.0.0.Alpha1\domain\configuration\keystore.vault</code>的文件，一个名为<code>C:\wildfly_dc\wildfly-11.0.0.Alpha1\domain\configuration\vault</code>的目录，以及一个可以用来访问保险库的密码。</p>

<p>您需要首先在所有域节点或独立节点上运行此脚本，以便它们都有一个vault的本地副本，可以在下一步中进行配置。</p>

<h2 id="configuring-the-vault">配置存储库</h2>

<p>创建了保险库之后，我们现在需要配置WildFly来使用它。这是通过将以下XML添加到WildFly主机配置文件中来完成的。</p>

<pre><code class="language-xml">&lt;vault&gt;
    &lt;vault-option name="KEYSTORE_URL" value="C:\wildfly_standalone\wildfly-11.0.0.Alpha1\standalone\configuration\keystore.vault"/&gt;
    &lt;vault-option name="KEYSTORE_PASSWORD" value="MASK-223/wEo1GLELe8EuQa5u20"/&gt;
    &lt;vault-option name="KEYSTORE_ALIAS" value="vault"/&gt;
    &lt;vault-option name="SALT" value="12345678"/&gt;
    &lt;vault-option name="ITERATION_COUNT" value="50"/&gt;
    &lt;vault-option name="ENC_FILE_DIR" value="C:\wildfly_standalone\wildfly-11.0.0.Alpha1\standalone\configuration\vault\/"/&gt;
&lt;/vault&gt;
</code></pre>

<p>为了简化这个过程，有另一个<a href="https://github.com/OctopusDeploy/JBossDeployment/blob/master/deploy-vault.groovy" rel="nofollow"> Groovy脚本</a>将为您添加这个配置。</p>

<p>下面的Powershell用于运行Groovy脚本并将vault配置添加到主机。</p>

<p>您只需要在域控制器上运行这个脚本，而不需要在域从属服务器上运行，因为域控制器会将vault配置推送到从属服务器。但是，域控制器不会推出实际的vault文件，这就是我们在添加此配置之前在所有主机上创建vault文件的原因。</p>

<p>如果您有独立的实例，那么这个脚本将在所有的实例上运行。</p>

<pre><code class="language-powershell">cd C:\Apps\JBossDeployment
&amp;groovy deploy-vault.groovy `
  --controller localhost `
  --port 9990 `
  --user admin `
  --password password `
  --keystore-file C:\wildfly_dc\wildfly-11.0.0.Alpha1\domain\configuration\keystore.vault `
  --keystore-password $OctopusParameters["Octopus.Action[Create Vault].Output.VaultPassword"] `
  --enc-dir C:\wildfly_dc\wildfly-11.0.0.Alpha1\domain\configuration\vault
</code></pre>

<h2 id="accessing-the-vault-passwords">访问保险库密码</h2>

<p>通过WildFly配置文件中的一个特殊变量，可以访问存储库中包含的密码。这里，我们引用了我们的vault中别名<code>vault</code>的<code>wildfly_slave_password</code>变量。</p>

<pre><code class="language-xml">&lt;server-identities&gt;
  &lt;secret value="${VAULT::vault::wildfly_slave_password::1}"/&gt;
&lt;/server-identities&gt;
</code></pre>

<p>正如您所看到的，实际的密码不再以纯文本的形式保存，即使这个配置文件被泄露，它也不会泄露一个泄漏的密码。</p>


<h2 id="next-steps">后续步骤</h2>

<p>这些Groovy脚本正在被开发，作为最终将被移植到Octopus Deploy中直接提供的步骤中的概念验证。</p>

<p>如果你对剧本有任何问题，请留下评论。如果有一些Java特性你希望Octopus在未来部署支持，请加入<a href="https://octopus.com/blog/java-rfc"> Java RFC帖子</a>的讨论。</p>

                    
                    
</body>
</html>