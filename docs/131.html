<html>
<head>
<title>Configuring Octopus High Availability in Azure - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>在Azure - Octopus部署中配置Octopus高可用性</h1>
<blockquote>原文：<a href="https://octopus.com/blog/configure-octopus-high-availability-in-azure#2022-07-14">https://octopus.com/blog/configure-octopus-high-availability-in-azure#2022-07-14</a></blockquote>
                        <p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-04/configure-octopus-high-availability-in-azure/image.png" class="zoom" data-title=""><img src="../Images/9ca0a2b6e953acf7559e1b546f759e76.png" class="img-fluid center" alt="Octopus High-Availability on Azure" data-original-src="https://i.octopus.com/blog/2021-04/configure-octopus-high-availability-in-azure/image.png"/>T2】</a></p>

<p>我们最近更新了我们的<a href="https://octopus.com/docs/administration/high-availability">高可用性</a>文档，为托管Octopus高可用性提供更多信息和选项。</p>

<p>在这篇博客中，我在Azure上设置了Octopus高可用性，评估了您可以使用的不同选项，并带您了解了在微软Azure上高可用性Octopus Deploy设置的不同组件。</p>



<h2 id="the-benefits-of-octopus-high-availability">Octopus高可用性的好处</h2>

<p><a href="https://octopus.com/docs/administration/high-availability">高可用性</a>允许你运行多个Octopus服务器，在它们之间分配负载和任务。高可用性有几个好处:</p>

<ul>
<li>业务关键型工作负载的弹性更高。</li>
<li>更简单的维护任务，如<a href="https://en.wikipedia.org/wiki/Patch_(computing)" rel="nofollow">服务器补丁</a>。</li>
<li>性能和可扩展性。</li>
<li>更少的停机时间。</li>
<li>使用八达通高可用性不收取额外费用。</li>
</ul>

<h2 id="octopus-high-availability-components">Octopus高可用性组件</h2>

<p>Octopus HA配置需要四个主要组件:</p>

<ul>
<li><strong>负载平衡器</strong>:负载平衡器在不同的Octopus服务器节点之间引导去往Octopus web接口的用户流量。</li>
<li><strong> Octopus服务器节点</strong>:运行Octopus服务器windows服务。它们服务于用户流量并协调部署。</li>
<li><strong>一个数据库</strong>:Octopus服务器节点使用的大部分数据都存储在这个数据库中。</li>
<li><strong>共享存储</strong>:一些较大的文件(如<a href="https://octopus.com/docs/packaging-applications/package-repositories"> NuGet包</a>，工件，部署任务日志)不适合存储在数据库中，必须存储在所有节点都可用的共享文件夹中。</li>
</ul>

<h2 id="octopus-virtual-machines">章鱼虚拟机</h2>

<p>当创建高可用性配置时，您需要在Azure中提供至少两个虚拟机来托管Octopus。我们没有一个适用于所有章鱼的标准，因为它取决于:</p>



<p>如果您在Octopus中的工作负载相当小，您可以选择较小的虚拟机。不过，Azure D系列虚拟机是一个很好的起点，因为它们是通用的，非常适合大多数场景。</p>

<p>我们的建议是考虑您的工作负载，然后使用其中一个D系列虚拟机，看看它在满足您的要求方面表现如何。</p>

<p>在这种情况下，我使用<strong> D2s V2 </strong>启动了两个虚拟机，分别名为<strong> Octo1 </strong>和<strong> Octo2 </strong>，它们使用<strong> Server 2019 </strong>拥有两个vCPU和8GB内存。这个规格是一个很好的起点，您可以将D系列更改为其他尺寸。</p>

<p>理论上，您可以根据需要增加资源和减少资源。您可以在这里使用某种形式的自动化来水平或垂直扩展。</p>

<h3 id="virtual-machine-disks">虚拟机磁盘</h3>

<p>您需要考虑您的Octopus虚拟机需要什么类型的存储，并且您可以看到<a href="https://docs.microsoft.com/en-us/azure/virtual-machines/disks-types" rel="nofollow">可用性磁盘类型</a>的完整列表。有几个问题需要考虑:</p>

<ul>
<li><a href="https://docs.microsoft.com/en-us/azure/virtual-machines/disks-types#ultra-disk" rel="nofollow">超磁盘</a> : Azure最快的磁盘。</li>
<li><a href="https://docs.microsoft.com/en-us/azure/virtual-machines/disks-types#premium-ssd" rel="nofollow">顶级固态硬盘</a>:适用于大多数工作负载的绝佳解决方案。</li>
<li><a href="https://docs.microsoft.com/en-us/azure/virtual-machines/disks-types#standard-ssd" rel="nofollow">标准固态硬盘</a>:在合理的预算内为您提供高速磁盘的解决方案。</li>
<li><a href="https://docs.microsoft.com/en-us/azure/virtual-machines/disks-types#standard-hdd" rel="nofollow">标准硬盘</a>:通常最适合低性能工作负载或开发和测试环境。</li>
</ul>

<p>请务必记住，这仅适用于虚拟机，我选择了<strong>标准固态硬盘</strong>，因为其成本和性能符合我的要求。Octopus对磁盘的占用不是很大，这意味着使用Ultra Disks不太可能获得很多好处。如果你在数千个项目中使用Octopus，你应该考虑高级SSD，因为这可能是有益的。</p>

<h3 id="azure-availability-sets-vs.azure-availability-zones">Azure可用性集与Azure可用性区域</h3>

<p>请查看<a href="https://docs.microsoft.com/en-us/azure/virtual-machines/availability" rel="nofollow"> Azure文档</a>以获得Azure虚拟机可用性选项的完整列表，因为我们不会涵盖所有这些。</p>

<ul>
<li>Azure可用性区域是Azure区域内独立的数据中心，具有专用的电力、冷却和网络。通过这个选项，当使用可用性区域时，您可以确保Octopus在您的主要Azure区域中保持对故障的弹性。对于弹性，所有启用区域至少有三个独立的区域。Azure为这个选项提供了99.99%的正常运行时间SLA。</li>
<li><a href="https://docs.microsoft.com/en-us/azure/virtual-machines/availability-set-overview" rel="nofollow"> Azure可用性集</a>是虚拟机的逻辑分组，提供冗余和可用性。Azure为可用性集提供了<strong> 99.95%的正常运行时间SLA </strong>，除了虚拟机成本之外，没有任何成本。</li>
</ul>

<p>在微软Azure上设计和配置Octopus时，我选择了<strong> Azure Availability Zones </strong>选项，纯粹是为了提高SLA。这也是微软通常推荐的高可用性。</p>

<p>我在<strong>可用性区域1 </strong>和<strong>可用性区域2 </strong>中设置了我的两个虚拟机<strong> Octo1 </strong>和<strong> Octo2 </strong>。这让我对Octopus HA有了容忍度，因为它使用了不同的逻辑数据中心，并且具有对存储和SQL数据库进行低延迟访问的优势。</p>

<p>大多数Octopus高可用性配置将包含两个虚拟机。如果您使用三个或更多，您需要将它们放入各自的区域。</p>

<p>多虚拟机Octopus高可用性的配置示例如下:</p>

<ul>
<li>AZ1的10月1日，AZ2的10月2日</li>
<li>AZ1的10月1日，AZ2的10月2日，AZ3的10月3日</li>
<li>AZ1中的十月一日、AZ2中的十月二日、AZ3中的十月三日、AZ1中的十月四日</li>
</ul>

<p>我们只在八个节点上测试Octopus，但是您可以根据需要将这些节点划分到多个可用区域。</p>

<h2 id="octopus-sql-database">Octopus SQL数据库</h2>

<p>Octopus由一个存储环境、项目、变量、版本和部署历史的SQL数据库支撑。你需要在Azure中启动一个SQL服务器。有两种选择可以考虑，而Octopus天生就支持这两种选择:</p>



<p>如果您可以联系数据库管理员，您应该寻求他们的专业知识，因为他们可能会提供进一步的见解。</p>

<h3 id="sql-virtual-machine-vs.azure-sql">SQL虚拟机与Azure SQL</h3>

<p>大多数组织在云中调配SQL工作负载时都使用虚拟机。在这一节中，我将介绍选择SQL虚拟机的好处和一些缺点。</p>

<p>因为我们需要Octopus的高可用性配置，所以我们需要考虑SQL级别的高可用性。这意味着你最少需要三个SQL服务器，最好是在Azure的一个SQL集群中，或者在Azure的一个永远可用组中。</p>

<p>大多数情况下，我将保持这一部分的高水平，因为在这些主题上有很好的内容，您可能有一个数据库管理员会为您执行此操作。如果你已经在Azure上安装了这个，我推荐使用这个设置来托管Octopus，最好是在一个专用的SQL实例上。</p>

<p>在Azure SQL上使用SQL虚拟机的优势:</p>

<ul>
<li>更大的灵活性。</li>
<li>更多的控制。</li>
<li>托管多个数据库，无需额外成本。</li>
</ul>

<p>在Azure SQL上使用SQL虚拟机的缺点:</p>

<ul>
<li>更高的总拥有成本。</li>
<li>增加了设置时间。</li>
<li>维护基础设施和数据库。</li>
</ul>

<p>我做了很多概念验证，我是任何PaaS的忠实粉丝。我特别喜欢<a href="https://docs.microsoft.com/en-us/azure/sql-database/sql-database-technical-overview" rel="nofollow"> Azure SQL数据库服务</a>，因为我不需要投入太多时间来启动虚拟机、网络安全组、配置SQL、防火墙规则、维护计划等。</p>

<p>我可以登录到<a href="https://portal.azure.com/" rel="nofollow"> Azure门户网站</a>，在几分钟内就可以构建一个新的SQL Server、数据库和连接字符串。如果你已经准备好了<a href="https://azure.microsoft.com/en-gb/resources/templates/" rel="nofollow">手臂模板</a>，这可能需要一些时间。基础设施作为代码可以节省大量时间，但我意识到这可能还不是每个人的偏好。</p>

<p>当在Azure SQL上构建数据库时，我可以在几分钟内创建一个地理复制或本地复制的数据库，这就是我的高可用性数据库。然后我简单地为Octopus配置连接字符串，就可以开始了。</p>

<p>在SQL虚拟机上使用Azure SQL有很多好处:</p>

<ul>
<li>更容易配置。</li>
<li>在几秒钟/几分钟内根据需要旋转和拆卸。</li>
<li>只需几个命令或几下鼠标，就能使数据库高度可用。</li>
<li>管理备份和维护任务。</li>
<li>伟大的Azure AQL分析和监测内置。</li>
</ul>

<p>在SQL虚拟机上使用Azure SQL的一些缺点:</p>

<ul>
<li>更少的控制。</li>
<li>当出现问题时，恢复备份需要相当长的时间。</li>
<li>重构SQL脚本。</li>
<li>试图理解什么是DTU。</li>
</ul>

<p>两种选择各有利弊。在为您和您的组织需求选择正确的解决方案时，您应该考虑这一点。</p>

<h3 id="sql-database-selection">SQL数据库选择</h3>

<p>下面是我在我的例子中所做的:</p>

<ul>
<li>选择西欧的Azure SQL Server，因为这是我的主要地区。</li>
<li>为我的地理复制Octopus数据库选择了位于北欧的Azure SQL Server，以满足灾难恢复需求。</li>
<li>在主区域和SQL Server中创建了一个名为<strong> Octo-HA </strong>的数据库。</li>
<li>浏览到主Azure SQL数据库上的地理复制并启用复制。</li>
<li>让它复制到辅助数据库服务器和区域。</li>
</ul>

<p>此时，您有一个主数据库服务器和数据库，它跨区域同步到一个辅助服务器和数据库。</p>

<p>区域冗余数据库目前正在Azure中预览。如果这是可用的，我会使用区域冗余数据库，因为这与我为Azure虚拟机设置的冗余级别相同。</p>


<h3 id="sql-database-specifications">SQL数据库规范</h3>

<p>博客的这一部分涵盖了SQL Server性能的选项。我建议查看<a href="https://docs.microsoft.com/en-us/azure/azure-sql/database/high-availability-sla" rel="nofollow">高可用性SLA </a>文档，以选择正确的数据库和服务器规模。</p>

<p>在我的例子中，我选择了:</p>

<ul>
<li>一般用途。</li>
<li>Provisioned，提供预先分配并按小时计费的计算机资源。</li>
<li>2个vCores。</li>
<li>最大数据大小为30GB。</li>
<li>区域冗余开启(区域冗余增加约20%的成本)。</li>
</ul>

<p>在高可用性配置中，这些规范是一个很好的起点。不过，您可能需要考虑您的工作量，因为如果您拥有一个小的Octopus实例，这对于您的要求来说可能太大了。</p>

<p>如果你拥有一个大型实例，我会考虑微软Azure中的超大规模和业务关键负载。找到适合您的SQL需求的方法，因为您不想要一个性能缓慢的Octopus实例，但您可能也不想让它太大，并为您的数据库托管支付太多费用。</p>

<h2 id="octopus-storage">八达通存储</h2>

<p>在单节点设置中，你通常将Octopus托管在<a href="https://en.wikipedia.org/wiki/Local_storage" rel="nofollow">本地存储上</a>在<code>C:\Octopus</code>或<code>D:\Octopus.</code>你需要Octopus的一些本地存储，除非你决定将Azure文件共享作为映射驱动器或作为到服务器的符号链接。</p>

<p>我们建议在服务器上本地托管您的Octopus日志和配置。这避免了可能导致Octopus停止响应的潜在文件锁定问题。</p>

<h3 id="artifacts-packages-and-task-logs">工件、包和任务日志</h3>

<p>Octopus存储了几个不适合存储在数据库中的文件。其中包括:</p>

<ul>
<li>Octopus内部的<a href="https://octopus.com/docs/packaging-applications/package-repositories">内置NuGet库</a>使用的NuGet包。这些包裹通常很大。</li>
<li>部署期间收集的工件。使用Octopus的团队有时会在部署过程中使用这个特性从机器上收集大型日志文件和其他文件。</li>
<li>任务日志是存储部署和其他任务的所有日志输出的文本文件。</li>
</ul>

<p>与数据库一样，从Octopus的角度来看，您告诉Octopus服务器将它们作为文件路径存储在操作系统中的什么位置。Octopus不在乎你用什么技术来呈现共享存储；它可以是映射的网络驱动器或文件共享的UNC路径。这三种类型的数据都存储在不同的位置。</p>

<p>无论您以何种方式提供共享存储，都有一些注意事项:</p>

<ul>
<li>对Octopus来说，它需要显示为映射的网络驱动器(例如，<code>D:\</code>)或文件共享的UNC路径(例如，<code>\\server\path</code>)。</li>
<li>Octopus运行的服务帐户需要完全控制目录。</li>
<li>驱动器是按用户映射的，所以您应该使用运行Octopus的同一服务帐户来分配驱动器。</li>
</ul>

<h3 id="azure-files">Azure文件</h3>

<p>如果你的Octopus服务器运行在微软Azure中，只有一个解决方案(除非你在Azure中有一个<a href="https://docs.microsoft.com/en-us/windows-server/storage/dfs-replication/dfsr-overview" rel="nofollow"> DFS副本</a>)。这个解决方案就是<a href="https://docs.microsoft.com/en-us/azure/storage/files/storage-files-introduction" rel="nofollow"> Azure文件存储</a>，它通过SMB 3.0提供一个文件共享，在你所有的Octopus服务器上共享。</p>

<p>一旦你创建了你的文件共享，添加Azure文件共享作为一个<a href="https://en.wikipedia.org/wiki/Symbolic_link" rel="nofollow">符号链接</a>，然后将它添加到<code>C:\Octopus\</code>用于工件、包和任务日志，它们需要对所有节点可用。</p>

<p>安装Octopus 前运行以下<strong>:</strong></p>

<pre><code class="language-powershell"># Add the Authentication for the symbolic links. You can get this from the Azure Portal.

cmdkey /add:octostorage.file.core.windows.net /user:Azure\octostorage /pass:XXXXXXXXXXXXXX

# Add Octopus folder to add symbolic links

New-Item -ItemType directory -Path C:\Octopus
New-Item -ItemType directory -Path C:\Octopus\Artifacts
New-Item -ItemType directory -Path C:\Octopus\Packages
New-Item -ItemType directory -Path C:\Octopus\TaskLogs

# Add the Symbolic Links. Do this before installing Octopus.

mklink /D C:\Octopus\TaskLogs \\octostorage.file.core.windows.net\octoha\TaskLogs
mklink /D C:\Octopus\Artifacts \\octostorage.file.core.windows.net\octoha\Artifacts
mklink /D C:\Octopus\Packages \\octostorage.file.core.windows.net\octoha\Packages
</code></pre>

<p><a href="https://octopus.com/docs/installation">安装Octopus </a>，然后运行以下程序:</p>

<pre><code class="language-powershell"># Set the path
&amp; 'C:\Program Files\Octopus Deploy\Octopus\Octopus.Server.exe' path --artifacts "C:\Octopus\Artifacts"
&amp; 'C:\Program Files\Octopus Deploy\Octopus\Octopus.Server.exe' path --taskLogs "C:\Octopus\TaskLogs"
&amp; 'C:\Program Files\Octopus Deploy\Octopus\Octopus.Server.exe' path --nugetRepository "C:\Octopus\Packages"
</code></pre>

<h2 id="load-balancing">负载平衡</h2>

<p>当您配置第一个Octopus服务器节点和每个后续节点时，您配置了Octopus Web门户可用的HTTP端点。</p>

<p>最后一步是配置一个负载平衡器，在每个Octopus服务器节点之间引导用户流量。</p>

<p>Octopus可以与任何负载平衡器技术一起工作，包括硬件和软件负载平衡器。Azure为我们提供了以下负载平衡器:</p>



<p>在评估了Azure中的选项后，我的首选是Azure负载平衡器选项，因为这是一个功能丰富的负载平衡器，符合我的要求。如果你想比较负载平衡的所有Azure选项，请查看<a href="https://docs.microsoft.com/en-us/azure/architecture/guide/technology-choices/load-balancing-overview" rel="nofollow">选择负载平衡服务</a>。</p>

<p>在创建虚拟机之前创建Azure负载平衡器，因为您可以在配置期间选择负载平衡器。</p>


<h3 id="load-balancer-session-persistence">负载平衡器会话持久性</h3>

<p>我们通常建议使用循环(或类似的)方法在集群中的节点之间共享流量，因为Octopus Web门户是无状态的。</p>

<p>但是，群集中的每个节点都保留了数据的本地缓存，包括用户权限。当用户权限更改时，会出现一个已知问题。本地缓存仅在进行更改的节点上无效。</p>

<p>为了同时解决这个问题，您可以用<strong>会话持久性</strong>配置您的负载平衡器。这将确保用户会话被路由到同一个节点。</p>

<h2 id="authentication-providers">身份验证提供商</h2>

<p>如果你从内部迁移到Azure，你需要考虑你的身份验证提供者。你可能在本地使用<strong>活动目录</strong>，通常，这是Azure中的Octopus不支持的，因为你需要在Octopus安装的同一网络中有一个域控制器，以允许对你的活动目录用户进行身份验证。</p>

<p>如果您在Azure中有可联系的域控制器，您可以继续使用Active Directory身份验证。</p>

<p>如果您没有可在Azure中联系的域控制器，您需要考虑切换到:</p>



<h3 id="moving-authentication-providers">移动身份验证提供程序</h3>

<p>如果您已经在内部使用了Active Directory，并且正在迁移到Azure，并且无法继续使用Active Directory，则可以在Octopus中将多个外部身份与单个用户相关联。最常见的迁移可能是从Active Directory到Azure Active Directory。在这个例子中，假设我有一个名为<strong> Derek的用户。坎贝尔</strong>在一个名为<strong> work.local </strong>的域名和一个worklocal.onmicrosoft.com<strong>的活动目录租户上，我会:</strong></p>

<ul>
<li>设置<a href="https://octopus.com/docs/security/authentication/azure-ad-authentication"> Azure活动目录</a>。</li>
<li>将我的<strong>Derek.Campbell@Worklocal.OnMicrosoft.com</strong>帐户添加到Octopus Deploy用户，该用户也有我的<strong>德里克。坎贝尔@Work.local </strong>用户。</li>
<li>拆下<strong>德里克。来自用户的Campbell@work.local </strong>。</li>
<li>测试身份验证。</li>
<li>冲洗，并为所有用户重复。</li>
</ul>

<p>请查看<a href="https://github.com/OctopusDeploy/OctopusDeploy-Api/blob/master/REST/PowerShell/Users/AddAzureActiveDirectoryLoginToUsers.ps1" class="alert-link" rel="nofollow">该脚本</a>，因为如果您要切换到Azure Active Directory，它可以帮助您从本地迁移到Azure。</p>


<h2 id="networking">建立工作关系网</h2>

<p>即使在最好的情况下，网络也是一个有争议的问题，您的配置将在很大程度上取决于您现有的网络拓扑和标准。我会实现下面的一个或几个来帮助保护你的Azure工作负载:</p>

<ul>
<li><a href="https://azure.microsoft.com/en-gb/services/azure-bastion/" rel="nofollow"> Azure Bastion </a>:一个完全平台管理的PaaS服务，可以用来为您的服务器提供安全无缝的RDP/SSH连接。</li>
<li><a href="https://azure.microsoft.com/en-gb/services/vpn-gateway/" rel="nofollow"> VPN网关</a>:将你的本地网络连接到Azure服务的服务。</li>
<li>ExpressRoute :一种通过私人链接直接连接Azure的专线方式。</li>
<li><a href="https://en.wikipedia.org/wiki/Jump_server" rel="nofollow">跳转框</a>:一种从安全服务器启用到Azure服务的单一路由的方式。</li>
</ul>

<p>考虑使用现有的方法连接到Azure，如果你已经有了它们。如果您有快速路线，那么这是最好的方法，但它是最昂贵的。</p>

<p>如果你有一个VPN网关，一个跳转框，或者甚至Azure Bastion服务，我推荐你利用这些优势。</p>

<p>最重要的建议是减少您的<a href="https://en.wikipedia.org/wiki/Attack_surface" rel="nofollow">攻击面</a>，同时保持您的网络尽可能简单明了，不会导致任何潜在的安全问题。</p>

<ul>
<li>在可能的情况下，使用<a href="https://en.wikipedia.org/wiki/Private_network" rel="nofollow">内部IP和网络</a>而不是公共IP，尤其是针对您的SQL配置。</li>
<li>使用VPN或跳转/堡垒盒。最好两者都有。</li>
<li>安全八达通使用HTTPS只有一个有效的证书。</li>
</ul>

<h3 id="polling-tentacles">投票触角</h3>

<p>监听触角不需要特殊的配置来实现高可用性。然而，轮询触须定期轮询服务器，以检查触须是否需要执行任何任务。</p>

<p>在高可用性场景中，轮询触角必须轮询配置中的所有Octopus服务器。您可以轮询一个负载平衡器，但是根据您的负载平衡器配置，存在一个风险，即触手不会立即轮询所有服务器。</p>

<p>您还可以将触手配置为轮询每个服务器，方法是将它注册到您的一个Octopus服务器，然后将每个Octopus服务器添加到触手. config文件中。添加Octopus服务器有两种选择，通过命令行或直接编辑触手. config文件:</p>

<p><strong>触手. config </strong></p>

<p>通过命令行配置触手是首选选项，每个服务器只执行一次命令。下面是使用默认实例的命令示例:</p>

<pre><code class="language-powershell">C:\Program Files\Octopus Deploy\Tentacle&gt;Tentacle poll-server --server=http://my.Octopus.server --apikey=API-77751F90F9EEDCEE0C0CD84F7A3CC726AD123FA6
</code></pre>

<p>有关该命令的更多信息，请参考<a href="https://octopus.com/docs/octopus-rest-api/tentacle.exe-command-line/poll-server">触手轮询服务器选项文档</a>。</p>

<p>或者，可以直接编辑Tentacle.config来添加每个Octopus服务器(这被解释为服务器的JSON数组)。不建议使用此方法，因为每台服务器的Octopus服务都需要重新启动，以通过此方法接受传入连接:</p>

<pre><code class="language-xml">&lt;set key="Tentacle.Communication.TrustedOctopusServers"&gt;
[
  {"Thumbprint":"77751F90F9EEDCEE0C0CD84F7A3CC726AD123FA6","CommunicationStyle":2,"Address":"https://10.0.255.160:10943","Squid":null,"SubscriptionId":"poll://g3662re9njtelsyfhm7t/"},
  {"Thumbprint":"77751F90F9EEDCEE0C0CD84F7A3CC726AD123FA6","CommunicationStyle":2,"Address":"https://10.0.255.161:10943","Squid":null,"SubscriptionId":"poll://g3662re9njtelsyfhm7t/"},
  {"Thumbprint":"77751F90F9EEDCEE0C0CD84F7A3CC726AD123FA6","CommunicationStyle":2,"Address":"https://10.0.255.162:10943","Squid":null,"SubscriptionId":"poll://g3662re9njtelsyfhm7t/"}
]
&lt;/set&gt;
</code></pre>

<p>请注意，在高可用性配置中，每个Octopus服务器都有一个地址条目。根据您的配置和网络拓扑，您可以为每个Octopus节点使用私有IP或公共IP和/或FQDN。以下示例显示了在端口<strong> 10943 </strong>上注册到<strong>octo1.domain.com</strong>、<strong>octo2.domain.com</strong>和<strong>octo3.domain.com</strong>的情况:</p>

<pre><code class="language-xml">&lt;set key="Tentacle.Communication.TrustedOctopusServers"&gt;
[
  {"Thumbprint":"77751F90F9EEDCEE0C0CD84F7A3CC726AD123FA6","CommunicationStyle":2,"Address":"https://octo1.domain.com:10943","Squid":null,"SubscriptionId":"poll://g3662re9njtelsyfhm7t/"},
  {"Thumbprint":"77751F90F9EEDCEE0C0CD84F7A3CC726AD123FA6","CommunicationStyle":2,"Address":"https://octo2.domain.com:10943","Squid":null,"SubscriptionId":"poll://g3662re9njtelsyfhm7t/"},
  {"Thumbprint":"77751F90F9EEDCEE0C0CD84F7A3CC726AD123FA6","CommunicationStyle":2,"Address":"https://octo3.domain.com:10943","Squid":null,"SubscriptionId":"poll://g3662re9njtelsyfhm7t/"}
]
&lt;/set&gt;
</code></pre>

<p>在以下示例中，我使用公共IP，而不是FQDN或私有IP:</p>

<pre><code class="language-xml">&lt;set key="Tentacle.Communication.TrustedOctopusServers"&gt;
[
  {"Thumbprint":"77751F90F9EEDCEE0C0CD84F7A3CC726AD123FA6","CommunicationStyle":2,"Address":"https://1.2.3.4:10943","Squid":null,"SubscriptionId":"poll://g3662re9njtelsyfhm7t/"},
  {"Thumbprint":"77751F90F9EEDCEE0C0CD84F7A3CC726AD123FA6","CommunicationStyle":2,"Address":"https://1.2.3.5:10943","Squid":null,"SubscriptionId":"poll://g3662re9njtelsyfhm7t/"},
  {"Thumbprint":"77751F90F9EEDCEE0C0CD84F7A3CC726AD123FA6","CommunicationStyle":2,"Address":"https://1.2.3.6:10943","Squid":null,"SubscriptionId":"poll://g3662re9njtelsyfhm7t/"}
]
&lt;/set&gt;
</code></pre>

<h2 id="migration">移民</h2>

<p>如果您正在将Octopus的一个实例迁移到Azure，我们推荐的方法是:</p>

<ul>
<li>建立基础设施。</li>
<li>设置Octopus文件夹和存储位置。</li>
<li>运行高可用性Octopus安装。</li>
<li>对新实例进行概念验证。</li>
<li>测试身份验证和部署。</li>
<li>确认后计划生产移动。</li>
<li>计划停机时间。</li>
<li>使用<a href="https://octopus.com/docs/administration/managing-infrastructure/moving-your-octopus/move-the-database-and-server">移动Octopus服务器和数据库</a>进行迁移。</li>
<li>切换到新的Azure设置。</li>
</ul>

<h2 id="conclusion">结论</h2>

<p>尽管Azure中的高可用性非常简单，但是在从内部部署迁移到Azure托管Octopus Deploy时，需要考虑很多问题。在这篇博客中，我解释并推荐了一些可以使用的技术，以帮助您在Microsoft Azure上配置Octopus高可用性。</p>

<p>我希望这些技巧能让在微软Azure上设置Octopus高可用性变得更容易。</p>

<p>愉快的部署！</p>

                    
                    
</body>
</html>