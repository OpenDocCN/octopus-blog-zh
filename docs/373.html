<html>
<head>
<title>Running unit tests in Jenkins - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>在Jenkins - Octopus部署中运行单元测试</h1>
<blockquote>原文：<a href="https://octopus.com/blog/jenkins-running-unit-tests#2022-05-19">https://octopus.com/blog/jenkins-running-unit-tests#2022-05-19</a></blockquote>
                        <p>在典型的开发工作流中，用单元测试验证代码变更是一个关键的过程。Jenkins提供了许多插件来收集和处理测试结果，允许开发人员浏览结果，调试失败的测试，忽略一些测试失败，并生成关于测试历史的报告。</p>

<p>在本文中，您将学习如何向Jenkins项目添加单元测试，并配置插件来处理结果。</p>

<h2 id="prerequisites">先决条件</h2>

<p>要跟进这篇文章，您需要一个Jenkins实例。<a href="https://octopus.com/blog/jenkins-install-guide-windows-linux">传统詹金斯安装</a>、<a href="https://octopus.com/blog/jenkins-docker-install-guide">码头工人詹金斯安装</a>或<a href="https://octopus.com/blog/jenkins-helm-install-guide">赫尔姆詹金斯安装</a>指南提供了在您选择的环境中安装詹金斯的说明。</p>

<p>您将构建的示例应用程序是用Java和DotNET Core编写的，因此Java开发工具包(JDK)和DotNET Core SDK必须安装在执行构建的Jenkins控制器或代理上。</p>

<p>你可以从<a href="https://dotnet.microsoft.com/download/dotnet/3.1" rel="nofollow">微软网站</a>找到关于安装DotNET Core SDK的说明。示例项目是针对DotNET Core 3.1编写的。</p>

<p>OpenJDK项目(及其下游项目)提供了免费的开源发行版，可以用来编译Java应用程序。有许多OpenJDK发行版可供选择，包括:</p>



<p>我通常使用Azul Zulu发行版，尽管任何发行版都可以。</p>

<h2 id="unit-testing-in-java">Java中的单元测试</h2>

<p>Java有很多单元测试框架，但是最流行的是<a href="https://junit.org" rel="nofollow"> JUnit </a>。</p>

<p>您将使用<a href="https://github.com/OctopusSamples/RandomQuotes-Java" rel="nofollow"> Random Quotes </a>示例应用程序来演示在Jenkins项目中运行的JUnit测试。</p>

<h3 id="installing-the-jenkins-plugin">安装Jenkins插件</h3>

<p>您必须安装<a href="https://plugins.jenkins.io/junit/" rel="nofollow"> JUnit </a>插件来处理JUnit测试的结果。</p>

<p>要安装插件:</p>

<ol>
<li>点击<strong>管理詹金斯</strong>，然后<strong>管理插件</strong>，然后<strong>可用</strong>。</li>
<li>在搜索框中输入<code>junit</code>。</li>
<li>选择<strong> JUnit </strong>选项，点击<strong>不重启安装</strong>:</li>
</ol>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-02/jenkins-running-unit-tests/junit-plugin.png" class="zoom" data-title=""><img src="../Images/76d4678abcacea56bd4f270f08a94420.png" class="img-fluid center" alt="Junit Plugin" data-original-src="https://i.octopus.com/blog/2022-02/jenkins-running-unit-tests/junit-plugin.png"/>T2】</a></p>

<h3 id="creating-the-pipeline-project-in-jenkins">在詹金斯创建管道项目</h3>

<p>创建新的管道项目，点击<strong>新建项目</strong>，输入项目名称<code>RandomQuotes-Java</code>，选择<strong>管道</strong>选项，点击<strong>确定</strong>按钮:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-02/jenkins-running-unit-tests/java-project.png" class="zoom" data-title=""><img src="../Images/3fda3e19517c2b48e343cc11091ba67c.png" class="img-fluid center" alt="New Java Project" data-original-src="https://i.octopus.com/blog/2022-02/jenkins-running-unit-tests/java-project.png"/>T2】</a></p>

<p>将以下管道脚本粘贴到<strong>管道</strong>部分，点击<strong>保存</strong>按钮:</p>

<pre><code class="language-groovy">pipeline {
  // This pipeline requires the following plugins:
  // * Git: https://plugins.jenkins.io/git/
  // * Workflow Aggregator: https://plugins.jenkins.io/workflow-aggregator/
  // * JUnit: https://plugins.jenkins.io/junit/
  agent 'any'
  stages {
    stage('Checkout') {
      steps {
        script {
            checkout([$class: 'GitSCM', branches: [[name: '*/master']], userRemoteConfigs: [[url: 'https://github.com/OctopusSamples/RandomQuotes-Java.git']]])
        }
      }
    }
    stage('Test') {
      steps {
        sh(script: './mvnw --batch-mode -Dmaven.test.failure.ignore=true test')

      }
    }
    stage('Package') {
      steps {
        sh(script: './mvnw --batch-mode package -DskipTests')
      }
    }
  }
  post {
    always {
      junit(testResults: 'target/surefire-reports/*.xml', allowEmptyResults : true)
    }
  }
}
</code></pre>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-02/jenkins-running-unit-tests/pipeline.png" class="zoom" data-title=""><img src="../Images/d4556230c8437eca909dc4dc4f675e97.png" class="img-fluid center" alt="Jenkins Pipeline" data-original-src="https://i.octopus.com/blog/2022-02/jenkins-running-unit-tests/pipeline.png"/>T2】</a></p>

<p><code>Test</code>阶段包含一个运行maven <code>test</code>目标的步骤，通过<code>--batch-mode</code>以避免显示每个正在下载的依赖项的不必要的日志记录，通过<code>-Dmaven.test.failure.ignore=true</code>以允许该步骤成功通过，即使有失败的测试。</p>

<pre><code class="language-groovy">sh(script: './mvnw --batch-mode -Dmaven.test.failure.ignore=true test')
</code></pre>

<p><code>post</code>部分包含<code>always</code>条件块，它用JUnit插件处理测试结果:</p>

<pre><code class="language-groovy">junit(testResults: 'target/surefire-reports/*.xml', allowEmptyResults : true)
</code></pre>

<p><code>Package</code>阶段打包应用程序，同时跳过任何带有<code>-DskipTests</code>参数的测试，因为测试是在前一阶段处理的:</p>

<pre><code class="language-groovy">sh(script: './mvnw --batch-mode -Dmaven.test.skip=true clean package', returnStdout: true)
</code></pre>

<p><strong>测试结果趋势</strong>图跟踪项目历史中通过、失败和跳过的测试:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-02/jenkins-running-unit-tests/test-result-trend.png" class="zoom" data-title=""> T31 </a></p>

<h2 id="unit-testing-in-dotnet-core">DotNET核心中的单元测试</h2>

<p>DotNET Core有许多流行的单元测试框架，包括MSTest、NUnit和xUnit。您将使用<a href="https://github.com/OctopusSamples/RandomQuotes" rel="nofollow"> RandomQuotes </a>示例应用程序来演示从Jenkins管道运行NUnit测试。</p>

<h3 id="installing-the-jenkins-plugin-1">安装Jenkins插件</h3>

<p>使用<a href="https://plugins.jenkins.io/mstest/" rel="nofollow"> MSTest </a>插件处理DotNET核心测试结果。</p>

<p>安装<a href="https://plugins.jenkins.io/mstest/" rel="nofollow"> MSTest </a>插件，处理NUnit测试的结果。要安装插件:</p>

<ol>
<li>单击<strong>管理Jenkins </strong>，然后单击<strong>管理插件</strong>，然后单击<strong>可用</strong>。</li>
<li>在搜索框中输入<code>mstest</code>。</li>
<li>选择<strong> MSTest </strong>选项，点击<strong>不重启安装</strong>:</li>
</ol>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-02/jenkins-running-unit-tests/mstest-plugin.png" class="zoom" data-title=""><img src="../Images/3d80d701bd0d8398440d392aa1b4307f.png" class="img-fluid center" alt="MSTest Plugin" data-original-src="https://i.octopus.com/blog/2022-02/jenkins-running-unit-tests/mstest-plugin.png"/>T2】</a></p>

<h3 id="creating-the-pipeline-project-in-jenkins-1">在詹金斯创建管道项目</h3>

<p>要新建管道项目，点击<strong>新建项目</strong>，输入<code>RandomQuotes-DotNET</code>作为项目名称，选择<strong>管道</strong>选项，点击<strong>确定</strong>按钮:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-02/jenkins-running-unit-tests/dotnet-project.png" class="zoom" data-title=""><img src="../Images/6c166ec6cb3da2dcb5a467d525e340cf.png" class="img-fluid center" alt="New DotNET Project" data-original-src="https://i.octopus.com/blog/2022-02/jenkins-running-unit-tests/dotnet-project.png"/>T2】</a></p>

<p>将以下管道脚本粘贴到<strong>管道</strong>部分，点击<strong>保存</strong>按钮:</p>

<pre><code class="language-groovy">pipeline {
  // This pipeline requires the following plugins:
  // * Git: https://plugins.jenkins.io/git/
  // * Workflow Aggregator: https://plugins.jenkins.io/workflow-aggregator/
  // * MSTest: https://plugins.jenkins.io/mstest/
  agent 'any'
  stages {
    stage('Environment') {
      steps {
          echo "PATH = ${PATH}"
      }
    }
    stage('Checkout') {
      steps {

        script {
            checkout([$class: 'GitSCM', branches: [[name: '*/master']], userRemoteConfigs: [[url: 'https://github.com/OctopusSamples/RandomQuotes.git']]])
        }
      }
    }
    stage('Dependencies') {
      steps {
        sh(script: 'dotnet restore')
      }
    }
    stage('Build') {
      steps {
        sh(script: 'dotnet build --configuration Release', returnStdout: true)
      }
    }
    stage('Test') {
      steps {
        sh(script: 'dotnet test -l:trx || true')        
      }
    }
  }
  post {
    always {
      mstest(testResultsFile: '**/*.trx', failOnError: false, keepLongStdio: true)
    }
  }
}
</code></pre>

<p><code>Test</code>阶段调用<code>dotnet test</code>运行单元测试，通过参数<code>-l:trx</code>将测试结果写入Visual Studio Test Results (TRX)文件。</p>

<p>如果任何测试失败，该命令将返回非零退出代码。为了确保在测试失败的情况下继续处理管道，如果<code>dotnet test</code>表示失败，则返回<code>true</code>:</p>

<pre><code class="language-bash">sh(script: 'dotnet test -l:trx || true')
</code></pre>

<p>然后使用<code>post</code>部分的MSTest插件处理测试结果:</p>

<pre><code class="language-bash">mstest(testResultsFile: '**/*.trx', failOnError: false, keepLongStdio: true)
</code></pre>

<h2 id="how-to-handle-failed-tests">如何处理失败的测试</h2>

<p>到目前为止，您只运行了具有成功测试的构建。要模拟失败的测试，修改<code>Checkout</code>阶段，指向Java Random Quotes应用程序的<code>failing-test</code>分支:</p>

<pre><code class="language-groovy">pipeline {
  // This pipeline requires the following plugins:
  // * Git: https://plugins.jenkins.io/git/
  // * Workflow Aggregator: https://plugins.jenkins.io/workflow-aggregator/
  // * JUnit: https://plugins.jenkins.io/junit/
  agent 'any'
  stages {
    stage('Checkout') {
      steps {
        script {
            checkout([$class: 'GitSCM', branches: [[name: '*/failing-test']], userRemoteConfigs: [[url: 'https://github.com/OctopusSamples/RandomQuotes-Java.git']]])
        }
      }
    }
    stage('Test') {
      steps {
        sh(script: './mvnw --batch-mode -Dmaven.test.failure.ignore=true test')
      }
    }
    stage('Package') {
      steps {
        sh(script: './mvnw --batch-mode package -DskipTests')
      }
    }
  }
  post {
    always {
      junit(testResults: 'target/surefire-reports/*.xml', allowEmptyResults : true)
    }
  }
}
</code></pre>

<p>这个分支有总是失败的测试。来自该分支的构建被标记为不稳定，并且<strong>测试结果趋势</strong>图显示新的失败测试:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-02/jenkins-running-unit-tests/failing-test.png" class="zoom" data-title=""><img src="../Images/9cff9a3869dae5865aa6bfcaffdadf8c.png" class="img-fluid center" alt="Failing Tests" data-original-src="https://i.octopus.com/blog/2022-02/jenkins-running-unit-tests/failing-test.png"/>T2】</a></p>

<p>要查看测试的详细信息，请单击构建任务并单击<strong>测试结果</strong>链接。在这里，您可以深入每个测试，查看测试结果，并查看日志:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-02/jenkins-running-unit-tests/test-result.png" class="zoom" data-title=""><img src="../Images/87dfd55ed46b2983aeffa4567944043f.png" class="img-fluid center" alt="Test results" data-original-src="https://i.octopus.com/blog/2022-02/jenkins-running-unit-tests/test-result.png"/>T2】</a></p>

<h3 id="claiming-failed-tests">声称测试失败</h3>

<p>上面的示例管道在一定程度上允许在测试失败时构建成功。这确保了即使测试失败，测试结果也能被JUnit或MSTest插件处理。然而，预计测试失败仍然由工程团队解决。<a href="https://plugins.jenkins.io/claim/" rel="nofollow"> Claim </a>插件为Jenkins用户提供了为失败的测试负责的能力。</p>

<p>下面的管道允许声明失败的测试:</p>

<pre><code class="language-groovy">pipeline {
  // This pipeline requires the following plugins:
  // * Git: https://plugins.jenkins.io/git/
  // * Workflow Aggregator: https://plugins.jenkins.io/workflow-aggregator/
  // * JUnit: https://plugins.jenkins.io/junit/
  // * Claim: https://plugins.jenkins.io/claim/
  agent 'any'
  options{
    // This option allows broken builds to be claimed
    allowBrokenBuildClaiming()
  }
  stages {
    stage('Checkout') {
      steps {
        script {
            checkout([$class: 'GitSCM', branches: [[name: '*/failing-test']], userRemoteConfigs: [[url: 'https://github.com/OctopusSamples/RandomQuotes-Java.git']]])
        }
      }
    }
    stage('Test') {
      steps {
        sh(script: './mvnw --batch-mode -Dmaven.test.failure.ignore=true test')
      }
    }
    stage('Package') {
      steps {
        sh(script: './mvnw --batch-mode package -DskipTests')
      }
    }
  }
  post {
    always {
      // The testDataPublishers argument allows failed tests to be claimed
      junit(testDataPublishers: [[$class: 'ClaimTestDataPublisher']], testResults: 'target/surefire-reports/*.xml', allowEmptyResults : true)
    }
  }
}
</code></pre>

<p>失败的测试可以通过<strong>测试结果</strong>屏幕来声明:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-02/jenkins-running-unit-tests/claim-test.png" class="zoom" data-title=""><img src="../Images/a9f3464b5a72675324b0119abff93df0.png" class="img-fluid center" alt="Claim Test" data-original-src="https://i.octopus.com/blog/2022-02/jenkins-running-unit-tests/claim-test.png"/>T2】</a></p>

<p>打开<strong>索赔报告</strong>链接，可以找到所有索赔的全球报告:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-02/jenkins-running-unit-tests/claim-report.png" class="zoom" data-title=""><img src="../Images/55a073d0c7977290b0225dd0b53cbed4.png" class="img-fluid center" alt="Claim Report" data-original-src="https://i.octopus.com/blog/2022-02/jenkins-running-unit-tests/claim-report.png"/>T2】</a></p>

<h3 id="failing-the-build-when-tests-fail">当测试失败时，构建失败</h3>

<p>您可能要求构建失败，而不是在测试失败时被标记为不稳定。您通常有两种选择来实现这一点:</p>

<ul>
<li>测试命令失败</li>
<li>测试处理失败</li>
</ul>

<h4 id="failing-the-test-command">测试命令失败</h4>

<p>第一个选项允许运行测试的命令失败。如果测试失败，大多数测试运行者会返回一个非零的退出代码，这反过来会导致构建失败。</p>

<p>您可以使用下面的Maven命令执行测试，并在失败时返回一个非零的退出代码。没有<code>-Dmaven.test.failure.ignore=true</code>参数会将命令恢复为默认行为:</p>

<pre><code class="language-bash">sh(script: './mvnw --batch-mode test')
</code></pre>

<p>如果任何测试失败，下面的DotNET Core命令也会返回非零退出代码。<code>|| true</code>命令链的缺失确保了返回<code>dotnet</code>退出代码:</p>

<pre><code class="language-bash">sh(script: 'dotnet test -l:trx') 
</code></pre>

<h4 id="failing-the-test-processing">测试处理失败</h4>

<p>第二个选项允许测试处理器确定构建是否失败。</p>

<p>MSTest插件提供了<code>failOnError</code>参数，用于在任何测试失败时使该步骤失败:</p>

<pre><code class="language-groovy">mstest(testResultsFile: '**/*.trx', failOnError: true, keepLongStdio: true)
</code></pre>

<p>不幸的是，<a href="https://issues.jenkins.io/browse/JENKINS-2734?page=com.atlassian.jira.plugin.system.issuetabpanels%3Aall-tabpanel" rel="nofollow">JUnit插件不具备基于测试结果</a>使构建失败的能力。</p>

<p>另一种方法是使用<a href="https://plugins.jenkins.io/xunit/" rel="nofollow"> xUnit插件</a>，它支持跳过和失败测试的阈值。</p>

<p>下面的示例管道用xUnit替换了JUnit插件:</p>

<pre><code class="language-groovy">pipeline {
  // This pipeline requires the following plugins:
  // * Git: https://plugins.jenkins.io/git/
  // * Workflow Aggregator: https://plugins.jenkins.io/workflow-aggregator/
  // * xUnit: https://plugins.jenkins.io/xunit/
  // * Claim: https://plugins.jenkins.io/claim/
  agent 'any'
  options {
    allowBrokenBuildClaiming()
  }
  stages {
    stage('Checkout') {
      steps {
        script {
            checkout([$class: 'GitSCM', branches: [[name: '*/failing-test']], userRemoteConfigs: [[url: 'https://github.com/OctopusSamples/RandomQuotes-Java.git']]])
        }
      }
    }
    stage('Test') {
      steps {
        sh(script: './mvnw --batch-mode -Dmaven.test.failure.ignore=true test')
      }
    }
    stage('Package') {
      steps {
        sh(script: './mvnw --batch-mode package -DskipTests')
      }
    }
  }
  post {
    always {
      xunit (testDataPublishers: [[$class: 'ClaimTestDataPublisher']], thresholds: [ skipped(failureThreshold: '0'), failed(failureThreshold: '0')], tools: [[$class: 'JUnitType', pattern: '**/surefire-reports/*.xml']])
    }
  }
}
</code></pre>

<p>下面的示例管道用xUnit替换了MSTest插件:</p>

<pre><code class="language-groovy">pipeline {
  // This pipeline requires the following plugins:
  // * Git: https://plugins.jenkins.io/git/
  // * Workflow Aggregator: https://plugins.jenkins.io/workflow-aggregator/
  // * xUnit: https://plugins.jenkins.io/xunit/
  // * Claim: https://plugins.jenkins.io/claim/
  agent 'any'
  options {
    allowBrokenBuildClaiming()
  }
  stages {
    stage('Environment') {
      steps {
          echo "PATH = ${PATH}"
      }
    }
    stage('Checkout') {
      steps {

        script {
            checkout([$class: 'GitSCM', branches: [[name: '*/failing-tests']], userRemoteConfigs: [[url: 'https://github.com/OctopusSamples/RandomQuotes.git']]])
        }
      }
    }
    stage('Dependencies') {
      steps {
        sh(script: 'dotnet restore')
      }
    }
    stage('Build') {
      steps {
        sh(script: 'dotnet build --configuration Release', returnStdout: true)
      }
    }
    stage('Test') {
      steps {
        sh(script: 'dotnet test -l:trx || true')
      }
    }
  }
  post {
    always {
      xunit (testDataPublishers: [[$class: 'ClaimTestDataPublisher']], thresholds: [ skipped(failureThreshold: '0'), failed(failureThreshold: '0')], tools: [[$class: 'MSTestJunitHudsonTestType', pattern: '**/*.trx']])
    }
  }
}
</code></pre>

<h2 id="conclusion">结论</h2>

<p>单元测试在大多数大型代码库中都很常见。通过在Jenkins中执行单元测试，开发团队拥有了一个报告当前和历史测试结果的真实的中心来源。</p>

<p>在这篇文章中，你学到了:</p>

<ul>
<li>如何在Java和DotNET核心代码库中运行测试</li>
<li>如何使用JUnit、MSTest和xUnit插件收集和处理测试结果</li>
<li>如何允许Jenkins用户声称测试失败，以表明他们将对这些测试负责</li>
<li>当测试失败时，如何使构建失败</li>
</ul>

<p><a href="https://oc.to/JenkinsPipelineGenerator" rel="nofollow">试试我们免费的Jenkins管道生成器工具</a>，用Groovy语法创建一个管道文件。这是您启动管道项目所需的一切。</p>

<h2 id="watch-our-jenkins-pipeline-webinar">观看我们的詹金斯管道网络研讨会</h2>

<iframe src="https://www.youtube.com/embed/D_7AHTML_xw" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen="">VIDEO</iframe>

<p>我们定期举办网络研讨会。请参见<a href="https://octopus.com/events">网络研讨会第</a>页，了解有关即将举办的活动和直播录像的详细信息。</p>

<p>阅读我们的<a href="https://octopus.com/blog/tag/CI%20Series">持续集成系列</a>的其余部分。</p>

<p>愉快的部署！</p>

                    
                    
</body>
</html>