<html>
<head>
<title>Deploy .NET Core applications to a Raspberry Pi with Octopus - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>展开。NET核心应用程序到带有Octopus - Octopus部署的Raspberry Pi</h1>
<blockquote>原文：<a href="https://octopus.com/blog/deploying-an-octopus-pi#2022-07-07">https://octopus.com/blog/deploying-an-octopus-pi#2022-07-07</a></blockquote>
                        <p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-06/deploying-an-octopus-pi/blogimage-raspberrypi.png" class="zoom" data-title=""><img src="../Images/12d3bbba58d4f55ead162389140baeea.png" class="img-fluid center" alt="Octopus enjoying a Raspberry Pi" data-original-src="https://i.octopus.com/blog/2020-06/deploying-an-octopus-pi/blogimage-raspberrypi.png"/>T2】</a></p>

<p><strong>更新2020年2月</strong> <br/> <em>开箱</em>对Linux ARM和Linux ARM64 SSH目标的支持分别包含在<em>章鱼服务器2019.11.2 </em>和<em> 2020.2.0 </em>中。</p>


<p>这篇文章最初发表于2018年2月，但后来发生了一些变化，这是原始文章的更新版本。</p>

<p>。NET Core在过去的几年里取得了长足的进步，Octopus Deploy也是如此。我们最近增加了在没有Mono 的情况下运行<a href="https://octopus.com/blog/octopus-release-3-16#ssh-targets-sans-mono"> Calamari的支持，在这篇文章中，我将向你介绍如何部署。NET核心应用程序到一个没有Mono的Raspberry Pi 3+上。</a></p>

<p>在这篇文章中，我将向您展示部署和运行是可能的。NET核心应用程序，我还将描述一些与Octopus Deploy服务器交互的不同方式。</p>

<h2 id="requirements-before-you-start">开始前的要求</h2>

<ul>
<li>编辑:Visual Studio，Visual Studio代码，Rider。</li>
<li><a href="https://octopus.com/downloads">章鱼命令行</a>。</li>
<li><a href="https://octopus.com/downloads">章鱼服务器</a>和一个<a href="https://octopus.com/docs/octopus-rest-api/how-to-create-an-api-key"> API密匙</a>。</li>
<li>。网芯:<a href="https://www.microsoft.com/net/download/windows" rel="nofollow"> Windows </a>或者<a href="https://www.microsoft.com/net/download/macos" rel="nofollow"> Macos </a>。</li>
<li>一个树莓Pi 3+运行<a href="https://www.raspberrypi.org/downloads/raspbian/" rel="nofollow"> Raspbian </a>与。NET core 2.0或更高版本运行时<a href="https://github.com/dotnet/core/blob/master/samples/RaspberryPiInstructions.md" rel="nofollow">已安装</a>:</li>
<li>对于角度或反作用应用:<ul>
<li>如果您选择的应用程序需要的话(angular或react)，您的开发机器上的节点和npm。</li>
<li>pi上的node.js</li>
</ul>
</li>
<li><a href="https://curl.haxx.se/download.html" rel="nofollow">卷曲</a></li>
</ul>

<p>ASP.NET在其捆绑包中包含了NodeServices，这要求在它能够服务任何请求之前安装Node。当你在Raspberry Pi上安装Node.js时，它会安装4.x版本，可执行文件名为<code>nodejs</code>，但是NodeServices会在你的路径中寻找<code>node</code>。您可以通过创建符号链接来解决这个问题:</p>
<pre><code class="language-Bash">sudo ln -s /usr/bin/nodejs /usr/bin/node
</code></pre>


<h2 id="build-the-application">构建应用程序</h2>

<h3 id="create-a-basic.net-core-application">创建一个基本的。网络核心应用</h3>

<pre><code class="language-powershell">dotnet new angular
</code></pre>

<h3 id="modify-the-application-to-listen-for-external-requests">修改应用程序以侦听外部请求</h3>

<p>默认情况下，ASP.NET核心应用程序将只为<code>http://localhost:5000</code>的请求提供服务。要允许web主机向您的本地网络提供请求，请在<code>Program.cs</code>中的<code>.UseStartup&lt;Startup&gt;()</code>后添加以下内容:</p>

<pre><code class="language-c#">.UseKestrel(options =&gt; {
    options.Listen(System.Net.IPAddress.Any, 5000);
})
</code></pre>

<p>有关配置Kestrel Web主机的更多信息，请查看<a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/servers/kestrel?tabs=aspnetcore2x" rel="nofollow">文档</a>。</p>

<h3 id="build-the-application-1">构建应用程序</h3>

<pre><code class="language-powershell">npm install
dotnet build
mkdir publish
dotnet publish -o publish --self-contained -r linux-arm
</code></pre>

<p>如果您的目标是在Raspberry Pi上支持64位的发行版，请将<code>linux-arm</code>替换为<code>linux-arm64</code></p>


<h3 id="package-the-application">打包应用程序</h3>

<p>创建. NET核心应用程序包的最简单方法是使用Octopus CLI工具。</p>

<p>创建一个<code>artifacts</code>目录，然后使用<code>octo pack</code>命令创建包:</p>

<pre><code class="language-powershell">mkdir artifacts
octo pack --id core4pi --version 1.0.0 --format zip --outFolder artifacts --basePath publish
</code></pre>

<p>再次使用Octopus CLI，将包推送到服务器:</p>

<pre><code class="language-powershell">octo push --server http://octopus/ --apikey API-ABCDEF123456 --package artifacts\core4pi.1.0.0.zip
</code></pre>

<h2 id="building-a-service-definition">构建服务定义</h2>

<p>要让应用程序作为服务运行，请参阅微软关于<a href="https://docs.microsoft.com/en-au/aspnet/core/host-and-deploy/linux-nginx?tabs=aspnetcore2x" rel="nofollow">托管的文档。Linux上的NET Core</a>。</p>

<p>创建一个名为<code>core4pi.service</code>的文件，包含以下文本:</p>

<pre><code class="language-text">[Unit]
Description=core4pi

[Service]
WorkingDirectory=#{Octopus.Action[deploy web site].Output.Package.InstallationDirectoryPath}
ExecStart=/usr/local/bin/dotnet "#{Octopus.Action[deploy web site].Output.Package.InstallationDirectoryPath}/core4pi.dll"
Restart=always
RestartSec=10
User=pi
Environment=ASPNETCORE_ENVIRONMENT=Production
Environment=DOTNET_PRINT_TELEMETRY_MESSAGE=false

[Install]
WantedBy=multi-user.target
</code></pre>

<p>上面的<code>core4pi.service</code>文本中的<code>[deploy web site]</code>字符串表示部署包的步骤的名称。<br/>该输出变量将包含新安装服务的路径。这将确保在安装服务时，它看到的是最新版本。</p>


<p>为服务定义创建一个包，并将其推送到Octopus服务器:</p>

<pre><code class="language-powershell">octo pack --id core4pi.service --version 1.0.0 --format zip --outFolder artifacts
octo push --server http://octopus/ --apikey API-ABCDEF123456 --package artifacts\core4pi.service.1.0.0.zip
</code></pre>

<h2 id="create-infrastructure">创建基础设施</h2>

<p>如果您还没有为您的Raspberry Pi配置Octopus环境，请在命令行中创建一个:</p>

<pre><code class="language-powershell">octo create-environment --server http://octopus/ --apikey API-ABCDEF123456 --name "Pi Dev"
</code></pre>

<p>或者通过<strong> <span class="path">基础设施使用web界面➜环境➜添加环境</span> </strong>。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-06/deploying-an-octopus-pi/create-new-environment.png" class="zoom" data-title=""><img src="../Images/761f7345c4ade4226955cc31983a7230.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2020-06/deploying-an-octopus-pi/create-new-environment.png"/>T2】</a></p>

<p>接下来，创建一个访问Pi的帐户，该帐户可以是用户名/密码帐户，也可以是Octopus门户网站中** <span class="path">基础设施➜帐户</span>* *部分的SSH密钥。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-06/deploying-an-octopus-pi/pi-account.png" class="zoom" data-title=""><img src="../Images/183b8c6d4622b5ca32975aca9bad63dd.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2020-06/deploying-an-octopus-pi/pi-account.png"/>T2】</a></p>

<p>最后，在<strong> <span class="path">基础设施➜部署目标下创建一个部署目标➜添加部署目标</span> </strong>作为<strong> SSH目标</strong>。</p>

<p>将目标角色设置为代表目标职责的东西，例如<code>PiWeb</code>。</p>

<p>添加详细信息(IP地址或DNS名称、SSH端口和帐户)后，在<strong>下。NET </strong>部分，确保选择<em>单声道未安装</em>，并选择<code>linux-arm</code>或<code>linux-arm64</code>作为平台。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-06/deploying-an-octopus-pi/dotnet-not-mono.png" class="zoom" data-title=""><img src="../Images/7a3bbd24794f741ac235ee4f5b1f1215.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2020-06/deploying-an-octopus-pi/dotnet-not-mono.png"/>T2】</a></p>

<p/>

<h2 id="create-the-deployment-project">创建部署项目</h2>

<p>通过Octopus门户网站的<strong>项目</strong>部分或命令行创建一个新项目:</p>

<pre><code class="language-powershell">octo create-project --server http://octopus/ --apikey API-ABCDEF123456 --name "PiWeb" --projectgroup "All projects" --lifecycle "Default Lifecycle"
</code></pre>

<h3 id="create-a-deployment-step-for-the-application">为应用程序创建部署步骤</h3>

<p>在新的<strong> PiWeb </strong>项目中，定义您的部署过程。</p>

<p>添加一个<strong>部署一个包</strong>的步骤，称为<code>deploy web site</code>。</p>

<p>此处的步骤名称将允许正确更新服务定义文件中的值。</p>


<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-06/deploying-an-octopus-pi/deploy-package-step-library.png" class="zoom" data-title=""><img src="../Images/37099475af93d16098008323e6078ae4.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2020-06/deploying-an-octopus-pi/deploy-package-step-library.png"/>T2】</a></p>

<p>将<strong>环境</strong>设置为<code>Pi Dev</code>环境。</p>

<p>将<strong>角色</strong>设置为<code>PiWeb</code>角色。</p>

<p>在<strong>包</strong>部分，选择您推送给服务器的包:<code>core4pi</code>。</p>

<p>我们不需要完成其他选项，因此请保存该步骤。</p>

<h3 id="create-a-deployment-step-for-the-service-definition">为服务定义创建部署步骤</h3>

<p>添加另一个<strong>部署一个包</strong>的步骤。这将在目标上安装一个服务来运行应用程序。</p>

<p>对于包选择，从<strong> Octopus服务器(内置)</strong>包馈送中选择<code>core4pi.service</code>包。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-06/deploying-an-octopus-pi/service-installation-step.png" class="zoom" data-title=""><img src="../Images/453889b9736a686a3a6615cbf9447a80.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2020-06/deploying-an-octopus-pi/service-installation-step.png"/>【T38】T2】</a></p>

<p>对于这一步，您需要<code>Configure Features</code>:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-06/deploying-an-octopus-pi/feature-configuration.png" class="zoom" data-title=""><img src="../Images/0c242a5f3986efd1e6aed470fd165eee.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2020-06/deploying-an-octopus-pi/feature-configuration.png"/>T2】</a></p>

<p>在<strong>文件中替换变量</strong>功能中添加服务定义文件的名称<code>core4pi.service</code>:</p>

<p>【T2 <img src="../Images/f0e6a1c30e69448f2f95007fb8af6f9a.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2020-06/deploying-an-octopus-pi/substitute-variables-in-service.png"/></p>

<p>在<code>Configuration Scripts</code>特性下，选择<strong> Bash </strong>，将下面的脚本粘贴到<strong>部署脚本</strong>部分:</p>

<pre><code class="language-bash">#!/bin/bash
if [ -e /lib/systemd/system/core4pi.service ]
then
    echo stopping service
    sudo systemctl stop core4pi.service
fi

echo installing service
sudo cp core4pi.service /lib/systemd/system/
sudo chmod 644 /lib/systemd/system/core4pi.service
sudo systemctl daemon-reload
sudo systemctl enable core4pi.service
echo starting service
sudo systemctl start core4pi.service
</code></pre>

<p>该脚本执行服务安装，并将在步骤执行期间执行。它将要求您用来连接到Raspberry Pi的用户拥有<code>sudo</code>权限。</p>

<h2 id="deploy-it">部署它</h2>

<p>从<strong>项目</strong>导航菜单中，选择<strong>创建发布</strong>。</p>

<p><strong>创建版本</strong>页面将允许您设置版本号，您可以保留默认值。它还允许选择你想要部署的包的版本，默认情况下，它会选择最新的版本。</p>

<p>按<strong>保存</strong>然后按<strong>部署到PI Dev </strong>然后按<strong>部署</strong>开始部署过程。</p>

<p><strong>创建发布</strong>也可以从命令行执行:</p>

<pre><code class="language-powershell">octo create-release --server http://octopus/ --apikey API-ABCDEF123456 --project "PiWeb"
octo deploy-release --server http://octopus/ --apikey API-ABCDEF123456 --project "PiWeb" --deployto="Pi Dev" --version "0.0.1"
</code></pre>

<p>第一次部署时，Octopus服务器将在目标机器上更新Calamari，这可能需要几分钟。</p>


<h2 id="test-it">测试一下</h2>

<p>部署完成后，在端口5000上导航到您的Raspberry Pi的IP地址或DNS名称，您应该会看到应用程序:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-06/deploying-an-octopus-pi/its-alive.png" class="zoom" data-title=""><img src="../Images/e98bc54153f36d09ad885482e251c9a4.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2020-06/deploying-an-octopus-pi/its-alive.png"/>T2】</a></p>

<h2 id="conclusion">结论</h2>

<p>随着许多不同技术的结合，部署。NET到Raspberry Pi的转换是受支持的，而Octopus Deploy使它变得不那么痛苦。在这篇文章中，您还看到了许多与Octopus服务器集成的不同方式，包括命令行和web门户。</p>

                    
                    
</body>
</html>