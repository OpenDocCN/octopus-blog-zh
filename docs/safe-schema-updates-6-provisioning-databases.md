# 安全模式更新-供应开发/测试数据库- Octopus 部署

> 原文：<https://octopus.com/blog/safe-schema-updates-6-provisioning-databases>

这篇博文是我的安全模式更新系列的第 6 部分。本系列其他文章的链接如下:

**批评现有系统:**

**想象更好的系统:**

**构建更好的系统:**

我们已经完成了这个系列的一半以上，到目前为止我们还只是停留在理论上。我们想象了一个更好的世界，但是我们还没有讨论实现这个世界所需的实际步骤。

现在情况变了。

从现在开始，我们将明确地讨论采用我在第 1 部分中讨论的那种 hellscape 的过程，并迭代地重构它，以便更安全地进行更改和改进。

根据记录，这段旅程可能不会很快也不会很容易。我们将讨论技术、流程和想法，这些对您现有的团队来说可能是新的。学习是困难的，大多数人需要一些时间来接受、学习和接受新技术和流程。

我们不会陷入教程、代码片段或其他细节中，但会有大量链接指向更详细的资料。

## 我们永远没有足够的环境

首先要做的事情:提供开发和测试环境。正如我们在第 2 部分[“无故障运行需要失败经验”](https://octopus.com/blog/safe-schema-updates-2-resilience-vs-robustness#appreciating-the-nature-of-failure-in-complex-systems)中所学。如果你的团队不能容易地进入一个现实的开发空间，在那里他们可以安全地实践失败，那么他们就不太可能构建出有弹性的生产系统。

通过从可快速部署和可任意处理的开发和测试系统开始，我们培养了更好地测试和预演有风险的重构的能力，这在以后会变得必要。此外，关于交付周期:

> 制约因素几乎总是存在的第一个地方，尤其是对于共享运营的传统 IT 组织[……]是环境创建。我们永远也吃不够，每当我们真的需要一个的时候，我们仍然要等四十个星期。

*金、[超越凤凰计划](https://octopus.com/blog/devops-reading-list#beyond-the-phoenix-project)、*

回想一下我们在之前的帖子中学到的内容:

*   个人的、可快速部署的环境更有弹性，因为它们是一次性的，并且可以隔离故障。如果一个开发人员破坏了一个环境，这个失败不会影响到其他任何人，并且可以轻松地终止和重新修复这个环境。此外，如果开发人员的个人开发实例被破坏，他们知道他们已经发现了产品中已经存在的问题，或者他们自己的代码有问题。这就减少了怀疑和指责。
*   自助服务环境减少了“在我的机器上工作/在开发中工作”的问题，因为所有环境都是从标准映像构建的，尽可能“像生产一样”。
*   个人开发环境鼓励持续的集成，因为当变更在不同的共享开发/测试环境中进行时，它们不需要被批量处理。变更是相互分离的。这导致了更小的集成、更安全的部署、更好的质量、更少的官僚作风和更快的交付周期。

如果我们想要获得这些好处，快速、轻松地进行环境资源调配至关重要。避免因依赖运营团队或审批者而导致的任何延迟至关重要。

我们的目标是创建一种现实的、现成的、预先批准的环境，开发人员和测试人员可以根据需要快速构建并抛弃它。它应该感觉像“git 克隆 f5 ”,需要大约同样多的时间和按键。

这个目标适用于任何系统的每个组件。由于数据库通常是一个共享的依赖项，其他一切都建立在它的基础上，所以在本文中，我们将重点关注快速、自助式的数据库供应。然而，这些想法和技术中的一些也可以帮助人们同时构建额外的依赖系统，允许人工或自动测试运行来构建完成手头任务所需的任何部分。

使用本文中的技术将会降低管理开销，并使产品更加安全。但是，节约成本不应该是首要目标。事实上，开发/测试托管费用(单独考虑)可能会有所增加。对于那些担心基础设施成本飙升的人，考虑一下大多数托管平台都允许支出上限。预算审批流程应该关注在哪里设置上限，而不是微观管理任何具体的计算时间。

让我们开始吧。

## 基础设施作为代码

如果使用云数据库，如 Azure SQL 数据库或 Amazon RDS，这一步可能没有必要。然而，出于本文的目的，我们将假设我们的整体后端数据库是运行在某个虚拟基础设施上的 SQL Server 数据库，要么在某个私有云，要么是 AWS、Azure 或 GCP 等托管提供商。

在这种情况下，您需要对一些脚本进行版本控制，以允许开发人员在他们自己的开发工作站、私有云或托管提供商上启动新的虚拟机或容器。

对于任何不熟悉这个概念的读者，我建议您阅读 Bob 的优秀系列，它从这里开始:

[使用基础设施作为运营手册的代码](https://octopus.com/blog/runbooks-with-infrastructure-as-code)

您的目标是为每个开发人员或测试人员提供一种简单的方法，在此基础上构建测试数据库。

## SQL Server

一旦有了服务器，就需要安装 SQL Server。我建议你从阅读 Bob 的另一篇文章开始(我会永远引用它！):

[自动安装 SQL Server Developer】](https://octopus.com/blog/automate-sql-server-install)

Bob 解释了如何对您的 SQL Server 配置进行版本控制并自动安装 SQL Server。读完之后，如果你运行的是 Windows，我鼓励你看看[巧克力。这基本上是 Windows 对 Linux 的](https://chocolatey.org/) [apt-get](https://help.ubuntu.com/community/AptGet/Howto) 的回应。它实现了与 Bob 的自动化脚本相同的功能，但代码少了:

> choco 安装 SQL-server-2019-params = " '/配置文件:c:\ git \ my repo \ IAC \ SQL \ configuration 文件。ini ' "

最后，不讨论 Docker 容器[是一种疏忽。](https://www.docker.com/resources/what-container)

您可以在 Windows 或 Linux 上的 Linux 容器中运行 SQL Server。Docker 允许人们比在操作系统上安装新的 SQL 实例更快、更有效地运行它。这允许开发人员更频繁、更自由地启动和关闭实例，而无需提供新的开发机器。除了加快速度之外，这还可能简化整个过程，因为开发人员无需在每次想要重建环境时都启动和拆除新的服务器。

在我看来，开始使用 SQL Server 容器的最佳地方是 Andrew Pruski 的优秀博客系列，它将带你从零到 Kubernetes 的混沌工程(以及……太空入侵者)。

[https://www.youtube.com/embed/HCy3sjMRvlI?start=1642](https://www.youtube.com/embed/HCy3sjMRvlI?start=1642)

VIDEO

## 数据库/数据

到目前为止，我们已经实现了基础设施和 SQL Server 安装的自动化，但是我们还没有设置数据库或任何测试数据。不足为奇的是，缺乏真实测试数据的开发人员往往会写出性能很差的查询。他们的代码第一次大规模测试是在生产中！

不幸的是，在开发/测试中使用原始生产数据几乎是不可能的/不切实际的。在我们继续之前，我们需要解决两个需要解决的问题:隐私和规模。我们将依次处理这些问题。

### 数据隐私:提供有用但安全的测试数据

如果为他们的银行、医疗保健提供商或超市工作的所有开发人员都可以访问他们的个人财务、健康或购买数据，大多数人会认为这是对隐私的侵犯。同样值得考虑的是，与生产数据库相比，黑客更有可能攻击开发数据库。如今，网络钓鱼邮件非常具有说服力。一旦坏人获得了对开发人员机器的访问权，开发人员数据库通常就更容易成为目标。

为了应对这些问题，几乎所有地方的数据隐私立法都趋向于更加严格。除了法律制裁，每当下一个企业遭遇数据泄露时，传统媒体和社交媒体都喜欢推波助澜。没有人想成为下一个 Equifax 。

问问你自己:“想象一下有人把你的 dev 数据库上传到一个流行的黑客网站……你担心吗？”如果是这样的话，很可能您知道在不应该存在敏感数据的地方存在敏感数据，或者您不知道 dev 数据库是否包含敏感数据。根据许多最新的数据隐私法，这两种情况都是不可接受的。

无论您是维护一个单一的共享开发环境，还是使用许多可任意使用的环境，都是如此。然而，如果走一次性基础设施路线，重要的是要认识到我们可能会创建许多开发数据的副本，这可能会加剧数据监护问题。

不管我们有一个还是一百个共享开发环境，这些环境中的数据库都不应该包含任何敏感数据。您可能希望用各种类型的数据来替换您的敏感数据。在推文中总结一下:

出于本文的目的，我将提出大多数开发和测试目的的理想数据是生产数据，但是任何敏感记录都要以某种方式删除或替换。这样，可以用代表性的数据规模和分布来测试程序，更好地突出一次性环境中的潜在问题。这将导致更多的问题被提前发现，更少的生产问题。

为了实现这一点，首先我们需要进行数据审计并创建数据清单/字典/地图。需要根据数据的敏感程度对数据进行分类。(这已经是包括 GDPR 在内的许多数据隐私法的要求。如果你不知道你的敏感数据在哪里，你就无法保护它！)

在 SQL Server 中，有几种方法可以做到这一点。例如，您可以强制所有列使用一个[扩展属性](https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/sp-addextendedproperty-transact-sql?view=sql-server-ver15)来定义数据敏感度的级别。这些属性相对容易放入源代码控制[和查询](http://workingwithdevs.com/query-return-sensitive-data-sql-server/)。进一步来说，[数据分类从 2016 年开始就是 SQL Server 的内置功能](https://docs.microsoft.com/en-us/sql/relational-databases/security/sql-data-discovery-and-classification?view=sql-server-ver15&tabs=t-sql)。

接下来，我们需要创建数据库的副本，清除所有敏感数据。我建议使用您的环境创建脚本(如上)在您的生产防火墙后面的某个地方建立一个临时的“暂存”实例。然后，您可以定期将最新的生产备份还原到该临时区域，并运行一些脚本或工具来删除所有敏感数据。(额外收获:无论如何，定期测试你的备份是一项重要的实践。)

数据屏蔽过程可能简单到用“John Doe”替换所有姓名，或者您可能使用更复杂的过程来创建真实但虚假的数据。例如，您可能想看看[dbatools Invoke-dbaDbDataMasking cmdlet](https://docs.dbatools.io/#Invoke-DbaDbDataMasking)(开源、简单、免费)或[Redgate Data Masker for SQL Server/Oracle](https://www.red-gate.com/products/dba/data-masker/)(第三方、复杂、非免费)。在这里投入精力来创建更真实的测试数据将会在以后带来更高质量的开发和测试工作。

如果你担心敏感的生产数据泄露，这里有一些建议:

*   向部署管道中添加一个测试，确保所有列在源代码管理中都有一个数据分类。
*   向部署管道添加一个测试，确保所有敏感列都有相应的屏蔽脚本或规则。
*   在遮罩过程之后添加冒烟测试，以扫描看起来敏感的数据，如社会保险、信用卡或电话号码。
*   在您的部署管道中添加一项检查，确保对数据隐私分类或屏蔽脚本的任何更改都被标记出来，以供高级开发人员或(如果必须的话)数据库管理员、安全团队、数据隐私官或 *[变更顾问委员会审查。(呦！“角色分离”执法大队:我看到你了。我所要求的是采取措施确保这些审查迅速进行，而不造成长时间的拖延。](https://octopus.com/blog/change-advisory-boards-dont-work)*

在屏蔽脚本之后，开发人员/测试人员可能想要提供他们自己的脚本来在登台实例上运行。例如，向数据库添加一组已知的测试用例，或者为开发/测试组添加一个具有管理权限的 SQL 登录。

当所有这些脚本完成后，我们可以在登台服务器上备份新的“dev-safe”数据库，并将备份复制到 dev 域中的某个共享位置。(然后我们可以删除临时数据库实例。它已经完成了它的使命。)

注意:数据屏蔽脚本可能需要很长时间才能运行，并且可能需要大量计算资源。如果逐行处理大型表，并到处创建临时表来维护复杂的外键引用，情况尤其如此。因此，整个事情需要作为一个计划的任务运行，每晚/每周/冲刺等创建新的“安全开发”备份。

现在，到开发人员早上开始工作的时候,“对开发安全的”备份应该已经准备好供他们使用了。他们已经创建的用于启动开发环境的脚本现在可以扩展，以恢复最新的掩蔽生产备份。现在，他们的开发环境已经完成了相对较新版本的屏蔽生产数据库。

### 数据规模:使生产数据更小、更快、更便宜

我们可能仍然面临重大的实际挑战。大多数生产数据库都非常大。

生产数据库很可能会太大，以至于无法在开发环境中完全重现。如果生产数据库是以 TB 为单位来衡量的，那么您不太可能想要购买大量的开发和测试服务器，每个服务器都足够大，可以承载全部内容。此外，大型数据库可能需要很长时间才能恢复。我们希望这个过程只需要几秒钟，而不是几个小时。

也就是说，您的开发人员和测试人员可以真正从访问大规模和相对较新的数据中受益。如果他们从来没有针对大型的、有代表性的数据集测试过他们的代码，他们怎么能预料到那些非直观的性能问题呢？这些性能问题可能会导致支撑整个生产资产的生产数据库崩溃。

这就是数据库克隆可以发挥作用的地方。

像 [dbaclone](https://github.com/sqlcollaborative/dbaclone) (开源，免费)和 [Redgate SQL Clone](https://www.red-gate.com/products/dba/sql-clone/) (第三方，不免费)这样的工具使用已经内置在 Windows 操作系统中的虚拟化功能来创建大型文件的廉价、可编辑的虚拟副本。

在 SQL Server 开发环境中，运营团队通常会从在共享位置创建大型数据库(高达 64TB)的开发安全“映像”开始。之后，开发人员可以根据需要创建“克隆”。这些克隆实际上是指向原始“映像”的指针。首次创建时，每个克隆只需要几兆字节(不管源映像的大小)。因此，我们可以在廉价的商用硬件上，几乎即时地创建几乎无限的源映像克隆。

聪明的一点是一个“差异磁盘”,它可以捕捉开发人员对克隆所做的任何更改。这感觉就像魔术一样，因为每个克隆都变成了它自己的 64 TB 源映像的可编辑副本，即使克隆运行在一个小得多的驱动器上。

主要问题是“差异磁盘”的大小会随着您修改文件而增长。因此，对小对象(如视图、过程或单行数据的更新)的更改不太可能产生大的影响。但是，如果重新索引一个大表，可能会很快耗尽磁盘空间。克隆是在小型、可任意使用的基础架构上使用的理想工具，在这种基础架构中，克隆的物理位置靠近源映像。

作为一个聚会恶作剧，我曾经在我的会议演示结束时循环运行这项克隆技术。几分钟之内，我在笔记本电脑上运行了一千多个可编辑的完整 StackOverflow 数据库副本。我的本地 SQL Server 实例认为我的 13 英寸 HP Spectre 上有将近 1pb 的 SSD 存储空间！

如果您想了解更多关于如何一起使用容器和克隆的知识，您可能想从观看我去年与 dbaclone 项目的维护者桑德·达塞的一次谈话开始:

[https://www.youtube.com/embed/masJxBmgfqo](https://www.youtube.com/embed/masJxBmgfqo)

VIDEO

而且，如果这一切还不够酷，看看[红门产卵](https://spawn.cc/)。这是 SQL 克隆的托管版本。虽然它仍处于预览阶段，我还没有机会亲自使用它，但我真的对它的潜力感到兴奋！它有可能用一个命令取代本文中的大部分步骤。

如果你想开始，[我在去年](https://octopus.com/blog/self-service-database-provisioning-with-octopus-runbooks-and-redgate-sql-clone)写了更多关于数据库克隆的细节，并且我包括了一个更详细的演练。

## 架构部署

到目前为止，我们有望获得一个常规的批处理作业，为我们的每个数据库生成开发安全的数据映像，以及一组自动化脚本，允许开发人员根据需要使用真实的数据来构建 SQL 实例。然而，这些数据库可能会有点过时。

数据库模式不是基于源代码管理的最新版本，而是基于产品。(生产可能还没有最新的开发变更)。此外，由于新的开发映像是提前创建的，它们可能已经存在几天或几周了。

在我们可以使用我们的新开发环境之前，我们需要在最新版本的“开发安全”数据库之上部署我们的源代码控制主分支中的最新源代码。除了这是使我们的开发环境保持最新的必要步骤之外，我喜欢这个练习，因为每次开发人员构建一个新环境时，他们都在有效地测试下一个生产部署。因此，如果有任何问题正在酝酿，你很可能提前发现它们。

我不打算在这里讨论自动化数据库部署的过程，但以下资源可能会有所帮助:

## 加速这一切

我们的配置过程现在已经完成。它有两个部分:

1.  按照计划，我们有一个为开发人员创建新的开发安全数据库的过程。
2.  开发人员可以在需要时构建他们自己的开发环境。

然而,“git，clone，f5”的体验可能还是会让开发者有点沮丧。

当开发人员想要运行他们的代码时，克隆回购相对较快，并且他们可以运行他们的脚本(或者使用 [Octopus Runbook](https://octopus.com/docs/runbooks) )来构建开发环境。但是，该脚本可能需要一段时间才能完成。

作为一名开发人员，我不想等待超过一分钟，最好是不超过几秒钟，就开始运行我的代码。但是，我的环境供应脚本必须完成以下所有工作:

1.  构建一个新实例并启动它。(这最多需要几分钟时间。)
2.  安装 SQL Server，以及其他任何需要的东西。(大概还要 5-10 分钟。如果使用容器就更少了。)
3.  还原我的数据库备份或克隆数据库。(如果使用大型备份，可能需要一段时间。)
4.  部署最新的源代码。(根据模式的大小/复杂程度以及部署工具/过程，这可能需要几分钟的时间。)

如果所有这些都需要 15 到 30 分钟，这并不奇怪，对于大型数据库来说，可能需要更长时间。这是一大堆无聊的事情，可能会让开发人员担心破坏他们的开发平台。如果他们犯了一个错误，他们真的想冒这么长时间延迟重生的风险吗？迭代一个设计或者测试多个实现选项可能需要很长时间，如果每个演进需要几个小时的话。

我们或许可以通过虚拟机快照来加快速度。或者，我们可以预先创建一个开发环境队列。我最喜欢队列选项，因为它省去了所有的 VM 魔法，并且可能更快。在开发人员提出请求之前，开发环境就已经准备好了——他们所需要的只是连接字符串。

## 摘要

根据 Gene Kim 的说法，大多数人在开发运维转型中遇到的第一个交付瓶颈是环境创建。我们在[数据库交付地狱](https://octopus.com/blog/safe-schema-updates-1-delivery-hell)中目睹的许多问题都是共享和不一致开发环境的结果。我们知道失败是正常的，所以创建失败是安全的系统是很重要的。

亲爱的读者，我希望这篇文章中概述的各种技术实践将允许您将尽可能多的开发和测试从您的大型共享开发/测试环境转移到专用环境中，在专用环境中，可以对更改进行隔离测试，并在准备好进行部署时进行合并。

这种改进的测试能力将会派上用场，因为我们将继续关注下一篇关于近零停机部署和将整体系统分解成更松散耦合的架构的扼杀模式的文章。如果您能够在安全的、可任意处理的开发和测试环境中测试和预演这些变化，那么进行复杂和有风险的重构会容易得多。

## 下次

在下一篇文章中，我们将把焦点转向部署模式。

在本系列中，我一直倡导更小、更安全、更频繁的部署。但是，如果这些部署需要停机时间，我们就不太可能像我们希望的那样经常部署。如果每次部署都需要一个小时的停机时间，那么一天部署 10 次是没有意义的。在我看来，接近零停机时间的部署不应该被视为一些崇高而不切实际的目标。它们应该被认为是实践真正的持续集成和交付弹性系统的先决条件。

本系列其他文章的链接如下:

**批评现有系统:**

**想象更好的系统:**

**打造更好的系统:**

## 观看网络研讨会

我们的第一次网络研讨会讨论了松耦合架构如何带来可维护性、创新性和安全性。第二部分讨论了如何将一个成熟的系统从一种架构转换到另一种架构。

### 数据库开发:想象更好的系统

[https://www.youtube.com/embed/oJAbUMZ6bQY](https://www.youtube.com/embed/oJAbUMZ6bQY)

VIDEO

### 数据库开发:构建更好的系统

[https://www.youtube.com/embed/joogIAcqMYo](https://www.youtube.com/embed/joogIAcqMYo)

VIDEO

愉快的部署！