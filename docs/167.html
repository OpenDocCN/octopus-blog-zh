<html>
<head>
<title>Debugging "element does not exist in the collection properties" for SSIS - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>为SSIS - Octopus部署调试“集合属性中不存在元素”</h1>
<blockquote>原文：<a href="https://octopus.com/blog/debugging-element-does-not-exist-in-the-collection-properties-for-ssis#2022-04-26">https://octopus.com/blog/debugging-element-does-not-exist-in-the-collection-properties-for-ssis#2022-04-26</a></blockquote>
                        <p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-05/debugging-element-does-not-exist-in-the-collection-properties-for-ssis/deploying-ssis-issue.png" class="zoom" data-title=""><img src="../Images/d3c7638c608843e6c14629dc0fee34ca.png" class="img-fluid center" alt="deploying SSIS with octopus deploy" data-original-src="https://i.octopus.com/blog/2021-05/debugging-element-does-not-exist-in-the-collection-properties-for-ssis/deploying-ssis-issue.png"/>T2】</a></p>

<p>在之前的一篇文章中，我介绍了如何使用Octopus Deploy部署SQL Server Integration Services(SSIS)包。在这篇文章中，我讨论了一个我在包被部署到服务器上之后遇到的问题，这个问题是由于使用较新版本的Visual Studio来开发SSIS包，但是部署到了较旧版本的SQL Server上。</p>

<h2 id="the-error">错误</h2>

<p>成功部署后，开发人员尝试运行SSIS包，但收到以下错误消息:</p>

<pre><code>Failed to configure a connection property that has the following path: \Package.Connections [WWI_Source_DB].Properties[ConnectByProxy]. Element "ConnectByProxy" does not exist in collection "Properties".
</code></pre>

<p>为了进行研究，我首先查看了环境变量映射:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-05/debugging-element-does-not-exist-in-the-collection-properties-for-ssis/ssis-environment-mapping.png" class="zoom" data-title=""><img src="../Images/8d1d5799a678fe78929572d3956674ed.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2021-05/debugging-element-does-not-exist-in-the-collection-properties-for-ssis/ssis-environment-mapping.png"/>T2】</a></p>

<p>该属性存在并映射到适当的环境变量。</p>

<p>作为一个实验，我让开发人员直接从Visual Studio发布SSIS包，这个包工作正常。这两种方法的主要区别在于Visual Studio publish没有将包参数映射到环境变量。相反，它们被设置为<strong>使用包</strong>中的默认值。在这种情况下，默认值显示为<code>False</code>。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-05/debugging-element-does-not-exist-in-the-collection-properties-for-ssis/ssis-package-parameter.png" class="zoom" data-title=""><img src="../Images/7e9a7f6b0453db936f9266550d752018.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2021-05/debugging-element-does-not-exist-in-the-collection-properties-for-ssis/ssis-package-parameter.png"/>T2】</a></p>

<p>要进入此窗口:</p>
<ol>
<li>右键单击该包并选择<strong>配置</strong>。</li>
<li>将范围下拉列表更改为<strong>所有包和项目</strong>。</li>
<li>点击<strong>连接管理器</strong>选项卡</li>
</ol>


<p>我使用Octopus Deploy重新部署了SSIS包。部署完成后，我编辑了包并选择了<strong>编辑值</strong>并选择了<code>False</code>。由于同样的错误，程序包再次失败，但是将值设置为<strong>使用程序包</strong>中的默认值成功。</p>

<h2 id="the-problem">问题是</h2>

<p>经过几个小时的研究，我发现开发人员使用最新版本的Visual Studio来开发SSIS包，但它是部署到SQL Server的旧版本。</p>

<p>新版本的Visual Studio为连接管理器引入了旧版本的SQL Server所不知道的附加属性。该错误试图告诉我们这一点，但不清楚。</p>

<p><code>Element "ConnectByProxy" does not exist in collection "Properties"</code>是说<code>ConnectByProxy</code>不存在于<code>Properties</code>的服务器集合中，而不是包本身。选择<strong>使用包</strong>中的默认值也具有误导性。</p>

<p>从UI来看，这个选择显示的值是<code>False</code>，然而，实际值是<code>null</code>(在读取包的XML时发现的)。</p>

<h2 id="the-solution">解决方案</h2>

<p>有两种解决方案:</p>

<ul>
<li>手动将封装参数更新为<strong>使用封装</strong>设置中的值。</li>
<li>使用PowerShell为您更新软件包参数。</li>
</ul>

<h3 id="manual-method">手动方法</h3>

<p>上面的提示描述了如何导航到包参数并手动更新它们。然而，这是低效的，因为它需要在每次部署后重复。</p>

<h3 id="powershell">PowerShell</h3>

<p>更好的解决方案是将“运行脚本”任务添加到部署过程中，以便为您执行编辑。</p>

<p>下面的脚本应该可以帮助您完成大部分工作:</p>

<pre><code class="language-PowerShell"># define functions
Function Import-Assemblies
{
    # display action
    Write-Host "Importing assemblies..."

    # get folder we're executing in
    $WorkingFolder = Split-Path $script:MyInvocation.MyCommand.Path
    Write-Host "Execution folder: $WorkingFolder"

    # Load the IntegrationServices Assembly
    [Reflection.Assembly]::LoadWithPartialName("Microsoft.SqlServer.Management.IntegrationServices") | Out-Null # Out-Null suppresses a message that would normally be displayed saying it loaded out of GAC
}

Function Get-Catalog
{
    # define parameters
    Param ($CatalogName, $IntegrationServices)

    # define working variables
    $Catalog = $null

    # check to see if there are any catalogs
    if($integrationServices.Catalogs.Count -gt 0 -and $integrationServices.Catalogs[$CatalogName])
    {
        # get reference to catalog
        $Catalog = $integrationServices.Catalogs[$CatalogName]
    }
    else
    {
        Write-Error  "Catalog $CataLogName does not exist or the Tentacle account does not have access to it."

        # throw error
        throw
    }

    # return the catalog
    return $Catalog
}

Function Get-Folder
{
    # parameters
    Param($FolderName, $Catalog)

    # try to get reference to folder
    $Folder = $Catalog.Folders[$FolderName]

    # check to see if $Folder has a value
    if(!$Folder)
    {
        Write-Error "Folder not found."
        throw
    }

    # return the folder reference
    return $Folder
}

Function Clear-Parameter
{
    # define parameters
    Param($ParameterName)

    # Create a connection to the server
    $sqlConnectionString = "Data Source=$SQLServer;Initial Catalog=master;Integrated Security=SSPI;"
    $sqlConnection = New-Object System.Data.SqlClient.SqlConnection $sqlConnectionString
    $ISNamespace = "Microsoft.SqlServer.Management.IntegrationServices"

    # create integration services object
    $integrationServices = New-Object "$ISNamespace.IntegrationServices" $sqlConnection

    try
    {
        # get catalog reference
        $Catalog = Get-Catalog -CatalogName $CataLogName -IntegrationServices $integrationServices
        $Folder = Get-Folder -FolderName $FolderName -Catalog $Catalog

        # get reference to project
        $Project = $Folder.Projects[$ProjectName]

        # find specific parameter
        $Parameter = $Project.Parameters | Where-Object {$_.Name -eq $ParameterName}

        # set parameter to design time default value
        Write-Host "Clearing parameter $ParameterName"
        $Parameter.Clear()

        # set value
        $Project.Alter()
    }
    finally
    {
        # close connection
        $sqlConnection.Close()
    }
}


# get reference to assemblies needed
Import-Assemblies

$SQLServer = "#{Project.Database.Server.Name}"
$CataLogName = "SSISDB"
$FolderName = "#{Project.SSISDB.Folder.Name}"
$ProjectName = "#{Project.SSISDB.Project.Name}"


# fix the problem
Clear-Parameter -ParameterName "CM.WWI_Source_DB.ConnectByProxy"
</code></pre>

<p>有了这个脚本，您可以调用<code>Clear-Parameter</code>来获取任何需要设置为<code>Use default value from package</code> on的参数。</p>

<h2 id="conclusion">结论</h2>

<p>在自动化SSIS部署时，我发现新版Visual Studio向连接管理器引入了旧版SQL Server不知道的附加属性。我希望这篇博客能让你避免遇到同样的问题。</p>

<p>愉快的部署！</p>

                    
                    
</body>
</html>