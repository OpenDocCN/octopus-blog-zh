<html>
<head>
<title>Rolling back a Tomcat deployment - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>回滚Tomcat部署- Octopus部署</h1>
<blockquote>原文：<a href="https://octopus.com/blog/rolling-back-tomcat-deployment#2021-11-05">https://octopus.com/blog/rolling-back-tomcat-deployment#2021-11-05</a></blockquote>
                        <p>DevOps反馈循环通常有自动化的流程来尽可能早地在管道中捕获问题。虽然这些自动化过程允许早期检测，但错误仍然可以找到进入生产代码的途径。一些bug非常严重，足以保证退出最近部署的版本。恢复更改的过程称为回滚。</p>

<p>在本文中，我将讨论使用Apache Tomcat web服务器时的不同回滚策略。</p>



<h2 id="initial-deployment-process">初始部署流程</h2>

<p>这篇文章使用<a href="https://bitbucket.org/octopussamples/petclinic/src/master/" rel="nofollow"> PetClinic应用程序</a>部署到Apache Tomcat web服务器。PetClinic应用程序需要一个数据库后端，并使用Flyway来执行数据库迁移。</p>

<p>示例流程如下所示:</p>

<ol>
<li>如果不存在，则创建数据库</li>
<li>部署数据库更改</li>
<li>部署PetClinic Web应用程序</li>
<li>验证部署</li>
<li>通知利益相关方</li>
</ol>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-11/rolling-back-tomcat-deployment/octopus-original-deployment-process.png" class="zoom" data-title=""><img src="../Images/e1c29d9f64c599fde382d4f90565d3fb.png" class="img-fluid center" alt="Octopus UI showing Process and 5 steps to deploy PetClinic application" data-original-src="https://i.octopus.com/blog/2021-11/rolling-back-tomcat-deployment/octopus-original-deployment-process.png"/>T2】</a></p>

<p>这篇文章假设您熟悉这个部署过程中包含的步骤，并且不会详细介绍每个步骤。</p>

<h2 id="deploying-the-previous-version">部署以前的版本</h2>

<p>使用Octopus Deploy，您可以通过重新部署应用程序的以前版本来回滚。您只需从<strong> Releases </strong>屏幕中选择以前的版本，然后单击所需环境旁边的<strong> REDEPLOY </strong>按钮。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-11/rolling-back-tomcat-deployment/octopus-redeploy-release.png" class="zoom" data-title=""><img src="../Images/c591a55d48c28643b52c2a4693562177.png" class="img-fluid center" alt="Octopus dashboard showing progression of Development lifecycle with REDEPLOY button highlighted" data-original-src="https://i.octopus.com/blog/2021-11/rolling-back-tomcat-deployment/octopus-redeploy-release.png"/>T2】</a></p>

<p>部署过程中的所有步骤都按照创建发布时的配置执行。对于Apache Tomcat，将在Tomcat服务器上重新提取包，执行变量替换，并在发送到Tomcat管理器进行部署之前重新打包。包裹的大小将决定需要多长时间。</p>

<h2 id="simple-rollback">简单回滚</h2>

<p>如上所述，部署过程中的所有步骤都将像第一次一样重新执行。虽然内置的重新部署方法是有效的，但在执行回滚时，可能会有一些您不想执行的步骤。</p>

<p>如果发布有问题，您通常会回滚。在这种情况下，最好将正在回滚的版本标记为坏的，并阻止它升级到其他环境。要有条件地跳过步骤并将发布标记为坏，需要修改流程:</p>

<ol>
<li>计算部署模式</li>
<li>如果数据库不存在，则创建数据库(回滚时跳过)</li>
<li>部署数据库更改(回滚期间跳过)</li>
<li>部署PetClinic Web应用程序</li>
<li>验证部署</li>
<li>通知利益相关方</li>
<li>阻止发布进度(仅在回滚期间)</li>
</ol>

<p>在部署步骤中使用<strong> Notes </strong>字段，您可以为这些步骤以及它们将以何种模式运行提供文档。</p>


<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-11/rolling-back-tomcat-deployment/octopus-simple-rollback-process.png" class="zoom" data-title=""><img src="../Images/8c78b8e7e686a20e767afbf90e59d218.png" class="img-fluid center" alt="Octopus UI showing Process and steps 1 to 7." data-original-src="https://i.octopus.com/blog/2021-11/rolling-back-tomcat-deployment/octopus-simple-rollback-process.png"/>T2】</a></p>

<p>您会注意到两个新步骤，<strong>计算部署模式</strong>和<strong>阻止发布进度</strong>，以及一些应用于现有步骤的条件。让我们更详细地看看这些。</p>

<h3 id="calculate-deployment-mode">计算部署模式</h3>

<p>回滚过程的第一部分是确定它是部署、回滚还是重新部署操作。</p>

<p>我们的团队开发了社区步骤模板<strong> <a href="https://library.octopus.com/step-templates/d166457a-1421-4731-b143-dd6766fb95d5/actiontemplate-calculate-deployment-mode" rel="nofollow">计算部署模式</a> </strong>，它决定了部署处于哪种模式，并生成了许多包含变量<a href="https://octopus.com/docs/projects/steps/conditions#run-condition">运行条件</a>语法的<a href="https://octopus.com/docs/projects/variables/output-variables">输出变量</a>(更多详细信息，请参见步骤描述中的文档)。</p>

<h3 id="database-steps">数据库步骤</h3>

<p><strong>如果不存在则创建数据库</strong>和<strong>部署数据库更改</strong>步骤不需要在回滚中运行。需要将它们配置为跳过。来自<strong>计算部署模式</strong>的<code>RunOnDeploy</code>输出变量可应用于这些步骤的变量运行条件以跳过它们:</p>

<pre><code>#{Octopus.Action[Calculate Deployment Mode].Output.RunOnDeploy}
</code></pre>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-11/rolling-back-tomcat-deployment/octopus-variable-run-condition.png" class="zoom" data-title=""><img src="../Images/634549e39e6a9aba84310571129bb687.png" class="img-fluid center" alt="Octopus UI showing Run Condition section with Variable section highlighted" data-original-src="https://i.octopus.com/blog/2021-11/rolling-back-tomcat-deployment/octopus-variable-run-condition.png"/>T2】</a></p>

<h3 id="block-release-progression">阻止释放进程</h3>

<p>阻塞发布进程在Octopus Deploy中并不新鲜，但是，它需要通过UI或API调用来完成。</p>

<p>我们的团队认识到，在处理回滚时，自动化这一活动是至关重要的，并开发了<strong><a href="https://library.octopus.com/step-templates/78a182b3-5369-4e13-9292-b7f991295ad1/actiontemplate-block-release-progression" rel="nofollow">Block Release Progression</a></strong>模板，该模板可以自动阻止发布。</p>

<p>此步骤应仅在回滚操作期间运行。使用<strong>计算部署模式</strong>的以下输出变量作为变量运行条件以确保这一点:</p>

<pre><code>#{Octopus.Action[Calculate Deployment Mode].Output.RunOnRollback}
</code></pre>

<h2 id="complex-rollbacks">复杂的回滚</h2>

<p>内置的和简单的回滚方法都将提取并重新打包<code>.war</code>文件，然后将其交付给Tomcat服务器进行部署。如果您的应用程序很大，这可能需要一些时间。使用Tomcat <a href="https://tomcat.apache.org/tomcat-7.0-doc/config/context.html#Parallel_deployment" rel="nofollow">并行部署</a>特性，可以在几秒钟内执行回滚。</p>

<h3 id="tomcat-parallel-deployments">Tomcat并行部署</h3>

<p>并行部署特性是在Tomcat version 7中引入的，它允许您将同一应用程序的多个版本部署到Tomcat服务器上。</p>

<p>在应用程序的较新版本处于运行状态后，新会话将在新版本上运行，而现有会话将继续在旧版本上运行，直到它们过期。您需要提供带有上下文路径的版本号。Tomcat服务器结合了版本号和上下文路径，并将部署的<code>.war</code>重命名为<code>&lt;contextpath&gt;##&lt;version&gt;.war</code></p>

<h3 id="complex-rollback-process">复杂的回滚过程</h3>

<p>要使用并行部署特性实现回滚过程，您需要修改您的过程，如下所示:</p>

<ol>
<li>计算部署模式</li>
<li>回滚原因(仅在回滚期间)</li>
<li>如果数据库不存在，则创建数据库(回滚时跳过)</li>
<li>部署数据库更改(回滚期间跳过)</li>
<li>在Tomcat中停止应用程序(回滚时运行或部署和回滚时运行)</li>
<li>部署PetClinic Web应用程序(仅在部署或重新部署期间)</li>
<li>在Tomcat中启动应用程序(仅在回滚期间)</li>
<li>验证部署</li>
<li>通知利益相关方</li>
<li>阻止发布进度(仅在回滚期间)</li>
</ol>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-11/rolling-back-tomcat-deployment/octopus-complex-rollback-process.png" class="zoom" data-title=""><img src="../Images/594cc3cbd92ed04cfd0cd9723a0723c0.png" class="img-fluid center" alt="Octopus UI showing rollback process with 10 steps" data-original-src="https://i.octopus.com/blog/2021-11/rolling-back-tomcat-deployment/octopus-complex-rollback-process.png"/>T2】</a></p>

<p>让我们回顾一下为实现这一点而对流程所做的更改。</p>

<h4 id="rollback-reason">回滚原因</h4>

<p><strong>回滚原因</strong>步骤是手动干预，提示您回滚的原因。您指定的原因用于流程中更下一步的<strong>块释放进程</strong>中的<strong>原因</strong>字段。此步骤仅在回滚期间运行，因此需要将变量运行条件设置为以下内容:</p>

<pre><code>#{Octopus.Action[Calculate Deployment Mode].Output.RunOnRollback}
</code></pre>

<h4 id="stop-app-in-tomcat">停止Tomcat中的应用程序</h4>

<p><strong>停止</strong>和<strong>启动</strong>步骤都使用Tomcat 步骤中的<strong>启动\停止应用。<strong>停止</strong>步骤在<strong>部署模式</strong>下是可选的，但在<strong>回滚模式</strong>下是必需的，因为Tomcat会将新会话传送到正在运行的最新版本的部署应用程序。</strong></p>

<p>回滚时，我们需要停止坏的版本，这样以前部署的版本将开始获取会话。</p>

<p>将变量运行条件设置为仅在回滚期间运行:</p>

<pre><code>#{Octopus.Action[Calculate Deployment Mode].Output.RunOnRollback}
</code></pre>

<p>或者，您可以使用<a href="https://octopus.com/docs/projects/variables/system-variables">系统变量</a> <code>Octopus.Release.CurrentForEnvironment.Number</code>来检查是否有先前部署的版本:</p>

<pre><code>#{if Octopus.Release.CurrentForEnvironment.Number}True#{/if}
</code></pre>

<p>Tomcat步骤的<strong>高级选项</strong>的版本号如下，所选动作为<strong>停止应用</strong>:</p>

<pre><code>#{Octopus.Release.CurrentForEnvironment.Number}
</code></pre>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-11/rolling-back-tomcat-deployment/octopus-tomcat-stop-advanced.png" class="zoom" data-title=""><img src="../Images/0870aa94fa1e762413f2ace8de2a0ddb.png" class="img-fluid center" alt="Octopus UI showing Advances Options with Deployment version highlighted" data-original-src="https://i.octopus.com/blog/2021-11/rolling-back-tomcat-deployment/octopus-tomcat-stop-advanced.png"/>T2】</a></p>

<h4 id="start-app-in-tomcat">在Tomcat中启动应用程序</h4>

<p>在回滚过程中，此过程会停止正在回滚的版本。</p>

<p>您需要一个步骤来启动您要回滚到的版本。在<strong>高级选项</strong>中为Tomcat步骤指定的版本号如下，选择<strong>保持应用程序运行</strong>:</p>

<pre><code>#{Octopus.Release.Number}
</code></pre>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-11/rolling-back-tomcat-deployment/octopus-tomcat-advanced.png" class="zoom" data-title=""><img src="../Images/0e91da849e4ad0b089f20fcdf72b943a.png" class="img-fluid center" alt="Octopus UI showing Advances Options with Deployment version highlighted" data-original-src="https://i.octopus.com/blog/2021-11/rolling-back-tomcat-deployment/octopus-tomcat-advanced.png"/>T2】</a></p>

<p>该步骤需要配置为仅使用以下变量运行条件在<code>Rollback Mode</code>中运行:</p>

<pre><code>#{Octopus.Action[Calculate Deployment Mode].Output.RunOnRollback}
</code></pre>

<h4 id="deploy-petclinic-web-app">部署PetClinic Web应用程序</h4>

<p>该步骤需要与Tomcat 步骤中的<strong> Start App设置相同的<strong>高级选项</strong>，为正在部署的版本提供<code>#{Octopus.Release.Number}</code>。(参考Tomcat 中<a href="#start-app-in-tomcat">启动App中的图片。)</a></strong></p>

<h4 id="block-release-progression-1">阻止释放进程</h4>

<p>在简单回滚场景中，<strong>块进程</strong>的<strong>原因</strong>字段被静态设置。<strong>回滚原因</strong>步骤提示您回滚的原因，而<strong>注释</strong>输出变量可以作为<strong>原因</strong>的输入，对阻塞释放有更有意义的信息。</p>

<p>修改<strong>原因</strong>字段以使用来自<strong>回滚原因</strong>步骤的<strong>注释</strong>输出变量，如下所示:</p>

<pre><code>#{Octopus.Action[Rollback reason].Output.Manual.Notes}
</code></pre>

<p>在Tomcat中启用<a href="https://tomcat.apache.org/tomcat-9.0-doc/config/host.html" class="alert-link" rel="nofollow">取消部署版本</a>功能会干扰复杂的回滚策略。</p>


<p>在Tomcat管理器中，并行部署将与此类似:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-11/rolling-back-tomcat-deployment/tomcat-manager-multiple.png" class="zoom" data-title="">T35【T36】T1】</a></p>

<h3 id="cleaning-up-old-versions">清理旧版本</h3>

<p>Octopus Deploy的保留策略通过删除已部署的旧版本来帮助您的目标保持干净。然而，Tomcat管理器将<code>.war</code>文件放在它自己的文件夹中，Octopus Deploy不知道这个文件夹。</p>

<p>如果您没有使用并行部署特性，那么新版本会简单地覆盖<code>.war</code>并部署应用程序。</p>

<p>Tomcat的并行部署特性将<code>.war</code>重命名为<code>&lt;contextpath&gt;##&lt;version&gt;.war</code>，因此它们是独一无二的。除非对版本化的应用程序条目执行<code>undeploy</code>操作，否则这些文件将继续累积。</p>

<p>为了帮助Tomcat维护，我们的团队开发了<strong> <a href="https://library.octopus.com/step-templates/34f13b4c-64e1-42b4-ad1a-4599f25a850e/actiontemplate-undeploy-tomcat-application-via-manager" rel="nofollow">通过管理器</a> </strong>取消部署Tomcat应用程序，这是一个社区步骤模板，在Tomcat服务器上执行取消部署操作，目前在Bash语法中可用。</p>

<h2 id="conclusion">结论</h2>

<p>在这篇文章中，我介绍了几种将应用程序部署回滚到Apache Tomcat web服务器的方法。我希望这些方法中的一个能在你的DevOps之旅中帮助你。</p>

<h2 id="watch-the-webinar-rollback-strategies-with-octopus-deploy">观看网络研讨会:Octopus Deploy的回滚策略</h2>

<iframe src="https://www.youtube.com/embed/F_V7r80aDbo" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen="">VIDEO</iframe>

<p>我们定期举办网络研讨会。请参见<a href="https://octopus.com/events">网络研讨会第</a>页，了解即将举办的活动和现场直播的详细信息。</p>

<p>愉快的部署！</p>

                    
                    
</body>
</html>