<html>
<head>
<title>RFC: Multitenancy - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>RFC:多租户- Octopus部署</h1>
<blockquote>原文：<a href="https://octopus.com/blog/rfc-multitenancy#2017-01-06">https://octopus.com/blog/rfc-multitenancy#2017-01-06</a></blockquote>
                        <p>更新:多租户部署将作为Octopus Deploy 3.4的一部分推出，Beta 2已经发布！参见<a href="https://octopus.com/blog/octopus-deploy-3.4-eap-beta2"> 3.4 Beta 2博客文章</a>了解最新信息。</p>

<p><strong>更新:根据一些令人信服的客户反馈，我们重新审视了这份RFC！阅读<a href="/blog/rfc-multitenancy-take-two" target="_blank">更新的RFC，提议将租户作为一级概念</a>...</strong></p>

<p>Octopus Deploy旨在部署软件版本，并通过一系列具有可重复结果的环境来推广它们。Octopus很好地模拟了这种典型的场景，但是它不适合多租户应用程序。让我们考虑一下在使用Octopus Deploy的多租户部署指南中讨论的例子...</p>

<blockquote>
  <p>为大公司客户制作人力资源软件。他们将软件作为SaaS产品提供给客户，并为客户托管网站和相关服务。由于应用程序的架构，对于每个客户，他们部署不同的SQL数据库、ASP.NET网站的副本和Windows服务的副本。</p>
</blockquote>

<p>这个场景中的关键问题是相同的组件需要部署多次，每个最终客户一个，这与Octopus通常设计处理的场景不同。</p>

<p>为了管理今天的这种情况，我们提出三条建议:</p>



<p>遗憾的是，Octopus中的<em>单位租户环境</em>和<em>单位租户项目</em>的可扩展性都很差，这就是我们想要解决的问题，从这个RFC开始！</p>

<p><strong>在本RFC中，我们将主要关注<em>每租户环境</em>，因为这是目前最流行的方法</strong></p>

<h2>概述</h2>

<p>这是一个很大的RFC，但也是一个很大的特性集！我们鼓励您花时间了解我们的提议，以及它将如何影响您的情况，并帮助我们把握方向！</p>



<h2>多租户很痛苦<a name="multi-tenancy-is-painful"/></h2>

<p>在帮助我们的许多客户处理Octopus中的多租户部署后，我们看到了以下主题:</p>



<p>我们错过了什么重要的东西吗？<a href="#leave-a-comment">留言评论！</a>T3】</p>

<h3>管理大量环境<a name="lots-of-environments"/></h3>

<p>Octopus部署引擎和API可以处理数千种环境。我们客户的主要抱怨是，管理多个环境的用户体验很差。</p>

<ul>
<li>环境页面本身的伸缩性不好。<em>加载速度慢，没有过滤/搜索功能，需要大量的垂直滚动，并且当许多租户托管在共享基础架构上时，可能会有大量重复的信息。</em></li>
<li>仪表板和项目概述页面的伸缩性不好。<em>加载时间慢，没有过滤/搜索，没有办法聚合状态，它们水平溢出，水平滚动很难。</em></li>
<li>每次添加新环境时，您都需要更新大量断开连接的资源:<ul>
<li>应该包括新环境的生命周期阶段</li>
<li>为新环境托管软件的部署目标/机器</li>
<li>支持部署到新环境的帐户</li>
<li>应该适用于新环境的步骤</li>
<li>应该限定新环境范围的变量</li>
</ul></li>
</ul>

<h3>添加新租户<a name="adding-tenant"/></h3>

<p>根据我们对<em>每租户环境</em>的建议，您需要:</p>

<ul>
<li>为名为<code>Production-CustomerA</code>的租户创建新环境<ul>
<li>将<code>Production-CustomerA</code>环境添加到所有必需的生命周期中</li>
<li>将<code>Production-CustomerA</code>环境添加到所有必需的帐户中</li>
<li>将<code>Production-CustomerA</code>环境添加到所有必需的部署目标中</li>
</ul></li>
<li>创建一个名为<code>Production-CustomerA</code>的新库变量集，以包含特定于新租户的变量<ul>
<li>您需要了解新租户所需的全套变量</li>
<li>手动输入每个变量名和值，注意不要出错！</li>
<li>将所有这些变量单独纳入<code>Production-CustomerA</code>环境</li>
</ul></li>
<li>对于每个必需的项目:<ul>
<li>将<code>Production-CustomerA</code>变量集添加到所有必需的项目中</li>
<li>可选地将部署步骤限定在<code>Production-CustomerA</code>环境中</li>
<li>将最新版本部署到<code>Production-CustomerA</code>环境中</li>
</ul></li>
<li>利润！</li>
</ul>

<p>如果最终客户需要一个测试和批准发布到他们的生产环境的临时环境，那么您必须为<code>Staging-CustomerA</code>重复所有这些。</p>

<p><em>我们的许多客户通过Octopus API自动完成了创建新租户的过程，但这并没有减轻租户长期持续管理带来的痛苦。</em></p>

<h3>没有管理客户的单一场所<a name="no-single-place-to-manage-customer"/></h3>

<p>当您管理一个具有一个或多个环境的客户时，您经常需要在Octopus用户界面中来回切换，而在与同一客户相关的信息片段之间导航很少或没有帮助。为环境、变量集、帐户和专用机器使用命名约定确实是一个好主意，但是它只能帮到你这么多。</p>

<h3>库变量集是全局的<a name="library-variable-sets-are-global"/></h3>

<p>考虑这样一种情况，某些重要的客户应该只由经过挑选的少数人来管理。这可以通过为环境设置权限并确保库变量集中的每个变量都正确地作用于环境来实现。然而，库变量集本身并不连接到环境——它被认为是一个全局资源。</p>

<h2>我们建议对Octopus部署中的多租户做些什么<a name="what-we-propose"/></h2>

<p>我们建议在Octopus部署中引入一系列新功能。我们相信，除了管理多租户部署的客户之外，这些功能还将惠及我们的绝大多数客户。</p>



<p><strong>有话要说？<a href="#leave-a-comment">留下评论！</a> </strong></p>

<h3>使用标签分组管理环境<a name="managing-environments-as-groups"/></h3>

<p>到目前为止，我们讨论的最常见的问题之一是处理大量的环境，尤其是您不能在仪表板上聚合环境，也不能将环境作为组来处理。我们建议引入<strong>标签</strong>来支持这些类型的场景。</p>

<p>首先，您将通过在库中创建<strong>标签集</strong>来确定您想要使哪些标签可用，其中包含每个标签集的有效标签列表。创建哪个标签集和标签完全由您决定。在本例中，我们创建了几个标记集，每个标记集代表我们希望在整个Octopus部署中利用的不同属性。</p>

<p><img src="../Images/523ca2b90ecd71857ce13de900787937.png" alt="Library - Tag Sets" data-original-src="https://i.octopus.com/blog/201512-library-tagsets-FJMW.png"/></p>

<p><em>请注意，这些标签目前意义不大——请继续阅读，了解如何利用这些不同的属性来实现一些引人注目的场景。</em></p>

<p>Octopus Deploy现在可以在配置您的环境时提供这些标记集，并且您可以配置您想要应用于每个环境的实际标记。看看下面，你会注意到标签集已经按照库中的顺序进行了排序。在本例中，我们将<code>Production-Tenant-Mobil</code>环境标记为属于<code>Production</code>阶段，托管在<code>Shared 2</code>托管组中，具有选定的模块，并作为<code>VIP</code>客户。</p>

<p><img src="../Images/b8f8dd0e566c6362e9e211c1b221327e.png" alt="Environment Settings - Tags" data-original-src="https://i.octopus.com/blog/201512-environmentsettings-tags-YZHW.png"/></p>

<p>如果您有许多环境，那么如果您能够管理哪些标签被批量应用到环境中，事情会容易得多。这将使您能够添加新的标记集，并快速标记您的所有环境。</p>

<p><img src="../Images/4606fea55b352b19f4e580034430d390.png" alt="Environments - Bulk Tag Edit" data-original-src="https://i.octopus.com/blog/201512-environments-bulktagedit-FU39.png"/></p>

<h3>改善环境页面<a name="improved-environments-page"/></h3>

<p>一旦你配置了一些标签集并标记了一些环境，Octopus就可以通过标签集聚集环境页面。您可以直接钻取其中一个标记，并显示匹配的环境。</p>

<p><img src="../Images/bee56419d72f7c52d766ac7b62034c49.png" alt="Environments - Rollup" data-original-src="https://i.octopus.com/blog/201512-environments-rollup-YJKX.png"/></p>

<h3>改进仪表板<a name="improved-dashboards"/></h3>

<p>在配置您的标记和环境之后，您可以将仪表板配置为按其中一个标记进行分组。Octopus可以聚集关于该组的最重要的信息，包括环境的数量、该组的整体状态(如果必要的话，用指示器来引起您的注意)、已经部署到所包含的环境中的版本的范围、以及向所包含的环境推出最新版本的进度。</p>

<p>在这个例子中，我们通过<strong>阶段</strong>标签对环境进行分组。</p>

<p><img src="../Images/4a568926b74673590f84b50af2ff3b4b.png" alt="Dashboard - By Phase" data-original-src="https://i.octopus.com/blog/201512-dashboard-byphase-PBXS.png"/></p>

<p>有些人可能对<strong>客户类型</strong>或其他聚合更感兴趣。</p>

<p><img src="../Images/0b14ec33567fce390905fa323e0783bf.png" alt="Dashboard - By Customer Type" data-original-src="https://i.octopus.com/blog/201512-dashboard-bycustomertype-LXX6.png"/></p>

<p>类似地，项目概述可以按标签分组，显示今天的发布历史。</p>

<p><img src="../Images/2a62d05828c7a2e663bd0e29406fa7f1.png" alt="Project Overview - By Phase" data-original-src="https://i.octopus.com/blog/201512-projectoverview-byphase-CCYB.png"/></p>

<p><img src="../Images/652db2a2bc2461355195daa2338cf14a.png" alt="Project Overview - By Customer Type" data-original-src="https://i.octopus.com/blog/201512-projectoverview-bycustomertype-QB3F.png"/></p>

<p>单击其中一个组可以深入到该组，并显示该组中环境的更多详细信息。在本例中，我们点击了<strong> 3.2.6-3.2.7 </strong>以查看该组的详细信息。请注意，我们现在可以垂直排列环境(不再水平滚动),并可能通过名称或其他标签过滤环境。我们还可以显示每个环境的发布历史，以及<code>Deploy</code>按钮，这样您就可以从同一个屏幕升级所有的<em>生产租户</em>。</p>

<p><img src="../Images/565a4d35568a75e050a1593b54085cab.png" alt="Project Overview - Details - Phase - Production" data-original-src="https://i.octopus.com/blog/201512-projectoverview-details-phase-production-4UKK.png"/></p>

<h3>通过标签引用环境<a name="referencing-environments-by-tag"/></h3>

<p>当您现在想在Octopus Deploy中引用一个环境时，您需要通过环境名显式地引用它。在您创建了一些标签集之后，您可以开始通过标签引用环境。考虑在标记集之前将部署目标配置为多个环境的共享主机<strong>的例子。</strong></p>

<p><img src="../Images/9f5ee0131f487a78d63801a1471d48a6.png" alt="Deployment Targets - By Name" data-original-src="https://i.octopus.com/blog/201512-deploymenttargets-byname-CD4U.png"/></p>

<p>有了标记，您可以简化这个部署目标，只需配置一次，并允许Octopus在运行时动态解析应用哪些环境。</p>

<p><img src="../Images/4c67048c14fa1d8d4bea5219f8ac794b.png" alt="Deployment Targets - By Tag" data-original-src="https://i.octopus.com/blog/201512-deploymenttargets-bytag-T7LH.png"/></p>

<p>虽然通过标签引用环境在很多方面会更方便，但根据每种情况的复杂性，它可能会变得更混乱。为了帮助驯服额外的复杂性，我们可以提供一个设计视图，类似于我们为设计通道的版本规则所做的。</p>

<p><img src="../Images/6247030e8322d3f896df01070658dd2b.png" alt="Select Environments - Designer" data-original-src="https://i.octopus.com/blog/201512-selectenvironments-designer-Z6PV.png"/></p>

<h3>管理生命周期、部署目标和账户<a name="managing-lifecycles-deployment-targets-and-accounts"/></h3>

<p>如果您可以通过标签引用环境，那么在生命周期、部署目标和帐户中管理环境将变得更加简洁和强大。例如，每当您添加一个新的环境时，Octopus可以<strong>根据其标签</strong>自动将该环境包含在正确的部署目标、生命周期阶段和帐户中。我们刚刚看到了一个部署目标的示例。在这个例子中，我们定义了一个简单的生命周期，其中每个阶段的环境都由<code>Phase: *</code>标签驱动。</p>

<p><img src="../Images/ed23d7a3730f6f5ad574038e1db797e9.png" alt="Lifecycle - By Tag" data-original-src="https://i.octopus.com/blog/201512-lifecycle-bytag-6TJ9.png"/></p>

<p>在本例中，所有标有<code>Phase: Production</code>的环境都将被授权使用<code>Synergy Production Subscription</code>账户。</p>

<p><img src="../Images/e17acb9418f0c0a4b143902928e4c27b.png" alt="Accounts - By Tag" data-original-src="https://i.octopus.com/blog/201512-accounts-bytag-M8RS.png"/></p>

<h3>范围变量和步骤<a name="scoping-variables-and-steps"/></h3>

<p>如果可以基于标记来确定范围，那么确定变量值的范围会更方便。在本例中，当我们部署到由<code>Phase: Production</code>标记定义的任何<em>生产租户</em>时，将使用变量值。</p>

<p><img src="../Images/5c12b1eb4b9056c2030096f075d1da06.png" alt="Scoping Variables - By Tag" data-original-src="https://i.octopus.com/blog/201512-scopingvariables-bytag-KY6K.png"/></p>

<p>类似地，确定部署步骤的范围会变得更加简单。在这个例子中，我们已经基于几个不同的标签定制了我们的部署过程。首先，我们将把<em>探索模块</em>部署给标记为<code>Module: Exploration</code>的租户。当标记为<code>Customer type: VIP</code>的VIP客户升级后，我们还会通知优先支持团队。一旦我们的<em>生产租户</em>成功完成部署，我们还将向他们发送定制的电子邮件通知，标签为<code>Phase: Production</code>。</p>

<p><img src="../Images/c5ed4b809825c362fb94a81e93c971e8.png" alt="Scoping Steps - By Tag" data-original-src="https://i.octopus.com/blog/201512-scopingsteps-bytag-QBUU.png"/></p>

<h3>管理特定于租户的变量<a name="managing-variables"/></h3>

<p>下一个难题是管理特定于每个租户的变量。为了解决这个问题，我们计划让您直接将变量添加到环境中，但是在我们开始之前，您如何知道哪些变量需要添加到这些环境中呢？想象一下，如果项目可以定义每个不同环境所需的变量，然后每个环境可以提示您它所需的变量。我们提议引入<strong>变量模板</strong>的概念。</p>

<h3>可变模板<a name="variable-templates"/></h3>

<p>变量模板可以允许项目定义成功部署所需的变量。我们认为变量模板作为复合部分将更易于管理，就像今天的项目变量和库变量集一样。每个项目都可以定义一组在不同环境之间变化的变量，可选地包括库中的公共变量模板。在本例中，项目定义了两个特定的变量模板，并包含了库中的两个变量集模板。</p>

<p><img src="../Images/69869d13d1368968cafa6d2bd5ca420b.png" alt="Project - Variable Set Template" data-original-src="https://i.octopus.com/blog/201512-project-variablesettemplate-44FV.png"/></p>

<p>这些变量模板中的每一个都可以以类似于为步骤模板定义参数<a href="http://docs.octopusdeploy.com/display/OD/Step+Templates" target="_blank">的方式进行定义，其中您可以提供变量名、标签、帮助文本、默认值和输入控制类型，如单行/多行文本框、敏感/密码框、复选框或下拉菜单。</a></p>

<h3>环境变量集<a name="environment-variable-sets"/></h3>

<p>如今，许多使用Octopus进行多租户部署的客户将为每个租户创建一个库变量集。我们建议将变量作为环境设置的一部分。这样，您可以将所有特定于环境的变量指定为环境本身的一部分，而Octopus会自动地、隐式地将这些变量限定在该环境中。当您将一个版本部署到一个特定的环境中时，Octopus会自动合并该环境中的变量集。</p>

<p>项目已经通过生命周期的方式映射到环境中，因此很自然地假设环境将使用通过生命周期链接到的任何项目中的可变模板。</p>

<p><img src="../Images/7d11548b152627a7478e2d29449aa404.png" alt="Mapping Projects to Environments" data-original-src="https://i.octopus.com/blog/201512-mappingprojectstoenvironments-VRVS.png"/></p>

<p>在这个例子中，Synergy项目将被部署到这个环境中，基于Synergy中定义的可变模板，我们需要:</p>

<ul>
<li><code>CustomerName</code>和<code>TenantAlias</code>来自<code>Standard tenant details</code>库变量集模板</li>
<li><code>StorageAccountUri</code>来自<code>Common storage account</code>库变量集模板</li>
<li><code>Synergy</code>项目中的<code>SynergyDatabase</code>和<code>SynergyApiKey</code></li>
<li><code>MojoDatabase</code>来自<code>Mojo</code>项目</li>
</ul>

<p><img src="../Images/5fbfb7844ff162a7bce7c5ce4b8156a7.png" alt="Environment Settings - Variables" data-original-src="https://i.octopus.com/blog/201512-environmentsettings-variables-8FPM.png"/></p>

<p>在这种情况下，我们没有为<code>MojoDatabase</code>变量定义一个值，而是被提示设置该值。</p>

<h3>变量检查器<a name="variable-inspector"/></h3>

<p>如今，Octopus Deploy中的变量一般来自项目、库变量集或step模板。添加环境作为变量的来源将简化管理变量的某些方面，但是诊断变量的问题可能会变得更加困难。我们建议添加一个变量检查器，这将使它更容易获得一个项目中所有变量的概览，它们的来源，以及是否有任何问题。</p>

<p><img src="../Images/558b72f11002904a8cac49abaf298020.png" alt="Variable Inspector" data-original-src="https://i.octopus.com/blog/201512-variableinspector-EB5Z.png"/></p>

<h2>不仅仅是多租户<a name="not-just-multi-tenancy"/></h2>

<p>如今，在Octopus Deploy中管理大规模多租户部署显然是一件痛苦的事情。我们相信RFC中提出的功能将使我们的大多数客户受益。考虑这些场景:</p>

<ul>
<li>类似于多租户的其他使用案例:<ul>
<li>管理公共云中的多区域部署，您将部署到几个地理区域，但将它们都视为<em>生产</em>。</li>
<li>有多个测试工程师的团队，每个人都有自己的测试环境。</li>
<li>动态试运行/退役特性分支环境，用于在正常的开发/测试/生产生命周期之前测试新特性。</li>
</ul></li>
<li>开始一个新项目，您配置开发和测试环境。几周后，您希望添加试运行和生产环境，但是忘记了需要为这些新环境添加哪些新变量。</li>
<li>出于各种原因，简单地管理大量的环境和变量。</li>
<li>出于内聚/权威/安全的原因，希望将特定于环境的变量直接保存在环境中。</li>
<li>想给你的项目变量添加更多的结构。</li>
</ul>

<h2>收尾<a name="wrapping-up"/></h2>

<p>有了这些功能，我们希望与管理大规模多租户部署相关的痛苦将得到显著缓解。考虑创建新租户会涉及哪些内容:</p>

<ul>
<li>为名为<code>Production-CustomerA</code>的租户创建新环境<ul>
<li>根据需要添加标签</li>
<li>输入提示变量</li>
</ul></li>
<li>将最新版本部署到<code>Production-CustomerA</code>环境中</li>
<li>利润！</li>
</ul>

<h2>留下评论<a name="leave-a-comment"/></h2>

<p>你怎么想呢?这是您畅所欲言并帮助我们为您的环境构建合适功能的机会。</p>

                    
                    
</body>
</html>