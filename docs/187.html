<html>
<head>
<title>Deploying a Java web app with a MySQL backend through Octopus Deploy - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>通过Octopus Deploy - Octopus Deploy部署带有MySQL后端的Java web应用程序</h1>
<blockquote>原文：<a href="https://octopus.com/blog/deploying-java-with-mysql#2021-08-12">https://octopus.com/blog/deploying-java-with-mysql#2021-08-12</a></blockquote>
                        <p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/deploy-java-and-mysql.png" class="zoom" data-title=""><img src="../Images/46474f80ea27f7292bc79052a3325fef.png" class="img-fluid center" alt="Deploying a Java web app with a MySQL backend with Octopus Deploy" data-original-src="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/deploy-java-and-mysql.png"/>T2】</a></p>

<p>在本文中，我将介绍如何构建和部署一个使用MySQL后端数据库的基于Java的web应用程序。</p>

<h2 id="setting-up-the-build-server">设置构建服务器</h2>

<p>对于这个演示，我使用Azure DevOps作为我的构建服务器。当人们想到Azure DevOps时，他们会立即想到。NET/。NET核心，不是Java。但是，Microsoft build server的任务库中内置了Maven和ANT构建任务。</p>

<p>等等，好像是...太容易了。</p>

<p>您的怀疑是正确的，尽管任务确实存在，但如果没有一点配置，它们实际上是无法工作的。对我们来说幸运的是，这一切都很简单。</p>

<h3 id="java-on-the-build-agent">构建代理上的Java</h3>

<p>要构建Java，需要在构建代理上安装Java开发工具包(JDK)，可以从<a href="https://openjdk.java.net/" rel="nofollow"> OpenJDK </a>下载。如果您像我一样是Windows用户，要使Java正常工作，还需要两个额外的步骤:</p>

<ul>
<li>创建JAVA_HOME环境变量，并将其设置为JAVA安装的根目录(即c:\Program Files\Java)。</li>
<li>将\bin文件夹添加到Path环境变量中(即c:\ Program Files \ Java \ jav exversion \ bin)。</li>
</ul>

<h3 id="maven-on-the-build-agent">构建代理上的Maven</h3>

<p>我们需要做的下一件事是在我们的构建代理上安装Maven。Maven没有安装程序，它是一个. zip文件，需要提取出来放在构建代理上。与Java类似，我们需要配置环境变量:</p>

<ul>
<li>创建MAVEN_HOME并指向提取MAVEN的位置(即c:\maven)。</li>
<li>将\bin文件夹添加到Path环境变量中(即c:\maven\bin)。</li>
</ul>

<h3 id="add-the-maven-capability">添加Maven功能</h3>

<p>如果您正在创建一个新的构建代理，这一步可能是不必要的，代理安装的一部分会扫描机器的功能，如果找到的话会自动添加Maven。如果您使用的是现有的代理，您需要进入Azure DevOps (ADO)并手动为代理添加功能。</p>

<p>导航到ADO的代理池部分。选择您想要修改的代理并点击<strong>功能</strong>:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/ado-agent-pools.png" class="zoom" data-title=""><img src="../Images/b0892110e497a8a8c9218574fb8ddf06.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/ado-agent-pools.png"/>T2】</a></p>

<p>点击<strong>添加功能</strong>按钮，添加以下内容(参见我使用的值的截图):</p>

<ul>
<li>JAVA_HOME</li>
<li>专家</li>
<li>MAVEN_HOME</li>
</ul>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/ado-add-capability.png" class="zoom" data-title=""><img src="../Images/2260291d5e388fe5739d102997e6fe0a.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/ado-add-capability.png"/>T2】</a></p>

<p>现在，您的ADO实例可以构建Maven项目。</p>

<p>配置ADO以构建ANT项目的步骤几乎与此相同。对于构建代理和功能部分，用ANT替换Maven。</p>


<h2 id="the-sample-application">示例应用程序</h2>

<p>在这个演示中，我使用的是<a href="https://github.com/spring-petclinic/spring-framework-petclinic" rel="nofollow"> Pet Clinic </a>示例应用程序，它最初是为了演示Spring框架的功能而开发的。Pet Clinic已经配置为使用Maven构建，并且能够使用MySQL作为数据库后端。开箱即用，宠物诊所是完全功能性的，所以我们自然要修改它。</p>

<h3 id="tweaking-the-pom">调整POM</h3>

<p>我需要对POM做一些调整。XML (Maven项目对象模型)文件，使其适用于本文:</p>

<ul>
<li>使用变量使<code>&lt;version&gt;</code>属性动态化。</li>
<li>将活动配置文件切换到MySQL。</li>
<li>更改MySQL概要文件的<code>jdbc.url</code>以使用变量。</li>
<li>改变<code>finalName</code>属性。</li>
<li>更新<code>cssDestinationFolder</code>属性。</li>
</ul>

<h4 id="making-the-version-number-dynamic">使版本号动态化</h4>

<p>原始项目中的版本号是硬编码的，但是我想根据内部版本号使它成为一个动态值。这很容易通过在Maven构建过程中插入变量来实现。在POM.xml文件中找到<code>&lt;version&gt;5.2.1&lt;/version&gt;</code>，并将其更改为<code>&lt;version&gt;${project.versionNumber}&lt;/version&gt;</code>。</p>

<p>变量名<code>project.versionNumber</code>是我选的名字，不过你想怎么命名都行。</p>


<h4 id="change-the-active-database-profile-to-mysql">将活动数据库配置文件更改为MySQL</h4>

<p>这个报告的作者在使这个应用程序支持多个数据库后端方面做了出色的工作:HyperSQL、MySQL和PostgreSQL。默认设置为HyperSQL配置文件(HSQLDB)。要将其更改为MySQL，只需将<code>&lt;activation&gt;</code> XML节点从HSQLDB概要文件移动到MySQL概要文件。</p>

<p>为此:</p>

<ol>
<li>在POM中找到<code>&lt;profiles&gt;</code> XML节点。XML文件。</li>
<li>找到子节点为<code>&lt;id&gt;HSQLDB&lt;/id&gt;</code>的<code>&lt;profile&gt;</code>节点。在<code>&lt;id&gt;</code>节点的正下方是一个<code>&lt;activation&gt;</code>节点。</li>
<li>将<code>&lt;activation&gt;</code>节点移动到MySQL节点。</li>
</ol>

<p>生成的MySQL节点应该如下所示:</p>

<pre><code>&lt;profile&gt;
    &lt;id&gt;MySQL&lt;/id&gt;
    &lt;activation&gt;
        &lt;activeByDefault&gt;true&lt;/activeByDefault&gt;
    &lt;/activation&gt;            
    &lt;properties&gt;
        &lt;db.script&gt;mysql&lt;/db.script&gt;
        &lt;jpa.database&gt;MYSQL&lt;/jpa.database&gt;
        &lt;jdbc.driverClassName&gt;com.mysql.jdbc.Driver&lt;/jdbc.driverClassName&gt;
        &lt;jdbc.url&gt;jdbc:mysql://${databaseServerName}/${databaseName}?useUnicode=true&lt;/jdbc.url&gt;
        &lt;jdbc.username&gt;root&lt;/jdbc.username&gt;
        &lt;jdbc.password&gt;&lt;/jdbc.password&gt;
    &lt;/properties&gt;
    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;mysql&lt;/groupId&gt;
            &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;
            &lt;version&gt;${mysql-driver.version}&lt;/version&gt;
            &lt;scope&gt;runtime&lt;/scope&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;
&lt;/profile&gt;
</code></pre>

<h4 id="alter-the-jdbc.url-of-the-my-profile-to-use-variables">更改我的概要文件的jdbc.url以使用变量</h4>

<p>当编译Maven项目时，活动数据库概要文件的属性被复制到结果中的<code>/WEB-INF/classes/spring/datasource-config.xml</code>文件中。战争档案。<code>datasource-config.xml</code>是用于该应用程序数据库连接字符串的文件。在上面的代码示例中，我们将服务器和数据库的连接字符串改为使用变量<code>databaseServerName</code>和<code>databaseName</code>:</p>

<pre><code>&lt;jdbc.url&gt;jdbc:mysql://${databaseServerName}/${databaseName}?useUnicode=true&lt;/jdbc.url&gt;
</code></pre>

<h4 id="alter-the-finalname-attribute">更改finalName属性</h4>

<p>POM的<code>finalName</code>属性。XML是。战争档案将在项目打包时给出。默认<code>finalName</code>为<code>petclinic</code>:</p>

<pre><code>&lt;finalName&gt;petclinic&lt;/finalName&gt;
</code></pre>

<p>构建时，这会产生一个petclinic.war的文件名。Octopus Deploy使用<a href="https://semver.org/" rel="nofollow">语义版本化</a>，文件名中嵌入了一个版本号。POM的<code>version</code>属性。XML文件将非常适合这种情况，因为我们已经将它动态化了。将您的<code>&lt;finalName&gt;</code>属性更新为:</p>

<pre><code>&lt;finalName&gt;petclinic.web.${project.version}&lt;/finalName&gt;
</code></pre>

<p>我添加了<code>.web.</code>部分，以便更容易地识别这是Octopus Deploy中的哪个组件。</p>

<h4 id="update-cssdestinationfolder-attribute">更新cssDestinationFolder属性</h4>

<p>当我在本地系统上完成这项工作时，当我更改POM的<code>finalName</code>属性时，我遇到了令人讨厌的意外；没有一个css能成为最终产品。经过一些故障排除后，我发现将css复制到应用程序中的操作使用了<code>finalName</code>值作为复制到的路径。为了解决这个问题，我更新了<code>&lt;cssDestinationFolder&gt;</code>属性:</p>

<pre><code>&lt;cssDestinationFolder&gt;${project.build.directory}/petclinic/resources/css&lt;/cssDestinationFolder&gt;
</code></pre>

<p>收件人:</p>

<pre><code>&lt;cssDestinationFolder&gt;${project.build.directory}/petclinic.web.${project.version}/resources/css&lt;/cssDestinationFolder&gt;
</code></pre>

<p>如果您的应用程序呈现以下图像，则您的<code>&lt;cssDestinationFolder&gt;</code>不正确:</p>
<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/css-folder-incorrect.png" class="zoom" data-title=""><img src="../Images/8e3c7df7cf4567b8c7be917da3c26a45.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/css-folder-incorrect.png"/>T2】</a></p>


<h3 id="updating-datasource-config.xml">更新datasource-config.xml</h3>

<p>通过这个示例应用程序，我了解到无论何时部署它，它都会运行包含的数据库脚本。经过一番挖掘，我发现我可以在datasource-config.xml文件中注释掉一些XML来阻止这种情况。我仍然需要数据库脚本，我只是不希望每次部署应用程序时都执行它们。稍后将详细介绍。</p>

<p>导航到<code>/src/main/resources/spring/datasource-config.xml</code>并注释掉数据库初始化器部分。它应该是这样的:</p>

<pre><code>    &lt;!-- Database initializer. If any of the script fails, the initialization stops. --&gt;
    &lt;!-- As an alternative, for embedded databases see &lt;jdbc:embedded-database/&gt;. --&gt;
    &lt;!--
    &lt;jdbc:initialize-database data-source="dataSource"&gt;
        &lt;jdbc:script location="${jdbc.initLocation}"/&gt;
        &lt;jdbc:script location="${jdbc.dataLocation}"/&gt;
    &lt;/jdbc:initialize-database&gt;
    --&gt;
</code></pre>

<h2 id="adding-a-flyway-project">添加飞行路线项目</h2>

<p>Flyway 是一款基于迁移的数据库部署工具。简而言之，它是一个包含在项目中的命令行实用程序，使用特定的文件夹结构以指定的顺序执行SQL脚本。Flyway下载本质上是您将添加到项目源代码控制中的项目。</p>

<h3 id="adding-the.sql-scripts-to-flyway">添加。到Flyway的sql脚本</h3>

<p>在Java应用程序源代码中，复制。位于Flyway项目的<code>src/main/resources/db/mysql</code>到<code>/sql</code>文件夹的sql文件。然后，重命名文件以符合<a href="https://flywaydb.org/getstarted/how" rel="nofollow"> Flyway的工作方式</a>。例如:</p>

<ul>
<li>V1__initDb.sql</li>
<li>V1_1__populateDb.sql</li>
</ul>

<p>就是这样！</p>

<h2 id="creating-the-build-definition">创建生成定义</h2>

<p>现在我们已经完成了在构建代理上安装Maven的先决条件工作，调整了几个文件，并添加了Flyway，我们可以创建我们的构建定义了。</p>

<h3 id="adding-the-maven-task">添加Maven任务</h3>

<p>创建一个新的构建定义，这个演示使用经典编辑器而不是YAML方法:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/ado-create-new-build.png" class="zoom" data-title=""><img src="../Images/a8c309a63abdd94884888ce0e762188d.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/ado-create-new-build.png"/>T2】</a></p>

<p>从空工单开始:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/ado-empty-job.png" class="zoom" data-title=""><img src="../Images/a86f7e0cceb549c1ee7d56732b5ad8d8.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/ado-empty-job.png"/>T2】</a></p>

<p>添加Maven构建任务:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/ado-add-maven-task.png" class="zoom" data-title=""><img src="../Images/4e15439468cef70354277d12a87d0f4d.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/ado-add-maven-task.png"/>T2】</a></p>

<p>填写任务输入字段:</p>

<ul>
<li>显示名称:          <ul>
<li>这个值不重要。</li>
</ul>
</li>
<li>Maven POM文件:          <ul>
<li>如果您的<code>pom.xml</code>不在根文件夹中，使用省略号(…)找到它。</li>
</ul>
</li>
<li>目标:          <ul>
<li><code>clean package dependency:purge-local-repository</code></li>
</ul>
</li>
<li>选项:          <ul>
<li><code>-Dproject.versionNumber=$(Build.BuildNumber) -DdatabaseServerName=$(DatabaseServerName) -DdatabaseName=$(DatabaseName) -DskipTests=$(SkipTests)</code></li>
</ul>
</li>
</ul>

<p>dependency:purge-local-repository目标可能没有必要，但是我喜欢在构建时清理我的sources文件夹。</p>


<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/ado-maven-fields.png" class="zoom" data-title=""><img src="../Images/8dedb35359f8f3488e78f2f8cbaef3dc.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/ado-maven-fields.png"/>T2】</a></p>

<p>导航到变量并创建以下内容:</p>

<ul>
<li>数据库名称:<code>#{Project.MySql.Database.Name}</code></li>
<li>数据库服务器名称:<code>#{Project.MySql.Database.ServerName}</code></li>
<li>船长:<code>true</code></li>
</ul>

<p>如果您不熟悉变量值使用的#语法，Octopus Deploy使用它来替换变量。</p>

<p>跳过测试是必要的，因为测试试图连接到数据库后端。因为我们将它们作为部署过程的变量，所以连接尝试将会失败，并使构建完全失败:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/ado-project-variables.png" class="zoom" data-title=""><img src="../Images/d79da454ff9470bd06faf736ebe4e643.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/ado-project-variables.png"/>T2】</a></p>

<p>您会注意到定义了两个额外的变量；<code>MajorVersion</code>和<code>MinorVersion</code>。我使用这些变量在ADO中创建我的内部版本号格式。要对此进行设置，单击Options选项卡并填写构建号格式，我使用了<code>$(MajorVersion).$(MinorVersion).$(Year:yy)$(DayOfYear).$(Date:Hmmss)</code>:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/ado-build-number-format.png" class="zoom" data-title=""><img src="../Images/f41c0189ad1b2f1b2be57e2f71dd3ae2.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/ado-build-number-format.png"/>T2】</a></p>

<p>这是ADO对<code>$(Build.BuildNumber)</code>的引用值，我们将它输入到传递给Maven构建任务的<code>project.VersionNumber</code>变量中。</p>

<p>Maven任务到此为止。<code>.war</code>是Octopus Deploy中内置包存储库支持的文件类型，因此不需要打包Java应用程序。</p>

<h3 id="packaging-the-flyway-project">打包飞行路线项目</h3>

<p>如前所述，Flyway是一个命令行实用程序，所以没有构建项目。我们唯一需要做的就是打包它，以便Octopus Deploy可以用它做一些事情。为此，我们可以使用任何创建ZIP或NuGet包的任务。本演示使用Octopus部署插件，打包应用程序任务:</p>

<ul>
<li>包ID: <code>petclinic.flyway</code></li>
<li>包装格式:<code>NuPkg</code></li>
<li>包版本:<code>$(Build.BuildNumber)</code></li>
<li>来源路径:<code>$(Build.SourcesDirectory)\flyway</code></li>
<li>输出路径:<code>$(build.stagingdirectory)</code></li>
</ul>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/ado-build-add-flyway-package.png" class="zoom" data-title=""><img src="../Images/c40a33e8744696e7c2db44357f21e6e5.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/ado-build-add-flyway-package.png"/>T2】</a></p>

<h3 id="pushing-to-octopus-deploy">推进到章鱼部署</h3>

<p>构建过程的最后一部分是将我们创建的包推送到我们的Octopus Deploy服务器。添加推送至Octopus部署任务:</p>

<ul>
<li>空间:选择您的空间。</li>
<li>包装:</li>
<li><code>$(Build.SourcesDirectory)\target\*.war</code></li>
<li><code>$(build.artifactstagingdirectory)\*.nupkg</code></li>
</ul>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/ado-build-push-packages.png" class="zoom" data-title=""><img src="../Images/bd8fd6df50d3b607f370254e47840e41.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/ado-build-push-packages.png"/>T2】</a></p>

<p>这就是您的构建定义。</p>

<h2 id="creating-the-octopus-deploy-project">创建Octopus部署项目</h2>

<p>在Octopus Deploy web门户中，单击项目选项卡，然后单击<strong>添加项目</strong>:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/octopus-create-project.png" class="zoom" data-title=""><img src="../Images/2ba0fc05b1f8b4169816a3561b5b3864.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/octopus-create-project.png"/>T2】</a></p>

<p>给项目命名，然后点击<strong>保存</strong>。或者，您可以选择将其放入哪个项目组以及使用哪个生命周期:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/octopus-project-name.png" class="zoom" data-title=""><img src="../Images/179b21e9ece29d175307935530218ac5.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/octopus-project-name.png"/>T2】</a></p>

<h3 id="variables">变量</h3>

<p>点击<strong>保存</strong>后，我们将直接进入我们全新的项目。单击变量来定义我们的一些变量，因为在我们定义流程之前，我们需要它们先存在:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/octopus-project-variables.png" class="zoom" data-title=""><img src="../Images/a8f996c71fd68d63e3a794b28a808d7e.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/octopus-project-variables.png"/>T2】</a></p>

<p>在变量屏幕上，我们创建以下变量:</p>

<ul>
<li><code>Project.MySql.Database.Name</code></li>
<li><code>Project.MySql.Database.ServerName</code></li>
<li><code>Project.MySql.Database.User.Name</code></li>
<li><code>Project.MySql.Database.User.Password</code></li>
</ul>

<p>为变量命名空间被认为是Octopus Deploy的最佳实践；它帮助用户识别变量的来源和用途。</p>

<h4 id="project.mysql.database.name">项目。MySql .数据库.名称</h4>

<p>这个变量是我们在构建过程中使用#语法设置的变量之一。我们将很快介绍变量是如何被替换的。现在，给这个变量取数据库名的值。在我的例子中，我使用了<code>petclinic</code>。</p>

<h4 id="project.mysql.database.servername">项目。MySql .数据库.服务器名</h4>

<p>当您从一个环境转到另一个环境时，数据库服务器通常是不同的。此变量将使用部署到的环境范围内的值。</p>

<h4 id="project.mysql.database.user.name">项目。MySql.Database .用户名</h4>

<p>顾名思义，这是数据库连接的用户名。</p>

<h4 id="project.mysql.database.user.password">项目。MySql .数据库.用户.密码</h4>

<p>这是数据库连接的用户帐户密码:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/octopus-project-variables-values.png" class="zoom" data-title=""><img src="../Images/6033596096b7b5121718bf5eb04dd77b.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/octopus-project-variables-values.png"/>T2】</a></p>

<h3 id="process">过程</h3>

<p>定义好变量后，让我们创建流程。点击<strong>进程</strong>按钮:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/octopus-project-process-tab.png" class="zoom" data-title=""><img src="../Images/7f9c40542e45e751cf5c920d3ef86fff.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/octopus-project-process-tab.png"/>T2】</a></p>

<h4 id="add-deploy-package-step">添加部署包步骤</h4>

<p>在过程屏幕上，点击<strong>添加步骤</strong>按钮:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/octopus-project-add-step.png" class="zoom" data-title=""><img src="../Images/b2dd5debd2f92b537a0f28d2de23dd77.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/octopus-project-add-step.png"/>T2】</a></p>

<p>选择<strong>包</strong>类别和<strong>部署包</strong>步骤:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/octopus-project-add-deploy-package.png" class="zoom" data-title=""><img src="../Images/0772112e52297eb30d4f7c669b953eb9.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/octopus-project-add-deploy-package.png"/>T2】</a></p>

<p>填写步骤的属性:</p>

<ul>
<li>步骤名称:<code>Deploy Flyway package</code>。</li>
<li>关于目标角色:<code>PetClinic-Db</code>(这是我给角色起的名字)。</li>
<li>包装:<code>petclinic.flyway</code>。</li>
</ul>

<p>这是点击<strong>保存</strong>后的步骤:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/octopus-flyway-package-step.png" class="zoom" data-title=""><img src="../Images/c662f534ca98e29474644844ada2462b.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/octopus-flyway-package-step.png"/>T2】</a></p>

<h5 id="variable-replacement-optional">变量替换(可选)</h5>

<p>如果您在任何。sql脚本(我做了)，您需要配置这个步骤来执行变量替换。</p>

<p>点击<strong>配置功能</strong>按钮:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/octopus-project-step-configure-features.png" class="zoom" data-title=""><img src="../Images/ce5e61911980eb69288fcf589f3a5ebb.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/octopus-project-step-configure-features.png"/>T2】</a></p>

<p>选择<strong>文件中的替代变量</strong>:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/octopus-project-step-variable-replacement.png" class="zoom" data-title=""><img src="../Images/68e63137df442d3c58075e742820664f.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/octopus-project-step-variable-replacement.png"/>T2】</a></p>

<p>点击<strong>确定</strong>，然后向下滚动并展开文件中的替代变量部分。对于<strong>目标文件</strong>，输入值<code>sql/*.sql</code>，点击<strong>保存</strong>:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/octopus-project-step-variable-replacement-sql.png" class="zoom" data-title=""><img src="../Images/4242b400cdfd7831d1af98de2a031692.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/octopus-project-step-variable-replacement-sql.png"/>T2】</a></p>

<h4 id="add-the-flyway-migrate-step">添加Flyway迁移步骤</h4>

<p>社区步骤模板库中提供了此步骤。</p>

<p>和前面一样，点击<strong>添加步骤</strong>按钮。当窗口出现时，键入flyway来过滤步骤。鼠标悬停飞行路线迁移并点击<strong>安装并添加</strong>:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/octopus-community-steps.png" class="zoom" data-title=""><img src="../Images/db82c0ecf4184f793c1fb26380969cb1.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/octopus-community-steps.png"/>T2】</a></p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/octopus-community-flyway.png" class="zoom" data-title=""><img src="../Images/e3aa167db5cb4ff897a072194fd9995f.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/octopus-community-flyway.png"/>T2】</a></p>

<p>系统会提示您安装并添加，点击<strong>保存</strong>:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/octopus-community-install.png" class="zoom" data-title=""><img src="../Images/32709b30e99bf97fb17bb255c2a36da3.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/octopus-community-install.png"/>【T34】T2】</a></p>

<p>填写步骤模板的必需属性:</p>

<ul>
<li>关于角色中的目标:<code>PetClinic-Db</code>(这是我给角色起的名字)。</li>
<li>飞行路径包步骤:使用下拉菜单选择<strong>部署飞行路径包</strong>步骤。</li>
<li>目标网址:<code>jdbc:mysql://#{Project.MySql.Database.ServerName}/#{Project.MySql.Database.Name}?useUnicode=true</code></li>
<li>目标用户:<code>#{Project.MySql.Database.User.Name}</code></li>
<li>目标密码:<code>#{Project.MySql.Database.User.Password}</code></li>
</ul>

<p>由于这是一个敏感变量，我们需要单击Bind图标来设置它使用一个变量:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/octopus-project-step-bind.png" class="zoom" data-title=""> T14 </a> T16 <img src="../Images/271d0d3195f1990710d5443cd9dfe7b6.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/octopus-project-step-password.png"/> T18】</p>

<p>这一步就这样，点击<strong>保存</strong>。</p>

<p>在撰写本文时，必须在目标上执行部署包步骤和Flyway迁移步骤。然而，Flyway迁移步骤的工人友好版本正在审查中。</p>


<h4 id="deploying-the-website-step">部署网站步骤</h4>

<p>Octopus Deploy为两个最流行的基于Java的应用程序的web服务器Tomcat和JBOSS/wildly提供了内置步骤。这个演示使用了野花步骤。</p>

<p>像以前一样，点击<strong>添加步骤</strong>，然后按野花过滤。选择<strong>部署到Wildfly或EAP </strong>步骤模板:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/octopus-project-add-wildfly.png" class="zoom" data-title=""><img src="../Images/cc4c95970518a8b68fbe457f1449ecae.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/octopus-project-add-wildfly.png"/>T2】</a></p>

<p>填写步骤模板的详细信息:</p>

<ul>
<li>步骤名称:<code>Deploy Petclinic Web</code></li>
<li>关于角色中的目标:<code>Petclinic-Web</code></li>
<li>包ID: <code>petclinic.web</code></li>
<li>管理主机或IP: <code>#{Octopus.Machine.Hostname}</code>(这是一个系统变量，使用要部署到的机器的主机名。)</li>
<li>管理用户:<code>[Your management user]</code></li>
<li>管理密码:<code>[Password for management account]</code></li>
<li>部署名称:<code>PetClinic.war</code></li>
</ul>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/octopus-project-step-wildfly.png" class="zoom" data-title=""><img src="../Images/58ccc9963546297569e9865a5bfe7afe.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/octopus-project-step-wildfly.png"/>T2】</a></p>

<p>对于Wildfly步骤，还有最后一件要配置的事情，替换datasource-config.xml中的# variables。单击<strong>配置特性</strong>按钮并选择<strong>替换文件</strong>中的变量，就像我们在<strong>部署包</strong>步骤中所做的那样。在<strong>目标文件</strong>部分，输入以下值<code>WEB-INF/classes/spring/datasource-config.xml</code>。</p>

<p>使用<code>/</code>而不是<code>\</code>是为了支持Linux部署目标，并且仍然适用于Windows目标。</p>


<p>就是这样。让我们创建我们的第一个版本。</p>

<h2 id="deployment-time">部署时间</h2>

<p>我们现在准备部署我们的应用程序。点击<strong>创建发布</strong>按钮:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/octopus-project-create-release.png" class="zoom" data-title=""><img src="../Images/74d0ca96c9e56de2d44a45ccc0ed068b.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/octopus-project-create-release.png"/>T2】</a></p>

<p>点击<strong>保存</strong>:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/octopus-project-create-release-save.png" class="zoom" data-title=""><img src="../Images/2d374e43be17cb95a59ec855226f0d3f.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/octopus-project-create-release-save.png"/>T2】</a></p>

<p>点击<strong>部署到开发</strong>(用您命名的环境替换开发):</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/octopus-project-deploy.png" class="zoom" data-title=""><img src="../Images/edb8dddc58d7c1da08cbde2ee6eabd46.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/octopus-project-deploy.png"/>T2】</a></p>

<p>点击<strong>展开</strong>:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/octopus-project-deploy-execute.png" class="zoom" data-title=""> T32 </a></p>

<p>完成后，您应该会看到如下所示的屏幕:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/octopus-project-deployment-complete.png" class="zoom" data-title=""><img src="../Images/800c8d6c228ed919dc67773033da1973.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/octopus-project-deployment-complete.png"/></a>T2】</p>

<p>注意，web服务器的部署被部署到两个服务器上，Wildfly1 (Windows)和Wildfly2 (Linux)。</p>

<p>点击<strong>任务日志</strong>标签，查看关于我们部署的更多详细信息:</p>

<p>飞行方式:<a href="#" data-featherlight="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/octopus-project-deployment-mysql.png" class="zoom" data-title=""> <img src="../Images/ebcdf23f850a20638617d99cfe798f7b.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/octopus-project-deployment-mysql.png"/> </a></p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/octopus-project-deployment-wildfly.png" class="zoom" data-title=""> <img src="../Images/33a0accc6d3d846e63ea8c1c45d71c58.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/octopus-project-deployment-wildfly.png"/> </a>野花</p>

<p>宠物诊所:<a href="#" data-featherlight="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/petclinic-web.png" class="zoom" data-title=""> <img src="../Images/c59c5374185a5e11662c9550020fec86.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/petclinic-web.png"/> </a></p>

<h2 id="conclusion">结论</h2>

<p>在本文中，我们配置了一个CI/CD管道来构建和部署一个基于Java的web应用程序，使用Flyway来管理MySQL数据库！</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/java-octopus-placeholder.png" class="zoom" data-title=""><img src="../Images/2fb09c53406106833564ff7b25532a9f.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2020-01/deploying-java-with-mysql/java-octopus-placeholder.png"/>T2】</a></p>

                    
                    
</body>
</html>