<html>
<head>
<title>Running SQL Server Developer in a Linux-based Docker Container - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>在基于Linux的Docker容器- Octopus Deploy中运行SQL Server Developer</h1>
<blockquote>原文：<a href="https://octopus.com/blog/automate-sql-server-install-using-linux-docker#2021-08-12">https://octopus.com/blog/automate-sql-server-install-using-linux-docker#2021-08-12</a></blockquote>
                        <p><a href="#" data-featherlight="https://i.octopus.com/blog/2019-10/automate-sql-server-install-using-linux-docker/sql_server_docker_linux_container.png" class="zoom" data-title=""><img src="../Images/edb401e660cc221abf532794f7f8b27b.png" class="img-fluid center" alt="SQL Server database in a Linux-based Docker container on an iceberg with a Docker container ship in the background" data-original-src="https://i.octopus.com/blog/2019-10/automate-sql-server-install-using-linux-docker/sql_server_docker_linux_container.png"/>T2】</a></p>

<p>我的<a href="/blog/running-sql-server-developer-install-with-docker">上一篇文章</a>讲述了如何让SQL Server在基于Windows的Docker容器中运行。然而，Docker是为托管基于Linux的容器而设计的，与基于Windows的容器相比，它具有以下优点。</p>

<ul>
<li>开销少得多。</li>
<li>更多可用功能。</li>
<li>更多图片可用。</li>
<li>更多使用中的容器示例。</li>
</ul>

<p>SQL Server可以在基于Linux的容器上运行。在本文中，我将介绍在基于Linux的容器中启动和运行SQL Server的必要条件。</p>



<h2 id="prep-work">准备工作</h2>

<p>本文使用<a href="https://hub.docker.com/editions/community/docker-ce-desktop-windows" rel="nofollow"> Docker桌面</a>。我之前的文章介绍了<a href="/blog/running-sql-server-developer-install-with-docker">安装Docker桌面</a>的步骤，所以我在这里不再重复。</p>

<p>Docker桌面唯一的缺点是你不能同时运行基于Windows的容器和基于Linux的容器。如果您一直在使用基于Windows的容器，您可以通过右键单击任务栏中的Docker图标并选择<code>Switch to Linux containers...</code>来切换到Linux容器。默认情况下，Docker桌面从Linux容器开始:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2019-10/automate-sql-server-install-using-linux-docker/docker-desktop-switch-to-linux-containers.png" class="zoom" data-title=""><img src="../Images/7581fe3da25df00dd651b05df56f763a.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2019-10/automate-sql-server-install-using-linux-docker/docker-desktop-switch-to-linux-containers.png"/>T2】</a></p>

<p>Docker将所有容器视为无状态。预计对容器所做的任何更改(如创建数据库)都将被销毁。我们将通过使用体积来解决这个问题。切换到Linux容器后，右键单击任务栏中的Docker桌面图标，然后进入设置。在设置中，选择共享驱动器选项。单击复选框，与Docker共享您选择的驱动器。在我的情况下，我只有<code>C:\</code>驱动器:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2019-10/automate-sql-server-install-using-linux-docker/docker-share-c-drive.png" class="zoom" data-title=""><img src="../Images/325a75e02427569d28c2e65646280eae.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2019-10/automate-sql-server-install-using-linux-docker/docker-share-c-drive.png"/>T2】</a></p>

<p>我想将数据库存储在我的<code>C:\</code>驱动器上的文件夹<code>C:\DockerLinux\Volumes\SQLServer</code>中:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2019-10/automate-sql-server-install-using-linux-docker/folder-for-database-files.png" class="zoom" data-title=""><img src="../Images/77f960e9c81864a6e00af7f6aab314d3.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2019-10/automate-sql-server-install-using-linux-docker/folder-for-database-files.png"/>T2】</a></p>

<h2 id="configuring-the-sql-server-developer-container">配置SQL Server开发人员容器</h2>

<p>就像以前一样，我想用这个来进行实际的开发工作。在上一篇文章中，我创建了一个Docker合成文件来启动SQL Server。与其从那里开始，我想做和以前一样的过程。有条不紊地在Linux容器中启动并运行SQL Server。当我最终碰壁时，采取系统化的方法会使故障诊断更容易。</p>

<ol>
<li>无需额外配置即可启动并运行容器。</li>
<li>通过SSMS连接到它。</li>
<li>持久化在容器中创建的数据库。</li>
</ol>

<h3 id="running-sql-server-developer-container-for-the-first-time">首次运行SQL Server Developer容器</h3>

<p>首先，让我们运行一个简单的命令，从Docker Hub下载SQL Server Windows开发人员映像:</p>

<pre><code class="language-PowerShell">docker pull mcr.microsoft.com/mssql/server
</code></pre>

<p>SQL Server的基于Windows的映像需要很长时间才能下载。对于基于SQL Server Linux的容器来说，情况并非如此。我花了更长的时间来输入这一段并捕捉截图:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2019-10/automate-sql-server-install-using-linux-docker/download-sql-server-docker-image.png" class="zoom" data-title=""><img src="../Images/b05e48d33392174fda399fd1379e13a7.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2019-10/automate-sql-server-install-using-linux-docker/download-sql-server-docker-image.png"/>T2】</a></p>

<p>为SQL Server的基于Linux的容器提供的<a href="https://hub.docker.com/_/microsoft-mssql-server" rel="nofollow">文档使容器的启动和运行变得很容易。请记下正在发送的<code>--name</code>参数。当我们需要弄清楚如何连接它时，这个参数将使它变得更容易。在命名实例的同时，我将端口设置为默认的SQL Server端口<code>1433</code>。</a></p>

<p>环境变量名区分大小写，sa_password将不起作用，它必须是SA_PASSWORD。</p>


<pre><code class="language-PowerShell">docker run --name SQLServerLinux -d -p 1433:1433 -e "SA_PASSWORD=Password_01" -e "ACCEPT_EULA=Y" mcr.microsoft.com/mssql/server
</code></pre>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2019-10/automate-sql-server-install-using-linux-docker/docker-run-linux-image.png" class="zoom" data-title=""><img src="../Images/8d4fb2964f73c555e79e0e3b657fa87a.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2019-10/automate-sql-server-install-using-linux-docker/docker-run-linux-image.png"/>T2】</a></p>

<h3 id="connecting-to-the-container-from-ssms-on-the-host">从主机上的SSMS连接到容器</h3>

<p>SQL Server容器正在运行，但是在主机上运行的SSMS如何连接到它呢？在上面的命令中，我们提供了<code>-p</code>参数，该参数将端口暴露给<code>localhost</code>上的主机。要从SSMS连接到运行在Linux容器中的SQL Server，我们只需键入<code>localhost</code>并提供sa用户名/密码:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2019-10/automate-sql-server-install-using-linux-docker/ssms-successful-connection-to-sql-linux.png" class="zoom" data-title=""><img src="../Images/9153549209abbc8a500b6d8da46fe939.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2019-10/automate-sql-server-install-using-linux-docker/ssms-successful-connection-to-sql-linux.png"/>T2】</a></p>

<p>就像普通的SQL Server一样，一切都按预期运行。我可以毫无问题地创建数据库和表格:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2019-10/automate-sql-server-install-using-linux-docker/create-table-inside-instance.png" class="zoom" data-title=""><img src="../Images/cd13cb921e6e32695cc37f337a38feb0.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2019-10/automate-sql-server-install-using-linux-docker/create-table-inside-instance.png"/>T2】</a></p>

<h3 id="persisting-databases-created-in-a-container">持久化在容器中创建的数据库</h3>

<p>如果容器需要重启会怎么样？</p>

<pre><code class="language-PowerShell">docker stop SQLServerLinux
docker start SQLServerLinux
</code></pre>

<p>重新启动后，数据库仍然存在:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2019-10/automate-sql-server-install-using-linux-docker/test-database-after-restart-only.png" class="zoom" data-title=""><img src="../Images/da6319a227f461f1ecf09c71417ab51a.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2019-10/automate-sql-server-install-using-linux-docker/test-database-after-restart-only.png"/>T2】</a></p>

<p>如果需要重新创建容器，进行升级或配置更改，那么我们需要在停止它之后调用<code>rm</code>命令来删除它:</p>

<pre><code class="language-PowerShell">docker stop SQLServerLinux
docker rm SQLServerLinux
docker run --name SQLServerLinux -d -p 1433:1433 -e "SA_PASSWORD=Password_01" -e "ACCEPT_EULA=Y" mcr.microsoft.com/mssql/server
</code></pre>

<p>发生这种情况时，该容器中的所有数据库都将被删除:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2019-10/automate-sql-server-install-using-linux-docker/docker-recreate-image-no-databases.png" class="zoom" data-title=""><img src="../Images/0100cf0f92f825a1533dde4e5ea546a8.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2019-10/automate-sql-server-install-using-linux-docker/docker-recreate-image-no-databases.png"/>T2】</a></p>

<p>如果你读过我以前的文章，这并不奇怪，就像以前一样，我们需要利用数量。Docker的一个优点是它提供了一个抽象层。告诉Docker指向主机上的文件夹，<code>C:\DockerLinux\Volumes\SQLServer</code>指向存储SQL Server配置的Linux目录，<code>var/opt/mssql</code>:</p>

<pre><code class="language-PowerShell">docker stop SQLServerLinux
docker rm SQLServerLinux
docker run --name SQLServerLinux -d -p 1433:1433 -e "SA_PASSWORD=Password_01" -e "ACCEPT_EULA=Y" -v C:\DockerLinux\Volumes\SQLServer:/var/opt/mssql mcr.microsoft.com/mssql/server
</code></pre>

<p>创建测试数据库后，它将出现在主机上的该文件夹中:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2019-10/automate-sql-server-install-using-linux-docker/sql-server-linux-windows-host-volumes.png" class="zoom" data-title=""><img src="../Images/c77ee6a314ef712fe34ca1b56ea089a0.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2019-10/automate-sql-server-install-using-linux-docker/sql-server-linux-windows-host-volumes.png"/>T2】</a></p>

<p>当容器重新启动时，它将挂载所有那些现有的数据库，包括TestDatabase。</p>

<h2 id="docker-compose">Docker撰写</h2>

<p>我喜欢用<a href="https://docs.docker.com/compose/" rel="nofollow"> Docker作曲</a>。将我的Docker容器配置存储在一个易于阅读和运行的YAML文件中非常好。以下是基于Linux的SQL Server容器的外观:</p>

<pre><code class="language-YAML">version: '3.7'
services:
 SQLServer:
 image: mcr.microsoft.com/mssql/server
 environment:
 - ACCEPT_EULA=Y
 - SA_PASSWORD=Password_01
 ports:
 - '1433:1433'
 volumes:
 - C:\DockerLinux\Volumes\SQLServer:/var/opt/mssql
</code></pre>

<p>我把那个<code>docker-compose.yml</code>文件保存在C:\DockerLinux中。现在，我运行这个PowerShell脚本来让一切正常运行:</p>

<pre><code class="language-PowerShell">set-location C:\DockerLinux
docker-compose up
</code></pre>

<p>如果您不想看到实时日志，将<code>-d</code>开关添加到<code>docker-compose up</code>来启动容器，而不附加它:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2019-10/automate-sql-server-install-using-linux-docker/docker-linux-docker-compose-sql-server.png" class="zoom" data-title=""><img src="../Images/cd7a116c4b71ce5d1d782473845ebe16.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2019-10/automate-sql-server-install-using-linux-docker/docker-linux-docker-compose-sql-server.png"/>T2】</a></p>

<h2 id="conclusion">结论</h2>

<p>当我开始写这篇文章时，我认为我必须学习很多关于Linux的知识。当我了解Linux的一些细微差别时，我在精神上为自己准备了几天的挫折。想象一下，当我所需要做的只是切换到Linux容器、提取不同的映像并更改主机上的路径时，我有多惊讶。我写这篇文章花的时间比启动和运行容器花的时间还多。这是为数不多的几次学习曲线比我预期的低很多的一次。</p>

<p>现在，我可以选择何时需要在本地运行SQL Server。我可以将它作为Windows服务、基于Windows的容器或基于Linux的容器来运行。有这样的选择真是太棒了。</p>

<p>下次再见，愉快的部署！</p>

                    
                    
</body>
</html>