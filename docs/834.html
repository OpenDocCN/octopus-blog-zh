<html>
<head>
<title>Workers explained - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>工作人员解释-章鱼部署</h1>
<blockquote>原文：<a href="https://octopus.com/blog/workers-explained#2021-08-24">https://octopus.com/blog/workers-explained#2021-08-24</a></blockquote>
                        <p>在Octopus Deploy的早期，随着产品的发展，对安装它的服务器提出了越来越高的要求。任何没有直接在<a href="https://octopus.com/docs/infrastructure/deployment-targets">目标</a>上执行的步骤都在服务器本身上执行。</p>

<p>为了处理越来越多的直接在服务器上执行的任务，我们创建了Workers的概念。</p>

<p>在这篇文章中，我将回答一些关于工人以及他们如何工作的常见问题。</p>

<h2 id="what-exactly-is-a-worker">工人到底是什么？</h2>

<p>本质上，工人是一根触手。它运行与部署目标相同的触手软件，但是它是在工作池中的服务器上注册的。工作池是工作机的集合。</p>

<h3 id="if-a-worker-is-a-tentacle-does-it-count-as-a-target-for-licensing">如果工人是触手，算不算许可对象？</h3>

<p>尽管运行着触手软件，但工人被视为Octopus服务器的延伸，因此不被算作目标。</p>

<p>在当前的许可模式下，您可以拥有多少台工作机是没有限制的。</p>

<h2 id="what-is-the-built-in-worker">什么是内置工人？</h2>

<p>所有Octopus实例都定义了一个默认的工人池。任何选择<strong>默认工人池</strong>的步骤都在内置工人上执行，这个工人就是Octopus服务器。然而，如果一个工作机被添加到<strong>默认工作机池</strong>，这个内置工作机就不再被使用了。</p>

<h2 id="what-can-a-worker-be-used-for">工人可以用来做什么？</h2>

<p>Workers可以用于不需要在目标上执行的步骤。最常见的使用案例是:</p>

<ul>
<li>数据库部署</li>
<li>API或Web服务调用</li>
<li>运行脚本</li>
<li>Kubernetes部署</li>
</ul>

<h3 id="database-deployments">数据库部署</h3>

<p>部署数据库更新只需要一个到数据库服务器和正在使用的数据库的连接字符串。工作人员可以帮助执行数据库部署，而不必在数据库服务器上安装额外的软件。</p>

<h3 id="api-or-web-service-calls">API或Web服务调用</h3>

<p>Workers非常适合调用API，或者不需要目标就能运行的Web服务。例子包括:</p>

<ul>
<li>时差通知</li>
<li>Microsoft团队消息</li>
<li>部署SQL Server Reporting Services报表</li>
</ul>

<h3 id="running-scripts">运行脚本</h3>

<p>运行脚本是工作者的另一个用例。进程密集型操作可以被卸载到一个工人上运行，而不是减慢Octopus服务器。</p>

<h3 id="kubernetes-deployments">Kubernetes部署</h3>

<p>Kubernetes (K8s)目标是唯一需要工人的目标类型。</p>

<p>K8s目标的工作人员要求安装<code>kubectl</code> CLI。因此，您可以在K8s目标屏幕上选择在运行状况检查操作期间使用的工作池。</p>

<p>Kubernetes部署与API交互，向K8s集群提供指令，而不是直接向其部署文件。这对工人来说是一个完美的用例。</p>

<h2 id="advantages-of-using-workers">使用工人的优势</h2>

<p>工人提供两大优势:</p>

<ul>
<li>从Octopus服务器卸载进程</li>
<li>Ability to run customized software</li>
</ul>

<h3 id="offload-processes-from-the-octopus-server">从Octopus服务器卸载进程</h3>

<p>长时间运行或密集的进程会影响Octopus服务器的性能。这些任务可以卸载到一个工作机，释放资源，让Octopus服务器以最佳状态运行。</p>

<h3 id="customized-software">定制软件</h3>

<p>Octopus附带的捆绑软件可能不包含流程所需的所有内容。有了工作人员，您可以安装定制软件包来帮助您的部署或runbook过程。</p>

<p>如果Worker安装了Docker，它可以使用<a href="https://octopus.com/docs/projects/steps/execution-containers-for-workers" class="alert-link">执行容器</a>特性来定制容器，而不是直接在Worker上安装软件。</p>


<p>【T2 <img src="../Images/54bffc1a4b69f6146e8da71c6d168a8d.png" class="img-fluid center" alt="Octopus dashboard showing Container Image section with Runs inside a container, on worker selected." data-original-src="https://i.octopus.com/blog/2021-08/workers-explained/octopus-worker-execution-containers.png"/></p>

<h2 id="how-do-i-specify-a-step-to-use-a-worker">如何指定使用工人的步骤？</h2>

<p>当在<a href="https://octopus.com/docs/runbooks"> Runbook </a>或<a href="https://octopus.com/docs/projects/deployment-process">项目部署过程</a>中定义一个步骤时，可以告诉Octopus这个步骤在一个Worker上运行并选择一个池。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-08/workers-explained/octopus-step-worker-pool.png" class="zoom" data-title=""><img src="../Images/05a2992c0813c36e9ec7c4d33b59eb61.png" class="img-fluid center" alt="Octopus dashboard Execution Location, Run once on a worker &amp; Worker Pool, Runs on a worker from a specific worker pool selected" data-original-src="https://i.octopus.com/blog/2021-08/workers-explained/octopus-step-worker-pool.png"/>T2】</a></p>

<h3 id="worker-pool-variable">工人池变量</h3>

<p>您可能已经注意到<strong> Worker Pool </strong>部分有第二个选择，<strong>运行在通过变量</strong>选择的池中的一个Worker上。我们创建了<a href="https://octopus.com/docs/projects/variables/worker-pool-variables">工人池变量</a>，用于在不同的情况下需要不同的工人池，比如环境。</p>

<p>有些人进行了安全隔离，这样开发人员就不允许接触测试中的资源。使用Worker Pool变量，您可以将池的范围扩大到环境，甚至是表示特定Azure区域的租户标签。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-08/workers-explained/octopus-worker-pool-variable.png" class="zoom" data-title=""><img src="../Images/dcdcafd28d8b66d5815557d48095402c.png" class="img-fluid center" alt="Octopus dashboard showing Project.Worker.Pool variable with multiple values." data-original-src="https://i.octopus.com/blog/2021-08/workers-explained/octopus-worker-pool-variable.png"/>T2】</a></p>

<h2 id="how-do-workers-execute-differently-from-targets">工人的执行与目标有何不同？</h2>

<p>如果您试图对同一台目标机器执行两个部署，您可能会注意到部署似乎在任务之间来回切换，一次执行一个步骤。此行为旨在保护目标，防止多个部署试图同时更新同一资源，如IIS元数据库。另一方面，工作人员被配置为同时处理多项任务。</p>

<p>像<code>Acquire Packages</code>这样的活动会导致一个工作线程被锁定，而使用同一个工作线程的任何其他部署/runbook都处于等待状态。</p>


<h2 id="how-is-a-worker-selected-from-the-pool">如何从人才库中挑选员工？</h2>

<p>工人是以循环赛的方式从人才库中挑选出来的。需要注意的是，在部署或运行手册运行的<em>开始</em>选择工人。我将在这篇文章的后面解释工人选择的注意事项。</p>

<p>假设每个步骤由池中不同的工作人员执行是最安全的。</p>


<p>考虑以下场景，其中工作池<code>Setup</code>由以下部分组成:</p>



<p>运行手册<strong>释放克拉肯</strong>调用运行手册<code>Create AWS RDS</code>进行环境开发、测试、准备和生产。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-08/workers-explained/octopus-runbook-unleash-the-kraken.png" class="zoom" data-title=""><img src="../Images/4a95a97d4d3881802633c56445e6176b.png" class="img-fluid center" alt="Octopus dashboard showing Runbooks process for Unleash the kraken." data-original-src="https://i.octopus.com/blog/2021-08/workers-explained/octopus-runbook-unleash-the-kraken.png"/>T2】</a></p>

<p>流程中的所有步骤按顺序执行，但配置为不等待运行手册完成就进入下一步(详情见<a href="https://library.octopus.com/step-templates/0444b0b3-088e-4689-b755-112d1360ffe3/actiontemplate-run-octopus-deploy-runbook" rel="nofollow">运行Octopus部署运行手册步骤</a>)。工人选择如下:</p>

<pre><code>Unleash the kraken
|
+-- worker1
|    |
     Create AWS RDS Development
     |
     +-- worker1
     |
     Create AWS RDS Test
     |
     +-- worker2
     |
     Create AWS RDS Staging
     |
     +-- worker3
     |
     Create AWS RDS Production
     |
     +-- worker1
</code></pre>

<h3 id="worker-selection-caveats">工人选择警告</h3>

<p>有些情况会影响Octopus选择员工的方式:</p>

<ul>
<li>引用包的步骤</li>
<li>包装参考订购</li>
<li>人工干预</li>
</ul>

<h4 id="steps-that-reference-packages">引用包的步骤</h4>

<p>任何使用相同包的步骤都在相同的工作机器上执行。例如，run book<strong>Create Region Workers</strong>将相同的映像部署到不同Azure区域中的Kubernetes集群。因为步骤2到6使用相同的包(映像)，所以它们都使用相同的Worker。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-08/workers-explained/octopus-worker-k8s-deploy.png" class="zoom" data-title=""><img src="../Images/0f25e3d8f51b682628509d94fd708370.png" class="img-fluid center" alt="Octopus dashboard open on Runbooks section then Create Region Workers showing steps 1 to 6 of process creating workers in specific Azure regions." data-original-src="https://i.octopus.com/blog/2021-08/workers-explained/octopus-worker-k8s-deploy.png"/>T2】</a></p>

<h4 id="referenced-package-ordering">参考包装订购</h4>

<p>薪资包参考排序也会影响员工选择。例如，如果有两个步骤以相同的顺序引用相同的包，那么Octopus会在同一个Worker上运行这两个步骤。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-08/workers-explained/octopus-reference-package1.png" class="zoom" data-title=""><img src="../Images/51f6ae341a7abd6be4fd597e03bcf057.png" class="img-fluid center" alt="Octopus dashboard showing Referenced Packages" data-original-src="https://i.octopus.com/blog/2021-08/workers-explained/octopus-reference-package1.png"/>T2】</a></p>

<p>但是，如果包的顺序不同，八达通为每个步骤选择不同的工人。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-08/workers-explained/octopus-reference-package2.png" class="zoom" data-title=""><img src="../Images/277d2c9befcb27fc455b25c9f431e184.png" class="img-fluid center" alt="Octopus dashboard showing Referenced Packages in opposite order" data-original-src="https://i.octopus.com/blog/2021-08/workers-explained/octopus-reference-package2.png"/>T2】</a></p>

<h4 id="manual-intervention">人工干预</h4>

<p>当遇到<a href="https://octopus.com/docs/projects/built-in-step-templates/manual-intervention-and-approvals">手动干预</a>步骤时，它将从任务队列中删除。在干预被执行之后，任务被添加回队列，这迫使工人选择再次发生。</p>

<h2 id="im-using-octopus-cloud-how-do-dynamic-workers-work">我在用章鱼云，动态工作者是怎么工作的？</h2>

<p>Octopus Deploy维护了一组工作器(VM ),您可以按需将它们用作动态工作器。这些员工可在以下人才库中找到:</p>

<ul>
<li>默认工作池(Windows Server 2016)</li>
<li>托管Windows (Windows Server 2019 <code>*</code>)</li>
<li>托管的Ubuntu (Ubuntu 18.04 <code>*</code>)</li>
</ul>

<p><code>*</code>池可以使用执行容器特性。</p>

<p>每个云实例可以为每个池租赁一个工作线程，专门用于该云实例。租约到期后，工人被销毁(时间到期见<a href="https://help.octopus.com/t/how-do-dynamic-workers-work-in-octopus-cloud/25228/2" rel="nofollow">这篇关于动态工人的文章</a>。)销毁后，将供应一个新的工作线程，并将其添加到可供云实例租赁的可用工作线程池中。</p>

<h2 id="conclusion">结论</h2>

<p>我希望这篇文章能澄清什么是工人，他们是如何被使用和选择的。写这篇文章让我学到了很多。</p>

<p>如果您需要帮助或想了解更多关于使用员工的信息，您可以通过<a href="mailto:customersuccess@octopus.com" rel="nofollow">customersuccess@octopus.com</a>联系我们的客户成功团队。</p>

<p>愉快的部署！</p>

                    
                    
</body>
</html>