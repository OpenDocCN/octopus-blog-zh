<html>
<head>
<title>Importing variables with the Octopus REST API - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>使用Octopus REST API导入变量- Octopus Deploy</h1>
<blockquote>原文：<a href="https://octopus.com/blog/creating-variables-with-the-api#2015-09-25">https://octopus.com/blog/creating-variables-with-the-api#2015-09-25</a></blockquote>
                        <p>Octopus 2.0引入了一个全面的REST API，可以用来执行UI可以执行的任何事情。我们知道这一点，因为UI本身完全构建在REST API之上。今天，一些人问他们如何使用API自动导入变量，我将在下面演示。</p>

<p>变量的集合存储在一个<code>VariableSet</code>资源中。在UI中编辑变量时，您正在编辑<code>VariableSet</code>。例如，在这个截图中，四个变量属于一个<code>VariableSet</code>:</p>

<p><img src="../Images/1806222e4fdf59a529f7e2564f995967.png" alt="Variable editing" data-original-src="https://i.octopus.com/blog/migrated/variables_nkakng.png"/></p>

<p>变量集资源<a href="https://github.com/OctopusDeploy/OctopusDeploy-Api/wiki/VariableSets">支持<code>GET</code>和<code>PUT</code>操作</a>。这个想法是，你<code>GET</code>变量集，进行修改(从集合中添加、修改、删除变量)，然后<code>PUT</code>它回来。</p>

<p><code>VariableSets</code>属于一个<code>Project</code>(或者属于一个发布，因为我们对每个发布的变量进行快照)。所以你需要这个项目来获取变量集。</p>

<h2>使用章鱼。客户</h2>

<p>这里有一个使用<a href="http://docs.octopusdeploy.com/display/OD/Octopus.Client"> Octopus的完整例子。客户端</a>:</p>

<pre><code>var octopus = new OctopusRepository(new OctopusServerEndpoint("http://your-octopus", "API-YOURKEY"));

// Find the project that owns the variables we want to edit
var project = octopus.Projects.FindByName("My Project");

// Get the variables for editing
var variableSet = octopus.VariableSets.Get(project.Link("Variables"));

// Add a new variable
variableSet.Variables.Add(new VariableResource()
{
    Name = "ConnectionString",
    Value = "Server=(local);Database=Foo;trusted_connection=true",
    Scope = new ScopeSpecification()
    {
        // Scope the variable to two environments using their environment ID
        { ScopeField.Environment, new ScopeValue("Environments-1", "Environments-2" )}
    }, 
});

// Save the variables
octopus.VariableSets.Modify(variableSet);
</code></pre>

<h2>正在发生什么</h2>

<p>首先，客户机点击<code>/api</code>并返回一个文档，如下所示:</p>

<pre><code>{
  "Application": "Octopus Deploy",
  "Version": "2.0.12.1092",
  "ApiVersion": "3.0.0",
  "Links": {
    ...
    "Projects": "/api/projects{/id}{?skip}",
    ...
    "Variables": "/api/variables{/id}"
  }
}
</code></pre>

<p>跟随<em>项目</em>链接，我们得到一个项目列表:</p>

<pre><code>{
  "ItemType": "Project",
  "IsStale": false,
  "TotalResults": 7,
  "ItemsPerPage": 30,
  "Items": [
    {
      "Id": "projects-65",
      "Name": "My Project",
      "VariableSetId": "variableset-projects-65",
      ...
      "Links": {
        "Self": "/api/projects/projects-65",
        "Releases": "/api/projects/projects-65/releases{/version}{?skip}",
        "Variables": "/api/variables/variableset-projects-65",
        "DeploymentProcess": "/api/deploymentprocesses/deploymentprocess-projects-65",
        "Web": "/app#/projects/projects-65"
      }
    },
    {
      "Id": "projects-129",
      "Name": "My Project 2",
      "VariableSetId": "variableset-projects-129",
      ...
</code></pre>

<p>项目上的<em>变量</em>链接将我们指向变量集资源:</p>

<pre><code>{
  "Id": "variableset-projects-129",
  "OwnerId": "projects-129",
  "Variables": [
    {
      "Id": "80bcaf5a-632a-470d-a8aa-a366f20c302e",
      "Name": "ConnectionString",
      "Value": "Server=(local);Database=Foo;trusted_connection=true",
      "Scope": {
        "Environment": [
          "Environments-1",
          "Environments-2"
        ]
      },
      "IsSensitive": false,
      "IsEditable": true,
      "Prompt": null
    }
  ],
  "ScopeValues": {
    "Environments": [
      {
        "Id": "Environments-1",
        "Name": "Automation Testing"
      },
      {
        "Id": "Environments-34",
        "Name": "EC2 Production"
      },
      {
        "Id": "Environments-33",
        "Name": "EC2 Staging"
      },
      {
        "Id": "Environments-97",
        "Name": "Octopus"
      },
      {
        "Id": "Environments-2",
        "Name": "Release To Web"
      }
    ],
</code></pre>

<p>我们现在可以对此资源进行更改，并将其放回原处。</p>

<p>注意，VariableSet文档实际上定义了不同的范围值选项。在UI中，我们使用它来填充定义范围时的下拉列表。在设置范围选项时，您可以使用它将诸如“EC2 Production”之类的名称映射到“Environments-34”。</p>

<p>我希望这有助于提供如何使用八达通的样本。客户端API来修改变量，以及了解幕后实际发生的事情。愉快的部署！</p>

                    
                    
</body>
</html>