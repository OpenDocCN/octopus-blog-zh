<html>
<head>
<title>Managing AWS costs with Instance Scheduler - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>使用实例调度程序管理AWS成本- Octopus Deploy</h1>
<blockquote>原文：<a href="https://octopus.com/blog/managing-aws-costs-instance-scheduler#2022-07-04">https://octopus.com/blog/managing-aws-costs-instance-scheduler#2022-07-04</a></blockquote>
                        <p>云计算的承诺是允许团队有效地按需扩展和缩减。虽然内部基础架构可以通过关闭来节省电力和冷却成本，但基于云的资源可以通过停止任何未使用的资源来避免几乎所有费用(存储费用通常适用于停止的资源)。</p>

<p>AWS提供了<a href="https://aws.amazon.com/solutions/implementations/instance-scheduler/" rel="nofollow">实例调度器</a>来按需关闭和重启EC2和RDS资源。对于拥有Octopus资源的团队来说，这是一个很好的解决方案，比如在AWS中运行的Workers，他们在一天中的大部分时间都没有被使用。</p>

<p>在这篇文章中，您将学习如何安装实例调度器，如何用自定义周期配置它，以及如何标记自动关闭和重启的资源。</p>

<h2 id="prerequisites">先决条件</h2>

<p>这篇文章假设您将在Linux Worker上运行脚本。你需要安装Python 3、<code>jq</code>、<code>curl</code>和<code>unzip</code>来完成本文中的步骤。要在Ubuntu中安装这些工具，请运行以下命令:</p>

<pre><code class="language-bash">apt-get install jq curl unzip python3
</code></pre>

<p>要在Fedora、RHEL、Centos和Amazon Linux中安装这些工具，请运行以下命令:</p>

<pre><code class="language-bash">yum install jq curl unzip python3
</code></pre>

<p>实例调度器由一个名为<a href="https://docs.aws.amazon.com/solutions/latest/instance-scheduler-on-aws/scheduler-cli.html" rel="nofollow"> Scheduler CLI </a>的定制Python应用程序管理。</p>

<p>CLI需要Python 3。如果您安装了Python 2和Python 3，您可以使用以下命令强制使用Python 3:</p>

<pre><code class="language-bash">alias python=python3
</code></pre>

<p>运行以下命令安装CLI:</p>

<pre><code class="language-bash">curl -O https://s3.amazonaws.com/solutions-reference/aws-instance-scheduler/latest/scheduler-cli.zip
unzip scheduler-cli.zip
python setup.py install
</code></pre>

<p>一个公共的<a href="https://tenpillars.octopus.app/app#/Spaces-42/projects/aws-instance-scheduler/deployments" rel="nofollow"> Octopus实例已经配置了一个项目，该项目部署了实例调度器</a>。</p>

<h2 id="deploying-the-instance-scheduler-template">部署实例调度程序模板</h2>

<p>实例调度器作为下载的<a href="https://s3.amazonaws.com/solutions-reference/aws-instance-scheduler/latest/aws-instance-scheduler.template" rel="nofollow"> CloudFormation模板分发。您将使用Octopus中的<strong>部署AWS CloudFormation模板</strong>步骤来部署它。</a></p>

<p>如果您在尝试保存模板时看到错误<code>Template could not be parsed: An item with the same key has already been added. Key: 14</code>，这是因为其中一个参数复制了<code>AllowedValues</code>数组中的一个选项。在下面的截图中，你可以看到<code>LogRetentionDays</code>参数有重复的值<code>14</code>。要解决该错误，请删除重复的值:</p>
<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-q2/managing-aws-costs-instance-scheduler/paramaters-error.png" class="zoom" data-title=""> <img src="../Images/94b0603ee47cb660b0e47c90347925e2.png" class="img-fluid center" alt="Parameter Error" data-original-src="https://i.octopus.com/blog/2022-q2/managing-aws-costs-instance-scheduler/paramaters-error.png"/> </a></p>


<p>您可以保留这些参数的默认值，尽管您可能希望定义<code>DefaultTimezone</code>参数来反映您的本地时区。</p>

<p>我们为这个步骤创建了一个<a href="https://tenpillars.octopus.app/app#/Spaces-42/projects/aws-instance-scheduler/deployments/process/steps?actionId=4ba7211f-0531-48e6-8f88-de70b770595b" rel="nofollow">实例。</a></p>

<h2 id="adding-new-periods">添加新周期</h2>

<p>实例调度器通过在DynamoDB数据库中定义多个周期来工作。Scheduler CLI提供了一个方便的界面，通过该界面可以查看和操作这些时间段。</p>

<p>下面的脚本调用<code>scheduler-cli describe-periods</code>列出当前定义的时间段，然后将结果JSON通过管道传递给<code>jq</code>，后者检查是否存在一个名为<code>aus_weekday</code>的时间段。如果不存在，则通过调用<code>scheduler-cli create-period</code>添加句点。如果确实存在，则通过调用<code>scheduler-cli update-period</code>更新周期。</p>

<p>这个脚本是创建幂等部署所必需的，在幂等部署中，可以在任何时候重新部署部署，而不管数据库的现有状态如何。</p>

<p>该脚本与Octopus中的<strong>运行AWS CLI脚本</strong>步骤一起运行。你可以在我们的实例中看到这一点:</p>

<pre><code class="language-bash">alias python=python3
scheduler-cli describe-periods --stack common-instance-scheduler | jq -e '.Periods|any(.Name == "aus_weekday")' &gt; /dev/null
if [[ 0 -ne $? ]]; then
    scheduler-cli create-period --name "aus_weekday" --begintime 05:00 --endtime 17:00 --weekdays mon-fri --stack common-instance-scheduler
else
    scheduler-cli update-period --name "aus_weekday" --begintime 05:00 --endtime 17:00 --weekdays mon-fri --stack common-instance-scheduler
fi
</code></pre>

<h2 id="tagging-resources">标记资源</h2>

<p>实例调度器根据标记识别要关闭和重启的资源。实例调度程序寻找的默认标记名为<code>Schedule</code>(尽管可以通过更改CloudFormation模板中的<code>TagName</code>参数来修改标记名)。标签的值被设置为一个句点的名称。</p>

<p>在下面的截图中，您可以看到一个worker EC2实例有一个名为<code>Schedule</code>的标记设置为<code>aus_weekday</code>。这意味着这个EC2实例将在每个工作日的17:00关闭，并在05:00重新启动。这使得EC2实例的运行成本降低了一半以上，因为它现在会在夜间和周末关闭:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-q2/managing-aws-costs-instance-scheduler/tagged-ec2.png" class="zoom" data-title=""><img src="../Images/51262f8faa4ec36e5168f38d0edbc27b.png" class="img-fluid center" alt="Tagged EC2 instance" data-original-src="https://i.octopus.com/blog/2022-q2/managing-aws-costs-instance-scheduler/tagged-ec2.png"/>T2】</a></p>

<h2 id="conclusion">结论</h2>

<p>AWS实例调度程序是一个方便的解决方案，允许您自动关闭和重启EC2和RDS实例，这可以显著降低并非全天24小时都需要的资源的运行成本。</p>

<p>在本文中，您了解了如何使用Octopus部署实例调度程序，使用调度程序CLI添加新的周期，以及标记您的资源以允许调度程序在夜间和周末关闭它们。</p>

<p>阅读我们的<a href="https://octopus.com/blog/tag/Runbooks%20Series"> Runbooks系列</a>的其余部分。</p>

<p>愉快的部署！</p>

                    
                    
</body>
</html>