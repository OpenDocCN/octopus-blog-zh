<html>
<head>
<title>Convert an existing application to use rolling deployments - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>转换现有应用程序以使用滚动部署- Octopus Deploy</h1>
<blockquote>原文：<a href="https://octopus.com/blog/convert-to-rolling-deployments#2022-07-05">https://octopus.com/blog/convert-to-rolling-deployments#2022-07-05</a></blockquote>
                        <p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-07/convert-to-rolling-deployments/rolling-deployments.png" class="zoom" data-title=""><img src="../Images/21092d6553bf3cfd8ec04ae9463517ca.png" class="img-fluid center" alt="Rolling deployments" data-original-src="https://i.octopus.com/blog/2020-07/convert-to-rolling-deployments/rolling-deployments.png"/>T2】</a></p>

<p>在之前的一篇文章中，我写了滚动部署模式的<a href="/blog/ultimate-guide-to-rolling-deployments">好处，这是一种在部署时减少应用程序停机时间的方法。当您第一次创建应用程序时，设计一个适合这种部署模式的应用程序可能要容易得多，但是从现有的应用程序开始，如何将应用程序转换成使用滚动部署模式呢？</a></p>

<p>在这篇文章中，我将向您展示如何在Octopus的<a href="https://octopus.com/docs/deployment-patterns/rolling-deployments#Rollingdeployments-Childsteps">子步骤</a>的帮助下转换现有的应用程序以使用滚动部署模式。</p>

<h2>在这篇文章中</h2>



<h2 id="the-application">应用程序</h2>

<p>我将以<a href="https://github.com/spring-projects/spring-petclinic" rel="nofollow"> PetClinic </a>为例，将应用程序的部署过程从在Octopus中顺序运行部署步骤的过程转换为滚动部署过程。PetClinic是一个用Java编写的示例Spring Boot应用程序，它有两个主要组件:</p>

<ul>
<li>一个web前端。</li>
<li>一个数据库。</li>
</ul>

<p>在本文中，我不会解释如何构建PetClinic应用程序。如果您是构建Java应用程序的新手，我们有许多<a href="https://octopus.com/docs/guides?application=java" class="alert-link">指南</a>，其中包括为各种工具设置CI/CD管道的逐步说明。</p>


<p>对于顺序和滚动部署流程，PetClinic应用程序和<a href="https://www.mysql.com/" rel="nofollow"> MySQL </a>数据库都托管在<a href="https://cloud.google.com/gcp" rel="nofollow"> Google Cloud </a>中。这些示例中使用的所有基础设施，包括服务器、负载平衡器和数据库，都使用<a href="https://octopus.com/docs/operations-runbooks">运营手册</a>定期重新创建。</p>

<h3 id="some-caveats">一些警告</h3>

<p>需要强调的是，这篇文章不会涵盖零停机部署所需的所有元素。它对应用程序的设置做了一些假设:</p>

<ol>
<li>数据库已经部署在高可用性配置中。有关MySQL高可用性的更多信息，请参考<a href="https://dev.mysql.com/doc/" rel="nofollow">文档</a>。</li>
<li>使用<a href="https://flywaydb.org/" rel="nofollow"> Flyway </a>以向后和向前兼容的方式对数据库进行更改。</li>
<li>将单个服务器部署到时，任何必需的会话状态都将保持。</li>
</ol>

<h2 id="sequential-deployment-process">顺序部署流程</h2>

<p>对于不担心应用程序停机的部署，默认情况下，Octopus通过依次运行各个步骤来满足这一需求。</p>

<p><strong> Start trigger </strong> <br/>也可以配置您的部署流程，以<a href="https://octopus.com/docs/deployment-process/conditions#start-trigger" class="alert-link">并行</a>的方式运行步骤。但是，应该注意避免并行运行的步骤相互依赖的情况。</p>


<p>现有的PetClinic应用程序使用这种顺序部署技术进行建模。部署流程由许多关键步骤组成:</p>

<ul>
<li>仅用于<strong>生产</strong>环境的<a href="https://octopus.com/docs/deployment-process/steps/manual-intervention-and-approvals">手动干预</a>批准步骤。</li>
<li>Flyway DB迁移<a href="https://library.octopus.com/listing/flyway" rel="nofollow">社区步骤模板</a>显示迁移状态和应用任何新数据库更改的步骤。</li>
<li>PetClinic web前端的部署到<a href="https://wildfly.org/" rel="nofollow"> WildFly </a>步骤。</li>
</ul>

<p>此外，部署流程包括将消息发布到具有部署进度更新的<a href="https://slack.com/" rel="nofollow"> Slack </a>通道的步骤。</p>

<p>完整的部署流程如下所示:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-07/convert-to-rolling-deployments/project-sequential-deployment-process.png" class="zoom" data-title=""><img src="../Images/e9d149f31e6770926389c69919860214.png" class="img-fluid center" alt="Project sequential deployment process" data-original-src="https://i.octopus.com/blog/2020-07/convert-to-rolling-deployments/project-sequential-deployment-process.png"/>T2】</a></p>

<p>在Octopus中<a href="https://octopus.com/docs/managing-releases#creating-a-release">创建了一个版本</a>之后，您可以看到一个在<strong>开发</strong>环境中的顺序部署实例:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-07/convert-to-rolling-deployments/project-sequential-deployment-run.png" class="zoom" data-title=""><img src="../Images/8f6e27706cba5dc2c0004d76b6cd929a.png" class="img-fluid center" alt="Project sequential deployment run" data-original-src="https://i.octopus.com/blog/2020-07/convert-to-rolling-deployments/project-sequential-deployment-run.png"/>T2】</a></p>

<p>一次运行一个步骤，直到部署完成。当<strong> Deploy PetClinic web app </strong>步骤运行时，应用程序变得不可用于向用户提供请求。</p>

<p>也许不足为奇的是，这些部署(每个环境)中使用的基础架构如下所示:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-07/convert-to-rolling-deployments/sequential-deployment-infrastructure.png" class="zoom" data-title=""><img src="../Images/49f65545d5a541f5c8ddf11d8845439d.png" class="img-fluid center" alt="Project sequential infrastructure" data-original-src="https://i.octopus.com/blog/2020-07/convert-to-rolling-deployments/sequential-deployment-infrastructure.png"/></a>T2】</p>

<p>它包括:</p>

<ul>
<li>一台<a href="https://ubuntu.com/" rel="nofollow"> Ubuntu </a>虚拟机托管Wildfly应用服务器。</li>
<li>一个托管在谷歌云SQL服务中的MySQL数据库。</li>
</ul>

<p><strong>样本Octopus项目</strong> <br/>您可以在我们的<a href="https://g.octopushq.com/PatternRollingSamplePetClinicNoRollingDeploy" class="alert-link" rel="nofollow">样本实例</a>中看到转换为滚动部署流程之前的PetClinic顺序部署流程<em>。</em></p>


<h2 id="convert-to-a-rolling-deployment-process">转换为滚动部署流程</h2>

<p>既然我们已经看到了现有应用程序的部署过程，我们首先需要决定滚动部署过程中我们的基础设施将会是什么样子。</p>

<h3 id="scale-up-the-servers">纵向扩展服务器</h3>

<p>为了减少停机时间并满足用户的请求，我们需要增加我们使用的服务器数量。我们还需要一个负载平衡器来控制哪些服务器可用。</p>

<p>在前面的顺序部署示例中，我们在每个环境中有一台虚拟机。为了简单起见，我们将保持<strong>开发</strong>环境的基础设施和以前一样。然而，对于<strong>测试</strong>和<strong>生产</strong>环境，基础架构将如下所示:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-07/convert-to-rolling-deployments/rolling-deployment-infrastructure.png" class="zoom" data-title=""><img src="../Images/cf16f9a8d2e6edb4910b10bca0dd6267.png" class="img-fluid center" alt="Project rolling infrastructure" data-original-src="https://i.octopus.com/blog/2020-07/convert-to-rolling-deployments/rolling-deployment-infrastructure.png"/>T2】</a></p>

<p>这包括一个<em>共享的</em>负载平衡器，这一次，每个环境中有两个应用服务器，像以前一样连接到MySQL数据库。</p>

<p>在您创建了新的服务器之后，您还需要将它们作为新的<a href="https://octopus.com/docs/infrastructure/deployment-targets#adding-deployment-targets">部署目标</a>添加到Octopus中，并用任何适当的<a href="https://octopus.com/docs/octopus-concepts/target-roles">目标角色</a>标记它们。</p>

<h3 id="choosing-a-load-balancer">选择负载平衡器</h3>

<p>有许多不同类型的负载平衡器，但这个滚动部署示例的一个关键要求是能够控制哪些服务器可用于服务流量。由于这个原因，并且这个例子是从Google Cloud运行的，我们将使用一个<a href="https://cloud.google.com/load-balancing/docs/network/" rel="nofollow">网络负载平衡器</a>。作为部署过程的一部分，这提供了一种从负载均衡器中添加和删除服务器的方法，稍后我们将看到这一点。有关设置网络负载平衡器的更多信息，请参考<a href="https://cloud.google.com/load-balancing/docs/network/setting-up-network" rel="nofollow">谷歌文档</a>。</p>

<p>在本例中，负载平衡器在<strong>测试</strong>和<strong>生产</strong>环境之间共享。为了将流量路由到正确的位置，负载平衡器使用不同的TCP端口来识别预期的环境。</p>
<ul>
<li>端口<code>8080</code>用于去往<strong>测试</strong>环境的流量。</li>
<li>端口<code>80</code>用于目的地为<strong>生产</strong>环境的流量。</li>
</ul>


<h3 id="load-balancer-target-pools">负载平衡器目标池</h3>

<p>以前，用户直接在单个虚拟机上访问PetClinic web前端。这里，我们将专用的目标池用于测试环境和生产环境。<a href="https://cloud.google.com/load-balancing/docs/target-pools" rel="nofollow">目标池</a>是一组托管在Google Cloud中的虚拟机实例的名称。</p>

<h3 id="create-a-new-project">创建新项目</h3>

<p>为了改变我们的部署过程，并保持顺序部署PetClinic的能力，我们需要创建一个新项目。实现这一点的方法之一是克隆现有的项目。</p>

<p>在现有项目中，在<strong>设置</strong>下，使用溢出菜单(...)并选择<strong>克隆</strong>:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-07/convert-to-rolling-deployments/project-clone-menu-option.png" class="zoom" data-title=""><img src="../Images/fad1990dc3e69ee7ef8d862cd70f7ccc.png" class="img-fluid center" alt="Project clone menu option" data-original-src="https://i.octopus.com/blog/2020-07/convert-to-rolling-deployments/project-clone-menu-option.png"/>T2】</a></p>

<ul>
<li>为您正在从原始项目克隆的新项目命名，检查设置，当您满意时，单击<strong>保存</strong>:</li>
</ul>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-07/convert-to-rolling-deployments/project-clone-add-dialog.png" class="zoom" data-title=""> T32 </a></p>

<h3 id="convert-the-petclinic-deployment-process">转换PetClinic部署流程</h3>

<p>接下来，我们将转换项目本身的部署过程。并不是所有的PetClinic部署过程都适合滚动部署模式，因此，我们将重点放在PetClinic的web前端。</p>

<p><strong>选择要转换的内容</strong> <br/>自己决定项目部署过程中的哪些元素应该转换为使用滚动部署模式是很重要的。在某些情况下，这可能会使事情<em>更难部署</em>。</p>


<h4 id="configure-a-rolling-deployment">配置滚动部署</h4>

<p>为了将<strong>部署PetCinic web app </strong>步骤转换为滚动部署，我们执行以下操作:</p>

<ul>
<li>打开部署流程编辑器中的步骤，展开角色中目标的<strong>部分，点击<strong>配置滚动部署</strong>:</strong></li>
</ul>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-07/convert-to-rolling-deployments/petclinic-step-configure-rolling.png" class="zoom" data-title=""><img src="../Images/863131e2d18bc6f5c6880ff6a161d3ec.png" class="img-fluid center" alt="PetClinic step configure rolling deployment" data-original-src="https://i.octopus.com/blog/2020-07/convert-to-rolling-deployments/petclinic-step-configure-rolling.png"/>T2】</a></p>

<ul>
<li>在出现的<strong>滚动展开</strong>选项中，选择一个<strong>窗口大小</strong>。我选择了<code>1</code>的窗口大小，因为我们将在每个环境中最多部署两台服务器:</li>
</ul>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-07/convert-to-rolling-deployments/petclinic-step-configure-rolling-windowsize.png" class="zoom" data-title=""><img src="../Images/fdb4318c5d62a26b02116c1d3d00b6ee.png" class="img-fluid center" alt="PetClinic step configure rolling deployment window size" data-original-src="https://i.octopus.com/blog/2020-07/convert-to-rolling-deployments/petclinic-step-configure-rolling-windowsize.png"/>T2】</a></p>

<ul>
<li>点击<strong>保存</strong>更新部署步骤。</li>
</ul>

<h4 id="add-the-child-steps">添加子步骤</h4>

<p>我们已经配置了滚动部署，但它还不是很智能。目前，该流程一次一个地将PetClinic部署到每个服务器，在部署时使应用程序的每个实例脱机。</p>

<p>我们需要向我们的滚动部署添加新的步骤，以便将PetClinic应用程序的新版本安全地部署到每个虚拟机，并继续向其他服务器上的用户提供流量。</p>

<p>这些步骤将:</p>

<ol>
<li>检索虚拟机名称。</li>
<li>在pet clinic部署之前，从负载均衡器<em>中移除虚拟机。</em></li>
<li>在pet clinic部署之后，将虚拟机添加到负载均衡器<em>中。</em></li>
<li>测试PetClinic web前端是否可用。</li>
</ol>

<p>在Octopus中，向滚动部署流程添加多个步骤是通过<a href="https://octopus.com/docs/deployment-patterns/rolling-deployments#Rollingdeployments-Childsteps">子步骤</a>完成的。</p>

<p><strong> gcloud CLI和授权</strong> <br/>下一节中用于与Google交互的大多数命令都利用了<a href="https://cloud.google.com/sdk/gcloud" class="alert-link" rel="nofollow"> Google Cloud CLI </a>。要使用g cloud CLI，你通常需要授权。有关gcloud授权的更多信息，请参考<a href="https://cloud.google.com/sdk/docs/authorizing" class="alert-link" rel="nofollow">文档</a>。</p>


<h5 id="add-a-new-child-step">添加新的子步骤</h5>

<p>要添加子步骤，我们打开溢出菜单(...)对于现有的<strong>部署PetClinic web app </strong>步骤，选择<strong>添加子步骤</strong>:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-07/convert-to-rolling-deployments/project-rolling-deployment-add-new-child-step.png" class="zoom" data-title=""><img src="../Images/37aeceac54608d8ad2c256db5c837420.png" class="img-fluid center" alt="Project rolling deployment add new child step" data-original-src="https://i.octopus.com/blog/2020-07/convert-to-rolling-deployments/project-rolling-deployment-add-new-child-step.png"/>T2】</a></p>

<p>我们看到了<strong>选择步骤模板</strong>选择器，在这里我们选择所需的步骤类型。</p>

<p>接下来，我将介绍完成滚动部署过程所需的新的子步骤。一些脚本示例已经减少到突出关键部分所需的最少数量。</p>

<h5 id="retrieve-the-instance-name">检索实例名称</h5>

<p>这个<a href="https://octopus.com/docs/deployment-examples/custom-scripts/run-a-script-step">脚本步骤</a>是必需的，以便我们可以识别Google Cloud中托管的虚拟机的名称，以便在删除和添加负载平衡器时使用。我们通过使用gcloud <code>instances describe</code>命令查询Google来做到这一点:</p>

<pre><code class="language-powershell">$machineName = $OctopusParameters["Octopus.Machine.Name"]

$instanceName=(&amp; gcloud compute instances describe $machineName --project=$projectName --zone=$zone --format="get(name)" --quiet) -join ", "
</code></pre>

<p>如果使用由Octopus系统变量<code>Octopus.Machine.Name</code>标识的机器找到匹配，脚本将设置一个<a href="https://octopus.com/docs/projects/variables/output-variables">输出变量</a>，其名称记录在Google Cloud中:</p>

<pre><code class="language-powershell">Set-OctopusVariable -name "InstanceName" -value $instanceName
</code></pre>

<h5 id="remove-the-machine-from-the-load-balancer">从负载平衡器上拆下机器</h5>

<p>当我们知道要部署到的机器的名称时，我们需要将它从负载平衡器目标池中删除。然而，为了防止在虚拟机不存在的情况下尝试从目标池中删除虚拟机，我们可以运行gcloud <code>target-pools describe</code>命令来检查:</p>

<pre><code class="language-powershell">$instances=(&amp; gcloud compute target-pools describe $targetPoolName --format="flattened(instances[])" --region=$region --project=$projectName --quiet)
</code></pre>

<p>如果在目标池中找到实例，我们运行gcloud <code>target-pools remove-instances</code>命令，为实例名提供<code>--instances</code>参数:</p>

<pre><code class="language-powershell">$instanceName = $OctopusParameters["Octopus.Action[Retrieve machine instance name].Output.InstanceName"]

$response=(&amp; gcloud compute target-pools remove-instances $targetPoolName --instances=$instanceName --instances-zone=$zone --project=$projectName --quiet)
</code></pre>

<p>从负载均衡器中移除虚拟机后，我们可以继续部署PetClinic应用程序。</p>

<p>我们不需要添加新的子步骤来部署PetClinic应用程序，因为它已经存在。相反，我们将在添加必要的子步骤后，将该步骤放在正确的位置。</p>


<h5 id="testing-the-petclinic-application">测试PetClinic应用程序</h5>

<p>部署PetClinic前端后，我们可以通过添加一个名为<strong> HTTP - Test URL </strong>的社区<a href="https://g.octopushq.comCommunityContributedStepTemplates" rel="nofollow">步骤模板</a>作为子步骤来测试它是否响应请求。</p>

<p>我们使用变量<code>#{Project.Wildfly.Url}</code>来测试它是否返回HTTP 200 OK响应。这将告诉我们应用程序是否正在运行。任何其他HTTP响应都将导致失败。</p>

<h5 id="add-the-machine-to-the-load-balancer">将机器添加到负载平衡器</h5>

<p>最后，当PetClinic应用程序被验证为在线时，我们可以将其添加回负载平衡器目标池。我们通过运行gcloud <code>target-pools add-instances</code>命令并为实例名(和以前一样)提供<code>--instances</code>参数来实现这一点:</p>

<pre><code class="language-powershell">$instanceName = $OctopusParameters["Octopus.Action[Retrieve machine instance name].Output.InstanceName"]

$response=(&amp; gcloud compute target-pools add-instances $targetPoolName --instances=$instanceName --instances-zone=$zone --project=$projectName --quiet)
</code></pre>

<h5 id="re-order-the-child-steps">重新排列子步骤</h5>

<p>添加完所有子步骤后，如果需要，可以对它们重新排序。在我们的例子中，我们需要将最初的<strong>部署PetClinic web应用程序</strong>步骤移到中间，这样我们就不会将应用程序部署到虚拟机<em>，直到</em>从负载均衡器中移除。</p>

<p>要重新排序子步骤:</p>

<ul>
<li>使用溢出菜单(...)并选择<strong>重新排序子步骤</strong>。</li>
<li>按照所需的顺序重新排列这些步骤。</li>
<li>完成后点击<strong>保存</strong>。</li>
</ul>

<h4 id="the-rolling-deployment-process">滚动部署流程</h4>

<p>滚动部署过程中的一些步骤对于<strong>开发</strong>环境是不需要的。这是因为我们在那个环境中没有使用负载平衡器。为了跳过不需要运行的步骤，我们使用环境<a href="https://octopus.com/docs/deployment-process/conditions#environments">运行条件</a>。这将跳过在部署到<strong>开发</strong>时适用于负载平衡环境的步骤。</p>

<p>完整的滚动部署流程如下所示:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-07/convert-to-rolling-deployments/project-rolling-deployment-new-child-steps.png" class="zoom" data-title=""><img src="../Images/250730bb889c2afde811acccd0d91d85.png" class="img-fluid center" alt="Project rolling deployment run" data-original-src="https://i.octopus.com/blog/2020-07/convert-to-rolling-deployments/project-rolling-deployment-new-child-steps.png"/>T2】</a></p>

<p>您可以看到使用新的滚动部署流程部署到<strong>生产</strong>的示例:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-07/convert-to-rolling-deployments/project-rolling-deployment-run.png" class="zoom" data-title=""><img src="../Images/9e14155267b5e3da94c07c456f2325ae.png" class="img-fluid center" alt="Project rolling deployment run" data-original-src="https://i.octopus.com/blog/2020-07/convert-to-rolling-deployments/project-rolling-deployment-run.png"/>T2】</a></p>

<p>就是这样！我们已经成功地将我们的部署流程从顺序部署流程转换为滚动部署流程。</p>

<p><strong>样本Octopus项目</strong> <br/>您可以在我们的<a href="https://g.octopushq.com/PatternRollingSamplePetClinicRollingDeploy" class="alert-link" rel="nofollow">样本实例</a>中看到转换为滚动部署流程后的完整PetClinic部署流程<em>。</em></p>


<h3 id="switch-over-to-new-infrastructure">切换到新的基础架构</h3>

<p>为了使用我们的新基础设施，我们需要通过负载平衡器将用户引导到我们的应用程序。最简单的方法就是调整你的DNS记录。在PetClinic的情况下，我只需要调整DNS <a href="https://en.wikipedia.org/wiki/List_of_DNS_record_types" rel="nofollow"> A记录</a>指向负载平衡器，并等待DNS更改更新。</p>

<p>更改任何DNS记录可能会导致用户在一段时间内仍然直接连接到虚拟机。这通常不会超过24小时，但这将取决于您的DNS提供商以及DNS更改传播所需的时间。</p>


<h3 id="clean-up">清理</h3>

<p>此时，您不再需要以前的Octopus项目。您可以通过禁用它(并有效地将其归档)或删除它(如果您不再需要它来满足任何审计需求)来清理它。</p>

<h2 id="conclusion">结论</h2>

<p>正如您从这篇文章中所看到的，通过几个步骤，您可以从Octopus中的顺序部署过程切换到使用滚动部署特性的过程。这使您能够从减少的停机时间中获益，因为您知道您的应用程序可以保持在线以满足用户的请求。</p>

<p>下次再见，愉快的部署！</p>

<h2 id="learn-more">了解更多信息</h2>



                    
                    
</body>
</html>