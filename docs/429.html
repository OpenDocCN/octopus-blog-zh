<html>
<head>
<title>Multi-tenancy release management with Octopus Deploy - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>使用Octopus Deploy的多租户发布管理- Octopus Deploy</h1>
<blockquote>原文：<a href="https://octopus.com/blog/multi-tenancy-release-management#2021-10-14">https://octopus.com/blog/multi-tenancy-release-management#2021-10-14</a></blockquote>
                        <p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/blogimage-multi-tenancy-release-management-2021.png" class="zoom" data-title=""><img src="../Images/069cef63a5e62635fc112247e72ff2cb.png" class="img-fluid center" alt="Multi-Tenancy Release Management with Octopus Deploy" data-original-src="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/blogimage-multi-tenancy-release-management-2021.png"/>T2】</a></p>

<p>Octopus Deploy中我最喜欢的功能之一是<a href="https://octopus.com/docs/deployments/patterns/multi-tenant-deployments">多租户</a>。每个客户都有自己的应用程序版本，或者托管在每个客户的独特基础架构上，或者由客户自己托管。Octopus Deploy中的多租户特性解决了许多问题。</p>

<p>我的<a href="/blog/release-management-with-octopus">上一篇文章</a>深入探讨了新的<a href="https://library.octopus.com/step-templates/0dac2fe6-91d5-4c05-bdfb-1b97adf1e12e/actiontemplate-deploy-child-octopus-deploy-project" rel="nofollow">部署子Octopus部署项目步骤模板</a>，涵盖了各种场景，但不包括多租户。</p>

<p>在本文中，我将介绍新step模板的多租户功能，以及如何使用它来更好地管理您的多租户版本。</p>

<p>这篇文章假设你阅读了<a href="/blog/release-management-with-octopus" class="alert-link">前一篇文章</a>。它将触及类似的主题，但不是一个完整的老调重弹。</p>


<h2 id="sample-application">示例应用程序</h2>

<p>和上一篇文章一样，我有一个示例应用程序，其中每个组件都是一个Octopus Deploy项目。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/multi-tenancy-release-management-sample-app.png" class="zoom" data-title=""><img src="../Images/ec79481d1a928b29d7e721b85ee89c3e.png" class="img-fluid center" alt="An overview of the sample application" data-original-src="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/multi-tenancy-release-management-sample-app.png"/>T2】</a></p>

<p>有几个主要区别:</p>



<p>示例应用程序是一个SaaS应用程序，具有以下业务规则:</p>

<ul>
<li>每个客户都获得了由数据库、Web API和Web UI组成的“核心”产品。</li>
<li>每个客户都获得一个<strong>分期</strong>和<strong>生产</strong>环境。<strong>试运行</strong>环境允许他们的工程师在部署到<strong>生产</strong>之前测试任何变化。</li>
<li>客户可以额外付费购买计划服务、单点登录应用程序和数据转换。</li>
<li>客户可以支付额外的费用来更早地访问在<strong>测试</strong>环境中部署的变更。</li>
<li>在发布部署到<strong>生产</strong>环境之前，某些客户必须征得他们的同意。</li>
<li>购买模块需要重新部署核心组件，需要更新配置文件，并且需要回收服务以获得新功能。</li>
<li>客户希望停机时间保持在最低限度。</li>
</ul>

<p>这些规则复制了现实世界的一些复杂性。</p>

<p>以下是我们的客户样本:</p>

<ul>
<li><strong>内部</strong>:这是一个内测客户，大家用来测试变化。该客户存在于所有四个环境中:<strong>开发</strong>、<strong>测试</strong>、<strong>试运行</strong>和<strong>生产</strong>。</li>
<li><strong>所有宠物</strong>:该客户已经支付了所有额外组件以及在<strong>测试</strong>环境中访问预览版本的费用。</li>
<li><strong>宠物生活</strong>:裸机客户在<strong>试运行</strong>和<strong>生产</strong>环境中只有四个“核心”组件。</li>
<li><strong>宠物世界</strong>:该客户购买了调度服务和单点登录应用程序，用于<strong>筹备</strong>和<strong>生产</strong>环境。</li>
<li><strong>仅限狗</strong>:该客户购买了调度服务和数据转换服务，用于<strong>试生产</strong>和<strong>生产</strong>环境。</li>
</ul>

<h2 id="multi-tenancy-and-the-deploy-child-octopus-deploy-project-step-template">多租户和部署子Octopus部署项目步骤模板</h2>

<p>一些客户选择一个大型项目来处理所有事情。他们一次性部署软件，但是停机时间非常长，因为未更改的组件也需要重新部署。</p>

<p>这可能会引出一个问题，“我如何跳过包没有改变的步骤？”。</p>

<p>这种方法的问题是web部署很少“仅仅”推出服务器包。需要额外的步骤来配置项目，如品牌或运行集成测试。</p>

<p>Octopus Deploy中的每个组件都需要分配给一个独特的项目。父项目将处理编排。直到现在，还没有一个步骤来解决现实世界中的几个用例:</p>

<ul>
<li>通过仅部署已更改的内容，最大限度地减少停机时间。</li>
<li>通过只构建已更改的内容来最小化构建时间。</li>
<li>尽量减少一个人必须做出的决定。</li>
<li>单一责任原则，每个项目尽其所能部署一件事。</li>
<li>租户被分配到不同的项目。</li>
<li>每个项目的租户被分配到不同的环境中。</li>
<li>租户有不同的<strong>生产</strong>发布时间表。</li>
<li>租户有不同的测试周期。</li>
<li>租户需要他们自己的一组批准，但是一个人应该只需要批准一次发布。</li>
<li>应用程序必须按照特定的顺序部署到租户。</li>
<li>客户在星期二批准了他们对星期四晚上部署的更改。</li>
</ul>

<p>新的<a href="https://library.octopus.com/step-templates/0dac2fe6-91d5-4c05-bdfb-1b97adf1e12e/actiontemplate-deploy-child-octopus-deploy-project" rel="nofollow">部署子Octopus部署项目</a>步骤模板有助于解决这些用例。</p>

<p>您的应用程序将有一个父项目，只需要一个部署过程。你不应该担心租户和项目分配。它有必要的保护条款，以确保相同的流程将适用于<strong>内部客户</strong>的所有附加功能，<em>和</em>的<strong>宠物生活</strong>只有核心组件。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/multi-tenany-release-management-orchestration-process.png" class="zoom" data-title=""><img src="../Images/d0080dd09d7f0509a35c75c95c6d8f28.png" class="img-fluid center" alt="Release orchestration process multi-tenant application" data-original-src="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/multi-tenany-release-management-orchestration-process.png"/>T2】</a></p>

<p>在继续之前，让我们看看step模板如何处理多租户父项目的不同用例。</p>

<h3 id="tenants-not-assigned-to-child-projects">未分配给子项目的租户</h3>

<p>步骤模板将自动处理所有可能的多租户用例:</p>

<ul>
<li>租户是否被分配给子项目？如果没有，退出该步骤，记录一条消息并继续下一步。</li>
<li>租户是否被分配到特定环境的子项目中？如果否，退出该步骤，记录一条消息，然后继续下一步。</li>
<li>租户是否被分配到特定环境的子项目中？如果是，找到最新版本并触发部署。</li>
<li>子项目是否配置为运行多租户？如果没有，则在不提供租户的情况下运行子项目。</li>
</ul>

<h3 id="choosing-a-release">选择版本</h3>

<p>step模板的核心业务规则之一是选择源环境中最后一个成功部署的版本。大多数逻辑专注于计算源环境，并通过4个逻辑门运行:</p>

<ul>
<li>如果提供了源环境，就使用它。</li>
<li>当提供通道时，找到目标环境阶段之前的阶段。</li>
<li>当没有提供通道时，使用<strong>默认</strong>通道，然后找到目标环境相位之前的相位。</li>
<li>一旦知道了源环境，找到最新的<em>成功的</em>版本。</li>
</ul>

<p>步骤模板使用任务日志来计算要升级的版本。使用Tasks页面上的高级搜索过滤器，您可以实时看到step模板将选择哪个版本。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/multi-tenancy-release-management-task-log.png" class="zoom" data-title=""><img src="../Images/d32c60cabcc26b18f4dd4e1ed10672af.png" class="img-fluid center" alt="Task log with advanced filters" data-original-src="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/multi-tenancy-release-management-task-log.png"/>T2】</a></p>

<p>当目标环境是渠道生命周期的第一阶段时，它将找到为渠道创建的与提供的发布模式相匹配的最新发布。</p>


<p>多租户增加了一层复杂性。考虑这个场景:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/multi-tenant-picking-release-complex.png" class="zoom" data-title=""><img src="../Images/a2393ffa85437c2583815c3065d329e1.png" class="img-fluid center" alt="A multi-tenant child project with a complex release" data-original-src="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/multi-tenant-picking-release-complex.png"/>T2】</a></p>

<ul>
<li><strong>内部</strong>:有最新的前沿版本，<code>2021.1.0.15</code>准备好进入<strong>暂存</strong>。</li>
<li><strong>所有宠物</strong>:有一个旧版本，<code>2021.1.0.1</code>准备好去<strong>登台</strong>。</li>
<li><strong>宠物生活</strong>、<strong>宠物世界</strong>和<strong>只有狗</strong>没有被分配到<strong>测试</strong>环境。</li>
</ul>

<p>当step模板将最新的<code>2021.1.0.x</code>版本升级到<strong> Staging </strong>时，会选择什么版本？答案是:</p>

<ul>
<li><strong>内部</strong> : 2021.1.0.15</li>
<li><strong>宠物生活</strong> : 2021.1.0.15</li>
<li>宠物世界 : 2021.1.0.15</li>
<li><strong>仅限狗入内</strong> : 2021.1.0.15</li>
<li>所有宠物 : 2021.1.0.1</li>
</ul>

<p>多租户增加了复杂性，因为:</p>

<ul>
<li>只有<strong>所有宠物</strong>和<strong>内部</strong>被分配到<strong>测试</strong>环境。</li>
<li>租户可以有不同的版本。</li>
</ul>

<p>幸运的是，章鱼已经为我们解决了这个问题。如果我们通过释放下拉菜单从<strong>过滤器中选择<code>2021.1.0.15</code>释放，仪表板将变成这样:</strong></p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/multi-tenant-release-complex-release-chosen.png" class="zoom" data-title=""> T47 </a></p>

<p>step模板与Octopus Deploy已经提供逻辑挂钩。在内部，该逻辑查看<code>2021.1.0.15</code>中的<strong>所有宠物</strong>，并确定这不是升级到<strong>暂存</strong>的正确版本。<strong>所有的宠物</strong>都被分配到<strong>测试</strong>环境中，而那个版本还没有被部署到那个环境中。而对于<strong>内部</strong>，该版本已经被部署到<strong>测试</strong>，因此它可以被部署到<strong>暂存</strong>。</p>

<p>当step模板查看<strong> Pet Life </strong>时，它看到租户没有被分配到<strong>测试</strong>环境。然后，它将从测试环境中选择最新的版本，而不考虑租户。</p>

<h2 id="using-the-deploy-child-octopus-deploy-project-step-template">使用部署子Octopus部署项目步骤模板</h2>

<p>本节将介绍一些常见父项目场景的配置。</p>

<p>您可以作为访客登录，在<a href="https://samples.octopus.app/app#/Spaces-603/projects/release-orchestration-multi-tenant/deployments" rel="nofollow">示例实例</a>上查看最终的项目。</p>

<h3 id="scaffolding">脚手架</h3>

<p>有一些为用户和生命周期配置的脚手架。请参见<a href="/blog/release-management-with-octopus#scaffolding">上一篇</a>中的脚手架部分。</p>

<p>配置用户和生命周期后，您需要创建一个项目。创建项目时，记得选择上面创建的新生命周期。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/release-management-create-project.png" class="zoom" data-title=""><img src="../Images/5352848c005f8e791f8853ed64227337.png" class="img-fluid center" alt="Release management create project" data-original-src="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/release-management-create-project.png"/>T2】</a></p>

<p>确保项目配置为所有部署都需要租户。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/project-multi-tenant-setting.png" class="zoom" data-title=""><img src="../Images/2a91c0af97fd81fa56a8334262e8766e.png" class="img-fluid center" alt="Configuring a project for multi-tenant" data-original-src="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/project-multi-tenant-setting.png"/>T2】</a></p>

<p>之后，导航到变量屏幕，添加API键和发布模式。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/release-orchestration-variables.png" class="zoom" data-title=""> T32 </a></p>

<p>对于每个租户，连接新创建的用于<strong>试运行</strong>和<strong>生产</strong>环境的项目。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/assigning-tenants-to-release-orchestration-project.png" class="zoom" data-title=""><img src="../Images/b00c523f458b821f41a6329bd23f404b.png" class="img-fluid center" alt="Assigning tenants to release orchestration project" data-original-src="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/assigning-tenants-to-release-orchestration-project.png"/>T2】</a></p>

<p>示例场景假设构建服务器将部署到<strong>开发</strong>中的所有租户。步骤模板不是根据这一假设编写的。因为<strong>开发</strong>是渠道生命周期的第一阶段，它将找到与提供的发布模式相匹配的最新发布。</p>


<h3 id="scenario-deploying-the-latest-release-for-the-tenant-from-test-to-staging">场景:为租户部署从测试到试运行的最新版本</h3>

<p>在这个场景中，我们将父项目配置为以特定的顺序部署从<strong>测试</strong>到<strong>阶段</strong>的所有子组件。目前，我们不关心批准。</p>

<h4 id="add-the-steps">添加步骤</h4>

<p>转到新创建的项目的部署流程，并为每个子项目添加一个<code>Deploy Child Octopus Deploy Project</code>步骤。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/release-management-deploy-release-steps-added.png" class="zoom" data-title=""><img src="../Images/09abd021abca68dc3482f1d2a4668bf3.png" class="img-fluid center" alt="Release orchestration deploy child octopus deploy project steps added" data-original-src="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/release-management-deploy-release-steps-added.png"/>T2】</a></p>

<p>以下是每个参数的值:</p>

<ul>
<li><strong> Octopus Base URL </strong>:接受默认值<code>#{Octopus.Web.ServerUri}</code>。您可以在配置- &gt;节点配置该值。这是为章鱼云预先配置的。</li>
<li><strong>Octopus API Key</strong>:API Key变量，<code>#{Project.ChildProjects.ReleaseAPIKey}</code>。</li>
<li><strong>子项目空间</strong>:接受默认值。这个例子没有在另一个空间中创建一个发布协调项目。</li>
<li><strong>子项目名称</strong>:子项目的名称。</li>
<li><strong>子项目发布号</strong>:发布模式变量<code>#{Project.ChildProjects.ReleasePattern}</code>。</li>
<li><strong>未找到子项目发布错误句柄</strong>:接受默认值，表示如果发布不存在，跳过它。</li>
<li><strong>目的环境名</strong>:接受默认值。使用与父项目相同的环境。</li>
<li><strong>源环境名称</strong>:接受缺省(空)值本例将让step模板决定源环境。</li>
<li><strong>子项目通道</strong>:接受默认值(空)子项目只有一个通道。</li>
<li><strong>租户名称</strong>:接受默认值<code>#{Octopus.Deployment.Tenant.Name}</code>。</li>
<li><strong>子项目提示变量</strong>:接受缺省(空)值。没有提示变量。</li>
<li><strong>部署模式</strong>:接受默认值。该示例是进行部署，而不是重新部署。</li>
<li><strong>强制重新部署</strong>:接受默认值。该示例不会重新部署现有的版本。</li>
<li><strong>刷新变量快照</strong>:接受默认值。该示例不会刷新子项目变量快照。</li>
<li><strong>具体部署目标</strong>:接受默认值。这个例子没有部署到特定的机器上。</li>
<li><strong>忽略特定机器不匹配</strong>:接受默认值。我们还没有添加部署目标触发器。</li>
<li><strong>将发布说明保存为工件</strong>:接受默认值。</li>
<li><strong>如果</strong>会怎样:接受默认值。我们还没有添加批准。</li>
<li><strong>等待完成</strong>:接受默认值。此示例将等待部署完成。</li>
<li><strong>等待部署</strong>:接受默认值。30分钟应该足够了。</li>
<li><strong>调度</strong>:接受默认值。这个例子要求子项目有一个特定的顺序。</li>
<li><strong>自动批准子项目手动干预</strong>:接受默认值。现在不需要这个设置，因为这个例子不涉及手动干预。</li>
<li><strong>审批环境</strong>:接受默认值。现在不需要这个设置，因为这个例子不涉及手动干预。</li>
<li><strong>批准租户</strong>:接受默认值。现在不需要这个设置，因为这个例子不涉及手动干预。</li>
</ul>

<h4 id="create-the-release-and-deploy-it">创建发布并部署它</h4>

<p>在添加和配置这些步骤之后，您就创建了一个发布。在这篇文章中，我将对父项目进行许多修改；您可能会看到发布号的<code>2021.1.0-RCx</code>。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/release-orchestration-create-release.png" class="zoom" data-title="">T35【T36】T1】</a></p>

<p>首先，将发布部署到<strong>所有宠物</strong>租户。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/release-management-deploy-to-odd-tenant.png" class="zoom" data-title=""><img src="../Images/f25f299e45199e22b6329d821c4267cb.png" class="img-fluid center" alt="Deploy to odd tenant first" data-original-src="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/release-management-deploy-to-odd-tenant.png"/>T2】</a></p>

<p>等待释放完成。对于Web UI项目，您应该看到发布版<code>2021.1.0.1</code>被选中进行部署。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/odd-tenant-selecting-correct-release.png" class="zoom" data-title=""><img src="../Images/34677a5f5baa78c099662839f10a3683.png" class="img-fluid center" alt="The correct release is picked up for the odd tenant" data-original-src="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/odd-tenant-selecting-correct-release.png"/>T2】</a></p>

<p>对于其他项目，您应该会看到<code>2021.1.0.15</code>被选中。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/internal-tenant-selecting-correct-release.png" class="zoom" data-title=""><img src="../Images/5d5359906b017935f04ecc3e8ccab0d7.png" class="img-fluid center" alt="The correct release is picked up for the internal tenant" data-original-src="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/internal-tenant-selecting-correct-release.png"/>T2】</a></p>

<h4 id="deploy-the-release-for-tenants-not-assigned-to-test">为未分配测试的租户部署该版本</h4>

<p>现在我们来看看租户是<em>而不是</em>分配到<strong>测试</strong>的情况，比如<strong>宠物生活</strong>、<strong>宠物世界</strong>、<strong>狗狗专用</strong>的情况。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/tenants-not-assigned-to-test.png" class="zoom" data-title=""><img src="../Images/a66b1845524021c4385f4c5161015d29.png" class="img-fluid center" alt="Which release should Pet Life pick up" data-original-src="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/tenants-not-assigned-to-test.png"/>T2】</a></p>

<p><strong>宠物生活</strong>也不分配到调度服务、单点登录或数据转换服务项目。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/pet-life-project-assignments.png" class="zoom" data-title=""><img src="../Images/edf7efb1209114af57a2c28885ee70b4.png" class="img-fluid center" alt="Pet Life assignments" data-original-src="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/pet-life-project-assignments.png"/>T2】</a></p>

<p>当将父项目部署到<strong>Staging</strong>for<strong>Pet Life</strong>时，会发生一些事情</p>

<ul>
<li>Web UI项目的版本<code>2021.1.0.15</code>将被选中，因为它是<strong>测试</strong>的最新成功版本。</li>
<li>将跳过计划服务、数据转换服务和单一登录项目。</li>
</ul>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/pet-life-deployment-to-staging.png" class="zoom" data-title=""><img src="../Images/c2748a21263f89e54ec225a33340cf23.png" class="img-fluid center" alt="Pet Life deploying all the child components it has to staging" data-original-src="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/pet-life-deployment-to-staging.png"/></a>T2】</p>

<p>到目前为止，我们已经将父项目配置为只进行部署。如果我们停在这里，我们会比以前处于更有利的位置。我们可以按特定顺序推出分配给租户的所有组件。此外，该流程将跳过未自动分配给租户的步骤。在管理多租户应用程序时，这本身就是一种成功。但是我们可以更进一步。让我们转到审批。</p>

<h3 id="scenario-approval-in-the-parent-project">方案:父项目中的审批</h3>

<p>在子项目中进行手动干预是很常见的。在这个示例应用程序中，每个组件项目都有两到三个手动干预。这意味着要提交8到18个批准，具体取决于租户。那是非常乏味的。</p>

<p>在理想的配置中，所有的批准都在父项目中，并向下流动到子项目。</p>

<p>然而什么是被批准的？部署Octopus后，所有手动干预都是部署的一部分。这是先有鸡还是先有蛋的情况。为了解决这个问题，step模板提供了“假设”功能，它将完成部署之前的所有工作。此外，步骤模板收集了所有的发行说明以帮助批准。</p>

<p>父项目的流程是:</p>

<ol>
<li>以假设模式运行<strong>部署子Octopus部署项目</strong>步骤模板。</li>
<li>进行所有必要的手动干预。</li>
<li>在正常模式下运行<strong>部署子Octopus部署项目</strong>步骤模板。</li>
</ol>

<p>在假设模式下运行时，将设置以下输出参数，供流程稍后使用:</p>

<ul>
<li><strong> ReleaseToPromote </strong>:满足所有要求的发布号。如果找不到版本，则设置为N/A。如果版本已经部署到目标环境，则它会指示。</li>
<li><strong> ReleaseNotes </strong>:子项目的发布说明。包括提交历史记录和使用构建信息时与项目关联的问题。</li>
<li><strong> ChildReleaseToDeploy </strong>:表示是否有子版本要部署。它要么是真的，要么是假的。在可变运行条件下使用此变量。</li>
</ul>

<h4 id="create-the-what-if-steps">创建假设步骤</h4>

<p>要对此进行配置，首先克隆所有现有的步骤。通过点击每个步骤旁边的溢出菜单(三个垂直省略号)来完成。</p>

<p>【T2 <img src="../Images/49ceedc699c649d23c04a11b0c944e82.png" class="img-fluid center" alt="Release management clone steps" data-original-src="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/release-mangement-clone-steps.png"/></p>

<p>重命名每个克隆的步骤。将克隆步骤中的参数更新为:</p>

<ul>
<li><strong>将发行说明保存为工件</strong>:设置为<code>Yes</code>。</li>
<li><strong>如果</strong>怎么办:设置为<code>Yes</code>。</li>
</ul>

<h4 id="add-the-manual-intervention-steps">添加手动干预步骤</h4>

<p>在继续之前，添加手动干预步骤。手动干预步骤的一个特征是它可以向批准者提供指示。我们可以使用step模板的输出变量来创建有用的指令。例如:</p>

<pre><code>Please approve releases for:

**Database: #{Octopus.Action[Get Database Release].Output.ReleaseToPromote}**
#{Octopus.Action[Get Database Release].Output.ReleaseNotes}

**Web API: #{Octopus.Action[Get Web API Release].Output.ReleaseToPromote}**
#{Octopus.Action[Get Web API Release].Output.ReleaseNotes}

**Scheduling Service: #{Octopus.Action[Get Scheduling Service Release].Output.ReleaseToPromote}**
#{Octopus.Action[Get Scheduling Service Release].Output.ReleaseNotes}

**Data Conversion: #{Octopus.Action[Get Data Conversion Release].Output.ReleaseToPromote}**
#{Octopus.Action[Get Data Conversion Release].Output.ReleaseNotes}

**Web UI: #{Octopus.Action[Get Web UI Release].Output.ReleaseToPromote}**
#{Octopus.Action[Get Web UI Release].Output.ReleaseNotes}

**Web UI: #{Octopus.Action[Get Sign Sign On Release].Output.ReleaseToPromote}**
#{Octopus.Action[Get Single Sign On Release].Output.ReleaseNotes}
</code></pre>

<p>我避免重复劳动。让我们把它作为一个变量。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/manual-intervention-instructions.png" class="zoom" data-title=""><img src="../Images/0e59737b06332c6ee029a2fb4b50bedc.png" class="img-fluid center" alt="Manual intervention instructions" data-original-src="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/manual-intervention-instructions.png"/>T2】</a></p>

<p>现在，我们可以添加手动干预，将指令发送到新变量，并且只在<strong>生产</strong>环境中运行。</p>

<p>手动干预中的负责团队列表与OR相结合。列表中任何团队的任何人都可以批准手动干预。如果您需要多个团队的批准，您将需要多个手动干预步骤。</p>


<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/adding-manual-interventions.png" class="zoom" data-title=""><img src="../Images/5b0c91969cf3d3d08fce6a96e1c52c35.png" class="img-fluid center" alt="Add manual interventions" data-original-src="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/adding-manual-interventions.png"/>T2】</a></p>

<h4 id="reorder-the-steps">重新排列步骤</h4>

<p>部署后，批准没有意义，因此通过单击按名称过滤文本框旁的溢出菜单(三个垂直省略号)并选择重新排序按钮来重新排序步骤。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/reorder-release-orchestration-steps.png" class="zoom" data-title=""><img src="../Images/815fc7f2a33aa59c40ba963f91b7931f.png" class="img-fluid center" alt="Reorder release orchestration steps" data-original-src="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/reorder-release-orchestration-steps.png"/>T2】</a></p>

<p>将您设置的所有“假设”步骤移到“非假设”步骤之上。完成后，您的流程应该如下所示:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/release-orchestration-post-sort.png" class="zoom" data-title=""><img src="../Images/6c9fdb7e40de575e1aab263f1e3b2197.png" class="img-fluid center" alt="Release orchestration project post sort" data-original-src="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/release-orchestration-post-sort.png"/></a>T2】</p>

<h4 id="see-auto-approvals-in-action">了解自动批准的实际应用</h4>

<p>为其中一个租户创建一个新版本，并将其部署到<strong> Staging </strong>。一旦发布完成，就将其发布到<strong>生产</strong>。</p>

<p>在此部署过程中，您将看到手动干预和自动批准在起作用。首先，手动干预应该有随发行说明一起部署的版本:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/manual-intervention-with-rendered-notes.png" class="zoom" data-title=""><img src="../Images/c12587c22c0a4066aa3b9beab6be6e06.png" class="img-fluid center" alt="Manual intervention with rendered notes" data-original-src="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/manual-intervention-with-rendered-notes.png"/>T2】</a></p>

<p>在每个小组都批准了发布之后，部署就开始了。如果您转到一个特定的部署，您将在子项目中看到类似于以下内容的消息:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/release-management-auto-approval-message.png" class="zoom" data-title=""><img src="../Images/6e61f05a1b207c68e48755488858ccc4.png" class="img-fluid center" alt="Manual intervention auto-approval message" data-original-src="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/release-management-auto-approval-message.png"/>T2】</a></p>

<p>发布到<strong>生产</strong>现已完成。您可以在一个地方批准特定租户的所有子项目部署。</p>

<h3 id="scenario-approve-today-deploy-tomorrow">场景:今天批准，明天部署</h3>

<p>有时，在进入<strong>生产</strong>之前，特定客户需要在发布上签字。在实际部署期间，他们不太可能批准部署。例如，更常见的情况是，他们会在周二批准在周四部署。另外，让我提醒你之前的这条规则:</p>

<blockquote class="blockquote">
<p>某些客户，如<strong>所有宠物</strong>和<strong>宠物世界</strong>必须在发布部署到<strong>生产</strong>环境之前给予同意。</p>
</blockquote>

<p><strong>所有宠物</strong>和<strong>宠物世界</strong>都需要特别批准。所有其他客户只需要一次批准，这将发生在<strong>内部</strong>租户。</p>

<p>为了避免部署在<strong>生产</strong>中等待数天的人工干预，您可以在<strong>准备</strong>和<strong>生产</strong>之间有一个<strong>产品批准</strong>环境。</p>

<p><strong>产品批准</strong>环境将<em>仅</em>用于父项目。子项目的生命周期将保持不变。</p>


<p>这个场景逐步将<strong>产品批准</strong>环境添加到多租户应用程序中，以满足这些规则。</p>

<h4 id="add-the-new-environment-and-configure-the-lifecycle">添加新环境并配置生命周期</h4>

<p>添加<strong>产品批准</strong>环境。你会注意到我的截图中的环境位于本页的<strong>暂存</strong>和<strong>生产</strong>之间。我单击了溢出菜单，对该页面上的环境进行了重新排序。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/release-management-add-prod-approval.png" class="zoom" data-title=""><img src="../Images/689390975f46efe2ca5d7a6d8f290c4b.png" class="img-fluid center" alt="add prod approval" data-original-src="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/release-management-add-prod-approval.png"/>T2】</a></p>

<p>现在已经添加了新的环境，更新这个发布编排项目所使用的生命周期。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/release-management-updated-lifecycles.png" class="zoom" data-title=""><img src="../Images/44ed363b6292f46604454b380e48b75e.png" class="img-fluid center" alt="Prod approval in the release orchestration lifecycle" data-original-src="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/release-management-updated-lifecycles.png"/>T2】</a></p>

<p>关注<strong>默认生命周期。</strong>它没有明确定义的短语，而是使用整个环境列表自动生成阶段。要从<strong>默认生命周期</strong>中删除<strong>产品批准</strong>，您需要添加显式阶段。</p>


<h4 id="update-the-deployment-process">更新部署流程</h4>

<p>接下来，更新批准步骤，使其仅在<strong>产品批准</strong>环境中运行。然后配置非假设步骤，跳过<strong>生产审批</strong>环境。更新后的部署流程如下所示:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/prod-approval-environment-process-changes.png" class="zoom" data-title=""><img src="../Images/302c47dd6ced5c6d446ebff0c7acd690.png" class="img-fluid center" alt="Deployment process after prod approval changes" data-original-src="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/prod-approval-environment-process-changes.png"/>T2】</a></p>

<p>接下来，导航到变量屏幕并添加两个新变量:</p>

<ul>
<li><strong>项目。child project . Approval . environment . name</strong>:存储<strong> Prod Approval </strong>环境名。</li>
<li><strong>项目。child project . deployment . environment . name</strong>:存储部署的目标环境的名称。对于除<strong>产品批准</strong>之外的所有环境，该名称将与当前环境相匹配。在<strong>产品批准</strong>环境中运行时，部署环境的名称是<strong>生产</strong>。</li>
</ul>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/release-management-approval-environment-variables.png" class="zoom" data-title=""><img src="../Images/ca9dbf997dae27ae798bf6b0fff928e8.png" class="img-fluid center" alt="Release management approval environment variables" data-original-src="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/release-management-approval-environment-variables.png"/>T2】</a></p>

<p>进入实施<strong>部署子Octopus部署项目</strong>的每个步骤，并更新以下参数:</p>

<ul>
<li><strong>目的环境名称</strong>:更新为<code>#{Project.ChildProject.Deployment.Environment.Name}</code>。</li>
<li><strong>审批环境</strong>:更新至<code>#{Project.ChildProject.Approval.Environment.Name}</code>。</li>
</ul>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/release-management-using-the-new-variables.png" class="zoom" data-title=""><img src="../Images/ef23bd2ba2166e8491dd270bf082912f.png" class="img-fluid center" alt="Using the new variables in the new steps" data-original-src="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/release-management-using-the-new-variables.png"/>T2】</a></p>

<p>通过这样做，我们告诉步骤模板在<strong>生产</strong>部署期间从<strong>生产审批</strong>环境而不是<strong>生产</strong>环境中获取审批。这意味着我们可以在上午11点批准，并安排在下午7点部署。</p>


<h4 id="set-the-tenant-approvals">设置租户审批</h4>

<p>最后，设置审批租户。默认情况下，批准租户是当前租户的名称。那个默认将只适用于<strong>所有宠物</strong>、<strong>宠物世界</strong>和<strong>内部</strong>。其他人都会用<strong>内部</strong>。有几种方法可以实现这一点。我将使用一个项目变量模板，默认值设置为<code>Internal</code>:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/project-variable-templates-approval-tenant.png" class="zoom" data-title=""> T38 </a></p>

<p>转到<strong>内部</strong>、<strong>所有宠物</strong>和<strong>宠物世界</strong>，为发布编排项目分配<strong>产品批准</strong>环境。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/linking-prod-approval-to-tenant.png" class="zoom" data-title=""><img src="../Images/9794ab6a6adc02fb8b2c5bbf8354ed92.png" class="img-fluid center" alt="Assigning the prod approval environment" data-original-src="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/linking-prod-approval-to-tenant.png"/>T2】</a></p>

<p>对于<strong>所有宠物</strong>和<strong>宠物世界</strong>，在<strong>生产</strong>环境下将审批租户名称改为<code>Octopus.Deployment.Tenant.Name</code>。这是必要的，因为<strong>生产</strong>环境是我们需要获得批准的地方。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/overwriting-default-approval-tenant.png" class="zoom" data-title=""><img src="../Images/39bb2e8e3e2379025161e3975fc79f7a.png" class="img-fluid center" alt="Changing the approval tenant name" data-original-src="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/overwriting-default-approval-tenant.png"/>T2】</a></p>

<p>对于每个“非假设”步骤，将批准租户设置为前面创建的变量。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/setting-approval-tenant-deployment-step.png" class="zoom" data-title=""><img src="../Images/311101af0492995ca0717156457f4d70.png" class="img-fluid center" alt="Setting the approval tenant in the steps" data-original-src="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/setting-approval-tenant-deployment-step.png"/>T2】</a></p>

<p>批准屏幕将显示<strong>宠物生活</strong>和<strong>仅限狗</strong>不在<strong>产品批准</strong>环境中运行。其他房客都是这样。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/orchestration-project-overview-approval-rules.png" class="zoom" data-title=""><img src="../Images/90c197144540fbfe6d8831ccc4a2ae9c.png" class="img-fluid center" alt="Release orchestration approval overview" data-original-src="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/orchestration-project-overview-approval-rules.png"/>T2】</a></p>

<h4 id="seeing-approvals-in-action">查看批准的实际情况</h4>

<p>让我们看看这一切的行动。首先，让我们部署<strong>内部</strong>到<strong>暂存</strong>和<strong>生产审批</strong>。只有假设步骤和批准步骤将在<strong>产品批准</strong>环境中运行。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/release-orchestartion-production-approval-environment.png" class="zoom" data-title=""><img src="../Images/bc1094d245c7c9323f74e8ee1ef339b0.png" class="img-fluid center" alt="Prod approval environment for internal tenant" data-original-src="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/release-orchestartion-production-approval-environment.png"/>T2】</a></p>

<p>现在把那个发布提升到<strong>生产</strong>为<strong>内部</strong>。从<strong>内部</strong>租户的<strong>产品批准</strong>环境中获取批准。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/prod-approval-internal-tenant-message.png" class="zoom" data-title=""><img src="../Images/3f63e4d5ec9409d9751e3864c2f69533.png" class="img-fluid center" alt="Prod approval for internal tenant message" data-original-src="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/prod-approval-internal-tenant-message.png"/>T2】</a></p>

<p>在<strong>内部</strong>通过<strong>产品批准</strong>后，我们可以进入<strong>宠物生活</strong>和<strong>仅限狗</strong>。通过<strong>准备</strong>和<strong>生产</strong>促进发布表明<strong>内部</strong>租户的批准。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/pet-life-deploy-to-prod-for-internal-tenant-approval.png" class="zoom" data-title=""><img src="../Images/49f2dd06090756d45622a612a69de617.png" class="img-fluid center" alt="Prod approval for Pet Life tenant using the internal tenant" data-original-src="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/pet-life-deploy-to-prod-for-internal-tenant-approval.png"/>T2】</a></p>

<p>当相同的版本被部署到<strong>所有宠物</strong>的<strong>生产</strong>时，我们看到批准来自<strong>所有宠物</strong>租户。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-07/multi-tenancy-release-management/all-pets-tenant-approval-from-coca-cola.png" class="zoom" data-title=""> T39 </a></p>

<p>步骤模板仅查找当前版本的批准。创建一个新版本将需要另一轮批准，即使是补丁版本，如<code>2021.1.1</code>。</p>


<h2 id="conclusion">结论</h2>

<p>这篇文章介绍了<a href="https://library.octopus.com/step-templates/0dac2fe6-91d5-4c05-bdfb-1b97adf1e12e/actiontemplate-deploy-child-octopus-deploy-project" rel="nofollow">部署子Octopus部署项目</a>步骤模板的一些多租户场景。你可以在我的<a href="/blog/release-management-with-octopus">上一篇</a>中看到更多的场景。</p>

<p>Octopus Deploy的多租户功能旨在帮助在不同基础设施上安装软件的公司。我看到和听到了客户在这个模型中遇到的各种怪癖，它们是我编写这个步骤模板的动机。我希望帮助客户避免手动流程中的错误，并尽可能消除多租户部署带来的心理负担。</p>

<p>我希望这个步骤模板对您的多租户项目有用。</p>

<p>这个三部分系列的最后一个指南是:</p>



<h2 id="watch-the-webinar-better-multi-tenancy-deployments-using-octopus-deploy">观看网络研讨会:使用Octopus Deploy实现更好的多租户部署</h2>

<iframe src="https://www.youtube.com/embed/dD8psiK1wL4" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen="">VIDEO</iframe>

<p>我们定期举办网络研讨会。请参见<a href="https://octopus.com/events">网络研讨会第</a>页，了解过去的网络研讨会和即将举办的网络研讨会的详细信息。</p>

<p>愉快的部署！</p>

                    
                    
</body>
</html>