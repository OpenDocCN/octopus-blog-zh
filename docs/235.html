<html>
<head>
<title>The difference between ClusterIP, NodePort, and LoadBalancer Kubernetes services - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>ClusterIP、NodePort和负载平衡器Kubernetes服务之间的区别——Octopus Deploy</h1>
<blockquote>原文：<a href="https://octopus.com/blog/difference-clusterip-nodeport-loadbalancer-kubernetes#2022-12-15">https://octopus.com/blog/difference-clusterip-nodeport-loadbalancer-kubernetes#2022-12-15</a></blockquote>
                        <p>Kubernetes服务提供三种不同类型:</p>

<ul>
<li><code>ClusterIP</code></li>
<li><code>NodePort</code></li>
<li><code>LoadBalancer</code></li>
</ul>

<p>知道要配置哪种类型的服务对于允许客户端建立网络连接同时不将服务暴露给不必要的流量是至关重要的。</p>

<p>在这篇文章中，我将讨论这三种类型的服务以及何时应该使用它们。</p>

<h2 id="the-clusterip-service-type">ClusterIP服务类型</h2>

<p>下面的YAML定义了一个类型为<code>ClusterIP</code>的服务，该服务在标签<code>app</code>设置为<code>web</code>(由<code>selector</code>属性定义)的任何pod上将端口80(由<code>port</code>属性定义)上的流量定向到端口8080(由<code>targetPort</code>属性定义):</p>

<pre><code class="language-yaml">apiVersion: v1
kind: Service
metadata:
  name: my-service
spec:
  type: ClusterIP
  selector:
    app: web
  ports:
    - protocol: TCP
      port: 80
      targetPort: 8080
</code></pre>

<p>服务将pod暴露给内部网络流量。例如，您可以通过一个<code>ClusterIP</code>服务向其他pods公开一个数据库，因为外部客户机永远不应该直接访问数据库。</p>

<p><code>ClusterIP</code>服务暴露的表面积最小，应该用于只需要暴露给集群中其他pod的pod。</p>

<p>下图显示了同一集群中的pod如何通过<code>ClusterIP</code>服务进行通信:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-11/difference-clusterip-nodeport-loadbalancer-kubernetes/clusterip.png" class="zoom" data-title=""><img src="../Images/6721a7b2bcf2babcc0078ae51d2db0a2.png" class="img-fluid center" alt="ClusterIP diagram" data-original-src="https://i.octopus.com/blog/2022-11/difference-clusterip-nodeport-loadbalancer-kubernetes/clusterip.png"/>T2】</a></p>

<h2 id="the-nodeport-service-type">节点端口服务类型</h2>

<p>下面的YAML定义了一个<code>NodePort</code>服务，它将每个节点上端口30007(由<code>nodePort</code>属性定义)上的流量定向到标签<code>app</code>设置为<code>web</code>的任何pod上的端口8080(由<code>targetPort</code>属性定义):</p>

<pre><code class="language-yaml">apiVersion: v1
kind: Service
metadata:
  name: my-service
spec:
  type: NodePort
  selector:
    app: web
  ports:
    - protocol: TCP
      port: 80
      targetPort: 8080
      nodePort: 30007
</code></pre>

<p><code>NodePort</code>服务在内部公开pod的方式与<code>ClusterIP</code>服务相同。此外，<code>NodePort</code>服务允许外部客户通过Kubernetes节点上开放的网络端口访问pod。这些端口通常在30000-32768的范围内，尽管该范围是可定制的。</p>

<p><code>NodePort</code>服务对于将pod暴露给外部流量非常有用，其中客户端可以通过网络访问Kubernetes节点。例如，如果您的节点有主机名<code>node1</code>和<code>node2</code>，上面的示例服务让客户机访问http://node1:30007或http://node2:30007。外部客户端连接到哪个节点并不重要，因为Kubernetes配置网络路由，将所有流量从任何<em>节点上的端口30007定向到适当的pods。</em></p>

<p>在实践中，我还没有看到<code>NodePort</code>服务在生产系统中被大量使用。不寻常的端口经常受到限制性防火墙规则的限制，并且很难理解您使用像http://node1:30007这样的URL与什么服务进行通信。<code>NodePort</code>服务非常适合测试，因为它们可能不需要任何额外的基础设施来将pod暴露给外部流量，这使得它们成为调试pod的快速而简单的方法。</p>

<p>下图显示了外部客户端如何通过由<code>NodePort</code>服务公开的节点上的端口与pods通信:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-11/difference-clusterip-nodeport-loadbalancer-kubernetes/nodeport.png" class="zoom" data-title=""><img src="../Images/c5cd4cb2d57293d6a9843bc1e83f4438.png" class="img-fluid center" alt="Diagram with boxes and arrows showing how external clients can communicate with pods via ports" data-original-src="https://i.octopus.com/blog/2022-11/difference-clusterip-nodeport-loadbalancer-kubernetes/nodeport.png"/>T2】</a></p>

<h2 id="the-loadbalancer-service-type">负载平衡器服务类型</h2>

<p>下面的YAML定义了一个<code>LoadBalancer</code>服务，它将流量从公共负载平衡器上的端口80(由<code>port</code>属性定义)和内部服务定向到标签<code>app</code>设置为<code>web</code>的任何pod上的端口8080(由<code>targetPort</code>属性定义):</p>

<pre><code class="language-yaml">apiVersion: v1
kind: Service
metadata:
  name: my-service
spec:
  type: LoadBalancer
  selector:
    app: web
  ports:
    - protocol: TCP
      port: 80
      targetPort: 8080
</code></pre>

<p><code>LoadBalancer</code>服务在内部公开pod的方式与<code>NodePort</code>服务相同。此外，<code>LoadBalancer</code>服务创建外部网络基础设施，将网络请求定向到集群中的pod。在云平台上，如Azure、AWS和GCP，外部负载平衡器通常由云提供商的现有负载平衡器服务之一提供。例如，AWS上的一个<a href="https://aws.amazon.com/eks/" rel="nofollow"> EKS集群</a>可能会创建一个<a href="https://aws.amazon.com/elasticloadbalancing/" rel="nofollow">弹性负载均衡器(ELB) </a>来将pods暴露给公共网络流量。</p>

<p>当pod需要通过可预测的URL向外部客户端公开时，或者当需要对外部客户端建立的连接进行额外控制时，服务是最佳选择。通过使用云提供商提供的现有负载平衡器解决方案，<code>LoadBalancer</code>服务使管理员能够配置额外的设置，如扩展、防火墙、路由等，以及以pod为目的地的外部流量。</p>

<p><code>LoadBalancer</code>服务的缺点是通常会产生额外的费用。例如，如果一个ELB实例一天24小时运行，每月的成本大约为16美元，这还不包括任何与网络流量相关的成本。</p>

<p>下图显示了外部客户端如何通过由<code>LoadBalancer</code>服务创建的负载平衡器与pods通信:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-11/difference-clusterip-nodeport-loadbalancer-kubernetes/loadbalancer.png" class="zoom" data-title=""><img src="../Images/792666565839dd8b907e4666b71ade19.png" class="img-fluid center" alt="Diagram showing how external clients can communicate with pods via a load balancer" data-original-src="https://i.octopus.com/blog/2022-11/difference-clusterip-nodeport-loadbalancer-kubernetes/loadbalancer.png"/>T2】</a></p>

<h2 id="conclusion">结论</h2>

<p>不同类型的Kubernetes服务提供了多种方式将pod暴露给网络流量。选择正确的服务取决于您是否需要在集群内部向能够访问非标准端口的外部客户端，或者向需要专用负载平衡器的规模和灵活性的外部客户端公开pod。</p>

<p>在这篇文章中，您了解了<code>ClusterIP</code>、<code>NodePort</code>和<code>LoadBalancer</code>服务之间的区别，以及每种服务何时可以使用。</p>

<p>愉快的部署！</p>

                    
                    
</body>
</html>