<html>
<head>
<title>Building and deploying a Java app with Docker, Google, Azure, and Octopus - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>使用Docker、Google、Azure和Octopus - Octopus Deploy构建和部署Java应用程序</h1>
<blockquote>原文：<a href="https://octopus.com/blog/deploying-java-app-docker-google-azure#2022-05-19">https://octopus.com/blog/deploying-java-app-docker-google-azure#2022-05-19</a></blockquote>
                        <p>持续集成(CI)过程通常包括构建映像并将其推送到容器注册中心。然后，持续交付(CD)工具接管并部署到一个端点，如web应用程序。在我们的<a href="https://octopus.com/blog/tag/CI%20Series"> CI系列</a>中，我们探索了实现这一目标的各种方法。</p>

<p>为了演示其中一个过程，我构建了一个Maven Java项目，并在Google容器注册中心(GCR)上托管了这个映像。</p>

<p>您可以通过Octopus访问GCR，并将Java应用程序部署到Azure Kubernetes服务(AKS)。</p>

<h2 id="prerequisites">先决条件</h2>

<p>要跟进这篇文章，你需要:</p>



<h2 id="the-octopus-underwater-app">章鱼水下应用</h2>

<p>Octopus underwater应用程序是用户创建第一个部署的登录页面。它包括帮助您继续Octopus Deploy之旅的帖子链接。</p>

<p>你可以在<a href="https://github.com/OctopusSamples/octopus-underwater-app" rel="nofollow"> GitHub </a>上找到web应用库。</p>

<p>对于不同的用例，存储库被分成不同的分支。对于这篇文章，使用水下应用java分支。</p>

<h2 id="building-and-pushing-to-a-registry">构建并推送注册中心</h2>

<p>您使用命令行构建Java项目，并使用gcloud将映像推送到GCR。</p>

<p>首先，配置gcloud工具指向您的<code>PROJECT_ID</code>:</p>

<pre><code>gcloud config set project &lt;PROJECT_ID&gt;
</code></pre>

<p>克隆您将用来构建和部署到Azure的Java项目存储库:</p>

<pre><code>git clone https://github.com/terence-octo/octopus-underwater-app
cd octopus-underwater-app
git checkout underwater-app-java
</code></pre>

<p>使用<code>run</code>命令并访问<code>http://localhost:8080/</code>在本地测试应用程序</p>

<pre><code>chmod +x mvnw
./mvnw spring-boot:run
</code></pre>

<p>当您运行package步骤时，它会为应用程序构建可部署的目标JAR:</p>

<pre><code>./mvnw package
</code></pre>

<p>接下来，启用容器注册表来存储容器映像:</p>

<pre><code>gcloud services enable containerregistry.googleapis.com
export GOOGLE_CLOUD_PROJECT=`gcloud config list --format="value(core.project)"`
</code></pre>

<p>运行以下命令，使用正确的设置创建config.json:</p>

<pre><code>gcloud auth configure-docker
</code></pre>

<p>jib工具创建图像并将其推送到容器注册表:</p>

<pre><code>./mvnw com.google.cloud.tools:jib-maven-plugin:build -Dimage=gcr.io/$GOOGLE_CLOUD_PROJECT/octopus-underwater-app:latest
</code></pre>

<p>通过进入<a href="https://cloud.google.com/container-registry" rel="nofollow">集装箱注册主页</a>确认图像存在于GCR上。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-01/deploying-java-app-docker-google-azure/gcr.png" class="zoom" data-title=""><img src="../Images/0779310520ade2763b6c3f631c245735.png" class="img-fluid center" alt="gcr" data-original-src="https://i.octopus.com/blog/2022-01/deploying-java-app-docker-google-azure/gcr.png"/>T2】</a></p>

<h2 id="retrieving-credentials-from-azure-for-octopus-deploy">正在从Azure检索用于Octopus部署的凭据</h2>

<p>您需要检索一些凭证以传递给Octopus Deploy。</p>

<p>按照我们文档中的步骤来<a href="https://octopus.com/docs/infrastructure/accounts/azure">添加Azure服务主体到Octopus Deploy </a>。</p>

<h2 id="creating-an-azure-kubernetes-cluster">创建Azure Kubernetes集群</h2>

<p>接下来，切换到Microsoft Azure来托管您的Kubernetes集群。Octopus Deploy与云无关，因此它可以与跨多个云提供商的部署一起工作。</p>

<ol>
<li>通过转到您的资源组并创建一个Kubernetes服务来创建一个新的Kubernetes集群。</li>
<li>为集群命名，并接受所有默认选项。</li>
</ol>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-01/deploying-java-app-docker-google-azure/create-kubernetes-cluster.png" class="zoom" data-title=""><img src="../Images/1f37eb006fda4d3dda7b11f8c256e2ef.png" class="img-fluid center" alt="Create Kubernetes Cluster" data-original-src="https://i.octopus.com/blog/2022-01/deploying-java-app-docker-google-azure/create-kubernetes-cluster.png"/></a>T2】</p>

<h2 id="octopus-steps">章鱼步</h2>

<h3 id="add-deployment-target">添加部署目标</h3>

<ol>
<li>转到<strong>基础设施</strong>，然后<strong>部署目标</strong>，然后<strong>添加部署目标</strong>，然后<strong> Kubernetes集群</strong>。</li>
<li>使用之前设置的Azure服务原则填写字段。</li>
<li>为部署分配唯一的角色。</li>
</ol>

<h3 id="add-external-feeds">添加外部源</h3>

<p>为了让Octopus访问存储在GCR的图像，您需要启用<a href="https://octopus.com/docs/packaging-applications/package-repositories/guides/google-container-registry"> Google容器注册表提要</a>。</p>

<h3 id="set-up-deployment-steps">设置部署步骤</h3>

<p>在您的项目中，添加<strong>部署Kubernetes容器</strong>步骤。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-01/deploying-java-app-docker-google-azure/deploy-kubernetes-containers-step.png" class="zoom" data-title="Deploy Success"><img src="../Images/1191dc92adfc8c1ac970b977f5274155.png" class="img-fluid center" alt="Deploy Kubernetes Containers step" title="Deploy Success" data-original-src="https://i.octopus.com/blog/2022-01/deploying-java-app-docker-google-azure/deploy-kubernetes-containers-step.png"/>T2】</a></p>

<h3 id="yaml-file">YAML文件</h3>

<p>点击<strong>编辑YAML </strong>框，将下面的YAML文件粘贴到框中。YAML文件填充Octopus UI中的各种设置。您必须用您的google PROJECT_ID替换PROJECT_ID。使用前面设置的Google外部提要凭证，您还可以使用UI手动选择容器图像。</p>

<pre><code>apiVersion: apps/v1
kind: Deployment
metadata:
  name: java-web-underwater
  labels:
    app: java-web-app
spec:
  selector:
    matchLabels:
      app: java-web-app
  replicas: 1
  strategy:
    type: RollingUpdate
  template:
    metadata:
      labels:
        app: java-web-app
    spec:
      containers:
        - name: java-web-app
          image: gcr.io/&lt;PROJECT_ID&gt;/octopus-underwater-app
          ports:
            - containerPort: 80
</code></pre>

<h3 id="service">服务</h3>

<p>将以下YAML粘贴到步骤的<strong>服务</strong>部分。这将通过Octopus客户端创建一个Azure服务。</p>

<pre><code>
apiVersion: v1
kind: Service
metadata:
  name: underwater-service
spec:
  type: LoadBalancer
  ports:
    - name: web
      port: 80
      targetPort: 8080
      protocol: TCP
  selector:
    app: java-web-app

</code></pre>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-01/deploying-java-app-docker-google-azure/octopus-service.png" class="zoom" data-title="Kubernetes Service"><img src="../Images/4fa3b5bc395ebcf42f98c8eb27838c11.png" class="img-fluid center" alt="Kubernetes Service section in Octopus process editor" title="Kubernetes Service" data-original-src="https://i.octopus.com/blog/2022-01/deploying-java-app-docker-google-azure/octopus-service.png"/>T2】</a></p>

<h3 id="deploy-to-azure">部署到Azure</h3>

<ol>
<li>点击<strong>保存</strong>。</li>
<li>点击<strong> Create Release </strong>，点击各个步骤，将应用部署到Azure。</li>
</ol>



<p>您可以通过runbooks设置对Kubernetes资源的监控。</p>

<p>转到您的项目仪表板，然后<strong>运行手册</strong>，然后<strong>添加运行手册</strong>，然后<strong>定义您的运行手册流程</strong>，然后<strong>添加步骤</strong>，然后<strong> Kubernetes - Inspect资源</strong>。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-01/deploying-java-app-docker-google-azure/inspect-kubernetes-octopus.png" class="zoom" data-title=""><img src="../Images/d05bf4308790fe164ab942001b30491d.png" class="img-fluid center" alt="Inspect Kubernetes Octopus" data-original-src="https://i.octopus.com/blog/2022-01/deploying-java-app-docker-google-azure/inspect-kubernetes-octopus.png"/>T2】</a></p>

<p>分配您为部署目标设置的角色。您可以通过设置<strong>资源</strong>和<strong>库对象动词</strong>来复制<code>kubectl get service</code>命令。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-01/deploying-java-app-docker-google-azure/get-service.png" class="zoom" data-title=""><img src="../Images/c69f5a3b1cb03828545a1adbce1903e8.png" class="img-fluid center" alt="Get Service" data-original-src="https://i.octopus.com/blog/2022-01/deploying-java-app-docker-google-azure/get-service.png"/>T2】</a></p>

<p>点击<strong>保存</strong>，然后<strong>运行</strong>。</p>

<p>操作手册现在可以跨团队共享。这意味着监控可以在组织级别完成，而不是在本地机器上单独完成。</p>

<p>转到任务日志，查看您刚刚创建的<code>underwater-service</code>。在<strong>外部IP </strong>下找到IP地址。在浏览器地址栏输入这个地址，你就会看到章鱼水下应用。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-01/deploying-java-app-docker-google-azure/octopus-underwater-app.png" class="zoom" data-title=""><img src="../Images/82d7f56074ca3655d5775480646f375e.png" class="img-fluid center" alt="Octopus Underwater App" data-original-src="https://i.octopus.com/blog/2022-01/deploying-java-app-docker-google-azure/octopus-underwater-app.png"/>T2】</a></p>

<h2 id="conclusion">结论</h2>

<p>在这篇文章中，你构建了章鱼水下应用程序，并将图片推送到GCR。您使用Octopus Deploy来引用这个映像，并将该映像部署到AKS。</p>

<p>阅读我们的<a href="https://octopus.com/blog/tag/CI%20Series">持续集成系列</a>的其余部分。</p>

<p>愉快的部署！</p>

                    
                    
</body>
</html>