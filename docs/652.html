<html>
<head>
<title>Saving Cloud Dollars: Consumption usage details in Azure - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>节省云成本:Azure - Octopus Deploy中的消费使用细节</h1>
<blockquote>原文：<a href="https://octopus.com/blog/saving-cloud-dollars#2022-08-09">https://octopus.com/blog/saving-cloud-dollars#2022-08-09</a></blockquote>
                        <p>更新于2018-04-23 -这篇博客文章在我们的Octopus 2018.4发布后进行了更新，现在支持<a href="https://octopus.com/blog/octopus-release-2018.4#recurring-scheduled-deployments">重复计划部署</a>，以说明如何按计划定期运行部署。</p>

<p>你是否曾经在Azure中部署了一个虚拟机，进行了10分钟的快速测试，却在两个月后回来，发现它一直在运行？这篇博文展示了如何使用Octopus通过Slack通知您Azure资源组的成本是否超过了预期值——您可以使用资源组标签来指定。由于Octopus有能力认证许多不同的云平台，并向它们部署资源，它自然也有能力获取有用的数据。这使得Octopus成为运行我们需要查看我们的资源消耗的脚本的绝佳候选。</p>

<h2 id="scenario">方案</h2>

<p>我喜欢好的场景，所以事不宜迟，请见见OctoFX一家虚构的公司，由技术高超的开发人员组成，他们将资源部署到云中并对其进行测试。最近，他们注意到当测试完成时很难记得删除某些资源，并且希望在资源的成本超过成本限制时得到通知。虽然每个云平台都有自己通知成本的方式，但OctoFX选择使用Octopus来运行这些脚本，因为它允许他们遵循一致的方法，而不管他们使用的是哪个云平台。在这个场景中，我们将定义一个名为NotifyCostLimit的标记，当达到这个限制时，Octopus将发出slack通知。如果没有应用NotifyCostLimit，将采用默认值$100。</p>

<p>这篇博客文章只涵盖了查询Microsoft Azure的步骤，但是您也可以对AWS应用类似的方法。所以，让我们开始吧！如果您想了解脚本执行的过程，您可以遵循以下每个目标。或者，你可以跳到这个博客的<code>Configure it in Octopus</code>部分来看完整的脚本。</p>

<h2 id="limitations">限制</h2>

<p>这里需要注意几个关键点:</p>

<ul>
<li>用于检索成本项目的cmdlet(<a href="https://docs.microsoft.com/en-us/powershell/module/azurerm.consumption/get-azurermconsumptionusagedetail?view=azurermps-5.4.0" rel="nofollow">Get-AzureRmConsumptionUsageDetail</a>)只能获得资源管理器的详细信息，这意味着我们根本看不到任何服务管理器资源成本。</li>
<li>可能需要两周时间才能获得消费详情，我们应该考虑到我们看到的最早的数据条目可能是两周前的。</li>
<li>成本数字不含税。</li>
</ul>

<h2 id="objective-1-get-all-cost-items-for-all-subscriptions-in-azure">目标1:获取Azure中所有订阅的所有费用项目。</h2>

<p>下面这段脚本的主要目的是检索消费使用情况的详细信息。这可以通过使用来自Azure PowerShell的Get-AzureRmConsumptionUsageDetailcmdlet来完成。这里我们提供了两个日期，开始日期(今天减去30天)和结束日期(今天)</p>

<pre><code class="language-powershell">write-output "Getting all cost items for this subscription in Azure"
write-output "Subscription ID: $SubscriptionId "

$now = get-Date

$startDate = $($now.Date.AddDays(-$DateRangeInDays))
$endDate = $($now.Date)

write-output "Start Date:  $startDate  "
write-output "end Date:  $endDate "


$SubConsumptionUsage = Get-AzureRmConsumptionUsageDetail -StartDate $startDate  -EndDate $endDate
</code></pre>

<h2 id="objective-2-find-all-of-the-resource-group-names-which-existed-during-this-billing-period">目标2:查找在此开单期间存在的所有资源组名称。</h2>

<p>现在，我们从消费使用详细信息中取出每一行，删除每个实例ID的开始部分。然后，我们去掉资源组名称之后的所有内容。最后，我们完成了资源组名称。因为资源组是不区分大小写的，所以我将每个资源组的名称都改成了小写。</p>

<pre><code class="language-powershell">write-output "Finding all of the resource group names which existed during this billing period."
$SubIdPrefix = "/subscriptions/" + $SubscriptionId
$RgIdPrefix = $SubIdPrefix + "/resourceGroups/"

$resourceGroupName = @()
$resourceGroups = @()

foreach ($line in $SubConsumptionUsage) {
    if ($line.InstanceId -ne $null ) {
        $thisRgName = $($line.InstanceId.ToLower()).Replace($RgIdPrefix.ToLower(),"")
        $toAdd = $thisRgName.Split("/")[0]
        $toAdd = $toAdd.ToString()
        $toAdd = $toAdd.ToLower()
        $toAdd = $toAdd.Trim()

        if ($resourceGroups.Name -notcontains $toAdd) {
            $resourceGroupName = [PSCustomObject]@{
            Name = $toAdd
            }
            $resourceGroups += $resourceGroupName
        }
    }
}

write-output "Found these Resource groups: "
$resourceGroups
</code></pre>

<h2 id="objective-3-calculate-the-cost-of-each-resource-group-then-flag-ones-that-exceed-notifycostlimit">目标3:计算每个资源组的成本，然后标记超出NotifyCostLimit的资源组。</h2>

<p>对于遇到的每个资源组名称，我们按资源组过滤详细信息，并将所有成本加在一起。这成为每个资源组的总成本。</p>

<pre><code class="language-powershell">Write-Output "Calculating the cost of each Resource Group, then flag ones that exceed NotifyCostLimit."
$currentResourceGroups = Get-AzureRmResourceGroup
$rgIndexId = 0

foreach ($rg in $resourceGroups) {

    #$thisRg = $null
    $RgIdPrefix = $SubIdPrefix + "/resourceGroups/" + $rg.Name
    $ThisRgCost = $null
    $SubConsumptionUsage | ? { if ( $_.InstanceId -ne $null) { $($_.InstanceId.ToLower()).StartsWith($RgIdPrefix.ToLower()) } } |  ForEach-Object { $ThisRgCost += $_.PretaxCost   }
    $toaddCost = [math]::Round($ThisRgCost,2)
    $resourceGroups[$rgIndexId] | Add-Member -MemberType NoteProperty -Name "Cost" -Value $toaddCost

    if ($currentResourceGroups.ResourceGroupName -contains $rg.Name) {

        $addingResourceGroup = Get-AzureRmResourceGroup -Name $($rg.Name)
        $resourceGroups[$rgIndexId] | Add-Member -MemberType NoteProperty -Name "NotifyCostLimit" -Value $($addingResourceGroup.tags.NotifyCostLimit)

    }

    $rgIndexId ++

}
</code></pre>

<h2 id="objective-4-filter-the-items-whose-cost-is-higher-than-expected">目标4:筛选成本高于预期的项目。</h2>

<p>为了完成这下一部分，我们将把我们的资源组传送到<code>where-object</code>(它被缩短为<code>?</code>，以过滤大于或等于成本通知标签<code>NotifyCostLimit</code>的每个项目。</p>

<pre><code class="language-powershell">Write-Output "Filtering the items whose cost is higher than the allowed limit."
$reminderGroups = $resourceGroups | ? {
    if ($_.NotifyCostLimit -ne $Null) {

        $_.Cost -ge $_.NotifyCostLimit

    }
    else {

        $_.Cost -ge $DefaultNotifyCostLimit

    }
}
</code></pre>

<h2 id="objective-5-notify-the-correct-people-using-a-slack-notification">目标5:使用时差通知通知正确的人。</h2>

<p>最后，我们将提醒人们，他们可能有一个已经达到资源成本极限的测试资源。</p>

<pre><code class="language-powershell">function new-SlackMessage ( $resourceGroup ) {

    $orange = "#F9812A"
    $attachments = @{}
    $fieldNumber = 0
    $username = "Octopus Cost Reminder"
    $IconUrl = "https://octopus.com/images/company/Logo-Blue_140px_rgb.png"
    $payload = @{
    #channel = "General";
    username = $username;
    icon_url = $IconUrl;
    attachments = @(
    );
    }


    $state = "Current cost: $($resourceGroup.Cost)"
    $description = "ResourceGroup Name: $($resourceGroup.Name)"
    $ownerContact = "OwnerContact: $($resourceGroup.OwnerContact)"
    $colour = $orange

    if ($fieldNumber -eq 0){
        $pretext = "This Resource Group has spiked above expected cost"
    }
    else {
        $pretext = $null
    }

    $thisFallbackMessage = "$description has spiked above expected cost (Current Cost: $state)"

    #Some results can have multiple fields:
    $fields = @(
        @{
        title = $description;
        value = $state;
        });


    $thisAttachment = @{
        fallback = $thisFallbackMessage;
        color = $colour;
        pretext = $pretext;
        fields = $fields;
    }

    $payload.attachments += $thisAttachment

    return $payload

}

function New-SlackNotification ($hook, $group)
{

    $message = New-SlackMessage -resourceGroup $group
    Invoke-Restmethod -Method POST -Body ($message | ConvertTo-Json -Depth 4) -Uri $hook

}

if ($reminderGroups -ne $null) {
    Write-Output "Sending a Slack notification about these groups"
    $reminderGroups
    foreach ($group in $reminderGroups) {

        New-SlackNotification -hook $slackHook -group $group


    }
}
else {
    Write-Output "There are no groups which need attention"
}
</code></pre>

<h2 id="configure-it-in-octopus">在Octopus中配置它</h2>

<p>现在进入有趣的部分，配置Octopus！</p>

<h2 id="pre-requisites">先决条件</h2>

<p>请确保您已经设置了这两个先决条件，以便开始工作:</p>

<ul>
<li>Octopus中的Azure服务主体设置。</li>
<li>使用您的备用挂钩URL配置的备用帐户。</li>
</ul>

<h2 id="setting-up-the-octopus-service-principal-account">设立八达通服务主账户</h2>

<p>我们首先需要确保Octopus配置了一个服务主体帐户来查看您的Azure订阅。请随时查看我们关于<a href="https://g.octopushq.com/AzureServicePrincipalAccount" rel="nofollow">创建Azure服务主帐户</a>的文档，了解如何执行该任务的更多信息。出于此帐户的目的，您需要确保该帐户至少拥有对套餐的<code>Reader</code>访问权限。</p>

<h2 id="setting-up-the-slack-notification-account">设置时差通知帐户</h2>

<p>请查看<a href="https://api.slack.com/" rel="nofollow"> slack文档</a>，了解如何创建新的slack集成并获取slack挂钩URL。一旦有了URL，就需要确保它在Octopus中被设置为项目变量。</p>

<h2 id="create-your-new-project">创建您的新项目</h2>

<p>在Octopus中创建您的新项目，我的项目名为<code>Cloud Cost</code>，然后定义这4个项目变量:</p>

<ul>
<li>SubscriptionId(类型:字符串)。可以通过运行<code>Get-AzureRmSubscription</code>从Azure PowerShell中检索的订阅ID。</li>
<li>DateRangeInDays(类型:整数)。该脚本采用当天的天数，并以此天数进行倒计数，以形成一个范围来检查使用成本。</li>
<li>DefaultNotifyCostLimit(类型:整数)。如果一个资源组没有用<code>NotifyCostLimit</code>标记，Octopus将默认为这个值。</li>
<li>SlackHook(类型:字符串)。您的slack hook的完整URL。</li>
</ul>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2018-03/saving-cloud-dollars/saving-cloud-dollars_variables.png" class="zoom" data-title=""><img src="../Images/b46165eea6d8c8dd041ff1c1debf8062.png" class="img-fluid center" alt="New Project Variables" data-original-src="https://i.octopus.com/blog/2018-03/saving-cloud-dollars/saving-cloud-dollars_variables.png"/>T2】</a></p>

<h2 id="create-a-new-step-azure-powershell-script">创建新步骤(Azure PowerShell脚本)</h2>

<p>使用<code>Run an Azure PowerShell Script</code>步骤模板创建一个名为<code>Get Azure subscription cost</code>的新步骤。将该帐户指定为您的服务主体帐户，该帐户有权访问您从中获取费用数据的订阅。将下面的完整脚本粘贴到您的脚本内容部分。省去第一步。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2018-03/saving-cloud-dollars/saving-cloud-dollars_process1.png" class="zoom" data-title=""><img src="../Images/42c3584eae030e7aa6412c1337f5849b.png" class="img-fluid center" alt="New Step" data-original-src="https://i.octopus.com/blog/2018-03/saving-cloud-dollars/saving-cloud-dollars_process1.png"/>T2】</a></p>

<pre><code class="language-powershell">write-output "Getting all cost items for this subscription in Azure"
write-output "Subscription ID: $SubscriptionId "

$now = get-Date

$startDate = $($now.Date.AddDays(-$DateRangeInDays))
$endDate = $($now.Date)

write-output "Start Date:  $startDate  "
write-output "end Date:  $endDate "

$SubConsumptionUsage = Get-AzureRmConsumptionUsageDetail -StartDate $startDate  -EndDate $endDate

write-output "Finding all of the resource group names which existed during this billing period."
$SubIdPrefix = "/subscriptions/" + $SubscriptionId
$RgIdPrefix = $SubIdPrefix + "/resourceGroups/"

$resourceGroupName = @()
$resourceGroups = @()

foreach ($line in $SubConsumptionUsage) {
    if ($line.InstanceId -ne $null ) {
        $thisRgName = $($line.InstanceId.ToLower()).Replace($RgIdPrefix.ToLower(),"")
        $toAdd = $thisRgName.Split("/")[0]
        $toAdd = $toAdd.ToString()
        $toAdd = $toAdd.ToLower()
        $toAdd = $toAdd.Trim()

        if ($resourceGroups.Name -notcontains $toAdd) {
            $resourceGroupName = [PSCustomObject]@{
            Name = $toAdd
            }
            $resourceGroups += $resourceGroupName
        }
    }
}

write-output "Found these Resource groups: "
$resourceGroups

Write-Output "Calculating the cost of each Resource Group, then flag ones that exceed NotifyCostLimit."
$currentResourceGroups = Get-AzureRmResourceGroup
$rgIndexId = 0

foreach ($rg in $resourceGroups) {

    #$thisRg = $null
    $RgIdPrefix = $SubIdPrefix + "/resourceGroups/" + $rg.Name
    $ThisRgCost = $null
    $SubConsumptionUsage | ? { if ( $_.InstanceId -ne $null) { $($_.InstanceId.ToLower()).StartsWith($RgIdPrefix.ToLower()) } } |  ForEach-Object { $ThisRgCost += $_.PretaxCost   }
    $toaddCost = [math]::Round($ThisRgCost,2)
    $resourceGroups[$rgIndexId] | Add-Member -MemberType NoteProperty -Name "Cost" -Value $toaddCost

    if ($currentResourceGroups.ResourceGroupName -contains $rg.Name) {

        $addingResourceGroup = Get-AzureRmResourceGroup -Name $($rg.Name)
        $resourceGroups[$rgIndexId] | Add-Member -MemberType NoteProperty -Name "NotifyCostLimit" -Value $($addingResourceGroup.tags.NotifyCostLimit)

    }

    $rgIndexId ++

}

Write-Output "Filtering the items whose cost is higher than the allowed limit."
$reminderGroups = $resourceGroups | ? {
    if ($_.NotifyCostLimit -ne $Null) {

        $_.Cost -ge $_.NotifyCostLimit

    }
    else {

        $_.Cost -ge $DefaultNotifyCostLimit

    }
}

function new-SlackMessage ( $resourceGroup ) {

    $orange = "#F9812A"
    $attachments = @{}
    $fieldNumber = 0
    $username = "Octopus Cost Reminder"
    $IconUrl = "https://octopus.com/images/company/Logo-Blue_140px_rgb.png"
    $payload = @{
        #channel = "General";
        username = $username;
        icon_url = $IconUrl;
        attachments = @(
        );
    }

    $state = "Current cost: $($resourceGroup.Cost)"
    $description = "ResourceGroup Name: $($resourceGroup.Name)"
    $colour = $orange

    if ($fieldNumber -eq 0){
        $pretext = "This Resource Group has spiked above expected cost"
    }
    else {
        $pretext = $null
    }

    $thisFallbackMessage = "$description has spiked above expected cost (Current Cost: $state)"

    $fields = @(
        @{
        title = $description;
        value = $state;
        });

    $thisAttachment = @{
        fallback = $thisFallbackMessage;
        color = $colour;
        pretext = $pretext;
        fields = $fields;
    }

    $payload.attachments += $thisAttachment

    return $payload

}

function New-SlackNotification ($hook, $group)
{

    $message = New-SlackMessage -resourceGroup $group
    Invoke-Restmethod -Method POST -Body ($message | ConvertTo-Json -Depth 4) -Uri $hook

}

if ($reminderGroups -ne $null) {
    Write-Output "Sending a Slack notification about these groups"
    $reminderGroups
    foreach ($group in $reminderGroups) {

        New-SlackNotification -hook $slackHook -group $group

    }
}
else {
    Write-Output "There are no groups which need attention"
}
</code></pre>

<h2 id="creating-your-new-release">创建您的新版本。</h2>

<p>保存您的新步骤并创建一个新版本！</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2018-03/saving-cloud-dollars/saving-cloud-dollars_createrelease.png" class="zoom" data-title=""><img src="../Images/7a451be8d8acc27101da0256c79073be.png" class="img-fluid center" alt="New Release" data-original-src="https://i.octopus.com/blog/2018-03/saving-cloud-dollars/saving-cloud-dollars_createrelease.png"/>T2】</a></p>

<h2 id="setup-a-deployment-schedule-optional">设置部署时间表(可选)</h2>

<p>或者，您可以将云成本项目设置为定期运行。一种可能是每月在某一天运行一次该任务。在您的新项目中，选择<span class="path">触发器➜添加触发器➜预定触发器</span>。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2018-03/saving-cloud-dollars/saving-cloud-dollars_schedule.png" class="zoom" data-title=""><img src="../Images/f49898844e28fd55cb88a22eae770b59.png" class="img-fluid center" alt="New Schedule" data-original-src="https://i.octopus.com/blog/2018-03/saving-cloud-dollars/saving-cloud-dollars_schedule.png"/>T2】</a></p>

<ul>
<li>在<strong>名称</strong>部分，提供一个名称来描述该计划，我选择使用“每月25日”</li>
<li>在<strong>触发时间表</strong>部分，我已经将它设置为每月<strong>天</strong>，并将这一天设置为每月的<strong>25日</strong>——开始时间为上午09:00。</li>
<li>在<strong>触发动作</strong>部分，您可以选择想要运行的版本。我已经选择部署这个项目的<strong>最新</strong>版本。</li>
<li>在<strong>源环境</strong>和<strong>目的环境</strong>下选择相同的环境。我已经选择了<strong>生产</strong>环境。</li>
</ul>

<p>这将导致在每月的25日重新部署源环境中的最新版本。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2018-03/saving-cloud-dollars/saving-cloud-dollars_schedule-settings.png" class="zoom" data-title=""><img src="../Images/4b1b581829055d892c9873d7ec8b6359.png" class="img-fluid center" alt="New Schedule settings" data-original-src="https://i.octopus.com/blog/2018-03/saving-cloud-dollars/saving-cloud-dollars_schedule-settings.png"/>T2】</a></p>

<p>保存您的新计划。</p>

<h2 id="deploying-your-new-release">部署您的新版本。</h2>

<p>现在让我们开始部署！</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2018-03/saving-cloud-dollars/saving-cloud-dollars_deploy.png" class="zoom" data-title=""><img src="../Images/a8d88d15d9b565f921a68c84e37484b7.png" class="img-fluid center" alt="Deploy Release" data-original-src="https://i.octopus.com/blog/2018-03/saving-cloud-dollars/saving-cloud-dollars_deploy.png"/>T2】</a></p>

<h2 id="troubleshooting">解决纷争</h2>

<p>如果您的脚本因为找不到<code>Get-AzureRmConsumptionUsageDetails</code>而无法运行，请确保您的Octopus服务器上安装了最新的AzureRM模块，并创建另一个名为<code>Octopus.Action.Azure.UseBundledAzurePowerShellModules</code>的Octopus变量，其值为<code>False</code>。有关您为什么会收到此错误的更多信息，请查看关于配置Azure PowerShell模块版本的文档</p>

<h2 id="finishing-up">收尾工作</h2>

<p>恭喜你！您已经成功地在Azure中部署了检查成本的项目！</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2018-03/saving-cloud-dollars/saving-cloud-dollars_deploy.png" class="zoom" data-title=""><img src="../Images/a8d88d15d9b565f921a68c84e37484b7.png" class="img-fluid center" alt="Now Deploy" data-original-src="https://i.octopus.com/blog/2018-03/saving-cloud-dollars/saving-cloud-dollars_deploy.png"/>T2】</a></p>

<p>让我们检查一下时差通知！</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2018-03/saving-cloud-dollars/saving-cloud-dollars_notification.png" class="zoom" data-title=""><img src="../Images/8d2fe425adbe84d00171b6b5508a9c8d.png" class="img-fluid center" alt="Now Deploy" data-original-src="https://i.octopus.com/blog/2018-03/saving-cloud-dollars/saving-cloud-dollars_notification.png"/>T2】</a></p>

                    
                    
</body>
</html>