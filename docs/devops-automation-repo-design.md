# 如何为 DevOps automation - Octopus Deploy 构建 Git 存储库

> 原文：<https://octopus.com/blog/devops-automation-repo-design>

[![How to structure your Git repository for DevOps automation](img/f18f273fd338df3b33634b4d00667cd2.png)](#)

作为一名操作人员，当您第一次开始使用自动化时，您可能会发现到处都有 Git 库。其中一些可能非常臃肿，包含一行程序、脚本、函数、模块和配置文件。其他回购可能因数月或数年未动的破裂 CI/CD 管道而变得陈旧。

存储库设计通常是事后才想到的，这是有充分理由的。当你不知道你到底在构建什么的时候，很难知道如何构建一个东西。它不一定要一团糟，也不一定要把未来几年的工作提前投入到今天无法做出的决定中。

作为许多“混乱”代码库的贡献者，我将与您分享在开始自动化之路时，什么对我所在的团队最有效，以及如何重构集中式存储库。

## 从简单开始，集中自动化

```
|-- docs/
|   |-- failover-database.md
|   |-- sre-local-setup.md
|-- scripts/
|   |-- windows/
|   |-- linux/
|   |-- load-balancer/
|   |-- networking/
|-- ansible/
|   |-- group_vars/
|   |-- roles/
|   |-- site.yml
|   |-- windows-patching.yml
|   |-- inventory.yml
|-- terraform/
|   |-- main.tf
|   |-- provider.tf
|   |-- variables.tf
|   |-- outputs.tf 
```

最初，创建一个中央存储库可能是最好的开始方式。这大致相当于一个单片应用程序，其中所有的东西都是紧密耦合的。临时脚本、编排自动化和基础设施作为代码文档都存在于同一个存储库中。以你的团队命名资源库，让它成为你的团队开发的所有代码的真实来源。

保持存储库布局简单。创建通用目录来分隔存储库中不同类型的自动化。例如，为临时脚本创建一个脚本目录，为 Terraform 配置文件创建另一个脚本目录，等等。添加额外的目录，用于定义打补丁等流程的自动化。在这个阶段，不要在目录的结构和命名上花太多心思。你现在的首要目标是让它尽可能简单易用。

当代码的执行仍然是手动的时，集中式设计效果最好，例如，代码配置、脚本和编排自动化等基础设施都是从命令行下载和运行的。

将集中式存储库设计与单一的应用程序进行比较，可能会让你觉得不应该使用它。但是，如果您的团队或组织不熟悉自动化或基础设施，一般来说，这是一个很好的起点。这是你最终会摆脱的东西，但我发现这比跳到一个更成熟的设计要好得多，它会增加复杂性、混乱，并降低你的采用率。

把所有东西都放在一个地方可以让事情变得简单。如何组织文件以及应该在哪里提交代码都很清楚。很容易跟踪更改，并且有一个单独的 [CI/CD 管道](https://octopus.com/devops/continuous-delivery/what-is-a-deployment-pipeline/)来排除故障。

## 什么时候重构存储库？

摩擦是识别约束的最佳方式，随着时间的推移，您的集中式存储库的代码库将开始变得繁重。当你转向[自动执行任务](https://octopus.com/devops/continuous-delivery/automate-everything)并停止手动运行一切时，就会发生这种情况。这时，集中式存储库开始让事情变得复杂。

集中式存储库的最大缺点是它包含的工作流的数量。有很多 T4 的工作需要自动化，而且不是所有的工作都在同一时间运行。

例如，假设您有一个用于生成审计报告的脚本，一个用于完成故障转移的 PowerShell 模块，以及用于构建基础架构的 Terraform 代码，所有这些都在一个 repo 中完成。瓶颈不在于单一回购，而在于工作流程。这三种不同的代码基础中的每一种都将在不同的时间发生变化和发展。

正是在这一点上，整个代码库的最新版本变得有问题。如果对审计脚本的更改混入了一些 Terraform 更改，可能会发生不好的事情。结果，开发变慢了，这正是你需要重新评估你的存储库设计的时候。

简而言之，有两个指标是时候重新设计了:

*   发展放缓。
*   移除代码的手动执行会增加风险。

一种解决方案是为每个单独的工作流创建一个存储库，虽然这是一个简单的解决方案，但不是最好的。

## 如何拆分存储库？

每样东西和每个人都有一个仓库！这通常是集中式存储库出现问题时的第一反应。然而，这也带来了一系列挑战。相反，我建议你跟随*改变*。

编写自动化是为了进行更改、报告更改或测试更改。当需要重构您的存储库时，从在系统中映射这些变化开始。使用这些数据将有助于你做出决定。

[价值流图](https://www.atlassian.com/continuous-delivery/principles/value-stream-mapping)是一种用于分析为客户带来成果所需的信息流、人流和物流的技术。通常以产品或服务的形式。这是一个起源于精益制造方法的概念，但在 DevOps 文献中也很普遍。

这种分析可以像你做的那样复杂，但要保持简单，坚持识别过程中的步骤，而不是浪费和效率。你的目标是可视化当前的过程，而不是优化它。

【T2 ![](img/1f51be29a4801a6270e8e6d2fc898c9e.png)

对于中央存储库中的每个不同流程，请完成此工作流练习。例如，假设您已经自动化了一个操作系统修补流程。代码位于中央存储库中，每月运行一次。您还可以在同一个存储库中将基础设施作为代码配置，但是它是按需运行的，没有时间表。这些过程中的每一个都有不同的工作流程，并且很适合分离到它们自己的存储库中。

创建更多的存储库是有帮助的，但是也会带来更多的复杂性。有权衡，你需要取得正确的平衡。为了组织代码而将代码转移到另一个存储库不会激励任何人。然而，如果移动代码意味着一项任务可以完全自动化，并且某人不必在凌晨 3:00 醒来修补服务器。那么绝对值得。

使用简单的工作流程工具，如 [draw.io](https://draw.io) 来起草工作流程。与您的团队分享工作流程以获得反馈。在您映射了流程之后，开始将该流程所需的所有代码转移到不同的存储库中。同样，只有当代码增加价值时，才解耦代码。

## 结论

从简单开始是开始你的[自动化之旅](https://octopus.com/devops/continuous-delivery/automate-everything)的最佳方式。通过使用包含所有自动化流程的集中存储库，避免过度设计。开发一慢下来，摩擦一增加就重构。使用价值流图来确定中央存储库中存在的工作流。将具有最高投资回报(ROI)的代码解耦到您的团队，并增加最大的价值。