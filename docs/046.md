# 为什么要考虑数据库部署自动化？-章鱼部署

> 原文：<https://octopus.com/blog/automated-database-deployments-series-kick-off>

[![Why consider database deployment automation?](img/7e739cdbe10b2505b89f980056ebaee4.png)](#)

这是关于数据库部署自动化系列文章的第一篇。

对我来说，数据库是任何部署中最伤脑筋的部分。部署代码的压力要小得多。如果有什么不对劲，代码可以回滚。当它进入生产阶段时，如果它是在开发、QA 和预生产中测试过的相同代码，应该不会有任何意外。

数据库没有那么灵活。假设数据库脚本中有一个错误，所有用户的名字都被删除了。没有一个好的方法来回滚。备份可以恢复，但是备份是在什么时候进行的，自备份以来系统中是否有任何用户？如果恢复备份，哪些数据将会丢失？

## 手动数据库部署的问题

在 Octopus Deploy 工作之前，我是美国一家大型金融机构贷款发放系统的首席开发人员。在任何时候，都有数亿美元的贷款在外逃。这些都是大额贷款，需要许多个人来处理。每个人可能会在贷款上花费 15 分钟到 1 小时不等的时间。财务人员可能会花半个小时输入客户的财务状况，而承销商可能会花一个小时研究客户，并在贷款上添加注释和条件。不用说，恢复数据库备份是最后的手段。告诉人们他们必须重新输入信息，这种情况只会发生很多次，然后他们才会想要找到我。

我们有自动化的代码部署，但是数据库增量脚本是由数据库开发人员在部署之前手工创建的。对他们来说，花上一两个工作日的时间来整理剧本是很平常的事情。手动创建也意味着很少会发生测试。当脚本在生产中运行时，它很可能是第一次运行。我们还使用了 Redgate 的 SQL Compare 等工具，并在可能的情况下对恢复的备份进行了测试，但这只能做这么多。

由于存在风险，部署只能在下班后进行，这意味着晚上或周末，但这确实意味着我们可以为回滚进行备份。除了进行部署的开发团队之外，我们还有一名在线 DBA 和操作人员。操作人员必须等待 DBA 运行所有脚本，这可能需要一秒钟或二十分钟才能完成。

时间安排上的风险和困难意味着我们只能每个季度部署一次主要版本，在此期间进行小的 bug 修复。在一个主要版本之后，我们通常会发布几个错误修复版本，通常是因为错过了一些模式更改。每季度部署一次意味着一次要做很多改变。变更的验证需要很长时间，通常每个版本都需要两三个小时。

数据库模式更改被遗漏，因为数据库没有真实的来源。索引可能存在于生产前，但不存在于 QA 中，那么哪种环境是正确的呢？那个索引是什么时候添加的？谁加的？更糟糕的是，数据库中有将近 6，000 个对象(大部分是 CRUD 存储过程)。数据库开发人员不得不求助于手动跟踪所有的更改。80%的时间是数据库开发人员进行更改，另外 20%是开发人员进行更改。如果数据库开发人员那天不在，我们试图记住通过电子邮件将更改发送给他们，但是想想您在上一个季度对代码所做的所有更改。你记得他们所有人吗？

简而言之，除了应用程序中最关键的部分，我们已经实现了所有的自动化。完全相同的代码在环境中移动时被测试了多次。为每个环境手动创建了唯一的数据库增量脚本。数据库模式没有真实的来源，数据库管理员正在拔头发，试图让一切保持运行。

总结一下我们面临的挑战:

*   环境都不一样。
*   为每个环境创建了自定义脚本。
*   数据库对象存在于一个环境中，而不存在于另一个环境中。
*   部署耗时数小时。
*   *Big bang* 多个 bug 修复版本的季度发布。
*   手动跟踪更改。

数据库变更控制是狂野的西部。

## 数据库部署自动化

有些东西必须放弃。数据库更改必须进入源代码控制，这些脚本需要打包并在部署期间自动运行。经过大量的讨论、研究和测试，我们找到了一个工具。工具本身并不重要。重要的是，我们自动化了数据库部署。

这种影响几乎立刻就能被察觉。

将数据库放在源代码控制中可以让我们看到什么时候有人做了更改。我们可以将它与故事联系起来，我们知道为什么要进行更改，我们设置它以便删除不在源代码控制中的更改。如果一个索引在 QA 中，但不在源代码控制中，我们就删除它。这有点苛刻，但它保证了数据库模式匹配源代码控制中的内容。

由于随机视图或存储过程丢失而导致的紧急修复几乎降到了零。我们在 Octopus Deploy 中设置了一个手动干预步骤，这允许我们在部署之前查看和批准数据库增量脚本。每个人真正喜欢手动干预步骤的地方是，如果 delta 脚本中出现意外的数据库更改，可以取消部署。这有助于每个人、开发人员、QA 和 DBA 信任这个过程。

对部署的信心开始增加。很快，我们每月进行一次部署。然后一周一次。一旦通过 QA 和业务所有者的验证，功能就可以交付给用户。可以报告一个 bug，一旦通过验证，修复程序就可以交给用户了。我们发布得如此频繁，以至于每次发布的更改数量都显著减少，部署时间从两到三个小时减少到五到二十分钟。

将这一切都放在 Octopus Deploy 中还有一个好处，那就是让数据库管理员和运营团队的夜晚和周末时光重新回来。现在，他们可以安排部署，并且只在出现问题时才需要上线。

## 博客系列

这篇文章是我带领您建立数据库生命周期管理(DLM)和数据库部署自动化的系列文章的第一篇。本系列的目标是为您提供一些使用各种数据库部署工具的真实示例。除此之外，我们将讨论一些你会遇到的常见陷阱。

* * *

数据库部署自动化系列文章: