# 征求意见-动态基础设施-八达通部署

> 原文：<https://octopus.com/blog/rfc-dynamic-infrastructure>

云提供商使供应新的基础设施变得容易。这意味着可以轻松启动环境来测试新功能或为客户进行演示。然而，保持你的 Octopus 目标同步可能是有挑战性的，因为这个基础设施来来去去。

Octopus 目前提供了一个[动态基础设施](https://octopus.com/docs/infrastructure/deployment-targets/dynamic-infrastructure)特性，允许您在部署过程中注册目标。我们给你必要的部件，你把它们粘在一起以满足你的要求。这包括定制脚本、处理输出变量和切换设置。

这种复杂性使它成为一个专家用例，需要多次尝试将所有东西按正确的顺序排列。对于许多用户来说，手动注册这些目标更容易。因为功能不清楚，有些人甚至不知道还有另一种方法。

我们想改变这一切。我们希望利用用户已经与他们的云提供商和 Octopus 交互的方式，创建一个感觉不显眼和直观的解决方案。

## 我们的解决方案

我们希望 Octopus 为您的部署找到并注册目标。我们已经分解出关键部分，使其全部工作。

### 标签驱动的目标发现

我们将在需要时发现目标，而不是直接在 Octopus 中注册部署目标。

您将对您的云资源应用标记来表示您的意图，Octopus 将在执行您的部署过程时发现并注册这些目标。

首先，您的资源将需要两个标签:`octopus-environment`和`octopus-role`来分别表示环境和角色。您还可以指定标签来限制项目、空间和租户的发现。

### 认证上下文

为了发现目标，Octopus 需要向合适的云提供商进行认证。您将能够使用 Octopus 变量提供这种上下文。例如，您将能够配置一个名为`Octopus.Azure.Account`的变量来引用 Azure 帐户以用于发现。默认情况下，我们将在发现过程中将身份验证上下文中的帐户链接到目标。

为此，我们喜欢使用变量，因为它们具有完善的作用域行为，可用于为每个适用的作用域配置不同的帐户。例如，您可以通过环境来确定范围，确保测试和生产环境使用不同的身份验证上下文。

### 目标生命周期

云的一个关键优势是，当您使用完新环境时，可以非常轻松地启动新环境并拆除它们。Octopus 将跟踪这些发现的目标，如果它们不再存在，就将它们清理掉。如果由于某种原因，他们回来了，Octopus 将重新发现他们，以便进行下一次部署。

## FAQ

### 我所有的云资源会成为 Octopus 中的目标吗？

不会。只有映射到内置步骤使用的 Octopus 目标的资源才会被发现。Octopus 还需要资源来设置标签`octopus-role`和`octopus-environment`。Octopus 会在发现过程中忽略任何没有这些标签的资源。

### 传统的处理部署目标的方式还有效吗？

现有的自定义脚本将继续工作，用于创建新目标的 PowerShell commandlets 将保持不变。迁移到这种新方法只会涉及:

*   在您的云资源上设置适当的标签
*   删除现有的脚本步骤
*   配置身份验证上下文变量

目标仍然可以手动注册。

### 如果找不到我的所有目标，它们会被自动删除吗？

只有通过此机制发现而创建的目标才会被自动删除。通过 UI 或现有 commandlets 创建的目标将像现在一样工作。

### 如果我需要使用不同的帐户进行部署和发现，该怎么办？

您可以通过设置其他标签来指定 Octopus 配置目标所需的额外细节。例如，要在部署到资源时使用不同的帐户，您可以指定`octopus-account`标记来引用 Octopus 中所需的帐户。

### 将支持哪些目标？

最初，我们将致力于支持 Azure Web 应用、服务架构和 AWS ECS 集群。然后，随着我们在未来一年扩大对更多云目标的支持，我们将确保他们为动态基础架构做好准备。

我们计划接下来支持在 AWS、Azure 和 Google Cloud 上发现 Kubernetes 容器。

### 是否支持 AWS 实例/假定角色？

Octopus 目前为 AWS 认证提供了广泛的选择。除了使用访问密钥和秘密密钥的帐户之外，我们还支持承担 IAM 角色并使用分配给 Worker 的角色。

我们仍在研究如何最好地支持这一点，并在依赖实例角色时平衡工人池依赖性。

## 我们需要您的反馈

我们正在积极开发这一功能，并希望采纳您的反馈。我们已经创建了一个 [Github 问题](https://github.com/OctopusDeploy/StepsFeedback/issues/8)来收集您的评论。

具体来说，我们想知道:

*   关于标记方面我们可能没有预料到的边缘情况
*   该解决方案适合您的使用情形吗？
*   你希望 Octopus 解决其他动态基础设施挑战吗？

这些反馈将有助于我们提供最佳解决方案。

[提供反馈](https://github.com/OctopusDeploy/StepsFeedback/issues/8)

## 结论

总之，我们改进动态基础设施的计划包括:

*   定义在云资源上使用的标签，以描述发现过程中的意图
*   通过具有众所周知的名称的变量提供认证上下文
*   在部署过程中注册目标
*   清理云中不再存在的旧目标

感谢阅读。我们希望您和我们一样对这项功能将释放的潜力感到兴奋。

非常感谢您的任何反馈。

愉快的部署！