<html>
<head>
<title>Using Google Cloud Secret Manager with Octopus - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>使用谷歌云秘密管理器与八达通-八达通部署</h1>
<blockquote>原文：<a href="https://octopus.com/blog/using-google-cloud-secret-manager-with-octopus#2021-11-11">https://octopus.com/blog/using-google-cloud-secret-manager-with-octopus#2021-11-11</a></blockquote>
                        <p>我以前写过关于使用step模板扩展Octopus的功能，以与<a href="https://octopus.com/blog/using-hashicorp-vault-with-octopus-deploy"> HashiCorp Vault </a>和<a href="https://octopus.com/blog/using-azure-key-vault-with-octopus"> Azure Key Vault </a>集成。我们致力于为我们的客户提供许多成功使用Octopus的方法，因此我们正在创建更多与其他secret managers集成的step模板。</p>

<p>在这篇文章中，我将介绍一个新的步骤模板，<a href="https://library.octopus.com/step-templates/9f5a9e3c-76b1-462f-972a-ae91d5deaa05/actiontemplate-gcp-secret-manager-retrieve-secrets" rel="nofollow"> GCP秘密管理器-获取秘密</a>。此步骤模板从Google云平台(GCP)上的Secret Manager中检索机密，以便在您的部署或操作手册中使用。</p>

<h2 id="getting-started">入门指南</h2>

<p>这篇文章假设读者对定制步骤模板和Octopus社区库比较熟悉。</p>

<p>此外，这篇文章没有详细介绍秘密管理器的概念或如何设置秘密管理器。你可以通过阅读谷歌的<a href="https://cloud.google.com/secret-manager/docs/quickstart" rel="nofollow"> Secret Manager快速入门指南</a>了解更多。</p>

<p>本文中的步骤模板使用GCP命令行工具<a href="https://cloud.google.com/sdk/gcloud" rel="nofollow"> gcloud </a>从<a href="https://cloud.google.com/secret-manager" rel="nofollow">秘密管理器</a>中检索秘密。必须在部署目标或工作者上安装gcloud工具版本<strong> 338.0.0 </strong>或更高版本，步骤才能成功检索机密。</p>

<p>这一步还需要Octopus <strong> 2021.2 </strong>或更新版本，因为它利用了我们最近添加的对<a href="https://octopus.com/blog/google-cloud-platform-integration">谷歌云平台</a>的内置支持。step模板已经在Windows和Linux上测试过(安装了PowerShell核心)。</p>

<h2 id="authentication">证明</h2>

<p>在您可以从Secret Manager中检索机密之前，您必须通过Google认证。在他们关于创建和访问机密的<a href="https://cloud.google.com/secret-manager/docs/creating-and-accessing-secrets" rel="nofollow">文档</a>中，Google描述了访问机密的角色:</p>

<blockquote class="blockquote">
<p>访问机密版本需要机密、项目、文件夹或组织的<strong>机密管理员机密访问者</strong>角色(<code>roles/secretmanager.secretAccessor</code>)。不能在秘密版本上授予IAM角色。</p>
</blockquote>

<p>要了解更多关于您可以在Secret Manager中使用的不同角色，请阅读关于如何提供访问敏感密码、证书和其他机密的权限的<a href="https://cloud.google.com/secret-manager/docs/access-control" class="alert-link" rel="nofollow">访问控制文档</a>。</p>


<p>在Octopus中，您可以使用我们在版本<strong> 2021.2 </strong>中添加的<a href="https://octopus.com/docs/infrastructure/accounts/google-cloud">谷歌云账户</a>与谷歌云平台进行认证</p>

<h2 id="retrieving-secrets">找回秘密</h2>

<p><a href="https://library.octopus.com/step-templates/9f5a9e3c-76b1-462f-972a-ae91d5deaa05/actiontemplate-gcp-secret-manager-retrieve-secrets" rel="nofollow"> GCP秘密管理器-检索秘密</a>步骤模板从秘密管理器中检索一个或多个秘密，并为每个检索到的秘密创建敏感的输出变量。</p>

<p>对于每个秘密，您必须提供一个要检索的秘密版本，并且可以选择提供一个自定义输出变量名。</p>

<p><strong>始终选择特定的机密版本</strong> <br/> Google建议，对于生产应用程序，您应该始终使用特定版本来检索机密，而不是使用<em>最新的</em>版本说明符。</p>


<p>检索一个秘密需要:</p>

<ul>
<li>一个允许访问机密的Google Cloud帐户，包括默认的<a href="https://g.octopushq.com/GCPDefaultProject" rel="nofollow">项目</a>、<a href="https://g.octopushq.com/GCPDefaultRegionAndZone" rel="nofollow">区域和区域</a>的详细信息</li>
<li>要检索的机密的名称</li>
</ul>

<p>step模板的一个高级特性支持一次检索多个机密。这需要在新的一行中输入每个秘密。</p>

<p>对于检索到的每个秘密，创建一个<a href="https://octopus.com/docs/projects/variables/output-variables#sensitive-output-variables">敏感输出变量</a>用于后续步骤。默认情况下，任务日志中只会显示已创建变量的数量。要查看任务日志中的变量名，将<strong>打印输出变量名</strong>参数更改为<code>True</code>。</p>

<h3 id="parameters">步骤模板参数</h3>

<p>步骤模板使用以下参数:</p>

<ul>
<li><p><strong> Google Cloud Account </strong>:一个<a href="https://octopus.com/docs/infrastructure/accounts/google-cloud"> Google Cloud account </a>，有权限访问Secret Manager的秘密。</p>
</li>
<li><p><strong> Google Cloud项目</strong>:指定默认项目。这将设置<code>CLOUDSDK_CORE_PROJECT</code>环境变量。</p>
</li>
<li><p><strong>谷歌云区域</strong>:指定默认区域。这将设置<code>CLOUDSDK_COMPUTE_REGION</code>环境变量。</p>
</li>
<li><p><strong> Google Cloud Zone </strong>:指定默认区域。这将设置<code>CLOUDSDK_COMPUTE_ZONE</code>环境变量。</p>
</li>
<li><p><strong>要检索的秘密名称</strong>:指定要从Google Cloud中的Secret Manager返回的秘密名称，格式:<code>SecretName SecretVersion | OutputVariableName</code>其中:</p>
<ul>
<li><code>SecretName</code>是要检索的机密的名称。</li>
<li><code>SecretVersion</code>是秘密检索的版本。<em>如果未指定该值，将检索最新版本</em>。</li>
<li><code>OutputVariableName</code>是<em>可选</em> Octopus <a href="https://octopus.com/docs/projects/variables/output-variables">输出变量</a>的名称，用于存储秘密值。<em>如果未指定该值，将动态生成一个输出名称</em>。</li>
</ul>
<p><strong>注意:</strong>通过在新的一行中输入每个字段，可以检索多个字段。</p>
</li>
<li><p><strong>打印输出变量名</strong>:将章鱼<a href="https://octopus.com/docs/projects/variables/output-variables">输出变量名</a>写入任务日志。默认:<code>False</code>。</p>
</li>
</ul>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-11/using-google-cloud-secret-manager-with-octopus/gcp-secret-manager-retrieve-secrets-step-parameters.png" class="zoom" data-title=""><img src="../Images/3e5b2426d88195bf8a8e76c4ec651281.png" class="img-fluid center" alt="Parameters for the step" data-original-src="https://i.octopus.com/blog/2021-11/using-google-cloud-secret-manager-with-octopus/gcp-secret-manager-retrieve-secrets-step-parameters.png"/>T2】</a></p>

<h3 id="using-the-step">使用步骤</h3>

<p><strong> GCP机密管理器-检索机密</strong>步骤以与其他步骤相同的方式添加到<a href="https://octopus.com/docs/projects/steps#adding-steps-to-your-deployment-processes">部署和运行手册流程中。</a></p>

<p>将步骤添加到流程后，填写步骤中的参数:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-11/using-google-cloud-secret-manager-with-octopus/gcp-secret-manager-retrieve-secrets-step-in-process.png" class="zoom" data-title=""><img src="../Images/67c9331b3efd1234fd647d54b2ab1a58.png" class="img-fluid center" alt="GCP Secret Manager - Retrieve Secrets step used in a process" data-original-src="https://i.octopus.com/blog/2021-11/using-google-cloud-secret-manager-with-octopus/gcp-secret-manager-retrieve-secrets-step-in-process.png"/>T2】</a></p>

<p>填写参数后，您可以在操作手册或部署流程中执行该步骤。成功执行后，任何匹配的机密都将被存储为敏感的输出变量。如果您将步骤配置为打印变量名，它们会出现在任务日志中:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-11/using-google-cloud-secret-manager-with-octopus/gcp-secret-manager-retrieve-secrets-step-output-variable.png" class="zoom" data-title=""><img src="../Images/c374e926ec8e4511484fa244de489180.png" class="img-fluid center" alt="GCP Secret Manager - Retrieve secrets step task log" data-original-src="https://i.octopus.com/blog/2021-11/using-google-cloud-secret-manager-with-octopus/gcp-secret-manager-retrieve-secrets-step-output-variable.png"/>T2】</a></p>

<p>在后续步骤中，从匹配密码创建的输出变量可以在您的部署或runbook中使用。</p>

<p><strong>提示:</strong>对于任何输出变量名，记得用您的步骤名替换<code>GCP Secret Manager - Retrieve Secrets</code>。</p>


<p>尽管不建议这样做，但还是有可能检索到秘密的最新版本。您可以从机密名称参数中省略版本，如下所示:</p>

<pre><code class="language-text">OctoSecrets-username | username-latest
</code></pre>

<p>或者，您可以使用<em>最新的</em>版本说明符，如下所示:</p>

<pre><code class="language-text">OctoSecrets-password latest | password-latest
</code></pre>

<p>在这两种情况下，步骤模板都会向任务日志发送警告:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-11/using-google-cloud-secret-manager-with-octopus/gcp-secret-manager-retrieve-secrets-step-latest-version-specifier-warning.png" class="zoom" data-title=""><img src="../Images/8a951d69967b4c931b0bf5411783cdef.png" class="img-fluid center" alt="GCP Secret Manager - Retrieve secret using latest version specifier warning" data-original-src="https://i.octopus.com/blog/2021-11/using-google-cloud-secret-manager-with-octopus/gcp-secret-manager-retrieve-secrets-step-latest-version-specifier-warning.png"/>T2】</a></p>

<h2 id="conclusion">结论</h2>

<p><strong> GCP秘密管理器-检索秘密</strong>步骤模板演示了与Google Cloud Secret Manager集成并利用Octopus部署或runbooks中存储的秘密是很容易的。</p>

<p>愉快的部署！</p>

                    
                    
</body>
</html>