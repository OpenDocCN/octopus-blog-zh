<html>
<head>
<title>Azure Virtual Machine Extension - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Azure虚拟机扩展- Octopus部署</h1>
<blockquote>原文：<a href="https://octopus.com/blog/new-azure-vm-extension#2021-07-07">https://octopus.com/blog/new-azure-vm-extension#2021-07-07</a></blockquote>
                        <p>回到2014年10月，我们非常兴奋地<a href="https://octopus.com/blog/azure-vm-extension">宣布【Azure的虚拟机扩展，它允许你安装触手代理，并将其连接到你的Octopus服务器。</a></p>

<p>然而，在软件的世界里(尤其是在云的世界里)，事情在继续发展。微软对Azure门户和使这些扩展可用的基础设施进行了重大更新——我们的扩展不再兼容，并已从门户中移除。</p>

<p>今天，我很高兴地宣布，我们已经从头开始重新编写了扩展，它现在可以供您愉快地使用。</p>

<h2 id="what-can-i-do-with-it">我能用它做什么？</h2>

<p>新的扩展允许你安装或卸载触手，以及在Azure虚拟机上更新触手的配置。</p>

<p>你可以通过<a href="https://octopus.com/docs/infrastructure/windows-targets/azure-virtual-machines/via-the-azure-portal"> Azure门户</a>、<a href="https://octopus.com/docs/infrastructure/windows-targets/azure-virtual-machines/via-powershell"> PowerShell </a>、<a href="https://octopus.com/docs/infrastructure/windows-targets/azure-virtual-machines/via-the-azure-cli"> Azure CLI </a>或<a href="https://octopus.com/docs/infrastructure/windows-targets/azure-virtual-machines/via-an-arm-template"> ARM模板</a>来实现。(有人告诉我，这甚至可以通过<a href="https://www.terraform.io/docs/providers/azurerm/r/virtual_machine_extension.html" rel="nofollow"> Terraform </a>实现，但这超出了本文的范围！)</p>

<h2 id="using-the-new-azure-portal">使用新的Azure门户</h2>

<p>在Azure门户中，选择您的虚拟机，点击<code>Extensions</code>并点击<code>+ Add</code>按钮。选择<code>Octopus Deploy Tentacle Agent</code>扩展，点击<code>Create</code>。按照要求填写字段，点击<code>OK</code>，扩展将被部署。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2017-04/azure-vm-extension.png" class="zoom" data-title=""><img src="../Images/3c6a0f817292f633c18492acac72f085.png" class="img-fluid center" alt="Azure Portal - Add Tentacle VM Extension" data-original-src="https://i.octopus.com/blog/2017-04/azure-vm-extension.png"/>T2】</a></p>

<h2 id="using-powershell-azure-resource-manager-arm-mode">使用PowerShell (Azure资源管理器(ARM)模式)</h2>

<pre><code class="language-powershell">$publicSettings = @{
  OctopusServerUrl = "https://octopus.example.com";
  Environments = @("Env1", "Env2");
  Roles = @("app-server", "web-server");
  CommunicationMode = "Listen";
  Port = 10933
}

$privateSettings = @{"ApiKey" = "&lt;MY SECRET API KEY&gt;"}

Set-AzureRmVMExtension -ResourceGroupName "resource-group-name" `
    -Location "Australia East" `
    -VMName "vm-name" `
    -Name "OctopusDeployWindowsTentacle" `
    -Publisher "OctopusDeploy.Tentacle" `
    -TypeHandlerVersion "2.0" `
    -Settings $publicSettings `
    -ProtectedSettings $privateSettings `
    -ExtensionType "OctopusDeployWindowsTentacle"
</code></pre>

<h2 id="using-an-arm-template">使用ARM模板</h2>

<p>您可以在创建虚拟机时部署扩展，或者更新扩展资源组以便以后应用扩展。</p>

<p>像往常一样创建您的ARM模板，并在您的<code>Microsoft.Compute/virtualMachine</code>资源下添加一个<code>resources</code>元素:</p>

<pre><code class="language-json">"resources": [
  {
    "type": "Microsoft.Compute/virtualMachines/extensions",
    "name": "[concat(parameters('vmName'),'/OctopusDeployWindowsTentacle')]",
    "apiVersion": "2015-05-01-preview",
    "location": "[resourceGroup().location]",
    "dependsOn": [
      "[concat('Microsoft.Compute/virtualMachines/', parameters('vmName'))]"
    ],
    "properties": {
      "publisher": "OctopusDeploy.Tentacle",
      "type": "OctopusDeployWindowsTentacle",
      "typeHandlerVersion": "2.0",
      "autoUpgradeMinorVersion": "true",
      "settings": {
        "OctopusServerUrl": "http://localhost:81",
        "Environments": [
          "Development",
          "Staging"
        ],
        "Roles": [
          "App Server",
          "Web Server"
        ],
        "CommunicationMode": "Listen",
        "Port": 10933
      },
      "protectedSettings": {
        "ApiKey": "API-ABCDEF1234567890ABCDEF12345"
      }
    },
    "dependsOn": [
      "[concat('Microsoft.Compute/virtualMachines/', parameters('vmName'))]"
    ]
  }
]
</code></pre>

<p>有关更多信息和示例，包括Azure服务管理(ASM)模式、Azure CLI等的说明，请<a href="https://octopus.com/docs/installation">查看我们的文档</a>。</p>

                    
                    
</body>
</html>