<html>
<head>
<title>Source control your Azure Bicep files - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>源代码控制你的Azure Bicep文件</h1>
<blockquote>原文：<a href="https://octopus.com/blog/source-control-azure-bicep-files#2022-07-04">https://octopus.com/blog/source-control-azure-bicep-files#2022-07-04</a></blockquote>
                        <p>最近，我写了关于使用Azure Bicep文件的<a href="https://www.octopus.com/blog/azure-bicep-octopus-deploy" rel="nofollow">，使用Octopus run book</a>部署你的Azure基础设施。</p>

<p>在这篇文章中，我解释了如何使用GitHub对Azure Bicep文件进行源代码控制，然后使用Octopus部署它们。</p>

<h2 id="why-source-control">为什么是源代码管理？</h2>

<p>源代码控制提供了单一的事实来源，无论是对您的应用程序代码还是您的基础设施代码(IaC)。</p>

<p>源代码管理还允许您与处理相同代码库的其他人协作，并合并他们的更改。它还可以帮助跟踪每个更改，因此如果有人犯了错误，您可以将时钟倒回到工作版本。</p>

<h2 id="get-your-bicep-files-from-github-to-octopus">将你的二头肌文件从GitHub下载到Octopus</h2>

<p>将Bicep文件存储在GitHub中，您可以使用GitHub操作将它们移动到Octopus Deploy实例，以自动化Azure资源的部署。</p>

<p>GitHub Actions于2019年推出，已成为DevOps专业人士和开源贡献者的热门工具。</p>

<p>在本文中，您将创建一个GitHub Actions工作流来将Bicep文件打包成一个ZIP文件。然后，将Bicep文件推送到Octopus实例，准备进行部署。</p>

<h3 id="octopus-connection">八达通连接</h3>

<p>首先，您需要设置GitHub Actions secrets，它将保存到Octopus实例的连接信息。</p>

<p>您需要:</p>

<ul>
<li>Octopus部署实例的URL</li>
<li>API密钥</li>
<li>您要将文件推送到的空间的名称</li>
</ul>

<p>在<strong>设置下创建3个秘密</strong>、<strong>秘密</strong>:</p>

<ul>
<li><code>OCTOPUSSERVERAPIKEY</code></li>
<li><code>OCTOPUSSERVERURL</code></li>
<li><code>OCTOPUSSERVER_SPACE</code></li>
</ul>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-q2/source-control-azure-bicep-files/githubsecrets.png" class="zoom" data-title=""><img src="../Images/da2b989bbc824e19e762defddb524e29.png" class="img-fluid center" alt="GitHub Secrets" data-original-src="https://i.octopus.com/blog/2022-q2/source-control-azure-bicep-files/githubsecrets.png"/>T2】</a></p>

<h3 id="creating-a-github-actions-workflow">创建GitHub操作工作流</h3>

<p>现在您需要创建GitHub操作工作流。</p>

<p>您的GitHub Actions工作流需要位于一个名为<strong>的文件夹下。github </strong>在你的库中，它必须使用YAML。</p>

<p>从描述工作流文件的作用开始，以便于参考和他人理解。然后，定义工作流的名称以及希望它运行的时间:</p>

<pre><code class="language-yml">
# This workflow takes the Bicep files within the Bicep folder and zips them together.  Then pushes/uploads them to the Octopus Instance specified. 
# In the repo's secrets are the information relating to the Octopus Instance URL, API key and Space. 
name: OctoPetShopBicepBuild
on:
  push:
    branches:
    - main
</code></pre>

<p>每次主分支上有推时，您的工作流都会运行。</p>

<p>接下来，您需要定义工作流的步骤:</p>

<pre><code class="language-yml"># A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "Bicep Build"
  BicepBuild:
    # The type of runner that the job will run on
    runs-on: windows-latest
    steps:
    # This first step takes the code within the Repo and pulls it into the workspace
    - uses: actions/checkout@v2
</code></pre>

<p>定义作业应该运行的工作程序或运行程序的类型。在这个例子中，我定义了最新的Windows runner。</p>

<p>工作流程的第一步是将存储库中的文件放入工作区。我使用了一个叫做checkout的市场行为来完成这个任务。</p>

<pre><code class="language-yml"> # We install the latest version of Octopus CLI
    - uses: OctopusDeploy/install-octopus-cli-action@v1.1.8
</code></pre>

<p>接下来，将Octopus CLI安装到您的runner上，以便您可以使用该CLI中的命令。默认情况下，跑步者没有安装命令。</p>

<pre><code class="language-yml"> # We take the files inside the Bicep folder and zip them together
    - name: Zip Bicep files
      run: octo pack --id="OctoBicepFiles" --format="zip" --version=${{ github.run_number }} --basePath=${{ github.workspace }}\Bicep\ --outFolder=${{ github.workspace }}\output
</code></pre>

<p>下一步是将文件放入存储库中的Bicep文件夹，并放入一个ZIP文件中。</p>

<pre><code class="language-yml"># We take the zip file we created and push them to the Octopus Deploy server instance
    - name: Push Bicep files
      run: octo push --package="${{ github.workspace }}\output\OctoBicepFiles.${{ github.run_number }}.zip" --server="${{ secrets.OCTOPUSSERVERURL }}" --apiKey="${{ secrets.OCTOPUSSERVERAPIKEY }}" --space="${{ secrets.OCTOPUSSERVER_SPACE }}"
</code></pre>

<p>此工作流的最后一步是推送步骤。这一步获取您创建的ZIP文件，并将其推送到您的Octopus实例中。您使用之前创建的秘密来连接到您的Octopus实例。</p>

<p>你可以在GitHub 上获得一份<a href="https://gist.github.com/weeyin83/fa134eec3cb7bd8c52fa25f2f323189c" rel="nofollow">完整工作流程的副本。</a></p>

<h2 id="conclusion">结论</h2>

<p>现在，您有了一个存储Bicep模块和基础设施部署代码的地方，以及一个将这些文件推送到Octopus实例以备部署的自动化过程。</p>

<p>如果您对此流程有任何问题或反馈，请在下面留下您的评论，我们非常希望收到您的回复。</p>

<p>阅读我们的<a href="https://octopus.com/blog/tag/Runbooks%20Series"> Runbooks系列</a>的其余部分。</p>

<p>愉快的部署！</p>

                    
                    
</body>
</html>