<html>
<head>
<title>SHA1 "Shattered" Collision - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>SHA1“粉碎”碰撞-章鱼部署</h1>
<blockquote>原文：<a href="https://octopus.com/blog/shattered#2022-07-05">https://octopus.com/blog/shattered#2022-07-05</a></blockquote>
                        <p><a href="#" data-featherlight="https://i.octopus.com/blog/2017-02/shattered-logo.png" class="zoom" data-title=""><img src="../Images/0369d5f66e5c1a4984c6b0b4dd78003b.png" class="img-fluid center" alt="SHA1ttered logo" data-original-src="https://i.octopus.com/blog/2017-02/shattered-logo.png"/>T2】</a></p>

<p>如果你最近一直关注科技新闻，你会看到<a href="https://security.googleblog.com/2017/02/announcing-first-sha1-collision.html" rel="nofollow">谷歌宣布</a>一项新的攻击，这使得<a href="http://shattered.io/" rel="nofollow">几乎有可能产生SHA1哈希冲突</a>。</p>

<p>风险似乎集中在证书用于数字签名而非加密的领域。到目前为止，我们还没有看到任何明确的报告表明这适用于SSL/TLS——我的理解是，存在有人制作假证书的风险，它可以像真证书一样被“信任”,但SSL/TLS数据不能被解密。当然，我不是专家！</p>

<p>无论哪种方式，SHA1已经过时一段时间了，证书颁发机构很久以前就停止颁发SHA1证书了。这对SHA1来说只是又一个致命的打击。</p>

<p>在这篇文章中，我想解释这对Octopus意味着什么，并提供一些PowerShell脚本来查看您部署的应用程序是否受到影响。</p>

<h2 id="octopus-and-tentacle-currently-use-sha1">章鱼和触手目前使用SHA1</h2>

<p>当您安装Octopus和触手代理时，它们都会生成X.509证书，用于加密它们之间的连接(通过TLS)。当我们生成这些自签名证书时，<strong>我们使用SHA1 </strong>。这是我们在Windows API中调用的<a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa376039(v=vs.85).aspx" rel="nofollow">证书生成函数</a>的默认设置，我们从未想过要改变。</p>

<p>缓解措施:</p>

<ul>
<li>与此同时，如果你担心的话，有一个变通办法:你可以生成自己的证书，并告诉Octopus和触手使用它们。有关详细信息，请查看我们关于<a href="https://octopus.com/docs/security/octopus-tentacle-communication/custom-certificates-with-octopus-server-and-tentacle">如何使用章鱼和触手</a>自定义证书的文档页面。</li>
<li>很快 <br/>我们将发布一个更新，将算法改为SHA256。这将适用于新的安装，但对于旧的安装，您必须重新生成证书并更新所有机器之间的信任。</li>
<li><strong>稍后</strong>T3】我们会在Octopus中增加一些功能，自动重新生成Octopus服务器和所有触手上的证书，并为您全部更新。如果您有许多机器要管理，您可能需要等待。这还需要做更多的工作，但我们会在谷歌90天内公布技术细节之前，尽量腾出时间来完成这项工作。</li>
</ul>

<h2 id="other-things-you-should-check">你应该检查的其他事情</h2>

<p>你要检查SHA1是否在其他地方被使用。八达通用户的常见例子包括:</p>

<ul>
<li>如果您使用HTTPS，用于八达通网络前端的证书。通常这是人们自己提供的东西。</li>
<li>用于向第三方服务进行身份验证的证书，如Azure管理证书</li>
<li>用于为您部署的网站提供HTTPS的证书</li>
</ul>

<h2 id="detecting-sha1-certificates-with-powershell">使用PowerShell检测SHA1证书</h2>

<p>给定一个<code>X509Certificate2</code>对象，这里有一个PowerShell函数检查它是否使用SHA1:</p>

<pre><code class="language-powershell">function Test-CertificateIsSha1{
    [cmdletbinding()]
    param(  
    [Parameter(
        Position=0, 
        Mandatory=$true, 
        ValueFromPipeline=$true)
    ]
    [System.Security.Cryptography.X509Certificates.X509Certificate2[]]$Certificate
    ) 

    process 
    {
       foreach($cert in $Certificate)
       {
           $algorithm = $cert.SignatureAlgorithm.FriendlyName
           $isSha1 = $algorithm.Contains("sha1")
           Write-Output $isSha1
       }
    }
}
</code></pre>

<p>这里有一个PowerShell脚本，您可以使用它来检查网站是否正在使用SHA1证书。Jason Stangroome在<a href="https://gist.github.com/jstangroome/5945820" rel="nofollow"> Get-RemoteSSLCertificate </a>的初步实施中表现出色:</p>

<pre><code class="language-powershell">function Get-RemoteSSLCertificate {
    [CmdletBinding()]
    param (
        [Parameter(Position=0, Mandatory=$true, ValueFromPipeline=$true)]
        [System.Uri[]]
        $URI
    )
    process 
    {
       foreach ($u in $URI)
       {
            $Certificate = $null
            $TcpClient = New-Object -TypeName System.Net.Sockets.TcpClient
            try {
                $TcpClient.Connect($u.Host, $u.Port)
                $TcpStream = $TcpClient.GetStream()
                $Callback = { param($sender, $cert, $chain, $errors) return $true }
                $SslStream = New-Object -TypeName System.Net.Security.SslStream -ArgumentList @($TcpStream, $true, $Callback)
                try {
                    $SslStream.AuthenticateAsClient('')
                    $Certificate = $SslStream.RemoteCertificate
                } finally {
                    $SslStream.Dispose()
                }
            } finally {
                $TcpClient.Dispose()
            }
            if ($Certificate) {
                if ($Certificate -isnot [System.Security.Cryptography.X509Certificates.X509Certificate2]) {
                    $Certificate = New-Object -TypeName System.Security.Cryptography.X509Certificates.X509Certificate2 -ArgumentList $Certificate
                }

                Write-Output $Certificate
            }
        }
    }
}

$sites = @("https://www.yoursite.com", "https://anothersite.com")
$sites | ForEach-Object {
    $site = $_
    $cert = Get-RemoteSSLCertificate -Uri $site
    if (Test-CertificateIsSha1 -Certificate $cert) {
        Write-Warning "Site: $site uses SHA1"
    }
}
</code></pre>

<p>这里有一个脚本检查您的IIS服务器是否正在使用任何SHA1证书:</p>

<pre><code class="language-powershell">Import-Module WebAdministration

foreach ($site in Get-ChildItem IIS:\Sites)
{
    foreach ($binding in $site.bindings.Collection)
    {
        if ($binding.protocol -eq "https") 
        {
            $hash = $binding.CertificateHash
            $store = $binding.certificateStoreName

            $certs = Get-ChildItem "Cert:\LocalMachine\$store\$hash"

            foreach ($cert in $certs) 
            {
                if (Test-CertificateIsSha1 -Certificate $cert) 
                {
                    Write-Warning "Site: $site.Name uses SHA1"
                }
            } 
        }
    }
}
</code></pre>

<p>您可以在所有机器上的<a href="https://octopus.com/docs/administration/script-console"> Octopus脚本控制台</a>中轻松运行:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2017-02/shattered-console.png" class="zoom" data-title=""><img src="../Images/9288c2bd6438f9059a644f1dfe035c5b.png" class="img-fluid center" alt="Running the IIS SHA1 binding detection in the Octopus script console" data-original-src="https://i.octopus.com/blog/2017-02/shattered-console.png"/>T2】</a></p>

<h2 id="certificates-feature-in-octopus">八达通的证书功能</h2>

<p>这是一个为Octopus 3.11中的<a href="https://octopus.com/blog/certificates-feature">新证书功能</a>欢呼的好时机。如果你无论如何都要更新你的网站证书，为什么不用Octopus来管理它们呢？</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/201702-certificate_list-BR7P.png" class="zoom" data-title=""><img src="../Images/912e0e2046e2cd9134d884e9d923d4bd.png" class="img-fluid center" alt="Certificates feature" data-original-src="https://i.octopus.com/blog/201702-certificate_list-BR7P.png"/>T2】</a></p>

<p>如需更新，请订阅我们的<a href="#newsletter">简讯</a>。</p>

                    
                    
</body>
</html>