<html>
<head>
<title>Authenticate to Azure with Golang - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>使用Golang - Octopus部署向Azure进行身份验证</h1>
<blockquote>原文：<a href="https://octopus.com/blog/authenticate-to-azure-with-golang#2021-08-12">https://octopus.com/blog/authenticate-to-azure-with-golang#2021-08-12</a></blockquote>
                        <p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-08/authenticate-to-azure-with-golang/go-auth-with-azure.png" class="zoom" data-title=""><img src="../Images/1f347276302ecb8704dde82b514ee3ee.png" class="img-fluid center" alt="Authenticate to Azure with Golang" data-original-src="https://i.octopus.com/blog/2020-08/authenticate-to-azure-with-golang/go-auth-with-azure.png"/>T2】</a></p>

<p>当你使用任何编程或自动化语言时，很可能你首先需要解决的事情之一就是<em>我如何从SDK认证到云平台？</em>根据您使用的SDK，该过程可能会有很大不同。</p>

<p>例如，PowerShell通过<code>Connect-AZAccount</code> cmdlet进行身份验证，而Python可以通过应用注册或使用Azure CLI配置文件进行身份验证。重点是，每种语言和SDK都不一样，那么<a href="https://golang.org/" rel="nofollow"> Golang (Go) </a>怎么样？如果你是当今世界的一名开发人员，你可能听说过Golang(Terraform、Docker和Kubernetes就是用它编写的)，它是当今工具领域中发展最快和最流行的语言之一。</p>

<p>在这篇博客文章中，你将采取实践的方法来学习如何向Azure认证以使用虚拟机客户端。</p>

<h2 id="prerequisites">先决条件</h2>

<p>要跟进这篇博文，您需要:</p>

<ol>
<li>对围棋的初级到中级理解。</li>
<li>Azure账户。如果你没有，你可以注册一个<a href="https://azure.microsoft.com/en-us/free/" rel="nofollow">免费30天试用</a>。</li>
<li>一个IDE或者脚本编辑器，比如<a href="https://www.jetbrains.com/go/" rel="nofollow"> GoLand </a>或者<a href="https://code.visualstudio.com/" rel="nofollow"> VS Code </a>。</li>
</ol>

<h2 id="which-packages-to-use">要使用哪些包</h2>

<p>Azure authentication with Go的第一步是找出程序中需要哪些库/包。出于本文的目的，除了标准的<code>os</code>和<code>fmt</code>包，还有两个Azure包。</p>

<ol>
<li>在你的桌面上创建一个目录，用VS代码打开它。</li>
<li>在目录中创建一个<code>main.go</code>文件。</li>
<li>添加以下代码来启动带有标准包的<code>main.go</code>文件，以及您需要连接到Azure并向其进行身份验证的包:</li>
</ol>

<pre><code class="language-go">package main

import (
    "fmt"
    "os"

    "github.com/Azure/azure-sdk-for-go/services/compute/mgmt/2020-06-01/compute"
    "github.com/Azure/go-autorest/autorest/azure/auth"
)
</code></pre>



<h2 id="the-azure-connection">Azure connection</h2>

<p>接下来，您将设置<code>AzureAuth</code>功能:</p>

<ol>
<li>在<code>main.go</code>文件中的<code>import</code>下，创建如下所示的新函数。该函数为<code>subscriptionID</code>使用了一个<code>os.Arg</code>，稍后您将在<code>main</code>函数中定义它，并使用<code>compute.VirtualMachinesClient</code>类型来使用Azure的身份验证方法:</li>
</ol>

<pre><code class="language-go">func AzureAuth(subscriptionID string) compute.VirtualMachinesClient {

}
</code></pre>

<ol start="2">
<li>创建新功能后，您可以使用来自本地环境的身份验证来设置Azure的客户端身份验证:</li>
</ol>

<pre><code class="language-go">vmClient := compute.NewVirtualMachinesClient(subscriptionID)
authorizer, err := auth.NewAuthorizerFromEnvironment()
</code></pre>

<h2 id="error-handling-and-authentication">错误处理和验证</h2>

<p>身份验证代码的最后一部分是错误处理和身份验证的混合体。<code>if</code>语句指定如果<code>nil</code>不为空，则打印出一个错误，否则让用户知道认证成功并启动VM客户机:</p>

<pre><code class="language-go">if err != nil {
        fmt.Println(err)
    } else {
        fmt.Println("Auth: Successful")
        vmClient.Authorizer = authorizer
    }

    return vmClient
</code></pre>

<h2 id="configure-the-main-function">配置主要功能</h2>

<p>接下来，我们将配置<code>main</code>功能。因为Go是一种基于过程的语言，所以您将使用<code>main</code>函数来调用<code>AzureAuth</code>函数。这样，函数就按顺序运行了。</p>

<p><code>main</code>函数是两行代码，实现了以下功能:</p>

<ul>
<li>指定运行时要传入的订阅ID的<code>os.Arg</code>。</li>
<li>调用<code>AzureAuth</code>函数。</li>
</ul>

<p>在<code>AzureAuth</code>函数上方添加以下代码，以指定它是一个<code>main</code>函数:</p>

<pre><code class="language-go">func main() {
    subscriptionID := os.Args[1]

    AzureAuth(subscriptionID)
}
</code></pre>

<p>编辑器中的代码现在应该是这样的:</p>

<pre><code class="language-go">package main

import (
    "fmt"
    "os"

    "github.com/Azure/azure-sdk-for-go/services/compute/mgmt/2020-06-01/compute"
    "github.com/Azure/go-autorest/autorest/azure/auth"
)

func main() {
    subscriptionID := os.Args[1]

    AzureAuth(subscriptionID)
}

func AzureAuth(subscriptionID string) compute.VirtualMachinesClient {
    vmClient := compute.NewVirtualMachinesClient(subscriptionID)

    authorizer, err := auth.NewAuthorizerFromEnvironment()
    if err != nil {
        fmt.Println(err)
    } else {
        fmt.Println("Auth: Successful")
        vmClient.Authorizer = authorizer
    }
    return vmClient
}
</code></pre>

<p>要运行该程序，您需要一个Azure订阅ID在运行时传入。运行以下代码行来运行程序:</p>

<pre><code class="language-go">go run main.go your_subscription_id
</code></pre>

<p>如果身份验证成功，您应该会看到类似如下的输出:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-08/authenticate-to-azure-with-golang/images/1.png" class="zoom" data-title=""><img src="../Images/7421944412ab50feaf172ce611c0c500.png" class="img-fluid center" alt="Terminal output showing authentication was successful" data-original-src="https://i.octopus.com/blog/2020-08/authenticate-to-azure-with-golang/images/1.png"/>T2】</a></p>

<p>恭喜你。您已成功通过Golang向Azure认证。</p>

<h2 id="conclusion">结论</h2>

<p>无论是在云中还是在内部，对任何平台进行身份验证都是重要的第一步。如果没有身份验证，如果您打算用它来连接平台，代码基本上是无用的。</p>

<p>在这篇博文中，你初步了解了如何使用Go for virtual machines认证Azure。</p>

                    
                    
</body>
</html>