# 在数据库部署自动化管道中使用专用脚本——Octopus Deploy

> 原文：<https://octopus.com/blog/automated-database-deployments-adhoc-scripts>

[![Octopus worker deploying an ad-hoc SQL script illustration](img/6d4da028279be7dabd60bf23daf92204.png)](#)

自动化数据库部署在连续交付方面实现了巨大飞跃。我无法相信自动化数据库部署解决了这么多问题。无论是添加新表、修改存储过程还是创建索引。不管是什么，我不再需要确定环境之间的差异。

尽管有这些优势，一个常见的场景不断出现；在数据库服务器上运行即席查询。我见过的最常见的用例是修复数据。通常，当用户做了意想不到的事情时，数据会处于一种奇怪的状态。在某些情况下，根本问题不会被修复(这种情况发生得不够频繁)，或者问题在一周左右的时间内不会被修复，但是数据需要立即修复。

当我过去遇到这种情况时，过程是:

1.  开发人员创建脚本来修复数据。
2.  他们将脚本发送给 DBA 或拥有更改数据所需权限的人。
3.  有权运行脚本的人。
4.  通知开发人员脚本已经运行。

这个过程有很多缺陷。在我职业生涯的某个阶段，我要么是开发人员，要么是运行脚本的人，这不是一个愉快的过程:

1.  运行脚本的人不是系统专家。大多数情况下，在运行脚本之前，只是粗略地浏览一下。
2.  拥有必要权限的人可能已经回家了，出去吃午饭了，或者正在开会。该脚本可能几个小时都不会运行。在某些情况下，必须立即修复数据。
3.  通知开发人员是一个手动过程，这意味着脚本可能已经运行，但通知尚未发送。
4.  大多数公司不给初级开发人员修改产品的权利。坦率地说，运行脚本的人还有其他更重要的职责。他们可能真的专注于某件事，被打断会打断他们的思路。
5.  如果请求是通过电子邮件或 slack 完成的，就不会进行审计，电子邮件是文档死亡的地方。

Octopus Deploy 不仅仅可以部署软件。增加了许多新功能，使 Octopus 部署了一个更完整的 DevOps 工具。在这篇文章中，我将带您完成一个自动运行即席查询的过程。

我使用 Octopus Deploy 的原因(除了我在这里工作的事实之外)是因为它可以为这个过程提供以下内容:

*   审计:Octopus Deploy 可以告诉您谁提出了请求，谁批准了请求，以及这一切是何时发生的。
*   工件:使用 Octopus Deploy 内置的工件功能，可以存储和捕获运行的确切脚本，但是，如果有人在文件共享之后更改了脚本，就无从得知了。
*   认可:在某些情况下，让另一双眼睛看剧本是很重要的。Octopus Deploy 可以设置为基于一组标准有条件地批准脚本。
*   自动化:不再需要手动发送电子邮件。不再需要手动发送确认。不再打开 SSMS 和运行脚本。
*   可重复:将在所有环境中使用相同的过程来运行脚本。

## 用例

为了这篇博文的目的。以下是使用案例:

*   作为一名开发人员，我需要运行一个特别的查询来添加一个索引，看看这是否能解决一个性能问题。如果是，那么将该索引添加到数据库定义中，并将其推送到所有环境中。
*   作为一名 DBA，我需要运行一个特殊查询来创建一个 SQL 登录。
*   作为一名支持工程师，我需要运行一个特别的查询来授予开发人员选择权限。
*   作为一名业务分析师，我需要为用户解决一个数据问题。

## 要求

考虑到用例，以下是流程的要求:

*   章鱼展开。
*   没有源代码管理。许多 DBA、支持工程师和业务分析师不熟悉源代码控制工具。
*   自动化。当脚本准备好时，它们应该在五分钟内运行，而不必填写表格或通知任何人。
*   对脚本的分析，如果脚本包含某些关键字，那么人应该在运行它之前检查脚本。
*   在任何环境下工作。我们希望鼓励人们在任何环境下运行这个。甚至是戴夫。

## 设置

### 触须

我们的[数据库部署文档](https://octopus.com/docs/deployment-examples/sql-server-databases)建议您在 Octopus Deploy 和数据库服务器之间的**跳转框**上安装触角。当使用集成安全性时，这些触角在有权处理部署的服务帐户下运行。这些触角将处理正常部署。

您有几个选项来设置临时流程和权限:

1.  继续使用部署触角，但赋予他们执行额外任务的提升权限。
2.  创建一组具有提升权限的新服务帐户，并为这些新服务帐户创建新的触角。
3.  选项 1 和选项 2 的组合。创建两条管道。一个用于数据修复，另一个用于其他更改。数据修复通过常规部署目标运行，但是其他更改通过一组新的部署目标运行，这些目标具有新的服务帐户。

### 生命周期

这个过程允许人们在生产中直接运行脚本。使用默认的开发生命周期来测试预生产到生产没有太大意义。创建新的生命周期，允许部署到任何环境。我称我的脚本生命周期为:

[![](img/16c694bfc458cf54241a6784a7c80ba5.png)](#)

您可以通过创建一个阶段并将所有环境添加到该阶段来实现这一点:

[![](img/e0cba84b1486a2f64861d099031f4200.png)](#)

## 项目和流程

对于这个过程，我创建了许多步骤模板。我不想把它们提交给社区图书馆，因为它们不够通用，但是你可以在我们的 [GitHub 示例库](https://github.com/OctopusSamples/AdHoc-SQLQueries)中找到它们。

### 摄取脚本

我将为这个用例编写一个数据库脚本:

*作为一名业务分析师，我需要为一名用户解决一个数据问题。*

我想到了几个问题:

1.  问:什么环境？答:生产。
2.  问:什么 SQL 服务器？答:127.0.0.1。
3.  问:SQL Server 上的什么数据库？答:RandomQuotes_Dev。
4.  问:谁在提交剧本？鲍勃·沃克。

好了，我们知道了答案，我们如何把这些从我们的大脑中释放到章鱼的大脑中呢？为此，我将使用一个名为元数据的 YAML 文件，其中包含所有这些信息:

```
---
DatabaseName: RandomQuotes_Dev
Server: 127.0.0.1
Environment: Dev
SubmittedBy: Bob.Walker@octopus.com
... 
```

下一个问题是如何将 YAML 文件和 SQL 脚本发送到 Octopus Deploy 来运行？为了使提交脚本的人尽可能容易，我将使用一个热文件夹。我编写了一个 PowerShell 脚本，它将:

1.  在常用文件夹中查找任何新目录。
2.  使用 Octo.exe 打包文件夹。
3.  将包推至 Octopus Deploy。
4.  创建新版本。
5.  使用 MetaData.yaml 文件确定要部署到哪个环境。
6.  将文件夹移动到已处理的位置，以便脚本不会再次运行。

我可以设置一个在服务器上运行的计划任务。但是这个任务没有真正的可视性。如果它开始失败，我不会知道它失败了，直到我 RDP 到服务器上。

我没有经历那个噩梦，而是在 Octopus Deploy 中建立了一个新项目，名为“即席查询构建数据库包”该过程只有一个步骤，即运行 PowerShell 脚本来构建数据库包。记下生命周期，它只运行在一个虚拟环境中，我称之为`SpinUp`:

【T2 ![](img/de730dce10e10d16b6bf0274a36d972e.png)

它有一个触发器，每五分钟创建一个新版本，并运行以下流程:

[![](img/1bb3444ec21a9ab26925a3f0f0929380.png)](#)

在事件中，我想扩展这个过程以支持其他类型的脚本，我将它作为一个步骤模板:

[![](img/b44feee099de33ed01dc6c475b429ac3.png)](#)

眼尖的读者会看到参数`Octopus`项目。这是运行脚本的项目。

### 运行脚本

为了满足上述要求，我希望该流程执行以下操作:

1.  将软件包下载到跳转框中。
2.  获取包中的所有文件，并将它们作为工件添加(如果需要审查的话)。
3.  对脚本执行一些基本的分析。如果任何脚本没有使用事务，或者使用关键字 *Drop* 或 *Delete* ，那么我想触发一个手动干预。
4.  需要手动干预时发出通知。我喜欢的工具是 slack。
5.  运行脚本。
6.  如果脚本失败，发送失败通知。
7.  如果脚本成功，发送成功通知。

【T2 ![](img/21af082d38f3903a2218a0d7de1d6bdb.png)

下载软件包的步骤非常简单。将软件包下载到服务器。不要运行任何配置转换。不要替换任何变量。只需部署软件包:

[![](img/b9adc6c19620feb5ec0b1a5a6ef36c3e.png)](#)

“从要检查的包中获取脚本”是一个步骤模板，它执行以下操作:

1.  读取 YAML 文件并设置输出参数。
2.  将包中的所有文件作为工件添加。
3.  对 SQL 文件执行一些基本的分析。
4.  如果分析失败，设置一个输出变量`ManualInterventionRequired`。

这都是在一个步骤模板中完成的。唯一需要的参数是下载包的步骤:

[![](img/9770ce48d6bd7a5e802430fce9310efa.png)](#)

Octopus Deploy 输出参数的格式可能很难记住。我知道我会输错一些东西，所以与其这样做，我使用变量。这样，如果我真的要改变什么，我只需要改变一个地方:

[![](img/9fb92c67dc0a86fe8c5ff50ca0ad3abf.png)](#)

当我通知某人时，我可以很容易地包含这些信息。另外，请注意，该步骤将基于`ManualInterventionRequired`输出变量运行:

【T2 ![](img/735ca8858b0c3ee4f56b8f6414a1444d.png)

人工干预也是如此。运行条件基于`ManualInterventionRequired`输出变量:

[![](img/151557971658668d5d256ba1d66c7308.png)](#)

运行 SQL 脚本步骤将遍历所有 SQL 文件并运行它们。同样，为了使它更容易，我使用了一个步骤模板。该流程使用了`invoke-sqlcmd`，它将捕获输出并添加任务历史:

[![](img/fdec0c46ae13e7db55df2c1416cc9cb6.png)](#)

假设一切顺利，成功通知可以发出:

[![](img/9fdef7fd5f81602aba64341ce37988e9.png)](#)

否则，失败通知可能会发出:

[![](img/cc3ee502dc606f6f3838a8ad46626612.png)](#)

## 流程演示

我准备了一个可以运行脚本:

[![](img/bc8cbade70174f9f0d8fd047a346ba1a.png)](#)

MetaData.yaml 文件将脚本设置为在 Dev:

[![](img/0be2fb2935f693b9d8cb727a4572ee00.png)](#)

剧本本身没什么特别的。我不打算用一个事务来表明流程会选择它并强制进行手动干预:

[![](img/8e76e6ebb3278d7dab49b5d883ecdc07.png)](#)

我已将该文件夹复制到常用文件夹中:

[![](img/546d708342a89a6ecae2f2fa0a6c466b.png)](#)

章鱼拿起那个文件夹:

[![](img/f2d334fcfbb11956de64f43b9feca648.png)](#)

我现在看到 demo 文件夹已经移动到 processed 文件夹中。我在上面贴了一个时间戳，这样我就能确切地知道那个文件夹是什么时候被处理的:

[![](img/4d1b82704b14051e7b7f52978f21d257.png)](#)

查看运行脚本的项目，我可以看到已经创建了一个新的版本，并且有一个手动干预正在等待我:

[![](img/750d937dae10d6ecb08fbf8fd6b4da2b.png)](#)

我可以检查松弛通道，并看到批准消息已发送:

[![](img/beb183209bf3845783b22753a9ce9c48.png)](#)

进入发布，我可以看到工件已经生成。如果我愿意，我可以下载它们并查看将要运行的确切脚本。当我查看审批详细信息时，我可以看到该消息与时差通知相同:

[![](img/a586ae33f0dd78e8ef84c21c398cbc5d.png)](#)

批准部署后，将运行脚本并捕获输出:

[![](img/888bc94b591274114632c57d238731dc.png)](#)

由于脚本成功运行，成功通知被发送到 slack:

[![](img/f19d84bcce15b5cf3e5f2fc7eb8e8ec2.png)](#)

## 常见问题解答

### 我如何阻止某人向开发环境提交脚本，但允许它用于生产 SQL Server？

使用集成安全性时，每个环境都要有一个触手。该触手只能访问其环境中的 SQL 服务器。使用 SQL 身份验证时，每个环境有单独的用户和密码。无论哪种情况，脚本都将失败，因为用来登录 SQL Server 的用户将无法登录。

### 如果我想让每个剧本在进入前期制作和制作阶段时都接受审查，该怎么办？

将手动干预步骤更改为始终运行。此外，将环境更改为生产前和生产环境。有条件批准是为了仅在满足某些条件时才要求批准。事实上，从一开始，我建议所有发送到前期制作和生产的脚本都要经过人工批准。当在流程中建立了信任后，就应该引入有条件的批准了。

### 这看起来有点过了。你不能在 Octopus Deploy 中使用提示变量吗？

绝对的！我有另一个项目来做这个。问题是，谁来提交这些脚本？他们应该有权利创建一个版本并投入生产吗？每个人都可以使用 Octopus Deploy 吗？对于我的用例，我的答案是否定的。我在这个过程中的主要目标是消除尽可能多的手动步骤。使用提示变量手动创建版本增加了太多的手动步骤。

## 结论

我第一个承认这个过程远非完美。这并不适用于每家公司。这篇文章的目的是提供一个流程的例子，你可以修改这个流程以用于你的公司。

下次再见，愉快的部署！

* * *

数据库部署自动化系列文章: