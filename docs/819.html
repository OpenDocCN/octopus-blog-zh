<html>
<head>
<title>WildFly S3 Domain Discovery - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>野火S3域名发现-章鱼部署</h1>
<blockquote>原文：<a href="https://octopus.com/blog/wildfly-s3-domain-discovery#2022-07-15">https://octopus.com/blog/wildfly-s3-domain-discovery#2022-07-15</a></blockquote>
                        <p>在云环境中配置WildFly域时，通常不可能依靠固定的IP地址或网络广播来发现资源。为AWS用户发现域控制器提供的一个解决方案是使用S3桶作为中央配置点。在这篇博文中，我们将看看如何在AWS中配置一个简单的WildFly域，使用S3桶来发现域控制器。</p>

<h2 id="aws-iam-user">AWS IAM用户</h2>

<p>首先，我们需要一个IAM用户，他有权限访问S3存储桶。WildFly将使用该用户的密钥来用域控制器的详细信息更新S3桶。</p>

<p>在这个例子中，我们将使用一个名为<code>wildfly-domain</code>的桶。为了授予对这个bucket的访问权，WildFly将使用其密钥的IAM用户具有以下安全策略。</p>

<pre><code class="language-json">{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "Stmt1496702015000",
            "Effect": "Allow",
            "Action": [
                "s3:*"
            ],
            "Resource": [
                "arn:aws:s3:::wildfly-domain",
                "arn:aws:s3:::wildfly-domain/*"
            ]
        }
    ]
}
</code></pre>

<p>有了这个策略，我们需要创建<a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_access-keys.html" rel="nofollow">访问键</a>。生成<code>Access key ID</code>和<code>Secret access key</code>时记下它们，因为AWS不会再向您显示秘密访问密钥。</p>

<h2 id="create-the-bucket">创建存储桶</h2>

<p>S3水桶本身没什么特别的。它不需要启用任何特殊特性，因此只需创建一个名为安全策略中引用的名称的bucket(在我们的例子中为<code>wildfly-domain</code>)。</p>

<h2 id="configuring-the-domain-controller">配置域控制器</h2>

<p>要配置域控制器以允许从属实例通过S3存储桶发现它并进行连接，需要很多步骤。</p>

<h3 id="add-a-slave-user">添加从属用户</h3>

<p>我们需要做的第一件事是在域控制器上创建一个用户，从属实例将使用它来连接到域控制器。这是通过<code>bin/add-user.sh</code>脚本完成的。用户:</p>

<ul>
<li>是一个<code>Management User</code></li>
<li>不属于任何团体</li>
<li>将用于一个AS流程连接到另一个AS流程</li>
</ul>

<p>创建名为<code>slave</code>的用户的输出如下所示。</p>

<pre><code>[ec2-user@ip-172-30-0-89 bin]$ ./add-user.sh

What type of user do you wish to add?
 a) Management User (mgmt-users.properties)
 b) Application User (application-users.properties)
(a):

Enter the details of the new user to add.
Using realm 'ManagementRealm' as discovered from the existing property files.
Username : slave
Password recommendations are listed below. To modify these restrictions edit the add-user.properties configuration file.
 - The password should be different from the username
 - The password should not be one of the following restricted values {root, admin, administrator}
 - The password should contain at least 8 characters, 1 alphabetic character(s), 1 digit(s), 1 non-alphanumeric symbol(s)
Password :
Re-enter Password :
What groups do you want this user to belong to? (Please enter a comma separated list, or leave blank for none)[  ]:
About to add user 'slave' for realm 'ManagementRealm'
Is this correct yes/no? yes
Added user 'slave' to file '/home/ec2-user/wildfly-11.0.0.Final/standalone/configuration/mgmt-users.properties'
Added user 'slave' to file '/home/ec2-user/wildfly-11.0.0.Final/domain/configuration/mgmt-users.properties'
Added user 'slave' with groups  to file '/home/ec2-user/wildfly-11.0.0.Final/standalone/configuration/mgmt-groups.properties'
Added user 'slave' with groups  to file '/home/ec2-user/wildfly-11.0.0.Final/domain/configuration/mgmt-groups.properties'
Is this new user going to be used for one AS process to connect to another AS process?
e.g. for a slave host controller connecting to the master or for a Remoting connection for server to server EJB calls.
yes/no? yes
To represent the user add the following to the server-identities definition &lt;secret value="UGFzc3dvcmQwMSE=" /&gt;
</code></pre>

<p>记下这条线</p>

<pre><code>To represent the user add the following to the server-identities definition &lt;secret value="UGFzc3dvcmQwMSE=" /&gt;
</code></pre>

<p>稍后我们将需要它来配置从属实例。</p>

<h3 id="configure-the-s3-bucket">配置S3存储桶</h3>

<p>在<code>domain/configuration/host-master.xml</code>文件中，用下面的代码替换<code>&lt;domain-controller&gt;</code>元素的默认内容。该配置指示域控制器在启动时将其详细信息保存在<code>wildfly-domain</code> S3桶中。</p>

<pre><code class="language-xml">&lt;domain-controller&gt;
  &lt;local&gt;
      &lt;discovery-options&gt;
          &lt;discovery-option name="s3-discovery" code="org.jboss.as.host.controller.discovery.S3Discovery" module="org.jboss.as.host-controller"&gt;
            &lt;property name="access-key" value="AKIAINKG7EYTNEPL2TBA"/&gt;
            &lt;property name="secret-access-key" value="yoursecretkeygoeshere"/&gt;
            &lt;property name="location" value="wildfly-domain"/&gt;
        &lt;/discovery-option&gt;
    &lt;/discovery-options&gt;
  &lt;/local&gt;
&lt;/domain-controller&gt;
</code></pre>

<h3 id="running-the-domain-controller">运行域控制器</h3>

<p>默认情况下，管理接口绑定到localhost，在这种情况下，域控制器将尽职尽责地将配置保存在S3存储桶中，指示它可以在127.0.0.1上访问，当从属服务器在另一个实例上运行时，这显然不是有用的信息。</p>

<p>要解决这个问题，域控制器必须将其管理端口绑定到外部接口。这里，我们用<code>-bmanagement=&lt;ip&gt;</code>参数启动了域控制器，它指示WildFly将管理端口绑定到外部NIC的IP地址。</p>

<p>我们还通过<code>--host-config</code>参数提供了主机配置文件的名称。</p>

<pre><code>[ec2-user@ip-172-30-0-89 bin]$ ./domain.sh --host-config=host-master.xml -bmanagement=172.30.0.89
</code></pre>

<h3 id="verifying-the-s3-configuration">验证S3配置</h3>

<p>一旦域控制器已经启动，你会发现新的文件创建在S3桶。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2017-11/s3-domain-config.png" class="zoom" data-title=""><img src="../Images/340298689e589f353070abf5e9df0f18.png" class="img-fluid center" alt="s3 domain config" data-original-src="https://i.octopus.com/blog/2017-11/s3-domain-config.png"/>T2】</a></p>

<h2 id="configuring-the-domain-slave">配置域从属服务器</h2>

<p>要配置从机，我们需要编辑<code>domain/configuration/host-slave.xml</code>文件。</p>

<p>用创建<code>slave</code>用户时由<code>add-users.sh</code>脚本生成的<code>&lt;secret&gt;</code>替换<code>&lt;server-identities&gt;</code>元素的内容。</p>

<pre><code>&lt;server-identities&gt;
  &lt;!-- Replace this with either a base64 password of your own, or use a vault with a vault expression --&gt;
  &lt;secret value="UGFzc3dvcmQwMSE=" /&gt;
&lt;/server-identities&gt;
</code></pre>

<p>然后用下面的代码替换<code>&lt;domain-controller&gt;</code>元素的内容。</p>

<pre><code class="language-xml">&lt;domain-controller&gt;
  &lt;remote security-realm="ManagementRealm" username="slave"&gt;
    &lt;discovery-options&gt;
        &lt;discovery-option name="s3-discovery" code="org.jboss.as.host.controller.discovery.S3Discovery" module="org.jboss.as.host-controller"&gt;
          &lt;property name="access-key" value="AKIAINKG7EYTNEPL2TBA"/&gt;
          &lt;property name="secret-access-key" value="yoursecretkeygoeshere"/&gt;
          &lt;property name="location" value="wildfly-domain"/&gt;
        &lt;/discovery-option&gt;
    &lt;/discovery-options&gt;
  &lt;/remote&gt;
&lt;/domain-controller&gt;
</code></pre>

<p>然后，可以使用命令启动从属实例</p>

<pre><code>./domain.sh --host-config host-slave.xml
</code></pre>

<h2 id="verifying-the-domain-in-the-management-console">在管理控制台中验证域</h2>

<p>当域控制器和从控制器都在运行时，我们可以使用管理控制台来查看域的详细信息。打开http://domaincontrollerip:9990。系统将提示您输入凭据。通常我们会为管理控制台创建一个专用用户，但是为了方便起见，我们可以只使用我们之前创建的<code>slave</code>用户。</p>

<p>在<code>Runtime</code>选项卡下，我们可以看到主主机和从主机确实按照预期连接。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2017-11/wildfly-domain-management.png" class="zoom" data-title=""><img src="../Images/ec1c0c6f2bb1e7be3c9b63d5cccfc713.png" class="img-fluid center" alt="wildfly domain management" data-original-src="https://i.octopus.com/blog/2017-11/wildfly-domain-management.png"/>T2】</a></p>

<h2 id="conclusion">结论</h2>

<p>使用S3桶作为配置的中心点是在AWS中配置WildFly域的一种简单、方便和可靠的方式。它消除了对固定IP地址的需求，并解决了AWS阻止网络广播的限制。</p>

<p>如果您对Java应用程序的自动化部署感兴趣，<a href="https://octopus.com/downloads">下载Octopus Deploy的试用版</a>，并查看我们的文档。</p>

                    
                    
</body>
</html>