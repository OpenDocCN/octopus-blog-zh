<html>
<head>
<title>Azure Bicep and Octopus Deploy - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>蓝色二头肌和章鱼部署-章鱼部署</h1>
<blockquote>原文：<a href="https://octopus.com/blog/azure-bicep-octopus-deploy#2022-07-04">https://octopus.com/blog/azure-bicep-octopus-deploy#2022-07-04</a></blockquote>
                        <p>2020年末，微软公布了他们的新项目，<a href="https://docs.microsoft.com/azure/azure-resource-manager/bicep/overview" rel="nofollow"> Bicep </a>，一种用于部署Azure资源的领域特定语言(DSL)。Bicep旨在简化创作体验，使其易于学习。它也是模块化和可重用的。</p>

<p>Bicep在IT界非常流行。你可以在官方的<a href="https://github.com/Azure/bicep" rel="nofollow"> Bicep GitHub空间</a>上找到博文、推文、会议和大量互动。从v.0.3开始，Bicep已经得到了微软支持计划的支持，并被认为可以投入生产。</p>

<p>在这篇文章中，我将介绍Bicep模板，并向您展示如何使用<a href="https://octopus.com/docs/runbooks">Octopus run book</a>来自动化它们的部署。</p>

<h2 id="getting-started-with-bicep-and-octopus">二头肌和章鱼入门</h2>

<h3 id="prerequisites">先决条件</h3>

<p>您需要以下工具来开始使用二头肌:</p>



<h3 id="creating-your-first-bicep-template">创建您的第一个二头肌模板</h3>

<p>微软提供了<a href="https://docs.microsoft.com/en-gb/learn/paths/fundamentals-bicep/" rel="nofollow"> Bicep微软学习路径</a>来帮助你入门。</p>

<p>在这篇文章中，我解释了如何创建一个基本的模板。这篇文章假设你有ARM模板或类似的经验。我介绍了Azure应用服务计划和Azure Linux Web应用的创建过程。</p>

<p>首先，在模板中，您需要声明您正在使用的参数和变量:</p>

<pre><code class="language-json">// Declare parameters
param sku string
param linuxFxVersion string = 'node|14-lts' // The runtime stack of web app
param location string
param resourceTags object = {
  Environment: 'Tutorial'
  Owner: 'Me'
} // Tags for all resources
param appServicePlanName string
param webSiteName string
</code></pre>

<p>您可以为这些参数声明静态条目，也可以将它们留空，然后在部署期间输入值。在本例中，您将一些声明为static，而将其他的留空，以便您可以在部署过程中传递信息。</p>

<p>接下来，定义您希望如何部署Azure应用服务计划:</p>

<pre><code class="language-json">// Deploying the Azure App Service Plan
resource appServicePlan 'Microsoft.Web/serverfarms@2021-02-01' = {
  name: appServicePlanName
  location: location
  tags: resourceTags
  properties: {
    reserved: true
  }
  sku: {
    name: sku
  }
  kind: 'linux'
}
</code></pre>

<p>我来给你分解一下:</p>

<ul>
<li>资源标识符(resource<code>appServicePlan</code>)——告诉Bicep创建一个名为<code>appServicePlan</code>的新资源。这个名称标识Bicep模板中的资源。这不是您将在Azure中创建的资源的名称。</li>
<li><code>Microsoft.Web/serverfarms@2021-02-01</code>——定义资源提供者<code>Microsoft.Web</code>，然后是资源类型<code>serverfarms</code>，最后是要使用的API版本<code>2021-02-01</code>。查看微软官方文档，看看是否有更新的API总是值得的。</li>
<li>名称——这是Azure资源的实际名称。</li>
<li>位置——这是您将要部署的Azure区域。</li>
<li>标记-标记你的资源有助于你合理地组织它们。</li>
<li>属性-您可以从这里开始根据自己的需求配置应用服务计划。在这里，您定义了SKU和种类(Linux或Windows)。</li>
</ul>

<p>接下来，您将部署Azure Web应用程序:</p>

<pre><code class="language-json">// Deploying the Azure Web App
resource appService 'Microsoft.Web/sites@2021-02-01' = {
  name: webSiteName
  location: location
  tags: resourceTags
  properties: {
    serverFarmId: appServicePlan.id
    siteConfig: {
      linuxFxVersion: linuxFxVersion
    }
  }
}
</code></pre>

<p>我来给你解释一下:</p>

<ul>
<li>资源标识符(resource<code>appService</code>)——告诉Bicep创建一个名为<code>appService</code>的新资源。这个名称标识Bicep模板中的资源。这不是您将在Azure中创建的资源的名称。</li>
<li><code>Microsoft.Web/sites@2021-02-01</code>——定义资源提供者<code>Microsoft.Web</code>，然后是资源类型<code>sites</code>，最后是要使用的API版本<code>2021-02-01</code>。查看微软官方文档，看看是否有更新的API总是值得的。</li>
<li>名称——这是Azure资源的实际名称。</li>
<li>位置——这是您将要部署的Azure区域。</li>
<li>标记-标记你的资源有助于逻辑地组织它们。</li>
<li>属性-这是您开始配置应用程序服务的地方。您定义了此web应用使用的应用服务计划以及您想要的Linux版本。您可以配置更多的设置，但在本例中我们保持简单。</li>
</ul>

<p>模板现在完成了。你可以在GitHub 上<a href="https://gist.github.com/weeyin83/7a9a20a5fc7e10e65561b4d5e6ed4019" rel="nofollow">看到完成的模板。</a></p>

<h3 id="preparing-your-bicep-template-for-use-in-octopus-deploy">准备在Octopus Deploy中使用的二头肌模板</h3>

<p>要在Octopus Runbook中运行您的二头肌模板文件，您首先需要使用Octopus CLI将其保存在ZIP文件中。</p>

<pre><code class="language-bash">octo pack --id="BicepTemplate" --format="zip" --version="1.0.0.0" --basePath="c:\Bicep\" --outFolder="c:\Bicep"
</code></pre>

<p>您可以通过门户将ZIP文件上传到Octopus库或再次使用Octopus CLI。</p>

<pre><code class="language-bash">octo push --package="c:\bicep\BicepTemplate.1.0.0.0.zip" --server="https://MyOctopusServer" --apiKey="API-MyApiKey"
</code></pre>

<h3 id="running-the-bicep-template-from-an-octopus-runbook">从Octopus Runbook运行二头肌模板</h3>

<p>有了Octopus中的Bicep ZIP文件，是时候自动化其部署了。</p>

<p>这篇文章假设你已经设置了一个Octopus环境，并且已经连接了你的Azure账户。</p>


<p>在一个新的或现有的项目中，点击左侧菜单中的<strong>变量</strong>。</p>

<p>您需要为部署定义变量。输入变量:</p>

<ul>
<li>资源组</li>
<li>网站名称</li>
<li>应用服务计划名称</li>
<li>位置</li>
<li>SKU应用服务计划</li>
</ul>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-q2/azure-bicep-octopus-deploy/variables.png" class="zoom" data-title=""><img src="../Images/fd9c16b98019b5215935f73098efd20c.png" class="img-fluid center" alt="Declared variables" data-original-src="https://i.octopus.com/blog/2022-q2/azure-bicep-octopus-deploy/variables.png"/>T2】</a></p>

<p>输入变量后，导航至<strong>操作</strong>并点击<strong>操作手册</strong>。</p>

<p>选择<strong>添加Runbook </strong>创建新的Runbook来部署您的二头肌模板。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-q2/azure-bicep-octopus-deploy/newrunbook.png" class="zoom" data-title=""><img src="../Images/fc7e6baf3362176dcf0e4060f5f5dd3d.png" class="img-fluid center" alt="Add a new Runbook" data-original-src="https://i.octopus.com/blog/2022-q2/azure-bicep-octopus-deploy/newrunbook.png"/>T2】</a></p>

<p>在该操作手册中，点击<strong>定义您的操作手册流程</strong>。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-q2/azure-bicep-octopus-deploy/definerunbook.png" class="zoom" data-title=""><img src="../Images/90681f91af5ae2a241e4c632021ffde9.png" class="img-fluid center" alt="Define the Runbook Process" data-original-src="https://i.octopus.com/blog/2022-q2/azure-bicep-octopus-deploy/definerunbook.png"/></a>T2】</p>

<p>添加的第一步是<strong>运行一个Azure脚本</strong>。这一步创建Azure资源组来保存您的资源。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-q2/azure-bicep-octopus-deploy/azurescriptstep.png" class="zoom" data-title=""><img src="../Images/3c477c09c9f90b47ca309f3ed624879a.png" class="img-fluid center" alt="Azure Run a Script Deployment Step" data-original-src="https://i.octopus.com/blog/2022-q2/azure-bicep-octopus-deploy/azurescriptstep.png"/>T2】</a></p>

<p>为该步骤命名以供参考。然后，输入您的Azure帐户的详细信息。</p>

<p>接下来，使用Azure CLI命令输入将创建您的资源组的脚本。</p>

<pre><code class="language-bash">az group create -l $OctopusParameters["Project.location"] -n $OctopusParameters["Project.ResourceGroupName"]
</code></pre>

<p>您正在使用在前面步骤中声明的一些变量。</p>

<p>现在你需要添加另一个<strong>运行Azure脚本</strong>的步骤。这将部署您的二头肌模板，因此要适当地命名它。然后，滚动到Azure部分，再次添加您的Azure帐户详细信息。</p>

<p>接下来，滚动到<strong>脚本</strong>部分，输入以下脚本:</p>

<pre><code class="language-powershell"># Tell the deployment to use the package we’ve associated and the file path
$filePath = $OctopusParameters["Octopus.Action.Package[BicepTemplate].ExtractedPath"]

# Change Directory to extracted package
cd $filePath

# Get current date and set the deployment name
$today=Get-Date -Format "dd-MM-yyyy"
$deploymentName="BicepDeploy"+"$today"

# Deploy Bicep template and pull in the variable information
New-AzResourceGroupDeployment -Name $deploymentName -ResourceGroupName $OctopusParameters["Project.ResourceGroupName"] -TemplateFile webapp.bicep  -sku $OctopusParameters["Project.sku"] -location $OctopusParameters["Project.location"] -appServicePlanName $OctopusParameters["Project.appServicePlanName"] -webSiteName $OctopusParameters["Project.webSiteName"]
</code></pre>

<p>如果你使用自己的<a href="https://octopus.com/docs/infrastructure/workers" class="alert-link"> Workers </a>，请检查你是否安装了Azure CLI、Azure PowerShell和Bicep。</p>


<p>上面的脚本使用了Bicep ZIP文件。输入部署名称，以便可以跟踪部署的历史。该脚本使用PowerShell命令部署模板文件，并拉入您在Octopus中声明的变量。</p>

<p>在脚本框的正下方，导航到<strong>引用的包</strong>部分，然后单击<strong>添加</strong>。用你的Bicep文件选择ZIP文件。</p>

<p>现在，您可以保存此部署流程并运行部署。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-q2/azure-bicep-octopus-deploy/successfulrunbook.png" class="zoom" data-title=""><img src="../Images/4288b9b1392fc628dba65e85d18e5ee7.png" class="img-fluid center" alt="Runbook Success" data-original-src="https://i.octopus.com/blog/2022-q2/azure-bicep-octopus-deploy/successfulrunbook.png"/>T2】</a></p>

<h2 id="conclusion">结论</h2>

<p>您可以通过为更复杂的部署创建<a href="https://docs.microsoft.com/azure/azure-resource-manager/bicep/modules" rel="nofollow">二头肌模块</a>来构建这个基本的二头肌部署。</p>

<p>如果您正在使用Bicep将资源部署到您的环境中，请在下面的评论中或通过我们的<a href="https://octopus.com/slack"> Slack社区</a>联系我们，如果您有任何问题，请告诉我。</p>

<p>阅读我们的<a href="https://octopus.com/blog/tag/Runbooks%20Series"> Runbooks系列</a>的其余部分。</p>

<p>愉快的部署！</p>

                    
                    
</body>
</html>