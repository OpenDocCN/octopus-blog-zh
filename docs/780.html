<html>
<head>
<title>Using a remote back-end with Terraform in Octopus Deploy - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>在Octopus Deploy - Octopus Deploy中使用带有Terraform的远程后端</h1>
<blockquote>原文：<a href="https://octopus.com/blog/using-remote-backend-with-terraform#2021-10-12">https://octopus.com/blog/using-remote-backend-with-terraform#2021-10-12</a></blockquote>
                        <p>Terraform允许你用代码定义基础设施。在这篇文章中，我演示了如何使用GitHub库作为Terraform模板的源，并确保它们是受版本控制的。我还解释了如何在Terraform自己的云产品中存储工作区状态。</p>

<h2 id="setting-the-terraform-version">设置地形版本</h2>

<p>在本地和通过Octopus从同一工作空间运行Terraform命令时要小心，因为不同版本的Terraform具有不兼容的状态格式。</p>

<p>如果您使用Terraform Cloud，您可以通过<strong> <span class="path">设置➜常规</span> </strong>指定您想要使用的Terraform的确切版本。</p>

<p>您可以使用<a href="https://github.com/tfutils/tfenv" rel="nofollow"> tfenv工具</a>来管理多个版本的Terraform。</p>

<p>您还可以通过指定<code>required_version</code>来限制可用于工作区的CLI版本。</p>

<pre><code>terraform {
  required_version = "= 0.13.5"
}
</code></pre>

<p>详见<a href="https://github.com/hashicorp/terraform/issues/23290" rel="nofollow">本期GitHub</a>。</p>

<h2 id="creating-a-new-workspace-in-terraform-cloud">在Terraform Cloud中创建新的工作空间</h2>

<p>首先，您需要在<a href="https://app.terraform.io/" rel="nofollow"> app.terraform.io </a>创建一个工作空间，作为您项目的后端。</p>

<p>如果您还没有帐户，请创建一个帐户。</p>

<p>在工作区向导中:</p>

<ul>
<li>选择<strong> CLI驱动的工作流程</strong> -因为Octopus的Terraform步骤是使用CLI执行的。</li>
<li>将右上角的Terraform版本改为Octopus自带的CLI版本(本文发稿时为0.11.15，或者查看GitHub 中的<a href="https://github.com/OctopusDeploy/Octopus.Dependencies.TerraformCLI/blob/master/build.cake#L32" rel="nofollow">)。您可以通过提供自定义Terraform CLI可执行文件的完整路径(通过<code>Octopus.Action.Terraform.CustomTerraformExecutable</code>变量)或通过在</a><a href="https://octopus.com/docs/projects/steps/execution-containers-for-workers">自定义Docker容器</a>中运行该步骤来使用不同版本的Terraform。</li>
</ul>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-08/using-remote-backend-with-terraform/terraform-version.png" class="zoom" data-title=""><img src="../Images/bec29c563646988fec628d11243f8838.png" class="img-fluid center" alt="Terraform Version Selector" data-original-src="https://i.octopus.com/blog/2021-08/using-remote-backend-with-terraform/terraform-version.png"/>T2】</a></p>

<h2 id="creating-an-external-feed">创建外部源</h2>

<p>接下来，您需要配置Octopus Deploy来使用您的GitHub存储库作为<a href="https://octopus.com/docs/packaging-applications/package-repositories/github-feeds">包提要</a>。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-08/using-remote-backend-with-terraform/octopus-external-feed.png" class="zoom" data-title=""><img src="../Images/251cef0a8b1d52658800fd86580c542a.png" class="img-fluid center" alt="Octopus GitHub Feed" data-original-src="https://i.octopus.com/blog/2021-08/using-remote-backend-with-terraform/octopus-external-feed.png"/>T2】</a></p>

<h2 id="github-repository">GitHub知识库</h2>

<p>在这篇文章中，我创建了一个<a href="https://github.com/OctopusDeploy/TerraformBackendSample" rel="nofollow">样本库</a>，你可以很容易地为你的项目创建这个样本库。</p>

<p>存储库中有四个文件。您可以用不同的方式构建这些文件；但是要确保您的项目和后端变量是作为单独的文件保存的。</p>

<p>记住，提要中只有带标签的提交才可用，所以要向您的存储库添加一个标签。</p>

<p><strong> 1。</strong><strong>main . TF</strong>——在这里指定全局Terraform选项，比如后端选项和想要使用的工作空间。</p>

<pre><code>terraform {
  backend "remote" {
    organization = "octopus-deploy"
    workspaces {
      name = "egorp-test-workspace"
    }
  }
}

variable "aws_access_key" {
  type = string
}

variable "aws_secret_key" {
  type = string
}

provider "aws" {
  region     = "us-east-1"
  access_key = var.aws_access_key
  secret_key = var.aws_secret_key
}
</code></pre>

<p><strong> 2。</strong><strong>buckets . TF</strong>——对于这个例子，创建一个空的S3 bucket。</p>

<pre><code>variable "bucket_name" {
  description = "the bucket name to use"
}

resource "aws_s3_bucket" "mybucket" {
  bucket = var.bucket_name
  force_destroy = true
  acl    = "private"
  tags = {
      Name        = var.bucket_name
      Environment = "Dev"
  }
  cors_rule {
    allowed_headers = ["*"]
    allowed_methods = ["GET","PUT","HEAD","DELETE","POST"]
    allowed_origins = ["*"]
    max_age_seconds = 3000
  }
}
</code></pre>

<p><strong> 3。</strong><strong>terra form . auto . TF vars</strong>-在这里存储其他文件中使用的变量。Octopus在使用文件之前会执行<a href="https://octopus.com/docs/projects/variables/variable-substitutions">变量替换</a>。</p>

<p>注意，这个文件必须有扩展名<code>.auto.tfvars</code>，否则远程后端不会使用它。</p>

<pre><code>bucket_name = "#{BucketName}"
aws_access_key = "#{AWS Account.AccessKey}"
aws_secret_key = "#{AWS Account.SecretKey}"
</code></pre>

<p><strong> 4。</strong> <strong> backend.tfvars </strong> -该文件被提供给<code>terraform init</code>命令的<code>-backend-config</code>参数。这允许您安全地存储敏感变量，而不是将这些值直接存储在存储库中。</p>

<pre><code>token = "#{TerrraformCloudRemoteToken}"
</code></pre>

<p>您的工作区现在应该如下所示:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-08/using-remote-backend-with-terraform/octopus-terraform-folder-structure.png" class="zoom" data-title=""><img src="../Images/cb479d0f572d9673b5022abb5abc8d37.png" class="img-fluid center" alt="Terraform Folder Structure" data-original-src="https://i.octopus.com/blog/2021-08/using-remote-backend-with-terraform/octopus-terraform-folder-structure.png"/>T2】</a></p>

<p>接下来，配置<strong>应用Terraform模板</strong>步骤，以使用我们的GitHub存储库并执行必要的变量替换，为您提供远程令牌和存储桶名称。</p>

<p>工作空间现在存储在Terraform Cloud中，因此您可以通过手动调用Terraform CLI来使用它，并将其作为Octopus Deploy中部署流程的一部分。</p>

<p>Terraform将跟踪<a href="https://www.terraform.io/docs/language/state/index.html" rel="nofollow">工作区状态</a>，并确保您的本地状态与真实的基础设施相匹配。</p>

<h2 id="adding-an-aws-account">添加AWS帐户</h2>

<p>导航至<strong> <span class="path">基础设施➜账户</span> </strong>，添加您的AWS账户密钥和密码。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-08/using-remote-backend-with-terraform/octopus-infrastructure-account.png" class="zoom" data-title=""><img src="../Images/245413d0cd6ad8e6d7c4eaf429e92dbc.png" class="img-fluid center" alt="Octopus Infrastructure Account" data-original-src="https://i.octopus.com/blog/2021-08/using-remote-backend-with-terraform/octopus-infrastructure-account.png"/>T2】</a></p>

<h2 id="adding-variables">添加变量</h2>

<p>现在导航到左边的<strong>变量</strong>，添加您在<code>.tfvars</code>文件中定义的两个变量:</p>

<ul>
<li><strong> AWS账户</strong>:选择<strong>值</strong>字段，<strong>将类型</strong>更改为<strong> AWS账户</strong>，然后选择您已经添加到<strong>基础设施</strong>选项卡的账户。</li>
<li><strong> BucketName </strong>:您的S3桶的期望名称(如果您点击<strong>打开编辑器</strong>并勾选<strong>提示输入值</strong>，该值将必须在每次运行runbook时手动输入)。</li>
<li><strong>TerrraformCloudRemoteToken</strong>:将类型更改为<strong> Sensitive </strong>，并为您的Terraform云工作空间粘贴机密令牌。</li>
</ul>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-08/using-remote-backend-with-terraform/octopus-project-variables.png" class="zoom" data-title=""><img src="../Images/2341c59794bd3827391465b8f8857d86.png" class="img-fluid center" alt="Octopus Project Variables" data-original-src="https://i.octopus.com/blog/2021-08/using-remote-backend-with-terraform/octopus-project-variables.png"/>T2】</a></p>

<h2 id="creating-a-runbook">创建操作手册</h2>

<p>基础设施活动通常被定义为<a href="https://octopus.com/docs/runbooks">运行手册</a>。这篇文章假设你熟悉在Octopus中创建<a href="https://octopus.com/docs/projects">项目</a>，所以我将跳过这一部分。</p>

<ol>
<li>为您的项目创建一个操作手册。我把我的叫做<code>Terraform Apply</code>。</li>
<li>在您的流程中添加一个<strong>应用Terraform模板</strong>步骤。</li>
</ol>

<p>这个步骤模板很大，所以我将介绍最少的组件来完成它。</p>

<h3 id="managed-accounts">托管账户</h3>

<ul>
<li><strong>启用AWS账户整合</strong>:选择<strong>是</strong>。</li>
<li><strong>使用AWS服务角色为EC2实例</strong>执行:选择<strong>否</strong>。</li>
<li><strong>选择账户变量</strong>:选择您在上一节创建的账户变量。</li>
<li><strong>区域</strong>:输入默认使用的AWS区域，在我的例子中是<code>us-east-1</code>。</li>
</ul>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-08/using-remote-backend-with-terraform/octopus-managed-accounts.png" class="zoom" data-title=""> T50 </a></p>

<h3 id="template-section">模板部分</h3>

<p>选择包中的<strong>文件作为模板源，填写如下:</strong></p>

<ul>
<li><strong>包提要</strong>:选择您在第一步中创建的GitHub提要。</li>
<li><strong>包ID </strong>:输入你的仓库地址，在我这里是<code>OctopusDeploy/TerraformBackendSample</code>。</li>
</ul>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-08/using-remote-backend-with-terraform/octopus-terraform-template-options.png" class="zoom" data-title=""><img src="../Images/52cce52eb26e90c600afa444f4d664cc.png" class="img-fluid center" alt="Octopus Terraform Template Options" data-original-src="https://i.octopus.com/blog/2021-08/using-remote-backend-with-terraform/octopus-terraform-template-options.png"/>T2】</a></p>

<p>其余的可以保留默认值。</p>

<h3 id="advanced-options">高级选项</h3>

<p>展开<strong>地形选项</strong>并指定以下内容:</p>

<ul>
<li><strong>自定义地形初始化参数</strong> : <code>-backend-config=backend.tfvars</code></li>
</ul>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-08/using-remote-backend-with-terraform/octopus-custom-terraform-init-params.png" class="zoom" data-title=""><img src="../Images/78b23d93bbe723a0df650bce85c179a7.png" class="img-fluid center" alt="Octopus Custom Terraform Init Parameters" data-original-src="https://i.octopus.com/blog/2021-08/using-remote-backend-with-terraform/octopus-custom-terraform-init-params.png"/>T2】</a></p>

<p>点击<strong>运行</strong>在您选择的环境中运行操作手册。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-08/using-remote-backend-with-terraform/octopus-successful-run.png" class="zoom" data-title=""><img src="../Images/0548cfbb2c7eb28aa3f3ed044fedc9e0.png" class="img-fluid center" alt="Successful Runbook Run" data-original-src="https://i.octopus.com/blog/2021-08/using-remote-backend-with-terraform/octopus-successful-run.png"/>T2】</a></p>

<p>您可以在Terraform步骤的日志中找到Terraform云运行的URL。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-08/using-remote-backend-with-terraform/terraform-cloud-url.png" class="zoom" data-title=""><img src="../Images/3392ece5edf537de5b96b7698ae9b9a9.png" class="img-fluid center" alt="Terraform Cloud URL" data-original-src="https://i.octopus.com/blog/2021-08/using-remote-backend-with-terraform/terraform-cloud-url.png"/>T2】</a></p>

<p>现在，您已经使用共享的远程后端完成了部署。您可以在同一个工作区进行协作，并允许Terraform自动管理基础设施的状态。</p>

<h2 id="conclusion">结论</h2>

<p>在这篇文章中，我演示了如何在Octopus Deploy中为您的Terraform工作区使用Terraform云后端。</p>

<p>愉快的部署！</p>

                    
                    
</body>
</html>