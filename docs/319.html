<html>
<head>
<title>Infrastructure as code in Azure with Octopus Deploy and Pulumi: Part one - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>使用Octopus Deploy和Pulumi将基础设施作为代码:第一部分——Octopus Deploy</h1>
<blockquote>原文：<a href="https://octopus.com/blog/iac-azure-octopus-pulumi-part-1#2021-08-12">https://octopus.com/blog/iac-azure-octopus-pulumi-part-1#2021-08-12</a></blockquote>
                        <p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-04/iac-azure-octopus-pulumi-part-1/blogimage-infrastructure-development-azure-pulumi-1.png" class="zoom" data-title=""><img src="../Images/5afc6725213591e187844b05a34cee96.png" class="img-fluid center" alt="Infrastructure as code in Azure with Octopus Deploy and Pulumi: Part one" data-original-src="https://i.octopus.com/blog/2021-04/iac-azure-octopus-pulumi-part-1/blogimage-infrastructure-development-azure-pulumi-1.png"/>T2】</a></p>

<p>Pulumi是一个基础设施代码解决方案，允许你用你已经熟悉的语言定义你的基础设施，比如Go、Python或JavaScript。</p>

<p>在这篇文章中，我将向您展示如何使用用Go (Golang)编写的Pulumi项目创建Azure资源组，以及如何使用Octopus Deploy部署它。</p>

<h2 id="prerequisites">先决条件</h2>

<p>要跟进这篇文章，你需要:</p>

<ul>
<li>一个<a href="https://www.github.com" rel="nofollow"> GitHub账号</a>。</li>
<li>至少一个Linux部署目标。</li>
<li>Azure订阅。</li>
<li>在Octopus中配置的Azure帐户。</li>
<li>一个免费的账户。</li>
</ul>

<h2 id="why-pulumi-and-octopus-deploy">为什么普鲁米和章鱼部署？</h2>

<p>Pulumi是一个多语言云开发平台，允许您使用编程语言(如Go、C#、Python、TypeScript、JavaScript、F#、VB)来构建云服务。无论您是想构建虚拟机、网络、无服务器实现，还是其他任何东西，Pulumi都可以提供帮助。</p>

<p>对于Pulumi支持的每种语言，都有一个SDK可以用来与不同的云服务进行交互。例如，您可以使用Azure SDK创建一个资源组。</p>

<p>使用Octopus Deploy，您可以使用community steps在Windows和Linux服务器上运行Pulumi项目。这应该涵盖您需要工作的任何环境。</p>

<h3 id="creating-a-pulumi-project">创建Pulumi项目</h3>

<ol>
<li><p>登录到Pulumi。</p>
</li>
<li><p>点击<strong> +新建项目</strong>。</p>
</li>
<li><p>选择<strong> Azure </strong>为云。</p>
</li>
<li><p>选择语言的<strong>转到</strong>，点击<strong>下一步</strong>。</p>
</li>
<li><p>添加项目的详细信息。您可以保留默认值，也可以添加自定义元数据。</p>
<ul>
<li><strong>项目名称</strong>:正在创建的项目的名称。</li>
<li><strong>项目描述</strong>:正在创建的项目的描述。</li>
<li><strong>栈</strong>:栈名(dev，prod等。).</li>
<li><strong>配置</strong>:对于配置，您会看到几种不同的类型可供使用:<ul>
<li>公共</li>
<li>美国政府</li>
<li>德国的</li>
<li>瓷器；（China）中国</li>
</ul>
</li>
</ul>
<p>对于一个开发环境，只要你没有任何规定，保持它<code>public</code>就可以了。完成后，点击<strong>创建项目</strong>。</p>
</li>
<li><p>如果您还没有在本地安装Pulumi，您应该现在安装它。你可以在Windows上使用<a href="https://chocolatey.org/" rel="nofollow"> Chocolatey </a>，或者在MacOs上使用<a href="https://brew.sh/" rel="nofollow"> Homebrew </a>。</p>
</li>
<li><p>为您的项目创建一个新目录，并将目录(<code>cd</code>)更改为新创建的项目目录。</p>
</li>
<li><p>接下来，将项目从Pulumi拉到您刚刚创建的目录中，运行以下命令，然后按照说明进行操作:</p>
</li>
</ol>

<p><code>pulumi new azure-go -s AdminTurnedDevOps/azure-go-new-resource-group/dev</code></p>

<ol start="9">
<li>从Pulumi中取出项目后，就该部署它了:</li>
</ol>

<p><code>pulumi up</code></p>

<h2 id="writing-code-with-pulumi">使用Pulumi编写代码</h2>

<p>现在您已经创建了Pulumi项目，并且它在您的本地机器上是可用的，您已经拥有了使用Go与Pulumi进行交互所需要的一切。</p>

<p>该项目包括:</p>

<ul>
<li>一个go.mod文件，它指定了所需的包。</li>
<li>指定项目和项目名称的YAML配置文件。</li>
<li>main.go文件，其中已经包含了go代码。</li>
</ul>

<p>对于每个Pulumi项目，默认情况下您会看到starter代码，它会向您显示使用了哪些SDK和软件包。</p>

<h3 id="azure-example">Azure示例</h3>

<p>让我们从头开始创建一些东西，而不是使用main.go文件中的默认代码。</p>

<p>首先要指定的是包名和导入。因为代码来自<code>main</code>，所以您使用的包也将是<code>main</code>。</p>

<p>从标准库中，<code>fmt</code>和<code>log</code>将用于打印输出到屏幕上。这两个Pulumi包分别用于Azure SDK和Pulumi SDK:</p>

<pre><code class="language-go">package main

import (
    "fmt"
    "log"

    "github.com/pulumi/pulumi-azure/sdk/v3/go/azure/core"
    "github.com/pulumi/pulumi/sdk/v2/go/pulumi"
)
</code></pre>

<p>接下来，创建包含三个参数的资源组函数:</p>

<ul>
<li>来自Pulumi的上下文</li>
<li>资源组名称</li>
<li>位置</li>
</ul>

<pre><code class="language-go">func newResourceGroup(ctx *pulumi.Context, resourceGroupName string, location string) {
    if ctx == nil {
        log.Println("Pulumi CTX is not working as expected... please check issues on the SDK: github.com/pulumi/pulumi/sdk/v2/go/pulumi")
    } else {
        pulumi.Run(func(ctx *pulumi.Context) error {
            resourceGroup, err := core.NewResourceGroup(ctx, resourceGroupName, &amp;core.ResourceGroupArgs{Location: pulumi.String(location)})
            if err != nil {
                log.Println(err)
            }

            fmt.Println(resourceGroup)
            return nil
        })
    }
</code></pre>

<p><code>if</code>语句检查<code>ctx</code>是否是<code>nil</code>，并允许我们查看SDK在上下文中是否有问题。</p>

<p><code>else</code>语句包括执行Pulumi程序主体的<code>Run()</code>函数。正如你在<a href="https://github.com/pulumi/pulumi/blob/master/sdk/go/pulumi/run.go" rel="nofollow"> GitHub </a>上的SDK中看到的，它需要一个匿名函数，特别是在上下文中传递。</p>

<p>代码的核心在<code>core.NewResourceGroup</code>中，它创建了资源组。您还可以添加一些错误处理:</p>

<pre><code class="language-go">func main() {
    resourceGroupName := "octopuspulumitest"
    location := "eastus"
    ctx := &amp;pulumi.Context{}

    newResourceGroup(ctx, resourceGroupName, location)

}
</code></pre>

<p><code>main</code>函数执行<code>newResourceGroup()</code>函数，并在运行时传入一些参数。还有一个Pulumi上下文的空初始化，因为这是<code>newResourceGroup()</code>中需要的参数之一。</p>

<p>完成的代码片段如下所示:</p>

<pre><code class="language-go">package main

import (
    "fmt"
    "log"

    "github.com/pulumi/pulumi-azure/sdk/v3/go/azure/core"
    "github.com/pulumi/pulumi/sdk/v2/go/pulumi"
)

func main() {
    resourceGroupName := "octopuspulumitest"
    location := "eastus"
    ctx := &amp;pulumi.Context{}

    newResourceGroup(ctx, resourceGroupName, location)

}

func newResourceGroup(ctx *pulumi.Context, resourceGroupName string, location string) {
    if ctx == nil {
        log.Println("Pulumi CTX is not working as expected... please check issues on the SDK: github.com/pulumi/pulumi/sdk/v2/go/pulumi")
    } else {
        pulumi.Run(func(ctx *pulumi.Context) error {
            resourceGroup, err := core.NewResourceGroup(ctx, resourceGroupName, &amp;core.ResourceGroupArgs{Location: pulumi.String(location)})
            if err != nil {
                log.Println(err)
            }

            fmt.Println(resourceGroup)
            return nil
        })
    }
}
</code></pre>

<h2 id="conclusion">结论</h2>

<p>最初配置Pulumi有多个步骤，但正如您所见，它非常强大。您可以使用您喜欢使用的编程语言，并在一个环境中创建您需要的基础设施或服务。</p>

<p>在我的下一篇<a href="/blog/iac-azure-octopus-pulumi-part-2">帖子</a>中，我将向您展示如何打包Go代码并使用Octopus Deploy部署它。</p>

<h2 id="watch-the-webinar">观看网络研讨会</h2>

<iframe src="https://www.youtube.com/embed/SA3-efF5PWk" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen="">VIDEO</iframe>

<p>我们定期举办网络研讨会。请参见第<a href="https://octopus.com/events">页的</a>网上研讨会，了解以往网上研讨会的档案以及即将举办的网上研讨会的详细信息。</p>

<p>愉快的部署！</p>

                    
                    
</body>
</html>