<html>
<head>
<title>Selenium series: Travis CI - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>硒系列:特拉维斯CI -章鱼部署</h1>
<blockquote>原文：<a href="https://octopus.com/blog/selenium/21-travis-ci/travis-ci#2021-07-07">https://octopus.com/blog/selenium/21-travis-ci/travis-ci#2021-07-07</a></blockquote>
                        <p>这篇文章是关于<a href="/blog/selenium/0-toc/webdriver-toc">创建Selenium WebDriver测试框架</a>的系列文章的一部分。</p>

<p>既然我们已经在一个公共的GitHub存储库中有了我们的代码，我们可以将它与Travis CI链接起来，以允许签入触发我们代码的构建和测试。</p>

<p>首先打开<a href="https://travis-ci.com/" rel="nofollow">https://travis-ci.com/</a>并点击<code>Sign in with GitHub</code>按钮。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2018-10/selenium/21-travis-ci/image1.png" class="zoom" data-title=""><img src="../Images/e12819e3b7699ae4568916f4782a64cd.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2018-10/selenium/21-travis-ci/image1.png"/>T2】</a></p>

<p>GitHub会要求你授权Travis CI。点击<code>Authorize travis-pro</code>按钮。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2018-10/selenium/21-travis-ci/image2.png" class="zoom" data-title=""><img src="../Images/2d5fed8bc951c2519563991d1c29c30e.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2018-10/selenium/21-travis-ci/image2.png"/>T2】</a></p>

<p>你需要重新输入你的GitHub密码，然后点击<code>Confirm password</code>按钮。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2018-10/selenium/21-travis-ci/image3.png" class="zoom" data-title=""><img src="../Images/8f1a7c37d2eea557d3fa5314f562a51e.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2018-10/selenium/21-travis-ci/image3.png"/>T2】</a></p>

<p>几秒钟后，您将被带到一个屏幕，在这里您可以激活GitHub集成。点击<code>Active</code>按钮。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2018-10/selenium/21-travis-ci/image4.png" class="zoom" data-title=""><img src="../Images/e9bf1a1d007506de91c7ade752743e9d.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2018-10/selenium/21-travis-ci/image4.png"/>T2】</a></p>

<p>选择<code>All repositories</code>选项，点击<code>Approve &amp; Install</code>按钮。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2018-10/selenium/21-travis-ci/image5.png" class="zoom" data-title=""><img src="../Images/a0c8440475beb16396dc81497bee97c1.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2018-10/selenium/21-travis-ci/image5.png"/>T2】</a></p>

<p>几秒钟后，您将看到之前创建的公共GitHub存储库。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2018-10/selenium/21-travis-ci/image6.png" class="zoom" data-title=""><img src="../Images/a88a60e18c7d0080727242f49648f5c8.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2018-10/selenium/21-travis-ci/image6.png"/>T2】</a></p>

<p>单击存储库，进入构建列表。这个列表将是空的，因为我们还没有将所需的配置文件添加到存储库中，以允许Travis CI构建它。然而，我们现在已经成功地将Travis CI和GitHub链接在一起，这意味着Travis CI将监控GitHub存储库的变化。这是创建持续集成管道的第一步。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2018-10/selenium/21-travis-ci/image7.png" class="zoom" data-title=""><img src="../Images/dec9f311cab4a78bbf4292c8d6227b63.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2018-10/selenium/21-travis-ci/image7.png"/>T2】</a></p>

<p>Travis CI和GitHub现在链接在一起了，Travis CI正在监控保存我们的Java应用程序的存储库的任何签入。签入将触发Travis CI构建我们的代码并运行我们的测试，但是为了让Travis CI知道如何构建我们的项目，我们需要向我们的存储库添加一个名为<code>.travis.yml</code>的特殊文件。</p>

<p><code>.travis.yml</code>文件是Travis CI在其监控的任何存储库中查找的配置文件。该文件包含Travis CI构建代码和运行测试所需的配置。</p>

<p>Travis CI在Linux或MacOS实例上执行构建。我们将使用Linux来进行构建，因为Linux有许多有用的工具，我们可以在测试中加以利用。</p>



<p>让我们来看看完整的<code>.travis.yml</code>档案:</p>

<pre><code class="language-yaml">sudo: required
dist: trusty
language: java
jdk:
- oraclejdk8
addons:
  firefox: "60.0"
before_install:
- sudo apt-get update
- sudo apt-get install dbus-x11
- export DISPLAY=:99.0
- sh -e /etc/init.d/xvfb start
- export CHROME_BIN=/usr/bin/google-chrome
- sudo apt-get install -y libappindicator1 fonts-liberation
- wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
- sudo dpkg -i google-chrome*.deb
- wget https://chromedriver.storage.googleapis.com/2.38/chromedriver_linux64.zip
- unzip chromedriver_linux64.zip
- sudo cp chromedriver /usr/bin
- wget https://github.com/mozilla/geckodriver/releases/download/v0.20.1/geckodriver-v0.20.1-linux64.tar.gz
- tar -xzf geckodriver-v0.20.1-linux64.tar.gz
- sudo cp geckodriver /usr/bin
</code></pre>

<p>现在让我们来分解这个文件。</p>

<p><code>sudo</code>选项用于指示构建是否应该在可以运行<code>sudo</code>命令的环境中进行。通过将该选项设置为<code>required</code>，我们已经表明我们需要能够运行<code>sudo</code>命令，这意味着Travis CI将在虚拟机内部运行该构建。如果我们将这个选项设置为<code>false</code>，Travis CI就会创建一个容器来运行构建。</p>

<p>容器比虚拟机快，但是因为我们需要在构建环境中安装一些额外的软件来支持运行WebDriver测试，所以我们必须使用虚拟机选项:</p>

<pre><code class="language-yaml">sudo: required
</code></pre>

<p><code>dist</code>选项配置我们的构建将运行的Ubuntu版本。Ubuntu版本有一些押韵的名字，比如“精确的穿山甲”和“可靠的塔尔”。<code>dist</code>选项接受这些版本的简写，这里我们已经表明我们希望使用可信的Tahr版本的Ubuntu(也称为版本14.04)。</p>

<pre><code class="language-yaml">dist: trusty
</code></pre>

<p><code>language</code>选项定义了存储库中代码的编程语言。我们用Java编写代码，所以我们将这个选项设置为<code>java</code>:</p>

<pre><code class="language-yaml">language: java
</code></pre>

<p><code>jdk</code>选项配置用于构建代码的JDK。您可以选择使用OpenJDK，它是Java的开源实现，或者使用Oracle JDK，它是Oracle提供的Java发行版。对于我们的代码来说，这两种选择都可以，但是我们将使用Oracle JDK。</p>



<pre><code class="language-yaml">jdk:
- oraclejdk8
</code></pre>

<p>Travis CI提供了许多常见的应用程序，这些应用程序可以通过<code>addons</code>选项包含在构建环境中，Firefox就是提供的应用程序之一。在这里，我们已经配置了要安装的Firefox 60:</p>

<pre><code class="language-yaml">addons:
  firefox: "60.0"
</code></pre>

<p><code>before_install</code>选项为我们提供了运行原始脚本命令的能力，以便在构建代码之前进一步定制我们的构建环境。该选项下的每个项目都作为单独的命令运行，很像脚本文件:</p>

<pre><code class="language-yaml">before_install:
</code></pre>

<p><code>apt-get</code>命令是在Ubuntu中安装包的方式。大多数Linux发行版都有庞大的软件库，可以用包管理器安装，Ubuntu也不例外。像这样用一个命令就能下载、安装和更新软件的能力是Linux如此受开发人员欢迎的原因之一。</p>

<p>在我们安装任何额外的软件包之前，我们使用<code>update</code>命令来刷新可用软件包的列表。这可确保我们在稍后调用<code>apt-get</code>时安装任何应用程序的最新版本:</p>

<pre><code class="language-yaml">- sudo apt-get update
</code></pre>

<p>当从Travis CI环境中运行Firefox时，许多类似于<code>(firefox:9067): GConf-WARNING **: Client failed to connect to the D-BUS daemon</code>的警告被添加到日志文件中。这些可以忽略，但是很烦。问题<a href="https://github.com/travis-ci/travis-ci/issues/8520" rel="nofollow">https://github.com/travis-ci/travis-ci/issues/8520,</a>中指出的解决方案是安装<code>dbus-x11</code>包:</p>

<pre><code class="language-yaml">- sudo apt-get install dbus-x11
</code></pre>

<p>接下来的两个命令配置并启动Xvfb。</p>

<p>在以前的帖子中，我们讨论了一些系统是如何无头的，这仅仅意味着它们没有连接监视器。Travis CI使用的构建环境就是一个无头环境的例子。</p>

<p>然而，在某些情况下，比如在web浏览器上运行自动化测试，拥有一个即使没有监视器也能运行桌面应用程序的环境是很有用的。Xvfb是X虚拟帧缓冲区的缩写，它允许这样的桌面应用程序在无头环境中运行。Xvfb在内存中创建一个虚拟监视器，桌面应用程序将自己“画”到这个虚拟监视器上。</p>

<p>Xvfb中的X来自名称X Window System，这是可以在Travis CI中运行的Linux版本所使用的窗口系统。</p>


<p>通过使用Xvfb，我们可以测试没有在headless环境中运行的本机支持的浏览器，或者运行像Chrome和Firefox这样的老版本浏览器，这些浏览器最近才获得本机headless支持。</p>

<p>导出<code>DISPLAY</code>环境变量将应用程序配置为将自己绘制到屏幕<code>99</code>，这是Xvfb默认提供的屏幕:</p>

<pre><code class="language-yaml">- export DISPLAY=:99.0
</code></pre>

<p>然后我们手动启动<code>xvbf</code>服务:</p>

<pre><code class="language-yaml">- sh -e /etc/init.d/xvfb start
</code></pre>

<p>导出<code>CHROME_BIN</code>环境变量可以确保Chrome二进制驱动程序可以在测试中定位并启动Chrome:</p>

<pre><code class="language-yaml">- export CHROME_BIN=/usr/bin/google-chrome
</code></pre>

<p>这两个命令安装Chrome所需的一些依赖项:</p>

<pre><code class="language-yaml">- sudo apt-get install -y libappindicator1 fonts-liberation
</code></pre>

<p>与Firefox不同，Chrome在Travis CI中不作为插件提供，所以我们必须自己手动安装。这里我们用wget(Linux下下载文件的工具)下载Ubuntu的Chrome包，用<code>dpkg</code>安装:</p>

<pre><code class="language-yaml">- wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
- sudo dpkg -i google-chrome*.deb
</code></pre>

<p>正如我们在本地将Chrome二进制驱动程序安装到<code>PATH</code>上的一个目录中一样，我们为Travis CI构建环境做了同样的事情。在这里，我们下载Chrome二进制驱动程序，将其解压缩，并将可执行文件复制到<code>/usr/bin</code>目录。<code>/usr/bin</code>目录已经在<code>PATH</code>上了，这意味着任何复制到那里的可执行文件都可供我们的代码运行:</p>

<pre><code class="language-yaml">- wget https://chromedriver.storage.googleapis.com/2.38/chromedriver_linux64.zip
- unzip chromedriver_linux64.zip
- sudo cp chromedriver /usr/bin
</code></pre>

<p>我们对Firefox二进制驱动程序做同样的事情:</p>

<pre><code class="language-yaml">- wget https://github.com/mozilla/geckodriver/releases/download/v0.20.1/geckodriver-v0.20.1-linux64.tar.gz
- tar -xzf geckodriver-v0.20.1-linux64.tar.gz
- sudo cp geckodriver /usr/bin
</code></pre>

<p>要创建<code>.travis.yml</code>文件，右击项目根文件夹并选择<span class="path">新➜文件</span>。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2018-10/selenium/21-travis-ci/image8.png" class="zoom" data-title=""><img src="../Images/c72e7ce0472803e0266683049614748d.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2018-10/selenium/21-travis-ci/image8.png"/>T2】</a></p>

<p>输入文件名并点击<code>OK</code>按钮。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2018-10/selenium/21-travis-ci/image9.png" class="zoom" data-title=""><img src="../Images/c37152b0a47e074ddd4ab11fbfe2438a.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2018-10/selenium/21-travis-ci/image9.png"/>T2】</a></p>

<p>填充<code>.travis.yml</code>文件并保存更改。</p>

<p>我们需要将变更推送到或者签入到远程存储库中。为此，右击项目根目录并选择<span class="path"> Git ➜提交目录</span>。</p>

<p>输入提交消息，点击<code>Commit</code>按钮旁边的下拉箭头，然后点击<code>Commit and Push</code>。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2018-10/selenium/21-travis-ci/image10.png" class="zoom" data-title=""><img src="../Images/4ae4405e09becf00b31cc7d0e8721b60.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2018-10/selenium/21-travis-ci/image10.png"/>T2】</a></p>

<p>点击<code>Push</code>按钮，将变更登记到远程存储库中。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2018-10/selenium/21-travis-ci/image11.png" class="zoom" data-title=""><img src="../Images/5c796a82231ea25ad4608ca4f4df7de9.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2018-10/selenium/21-travis-ci/image11.png"/>T2】</a></p>

<p>推送完成后，新文件将显示在GitHub存储库中。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2018-10/selenium/21-travis-ci/image12.png" class="zoom" data-title=""><img src="../Images/939be9986e3175cf6f36fb9776dab415.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2018-10/selenium/21-travis-ci/image12.png"/>T2】</a></p>

<p>更重要的是，Travis CI已经检测到了对GitHub存储库的推送，并使用了<code>.travis.yml</code>文件中的配置来构建项目。</p>

<p>Travis CI认识到我们的项目是使用Maven <a href="https://docs.travis-ci.com/user/languages/java/#Projects-Using-Maven" rel="nofollow">构建的，因为pom.xml文件</a>的存在。然后，它将通过运行以下命令自动安装Maven依赖项:</p>

<pre><code>mvn install -DskipTests=true -Dmaven.javadoc.skip=true -B -V
</code></pre>

<p>然后通过运行以下命令来运行测试:</p>

<pre><code>mvn test -B
</code></pre>

<p>这一切都是自动发生的，无需任何额外的配置。这意味着当我们的代码被签入GitHub时，Travis CI将获得代码的副本，并运行我们编写的所有测试。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2018-10/selenium/21-travis-ci/image13.png" class="zoom" data-title=""><img src="../Images/9a35d6bd3de73aa1cfe0cb58a266bba1.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2018-10/selenium/21-travis-ci/image13.png"/>T2】</a></p>

<p>然而有一个问题。如果我们查看日志文件的末尾，我们会看到一些测试失败了:</p>

<pre><code>Results :

Tests in error:

browserStackAndroidTest(academy.learnprogramming.FormTest): Invalid username or password (WARNING: The server did not provide any stacktrace information)(..)

browserStackEdgeTest(academy.learnprogramming.FormTest): Invalid username or password (WARNING: The server did not provide any stacktrace information)(..)

Tests run: 19, Failures: 0, Errors: 2, Skipped: 1
</code></pre>

<p>这些测试失败了，因为BrowserStack测试要求将用户名和密码存储在环境变量中。幸运的是，Travis CI提供了一种为构建定义环境变量的简单方法。</p>

<p>点击<code>More Options</code>菜单，选择<code>Settings</code>选项。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2018-10/selenium/21-travis-ci/image14.png" class="zoom" data-title=""><img src="../Images/a2de49aaf48acb52ede682e6b3efae48.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2018-10/selenium/21-travis-ci/image14.png"/>T2】</a></p>

<p>在环境变量下添加<code>BROWSERSTACK_USERNAME</code>和<code>BROWSERSTACK_KEY</code>的值。您可以禁用构建日志中的<code>Display value</code>，这意味着这些值将从Travis CI生成的日志中隐藏。这是防止秘密值泄露到日志文件中的一个有用的方法。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2018-10/selenium/21-travis-ci/image15.png" class="zoom" data-title=""><img src="../Images/ed9a20566de07532d29f3617608292f6.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2018-10/selenium/21-travis-ci/image15.png"/>T2】</a></p>

<p>单击左侧菜单中的build，然后单击<code>Restart build</code>。这将重新构建代码，但是这次使用新的环境变量。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2018-10/selenium/21-travis-ci/image16.png" class="zoom" data-title=""><img src="../Images/c9b2c6a2fe6dd3d9f4c0f720d1506b52.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2018-10/selenium/21-travis-ci/image16.png"/>T2】</a></p>

<p>这一次，构建和相关的测试成功完成。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2018-10/selenium/21-travis-ci/image17.png" class="zoom" data-title=""><img src="../Images/8a43b4bb5fb2796ec133d8ca924287de.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2018-10/selenium/21-travis-ci/image17.png"/>T2】</a></p>

<p>您可能会看到如下日志消息:</p>

<pre><code>GLib-GObject-CRITICAL **: g_object_ref: assertion 'object-&amp;gt;ref_count &amp;gt; 0' failed
</code></pre>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2018-10/selenium/21-travis-ci/image18.png" class="zoom" data-title=""><img src="../Images/05db2facb0ed69e50d836c2331db0f06.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2018-10/selenium/21-travis-ci/image18.png"/>T2】</a></p>

<p>这些可以忽略，因为它们不影响测试的结果。</p>

<p>我们现在已经成功地将代码签入到GitHub中托管的中央Git存储库中，Travis CI已经检测到新代码，并自动构建它并运行所有测试。这是持续集成的核心思想，这意味着每次新代码被检入时，它都会被我们的测试自动验证。</p>

<p>您可以在此查看同一项目<a href="https://travis-ci.org/OctopusDeploy/WebDriverTraining" rel="nofollow">的Travis CI构建。</a></p>

<p>这篇文章是关于<a href="/blog/selenium/0-toc/webdriver-toc">创建Selenium WebDriver测试框架</a>的系列文章的一部分。</p>

                    
                    
</body>
</html>