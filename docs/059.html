<html>
<head>
<title>Deploying containers to AWS Fargate - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>将容器部署到AWS Fargate - Octopus Deploy</h1>
<blockquote>原文：<a href="https://octopus.com/blog/aws-fargate#2022-01-13">https://octopus.com/blog/aws-fargate#2022-01-13</a></blockquote>
                        <p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-09/aws-fargate/fargate-octopus.png" class="zoom" data-title=""><img src="../Images/987293e707a03350b823d81995a2ad3a.png" class="img-fluid center" alt="Deploying containers to AWS Fargate" data-original-src="https://i.octopus.com/blog/2020-09/aws-fargate/fargate-octopus.png"/>T2】</a></p>

<p>亚马逊网络服务(AWS) Fargate 已经成为部署容器化应用的流行技术，而无需担心后端基础设施管理。我的团队经常被问到，你能用Octopus Deploy搭配AWS Fargate吗？答案是，可以！不仅可以使用Fargate，还可以使用AWS弹性容器注册中心(ECR)作为Octopus Deploy的外部提要。在本文中，我使用TeamCity、ECR、Octopus Deploy和弹性容器服务(ECS) Fargate演示了整个CI/CD管道。</p>

<h2 id="create-aws-resources">创建AWS资源</h2>

<p>对于这篇文章，我们需要在AWS中创建一些资源:</p>

<ul>
<li>资格证书</li>
<li>ECR回购</li>
<li>VPC</li>
<li>子网</li>
<li>安全组</li>
<li>ECS集群</li>
</ul>

<h3 id="create-the-aws-credentials">创建AWS凭据</h3>

<p>TeamCity和Octopus Deploy都需要凭证才能使用AWS服务。您需要做的第一件事是登录到<a href="https://aws.amazon.com/console/" rel="nofollow"> AWS管理控制台</a>，并使用身份和访问管理(IAM)创建一个帐户。创建帐户后，点击用户，然后点击<strong>安全凭证</strong>来创建一个<code>Access Key</code>。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-09/aws-fargate/aws-iam-user-access-key.png" class="zoom" data-title=""><img src="../Images/b5e79b771ddb98920ff3740ee6e2a0d8.png" class="img-fluid center" alt="AWS user access key" data-original-src="https://i.octopus.com/blog/2020-09/aws-fargate/aws-iam-user-access-key.png"/>T2】</a></p>

<p>创建访问密钥后，保存<code>Secret Key</code>，因为<em>值只会显示一次</em>。<code>Access Key</code>和<code>Secret Key</code>的组合用于向AWS认证。</p>

<p>除了Octopus将外部feed部署到ECR之外，可以将AWS IAM角色用于TeamCity和Octopus Deploy。因此，这篇文章使用了访问密钥/秘密密钥的方法。</p>


<h3 id="retrieve-the-aws-ecr-registry-information">检索AWS ECR注册表信息</h3>

<p>您创建的每一个容器都将在其特定区域的ECR repo中结束。回购URI由以下部分组成:</p>

<pre><code class="language-text">&lt;RegistryId&gt;.dkr.ecr.&lt;RegionName&gt;.amazonaws.com/&lt;RepoName&gt;
</code></pre>

<p><code>RegistryId</code>和<code>RegionName</code>将用于我们将在TeamCity中创建的连接，当我们标记我们的图像时，将使用整个URI。</p>

<p>要检索这些值，导航到AWS控制台中的<strong>弹性容器注册表</strong>。</p>

<p>在<strong>查找服务</strong>框中输入<code>ecr</code>会让你更快到达那里。</p>


<p>如果您没有任何ECR存储库，请点击<strong>开始</strong>按钮:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-09/aws-fargate/aws-ecr-get-started.png" class="zoom" data-title=""><img src="../Images/58eea240f778a8e00fe04d915fb9d1e2.png" class="img-fluid center" alt="ECR getting started" data-original-src="https://i.octopus.com/blog/2020-09/aws-fargate/aws-ecr-get-started.png"/>T2】</a></p>

<p>如果您有现有的ECR存储库，点击<strong>创建存储库</strong>按钮或复制现有存储库的URI:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-09/aws-fargate/aws-ecr-create-repo.png" class="zoom" data-title=""><img src="../Images/acedb60c9a62c944f419f85978e56f82.png" class="img-fluid center" alt="An existing ECR repo" data-original-src="https://i.octopus.com/blog/2020-09/aws-fargate/aws-ecr-create-repo.png"/>T2】</a></p>

<h3 id="create-or-use-an-existing-vpc">创建或使用现有的VPC</h3>

<p>Fargate不需要唯一的虚拟私有云(VPC)，因此不需要创建新的VPC；然而，使用现有的VPC就可以了。这篇文章假设你已经对AWS有了一些了解，并且知道如果需要的话如何创建VPC。</p>

<h3 id="create-or-use-existing-subnets">创建或使用现有子网</h3>

<p>除了VPC，Fargate不需要定义子网。就像VPC一样，法盖特可以使用现有的物品。同样，本文假设您已经知道如何根据需要创建子网。</p>

<h3 id="create-or-use-existing-security-groups">创建或使用现有的安全组</h3>

<p>您可能需要考虑创建新的安全组，因为您可能需要定义端口来访问您的容器，而这些端口对于其他AWS资源来说是不必要的。</p>

<p>Octo Pet Shop应用程序是一个. NET核心应用程序，其中web前端使用内置的Kestrel web服务器，该服务器使用默认端口<code>5000</code>。Octo宠物店前端配置为自动将HTTP流量重定向到HTTPS和端口<code>5001</code>。这两个端口没有被任何其他资源使用，所以我为Octo Pet Shop创建了一个新的安全组。</p>

<p>要创建新的安全组，导航到AWS控制台中的<strong> VPC </strong>服务，并单击左侧的<strong>安全组</strong>。如果您正在关注这篇文章，请为端口<code>5000</code>和<code>5001</code>创建两个入站规则。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-09/aws-fargate/aws-vpc-securitygroup.png" class="zoom" data-title=""><img src="../Images/d4d05544568db417bc6f8c753b42b745.png" class="img-fluid center" alt="AWS VPC Security Groups" data-original-src="https://i.octopus.com/blog/2020-09/aws-fargate/aws-vpc-securitygroup.png"/>T2】</a></p>

<h3 id="create-an-ecs-cluster">创建ECS群集</h3>

<p>我们需要的最后一个资源是一个ECS集群来托管我们的容器。</p>

<ol>
<li>在AWS控制台中导航到ECS。</li>
<li>选择<strong>创建集群</strong>。</li>
<li>在下一个屏幕上，选择<strong>仅联网</strong>模板。</li>
<li>点击<strong>下一步</strong>。</li>
<li>给你的集群命名，然后点击<strong>创建</strong>。</li>
</ol>

<p>这个过程非常快，所以最多需要一分钟就可以完成。</p>

<p>随着AWS资源的创建，我们可以继续构建了。</p>

<h2 id="define-our-teamcity-build">定义我们的团队建设</h2>

<p>在这篇文章中，我使用TeamCity作为构建服务器来构建Octo Pet Shop应用程序作为Docker容器，并将它们推送到AWS ECR。</p>

<h3 id="create-the-project-connection">创建项目连接</h3>

<p>为了将我们的容器映像推送到ECR，我们需要配置一个连接到AWS ECR的TeamCity项目。这是通过以下步骤实现的:</p>

<ol>
<li>点击<strong>项目</strong>。</li>
<li>选择要添加连接的项目。</li>
<li>点击<strong>编辑项目</strong>。</li>
</ol>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-09/aws-fargate/teamcity-edit-project.png" class="zoom" data-title="witdth=500"><img src="../Images/a87ccd08a42ea2da277b2c8745015dfe.png" class="img-fluid center" alt="TeamCity edit project button" title="witdth=500" data-original-src="https://i.octopus.com/blog/2020-09/aws-fargate/teamcity-edit-project.png"/>T2】</a></p>

<ol start="4">
<li>点击<strong>连接</strong>然后<strong>添加连接</strong>。</li>
<li>从下拉菜单中选择<code>Amazon ECR</code>，并填写以下值:</li>
</ol>

<ul>
<li>AWS区域</li>
<li>访问密钥ID</li>
<li>秘密访问密钥</li>
<li>注册表Id</li>
</ul>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-09/aws-fargate/teamcity-ecr-connection.png" class="zoom" data-title=""><img src="../Images/2707ecb51bb410af1e7eaea1de5dc607.png" class="img-fluid center" alt="TeamCity ECR connection settings" data-original-src="https://i.octopus.com/blog/2020-09/aws-fargate/teamcity-ecr-connection.png"/>T2】</a></p>

<h3 id="enable-build-feature">启用构建功能</h3>

<p>在为Docker容器创建了构建定义之后，您需要启用Docker支持构建特性。为此，导航到您的构建定义并单击<strong>构建特性</strong>选项卡。点击<strong>添加构建特征</strong>按钮，选择<strong>对接支持</strong>。选择您为ECR创建的注册表并点击<strong>保存</strong>。</p>

<h3 id="add-your-build-steps">添加您的构建步骤</h3>

<p>Octo Pet Shop应用程序由四个主要组件组成:</p>

<ul>
<li>Web前端</li>
<li>产品服务</li>
<li>购物车服务</li>
<li>DbUp数据库迁移器</li>
</ul>

<p>我的构建只包含六个步骤:</p>

<ol>
<li>设置版本号</li>
<li>构建网站</li>
<li>建立产品服务</li>
<li>构建购物车服务</li>
<li>构建DbUp</li>
<li>将Docker图像推送到ECR</li>
</ol>

<p>第二步到第五步构建各自的Docker图像，然后使用下面的模式<code>octopetshop-&lt;component&gt;:%build.number% 968802670493.dkr.ecr.us-west-1.amazonaws.com/octopetshop-&lt;component&gt;:%build.number%</code>标记它们。例如，这是web前端的标记方式:</p>

<pre><code>octopetshop-web:%build.number% 968802670493.dkr.ecr.us-west-1.amazonaws.com/octopetshop-web:%build.number%
</code></pre>

<p>第六步在一个步骤中将Docker映像推送到ECR。它不使用<code>build</code>选项，而是使用<code>push</code>选项，如下所示:</p>

<pre><code>968802670493.dkr.ecr.us-west-1.amazonaws.com/octopetshop-web:%build.number%
968802670493.dkr.ecr.us-west-1.amazonaws.com/octopetshop-productservice:%build.number%
968802670493.dkr.ecr.us-west-1.amazonaws.com/octopetshop-shoppingcartservice:%build.number%
968802670493.dkr.ecr.us-west-1.amazonaws.com/octopetshop-database:%build.number%
</code></pre>

<h3 id="run-the-build">运行构建</h3>

<p>执行构建时，您应该会得到类似于以下内容的输出:</p>

<pre><code>Step 6/6: Push OctoPetShop-Web (Docker)
15:57:57
  Starting: /bin/sh -c "docker push  968802670493.dkr.ecr.us-west-1.amazonaws.com/octopetshop-web:1.0.20226.225747 &amp;&amp; docker push  968802670493.dkr.ecr.us-west-1.amazonaws.com/octopetshop-productservice:1.0.20226.225747 &amp;&amp; docker push  968802670493.dkr.ecr.us-west-1.amazonaws.com/octopetshop-shoppingcartservice:1.0.20226.225747 &amp;&amp; docker push  968802670493.dkr.ecr.us-west-1.amazonaws.com/octopetshop-database:1.0.20226.225747"
15:57:57
  in directory: /opt/buildagent/work/7f2634c2d5e5df05
15:57:57
  The push refers to repository [968802670493.dkr.ecr.us-west-1.amazonaws.com/octopetshop-web]
15:57:57
  dae5c6c2d080: Preparing
15:57:57
  92dbf6df1786: Preparing
15:57:57
  9d32e62891bc: Preparing
15:57:57
  b22206f4fa7b: Preparing
15:57:57
  b701a024aaa5: Preparing
15:57:57
  0b565516ff7f: Preparing
15:57:57
  91ab7edbc80b: Preparing
15:57:57
  9262398ff7bf: Preparing
15:57:57
  804aae047b71: Preparing
15:57:57
  5d33f5d87bf5: Preparing
15:57:57
  4e38024e7e09: Preparing
15:57:57
  0b565516ff7f: Waiting
15:57:57
  91ab7edbc80b: Waiting
15:57:57
  9262398ff7bf: Waiting
15:57:57
  804aae047b71: Waiting
15:57:57
  5d33f5d87bf5: Waiting
15:57:57
  4e38024e7e09: Waiting
15:58:00
  b22206f4fa7b: Pushed
15:58:01
  9d32e62891bc: Pushed
15:58:01
  dae5c6c2d080: Pushed
15:58:04
  92dbf6df1786: Pushed
15:58:16
  804aae047b71: Pushed
15:58:16
  91ab7edbc80b: Pushed
15:58:31
  5d33f5d87bf5: Pushed
15:58:52
  0b565516ff7f: Pushed
15:58:56
  9262398ff7bf: Pushed
15:59:02
  4e38024e7e09: Pushed
15:59:24
  b701a024aaa5: Pushed
</code></pre>

<p>将图像推送到ECR后，我们可以跳到Octopus Deploy来创建部署流程。</p>

<h2 id="octopus-deploy">章鱼部署</h2>

<p>为了使用在我们的部署过程中被推送到ECR的图像，我们需要在Octopus Deploy中配置一个指向我们的ECR注册中心的外部提要。</p>

<h3 id="create-ecr-external-feed">创建ECR外部进料</h3>

<p>在Octopus Deploy中创建外部提要非常容易。首先，导航到<strong>库</strong>，然后选择<strong>外部馈送</strong>。在<strong>外部进给</strong>屏幕上，点击<strong>添加进给</strong>。从下拉框中选择<strong> AWS弹性容器注册表</strong>，并填写以下内容:</p>

<ul>
<li>名字</li>
<li>存取关键字</li>
<li>秘密钥匙</li>
<li>地区</li>
</ul>

<p>然后点击<strong>保存</strong>。</p>

<h3 id="create-an-aws-account">创建AWS帐户</h3>

<p>因为我使用访问密钥/秘密密钥组合方法对AWS进行认证，所以我需要在Octopus中创建一个AWS帐户来引用。</p>

<ol>
<li>导航至<strong>基础设施</strong>，然后点击<strong>账户</strong>。</li>
<li>在<strong>账户</strong>屏幕上，点击<strong>添加账户</strong>按钮并选择<strong> AWS账户</strong>。</li>
<li>填写所需的值:</li>
</ol>

<ul>
<li>名字</li>
<li>存取关键字</li>
<li>秘密钥匙</li>
</ul>

<ol start="4">
<li>点击<strong>保存</strong>。</li>
</ol>

<h3 id="define-the-deployment-process">定义部署流程</h3>

<p>这篇文章假设你对Octopus Deploy足够熟悉，可以创建一个<a href="https://octopus.com/docs/projects">项目</a>，并将重点放在部署的AWS Fargate特定组件上。</p>

<h4 id="variables">变量</h4>

<p>在开始添加步骤之前，我们首先需要添加一些在流程中使用的变量。我创建了一个库变量集来保存AWS的公共变量:</p>

<ul>
<li><code>AWS.Account</code>:这引用了我们在创建AWS帐户部分创建的AWS帐户。</li>
<li><code>AWS.Region.name</code>:我们正在使用的地区名称。</li>
<li><code>AWS.SecurityGroup.Id</code>:我们为Octo宠物店创建的安全组的ID。</li>
<li>(可选)<code>AWS.Subnet1.Id</code>:要使用的子网1的ID。</li>
<li>(可选)<code>AWS.Subnet.Id</code>:要使用的子网2的ID。</li>
</ul>

<p>其余的变量是项目变量:</p>

<ul>
<li><code>Project.AWS.ECS.Cluster.Name</code>:集群名称(如<code>OctpousSamples-ECS</code>)。</li>
<li><code>Project.AWS.ECS.Service.Name</code>:要创建或更新的服务的名称(例如<code>octopetshop</code>)。</li>
<li><code>Project.AWS.Task.Database.Name</code>:任务定义的数据库容器的名称(如<code>octopetshop-database</code>)。</li>
<li><code>Project.AWS.Task.ProductService.Name</code>:任务定义的产品服务容器的名称(如<code>octopetshop-productservice</code>)。</li>
<li><code>Project.AWS.Task.ShoppingCartService.Name</code>:任务定义的购物车服务容器的名称(如<code>octopetshop-shoppingcartservice</code>)。</li>
<li><code>Project.AWS.Task.Web.Name</code>:任务定义的web容器名称(如<code>octopetshop-web</code>)。</li>
<li><code>Project.Container.Environment.ConnectionString</code>:用作容器环境变量的数据库连接字符串(如<code>Data Source=localhost;Initial Catalog=OctoPetShop; User ID=#{Project.Database.User.Name}; Password=#{Project.Database.User.Password}</code>)。</li>
<li><code>Project.Database.User.Name</code>:数据库连接的用户名(如<code>sa</code>)。</li>
<li><code>Project.Database.User.Password</code>:数据库连接的密码(如<code>My$uper$3cretPassw0rd!</code>)。</li>
</ul>

<h4 id="steps">步伐</h4>

<p>以下过程可以通过使用<a href="https://octopus.com/blog/octopus-release-2021-q4#ecs-integration" class="alert-link">部署Amazon ECS服务</a>步骤来替代(参见我们的<a href="https://samples.octopus.app/app#/Spaces-103/projects/aws-ecs/deployments/process" class="alert-link" rel="nofollow">示例</a>以获取详细信息。)下面的脚本步骤是出于历史目的而保留的。</p>


<p>这个部署将包括两个步骤，它们都使用<strong>运行一个AWS CLI脚本</strong>。在撰写本文时，还没有任何ECS或Fargate特定的模板可用。</p>

<ul>
<li>创建任务定义</li>
<li>运行任务</li>
</ul>

<h5 id="create-task-definition">创建任务定义</h5>

<p>此步骤为ECS运行创建任务定义。为了部署我们上传到ECR的图像，这个步骤将所有的图像作为包引用添加进来。这允许将来自ECR的图像添加到Fargate容器定义集合中。如果被引用的服务不存在，它将创建它，但是如果它存在，它将更新现有的服务。在注册任务定义之后，它将<code>TaskDefinitionArn</code>保存到一个输出变量中，以便在下一步中使用:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-09/aws-fargate/octopus-project-referenced-packages.png" class="zoom" data-title=""><img src="../Images/0d26bc2a8912811ee1dac5b11f5bcad2.png" class="img-fluid center" alt="Package References" data-original-src="https://i.octopus.com/blog/2020-09/aws-fargate/octopus-project-referenced-packages.png"/>T2】</a></p>

<p>使用Fargate时，HostPort和ContainerPort值<em>必须</em>匹配，否则将报告错误。</p>
<p>在步骤中引用包时，请务必将其标记为<code>The package will not be acquired</code>。</p>


<pre><code class="language-PowerShell">$Region = $OctopusParameters["Octopus.Action.Amazon.RegionName"]
$TaskName = $OctopusParameters["Project.AWS.Task.Web.Name"]
$ExecutionRole = $(Get-IAMRole -RoleName "ecsTaskExecutionRole").Arn

# Add web settings
$webPortMappings = New-Object "System.Collections.Generic.List[Amazon.ECS.Model.PortMapping]"
$webPortMappings.Add($(New-Object -TypeName "Amazon.ECS.Model.PortMapping" -Property @{ HostPort=5000; ContainerPort=5000; Protocol=[Amazon.ECS.TransportProtocol]::Tcp}))
$webPortMappings.Add($(New-Object -TypeName "Amazon.ECS.Model.PortMapping" -Property @{ HostPort=5001; ContainerPort=5001; Protocol=[Amazon.ECS.TransportProtocol]::Tcp}))

$webEnvironmentVariables = New-Object "System.Collections.Generic.List[Amazon.ECS.Model.KeyValuePair]"
$webEnvironmentVariables.Add($(New-Object -TypeName "Amazon.ECS.Model.KeyValuePair" -Property @{ Name="ProductServiceBaseUrl"; Value="http://localhost:5011"}))
$webEnvironmentVariables.Add($(New-Object -TypeName "Amazon.ECS.Model.KeyValuePair" -Property @{ Name="ShoppingCartServiceBaseUrl"; Value="http://localhost:5012"}))

$ContainerDefinitions = New-Object "System.Collections.Generic.List[Amazon.ECS.Model.ContainerDefinition]"
$ContainerDefinitions.Add($(New-Object -TypeName "Amazon.ECS.Model.ContainerDefinition" -Property @{ `
Name=$OctopusParameters['Project.AWS.Task.Web.Name'];`
Image=$OctopusParameters["Octopus.Action.Package[octopetshop-web].Image"]; `
PortMappings=$webPortMappings; `
Environment=$webEnvironmentVariables;}))

# Add product service settings
$productServicePortMappings = New-Object "System.Collections.Generic.List[Amazon.ECS.Model.PortMapping]"
$productServicePortMappings.Add($(New-Object -TypeName "Amazon.ECS.Model.PortMapping" -Property @{ ContainerPort=5011; Protocol=[Amazon.ECS.TransportProtocol]::Tcp}))

$serviceEnvironmentVariables = New-Object "System.Collections.Generic.List[Amazon.ECS.Model.KeyValuePair]"
$serviceEnvironmentVariables.Add($(New-Object -TypeName "Amazon.ECS.Model.KeyValuePair" -Property @{ Name="OPSConnectionString"; Value=$OctopusParameters['Project.Container.Environment.ConnectionString']}))

$ContainerDefinitions.Add($(New-Object -TypeName "Amazon.ECS.Model.ContainerDefinition" -Property @{ `
Name=$OctopusParameters['Project.AWS.Task.ProductService.Name']; `
Image=$OctopusParameters["Octopus.Action.Package[octopetshop-productservice].Image"]; `
PortMappings=$productServicePortMappings; `
Environment=$serviceEnvironmentVariables;}))

# Add shopping cart service settings
$shoppingCartServicePortMappings = New-Object "System.Collections.Generic.List[Amazon.ECS.Model.PortMapping]"
$shoppingCartServicePortMappings.Add($(New-Object -TypeName "Amazon.ECS.Model.PortMapping" -Property @{ ContainerPort=5012; Protocol=[Amazon.ECS.TransportProtocol]::Tcp}))

$ContainerDefinitions.Add($(New-Object -TypeName "Amazon.ECS.Model.ContainerDefinition" -Property @{ `
Name=$OctopusParameters['Project.AWS.Task.ShoppingCartService.Name']; `
Image=$OctopusParameters["Octopus.Action.Package[octopetshop-shoppingcartservice].Image"]; `
PortMappings=$shoppingCartServicePortMappings; `
Environment=$serviceEnvironmentVariables;}))

# Add sql server settings
$sqlPortMappings = New-Object "System.Collections.Generic.List[Amazon.ECS.Model.PortMapping]"
$sqlPortMappings.Add($(New-Object -TypeName "Amazon.ECS.Model.PortMapping" -Property @{ HostPort=1433; ContainerPort=1433; Protocol=[Amazon.ECS.TransportProtocol]::Tcp}))

$sqlEnvironmentVariables = New-Object "System.Collections.Generic.List[Amazon.ECS.Model.KeyValuePair]"
$sqlEnvironmentVariables.Add($(New-Object -TypeName "Amazon.ECS.Model.KeyValuePair" -Property @{ Name="ACCEPT_EULA"; Value="Y"}))
$sqlEnvironmentVariables.Add($(New-Object -TypeName "Amazon.ECS.Model.KeyValuePair" -Property @{ Name="SA_PASSWORD"; Value=$OctopusParameters['Project.Database.User.Password']}))

$ContainerDefinitions.Add($(New-Object -TypeName "Amazon.ECS.Model.ContainerDefinition" -Property @{ `
Name="sqlserver"; `
Image=$OctopusParameters["Octopus.Action.Package[mssql-server-linux].Image"]; `
PortMappings=$sqlPortMappings; `
Environment=$sqlEnvironmentVariables;}))

# Add DBUp project
$dbupEnvironmentVariables = New-Object "System.Collections.Generic.List[Amazon.ECS.Model.KeyValuePair]"
$dbupEnvironmentVariables.Add($(New-Object -TypeName "Amazon.ECS.Model.KeyValuePair" -Property @{ Name="DbUpConnectionString"; Value=$OctopusParameters['Project.Container.Environment.ConnectionString']}))

$ContainerDefinitions.Add($(New-Object -TypeName "Amazon.ECS.Model.ContainerDefinition" -Property @{ `
Name="octopetshop-database"; `
Image=$OctopusParameters["Octopus.Action.Package[octopetshop-database].Image"]; `
Essential=$false; `
Environment=$dbupEnvironmentVariables;}))

$TaskDefinition = Register-ECSTaskDefinition `
-ContainerDefinition $ContainerDefinitions `
-Cpu 512 `
-Family $TaskName `
-TaskRoleArn $ExecutionRole `
-ExecutionRoleArn $ExecutionRole `
-Memory 4096 `
-NetworkMode awsvpc `
-Region $Region `
-RequiresCompatibility "FARGATE"

if(!$?)
{
    Write-Error "Failed to register new task definition"
    Exit 0
}

$ClusterName = $OctopusParameters["Project.AWS.ECS.Cluster.Name"]
$ServiceName = $OctopusParameters["Project.AWS.ECS.Service.Name"]

# Check to see if there is a service already
$service = (Get-ECSService -Cluster $ClusterName -Service $ServiceName)

if ($service.Services.Count -eq 0)
{
    Write-Host "Service $ServiceName doesn't exist, creating ..."
    $ServiceCreate = New-ECSService `
        -Cluster $ClusterName `
        -ServiceName $ServiceName `
        -TaskDefinition $TaskDefinition.TaskDefinitionArn `
        -DesiredCount 1 `
        -AwsvpcConfiguration_Subnet @($OctopusParameters['AWS.Subnet1.Id'], $OctopusParameters['AWS.Subnet2.Id']) `
        -AwsvpcConfiguration_SecurityGroup @($OctopusParameters['AWS.SecurityGroup.Id'])
}
else
{
    $ServiceUpdate = Update-ECSService `
        -Cluster $ClusterName `
        -ForceNewDeployment $true `
        -Service $ServiceName `
        -TaskDefinition $TaskDefinition.TaskDefinitionArn `
}

if(!$?)
{
    Write-Error "Failed to register new task definition"
    Exit 0
}

# Save task definition to output variable
Set-OctopusVariable -Name "TaskDefinitionArn" -Value $TaskDefinition.TaskDefinitionArn
</code></pre>

<h5 id="run-task">运行任务</h5>

<p>注册任务定义后，我们使用另一个<code>Run an AWS CLI script</code>步骤来创建在Fargate中运行的任务:</p>

<pre><code class="language-PowerShell"># Assign local variables
$clusterName = $OctopusParameters['Project.AWS.ECS.Cluster.Name']
$securityGroups = @($OctopusParameters['AWS.SecurityGroup.Id'])
$subnets = @($OctopusParameters['AWS.Subnet1.Id'], $OctopusParameters['AWS.Subnet2.Id'])
$taskDefinitionArn = $OctopusParameters['Octopus.Action[Create task definition].Output.TaskDefinitionArn']

# Create launch type object
$launchType = $(New-Object -TypeName "Amazon.ECS.Launchtype" -ArgumentList "FARGATE")

# Create Public IP object
$assignPublicIp = $(New-Object -TypeName "Amazon.ECS.AssignPublicIp" -ArgumentList "ENABLED")

# Create new task
New-ECSTask -Cluster $clusterName `
    -AwsvpcConfiguration_SecurityGroup $securityGroups `
    -AwsvpcConfiguration_Subnet $subnets `
    -TaskDefinition $taskDefinitionArn `
    -LaunchType $launchType `
    -AwsvpcConfiguration_AssignPublicIp $assignPublicIp
</code></pre>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-09/aws-fargate/octopus-project-steps.png" class="zoom" data-title=""><img src="../Images/3b3345a404b49d026439ded884156f02.png" class="img-fluid center" alt="The deployment process steps" data-original-src="https://i.octopus.com/blog/2020-09/aws-fargate/octopus-project-steps.png"/>T2】</a></p>

<h4 id="deployment">部署</h4>

<p>部署完成后，您将看到部署的任务摘要:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-09/aws-fargate/octopus-deployment-complete.png" class="zoom" data-title=""><img src="../Images/0416ce0455ac498fa4d0051349fcf896.png" class="img-fluid center" alt="Deployment task summary" data-original-src="https://i.octopus.com/blog/2020-09/aws-fargate/octopus-deployment-complete.png"/>T2】</a></p>

<h2 id="fargate">法尔盖特</h2>

<p>部署完成后，任务将显示为挂起状态。给任务一些时间达到运行状态。在数据库容器达到停止状态后，Octo Pet Shop应用程序将可用。</p>

<p>【T2 <img src="../Images/c1523ddf7b2ea85bffce206e17bd5960.png" class="img-fluid center" alt="AWS ECS Fargate running task" data-original-src="https://i.octopus.com/blog/2020-09/aws-fargate/aws-ecs-fargate-running-task.png"/></p>

<p>此时，我们可以打开浏览器，进入<code>http://[PublicIP]:5000</code>。在此导航会自动将我们重定向到<code>https://[PublicIP]:5001</code>。你会看到一个关于无效证书的警告，但是Octo宠物店使用的是自签名证书，所以这个警告是正常的，去Octo宠物店是安全的！</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-09/aws-fargate/aws-ecs-fargate-octopetshop.png" class="zoom" data-title=""><img src="../Images/ab73af89f5d17a058fa9f864c22e1bd9.png" class="img-fluid center" alt="Octo Pet Shop" data-original-src="https://i.octopus.com/blog/2020-09/aws-fargate/aws-ecs-fargate-octopetshop.png"/>T2】</a></p>

<h2 id="conclusion">结论</h2>

<p>在本文中，我带您创建了一个CI/CD流程，将Octo Pet Shop应用程序部署到AWS Fargate。<br/>愉快的部署！</p>

                    
                    
</body>
</html>