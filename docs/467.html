<html>
<head>
<title>Octopus Pipe for Bitbucket: octopus-cli-run - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Bitbucket的Octopus管道:octopus-cli-run - Octopus Deploy</h1>
<blockquote>原文：<a href="https://octopus.com/blog/octopus-bitbucket-pipe#2021-08-12">https://octopus.com/blog/octopus-bitbucket-pipe#2021-08-12</a></blockquote>
                        <p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-05/octopus-bitbucket-pipe/bitbucket-cd.png" class="zoom" data-title=""><img src="../Images/394c6a78b8f08d81fb0813a53b4cd66d.png" class="img-fluid center" alt="Bitbucket Pipelines" data-original-src="https://i.octopus.com/blog/2020-05/octopus-bitbucket-pipe/bitbucket-cd.png"/>T2】</a></p>

<p>在之前的一篇文章中，我写了<a href="/blog/bitbucket-pipes-and-octopus-deploy">如何创建一个Bitbucket管道并将其与Octopus Deploy </a>集成。如果您是第一次开始使用管道，值得一读。</p>

<p>在本帖中，我将向您概述Octopus - <a href="https://bitbucket.org/octopusdeploy/octopus-cli-run/" rel="nofollow"> octopus-cli-run </a>的新实验性Bitbucket管道。如果你有兴趣尝试实验管道，你可以用它来运行来自<a href="https://octopus.com/docs/octopus-rest-api/octopus-cli/"> Octopus CLI </a>的命令，允许你进一步将你的Atlassian<a href="https://bitbucket.org/product/features/pipelines" rel="nofollow">bit bucket Pipeline</a>与Octopus集成来管理你的包、发布和部署。</p>

<h2>在这篇文章中</h2>



<h2 id="pipe-yaml-definition">管道YAML定义</h2>

<p>管道的基本定义包括对托管在<a href="https://bitbucket.org/octopusdeploy/octopus-cli-run/" rel="nofollow">位桶</a>上的仓库的引用。它还在Docker Hub上被发布为<a href="https://hub.docker.com/r/octopipes/octopus-cli-run/" rel="nofollow">octopus/octopus-CLI-run</a>。</p>

<p>它有一个必需的<code>CLI_COMMAND</code>变量。这是要运行的CLI命令。</p>

<p>要在您的<code>bitbucket-pipelines.yml</code>文件中使用管道，请将下面的YAML代码片段添加到脚本部分:</p>

<pre><code class="language-yaml">- pipe: octopusdeploy/octopus-cli-run:0.13.0
  variables:
    CLI_COMMAND: "&lt;string&gt;"
    # EXTRA_ARGS: ['&lt;string&gt;','&lt;string&gt;' ..] # Optional
    # DEBUG: "&lt;boolean&gt;" # Optional
</code></pre>

<p>管道还提供了一个名为<code>EXTRA_ARGS</code>的<em>可选</em>数组变量，您可以使用它来包含指定命令的任何附加命令行参数。</p>

<h3 id="pipe-variable-definitions">管道变量定义</h3>

<p>位桶管道和管道中的变量被配置为<a href="https://confluence.atlassian.com/bitbucket/variables-in-pipelines-794502608.html" rel="nofollow">环境变量</a>。由于<code>octopus-cli-run</code>管道包含许多命令，所需的具体变量取决于您正在使用的命令。参见<a href="https://bitbucket.org/octopusdeploy/octopus-cli-run/src/master/README.md#markdown-header-variables" rel="nofollow">自述文件</a>了解每个命令所需变量的详细信息。</p>

<h2 id="supported-commands">支持的命令</h2>

<p>这个<code>octopus-cli-run</code>管道是用最常用的CLI命令编写的，它实际上是建立在<a href="https://hub.docker.com/r/octopusdeploy/octo/" rel="nofollow"> Octopus CLI Docker映像</a>之上的。这包括以下能力:</p>

<ul>
<li>使用<a href="https://octopus.com/docs/octopus-rest-api/octopus-cli/pack"> pack </a>打包您的文件或构建工件。</li>
<li>使用<a href="https://octopus.com/docs/octopus-rest-api/octopus-cli/pack"> push </a>将包发送到Octopus内置存储库。</li>
<li>使用<a href="https://octopus.com/docs/octopus-rest-api/octopus-cli/build-information">构建信息</a>将构建信息推送到Octopus。</li>
<li>使用<a href="https://octopus.com/docs/octopus-rest-api/octopus-cli/create-release"> create-release </a>自动创建发布。</li>
<li>使用<a href="https://octopus.com/docs/octopus-rest-api/octopus-cli/create-release">部署-发布</a>部署已经创建的发布。</li>
</ul>

<p>接下来，我们将使用<a href="https://bitbucket.org/octopussamples/petclinic/" rel="nofollow"> Bitbucket </a>上提供的<strong> PetClinic </strong>示例应用程序来探索每个命令的管道步骤。为了保持简单，这些步骤已经减少到所需的最小定义。</p>

<h3 id="pack">包装</h3>

<p><code>pack</code>命令允许你从磁盘上的文件创建<a href="https://octopus.com/docs/packaging-applications">包</a>(zip或nupkg格式)，而不需要<code>.nuspec</code>或<code>.csproj</code>文件。</p>

<p>要创建包，请定义如下步骤:</p>

<pre><code class="language-yaml">- step:
    name: octo pack mysql-flyway
    script:
      - pipe: octopusdeploy/octopus-cli-run:0.13.0
        variables:
          CLI_COMMAND: 'pack'
          ID: 'petclinic.mysql.flyway'
          FORMAT: 'Zip'
          VERSION: '1.0.0.0'
          SOURCE_PATH: 'flyway'
          OUTPUT_PATH: 'flyway'
    artifacts:
      - "flyway/*.zip"
</code></pre>

<p>这会打包<code>flyway</code>文件夹，并在同一个文件夹中创建一个名为<code>petclinic.mysql.flyway.1.0.0.0.zip</code>的zip文件。</p>

<h3 id="push">推</h3>

<p><code>push</code>命令使您能够推送包(。zip，。nupkg，。战争等)到章鱼<a href="https://octopus.com/docs/packaging-applications/package-repositories/built-in-repository">的内置储存库</a></p>

<p>还支持同时推送多个包。要执行多包<code>push</code>，定义如下步骤:</p>

<pre><code class="language-yaml">- step:
    name: octo push
    script:
      - pipe: octopusdeploy/octopus-cli-run:0.13.0
        variables:
          CLI_COMMAND: 'push'
          OCTOPUS_SERVER: $OCTOPUS_SERVER
          OCTOPUS_APIKEY: $OCTOPUS_API_KEY
          OCTOPUS_SPACE: $OCTOPUS_SPACE
          PACKAGES: [ "./flyway/petclinic.mysql.flyway.1.0.0.0.zip", "target/petclinic.web.1.0.0.0.war" ]
</code></pre>

<p>这将把<code>petclinic.mysql.flyway.1.0.0.0.zip</code>和<code>petclinic.web.1.0.0.0.war</code>包推送给Octopus。</p>

<h3 id="build-information">构建信息</h3>

<p><code>build-information</code>命令帮助您将关于您的构建的信息(编号、URL、提交)传递给Octopus。这些信息可以在Octopus中查看，也可以在<a href="https://octopus.com/docs/managing-releases/release-notes">发行说明</a>和<a href="https://octopus.com/docs/managing-releases/deployment-notes">部署说明</a>中使用。</p>

<p>如果您已经创建了一个构建信息文件，那么您可以使用<code>FILE</code>变量将它提供给命令。如果没有提供变量，管道将生成自己的构建信息文件，并将其发送给Octopus。</p>

<p>要推送自动生成的构建信息文件，请定义如下步骤:</p>

<pre><code class="language-yaml">- step:
    name: octo build-information
    script:
      - pipe: octopusdeploy/octopus-cli-run:0.13.0
        variables:
          CLI_COMMAND: 'build-information'
          OCTOPUS_SERVER: $OCTOPUS_SERVER
          OCTOPUS_APIKEY: $OCTOPUS_API_KEY
          OCTOPUS_SPACE: $OCTOPUS_SPACE
          VERSION: '1.0.0.0'
          PACKAGE_IDS: ['petclinic.web']
</code></pre>

<p>这将创建构建信息，将它与<code>petclinic.web</code>包的版本<code>1.0.0.0</code>相关联，并将其推送到Octopus。</p>

<h3 id="create-release">创建发布</h3>

<p><code>create-release</code>命令允许您在Octopus中创建一个版本。您使用<code>PROJECT</code>变量指定项目来创建发布。</p>

<p>或者，您也可以将该版本部署到一个或多个环境中。为了实现这一点，您应该使用全局<code>EXTRA_ARGS</code>数组变量并提供适当的选项。例如:</p>

<p><code>EXTRA_ARGS: ['--deployTo', 'Development', '--guidedFailure', 'True']</code></p>

<p>要创建一个版本，并让Octopus选择要使用的版本，创建如下步骤:</p>

<pre><code class="language-yaml">- step:
    name: octo create-release
    script:
      - pipe: octopusdeploy/octopus-cli-run:0.13.0
        variables:
          CLI_COMMAND: 'create-release'
          OCTOPUS_SERVER: $OCTOPUS_SERVER
          OCTOPUS_APIKEY: $OCTOPUS_API_KEY
          OCTOPUS_SPACE: $OCTOPUS_SPACE
          PROJECT: $OCTOPUS_PROJECT
</code></pre>

<h3 id="deploy-release">部署发布</h3>

<p><code>deploy-release</code>命令允许您部署已经创建的版本。使用<code>PROJECT</code>和<code>RELEASE_NUMBER</code>变量来指定项目和发布版本号以部署发布版本。</p>

<p>通过使用名称或ID在<code>DEPLOY_TO</code>变量中指定要部署到的环境，如下所示:</p>

<p><code>DEPLOY_TO: ['Environments-1', 'Development', 'Staging', 'Test']</code></p>

<p>要为一个项目将<code>latest</code>版本部署到<code>Development</code>，创建如下步骤:</p>

<pre><code class="language-yaml">- step:
    name: octo deploy-release
    script:
      - pipe: octopusdeploy/octopus-cli-run:0.13.0
        variables:
          CLI_COMMAND: 'deploy-release'
          OCTOPUS_SERVER: $OCTOPUS_SERVER
          OCTOPUS_APIKEY: $OCTOPUS_API_KEY
          OCTOPUS_SPACE: $OCTOPUS_SPACE
          PROJECT: $OCTOPUS_PROJECT
          RELEASE_NUMBER: 'latest'
          DEPLOY_TO: ['Development']
</code></pre>

<h2 id="using-the-pipe">使用管道</h2>

<p>最后，让我们看看如何在多个步骤中使用管道来组成完整的位桶管道:</p>

<pre><code class="language-yaml">image: maven:3.6.1

pipelines:
  branches:
    master:
      - step:
          name: build petclinic
          caches:
            - maven
          script:
            - mvn -B verify -DskipTests -Dproject.versionNumber=1.0.0.0 -DdatabaseUserName=$DatabaseUserName -DdatabaseUserPassword=$DatabaseUserPassword -DdatabaseServerName=$DatabaseServerName -DdatabaseName=$DatabaseName
          artifacts:
          - "target/*.war"
      - step:
          name: octo pack mysql-flyway
          script:
            - pipe: octopusdeploy/octopus-cli-run:0.13.0
              variables:
                CLI_COMMAND: 'pack'
                ID: 'petclinic.mysql.flyway'
                FORMAT: 'Zip'
                VERSION: '1.0.0.0'
                SOURCE_PATH: 'flyway'
                OUTPUT_PATH: './flyway'
          artifacts:
            - "flyway/*.zip"
      - step:
          name: octo push
          script:
            - pipe: octopusdeploy/octopus-cli-run:0.13.0
              variables:
                CLI_COMMAND: 'push'
                OCTOPUS_SERVER: $OCTOPUS_SERVER
                OCTOPUS_APIKEY: $OCTOPUS_API_KEY
                OCTOPUS_SPACE: $OCTOPUS_SPACE
                PACKAGES: [ "./flyway/petclinic.mysql.flyway.1.0.0.0.zip", "target/petclinic.web.1.0.0.0.war" ]
      - step:
          name: octo build-information
          script:
            - pipe: octopusdeploy/octopus-cli-run:0.13.0
              variables:
                CLI_COMMAND: 'build-information'
                OCTOPUS_SERVER: $OCTOPUS_SERVER
                OCTOPUS_APIKEY: $OCTOPUS_API_KEY
                OCTOPUS_SPACE: $OCTOPUS_SPACE
                VERSION: '1.0.0.0'
                PACKAGE_IDS: ['petclinic.web']
      - step:
          name: octo create-release
          script:
            - pipe: octopusdeploy/octopus-cli-run:0.13.0
              variables:
                CLI_COMMAND: 'create-release'
                OCTOPUS_SERVER: $OCTOPUS_SERVER
                OCTOPUS_APIKEY: $OCTOPUS_API_KEY
                OCTOPUS_SPACE: $OCTOPUS_SPACE
                PROJECT: $OCTOPUS_PROJECT
      - step:
          name: octo deploy-release
          script:
            - pipe: octopusdeploy/octopus-cli-run:0.13.0
              variables:
                CLI_COMMAND: 'deploy-release'
                OCTOPUS_SERVER: $OCTOPUS_SERVER
                OCTOPUS_APIKEY: $OCTOPUS_API_KEY
                OCTOPUS_SPACE: $OCTOPUS_SPACE
                PROJECT: $OCTOPUS_PROJECT
                RELEASE_NUMBER: 'latest'
                DEPLOY_TO: ['Development']
</code></pre>

<p>就是这样！</p>

<p>您可以在<a href="https://bitbucket.org/octopussamples/petclinic/src/master/bitbucket-pipelines.yml" rel="nofollow">位桶</a>上查看完整的PetClinic <code>bitbucket-pipelines.yml</code>文件。</p>

<p><strong>样本Octopus项目</strong> <br/>您可以在我们的<a href="https://g.octopushq.com/TargetWildflySamplePetClinic" class="alert-link" rel="nofollow">样本</a>实例中看到PetClinic Octopus项目。</p>


<h2 id="conclusion">结论</h2>

<p>使用位桶管道确实有助于简化位桶管道中的配置，并且作为作者有助于促进您的操作的重用。查看<a href="https://bitbucket.org/product/features/pipelines/integrations" rel="nofollow"> Bitbucket Pipelines </a>了解更多信息，查看<a href="https://bitbucket.org/octopusdeploy/octopus-cli-run/src/master/README.md" rel="nofollow">实验性Octopus Pipe </a>了解如何一起使用Bitbucket和Octopus的更多细节。</p>

                    
                    
</body>
</html>