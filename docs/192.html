<html>
<head>
<title>Deploying PHP applications with Octopus Deploy - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>用Octopus部署PHP应用程序</h1>
<blockquote>原文：<a href="https://octopus.com/blog/deploying-php#2021-07-07">https://octopus.com/blog/deploying-php#2021-07-07</a></blockquote>
                        <p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-05/deploying-php/blogimage-deploying-php-applications-with-octopus-deploy-2021.png" class="zoom" data-title=""><img src="../Images/97dc23a5a2d1543c060ddccbd15d652f.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2021-05/deploying-php/blogimage-deploying-php-applications-with-octopus-deploy-2021.png"/>T2】</a></p>

<p>PHP是基于网络的应用程序中最流行的语言。这种流行导致了广泛的产品，这些产品将部署您的PHP代码，但不一定是您的整个堆栈。应用程序通常包括web前端以外的组件，如数据库、API，甚至容器化的微服务。</p>

<p>在这篇文章中，我演示了如何将PHP应用程序部署到使用MySQL作为数据库后端的NGINX web服务器上。</p>

<h2 id="sample-application">示例应用程序</h2>

<p>我为这个帖子选择的示例应用程序是<a href="https://projectnotes.org/php/car-rental-project-in-php-and-mysqli-with-source-code/" rel="nofollow">租车项目</a>。</p>

<p>只需对单个文件稍加修改，这个应用程序就可以开箱即用，非常适合这个演示。源代码包含一个MySQL数据库脚本，该脚本将创建表模式并用数据播种数据库。我将在这篇文章的后面讨论需要做的修改。下面是<a href="https://bitbucket.org/octopussamples/carrental/src/main/" rel="nofollow">修改项目</a>的链接。</p>

<h2 id="building-your-php-application">构建您的PHP应用程序</h2>

<p>PHP是一种脚本语言，这意味着它不需要编译就可以部署。然而，在PHP应用程序中使用构建服务器有一些好处:</p>

<ul>
<li>如果您的PHP应用程序使用<a href="https://getcomposer.org/" rel="nofollow"> Composer </a>作为依赖项管理器，您可以将它包含在应用程序的构建中，以便在构建运行时收集最新版本的依赖项。</li>
<li>使用构建服务器Octopus Deploy插件来简化集成，例如:<ul>
<li>打包应用程序</li>
<li>将包推送到Octopus Deploy服务器或第三方包解决方案(Nexus、Artifactory等)。)</li>
<li>将构建信息推送到Octopus部署</li>
<li>创建版本</li>
<li>部署和/或推广版本</li>
</ul>
</li>
</ul>

<p>对于这篇文章，我选择Jenkins作为我的构建服务器，有三个步骤:</p>

<ul>
<li>打包web前端</li>
<li>打包数据库脚本</li>
<li>将包推送到Octopus部署</li>
</ul>

<h3 id="package-web-front-end">打包web前端</h3>

<p>首先，让我们看一下我为这个项目所做的修改。如前所述，汽车租赁应用程序使用MySQL作为其数据库后端。数据库连接信息位于<code>src/includes/config.php</code>中。使用Octostache和模板中的<a href="https://octopus.com/docs/projects/steps/configuration-features/substitute-variables-in-templates#:%7E:text=The%20Substitute%20Variables%20in%20Files,Octopus%20Variables%20into%20any%20file.">替代变量</a>功能，我们可以参数化连接信息:</p>

<pre><code class="language-php">&lt;?php 
// DB credentials.
define('DB_HOST','#{MySQL.Server.Name}:#{MySQL.Server.Port}');
define('DB_USER','#{MySQL.Admin.User.Name}');
define('DB_PASS','#{MySQL.Admin.User.Password}');
define('DB_NAME','#{Project.Database.Name}');
// Establish database connection.
try
{
$dbh = new PDO("mysql:host=".DB_HOST.";dbname=".DB_NAME,DB_USER, DB_PASS,array(PDO::MYSQL_ATTR_INIT_COMMAND =&gt; "SET NAMES 'utf8'",PDO::MYSQL_ATTR_SSL_CA =&gt; '/var/www/html/DigiCertGlobalRootG2.crt.pem',PDO::MYSQL_ATTR_SSL_VERIFY_SERVER_CERT =&gt; false));
}
catch (PDOException $e)
{
exit("Error: " . $e-&gt;getMessage());
}
?&gt;
</code></pre>

<p>对于这个演示，我使用Azure MySQL PaaS，它需要一个到数据库的SSL连接。我需要将以下内容添加到PDO期权组件数组中(如上所示):</p>

<pre><code>PDO::MYSQL_ATTR_SSL_CA =&gt; '/var/www/html/DigiCertGlobalRootG2.crt.pem'
PDO::MYSQL_ATTR_SSL_VERIFY_SERVER_CERT =&gt; false
</code></pre>

<p>使用Octopus Deploy Jenkins插件，打包应用程序进行部署很容易。只需选择<strong>Octopus Deploy:Package application</strong>步骤并填写以下内容:</p>

<ul>
<li>Octopus Deploy CLI:选择在<code>Global Tool Configuration</code>中配置的Octopus Deploy CLI</li>
<li>包ID:包的名称，即<code>CarRental.PHP.Web</code></li>
<li>版本号:包的版本号</li>
<li>包格式:Zip或Nuget</li>
<li>包基础文件夹:对于我的回购，它是<code>${WORKSPACE}/src</code></li>
<li>包输出文件夹:<code>${WORKSPACE}</code></li>
</ul>

<h3 id="package-database-script">打包数据库脚本</h3>

<p>源代码中包含一个脚本，该脚本创建模式并用数据填充数据库。数据库脚本文件是专门为使用Flyway数据库迁移产品而命名的:</p>

<ul>
<li>Octopus Deploy CLI:选择<code>Global Tool Configuration</code>中配置的Octopus Deploy CLI</li>
<li>包ID:包的名称，即<code>CarRental.PHP.Db</code></li>
<li>版本号:包的版本号</li>
<li>包格式:Zip或Nuget</li>
<li>包基础文件夹:对于我的回购，它是<code>${WORKSPACE}</code></li>
<li>包输出文件夹:<code>${WORKSPACE}</code></li>
<li>包包含路径:<code>**/sql/*.*</code></li>
</ul>

<h3 id="pushing-packages-to-octopus-deploy">将包推送到Octopus部署</h3>

<p>使用<strong>Octopus Deploy:Push packages</strong>插件步骤，您可以在一个步骤中将web和数据库包推送到Octopus Deploy:</p>

<ul>
<li>Octopus Deploy CLI:选择在<code>Global Tool Configuration</code>中配置的Octopus Deploy CLI</li>
<li>Octopus Deploy Server:选择要推送的Octopus Deploy server(在<strong> <span class="path">管理詹金斯➜配置系统</span> </strong>中定义)</li>
<li>空间:选择要推进到的空间(如果留空，则使用默认值)</li>
<li>包路径:<code>/.zip</code></li>
</ul>

<p>我们的PHP应用程序现在已经打包好，可以部署了。</p>

<h2 id="deploying-your-php-application">部署PHP应用程序</h2>

<p>包准备好了，我们就可以定义我们的部署过程了。</p>

<p>这篇文章假设您已经熟悉创建Octopus Deploy项目，所以我不会涉及这一部分。如果你不熟悉这个话题，看看我们的<a href="https://octopus.com/docs/getting-started">入门</a>指南。</p>

<p>我们的部署流程将包括以下步骤:</p>

<ul>
<li>如果MySQL数据库不存在，则创建它</li>
<li>Flyway数据库迁移(使用执行容器)</li>
<li>部署到NGINX</li>
</ul>

<h3 id="create-mysql-database">创建MySQL数据库</h3>

<p>如果数据库还不存在，这一步将在MySQL服务器上创建一个数据库。这一步只需要填写几个输入:</p>

<ul>
<li>服务器:MySQL服务器的名称或IP地址</li>
<li>用户名:有足够权限创建数据库的用户名</li>
<li>密码:用户帐户的密码</li>
<li>数据库名称:要创建的数据库的名称</li>
<li>端口:MySQL监听的端口(默认为3306)</li>
<li>使用SSL:连接到MySQL时是否使用SSL(这对于我来说是必须的，因为我使用的是Azure MySQL PaaS)</li>
</ul>

<h3 id="flyway-database-migrations">Flyway数据库迁移</h3>

<p>在这篇文章中，我使用了新创建的<a href="https://library.octopus.com/step-templates/ccebac39-79a8-4ab4-b55f-19ea570d9ebc/actiontemplate-flyway-database-migrations" rel="nofollow"> Flyway模板</a>，它可以与<a href="https://octopus.com/docs/projects/steps/execution-containers-for-workers">执行容器</a>一起使用。</p>

<ul>
<li>执行位置:在工作线程上运行一次</li>
<li>工人池:包含安装了Docker的工人的池</li>
<li>容器图像:<code>octopuslabs/flyway-workertools:latest</code>(您必须配置外部feed才能使用Docker Hub)</li>
</ul>

<p>该步骤需要以下信息:</p>

<ul>
<li>飞行路线包:<code>CarRental.PHP.Db</code></li>
<li>飞航命令:<code>Migrate</code></li>
<li>-Url: JDBC连接Url，即jdbc:mysql:// <code>&lt;ServerName&gt;</code> : <code>&lt;Port&gt;</code> / <code>&lt;DatabaseName&gt;</code> }？server time zone = UTC&amp;use SSL = true</li>
<li>-用户:可以更新数据库的用户</li>
<li>-Password:用户帐户的密码</li>
</ul>

<h3 id="deploy-car-rental-to-nginx">将汽车租赁部署到NGINX</h3>

<p>第三步也是最后一步是将汽车租赁PHP应用程序部署到NGINX web服务器上。选择NGINX内置步骤模板，向流程添加一个步骤:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-05/deploying-php/octopus-nginx-step.png" class="zoom" data-title=""><img src="../Images/2ea24aba9a1e36ee834ee3967e467700.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2021-05/deploying-php/octopus-nginx-step.png"/>T2】</a></p>

<p>点击<strong>配置功能</strong>并启用:</p>

<ul>
<li><strong>定制部署脚本</strong></li>
<li><strong>替换模板中的变量</strong></li>
</ul>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-05/deploying-php/octopus-configure-features.png" class="zoom" data-title=""><img src="../Images/e01485264e34eeaf61608d6597d525a4.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2021-05/deploying-php/octopus-configure-features.png"/>T2】</a></p>

<h4 id="package-details">包装详情</h4>

<p>在<strong>封装细节</strong>部分，选择<code>CarRental.PHP.Web</code>封装。</p>

<h4 id="custom-deployment-scripts">自定义部署脚本</h4>

<p>在部署后脚本窗口中添加以下内容:</p>

<pre><code>nginx -s reload
</code></pre>

<p>确保为脚本选择适当的语言。我选择Bash，因为我要在Linux上部署NGINX。</p>

<p>【T2 <img src="../Images/6175dd04d96dd0bf301a8d2d023812bb.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2021-05/deploying-php/octopus-nginx-post-deploy-script.png"/></p>

<h4 id="substitute-variables-in-templates">模板中的替代变量</h4>

<p>指定包含数据库连接信息的<code>config.php</code>文件的位置，以便用<strong>目标文件</strong>输入:<code>includes/config.php</code>中的适当值进行更新</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-05/deploying-php/octopus-file-substitute.png" class="zoom" data-title=""><img src="../Images/1f0e15ecd8f2f012a69003c621fe6813.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2021-05/deploying-php/octopus-file-substitute.png"/>T2】</a></p>

<h4 id="nginx-web-server">NGINX Web服务器</h4>

<p>本节将定义NGINX步骤的设置。在这篇文章中，我填写了绑定和位置。</p>

<h5 id="bindings">粘合剂</h5>

<p>对于这个示例应用程序，我只需要一个绑定:</p>

<ul>
<li>协议:http</li>
<li>端口:8088(或者您希望的任何端口)</li>
<li>IP地址:*</li>
</ul>

<h5 id="locations">位置</h5>

<p>要配置NGINX来运行我们的PHP应用程序，我们需要定义三个位置:</p>

<pre><code>Location: = /
Directives:

- index = `index.html`

Location: /
Directives:

- root = #{Octopus.Action.Package.InstallationDirectoryPath}/
- try_files = $uri /index.php$is_args$args

Location: ~ [^/]\.php(/|$)
Directives:

- fastcgi_split_path_info = ^(.+?\.php)(/.*)$
- fastcgi_pass = unix:/run/php/php7.2-fpm.sock
- fastcgi_index = index.php
- include = fastcgi.conf
- root = #{Octopus.Action.Package.InstallationDirectoryPath}/
- fastcgi_param = ENVIRONMENT_NAME #{Octopus.Environment.Name}
</code></pre>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-05/deploying-php/octopus-nginx-locations.png" class="zoom" data-title=""><img src="../Images/eea16c0e141c14bee43d67c55fa2512e.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2021-05/deploying-php/octopus-nginx-locations.png"/>T2】</a></p>

<p>我们现在已经配置了将PHP应用程序部署到NGINX的步骤。剩下的工作就是创建一个版本并进行部署。</p>

<h3 id="deploy">部署</h3>

<p>部署您的版本后，您应该会收到类似于以下内容的输出:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-05/deploying-php/octopus-deploy-success.png" class="zoom" data-title=""><img src="../Images/29f1bfd3f84d533181292dd495abd6a0.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2021-05/deploying-php/octopus-deploy-success.png"/>T2】</a></p>

<p>您可能会注意到NGINX步骤显示警告，但是，这是正常的。NGINX将信息消息写入stderr流，Octopus将其解释为可能的错误，并标记为警告。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-05/deploying-php/octopus-nginx-stderr.png" class="zoom" data-title=""><img src="../Images/48bd4270d83ea0769072776de552651a.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2021-05/deploying-php/octopus-nginx-stderr.png"/>T2】</a></p>

<p>访问我们的服务器，我们可以看到我们的PHP应用程序已经启动并运行。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-05/deploying-php/car-rental-app.png" class="zoom" data-title=""><img src="../Images/a4c5be8753a3167cf18230e1c0521ba7.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2021-05/deploying-php/car-rental-app.png"/></a>T2】</p>

<h2 id="conclusion">结论</h2>

<p>世界上大多数人都在PHP上运行他们的应用程序。在这篇文章中，我演示了如何使用Octopus Deploy通过数据库后端轻松部署PHP应用程序。</p>

<p>愉快的部署！</p>

                    
                    
</body>
</html>