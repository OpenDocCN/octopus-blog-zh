<html>
<head>
<title>Infrastructure as code in Azure with Terraform and Octopus Deploy - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>基础设施作为Azure中的代码，具有Terraform和Octopus Deploy - Octopus Deploy</h1>
<blockquote>原文：<a href="https://octopus.com/blog/terraform-and-octopus-deploy-in-azure#2021-08-12">https://octopus.com/blog/terraform-and-octopus-deploy-in-azure#2021-08-12</a></blockquote>
                        <p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-12/terraform-and-octopus-deploy-in-azure/infrastructure-as-code-terraform.png" class="zoom" data-title=""><img src="../Images/746b758cb8f51f1eeb014457780dcca4.png" class="img-fluid center" alt="Infrastructure as code in Azure with Terraform and Octopus Deploy" data-original-src="https://i.octopus.com/blog/2020-12/terraform-and-octopus-deploy-in-azure/infrastructure-as-code-terraform.png"/>T2】</a></p>

<p>基础设施开发人员编写代码来自动化配置云和内部基础设施的过程，在这篇文章中，我将向您展示如何使用Terraform和Octopus Deploy将服务部署到Azure。</p>

<h2 id="prerequisites">先决条件</h2>

<p>要跟进这篇博文，您需要以下内容:</p>

<ul>
<li>一个Octopus部署的服务器，或者是<a href="https://octopus.com/start/server">本地</a>或者是<a href="https://octopus.com/start/cloud">云实例</a></li>
<li>Azure订阅。如果你还没有，你可以注册一个<a href="https://azure.microsoft.com/en-us/free/" rel="nofollow"> 30天的免费试用</a>。</li>
<li>Azure服务主体(应用程序注册)有权在您的Azure订阅中创建资源。</li>
<li>初级到中级水平的<a href="https://www.terraform.io/intro/index.html" rel="nofollow">地形</a>知识。</li>
</ul>

<h2 id="using-octopus-and-terraform-together">同时使用章鱼和地球形态</h2>

<p>Terraform是由<a href="https://www.hashicorp.com/" rel="nofollow"> Hashicorp </a>创建的代码为平台的开源<a href="https://docs.microsoft.com/en-us/azure/devops/learn/what-is-infrastructure-as-code" rel="nofollow">基础设施，在Octopus Deploy中默认支持。</a></p>

<p>您可以将Terraform资源部署到:</p>

<ul>
<li>蔚蓝的</li>
<li>自动警报系统</li>
<li>内部部署(硬件和虚拟化环境)</li>
</ul>

<p>在持续交付和部署工具中使用Terraform的主要好处之一是，您可以专注于编写代码，而不是手动部署。将Octopus和Terraform结合起来，可以让整个生命周期自动化。</p>

<h2 id="the-terraform-code">地形代码</h2>

<p>要在Azure中创建资源或服务，您需要编写HCL代码。在这一节中，我将向您展示使用Terraform在Azure中创建资源组的HCL代码。</p>

<h3 id="the-azure-terraform-provider">Azure Terraform提供商</h3>

<p>每当您与Terraform提供者交互时，您都需要在代码块中指定一些输入和身份验证。用于与Azure交互的提供者是<a href="https://www.terraform.io/docs/providers/azurerm/index.html" rel="nofollow"> <code>azurerm</code>提供者</a>。</p>

<p>向<code>azurerm</code> Terraform提供商认证有四种方式:</p>



<p>出于这篇博文的目的，我们使用Azure服务主体。</p>

<p>提供商需要以下信息:</p>

<ul>
<li>Azure订阅ID</li>
<li>客户端ID</li>
<li>客户机密</li>
<li>Tenant ID</li>
</ul>

<p>还有一个<code>features</code>参数，但是可以留空。</p>

<p>提供者配置块看起来像下面的代码:</p>

<pre><code>provider "azurerm" {
  subscription_id = "#{subscriptionID}"
  client_id       = "#{clientID}"
  client_secret   = "#{clientSecret}"
  tenant_id       = "#{tenantID}"

  features        = {}
}
</code></pre>

<p>注意，订阅ID、客户机ID、客户机机密和租户ID的值都有变量。我将在后面的小节中介绍这些变量的配置。</p>

<h2 id="creating-the-azure-resource">创建Azure资源</h2>

<p>资源创建操作将调用<code>azurerm_resource_group</code>资源类型。资源类型在配置块中包含两个参数:</p>

<ul>
<li><strong>名称</strong>:您正在创建的资源组的名称。</li>
<li><strong>位置</strong>:资源组将要驻留的位置，例如<code>eastus</code>。</li>
</ul>

<pre><code>resource "azurerm_resource_group" "resourceGroup" {
  name     = "#{resourceGroupName}"
  location = "#{location}"
}
</code></pre>

<p>有了提供者和资源代码后，它应该类似于下面的代码片段:</p>

<pre><code>provider "azurerm" {
  subscription_id = "#{subscriptionID}"
  client_id       = "#{clientID}"
  client_secret   = "#{clientSecret}"
  tenant_id       = "#{tenantID}"

  features        = {}
}

resource "azurerm_resource_group" "myterraformgroup" {
  name     = "#{resourceGroupName}"
  location = "#{location}"
}
</code></pre>

<h2 id="authentication-from-octopus-deploy-to-azure">从Octopus部署到Azure的身份验证</h2>

<p>接下来，您需要一种从Octopus Deploy到Azure的身份验证方法。Octopus Deploy提供了一种创建帐户的方法，用于对云和内部环境进行身份验证。</p>

<h3 id="create-an-azure-account">创建Azure帐户</h3>

<ol>
<li>登录Octopus Deploy门户网站，进入<strong> <span class="path">基础设施➜账户</span> </strong></li>
<li>点击<strong>添加账户</strong>并选择<strong> Azure订阅</strong>选项。</li>
<li>为您用来在Azure门户中创建资源的Azure服务主体添加相关信息。</li>
<li>为了确认Azure服务主体工作，点击<strong>保存并测试</strong>。</li>
</ol>

<h2 id="creating-a-new-project-in-octopus-deploy">在Octopus Deploy中创建新项目</h2>

<p>从Octopus Deploy到Azure的身份验证完成后，您可以开始考虑您希望Terraform runbook如何存在以及存在于何处。为了确保runbook在它自己的项目中，您可以在Octopus Web门户中创建项目。</p>

<h3 id="create-a-project-in-octopus-deploy">在Octopus Deploy中创建项目</h3>

<ol>
<li>登录Azure门户，进入<strong>项目</strong>。</li>
<li>选择您想要存储项目的项目组，然后单击<strong>添加项目</strong>。</li>
<li>创建一个新项目，并将其命名为<strong> TerraformAzure </strong>。</li>
</ol>

<p>创建项目后，就该创建操作手册了。</p>

<h3 id="creating-the-octopus-variables">创建章鱼变量</h3>

<p>导航到项目的变量部分，添加项目变量:</p>

<pre><code>AzureAuth         = AzureAuth Account
clientID          = guid_client_id
clientSecret      = client_secret
location          = eastus
resourceGroupName = your_resource_group_name
subscriptionID    = your_subscription_id
tenantID          = guid_tenant_id
</code></pre>

<p>这些值会因您使用的环境而异。变量的<code>Name</code>应该与下面的例子相匹配，但是对于您的环境，值会有所不同。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-12/terraform-and-octopus-deploy-in-azure/images/4.png" class="zoom" data-title=""><img src="../Images/307694ec471c595074410b2ee7f9eb0c.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2020-12/terraform-and-octopus-deploy-in-azure/images/4.png"/>T2】</a></p>

<h2 id="configure-the-runbook">配置操作手册</h2>

<p>因为你是在Azure中部署服务，而不是为应用程序编码，所以使用runbook是最有效的方法。操作手册将为您提供使用Terraform步骤模板和创建资源组的能力。</p>

<h2 id="create-a-runbook">创建一本操作手册</h2>

<ol>
<li>导航到<strong>项目</strong>，选择<strong> <span class="path">操作➜操作手册</span> </strong>。</li>
<li>点击<strong>添加RUNBOOK </strong>。</li>
<li>创建一个runbook并将其命名为<strong> ResourceGroup </strong>。</li>
</ol>

<h2 id="add-steps-to-the-runbook">向操作手册添加步骤</h2>

<ol>
<li>导航到操作手册，选择<strong>流程</strong>，点击<strong>添加步骤。</strong></li>
<li>点击地形类别。</li>
<li>选择<strong>应用地形模板</strong>步骤。</li>
</ol>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-12/terraform-and-octopus-deploy-in-azure/images/6.png" class="zoom" data-title=""><img src="../Images/c8937a23dee9ab06a76a81bb0ae05186.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2020-12/terraform-and-octopus-deploy-in-azure/images/6.png"/>T2】</a></p>

<h3 id="configuring-the-terraform-step">配置Terraform步骤</h3>

<p>根据您运行的环境，这些步骤可能会有所不同。例如，您可以使用不同于默认的工作池。以下是Terraform要包括的关键步骤:</p>

<ol>
<li>在<strong>托管账户</strong>下，选择<strong> Azure账户</strong>并将您在<strong>身份验证中创建的Azure账户添加到从Azure </strong>部分的Octopus Deploy。</li>
<li>在<strong>模板</strong>下，选择<strong>模板源</strong>并使用<strong>源代码</strong>选项。然后粘贴以下代码:</li>
</ol>

<pre><code>provider "azurerm" {
  subscription_id = "#{subscriptionID}"
  client_id       = "#{clientID}"
  client_secret   = "#{clientSecret}"
  tenant_id       = "#{tenantID}"

  features        = {}
}

resource "azurerm_resource_group" "myterraformgroup" {
  name     = "#{resourceGroupName}"
  location = "#{location}"
}
</code></pre>

<p>如你所见，这使用了你在<strong>创建Octopus变量</strong>一节中创建的变量。</p>

<h2 id="executing-the-runbook">执行操作手册</h2>

<p>项目、身份验证、步骤和代码的配置都已完成。现在，是时候看看实际运行的代码了。</p>

<ol>
<li>在<strong>运行手册</strong>下，你会看到<strong>资源组</strong>运行手册。点击<strong>运行</strong>。</li>
<li>选择您想要运行runbook的环境，然后单击<strong>运行</strong>。</li>
</ol>

<p>runbook执行后，任务摘要将显示您已经使用Octopus Deploy和Terraform在Azure中成功创建了一个资源组。</p>

<h2 id="conclusion">结论</h2>

<p>将持续部署和基础设施作为代码结合起来是任何自动化环境的关键。它不仅为您提供了自动化，还为其他团队成员提供了一个协作、查看发生了什么以及理解流程的地方，而不是自己手动完成。</p>

                    
                    
</body>
</html>