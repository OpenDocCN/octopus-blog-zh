<html>
<head>
<title>Using AWS IAM roles in Octopus - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>在Octopus - Octopus部署中使用AWS IAM角色</h1>
<blockquote>原文：<a href="https://octopus.com/blog/aws-iam-roles#2021-08-12">https://octopus.com/blog/aws-iam-roles#2021-08-12</a></blockquote>
                        <p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-10/aws-iam-roles/blogimage-awsiam.png" class="zoom" data-title=""><img src="../Images/e5964169fc1c3b72249d2fec7d912bd1.png" class="img-fluid center" alt="Using AWS IAM roles in Octopus" data-original-src="https://i.octopus.com/blog/2020-10/aws-iam-roles/blogimage-awsiam.png"/>T2】</a></p>

<p>管理云提供商的凭证是一项挑战，尤其是当您考虑到您没有足够的物理安全性时，这意味着一个泄露的管理密钥就可以允许从世界任何地方访问您的整个帐户。云帐户也不能幸免于众所周知的“rm -rf”场景，即管理员帐户意外删除了他们不应该删除的资源。</p>

<p>IAM角色可用于提供特定于任务的授权，当角色被分配给EC2实例时，有权访问该VM的用户可以继承该角色。</p>

<p>在这篇博文中，我们将看看AWS中的IAM角色，并了解如何在Octopus中使用它们。</p>

<h2 id="create-a-role">创建一个角色</h2>

<p>可以在AWS IAM控制台中创建角色。当您创建一个新角色时，您将看到该角色将应用到的服务列表。在默认选择<strong> AWS服务</strong>的情况下，点击<strong> EC2 </strong>链接:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-10/aws-iam-roles/createrole.png" class="zoom" data-title=""><img src="../Images/da42b7f64f8428f814badf0925bca58c.png" class="img-fluid center" alt="Create role" data-original-src="https://i.octopus.com/blog/2020-10/aws-iam-roles/createrole.png"/>T2】</a></p>

<p>我们不会为该角色附加任何权限或标签，因此请跳到最后，为该角色命名并创建它:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-10/aws-iam-roles/finishcreaterole.png" class="zoom" data-title=""><img src="../Images/c07c8a5a69cc0d1da17bd38dab8cf6c2.png" class="img-fluid center" alt="Finish creating the role" data-original-src="https://i.octopus.com/blog/2020-10/aws-iam-roles/finishcreaterole.png"/>T2】</a></p>

<p>打开新创建的角色，点击<strong>信任关系</strong>选项卡，点击<strong>编辑信任关系</strong>:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-10/aws-iam-roles/trustrelationships.png" class="zoom" data-title=""><img src="../Images/abb610835a5eb8a6c797150800dbb675.png" class="img-fluid center" alt="Trust relationship" data-original-src="https://i.octopus.com/blog/2020-10/aws-iam-roles/trustrelationships.png"/>T2】</a></p>

<p>信任关系是一个JSON结构，它配置哪个服务或用户可以继承角色。因为我们在创建角色时选择了EC2服务，所以EC2服务被授予了承担该角色的能力:</p>

<pre><code>{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "Service": "ec2.amazonaws.com"
      },
      "Action": "sts:AssumeRole"
    }
  ]
}
</code></pre>

<h2 id="assign-a-role-to-an-ec2-instance">将角色分配给EC2实例</h2>

<p>在创建新的EC2实例时，可以将该角色分配给它:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-10/aws-iam-roles/ec2role.png" class="zoom" data-title=""><img src="../Images/6e00137b912a0d5ab2daf9ba2fb5db82.png" class="img-fluid center" alt="Assign a role to an EC2 instance" data-original-src="https://i.octopus.com/blog/2020-10/aws-iam-roles/ec2role.png"/></a>T2】</p>

<p>当您登录到这个实例时，可以从<a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html" rel="nofollow">实例元数据</a> HTTP接口获得分配给虚拟机的角色名称，命令如下:</p>

<pre><code>curl http://169.254.169.254/latest/meta-data/iam/security-credentials/
</code></pre>

<p>我们还可以通过AWS CLI使用以下命令来验证角色:</p>

<pre><code>aws sts get-caller-identity
</code></pre>

<p>在这两种情况下，我们都看到了角色<strong> mytestrole </strong>:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-10/aws-iam-roles/rolename.png" class="zoom" data-title=""><img src="../Images/24709c0703841e2920fc2ccf8806ab8c.png" class="img-fluid center" alt="Terminal output" data-original-src="https://i.octopus.com/blog/2020-10/aws-iam-roles/rolename.png"/>T2】</a></p>

<p>这意味着知道实例元数据HTTP接口的工具可以使用分配给EC2实例的角色进行操作。只要您能够访问VM，就可以使用关联的IAM角色与AWS进行交互。</p>

<p>AWS CLI是了解实例元数据的工具的一个例子，Octopus Tentacles和Workers是另一个例子。我们可以利用EC2 IAM角色和Octopus Workers在没有任何AWS凭证的情况下对AWS服务运行命令。</p>

<h2 id="ec2-as-octopus-worker">EC2作为八达通工人</h2>

<p>为了连接到Linux虚拟机，我们需要用创建虚拟机时使用的证书创建一个<strong> SSH密钥对</strong>帐户。对于使用Amazon AMIs创建的虚拟机，用户名为<strong> ec2-user </strong>:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-10/aws-iam-roles/keypairaccount.png" class="zoom" data-title=""><img src="../Images/ffd3760074f7d0138f10be068cca2092.png" class="img-fluid center" alt="Key pair account" data-original-src="https://i.octopus.com/blog/2020-10/aws-iam-roles/keypairaccount.png"/>T2】</a></p>

<p>然后，我们可以创建一个SSH工作线程并连接到虚拟机:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-10/aws-iam-roles/worker.png" class="zoom" data-title=""><img src="../Images/f19df8b67c073ae9eb68b1858ec28204.png" class="img-fluid center" alt="Creating a Worker" data-original-src="https://i.octopus.com/blog/2020-10/aws-iam-roles/worker.png"/>T2】</a></p>

<p>现在，我们可以添加一个<strong>运行AWS CLI脚本</strong>步骤，设置脚本在包含我们刚刚创建的worker的Worker池上运行，并选择选项<strong>使用AWS服务角色执行EC2实例</strong>:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-10/aws-iam-roles/awsscriptstepauth.png" class="zoom" data-title=""><img src="../Images/c16a3bc1ec13f62d8a8ebea79addddbc.png" class="img-fluid center" alt="AWS service role" data-original-src="https://i.octopus.com/blog/2020-10/aws-iam-roles/awsscriptstepauth.png"/>T2】</a></p>

<p>现在，如果我们在这个脚本中运行命令<code>aws sts get-caller-identity</code>，我们会看到与之前相同的结果:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-10/aws-iam-roles/awscriptresult.png" class="zoom" data-title=""><img src="../Images/4b7b1d1fd8d572fd9b33b07dbb67fc44.png" class="img-fluid center" alt="Task log" data-original-src="https://i.octopus.com/blog/2020-10/aws-iam-roles/awscriptresult.png"/>T2】</a></p>

<p>我们现在能够执行部署和脚本，而不需要通过Worker和IAM角色共享AWS凭据，它从底层虚拟机中承担IAM角色。</p>

<h2 id="assuming-roles-for-kubernetes-targets">承担Kubernetes目标的角色</h2>

<p>使用Octopus 2020.4.0，还可以使用与虚拟机关联的IAM角色与EKS集群进行交互。</p>

<p>但是，为了让IAM角色在Kubernetes集群中拥有任何权限，我们需要将IAM角色映射到Kubernetes角色。这个映射是在<code>kube-system</code>名称空间中的<code>aws-auth</code>配置映射中完成的。</p>

<p>该文件的默认内容类似于下面的例子。但是，请注意，现有的角色映射特定于每个EKS集群，因为它允许分配给节点的角色访问集群。您需要从集群中修改配置映射，而不是复制并粘贴如下所示的配置映射，因为直接使用此示例会导致错误:</p>

<pre><code class="language-YAML">apiVersion: v1
data:
  mapRoles: |
    - groups:
      - system:bootstrappers
      - system:nodes
      rolearn: arn:aws:iam::968802670493:role/eksctl-k8s-cluster-nodegroup-ng-1-NodeInstanceRole-1FI6JXPS9MDWK
      username: system:node:{{EC2PrivateDNSName}}
  mapUsers: |
    []
kind: ConfigMap
metadata:
  name: aws-auth
  namespace: kube-system
</code></pre>

<p>在我的例子中，我在<code>mytestrole</code> IAM角色和Kubernetes <code>system:masters</code>角色之间添加了一个新的角色映射:</p>

<pre><code class="language-YAML">apiVersion: v1
data:
  mapRoles: |
    - groups:
      - system:bootstrappers
      - system:nodes
      rolearn: arn:aws:iam::968802670493:role/eksctl-k8s-cluster-nodegroup-ng-1-NodeInstanceRole-1FI6JXPS9MDWK
      username: system:node:{{EC2PrivateDNSName}}
    - rolearn: arn:aws:iam::968802670493:role/mytestrole
      username: admin
      groups:
        - system:masters
  mapUsers: |
    []
kind: ConfigMap
metadata:
  name: aws-auth
  namespace: kube-system
</code></pre>

<p>在应用了这个配置映射之后，我们可以使用EC2实例的AWS服务角色将我们的Kubernetes目标配置为<strong>执行</strong>:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-10/aws-iam-roles/eksiamrole.png" class="zoom" data-title=""><img src="../Images/5fe2492a45acd2eedf98fd5e81c99e05.png" class="img-fluid center" alt="EKS IAM Role" data-original-src="https://i.octopus.com/blog/2020-10/aws-iam-roles/eksiamrole.png"/>T2】</a></p>

<p>我们还需要确保目标使用Worker连接到应用了IAM角色的EC2实例:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-10/aws-iam-roles/eksworker.png" class="zoom" data-title=""><img src="../Images/9241d754887fa24a5c96d528efb0610e.png" class="img-fluid center" alt="EKS Worker" data-original-src="https://i.octopus.com/blog/2020-10/aws-iam-roles/eksworker.png"/>T2】</a></p>

<p>我们的Kubernetes目标现在将在没有任何AWS凭证的情况下完成运行状况检查，取而代之的是，使用分配给虚拟机的IAM角色，工作人员连接到:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2020-10/aws-iam-roles/ekshealth.png" class="zoom" data-title=""><img src="../Images/5fdcf30cf7310d0a1fb7b6f0e1ac6d5b.png" class="img-fluid center" alt="EKS health check" data-original-src="https://i.octopus.com/blog/2020-10/aws-iam-roles/ekshealth.png"/></a>T2】</p>

<h2 id="conclusion">结论</h2>

<p>在本文中，我们创建了一个可以分配给EC2实例的IAM角色。我们登录到EC2实例，并验证AWS CLI显示本地用户具有EC2角色。然后，我们将一个Worker连接到EC2实例，并从Octopus运行AWS CLI脚本和Kubernetes健康检查，Octopus还承担了分配给EC2实例的角色。</p>

<p>为EC2实例分配角色是消除共享AWS凭证需求的一种便捷方式，在Octopus 2020.4中，在steps和Kubernetes目标中提供了对承担这些角色的完全支持。</p>

                    
                    
</body>
</html>