<html>
<head>
<title>Running SQL Server Developer in a Windows-based Docker Container - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>在基于Windows的Docker容器中运行SQL Server Developer-Octopus Deploy</h1>
<blockquote>原文：<a href="https://octopus.com/blog/running-sql-server-developer-install-with-docker#2021-08-12">https://octopus.com/blog/running-sql-server-developer-install-with-docker#2021-08-12</a></blockquote>
                        <p><a href="#" data-featherlight="https://i.octopus.com/blog/2019-09/running-sql-server-developer-install-with-docker/sql_docker_container_2019.png" class="zoom" data-title=""><img src="../Images/2cbb27b47474982584d4cc36a0d2ad70.png" class="img-fluid center" alt="SQL Server database in a Docker container on a desert island with a Docker container ship in the background" data-original-src="https://i.octopus.com/blog/2019-09/running-sql-server-developer-install-with-docker/sql_docker_container_2019.png"/>T2】</a></p>

<p>在开发机器上运行SQL Server是自动化数据库部署的一个关键部分。通常，在本地运行SQL Server是通过<a href="https://octopus.com/blog/automate-sql-server-install">安装SQL Server Developer edition </a>来完成的。这样做的缺点是SQL Server Windows服务需要一直运行，这会消耗资源，安装程序会添加一堆额外的应用程序，开发人员负责升级它。</p>

<p>有可能两全其美吗？在本地运行SQL Server，但仅在需要时运行，并使其易于升级？很长一段时间以来，SQL Server一直是Docker映像，看起来它可以解决这些令人头痛的问题。真正的问题是，建立起来有多难？在本文中，我旨在回答这个问题，并帮助您让SQL Server在Docker容器中运行。</p>



<h2 id="windows-based-containers">基于Windows的容器</h2>

<p>我从大学开始就一直在Windows上开发。我知道Linux的核心概念，但我绝不是专家。同时学习Linux和Docker是一件很困难的事情。Docker提供了运行基于Linux和Windows的容器的能力。微软为SQL Server Developer Edition 提供了一个<a href="https://hub.docker.com/r/microsoft/mssql-server-windows-developer" rel="nofollow">基于Windows的容器，所以为了让学习更容易，我将在本文中使用这个容器。</a></p>

<h2 id="prep-work">准备工作</h2>

<p>本文假设您对Docker有一定的了解。如果你不熟悉Docker的核心概念，我鼓励你阅读<a href="https://docs.docker.com/engine/docker-overview/" rel="nofollow"> Docker概述页面</a>。</p>

<p>我的笔记本电脑运行的是Windows 10专业版。我将使用Docker桌面，有时被称为Docker for Windows。在我开始使用Docker之前，需要做一些准备工作。</p>

<h3 id="enable-cpu-virtualization">启用CPU虚拟化</h3>

<p>归根结底，Docker是一个虚拟化主机。就像任何其他虚拟化主机一样，CPU必须支持虚拟化，并且必须启用该功能。通常情况下，虚拟化是在BIOS中启用的，这意味着您必须在Google上搜索如何在您的计算机制造商的BIOS中启用它。英特尔称他们的虚拟化技术<a href="https://www.intel.com/content/www/us/en/virtualization/virtualization-technology/intel-virtualization-technology.html" rel="nofollow">为英特尔VT </a>，以及英特尔VTx。AMD称他们的虚拟化技术为<a href="https://www.amd.com/en/technologies/virtualization" rel="nofollow"> AMD V </a>，有时你会看到它被称为VDI或SVM。</p>

<h3 id="installing-docker-for-windows">安装Docker for Windows</h3>

<p>在快速BIOS更新之后，是时候安装Docker Desktop了，它包括Docker Compose和Docker CLI。安装Docker for Windows的整个过程被很好地记录了下来。无需在此重复。</p>

<p>有一点要注意，如果你没有启用Hyper-V，安装程序会为你启用它。那将需要重新启动计算机。</p>

<p>如前所述，我将使用基于Windows的容器。安装Docker桌面后，我需要切换到Windows容器。右键单击任务栏中的Docker桌面图标并选择<code>Switch to Windows containers...</code>即可完成。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2019-09/running-sql-server-developer-install-with-docker/docker-desktop-switch-to-windows-containers.png" class="zoom" data-title=""><img src="../Images/5c372fbac5472fc7b15d5290c68bc1dc.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2019-09/running-sql-server-developer-install-with-docker/docker-desktop-switch-to-windows-containers.png"/>T2】</a></p>

<h3 id="setting-up-folders-to-share-with-docker-containers">设置文件夹以与Docker容器共享</h3>

<p>默认情况下，Docker将所有容器视为无状态的。预计对容器所做的任何更改(如创建数据库)都将被销毁。这个问题可以通过利用Docker中的卷来解决。我在硬盘上建立了一个文件夹C:\Docker\Volumes来存储这些卷。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2019-09/running-sql-server-developer-install-with-docker/docker-shared-folders.png" class="zoom" data-title=""><img src="../Images/39eaec4f5d8e81db78e688ca0c24d406.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2019-09/running-sql-server-developer-install-with-docker/docker-shared-folders.png"/>T2】</a></p>

<p>值得注意的是，如果我将这些作为基于Linux的容器运行，我需要遵循<a href="https://docs.docker.com/docker-for-windows/#shared-drives" rel="nofollow"> Docker文档中列出的关于共享驱动器的步骤</a>。</p>

<h3 id="anti-virus-configuration">防病毒配置</h3>

<p>运行Windows容器的一个缺点是(除了空间开销之外)，反病毒软件可能会阻止它们下载。发生这种阻塞是因为Docker在Windows文件系统上存储图像的方式。实际上，另一个名为Windows的文件夹将出现在一个看似随机的位置。当反病毒扫描仪发现它们时。确保您使用的是最新版本的防病毒软件。如果你不得不将<code>C:\ProgramData\Docker</code>排除在扫描之外，不要感到惊讶。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2019-09/running-sql-server-developer-install-with-docker/extracted-docker-files-windows.png" class="zoom" data-title=""><img src="../Images/cf2e765917ccd6f998bdc32527286c11.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2019-09/running-sql-server-developer-install-with-docker/extracted-docker-files-windows.png"/>T2】</a></p>

<h2 id="configuring-the-sql-server-developer-container">配置SQL Server开发人员容器</h2>

<p>启动并运行一个容器很容易，甚至是SQL Server。我想将它用于实际的开发工作，这意味着我需要解决以下问题:</p>

<ol>
<li>无需额外配置即可启动并运行容器。</li>
<li>通过SSMS连接到它。</li>
<li>持久化在容器中创建的数据库。</li>
<li>保存映像配置供他人使用。</li>
</ol>

<h3 id="running-sql-server-developer-container-for-the-first-time">首次运行SQL Server Developer容器</h3>

<p>这份清单看起来令人望而生畏，尤其是如果你是Docker的新手。我想一步一步来。首先，让我们运行一个简单的命令，从Docker Hub下载SQL Server Windows开发人员映像:</p>

<pre><code class="language-PowerShell">docker pull microsoft/mssql-server-windows-developer
</code></pre>

<p>如果你是一步一步地跟着做，沏些茶或咖啡，然后坐下来，因为这可能需要一段时间来完成。它不仅下载该映像，还下载所有的依赖项。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2019-09/running-sql-server-developer-install-with-docker/docker-download-sql-server.png" class="zoom" data-title=""><img src="../Images/e1dcdc67060c057ab9f276209f2a9532.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2019-09/running-sql-server-developer-install-with-docker/docker-download-sql-server.png"/>T2】</a></p>

<p>既然已经下载了映像，现在是启动它并运行一些SQL脚本的时候了。幸运的是，微软添加到Docker Hub 的文档<a href="https://hub.docker.com/r/microsoft/mssql-server-windows-developer" rel="nofollow">让这变得很容易。请记下正在发送的<code>--name</code>参数。该参数将使以后的工作更加容易。在命名实例的同时，我将端口设置为默认的SQL Server端口，<code>1433</code>:</a></p>

<pre><code class="language-PowerShell">docker run --name SQLServer -d -p 1433:1433 -e sa_password=Password_01 -e ACCEPT_EULA=Y microsoft/mssql-server-windows-developer
</code></pre>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2019-09/running-sql-server-developer-install-with-docker/docker-run-sql-server-developer.png" class="zoom" data-title=""><img src="../Images/333fbfac32fc674bcebcf2d1a965e755.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2019-09/running-sql-server-developer-install-with-docker/docker-run-sql-server-developer.png"/>T2】</a></p>

<h3 id="connecting-to-the-container-from-ssms-on-the-host">从主机上的SSMS连接到容器</h3>

<p>SQL Server容器正在运行，但是我们如何从主机通过SSMS连接到它呢？在run命令中，我使用了开关<code>-p</code>，它是publish的缩写。本质上，端口1433被发布给主机，这意味着我们可以通过<code>localhost</code>访问它。要将SSMS连接到我的Docker SQL Sever，我需要做的就是输入<code>localhost</code>，以及上面定义的用户名/密码<code>sa</code>。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2019-09/running-sql-server-developer-install-with-docker/ssms-connected-to-docker-image.png" class="zoom" data-title=""><img src="../Images/ced1ead5631e3aecab705fae3e7489f7.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2019-09/running-sql-server-developer-install-with-docker/ssms-connected-to-docker-image.png"/>T2】</a></p>

<p>就像普通的SQL Server一样，一切都按预期运行。我可以毫无问题地创建一个数据库和表格。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2019-09/running-sql-server-developer-install-with-docker/create-table-inside-instance.png" class="zoom" data-title=""><img src="../Images/b0ffa87013da3a44462a2e4d264798ce.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2019-09/running-sql-server-developer-install-with-docker/create-table-inside-instance.png"/>T2】</a></p>

<h3 id="persisting-databases-created-in-a-container">持久化在容器中创建的数据库</h3>

<p>如果容器需要重启会怎么样？</p>

<pre><code class="language-PowerShell">docker stop SQLServer
docker start SQLServer
</code></pre>

<p>重启后，数据库和所有表仍然存在。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2019-09/running-sql-server-developer-install-with-docker/test-database-after-restart-only.png" class="zoom" data-title=""><img src="../Images/8eb1715d7e0ed8faf9714edb72844bd9.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2019-09/running-sql-server-developer-install-with-docker/test-database-after-restart-only.png"/>T2】</a></p>

<p>如果需要重新创建容器呢？通常，这是在容器配置更改或发布新版本时完成的。除了<code>stop</code>命令，我还需要运行<code>rm</code>命令来删除容器:</p>

<pre><code class="language-PowerShell">docker stop SQLServer
docker rm SQLServer
docker run --name SQLServer -d -p 1433:1433 -e sa_password=Password_01 -e ACCEPT_EULA=Y microsoft/mssql-server-windows-developer
</code></pre>

<p>在这种情况下，所有数据库都被删除了。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2019-09/running-sql-server-developer-install-with-docker/restart-container-no-new-databases.png" class="zoom" data-title=""><img src="../Images/8aa4b7041d6aef935b8029fb3772aafa.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2019-09/running-sql-server-developer-install-with-docker/restart-container-no-new-databases.png"/>T2】</a></p>

<p>我们需要一种持久化数据的方法来处理容器的重启和容器的重建。</p>

<p>数据库文件需要持久化。这是使用卷完成的，将指向<code>C:\Docker \Volumes\SQLServer</code>。还有<a href="https://blog.sixeyed.com/docker-volumes-on-windows-the-case-of-the-g-drive/" rel="nofollow">多</a>，<a href="https://github.com/docker/labs/blob/master/windows/sql-server/part-3.md" rel="nofollow">多</a>篇关于<a href="https://docs.docker.com/storage/volumes/" rel="nofollow"> Docker卷</a>。TL；DR；就是把<code>--volume</code>开关加到<code>docker run</code>来加一个卷。如果容器已经在运行，则需要在添加卷之前将其销毁:</p>

<pre><code class="language-PowerShell">docker stop SQLServer
docker rm SQLServer
docker run --name SQLServer -d -p 1433:1433 --volume c:\Docker\Volumes\SQLServer:c:\SQLData -e sa_password=Password_01 -e ACCEPT_EULA=Y microsoft/mssql-server-windows-developer
</code></pre>

<p>所有数据库创建命令都需要指定<code>C:\SQLData\</code>作为数据的目录。假设我希望这个SQL Server容器托管Octopus Deploy和TeamCity的数据库。这些命令是:</p>

<pre><code class="language-SQL">CREATE DATABASE [OctopusDeploy]
 CONTAINMENT = NONE
 ON  PRIMARY
( NAME = N'OctopusDeploy', FILENAME = N'C:\SQLData\OctopusDeploy.mdf' , SIZE = 8192KB , FILEGROWTH = 65536KB )
 LOG ON
( NAME = N'OctopusDeploy_log', FILENAME = N'C:\SQLData\OctopusDeploy_log.ldf' , SIZE = 8192KB , FILEGROWTH = 65536KB )
GO
CREATE DATABASE [TeamCity]
 CONTAINMENT = NONE
 ON  PRIMARY
( NAME = N'TeamCity', FILENAME = N'C:\SQLData\TeamCity.mdf' , SIZE = 8192KB , FILEGROWTH = 65536KB )
 LOG ON
( NAME = N'TeamCity_log', FILENAME = N'C:\SQLData\TeamCity_log.ldf' , SIZE = 8192KB , FILEGROWTH = 65536KB )
GO
</code></pre>

<p>毫无疑问，数据库创建成功。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2019-09/running-sql-server-developer-install-with-docker/create-teamcity-octopus-databases.png" class="zoom" data-title=""><img src="../Images/5673da8872018a061f0dfa9f464e1e74.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2019-09/running-sql-server-developer-install-with-docker/create-teamcity-octopus-databases.png"/>T2】</a></p>

<p>它们现在显示在主机系统的目录中。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2019-09/running-sql-server-developer-install-with-docker/sql-server-volume.png" class="zoom" data-title=""><img src="../Images/7268496d2bf9d6ffcb6f75d25d679dac.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2019-09/running-sql-server-developer-install-with-docker/sql-server-volume.png"/>T2】</a></p>

<p>这些数据库的名称和路径可以使用<code>attach_dbs</code>环境变量传递给容器。可以使用PowerShell脚本引导所有这一切。对于本文，我没有这样做，因为我只需要创建数据库一次。我看不出花费精力写一个脚本来解决一个我只需要做一次的问题有什么意义。</p>

<pre><code class="language-PowerShell">docker stop SQLServer
docker rm SQLServer
$attachDbs = "[{'dbName':'OctopusDeploy','dbFiles':['C:\\SQLData\\OctopusDeploy.mdf','C:\\SQLData\\OctopusDeploy_log.ldf']},{'dbName':'TeamCity','dbFiles':['C:\\SQLData\\TeamCity.mdf','C:\\SQLData\\TeamCity_log.ldf']}]"
docker run --name SQLServer -d -p 1433:1433 --volume c:\Docker\Volumes\SQLServer:c:\SQLData -e sa_password=Password_01 -e ACCEPT_EULA=Y -e attach_dbs=$attachDbs microsoft/mssql-server-windows-developer
</code></pre>

<p>现在，当重新创建容器时，这些数据库被装载。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2019-09/running-sql-server-developer-install-with-docker/attach-dbs-with-sql-server.png" class="zoom" data-title=""><img src="../Images/428e5cfc0783cd2d4c06c7fc8db007d9.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2019-09/running-sql-server-developer-install-with-docker/attach-dbs-with-sql-server.png"/>T2】</a></p>

<h3 id="saving-the-configuration-in-docker-compose">在Docker Compose中保存配置</h3>

<p>到目前为止，我一直在大量使用命令行，特别是<code>docker stop</code>、<code>docker rm</code>和<code>docker run</code>。老实说，我一直在复制和粘贴上面的命令，而不是重新键入它们。一种选择是利用<a href="https://docs.docker.com/compose/" rel="nofollow"> Docker Compose </a>。Docker容器配置存储在YAML文件中，而不是脚本文件中。</p>

<pre><code class="language-YAML">version: '3.7'
services:
  SQLServer:
   image: microsoft/mssql-server-windows-developer
   environment:
     - ACCEPT_EULA=Y
     - SA_PASSWORD=Password_01   
     - attach_dbs=[{'dbName':'OctopusDeploy','dbFiles':['C:\\SQLData\\OctopusDeploy.mdf','C:\\SQLData\\OctopusDeploy_log.ldf']},{'dbName':'TeamCity','dbFiles':['C:\\SQLData\\TeamCity.mdf','C:\\SQLData\\TeamCity_log.ldf']}]
   ports:
     - '1433:1433'
   volumes:
     - c:\Docker\Volumes\SQLServer:c:\SQLData
</code></pre>

<p>我将docker-compose文件保存在硬盘上C:\Docker文件夹中:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2019-09/running-sql-server-developer-install-with-docker/docker-compose-file.png" class="zoom" data-title=""><img src="../Images/48ce1d35fdd55dfd92550664ef8fe3d7.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2019-09/running-sql-server-developer-install-with-docker/docker-compose-file.png"/>T2】</a></p>

<p>然后我在PowerShell中运行了这个命令:</p>

<pre><code class="language-PowerShell">Set-Location C:\Docker
docker-compose up -d
</code></pre>

<p>我得到了同样的结果。我更喜欢用这个，因为它更容易阅读，因此也更容易修改。跑起来也很轻松。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2019-09/running-sql-server-developer-install-with-docker/docker-compose-ssms-sucess.png" class="zoom" data-title=""><img src="../Images/d2dbec14d31416ed9352a6499d2f98f8.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2019-09/running-sql-server-developer-install-with-docker/docker-compose-ssms-sucess.png"/>T2】</a></p>

<h2 id="conclusion">结论</h2>

<p>让SQL Server在Docker中运行比我想象的要容易得多。我期待着一小时又一小时的工作，但最终，我在一小时内就完成了一些工作。公平地说，这不包括对Docker如何工作的研究。我的希望是这篇文章给了你足够的指导，让你自己深入Docker，并意识到它并没有那么大和可怕。也许，仅仅是也许，您将使用Docker在您的开发机器上托管SQL Server，而不是安装SQL Server Developer。</p>

<p>下次再见，愉快的部署！</p>

                    
                    
</body>
</html>