<html>
<head>
<title>Deploy SQL Server DACPAC with Octopus Deploy - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>使用Octopus Deploy - Octopus Deploy部署SQL Server DACPAC</h1>
<blockquote>原文：<a href="https://octopus.com/blog/deploying-sql-server-dacpac-octopus#2021-12-16">https://octopus.com/blog/deploying-sql-server-dacpac-octopus#2021-12-16</a></blockquote>
                        <p>数据库管理员(DBA)常常一提到自动化数据库部署就畏缩不前。他们的工作是确保服务器和数据库保持可用和健康，不受他们控制的进程会让他们紧张。引入自动对数据库结构或数据进行大规模修改的过程似乎与他们的职责形成了鲜明的对比。但是，使用带有Octopus Deploy的DACPAC来自动部署到SQL Server可以帮助您完成开发运维之旅。</p>

<p>这篇文章向您展示了如何使用DACPAC和Octopus Deploy从项目创建到部署自动化数据库更新到Microsoft SQL Server。</p>

<h2 id="sample-project-sakila">示例项目:Sakila</h2>

<p>这篇文章将把<a href="https://bitbucket.org/octopussamples/sakila/src/master/src/dacpac/mssql/" rel="nofollow"> Sakila </a>数据库部署到一个Microsoft SQL服务器上。</p>

<p>Sakila项目包含表、约束、存储过程、视图和用户定义的函数，以展示Microsoft DACPAC技术的全部功能。</p>

<p>Sakila Git repo包含使用不同部署方法将Sakila数据库部署到多种数据库技术的源代码。这篇文章特别关注微软的DACPAC版本。</p>


<h2 id="creating-the-database-project">创建数据库项目</h2>

<p>SQL Server数据库项目类型不是Visual Studio自带的。要创建它，您必须安装<a href="https://docs.microsoft.com/en-us/sql/ssdt/download-sql-server-data-tools-ssdt" rel="nofollow"> SQL Server数据工具</a> (SSDT)扩展。SSDT包含数据库项目、SQL Server Reporting Services(SSRS)项目和SQL Server Integration Services(SSIS)项目的项目类型。</p>

<p>安装完扩展后，创建一个新项目，并选择SQL Server类别、SQL Server数据库项目类型。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-12/deploying-sql-server-dacpac-octopus/visual-studio-new-project.png" class="zoom" data-title=""><img src="../Images/83502b667f4a6ffdd9281a6b5373b360.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2021-12/deploying-sql-server-dacpac-octopus/visual-studio-new-project.png"/>T2】</a></p>

<p>右键点击<strong>解</strong>空间，选择<strong>导入</strong>，然后选择<strong>数据库...</strong>连接到现有数据库:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-12/deploying-sql-server-dacpac-octopus/visual-studio-import-database.png" class="zoom" data-title=""><img src="../Images/314fa5bb6056f21bc70ee5a6666a44de.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2021-12/deploying-sql-server-dacpac-octopus/visual-studio-import-database.png"/>T2】</a></p>

<p>配置一个连接，然后点击<strong>开始</strong>。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-12/deploying-sql-server-dacpac-octopus/visual-studio-connect-database.png" class="zoom" data-title=""><img src="../Images/8f26adce1344412c7d372468a28fd36b.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2021-12/deploying-sql-server-dacpac-octopus/visual-studio-connect-database.png"/>T2】</a></p>

<p>该过程完成后，您的项目应该如下所示:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-12/deploying-sql-server-dacpac-octopus/visual-studio-database-imported.png" class="zoom" data-title=""><img src="../Images/e55e424fbc78203bf0977f373c68015d.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2021-12/deploying-sql-server-dacpac-octopus/visual-studio-database-imported.png"/>T2】</a></p>

<h2 id="creating-the-build">创建构建</h2>

<p>在创建生成之前，首先确保您的生成代理已配置为生成SQL Server数据库项目。除了SSRS项目之外，MSBuild无法生成SSDT项目。您的生成代理至少需要满足以下要求:</p>



<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-12/deploying-sql-server-dacpac-octopus/visual-studio-build-tools.png" class="zoom" data-title=""><img src="../Images/e447ca19dcd596022dd945f1adbf0ab2.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2021-12/deploying-sql-server-dacpac-octopus/visual-studio-build-tools.png"/>T2】</a></p>

<p>本节的剩余部分使用Microsoft Azure DevOps来配置构建。如果您使用的是不同的构建服务器，只要构建代理安装了上述工具，您就应该能够做同样的事情。</p>

<p>构建将包括以下步骤:</p>

<ul>
<li>构建DACPAC解决方案</li>
<li>打包文件</li>
<li>推送构建信息</li>
<li>将包装推到包装进料口</li>
</ul>

<h3 id="building-the-dacpac-solution">构建DACPAC解决方案</h3>

<p>向您的构建管道添加一个<strong> Visual Studio构建</strong>步骤。将clean设置为<code>true</code>将确保在进行后续构建时，文件夹中没有任何剩余的工件。</p>

<pre><code class="language-yaml">- task: VSBuild@1
  inputs:
    solution: 'dacpac\mssql\sakila.mssql.dacpac.sln'
    msbuildArgs: '/p:OutDir=$(build.stagingdirectory)'
    clean: true
</code></pre>

<h3 id="packaging-files">打包文件</h3>

<p>将Octopus 步骤的<strong>包应用程序添加到管道中。这将压缩<code>.dacpac</code>文件，以便Octopus Deploy可以部署它。包括。dacpac文件和发布配置文件XML文件。</strong></p>

<pre><code class="language-yaml">- task: OctopusPack@4
  inputs:
    PackageId: 'sakila.dacpac'
    PackageFormat: 'Zip'
    PackageVersion: '$(Build.BuildNumber)'
    SourcePath: '$(build.stagingdirectory)'
    OutputPath: '$(Build.ArtifactStagingDirectory)'
    Include: |
      sakila.mssql.dacpac.dacpac
      sakila.mssql.dacpac.publish.xml
</code></pre>

<h3 id="pushing-build-information">推送构建信息</h3>

<p>查看与这个构建相关联的提交和工作项是很有用的。将<strong>推送包构建信息添加到Octopus部署</strong>。</p>

<pre><code class="language-yaml">- task: OctopusMetadata@4
  inputs:
    OctoConnectedServiceName: 'Local Octopus Deploy'
    Space: 'Spaces-1'
    PackageId: 'sakila.dacpac'
    PackageVersion: '$(Build.BuildNumber)'
    Replace: 'false'
</code></pre>

<p>使用Azure DevOps assistant，您可以配置此步骤中使用的<code>OctoConnectedServiceName</code>。</p>


<h3 id="pushing-the-package-to-the-package-feed">将包装推到包装进料口</h3>

<p>构建过程的最后一步是将包推送到存储库。这篇文章将使用Octopus Deploy的内置库，但是也支持其他外部提要类型，包括Azure DevOps、Artifactory、Nexus等等。</p>

<pre><code class="language-yaml">- task: OctopusPush@4
  inputs:
    OctoConnectedServiceName: 'Local Octopus Deploy'
    Space: 'Spaces-1'
    Package: '$(Build.ArtifactStagingDirectory)\*.zip'
    Replace: 'false'
</code></pre>

<p>完整的YAML管道将类似于此:</p>

<pre><code class="language-yaml">trigger:
- master

pool: Default

steps:
- task: VSBuild@1
  inputs:
    solution: 'dacpac\mssql\sakila.mssql.dacpac.sln'
    msbuildArgs: '/p:OutDir=$(build.stagingdirectory)'
    clean: true

- task: OctopusMetadata@4
  inputs:
    OctoConnectedServiceName: 'Local Octopus Deploy'
    Space: 'Spaces-1'
    PackageId: 'sakila.dacpac'
    PackageVersion: '$(Build.BuildNumber)'
    Replace: 'false'
- task: OctopusPack@4
  inputs:
    PackageId: 'sakila.dacpac'
    PackageFormat: 'Zip'
    PackageVersion: '$(Build.BuildNumber)'
    SourcePath: '$(build.stagingdirectory)'
    OutputPath: '$(Build.ArtifactStagingDirectory)'
    Include: |
      sakila.mssql.dacpac.dacpac
      sakila.mssql.dacpac.publish.xml
- task: OctopusPush@4
  inputs:
    OctoConnectedServiceName: 'Local Octopus Deploy'
    Space: 'Spaces-1'
    Package: '$(Build.ArtifactStagingDirectory)\*.zip'
    Replace: 'false'
</code></pre>

<h2 id="creating-the-deployment-process">创建部署流程</h2>

<p>这篇文章假设你知道如何创建一个Octopus项目，但并不涉及这个主题。</p>

<p>DACPAC部署流程包括以下步骤:</p>

<ul>
<li><strong>(可选)如果数据库不存在，则创建数据库</strong>:有些人喜欢将此活动放在操作手册中，而不是作为部署过程的一部分。</li>
<li>将DACPAC部署到SQL Server。</li>
</ul>

<h3 id="optional-create-the-database-if-it-doesnt-exist">(可选)如果数据库不存在，则创建该数据库</h3>

<p>这一步连接到一个SQL server并创建一个数据库(如果它不存在的话)。点击<strong>添加步骤</strong>，选择<strong> SQL -如果不存在则创建数据库</strong>。该步骤可以在工作机上运行。</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-12/deploying-sql-server-dacpac-octopus/octopus-add-create-database.png" class="zoom" data-title=""><img src="../Images/66a7e6cbb0eb18fb66cafb72639f6e77.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2021-12/deploying-sql-server-dacpac-octopus/octopus-add-create-database.png"/>T2】</a></p>

<p>填写模板字段:</p>

<ul>
<li><strong> SQL Server </strong>:服务器名称。</li>
<li><strong> SQL登录</strong> : SQL认证用户名，如果使用Active Directory认证，则留空。</li>
<li><strong> SQL密码</strong>:SQL认证账户的密码，如果使用Active Directory认证，则留空。</li>
<li><strong>要创建的数据库</strong>:要创建的数据库名称。</li>
<li><strong>命令超时</strong>:等待创建数据库命令完成的秒数。</li>
<li>Azure数据库版本:如果你正在使用Azure SQL，选择要创建的版本。如果留空(并使用Azure SQL)，Azure将默认为Standard。</li>
</ul>

<h3 id="deploying-the-dacpac-to-sql-server">将DACPAC部署到SQL Server</h3>

<p>有几个DACPAC社区步骤模板可供选择:</p>

<ul>
<li><strong> SQL - Deploy DACPAC </strong>:这个版本的模板是在Octopus Deploy的Workers特性可用之前创建的。该模板必须在目标上执行，并且需要一个<strong>部署包</strong>步骤，首先将DACPAC部署到目标上。</li>
<li><strong>SQL-Deploy DAC PAC from Package Parameter</strong>:该模板与Worker兼容，使用内置的包选择器。此外，该模板可以动态下载SQL PowerShell模块(如果选择的话),并且不需要在工作机器上安装任何附加软件。</li>
<li><strong>SQL-Deploy DACPAC from Referenced Package</strong>:该模板使用两个包，一个包含执行DACPAC部署所需的二进制文件，另一个是DAC PAC本身。</li>
<li><strong>SQL-Deploy DAC PAC with AAD Auth support</strong>:这是最新的可用模板，包含使用Azure Active Directory认证数据库服务器的能力(这篇博文演示了<a href="https://octopus.com/blog/classes-in-custom-step-templates">如何配置步骤模板</a>)。</li>
</ul>

<p>所有四个模板在如何部署DACPAC方面包含相同的基本功能，但是，它们是单独开发的，以避免给使用模板的人带来破坏性的变化。这篇文章使用了最新的模板，<strong>SQL Deploy DAC PAC with AAD support</strong>。</p>

<p>所有四个模板都支持使用SQL CMD变量。因为可以有N个SQL CMD变量，所以模板中没有输入字段来定义它们。相反，模板代码在Octopus变量集合中查询以特定约定命名的变量:</p>
<ul>
<li><code>SqlCmdVariable.Variable1</code></li>
<li><code>my.sqlcmdvariable.variable2</code></li>
</ul>
<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-12/deploying-sql-server-dacpac-octopus/octopus-sql-cmd-variables-project-variables.png" class="zoom" data-title=""><img src="../Images/554c4e4b5dd60d360cb0ed8426120da3.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2021-12/deploying-sql-server-dacpac-octopus/octopus-sql-cmd-variables-project-variables.png"/>T2】</a></p>
<p>在部署过程中，当被添加时，您会看到如下内容:</p>
<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-12/deploying-sql-server-dacpac-octopus/octopus-sql-cmd-variables-log.png" class="zoom" data-title=""><img src="../Images/a299ddde755313f99da0ed8b22f3c2d3.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2021-12/deploying-sql-server-dacpac-octopus/octopus-sql-cmd-variables-log.png"/>T2】</a></p>


<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-12/deploying-sql-server-dacpac-octopus/octopus-add-deploy-dacpac.png" class="zoom" data-title=""><img src="../Images/faac0798068560d566fa56507f6571c2.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2021-12/deploying-sql-server-dacpac-octopus/octopus-add-deploy-dacpac.png"/>T2】</a></p>

<p>填写模板字段:</p>

<ul>
<li><strong>dapacpackagename</strong>:包中<code>.dacpac</code>文件的名称。对于这个帖子，是<code>sakila.mssql.dacpac.dacpac</code>。</li>
<li><strong>(可选)发布概要文件名</strong>:发布概要XML文件的名称。对于这个帖子，它是<code>sakila.mssql.dacpac.publish.xml</code>。</li>
<li><strong>报告</strong>:勾选这个框，生成一个HTML报告，报告将要进行的更改。</li>
<li><strong>脚本</strong>:勾选此框，生成一个包含将要执行的SQL的<code>.sql</code>文件。</li>
<li><strong>展开</strong>:勾选此框进行展开。</li>
<li><strong>将目标数据库提取到dacpac </strong>:勾选此框，将目标数据库提取到dacpac，并将其作为工件添加。</li>
<li><strong>目标服务器名称</strong>:数据库服务器的名称。</li>
<li><strong>目标数据库</strong>:要部署到的数据库的名称。</li>
<li><strong>目标数据库DAC版本</strong>:该列表是查找。dll文件，选择SQL Server PowerShell模块来动态加载该模块。</li>
<li><strong>认证类型</strong>:认证选项列表，本帖使用SQL认证。</li>
<li><strong>用户名</strong> : SQL认证用户名。</li>
<li><strong>密码</strong>:SQL认证用户的密码。</li>
<li><strong>启用多子网故障转移</strong>:是否使用多子网故障转移。</li>
<li><strong>附加部署贡献者</strong>:如果使用<code>SqlPackage.exe /p:AdditionalDeploymentContributors=[what you would put here]</code>命令行，您将添加的选项。</li>
<li><strong>附加部署贡献者参数</strong>:如果使用<code>SqlPackage.exe /p:AdditionalDeploymentContributorArguments=[what you would put here]</code>命令行，您将添加的选项。</li>
<li><strong> DACPAC包</strong>:要部署的包。</li>
<li><strong>命令超时</strong>:以秒为单位的超时，主要用于长时间运行的脚本。</li>
</ul>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-12/deploying-sql-server-dacpac-octopus/octopus-dacpac-deployment-process.png" class="zoom" data-title=""><img src="../Images/74fd9b016b7789323f2981ec3cb3e617.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2021-12/deploying-sql-server-dacpac-octopus/octopus-dacpac-deployment-process.png"/>T2】</a></p>

<p>您的部署将如下所示:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-12/deploying-sql-server-dacpac-octopus/octopus-deploy-complete.png" class="zoom" data-title=""><img src="../Images/c0a6c7a81fc8339411e39ccdd36bd359.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2021-12/deploying-sql-server-dacpac-octopus/octopus-deploy-complete.png"/>T2】</a></p>

<p>使用类似SQL Server Management Studio (SSMS)的工具，您可以看到数据库已经更新:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-12/deploying-sql-server-dacpac-octopus/ssms-sakila-database.png" class="zoom" data-title=""><img src="../Images/f2d7dab5cee1cc8002033f50a027e1fb.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2021-12/deploying-sql-server-dacpac-octopus/ssms-sakila-database.png"/>T2】</a></p>

<h2 id="conclusion">结论</h2>

<p>这篇文章向您展示了从项目创建到部署如何部署DACPAC。请务必查看我们的<a href="https://samples.octopus.app/app#/Spaces-106/projects/dacpac-azure-sql/deployments/process" rel="nofollow">示例实例</a>中的一个示例。该示例部署到Azure SQL数据库服务器。</p>

<p>愉快的部署！</p>

                    
                    
</body>
</html>