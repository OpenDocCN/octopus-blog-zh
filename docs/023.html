<html>
<head>
<title>Using the Octopus API with Bash and jq - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>通过Bash和jq - Octopus Deploy使用Octopus API</h1>
<blockquote>原文：<a href="https://octopus.com/blog/api-bash-jq#2021-12-02">https://octopus.com/blog/api-bash-jq#2021-12-02</a></blockquote>
                        <p>Octopus Deploy是API优先编写的，这意味着您可以在用户界面(UI)中做的任何事情，都可以通过API调用来完成。当我与API交互时，我使用PowerShell，因为它具有将JSON转换为PowerShell对象的内置功能，这使得使用JSON很容易。然而，并不是所有的Octopus客户都使用PowerShell，有些客户需要使用Bash的基于*nix的解决方案。</p>

<p>在这篇文章中，我演示了如何使用Bash和Octopus API。</p>

<h2 id="jq">japan quarterly 日本季刊</h2>

<p>Octopus Deploy API以JSON格式返回数据。然而，Bash没有提供处理JSON数据的内置方法，而是将JSON视为字符串。虽然Bash有一些复杂的字符串操作功能，但是使用JSON数据仍然很困难。</p>

<p>为了解决这个问题，Linux社区开发了一个强大的命令行实用程序jq来解析JSON。Jq已经成为处理JSON数据的首选工具，可以通过使用包管理器(如APT或YUM)轻松安装。</p>

<h2 id="curl">卷曲</h2>

<p>Wget和cURL是使用Bash发出web请求的两种最常用的方法。有这么多可用的Linux发行版，您无法判断安装的是哪一个实用程序。本文中的例子使用了cURL工具。像jq一样，cURL可以使用包管理器来安装。</p>

<h2 id="working-with-paginated-data">使用分页数据</h2>

<p>Octopus中的许多API以分页格式返回数据。对于这些API调用，您可以提供querystring参数如<code>skip</code>和<code>take</code>来操纵调用的结果。请参见https://[YourServer]/api，获取api方法列表和每种方法的querystring参数列表。</p>

<p>有时您希望返回给定调用的所有结果，例如当您检索所有项目时。对于这种情况，我编写了一个Bash函数，递归调用API，直到返回所有结果。</p>

<p>虽然这篇文章的这一部分谈到了分页数据，但是<code>Get-OctopusItems</code>函数也适用于非分页API调用。</p>


<pre><code class="language-bash">Get-OctopusItems () {
    octopusUri=$1
    apiKey=$2
    skipCount=$3

    header="X-Octopus-Apikey: $apiKey"
    items=()
    skipItemQuerystring=""

    # Adjust querysting accordingly
    if [[ "$octopusUri" == *"?"* ]]; then
        skipItemQuerystring="&amp;skip="
    else
        skipItemQuerystring="?skip="
    fi

    # Append the amount to skip
    skipItemQuerystring+="$skipCount"

    # Get results
    resultSet=$(curl -H "$header" -H "Accept: application/json" -H "Content-Type: application/json" "$octopusUri$skipItemQuerystring")

    # Check to see if items is present
    items=$(echo "$resultSet" | jq .Items)

    if [[ ! -z "$items" ]]; then

        # Check to see if results are bigger than page count
        itemsPerPage=$(echo "$resultSet" | jq -r .ItemsPerPage)
        totalResults=$(echo "$resultSet" | jq -r .TotalResults)
        itemCount=$(echo "$(($totalResults - $skipCount))")

        if [[ "$itemCount" -gt "$itemsPerPage" ]]; then

            # Increment skip count
            skipCount=$(echo "$(($itemsPerPage + $skipCount))")

            # Recursively call
            items+=$(Get-OctopusItems "$octopusUri" "$apiKey" "$skipCount")
        fi
    else
        echo "$items"
    fi

    echo "$items"
}

OctopusUrl="https://yourserverurl"
spaceId="Spaces-1"
ApiKey="API-YourAPIKey"

# Get all the projects
projects=$(Get-OctopusItems "$OctopusUrl/api/$spaceId/projects" "$ApiKey" 0)

if [[ "$projects" == *"]["* ]]; then
    # Replace characters to make one contiguous array
    projects=$(echo "${projects//][/,}")
fi
</code></pre>

<p>对API的每个调用都返回一个项目数组。返回的JSON中有多个JSON数组。</p>

<p><code>if</code>语句通过测试<code>][</code>的字符串并在找到时用<code>,</code>替换它来检查是否返回了许多数组。这使得JSON字符串成为单个数组，更容易处理。</p>

<p>在返回所有项目数据之后，您可以使用更多的jq命令来检索元素，比如ProjectId，并检索项目特定的数据，比如部署过程、操作手册或变量。</p>

<pre><code class="language-bash"># Iterate over returned items
arr=( $(echo "$projects" | jq -r '.[].Id') )

for projectId in "${arr[@]}"
do
    echo "$projectId"
done
</code></pre>

<h2 id="posting-to-the-api-with-bash">用Bash发布到API</h2>

<p>上面的例子演示了如何向API发出GET请求。虽然有用，但是这些请求只是您与API交互的一部分。下面的示例创建一个JSON文档，以发送到中断API:</p>

<pre><code class="language-bash">automaticResponseReasonNotes="Because I said so!"
automaticResponseManualInterventionResponseType="Proceed"

# Create JSON document
jsonBody=$(jq -n \
        --arg notes "$automaticResponseReasonNotes" \
        --arg result "$automaticResponseManualInterventionResponseType" \
        '{"Notes": $notes, "Result": $result}' )

# Submit response
curl -H "$header" -H 'Content-Type: application/json' -X POST -d "$jsonBody" "$automaticResponseOctopusUrl/api/$spaceId/interruptions/$manualInterventionId/submit" 
</code></pre>

<h2 id="conclusion">结论</h2>

<p>这篇文章演示了如何使用Bash、cURL和jq与Octopus API进行交互。<a href="https://octopus.com/docs/octopus-rest-api/examples"> Octopus API示例</a>页面包含更多在PowerShell、C#、Python和Go中使用API的示例。</p>

<p>愉快的部署！</p>

                    
                    
</body>
</html>