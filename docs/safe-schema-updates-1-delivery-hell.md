# 安全模式更新——数据库交付地狱——Octopus 部署

> 原文：<https://octopus.com/blog/safe-schema-updates-1-delivery-hell>

这篇博客文章是关于安全模式更新系列文章的第 1 部分。本系列其他文章的链接如下:

**批评现有系统:**

**想象更好的系统:**

**构建更好的系统:**

为了理解为什么有必要做出改变，反思一下我们现在的处境是很有用的。提前道歉，这可能会让你读起来不舒服。

“这需要改变数据库。”

听到这些话，IT 人常常不寒而栗。多年的经验告诉他们，要将那个功能投入生产，将会是一场艰苦的战斗。

这种末日即将来临的感觉有几个原因。为了好玩，我要借用但丁的一点艺术许可证。(声明一下，我完全是从[吉安卢卡·萨托里](https://spaghettidba.com/)那里偷来的这个想法——他在[的推特](https://twitter.com/spaghettidba)上，你可以去看看[他的极其时髦的数据库“地狱”谈话](https://www.youtube.com/watch?v=p1qQlmoj0sE)。)

**0 级:数据地狱**

数据库面临的独特挑战是数据。关键业务信息没有保存在源代码控制中，所以不可能像删除一个有问题的 web 服务器那样删除和重新部署数据库。

因此，数据库回滚并不容易。可以说，没有数据库回滚这样的事情。如果生产部署出现问题，可能需要恢复备份。这将导致停机和(可能的)数据丢失。这对您的用户来说可能是一场灾难，对企业来说成本高昂。

但这不仅仅是一个关于生产的故事。开发/测试数据库很少有真正有代表性的数据。因此，bug 和性能问题通常只能在生产中发现。此外，如果无法在“类似生产”的环境中可靠地模拟部署，就很难测试数据丢失或部署脚本执行不佳的情况。

当我们未能在开发/测试环境中提供有代表性的安全测试数据时，当我们未能在部署中测试数据问题时，我们就不尊重我们的数据。这种罪恶是有后果的。

第一级:依赖地狱

“数据库”常常成为无数依赖系统的共享后端服务。久经沙场的工程师已经痛苦地认识到，改变模式可能会对那些依赖系统产生意想不到的后果。当工程师甚至不知道他们依赖的系统是什么时，他们不可能对变化有信心。不幸的是，这些依赖性很少被很好地记录或测试。

当数据库之间的依赖性突然出现时，这尤其糟糕，例如，通过存储过程、视图或(令人不寒而栗的)链接服务器。最差的违规者甚至可能看到他们的开发、测试和生产环境之间的依赖性。

由于所有的依赖性，开发/测试环境非常难以供应和维护，这一事实加剧了生产部署问题。

在理想的情况下，开发/测试环境通常是可任意处理的专用环境，开发人员可以为每个新的开发任务开发和丢弃这些环境。然而，考虑到构建大型或复杂的数据库通常需要的时间和精力，开发/测试服务器通常由大型团队共享，这使得变更控制变得困难，并且使得孤立地测试变更变得不可能。

这些共享的开发/测试“狂野西部”的垃圾箱火灾很快变得与生产系统不一致。因此，它们不能被信任为生产的真实表现，并且在它们上面进行的任何开发/测试工作从根本上来说是不可靠的。

**第二级:全球失败地狱**

模式部署本身尤其危险，因为由于依赖关系，数据库已经成为如此多服务的单点故障。一个被遗忘的 WHERE 子句或消耗性能的游标可能会产生全球性的后果。

如上所述，由于依赖性的复杂性，很少有适合目的的测试环境。此外，为每个依赖的服务建立一个可靠的自动化测试套件是不太可能的，也是不可行的。这使得在执行部署时不可能确信没有任何东西会被破坏。

这些问题是真实而重大的。在[凤凰计划](https://octopus.com/blog/devops-reading-list#phoenix)中的一次大规模部署失败中，前三个级别被很好地联系在一起。单点故障数据库中的一个巨型表上有一个缺失的索引，它位于一个错综复杂的依赖关系网络的中心。这可能是因为开发/测试数据库与生产不匹配，或者因为它们没有代表性的数据，所以没有发现性能问题。

更新运行得极其缓慢，而且无法取消。他们错过了停机时间，并且由于大量的相关服务，当系统在周一早上没有恢复在线时，他们对数千名内部用户和客户造成了巨大的中断。

我将用一个真实的灾难来支持这个虚构的灾难。我曾经为一家公司工作，该公司有一个支撑其开发环境的狂野西部、单点故障、共享数据库。对于 100 多名开发人员来说，用真实的数据测试他们正在开发的东西是至关重要的。有一次，有人不小心删除了所有的 SQL 登录。整个开发功能以及相关的服务都被封锁了。DBA 花了一周多的时间来修复它，因为与此同时，生产中出现了一个大问题。

所有那些开发人员都闲荡了一个星期。我很紧张地想象着一个超过 100 人的财务部门开发团队的典型年度预算是什么样的，但我想股东们不会喜欢一周的闲扯。

**第三关:释放协同地狱**

如果您只是部署数据库变更，那就已经够糟了。但是，由于存在依赖性，您可能还需要同时或按特定顺序部署一组相关系统的新版本。整个过程需要精心安排，一个部分的问题可能会危及整个工作。

糟糕的源代码控制实践和共享环境的使用加剧了这个问题。在这种情况下，要发布的变更可能需要从开发/测试数据库中存在的更大的变更集中挑选出来。这一过程通常是手动的，需要更大的复杂性，并且更有可能出错。它也可能在源代码控制中涉及到非常复杂或者不切实际的简单分支模式。这两种情况都会带来复杂性、风险和偏头痛。[我在我的个人博客](http://workingwithdevs.com/branching-reality/)上更详细地谈论了这个话题。

当依赖对象/系统的发布需要仔细编排时，这是一个信号，表明您正遭受代码中的依赖噩梦的组合，以及您的团队/项目管理结构。[团队拓扑](https://octopus.com/blog/devops-reading-list#tt)更详细地讨论了这些问题。

**第四级:停机窗口地狱**

由于上述所有的依赖性和协调工作，您需要将整个系统脱机一段时间来完成更新。与用户/客户/ [“业务”](https://twitter.com/paulstovell/status/1323552178091433984)协商停机时间并不容易，所以你被迫在非社交时间做这件事。你可能没有完全清醒，也不太可能得到支持。(写代码的开发人员可能睡着了！)如果你错过了截止日期，后果自负。

更糟糕的是，由于您只能在有限的停机时间内完成工作，因此您面临着额外的压力，需要在每个时间内交付尽可能多的变更。部署变得更大、更复杂、更危险。

这个地狱的一个变种是由关于 100%正常运行时间的天真的业务假设引起的。100%的正常运行时间实际上是不可能的，也是难以想象的昂贵。[高层管理人员往往没有意识到这一点](https://www.brentozar.com/archive/2011/12/letters-that-get-dbas-fired/)。由于沟通不畅，技术人员经常被置于绝望的境地，被荒谬的期望所衡量。这导致了令人沮丧的政治活动和糟糕的决策。

**第五关:官僚地狱**

考虑到对单一后端数据库的任何更改都可能影响到的人数，以及失败的严重后果，许多利益相关者希望否决部署。工程师不得不花费和他们实际做测试一样多的时间来证明他们已经做了测试。

尽管这种充分的谨慎听起来很明智，但如果实施不当，通常是无效的。([而且几乎总是执行不好](https://octopus.com/blog/change-advisory-boards-dont-work))。)高层领导不太可能接受较慢的工作节奏。因此，如果变更的测试/批准措施导致了延迟，那么结果将是大量的“在制品”(WIP)。这导致了更大、甚至更复杂的部署，带来了更多的依赖性和协调问题。

据 [Accelerate](https://octopus.com/blog/devops-reading-list#accelerate) 报道，来自 DevOps 报告的数据表明，变更咨询委员会平均“比根本没有变更批准流程更糟糕”。尽管初衷是好的，但这些安全措施导致了更复杂、更危险的恶魔部署。

**第 6 关:不服从官僚地狱**

在按时发布的压力下，并通过个人愿望来完成一项工作，工程师们试图绕过官方流程。中层管理者玩弄政治来保护他们团队的变化。人们篡改真相以避免官僚主义。影子 IT 的出现是因为使用官方认可的系统是令人沮丧的乏味，阻碍了团队按时完成任务的能力。

高级管理人员甚至可能支持和祝贺这样的“创新”，而不承认他们正在促成一个[大泥球](https://en.wikipedia.org/wiki/Big_ball_of_mud)。这种短期进步通常是以长期表现为代价的。

**第七关:疏忽地狱**

随着企业越来越不顾一切地在越来越紧张的预算上完成越来越不可能的最后期限，投资任何与狭窄和具体的目标没有直接关系的东西变得越来越困难。起初，这可能不是那么糟糕。它把精力集中在最重要的工作上。然而，这不可避免地导致关键基础设施投资不足。

借用凤凰项目中的“四类工作”术语:这是 IT 人员在完成“业务项目”和“计划外工作”的巨大压力下，没有时间关注“内部项目”甚至例行“变更”(如修补服务器)。

正如[我的英国同事可能会说的](https://twitter.com/DavidJPoole/status/1361340954700107786)，高级经理变得“因小失大”。改进工作甚至日常维护都被推迟或废弃。消防成为家常便饭。该团队已经停止了积极的改进工作。他们没时间了。

一个常见的工程后果是短视的欺骗，以避免重构或删除数据库中的任何内容。如果您从不事后清理，数据库部署肯定会更容易。

你不应该删除数据库中的东西，这种想法在科技界很普遍，需要受到挑战。这种黑客认为你的 IT 基础设施中最重要的部分是你过去几年所有过时的或被误导的设计选择的垃圾场。这可能会在短期内为你节省一点时间，但它会咬人。重构是软件开发的重要部分。

我曾经在一家公司工作，那里所有的表格都有难以理解的四字名称。我问这是为什么。显然，几十年前的一些数据库技术有这种限制。他们当前的 RDBMS 并没有受到这种限制，但是他们非常害怕做出改变，以至于一些开发人员仍然坚持四字符约定——甚至对于新表也是如此。如果所有的表在 IDE 中整齐排列，看起来一定很漂亮。

这个数据库对于许多重要的服务来说是至关重要的，但是使用和维护它几乎是不可能的，尤其是对于新员工来说。没有人知道“QACD”或“FFFG”表是干什么用的。这些 5 表连接是不可能破译的。

随着软件和业务需求的发展，如果不重构我们的数据库，我们肯定会产生庞大的数据库，这些数据库很难使用，并且充满了(应该是)废弃的代码和不必要的依赖。

这是一张去…的单程票

**第八关:技术性债务奇点**

“计划外的工作”吞噬了一切。

随着业务水平不断下降，获得越来越多的技术债务，每个工程师花在救火上的时间比例也在增加。最终，这一比例达到 100%，甚至更高，工程师们为了维持核心运营而加班加点。一个短视的解决办法可能是雇佣更多的人，但那是行不通的。Frederick Brooks 在 1975 年的[神话人月](https://en.wikipedia.org/wiki/The_Mythical_Man-Month)中解释了原因！时隔近半个世纪，我不打算在本帖中浪费更多的文字重复他的观点。如果你在 IT 行业工作，并且你没有听说过它，我建议你点击上面的链接。

不幸的是，问题仍在恶化。几乎没有时间做新的东西。我们已经到了深渊的底部。某种变化是不可避免的。要么企业会改变想法，要么他们输给更有能力的竞争对手只是时间问题。

以我的经验来看，每一级都会把人们推向下一级。它们相互加强。对于那些身处困境的人来说，这些问题就像[西西弗斯的巨石](https://www.ancient.eu/sisyphus/)，只不过这块巨石随着时间的推移变得越来越大、越来越重。达到顶峰，甚至保持目前的势头，一天比一天更不可能。

有些东西必须放弃。

无论你在旅途中的什么地方，认清你的轨迹并在必要时选择不同的道路是至关重要的。等得越久，就越难逃脱。而且，如果那些有权力实施变革的人不改变他们的思维方式，逃跑肯定是不可能的。

## 下次

下一篇文章(第 2 部分)将是四篇文章中的第一篇，旨在帮助人们重新评估他们在复杂 IT 系统中看待和评估安全的方式。我们将开始想象一个更安全的软件架构、交付过程和开发文化会是什么样子。在继续讨论弹性、健壮性和松散耦合的概念之前，我们将从探索复杂系统中失败的本质开始。

本系列其他文章的链接如下:

**批判现有系统:**

**想象更好的系统:**

**构建更好的系统:**

## 观看网络研讨会

我们的第一次网络研讨会讨论了松耦合架构如何带来可维护性、创新性和安全性。第二部分讨论了如何将一个成熟的系统从一种架构转换到另一种架构。

### 数据库开发:想象更好的系统

[https://www.youtube.com/embed/oJAbUMZ6bQY](https://www.youtube.com/embed/oJAbUMZ6bQY)

VIDEO

### 数据库开发:构建更好的系统

[https://www.youtube.com/embed/joogIAcqMYo](https://www.youtube.com/embed/joogIAcqMYo)

VIDEO

愉快的部署！