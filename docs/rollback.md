# Octopus 如何处理回滚？-章鱼部署

> 原文：<https://octopus.com/blog/rollback>

这个问题出现了很多次:

> 当部署失败时，Octopus Deploy 如何处理回滚？

在回答这个问题时，首先要记住的是部署是复杂的，与云 PaaS 解决方案不同，Octopus 不会对您可以使用它构建或部署的软件类型施加太多限制。

当部署过程中出现问题时，我们有三种通用的处理方法:

1.  回滚-恢复到使用软件的先前版本
2.  前滚-修复它并部署新版本
3.  翻车-再试一次，也许是一个间歇性的问题

代码/应用程序的自动回滚通常非常简单——只需找到旧的二进制文件，更新 IIS/负载平衡器等。指着旧的二进制文件，你就笑开了。

然而，最难的是持久存储——我指的是数据库。在部署过程中，您可能运行了迁移脚本来重命名列。回滚应用程序后，旧版本的应用程序可能会中断，因为它希望列使用旧名称。这是一个非常简单的模式变化。

一种选择是从备份中恢复数据库。但是数据库可能在部署期间一直在使用，并且您可能在迁移脚本运行和部署失败之间不久收到了一个命令。自动回滚数据库将意味着丢失重要数据。

## 设计支持回滚的应用程序

在设计应用程序和进行更改时，可以使用一些技术来使应用程序更好地支持回滚。

一种选择是确保您的更改总是**向后兼容先前的版本**。我们可以在不破坏旧应用程序的情况下改变模式，例如，使用视图。在第三个版本之后，您可能会开始删除旧的列或表。然而，复杂的部分是测试；仅仅假设您的模式更改是向后兼容的是不够的，您真的应该测试它，否则回滚将和不回滚一样糟糕。

另一个可能有帮助的方法是使用[架构风格，比如事件源](http://martinfowler.com/eaaDev/EventSourcing.html "Event sourcing")。通过这种方式，你可以用旧代码‘重放’新事件，或者用新代码‘重放’旧事件，理想情况下，应用程序的两个版本都可以工作。

## 失败的部署应该是例外

不幸的是，作为一个应用程序部署工具，Octopus 不能假设您编写的代码总是支持自动回滚。不能保证自动回滚会让事情变得更好；事实上，这可能会让事情变得更糟。

相反，我们认为当部署失败时，Octopus 应该:

1.  提供尽可能多的信息；和
2.  提供工具来帮助，但**而不是**去尝试和接管。

毕竟，当生产部署出错时，通常是压力很大的时候——您最不希望的就是有工具对您进行事后批评，让事情变得更糟！

要做到这一点，Octopus 可以很容易地部署以前的版本，或者部署新的版本。只需找到您想要部署的版本，然后单击 deploy。*你*知道这个版本包含了什么，软件包是如何构造的，所以你可以决定是尝试回滚还是前滚是安全的。对 Octopus 来说，回滚或前滚就像任何正常的部署一样。

## 在持续部署的世界中失败的部署

Eric Ries 最近推广的一个话题是[持续部署，以及集群免疫系统的想法](http://www.startuplessonslearned.com/2010/01/case-study-continuous-deployment-makes.html "Continuous deployment")。这个想法是你的系统应该自我监控，如果它检测到一个问题，它可以自动回滚。

重要的是要认识到，Eric 并不提倡使用特定的部署工具来实现这种自动回滚。相反，在设计应用程序时，您需要在系统层面上进行思考。您在出现问题的第一个迹象时透明回滚的能力将更多地取决于您的物理基础架构、数据库和系统设计，而不是您选择的部署工具。

Octopus 确实提供了 API,使得自动部署项目的新老版本成为可能，因此它肯定会在恢复策略中发挥作用。但是没有一种部署工具是万能的；如果这是你的目标，你需要全面考虑你的系统。

## 部署失败. ps1

虽然 Octopus 永远无法为您从失败的部署中自动恢复，但我很乐意找到让您更容易创建恢复策略的方法。[一个建议是部署失败的. ps1](https://trello.com/card/deployfailed-ps1/4e907de70880ba000079b75c/14 "DeployFailed.ps1") ，如果对特定机器的部署失败，将运行该文件。脚本中会包含什么由您决定，但是支持会在那里。

## 最后

让我们回到最初的问题:

> 当部署失败时，Octopus Deploy 如何处理回滚？

简单的答案是，Octopus 使部署以前成功的版本变得容易，或者在解决问题后部署新的版本变得容易。这可以被 API 调用，所以如果你的系统是为它设计的，你可以自动化它。

也就是说，从失败的部署中自动恢复的能力在很大程度上是系统整体的属性，而不仅仅是自动化部署工具的特性。Octopus 有(并将有更多)功能可以提供帮助，但一如既往，这个行业没有灵丹妙药。

### 了解更多信息