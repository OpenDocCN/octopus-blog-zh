<html>
<head>
<title>RFC: Azure Resource Manager support - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>RFC: Azure资源管理器支持- Octopus部署</h1>
<blockquote>原文：<a href="https://octopus.com/blog/rfc-azure-resource-manager#2016-05-05">https://octopus.com/blog/rfc-azure-resource-manager#2016-05-05</a></blockquote>
                        <p>在过去的某个时候，Azure团队对Azure中管理资源的方式进行了明确的方向改变。结果当然是<a href="https://azure.microsoft.com/en-us/documentation/articles/resource-group-overview/"> Azure资源管理器</a>。</p>

<p>因此，现在有两个不同的接口与Azure交互。最初的接口被称为Azure服务管理(ASM)，Azure资源管理器(ARM)是新的。分裂是深刻的；有两个HTTP API，两套PowerShell模块，甚至两个web门户。</p>

<p>目前，Octopus Deploy只与服务管理接口交互。</p>

<p>当您在Octopus中创建新的Azure帐户时，您会附加一个证书，该证书用于通过Azure进行身份验证。这种认证模式只能与服务管理API交互。若要使用资源管理器，需要通过Azure Active Directory进行身份验证。</p>

<p>为了提供对Azure资源管理器的支持，提出了许多更改:</p>

<h3>Azure服务主帐户</h3>

<p>我们建议为Octopus添加一个新的帐户类型:一个<em> Azure服务主体</em>帐户(现有的Azure帐户将被称为<em> Azure管理证书</em>帐户)。Azure服务主体帐户的创建过程将包括在你的Azure Active Directory中创建一个服务主体(参见这篇<a href="https://azure.microsoft.com/en-us/documentation/articles/resource-group-authenticate-service-principal/">帖子</a>了解上下文)，并捕获必需的字段(应用程序ID、租户ID、密码)。我们会尽可能让这次经历顺利。</p>

<p><img src="../Images/56af631289ca236f4df17577180488d4.png" alt="Create Azure Service Principal Account" data-original-src="https://i.octopus.com/blog/201511-create_account-BQEU.png"/></p>

<h3>一个新的“部署Azure资源组”步骤</h3>

<p>通过资源管理器，可以使用<a href="https://azure.microsoft.com/en-us/documentation/articles/resource-group-authoring-templates/"> JSON模板</a>作为一个组来提供和部署资源。</p>

<p>我们提出了一个新的部署步骤，可以使用JSON模板提供/部署资源组。</p>

<p><img src="../Images/830f466c5291f61da48a629bfe152535.png" alt="Choose step type" data-original-src="https://i.octopus.com/blog/201511-choose_step-QGR8.png"/></p>

<p>编辑步骤可能类似于:</p>

<p><img src="../Images/0e4564123dfc2252ca46f3aaf5af5f9b.png" alt="Deploy Resource Group step" data-original-src="https://i.octopus.com/blog/201511-edit_step-VLMH.png"/></p>

<p>需要注意的事项:</p>

<ul>
<li>“参数”部分是动态的。该表单会进行调整，以匹配模板中定义的参数。</li>
<li>Octopus变量可以绑定到任何字段，包括参数。在上面的示例中，siteName参数被绑定到一个变量。这是强大的，因为它允许您的参数根据环境、通道等进行调整，而无需修改步骤。</li>
<li>“验证”按钮将允许根据Azure资源管理器来验证您的部署。这比创建一个版本并进行部署却发现JSON无效要好。</li>
</ul>

<p>在我们目前的想法中，这些步骤不包括NuGet包。我们为这些资源组步骤设想的用例更多的是关于供应资源，而不是部署它们。例如，您可能有一个创建Azure网站(可能还有SQL数据库等)的“部署资源组”步骤，然后是一个“部署Azure Web App”步骤，该步骤将获取包含您的应用程序的NuGet包并部署它。</p>

<p>例如</p>

<p><img src="../Images/b69f7ba0d23209c8c2aee4e7b0ee0f7c.png" alt="ARM Deployment Process" data-original-src="https://i.octopus.com/blog/201511-deployment_process-MDFZ.png"/></p>

<h3>Azure PowerShell脚本</h3>

<p>目前，对于“运行Azure PowerShell脚本”步骤，我们自动导入Azure PowerShell模块并根据订阅进行身份验证。但是这不允许使用资源管理器cmdlets。我们将为资源管理器做类似的事情:如果帐户是服务主体帐户，我们将自动进行身份验证。是否自动加载资源管理器模块是一个悬而未决的问题，因为它们已经变得更细粒度了。</p>

<p>此时，服务主体帐户无法访问服务管理API(包括PowerShell模块)。这意味着您无法在同一个步骤中组合服务管理和资源管理器cmdlets。要使用服务管理器cmdlet，您需要一个选择Azure管理证书帐户的步骤，而要使用ARM cmdlets，您需要一个选择Azure服务主体帐户的步骤。鉴于微软似乎已经有效地停止了服务管理方面的开发，我们认为这将是一个越来越小的问题。</p>

<h3>饭桶</h3>

<p>我们还在考虑允许从Git存储库中检索模板。这种情况可能会发生，也可能不会发生，即使发生，也可能不会包含在此功能的初始版本中。我们很想知道这是否有趣。</p>

<h2>反馈</h2>

<p>告诉我们你的想法？</p>

                    
                    
</body>
</html>