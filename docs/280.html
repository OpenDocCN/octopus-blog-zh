<html>
<head>
<title>Getting started with PowerShell Desired State Configuration (DSC) - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>PowerShell所需状态配置(DSC)入门- Octopus部署</h1>
<blockquote>原文：<a href="https://octopus.com/blog/getting-started-with-powershell-dsc#2021-08-12">https://octopus.com/blog/getting-started-with-powershell-dsc#2021-08-12</a></blockquote>
                        <p><a href="#" data-featherlight="https://i.octopus.com/blog/2019-10/getting-started-with-powershell-dsc/getting-started-powershell-dsc.png" class="zoom" data-title=""><img src="../Images/b2595a1f3fdde35c708385d07e0f0b3e.png" class="img-fluid center" alt="Octopus learning how to configure a server with PowerShell DSC" data-original-src="https://i.octopus.com/blog/2019-10/getting-started-with-powershell-dsc/getting-started-powershell-dsc.png"/>T2】</a></p>

<p>PowerShell DSC是一项非常棒的技术，可以放在您管理基于Windows的服务器的工具箱中。这篇文章是一系列文章的一部分:</p>



<p>我们也有关于使用PowerShell DSC和Octopus Deploy的文章:</p>



<hr/>

<p>无论您是大型组织还是小型组织，使用云基础架构还是机架式服务器，维护服务器的已知状态都是一项挑战。存在一些第三方解决方案，如Ansible、Chef和Puppet，但它们是基于Linux的付费产品。对于Windows用户，有一个免费的以Windows为中心的选项；PowerShell所需状态配置(DSC)。在这个PowerShell DSC教程中，我将向您展示如何开始使用PowerShell DSC，并提供一些如何使用它的基本示例。</p>

<h2 id="what-is-powershell-desired-state-configuration-dsc">什么是PowerShell期望状态配置(DSC)</h2>

<p>PowerShell DSC是一种基础结构代码(IaC)技术，它使用PowerShell创建托管对象格式(MOF)文件，Windows Management Instrumentation(WMI)可以使用这些文件来配置计算机。换句话说，PowerShell DSC使用PowerShell以编程方式配置基于Windows的计算机。此外，DSC可以监控已配置资源的状态，以确保您的计算机保持一致。除了监控，DSC还可以自动纠正系统的配置，使其始终处于所需的状态。</p>

<h3 id="powershell-powershell-dsc">PowerShell！= PowerShell DSC</h3>

<p>如果您曾经参加过PowerShell的课程，您的讲师可能会提到PowerShell DSC，但会掩饰地说这是一门完全不同的课程，或者PowerShell DSC还有其他课程。DSC使用PowerShell脚本语言，但相似之处仅此而已。</p>

<h3 id="why-use-powershell-dsc">为什么使用PowerShell DSC</h3>

<p>维护基础设施一致性的一种常用方法是为需要启动的不同类型的服务器创建基本映像。需要网络服务器吗？使用web服务器映像。需要数据库服务器吗？使用数据库服务器映像。虽然这无疑缩短了用已知/良好的配置供应资源所花费的时间，但是存在一些固有的问题。</p>

<p>例如，当您的首席信息安全官(CISO)更改了您的web服务器允许的协议时会发生什么？当然，您可以修复基本映像，或者重新创建所有web服务器，或者编写自动化脚本将新的安全配置应用到现有的服务器，但是重新创建服务器或者编写并测试更新脚本可能会花费大量时间，尤其是在您有数百台服务器的情况下。如果新实施的安全标准破坏了与业务合作伙伴的季度接口，该怎么办？现在你必须撤销所有的工作。</p>

<p>使用PowerShell DSC，您可以定义您想要的状态，所有新的和现有的服务器都可以选择并实现该状态。如果您必须撤销它，只需更改所需的状态即可恢复。</p>

<h3 id="how-does-it-work">它是如何工作的？</h3>

<p>PowerShell DSC将使用PowerShell配置的组件转换成MOF文件，供WMI用来配置机器。DSC可以使用两种方法将配置应用到您的机器上；推拉。您还可以使用自动部署工具(如Octopus Deploy)创建一种混合方法。</p>

<h4 id="push-method">推送方法</h4>

<p>推送方法可能是最容易开始的方法。这种方法要求用户通过调用<code>Start-DscConfiguration</code> cmdlet将期望的状态配置<em>推送到</em>服务器。这具有立即开始应用配置的优点。就自动化而言，这种方法的缺点是，如果服务器离线，它将无法应用新的期望状态。这就是拉方法可能是更好的方法的地方。</p>

<h4 id="pull-method">拉动方法</h4>

<p>顾名思义，Pull方法通过服务器获取所需的状态配置并应用它。这要求您有一个包含服务器配置的拉服务器。这种方法的缺点是需要额外的服务器来托管配置。然后，需要配置已配置的服务器来轮询“拉”服务器，以确定是否有新的MOF文件可用。</p>

<h2 id="getting-started">入门指南</h2>

<p>这篇文章是为初学DSC的人设计的，所以我们将使用更简单的推送方法开始。对于我们的场景，我们希望确保服务器的配置包括一些Windows特性。我们只使用几个例子:</p>

<ul>
<li>网络服务器</li>
<li>网络管理工具</li>
<li>web-默认-文档</li>
</ul>

<p>如果您想知道我是从哪里得到这些名字的，请使用<code>Get-WindowsFeature</code> cmdlet获取列表。您也可以使用通配符作为名称，例如<code>Get-WindowsFeature Web*</code>。</p>

<h3 id="simple-configuration-script">简单的配置脚本</h3>

<p>对于DSC，我们使用<code>Configuration</code>关键字来定义配置。在本例中，<code>WindowsFeature</code>是我们正在配置的组件。您可以看到我们定义了三个单独的<code>WindowsFeature</code>组件的实例，每个实例对应一个我们想要配置的组件。每个已配置的实例都需要自己唯一的名称，因为该名称在转换为MOF文件时用作关键字。您配置的每个组件都有一个<code>Ensure</code>属性，它的值可以是<code>Present</code>或<code>Absent</code>。当您想确保组件存在时，您可以指定<code>Present</code>。如果您不想在机器上安装组件，您可以指定<code>Absent</code>。对于这个例子，我们希望确保组件安装在服务器上，所以我们为所有组件指定了<code>Present</code>。</p>

<p>在我们完成一个<code>Configuration</code>之后，我们像调用一个函数一样调用它，并提供一个<code>OutputPath</code>，这样DSC就知道在哪里放置生成的MOF文件。对于这个例子，我们将其命名为<code>WebServerConfiguration</code>。DSC <code>Configuration</code>完成后，我们调用<code>Start-DscConfiguration</code> cmdlet并提供我们生成的MOF文件的路径:</p>

<pre><code class="language-PS">Configuration WebServerConfiguration
{  
  Node "localhost"
  {        
    WindowsFeature WebServer
    {
      Name = "Web-Server"
      Ensure = "Present"
    }

    WindowsFeature ManagementTools
    {
      Name = "Web-Mgmt-Tools"
      Ensure = "Present"
    }

    WindowsFeature DefaultDoc
    {
      Name = "Web-Default-Doc"
      Ensure = "Present"
    }
  }
}

WebServerConfiguration -OutputPath "C:\DscConfiguration"

Start-DscConfiguration -Wait -Verbose -Path "C:\DscConfiguration"
</code></pre>

<p>在您的配置运行之后，您应该会看到类似如下的输出:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2019-10/getting-started-with-powershell-dsc/example-1-results.png" class="zoom" data-title=""><img src="../Images/0cbb9a8794e19afd1666c8aa962e3126.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2019-10/getting-started-with-powershell-dsc/example-1-results.png"/>T2】</a></p>

<h3 id="separating-node-data-and-making-the-script-more-dynamic">分离节点数据并使脚本更加动态</h3>

<p>我们这个简单的例子是非常硬编码的，根本不是动态的。借助PowerShell DSC，我们能够将配置数据从配置本身中分离出来，并使我们的脚本更加动态。毕竟是PowerShell😃</p>

<p>DSC配置数据文件只是一组哈希表，可以包含其他哈希表或数组，通常具有psd1文件扩展名。DSC配置数据必须至少有一个名为<code>AllNodes</code>的密钥。参考<a href="https://docs.microsoft.com/en-us/powershell/scripting/dsc/configurations/configData?view=powershell-6" rel="nofollow">微软文档</a>了解更多信息。</p>

<p>让我们将三个Windows功能的原始列表放入DSC配置数据文件中:</p>

<pre><code class="language-PS">@{
  AllNodes = @(
    @{
      NodeName = $env:COMPUTERNAME
      WindowsFeatures = @(
        @{
          Name = "Web-Server"
          Ensure = "Present"
        },
        @{
          Name = "Web-Mgmt-Tools"
          Ensure = "Present"
        },
        @{
          Name = "Web-Default-Doc"
          Ensure = "Present"
        }
      )
    }
  )
}
</code></pre>

<p>通过分离配置数据，我们可以缩短DSC PowerShell脚本并使其更加通用:</p>

<pre><code class="language-PS">Configuration WebServerConfiguration
{  
  Node $AllNodes.NodeName
  {        
    # Loop through the defined features
    ForEach($Feature in $Node.WindowsFeatures)
    {
      # Define component
      WindowsFeature $Feature.Name
      {
        Name = $Feature.Name
        Ensure = $Feature.Ensure
      }
    }
  }
}

WebServerConfiguration -OutputPath "C:\DscConfiguration" -ConfigurationData "C:\DscConfiguration\WebServer.psd1"

Start-DscConfiguration -Wait -Verbose -Path "C:\DscConfiguration"
</code></pre>

<p>在我们的新脚本中有两件事需要注意:</p>

<ul>
<li>对<code>WebServerConfiguration</code>的调用现在多了一个参数<code>ConfigurationData</code>。这告诉DSC包含要加载的配置数据的文件。</li>
<li>我们可以使用点符号引用DSC配置数据文件的属性。</li>
</ul>

<h2 id="detecting-drift">检测漂移</h2>

<p>如前所述，DSC可以检测某样东西是否不再处于所需状态。需要注意的是，DSC只能检测它被告知要关注的变化。使用我们的示例，如果有人安装了Web-Ftp-Server Windows特性，我们的DSC PowerShell脚本将不会报告任何内容。然而，如果有人删除了Web-Default-Doc，DSC将报告该特性不再处于期望的状态。当DSC配置不再处于所需状态时，我们称之为漂移。</p>

<p>要运行当前配置的测试，您可以运行<code>Test-DscConfiguration</code> cmdlet。如果配置处于期望的状态，<code>Test-DscConfiguration</code>返回<code>True</code>，如果发生了漂移，则返回<code>False</code>。传递<code>-Detailed</code>参数将返回漂移内外的资源列表:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2019-10/getting-started-with-powershell-dsc/test-dsc-configuration-success.png" class="zoom" data-title=""><img src="../Images/5a4aeb3b85fac5fc4de3a33d354c0edc.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2019-10/getting-started-with-powershell-dsc/test-dsc-configuration-success.png"/>T2】</a></p>

<p>让我们通过运行以下命令来删除Web-Default-Doc:</p>

<pre><code class="language-PS">Uninstall-WindowsFeature Web-Default-Doc
</code></pre>

<p>运行<code>Test-DscConfiguration -Detailed</code>:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2019-10/getting-started-with-powershell-dsc/test-dsc-configuration-failed.png" class="zoom" data-title=""><img src="../Images/7193be16da89c903267d1b1503eef5d4.png" class="img-fluid center" alt="" data-original-src="https://i.octopus.com/blog/2019-10/getting-started-with-powershell-dsc/test-dsc-configuration-failed.png"/>T2】</a></p>

<p>如您所见，机器已经漂移并识别出[windows feature]Default Doc(we b-Default-Doc)不再处于所需状态！</p>

<h3 id="automatically-correcting-drift">自动校正漂移</h3>

<p>您可以将本地配置管理器(LCM)配置为在检测到漂移时自动更正配置。为此，我们在DSC PowerShell脚本中放置了一个<code>LocalConfigurationManager</code>节点，并设置了<code>ConfigurationMode</code>属性。<code>ConfigurationMode</code>可以有三个值之一:</p>

<ul>
<li><code>ApplyOnly</code>:该设置指示LCM应用配置，不做任何其他事情。</li>
<li><code>ApplyAndMonitor</code>:该设置指示LCM应用配置并定期运行一致性检查(本质上是<code>Test-DscConfiguration</code>)。一致性检查的默认频率是15分钟，可以通过设置<code>ConfigurationModeFrequencyMins</code>属性来覆盖。</li>
<li><code>ApplyAndAutoCorrect</code>:该设置指示LCM应用配置并定期运行一致性检查。如果一致性检查返回<code>false</code>，LCM将重新应用配置，使机器回到所需状态。</li>
</ul>

<p>为了配置LCM自动校正漂移，我们将它设置为<code>ApplyAndAutoCorrect</code>:</p>

<pre><code class="language-PS">Configuration WebServerConfiguration
{  
  Node $AllNodes.NodeName
  {
    # Configure the LCM
    LocalConfigurationManager
    {
      ConfigurationMode = "ApplyAndAutoCorrect"
    }        

    # Loop through the defined features
    ForEach($Feature in $Node.WindowsFeatures)
    {
      # Define component
      WindowsFeature $Feature.Name
      {
        Name = $Feature.Name
        Ensure = $Feature.Ensure
      }
    }
  }
}

WebServerConfiguration -OutputPath "C:\DscConfiguration" -ConfigurationData "C:\DscConfiguration\WebServer.psd1"

Start-DscConfiguration -Wait -Verbose -Path "C:\DscConfiguration"
</code></pre>

<p>现在我们的服务器将自动纠正自己每当漂移被检测到！如果您启用了自动漂移校正，请确保您记录了它；否则，你或你团队中的某个人将会试图找出为什么你刚刚删除的东西又回来了！</p>

<h2 id="summary">摘要</h2>

<p>这篇博文教程提供了一些关于如何开始使用PowerShell DSC的基本信息，以及如何检测和有选择地自动纠正漂移。关于提到的混合方法的例子，请参考本系列的这篇<a href="https://octopus.com/blog/powershelldsc-as-template">文章</a>，在这篇文章中，我们将PowerShell DSC配置为像应用程序一样进行部署。</p>

                    
                    
</body>
</html>