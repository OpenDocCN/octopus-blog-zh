<html>
<head>
<title>Building the Octopus Cloud in AWS - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>在AWS - Octopus Deploy中构建Octopus云</h1>
<blockquote>原文：<a href="https://octopus.com/blog/building-the-octopus-cloud-in-aws#2021-08-12">https://octopus.com/blog/building-the-octopus-cloud-in-aws#2021-08-12</a></blockquote>
                        <p><a href="#" data-featherlight="https://i.octopus.com/blog/2018-06/blogimage-octopus-cloud.png" class="zoom" data-title=""><img src="../Images/46b02f9efcf816942ba81385bf4d7613.png" class="img-fluid center" alt="Octopus Deploy in the clouds illustration" data-original-src="https://i.octopus.com/blog/2018-06/blogimage-octopus-cloud.png"/>T2】</a></p>

<h2 id="intro">介绍</h2>

<p>在我们开始构建章鱼云平台之前，我们讨论了它应该托管在哪里。我们最终归结为两个选择:亚马逊网络服务(AWS)或微软Azure。</p>

<p>从那时起，我们选择了AWS，主要是因为团队中的大多数人都有使用AWS服务的经验，而不是因为两家云提供商之间有任何具体的技术差异。</p>

<p>兴奋地开始，我们在Windows上使用Docker和Kubernetes一头扎进了这个项目。这是大约八个月前的事了，虽然我们取得了一些成功，但感觉像是一场持续的艰苦战斗。当时Windows上的Docker和Kubernetes感觉没有Linux上的Docker和Kubernetes成熟，我们也不能用Linux，因为Octopus不是用。网络核心...还没有。</p>

<p>我们不得不做出一个艰难的决定:在花费了大量时间和精力之后继续使用Docker和Kubernetes，或者转向一种更传统的屡试不爽的方法，在这种方法中，每个客户都有自己的EC2实例。我们决定暂时使用EC2实例。这篇博文中的推理，理解MVP(最小可行产品)，以及为什么我更喜欢Henrik Kniberg的《最早可测试/可用/可爱》,对我们的思维有很大的影响。我们意识到从一开始就试图开发完美的产品对自己要求太高了。</p>

<h2 id="networking">建立工作关系网</h2>

<p>创建AWS帐户后的首要任务之一是删除默认子网和默认VPC，这样我们就可以创建自己的更大的网络掩码来容纳更多的客户。我们的想法是扩大规模，考虑到这一点，我们将生产VPC网络掩码设置为<code>/16</code>，将每个子网的网络掩码设置为<code>/20</code>。允许我们在每个VPC中容纳多达16个子网，每个子网容纳4，091个IP地址，总共提供65，456个IP地址。</p>

<p>我们的VPC和子网的设计基于AWS提供的<a href="https://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/VPC_Scenario2.html" rel="nofollow">场景2:具有公共和私有子网(NAT)的VPC</a>示例，如下所示:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2018-06/octopus-cloud-prod-vpc(1).png" class="zoom" data-title=""><img src="../Images/ce4cbff66a28307d372682d1b2cc0daa.png" class="img-fluid center" alt="Octopus Cloud Production VPC" data-original-src="https://i.octopus.com/blog/2018-06/octopus-cloud-prod-vpc(1).png"/></a>T2】</p>

<p>非高可用性Octopus云服务器分布在我们的公共子网中，并直接暴露于互联网。未来的高可用性Octopus云服务器将分布在我们的私有子网中，并通过应用负载平衡器暴露于互联网。</p>

<p>在撰写本文时，Octopus云服务器可以在俄勒冈州(us-west-2)地区的t2.medium EC2实例上提供，但没有高可用性。然而，在不太遥远的将来，悉尼(ap-southeast-2)、伦敦(eu-west-2)和法兰克福(eu-central-1)地区可能会成为可用的，以及将Octopus云服务器从一个地区迁移到另一个地区并增加高可用性的能力。</p>

<p>为了创建我们的VPC和子网，我们使用了<a href="https://www.terraform.io" rel="nofollow"> Terraform </a>，因为它的配置语法。</p>

<blockquote class="blockquote">
<p>Terraform使用HashiCorp配置语言(HCL ),这意味着在人类可读和可编辑以及机器友好之间取得平衡。</p>
</blockquote>

<p><em>来源:<a href="https://www.terraform.io/docs/configuration/syntax.html" rel="nofollow">地形配置语法</a> </em></p>

<p>例如，下面是一个为VPC配置公共和私有子网的模板。</p>

<pre><code class="language-python">provider "aws" {
  region  = "us-west-2"
}

resource "aws_vpc" "production" {
  cidr_block           = "10.10.0.0/16"
  instance_tenancy     = "default"
  enable_dns_support   = true
  enable_dns_hostnames = true

  tags {
    Name = "Production VPC"
  }
}

resource "aws_internet_gateway" "production" {
  vpc_id = "${aws_vpc.production.id}"

  tags {
    Name = "Production Internet Gateway"
  }
}

resource "aws_route_table" "public" {
  vpc_id = "${aws_vpc.production.id}"

  route {
    cidr_block = "0.0.0.0/0"
    gateway_id = "${aws_internet_gateway.production.id}"
  }

  tags {
    Name = "Production Subnet (Public A/B/C)"
  }
}

resource "aws_eip" "public_a" {
  vpc = true
}

resource "aws_subnet" "public_a" {
  vpc_id                  = "${aws_vpc.production.id}"
  cidr_block              = "10.10.0.0/20"
  availability_zone       = "us-west-2a"
  map_public_ip_on_launch = true

  tags {
    Name = "Production Subnet (Public A)"
  }
}

resource "aws_route_table_association" "public_a" {
  subnet_id      = "${aws_subnet.public_a.id}"
  route_table_id = "${aws_route_table.public.id}"
}

resource "aws_nat_gateway" "public_a" {
  allocation_id = "${aws_eip.public_a.id}"
  subnet_id     = "${aws_subnet.public_a.id}"

  tags {
    Name = "Production NAT Gateway (Public A)"
  }
}

resource "aws_subnet" "private_a" {
  vpc_id            = "${aws_vpc.production.id}"
  cidr_block        = "10.10.16.0/20"
  availability_zone = "us-west-2a"

  tags {
    Name = "Production Subnet (Private A)"
  }
}

resource "aws_route_table" "private_a" {
  vpc_id = "${aws_vpc.production.id}"

  route {
    cidr_block = "0.0.0.0/0"
    gateway_id = "${aws_nat_gateway.public_a.id}"
  }

  tags {
    Name = "Production Subnet (Private A)"
  }
}

resource "aws_route_table_association" "private_a" {
  subnet_id      = "${aws_subnet.private_a.id}"
  route_table_id = "${aws_route_table.private_a.id}"
}
</code></pre>

<p>如果你想将上面的Terraform模板与类似的CloudFormation模板(YAML)进行比较，AWS在这里提供了一个例子<a href="https://docs.aws.amazon.com/codebuild/latest/userguide/cloudformation-vpc-template.html" rel="nofollow"/>。</p>

<h2 id="security">安全性</h2>

<p>对于章鱼云来说，安全性是最重要的。</p>

<p>我们聘请<a href="https://www.insomniasec.com/" rel="nofollow">失眠安全</a>对章鱼云进行渗透和漏洞测试，结果非常积极，没有检测到重大或中度风险。</p>

<p>我们通过允许入站和出站连接所需的最少协议和端口，为生产VPC实施了严格的网络访问控制列表(ACL)。对于附属于每个Octopus云服务器和防火墙的安全组(SG)也是如此。</p>

<p>我们还禁用了不安全和脆弱的TLS密码套件Octopus云服务器仅支持TLS 1.2和TLS 1.1，这意味着Windows XP等旧客户端和旧浏览器无法访问UI。</p>

<h2 id="ec2-instances">EC2实例</h2>

<p>之前我提到过，我们目前在t2.medium EC2实例上运行Octopus云服务器，我认为这对大多数人来说会是一个惊喜。一个t2.medium EC2实例有2个vCPUs和4GB RAM，并且:</p>

<blockquote class="blockquote">
<p>与传统的EC2实例不同，T2实例提供了基准级别的CPU性能，并且能够在该基准级别之上爆发。基准性能和突发能力由CPU信用控制。</p>
</blockquote>

<p><em>来源:<a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/t2-instances.html" rel="nofollow"> AWS用户指南- T2实例</a> </em></p>

<p>t2 .培养基的基线水平是40%。当CPU利用率低于基线水平时，将累积CPU信用，当CPU利用率高于基线水平时，将消耗CPU信用。如果你的Octopus云服务器消耗了所有的信用，CPU将无法超过其基线水平。</p>

<p>在我们的封闭alpha、封闭beta和可用性会议期间，我们发现，在空闲时，Octopus云服务器使用大约1%的CPU在执行同步部署时，CPU利用率通常低于基线水平。</p>

<p>在我们的负载测试中，让我们措手不及的是，我们发现:</p>

<blockquote class="blockquote">
<p>T2标准实例可以获得启动信用的次数是有限制的。默认限制是每个帐户、每个地区、每个连续24小时内启动或开始所有T2标准实例的次数总和为100次。</p>
</blockquote>

<p><em>来源:<a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/t2-std.html" rel="nofollow"> AWS用户指南- T2标准</a> </em></p>

<p>为了解决这个问题，我们在EC2实例被提供后查询CloudWatch，以查看它是在有信用还是没有信用的情况下启动的。如果它启动时没有配额，我们会在EC2实例上临时启用T2无限制，直到它完成配置。</p>

<h2 id="whats-next">下一步是什么？</h2>

<p>允许客户在俄勒冈州(us-west-2)以外的AWS地区提供他们的Octopus云服务器是我们许多客户的要求。我们根据以下因素调查了哪些地区最有意义:</p>

<ul>
<li>冗余的可用区域的数量，</li>
<li>最低的性能延迟。</li>
<li>什么能给我们最好的全球覆盖。</li>
</ul>

<p>我们选择了悉尼(ap-southeast-2)、伦敦(eu-west-2)和法兰克福(eu-central-1)地区，它们将在我们推出章鱼云后不久可用。</p>

<p>在支持其他地区之后，我们还将提供在这些地区之间迁移Octopus云服务器的能力。</p>

<p>高可用性也是我们优先考虑的问题，可能会在我们支持悉尼和伦敦地区后推出。</p>

<p>我们在封闭测试版和封闭测试版中注意到，有一小部分客户在创建他们的章鱼云服务器时使用了像<code>test</code>、<code>demo</code>和<code>sandbox</code>这样的词作为他们子域的一部分。这让我们想到了客户想要<em>更改</em>他们的子域的场景，这个特性肯定会在不久的将来变得可用。</p>

<p>我们还没有放弃Docker和Kubernetes。我们相信，这些技术将使我们能够更快地供应Octopus云服务器，增加额外的安全层，并帮助我们充分利用共同租赁来节省成本。</p>

                    
                    
</body>
</html>