<html>
<head>
<title>Mixing Keys in Tomcat - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Tomcat - Octopus部署中的组合键</h1>
<blockquote>原文：<a href="https://octopus.com/blog/mixing-keys-in-tomcat#2022-07-20">https://octopus.com/blog/mixing-keys-in-tomcat#2022-07-20</a></blockquote>
                        <p>在<a href="/blog/sni-in-tomcat">之前的博客文章</a>中，我们看到了Tomcat 8.5+如何使用SNI将证书映射到请求的主机名。</p>

<p>Tomcat 8.5+可以更进一步，为每个主机支持多种证书类型。这对于在旧浏览器上支持RSA，而在兼容浏览器上支持ECDSA非常有用。</p>

<p>在这篇博文中，我们将看看如何为Tomcat配置多种证书类型。</p>

<h2 id="creating-self-signed-rsa-keys">创建自签名RSA密钥</h2>

<p>要生成RSA私钥和自签名证书，请使用以下命令:</p>

<pre><code>openssl req -x509 -newkey rsa:4096 -keyout rsa.key -out rsa.crt -days 365
</code></pre>

<h2 id="creating-self-signed-ecdsa-keys">创建自签名ECDSA密钥</h2>

<p>要创建ECDSA私钥，请使用以下命令:</p>

<pre><code>openssl ecparam -genkey -out ecdsa.key -name prime256v1
</code></pre>

<p><code>name</code>参数是命令返回的列表中的一个:</p>

<pre><code>openssl ecparam -list_curves
</code></pre>

<p>OpenSSL支持大量的曲线，但是浏览器通常只支持非常少的曲线。<a href="https://www.ssllabs.com/ssltest/clients.html" class="alert-link" rel="nofollow"> SSL Labs </a>允许你测试你的浏览器对命名曲线的支持。在下面的截图中可以看到Firefox 57支持的曲线:<code>x25519</code>、<code>secp256r1</code>、<code>secp384r1</code>、<code>secp521r1</code>。</p>
<p><code>secp256r1</code>是OpenSSL <code>prime256v1</code>曲线。</p>
<p><a href="#" data-featherlight="https://i.octopus.com/blog/2017-11/firefox-named-groups.png" class="zoom" data-title=""><img src="../Images/e681073a8cd8ef05ba3a0e4b002bae6d.png" class="img-fluid center" alt="Firefox Named Groups" data-original-src="https://i.octopus.com/blog/2017-11/firefox-named-groups.png"/>T2】</a></p>


<p>然后使用以下命令从私钥创建证书:</p>

<pre><code>openssl req -x509 -new -key ecdsa.key -out ecdsa.crt
</code></pre>

<h2 id="configuring-tomcat-with-multiple-keys">用多个键配置Tomcat</h2>

<p>为了支持两种证书类型，可以将多个<code>&lt;Certificate&gt;</code>元素添加到一个<code>&lt;SSLHostConfig&gt;</code>元素中。当定义了多个<code>&lt;Certificate&gt;</code>元素时，每个元素必须有一个惟一的<code>type</code>属性。RSA证书具有<code>RSA</code>类型，ECDSA证书具有<code>EC</code>类型。</p>

<p>这是Tomcat <code>server.xml</code>配置文件的一个片段，其中包含使用上面的OpenSSL命令创建的两个自签名证书和私钥。</p>

<pre><code class="language-xml">&lt;Connector SSLEnabled="true" port="62000" protocol="org.apache.coyote.http11.Http11AprProtocol"&gt;
  &lt;SSLHostConfig&gt;
    &lt;Certificate certificateFile="${catalina.base}/conf/ecdsa.crt" certificateKeyFile="${catalina.base}/conf/ecdsa.key" type="EC"/&gt;
    &lt;Certificate certificateFile="${catalina.base}/conf/rsa.crt" certificateKeyFile="${catalina.base}/conf/rsa.key" type="RSA"/&gt;
  &lt;/SSLHostConfig&gt;
&lt;/Connector&gt;
</code></pre>

<p>这个片段使用APR协议，该协议接受由OpenSSL创建的PEM文件。有关在Tomcat中启用APR的更多信息，请参见<a href="/blog/building-apr-for-tomcat" class="alert-link">构建Apache可移植运行时</a>。</p>


<h2 id="verifying-the-configuration">验证配置</h2>

<p><a href="https://www.htbridge.com" rel="nofollow">高科桥</a>有一个验证web服务器安全配置的在线服务。</p>

<p>在这个截图中，我们可以看到Tomcat服务器已经公开了RSA和ECDSA证书。</p>

<p>【T2 <img src="../Images/69cfa35535f5b158cd5f7004ea1af640.png" class="img-fluid center" alt="Cert Info" data-original-src="https://i.octopus.com/blog/2017-11/cert-info.png"/></p>

<h2 id="conclusion">结论</h2>

<p>Tomcat在为单个HTTPS端口支持RSA和ECDSA证书的能力方面是非常独特的。这使得Tomcat可以在不牺牲安全性的情况下，为各种客户端提供HTTPS。这种配置可以简单地通过定义两个具有不同<code>type</code>属性的<code>&lt;Connector&gt;</code>元素来实现。</p>

<p>如果您对Java应用程序的自动化部署感兴趣，<a href="https://octopus.com/downloads">下载Octopus Deploy的试用版</a>，并查看我们的文档。</p>

                    
                    
</body>
</html>