<html>
<head>
<title>Using Azure Key Vault with Octopus - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>使用Azure Key Vault和Octopus - Octopus Deploy</h1>
<blockquote>原文：<a href="https://octopus.com/blog/using-azure-key-vault-with-octopus#2021-12-16">https://octopus.com/blog/using-azure-key-vault-with-octopus#2021-12-16</a></blockquote>
                        <p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-06/using-azure-key-vault-with-octopus/blogimage-azure-key-vault-step-template-2021.jpg" class="zoom" data-title=""><img src="../Images/4e0f6165a00cedd10895c1cf6ef38c59.png" class="img-fluid center" alt="Using Azure Key Vault with Octopus Deploy" data-original-src="https://i.octopus.com/blog/2021-06/using-azure-key-vault-with-octopus/blogimage-azure-key-vault-step-template-2021.jpg"/>T2】</a></p>

<p>我最近写了关于使用step模板扩展Octopus的功能以集成HashiCorp Vault的文章。后来，几个人问我是否打算创建step模板来与其他secret managers集成。</p>

<p>在这篇文章中，我介绍了一个新的步骤模板，<a href="https://library.octopus.com/step-templates/6f59f8aa-b2db-4f7a-b02d-a72c13d386f0/actiontemplate-azure-key-vault-retrieve-secrets" rel="nofollow">Azure Key Vault-Retrieve Secrets</a>，它旨在从Azure Key Vault中检索机密，以便在您的部署或操作手册中使用。</p>

<h2 id="introduction">介绍</h2>

<p>这篇文章假设读者对定制步骤模板和Octopus社区库比较熟悉。</p>

<p>此外，这篇文章没有详细介绍Azure Key Vault的概念或如何设置它。你可以通过阅读微软的Azure Key Vault基本概念指南来了解更多信息。</p>

<p>本文中的步骤模板使用<a href="https://docs.microsoft.com/en-us/powershell/module/az.keyvault/" rel="nofollow"> Az从<a href="https://azure.microsoft.com/en-gb/services/key-vault/" rel="nofollow"> Azure密钥库</a>中检索秘密。KeyVault </a> PowerShell模块。该模块必须下载并安装在部署目标或工作器上，然后该步骤才能成功检索机密。step模板已经在Windows和Linux上测试过了(安装了<code>PowerShell Core</code>)。</p>

<h2 id="authentication">证明</h2>

<p>在您可以从Azure Key Vault检索机密之前，您必须向Azure进行身份验证。在他们的<a href="https://docs.microsoft.com/en-us/azure/key-vault/general/authentication" rel="nofollow">认证概念文档</a>中，微软指出:</p>

<blockquote class="blockquote">
<p>使用Key Vault的身份验证与Azure Active Directory (Azure AD)协同工作，后者负责对任何给定安全主体的身份进行身份验证。</p>
</blockquote>

<p>在Octopus中，Azure Key Vault的身份验证可以通过一个<a href="https://octopus.com/docs/infrastructure/accounts/azure"> Azure帐户</a>使用服务主体来实现。</p>

<p>除了访问Azure中的资源，您的服务主体可能需要配置更多权限来访问和检索Azure Key Vault中存储的机密。要了解更多信息，请阅读关于如何使用Azure基于角色的访问控制提供对密钥、证书和秘密的访问的Azure Key Vault RBAC指南。</p>


<h2 id="retrieving-secrets">找回秘密</h2>

<p><a href="https://library.octopus.com/step-templates/6f59f8aa-b2db-4f7a-b02d-a72c13d386f0/actiontemplate-azure-key-vault-retrieve-secrets" rel="nofollow">Azure Key Vault-Retrieve Secrets</a>步骤模板从Azure Key Vault中检索一个或多个机密，并为每个检索到的机密创建敏感的输出变量。</p>

<p>对于每个秘密，您可以选择检索一个特定的版本，并提供一个定制的输出变量名。</p>

<p>检索一个秘密需要:</p>

<ul>
<li>有权限访问机密的Azure帐户。</li>
<li>要从中检索机密的Azure密钥库的名称。</li>
<li>要检索的机密的名称。</li>
</ul>

<p>step模板的一个高级特性支持一次检索多个机密。这需要在新的一行中输入每个秘密。</p>

<p>对于检索到的每个秘密，创建一个<a href="https://octopus.com/docs/projects/variables/output-variables#sensitive-output-variables">敏感输出变量</a>用于后续步骤。默认情况下，任务日志中只会显示已创建变量的数量。要查看任务日志中的变量名，将<strong>打印输出变量名</strong>参数更改为<code>True</code>。</p>

<h3 id="parameters">步骤模板参数</h3>

<p>步骤模板使用以下参数:</p>

<ul>
<li><p><code>Azure Account</code>:一个Azure账户，有权限从Azure Key Vault中检索机密。</p>
</li>
<li><p><code>Vault Name</code>:要从中检索机密的Azure Key Vault的名称。</p>
</li>
<li><p><code>Vault Secrets to retrieve</code>:指定从Azure Key Vault返回的秘密名称，格式:<code>SecretName SecretVersion | OutputVariableName</code>其中:</p>
<ul>
<li><code>SecretName</code>是要检索的秘密的名称。</li>
<li><code>SecretVersion</code>是<em>可选的</em>版本的秘密检索。<em>如果未指定该值，将检索最新版本</em>。</li>
<li><code>OutputVariableName</code>是<em>可选</em> Octopus <a href="https://octopus.com/docs/projects/variables/output-variables">输出变量</a>的名称，用于存储秘密值。<em>如果未指定该值，将动态生成一个输出名称</em>。</li>
</ul>
<p><strong>注意:</strong>通过在新的一行中输入每个字段，可以检索多个字段。</p>
</li>
<li><p><code>Print output variable names</code>:将Octopus <a href="https://octopus.com/docs/projects/variables/output-variables">输出变量</a>名称写入任务日志。默认:<code>False</code>。</p>
</li>
<li><p><code>Az PowerShell Module version (optional)</code>:如果您希望使用特定版本的<code>Az</code> PowerShell模块(而非默认版本)，请在此输入版本号。如<code>5.9.0</code>。</p>
<p><strong>注意:</strong>指定的版本必须存在于机器上。</p>
</li>
<li><p><code>Az PowerShell Install Location (optional)</code>:如果您希望为<code>Az</code> PowerShell模块提供自定义路径(而不是默认路径)，请在此输入值。</p>
<p><strong>注意:</strong>模块必须存在于机器上的指定位置。此步骤模板不会下载模块。</p>
</li>
</ul>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-06/using-azure-key-vault-with-octopus/azure-keyvault-retrieve-secrets-step-parameters.png" class="zoom" data-title=""><img src="../Images/a407b6607a464fd2880bd131ff6f23d0.png" class="img-fluid center" alt="Parameters for the step" data-original-src="https://i.octopus.com/blog/2021-06/using-azure-key-vault-with-octopus/azure-keyvault-retrieve-secrets-step-parameters.png"/>T2】</a></p>

<h3 id="using-the-step">使用步骤</h3>

<p>以与其他步骤相同的方式将<strong>Azure Key Vault-Retrieve Secrets</strong>步骤添加到部署和runbook流程中。</p>

<p>将步骤添加到流程后，填写步骤中的参数:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-06/using-azure-key-vault-with-octopus/azure-keyvault-retrieve-secrets-step-in-process.png" class="zoom" data-title=""><img src="../Images/02d7d43b2d65aac78420d95093173c28.png" class="img-fluid center" alt="Azure Key Vault retrieve secrets step used in a process" data-original-src="https://i.octopus.com/blog/2021-06/using-azure-key-vault-with-octopus/azure-keyvault-retrieve-secrets-step-in-process.png"/>T2】</a></p>

<p>填写完参数后，您可以在操作手册或部署流程中执行该步骤。成功执行后，任何匹配的机密都将被存储为敏感的输出变量。如果您已将步骤配置为打印变量名，它们将出现在任务日志中:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2021-06/using-azure-key-vault-with-octopus/azure-keyvault-retrieve-secrets-step-output-variable.png" class="zoom" data-title=""><img src="../Images/fbfdfff5639b77a5e5a4a8808e82155c.png" class="img-fluid center" alt="Azure Key Vault retrieve secrets step task log" data-original-src="https://i.octopus.com/blog/2021-06/using-azure-key-vault-with-octopus/azure-keyvault-retrieve-secrets-step-output-variable.png"/>T2】</a></p>

<p>在后续步骤中，从匹配密码创建的输出变量可以在您的部署或runbook中使用。</p>

<p><strong>提示:</strong>对于任何输出变量名，记得用您的步骤名替换<code>Azure Key Vault - Retrieve Secrets</code>。</p>


<h2 id="conclusion">结论</h2>

<p>这篇文章中提到的步骤模板演示了与Azure Key Vault集成并利用Octopus部署或runbooks中存储的秘密是很容易的。</p>

<p>愉快的部署！</p>

                    
                    
</body>
</html>