<html>
<head>
<title>Outage on octopus.com - report and learnings - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>octopus.com停电-报告和学习-八达通部署</h1>
<blockquote>原文：<a href="https://octopus.com/blog/outage-octopus-report-learnings-feb23#2023-02-13">https://octopus.com/blog/outage-octopus-report-learnings-feb23#2023-02-13</a></blockquote>
                        <p>从世界协调时2023年1月25日星期三下午3:37到世界协调时2023年1月26日星期四下午3:44，部分地区的客户无法访问octopus.com/signin,博客、文档和其他网址，因为他们返回了HTTP 404(未找到页面)响应。这主要影响了美国和欧盟，对亚洲地区也有一些间歇性的影响。</p>

<p>在本帖中，我们详细描述了事情的经过、我们的反应和我们的收获。</p>

<h2 id="how-the-incident-started">事件是如何开始的</h2>

<p>1月25日，作为DNS和路由提供商迁移计划的一部分，我们对<code>octopus.com</code>和<code>octopusdeploy.com</code>域名进行了定期维护。在这一步迁移中，一个Azure前门(AFD)配置文件中的路由设置被转移到另一个AFD配置文件。新的AFD配置文件未按预期运行。</p>

<p>我们发现新的AFD配置文件错误地路由了某些地区的请求子集，导致HTTP 404响应。我们在状态页面上公布了计划维护的服务中断。</p>

<p>我们将此视为意外事件，因为维护没有按计划进行，并且存在复杂因素:</p>

<ul>
<li>Azure的网络中断</li>
<li>AFD中的内部路由问题</li>
<li>新晶片在我们的应用中产生了显著的噪声</li>
<li>这个问题发生在澳大利亚的公共假期，我们的许多工程师都在那里工作</li>
</ul>

<p>对AFD配置文件的更改无法安全回滚。</p>

<h2 id="key-timings">按键计时</h2>

<table class="table">
<thead>
<tr>
<th>事件</th>
<th>期间</th>
</tr>
</thead>
<tbody>
<tr>
<td>检测时间</td>
<td>10小时21分钟</td>
</tr>
<tr>
<td>事件申报时间</td>
<td>13小时27分</td>
</tr>
<tr>
<td>解决问题的时间</td>
<td>37小时44分钟</td>
</tr>
</tbody>
</table>

<h2 id="incident-timeline">事故时间表</h2>

<p><em>(以下所有日期和时间均以UTC表示)</em></p>

<h3 id="wednesday-january-25-2023">2023年1月25日星期三</h3>

<p><strong> <em> 02:00 </em> </strong>一名Octopus工程师部署了对<code>octopus.com</code>和<code>octopusdeploy.com</code>域的更改，在Azure前门配置文件之间移动相关路由，作为迁移项目的一部分。</p>

<p><strong> <em> 02:39 </em> </strong>工程师将AFD WAF从预防模式切换到检测模式，因为它阻塞了有效流量。</p>

<p><strong><em>07:05</em></strong>Azure的网络中断掩盖了这个问题——参见我们的<a href="https://octopus.com/blog/cloud-connectivity-disruption-report-learnings">章鱼云连接中断报告</a>。</p>

<p><strong> <em> 12:21 </em> </strong>欧盟地区的一名应用支持工程师报告称在<code>octopus.com</code>域上遇到间歇性404。</p>

<p><strong> <em> 12:43 </em> </strong> Azure的网络中断问题得到全面解决。</p>

<p><strong> <em> 14:06 </em> </strong>报告第一个面向客户的问题。</p>

<p><strong> <em> 14:06 - 15:27 </em> </strong>应用支持工程师调查了该问题，并确定该问题是间歇性的，影响了欧盟和美国地区的客户。</p>

<p><strong> <em> 15:27 </em> </strong>状态页面更新:宣布发生事件。</p>


<p><strong> <em> 15:27 - 17:06 </em> </strong>调查显示，受影响航线的web app和数据库均无明显负载。新的AFD档案报告了对CNAME记录的警告。</p>

<p><strong> <em> 17:06 </em> </strong>随叫随到工程师确定问题出在AFD，因为端点动态解析为2个IP地址，其中一个IP地址始终返回404。</p>

<p><strong> <em> 17:22 </em> </strong>状态页面更新:我们正在继续调查此问题。</p>


<p><strong> <em> 17:35 </em> </strong>天蓝色支持票以“严重性:B”提出。</p>

<p><strong> <em> 18:32 </em> </strong>状态页面更新:已确定受影响地区。</p>


<p><strong> <em> 20:32 </em> </strong>事件被上报给负责AFD迁移项目的工程师。</p>

<p><strong> <em> 20:32 - 21:42 </em> </strong>我们调查了AFD中2个域关于CNAME记录的警告。</p>

<p><strong> <em> 21:36 </em> </strong>状态页面更新:内部升级。</p>


<p><strong> <em> 21:42 </em> </strong>我们与Azure支持代表通了电话，他们建议有关CNAME记录的警告可能是根本问题。</p>

<p><strong> <em> 21:42 - 22:26 </em> </strong>基于CNAME变平是根本原因的假设，试图采取缓解措施。</p>

<p><strong> <em> 22:26 </em> </strong>根据从受影响端点解析的2个IP地址之一的成功请求，CNAME扁平化被排除为原因。它还成功地对以前的AFD概况进行了大约一年的工作。我们的工程师重点关注AFD剖面中的故障线路。</p>

<p><strong> <em> 22:37 </em> </strong>有Azure的支持票升级为“严重性:A”。</p>

<p><strong> <em> 22:37 - 02:01 </em> </strong>我们的工程师与Azure支持代表密切合作，为Azure提供足够的信息来识别和重现问题。</p>

<p><strong> <em> 22:59 </em> </strong>状态页面更新:云提供商升级。</p>


<h3 id="thursday-january-26-2023">2023年1月26日星期四</h3>

<p><strong> <em> 02:01 </em> </strong>发现了一个新的潜在根本原因，导致向原始DNS提供商提出支持请求。</p>

<p>一名Azure应用程序支持工程师注意到AFD配置文件中有大量的404请求，这是由于将WAF的模式设置为<code>detection</code>而不是<code>prevention</code>。</p>

<p><strong> <em> 03:12 </em> </strong>由于时间太长，没有明确的解决途径，事件在内部升级，以召集高级工程管理人员。</p>

<p><strong> <em> 04:15 </em> </strong>发现路线问题:重新关注AFD配置文件。</p>

<p><strong> <em> 04:19 </em> </strong>状态页面更新:事件状态更改为已识别。</p>


<p><strong> <em> 05:42 </em> </strong>以前的云提供商建议他们的主机解析到正确的IP地址，并建议请求公共解析器刷新他们的DNS缓存。</p>

<p><strong> <em> 05:43 </em> </strong>建议在AFD中使用<code>www</code>子域控制请求解析的潜在缓解措施。</p>

<p><strong> <em> 07:06 </em> </strong> Azure建议AFD不能支持CNAME扁平化。</p>

<p><strong> <em> 07:13 </em> </strong>内部上报，涉及信托&amp;安全和安保部门。</p>

<p><strong> <em> 07:31 </em> </strong> Azure确认他们看到的唯一解决途径是将所有DNS记录移动到Azure DNS。Azure确认他们会将正确的配置同步到所有边缘节点。</p>

<p><strong> <em> 08:49 </em> </strong>我们为<code>www.octopus.com</code>创建了一个新的AFD端点，并通过现有的DNS提供商添加了一个来自CNAME的重定向。</p>

<p><strong> <em> 08:53 </em> </strong>更新应用服务接受新的原点头。</p>

<p><strong> <em> 09:26 </em> </strong>禁用从<code>www.octopus.com</code>到<code>octopus.com</code>的app级重定向。</p>

<p><strong> <em> 10:05 </em> </strong>更新了受影响的SSO服务的配置。</p>

<p><strong> <em> 10:07 </em> </strong>将根octopus.com改为CNAME，并创建了一个从<code>octopus.com</code>到<code>www.octopus.com</code>的302重定向。</p>

<p><strong> <em> 10:18 </em> </strong>测试显示先前中断的路线再次工作。</p>

<p><strong> <em> 11:07 </em> </strong>状态页面更新:事件状态更改为<code>Monitoring</code>，并发布了如何解决的建议。</p>


<p><strong> <em> 11:10 </em> </strong>内部报告显示，受影响的欧盟地区从“大部分不工作”转变为“大部分工作”。</p>

<p><strong> <em> 11:49 </em> </strong>内部报告显示<code>octopus.com</code>还是404ing。</p>

<p><strong> <em> 12:19 </em> </strong>确认AFD内部的路由问题仍在发生，尽管本应应用一个包罗万象的规则。</p>

<p><strong> <em> 12:36 </em> </strong>试图通过创建一组明确的规则来强制AFD路由某些URL。</p>

<p><strong> <em> 12:38 </em> </strong>状态页面更新:事件状态改回<code>identified</code>。</p>


<p><strong> <em> 13:23 </em> </strong> Azure证实他们重现了该问题，并与一个产品小组合作进行修复。</p>

<p><strong> <em> 14:30 </em> </strong>可用性测试开始报告成功。</p>

<p><strong> <em> 14:53 </em> </strong> Azure证实一小时前应用了一个修复程序。</p>

<p><strong> <em> 15:07 </em> </strong>状态页面更新:事件状态改回监控。</p>


<p><strong> <em> 15:44 </em> </strong>状态页面更新:事件已解决。</p>


<h2 id="technical-details">技术细节</h2>

<p>出现404是因为客户的请求被发送到了错误的web应用程序。这404个反应具有地区特异性和间歇性。找出错误路由的确切原因非常复杂。我们需要深入研究Azure前门(AFD)中DNS提供商和端点路由之间的关系。</p>

<h3 id="what-we-observed">我们观察到的</h3>

<p><code>octopus.com</code>域的特定AFD端点<code>octo-public-prod-endpoint-f2e5gmecbdf3bfg9.z01.azurefd.net</code>被动态解析为2个IP地址之一。两个IP地址中的一个在所有相关路由<code>/signin</code>、<code>/docs</code>和<code>/blog</code>上返回404，而另一个IP地址工作正常。</p>

<p>这表明CNAME警告不太可能是原因，因为一些流量被成功路由。</p>

<p>我们发现AFD路由解析的2个IP地址不同于预期接收此流量的web应用程序的A-B对的IP地址。</p>

<h3 id="what-happened">发生了什么</h3>

<p>当路由改变发生时，AFD不更新它的所有节点，所以一些AFD节点仍然将流量定向到不正确的web应用。受影响的端点在迁移前解析到不正确的应用程序。没有对CNAME记录的控制，AFD就不能权威地更新扁平化的A记录。</p>

<p>我们在AFD上建立了一个CNAME记录，让他们对该子域上的所有请求进行权威控制。受影响端点上不正确的IP地址解析行为仍在继续。</p>

<p>在Azure通知我们他们已经进行了内部更改后，AFD内部的错误路由停止了。</p>



<p>有两个不相关的因素:</p>

<ul>
<li>来自晶圆的404个错误</li>
<li>顶点域上的CNAME平坦化</li>
</ul>

<p>在实践中，删除代理和切换到AFD的WAF与这个问题无关。然而，他们制造了巨大的噪音，掩盖了真正的问题。</p>

<p>类似地，在顶点域上使用CNAME展平使得原因不清楚。CNAME扁平化是指DNS提供商为底层IP地址的动态解析创建一系列A记录，而不是单个CNAME记录。你可以在Cloudflare 的这个<a href="https://blog.cloudflare.com/introducing-cname-flattening-rfc-compliant-cnames-at-a-domains-root/" rel="nofollow">讲解器里了解更多。</a></p>

<p>基于我们对问题的最佳理解，我们在受影响的域上创建了一个<code>www</code>子域。我们在这个子域上创建了一个CNAME记录，让AFD对解决该域的所有请求进行权威控制。然后，我们将流量从受影响的域重定向到适当的<code>www</code>子域。</p>

<p>这种缓解最初有所帮助，但AFD端点中不正确的IP地址解析再次出现。在Azure通知他们对我们的AFD档案进行了更改后，IP问题得到了解决。</p>

<p>我们知道Azure将受影响的AFD档案“从传统平台转移到最新平台”，但在撰写本文时，我们尚未得到官方确认。</p>

<p>在我们了解问题之后，我们考虑回滚AFD配置文件的更改。我们决定不这样做，因为我们知道只有AFD节点的子集会更新，使一些区域处于中断状态。</p>

<h2 id="next-steps">后续步骤</h2>

<p>为了帮助我们更深入地了解这一事件，我们就此问题与我们的Azure客户经理进行了接洽。</p>

<p>解决后，我们立即解决了<code>www</code>子域缓解的影响，特别是在CORS、静态资产和SEO方面。</p>

<p>在我们回到稳定状态后，我们继续迁移项目。我们对项目进行了调整，使其与Azure紧密合作，以确保我们的更改按预期进行。在我们进行迁移的过程中，我们继续有计划的停机时间。基于我们的经验，我们可以设计回滚安全的迁移步骤。这有助于我们在出现意外行为时立即回滚，从而将计划停机的影响降至最低。</p>

<p>我们进行了一次事故回顾，并确定了需要改进的地方:</p>

<ul>
<li><p>开发过程:我们正在审查开发过程中的质量控制，以确定在将更改应用到生产环境之前，我们可以在哪里发现问题。</p>
</li>
<li><p>长期运行事件的事件响应流程:我们以前从未经历过如此长时间的事件。我们开始找不到合适的待命工程师来管理事故。我们正在调查其他内部和外部团队如何管理这些情况，并相应地更新我们的待命名单和指南。</p>
</li>
</ul>

<h2 id="conclusion">结论</h2>

<p>Octopus Deploy非常重视服务可用性。解决这一事件的时间比我们预期的要长。我们对此次停电给我们的客户带来的不便深表歉意。</p>

                    
                    
</body>
</html>