<html>
<head>
<title>Creating an EC2 Octopus Worker with CloudFormation - Octopus Deploy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>使用CloudFormation - Octopus Deploy创建EC2 Octopus Worker</h1>
<blockquote>原文：<a href="https://octopus.com/blog/creating-aws-cf-octopus-worker-cloudformation#2022-07-04">https://octopus.com/blog/creating-aws-cf-octopus-worker-cloudformation#2022-07-04</a></blockquote>
                        <p>Workers允许您将部署的执行委托给一台机器，该机器具有对正在修改的资源的特权访问，安装了专门的工具，或者只是为了消除从Octopus服务器执行部署的负担。</p>

<p>EC2实例为托管Octopus工人提供了一个逻辑解决方案。</p>

<p>在本文中，您将学习如何使用CloudFormation将Octopus Worker部署到新的EC2实例上。</p>

<h2 id="the-complete-template">完整的模板</h2>

<p>下面的CloudFormation模板在新VPC的公共子网中部署了一个EC2实例，并作为VMs初始化的一部分安装了一个Octopus触手作为Worker:</p>

<pre><code class="language-yaml">AWSTemplateFormatVersion: 2010-09-09
Parameters:
  InstanceTypeParameter:
    Type: String
    Default: t3a.medium
    AllowedValues:
    - c1.medium
    - c1.xlarge
    - c3.2xlarge
    - c3.4xlarge
    - c3.8xlarge
    - c3.large
    - c3.xlarge
    - c4.2xlarge
    - c4.4xlarge
    - c4.8xlarge
    - c4.large
    - c4.xlarge
    - c5.12xlarge
    - c5.18xlarge
    - c5.24xlarge
    - c5.2xlarge
    - c5.4xlarge
    - c5.9xlarge
    - c5.large
    - c5.metal
    - c5.xlarge
    - c5a.12xlarge
    - c5a.16xlarge
    - c5a.24xlarge
    - c5a.2xlarge
    - c5a.4xlarge
    - c5a.8xlarge
    - c5a.large
    - c5a.xlarge
    - c5d.12xlarge
    - c5d.18xlarge
    - c5d.24xlarge
    - c5d.2xlarge
    - c5d.4xlarge
    - c5d.9xlarge
    - c5d.large
    - c5d.metal
    - c5d.xlarge
    - c5n.18xlarge
    - c5n.2xlarge
    - c5n.4xlarge
    - c5n.9xlarge
    - c5n.large
    - c5n.metal
    - c5n.xlarge
    - c6g.12xlarge
    - c6g.16xlarge
    - c6g.2xlarge
    - c6g.4xlarge
    - c6g.8xlarge
    - c6g.large
    - c6g.medium
    - c6g.metal
    - c6g.xlarge
    - c6gd.12xlarge
    - c6gd.16xlarge
    - c6gd.2xlarge
    - c6gd.4xlarge
    - c6gd.8xlarge
    - c6gd.large
    - c6gd.medium
    - c6gd.metal
    - c6gd.xlarge
    - d2.2xlarge
    - d2.4xlarge
    - d2.8xlarge
    - d2.xlarge
    - g2.2xlarge
    - g2.8xlarge
    - g3.16xlarge
    - g3.4xlarge
    - g3.8xlarge
    - g4dn.12xlarge
    - g4dn.16xlarge
    - g4dn.2xlarge
    - g4dn.4xlarge
    - g4dn.8xlarge
    - g4dn.metal
    - g4dn.xlarge
    - i2.2xlarge
    - i2.4xlarge
    - i2.8xlarge
    - i2.xlarge
    - i3.16xlarge
    - i3.2xlarge
    - i3.4xlarge
    - i3.8xlarge
    - i3.large
    - i3.metal
    - i3.xlarge
    - i3en.12xlarge
    - i3en.24xlarge
    - i3en.2xlarge
    - i3en.3xlarge
    - i3en.6xlarge
    - i3en.large
    - i3en.metal
    - i3en.xlarge
    - inf1.24xlarge
    - inf1.2xlarge
    - inf1.6xlarge
    - inf1.xlarge
    - m1.large
    - m1.medium
    - m1.small
    - m1.xlarge
    - m2.2xlarge
    - m2.4xlarge
    - m2.xlarge
    - m3.2xlarge
    - m3.large
    - m3.medium
    - m3.xlarge
    - m4.10xlarge
    - m4.16xlarge
    - m4.2xlarge
    - m4.4xlarge
    - m4.large
    - m4.xlarge
    - m5.12xlarge
    - m5.16xlarge
    - m5.24xlarge
    - m5.2xlarge
    - m5.4xlarge
    - m5.8xlarge
    - m5.large
    - m5.metal
    - m5.xlarge
    - m5a.12xlarge
    - m5a.16xlarge
    - m5a.24xlarge
    - m5a.2xlarge
    - m5a.4xlarge
    - m5a.8xlarge
    - m5a.large
    - m5a.xlarge
    - m5ad.12xlarge
    - m5ad.16xlarge
    - m5ad.24xlarge
    - m5ad.2xlarge
    - m5ad.4xlarge
    - m5ad.8xlarge
    - m5ad.large
    - m5ad.xlarge
    - m5d.12xlarge
    - m5d.16xlarge
    - m5d.24xlarge
    - m5d.2xlarge
    - m5d.4xlarge
    - m5d.8xlarge
    - m5d.large
    - m5d.metal
    - m5d.xlarge
    - m5zn.12xlarge
    - m5zn.2xlarge
    - m5zn.3xlarge
    - m5zn.6xlarge
    - m5zn.large
    - m5zn.metal
    - m5zn.xlarge
    - m6g.12xlarge
    - m6g.16xlarge
    - m6g.2xlarge
    - m6g.4xlarge
    - m6g.8xlarge
    - m6g.large
    - m6g.medium
    - m6g.metal
    - m6g.xlarge
    - m6gd.12xlarge
    - m6gd.16xlarge
    - m6gd.2xlarge
    - m6gd.4xlarge
    - m6gd.8xlarge
    - m6gd.large
    - m6gd.medium
    - m6gd.metal
    - m6gd.xlarge
    - m6i.12xlarge
    - m6i.16xlarge
    - m6i.24xlarge
    - m6i.2xlarge
    - m6i.32xlarge
    - m6i.4xlarge
    - m6i.8xlarge
    - m6i.large
    - m6i.metal
    - m6i.xlarge
    - r3.2xlarge
    - r3.4xlarge
    - r3.8xlarge
    - r3.large
    - r3.xlarge
    - r4.16xlarge
    - r4.2xlarge
    - r4.4xlarge
    - r4.8xlarge
    - r4.large
    - r4.xlarge
    - r5.12xlarge
    - r5.16xlarge
    - r5.24xlarge
    - r5.2xlarge
    - r5.4xlarge
    - r5.8xlarge
    - r5.large
    - r5.metal
    - r5.xlarge
    - r5a.12xlarge
    - r5a.16xlarge
    - r5a.24xlarge
    - r5a.2xlarge
    - r5a.4xlarge
    - r5a.8xlarge
    - r5a.large
    - r5a.xlarge
    - r5ad.12xlarge
    - r5ad.16xlarge
    - r5ad.24xlarge
    - r5ad.2xlarge
    - r5ad.4xlarge
    - r5ad.8xlarge
    - r5ad.large
    - r5ad.xlarge
    - r5d.12xlarge
    - r5d.16xlarge
    - r5d.24xlarge
    - r5d.2xlarge
    - r5d.4xlarge
    - r5d.8xlarge
    - r5d.large
    - r5d.metal
    - r5d.xlarge
    - r5n.12xlarge
    - r5n.16xlarge
    - r5n.24xlarge
    - r5n.2xlarge
    - r5n.4xlarge
    - r5n.8xlarge
    - r5n.large
    - r5n.metal
    - r5n.xlarge
    - r6g.12xlarge
    - r6g.16xlarge
    - r6g.2xlarge
    - r6g.4xlarge
    - r6g.8xlarge
    - r6g.large
    - r6g.medium
    - r6g.metal
    - r6g.xlarge
    - r6gd.12xlarge
    - r6gd.16xlarge
    - r6gd.2xlarge
    - r6gd.4xlarge
    - r6gd.8xlarge
    - r6gd.large
    - r6gd.medium
    - r6gd.metal
    - r6gd.xlarge
    - t1.micro
    - t2.2xlarge
    - t2.large
    - t2.medium
    - t2.micro
    - t2.nano
    - t2.small
    - t2.xlarge
    - t3.2xlarge
    - t3.large
    - t3.medium
    - t3.micro
    - t3.nano
    - t3.small
    - t3.xlarge
    - t3a.2xlarge
    - t3a.large
    - t3a.medium
    - t3a.micro
    - t3a.nano
    - t3a.small
    - t3a.xlarge
    - t4g.2xlarge
    - t4g.large
    - t4g.medium
    - t4g.micro
    - t4g.nano
    - t4g.small
    - t4g.xlarge
    - z1d.12xlarge
    - z1d.2xlarge
    - z1d.3xlarge
    - z1d.6xlarge
    - z1d.large
    - z1d.metal
    - z1d.xlarge
  WorkstationIp:
    Type: String
    Description: The IP address of the workstation that can RDP into the instance.
  Key:
    Type: String
    Description: The key used to access the instance.
  OctopusURL:
    Type: String
    Description: The URL of the Octopus instance to connect to.
  OctopusAPI:
    Type: String
    Description: The Octopus API key.
  OctopusSpace:
    Type: String
    Description: The Octopus space.
  OctopusWorkerPool:
    Type: String
    Description: The Octopus worker pool.
Mappings:
  RegionMap:
    eu-north-1:
      ami: ami-0f541966b45340fce
    ap-south-1:
      ami: ami-00c7dbcc1310fd066
    eu-west-3:
      ami: ami-0bce8e5f8fd912af2
    eu-west-2:
      ami: ami-02a7ca2a9d03676bf
    eu-west-1:
      ami: ami-02c55114d1d2a8201
    ap-northeast-3:
      ami: ami-02d358004635cea15
    ap-northeast-2:
      ami: ami-0dcf592770858a733
    ap-northeast-1:
      ami: ami-0a428a8bcfce0f804
    sa-east-1:
      ami: ami-035b4cb75ab88f259
    ca-central-1:
      ami: ami-0583af09af7e435f3
    ap-southeast-1:
      ami: ami-09df7bed19956d10b
    ap-southeast-2:
      ami: ami-0666dd0a9eccbab7d
    eu-central-1:
      ami: ami-0e8f6957a4eb67446
    us-east-1:
      ami: ami-0ba45cd7fcf163404
    us-east-2:
      ami: ami-086e001f1a73d208c
    us-west-1:
      ami: ami-0bd3976c0dbacc605
    us-west-2:
      ami: ami-04e6179c63d17513d
Resources:
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      Tags:
        - Key: Name
          Value: Linux VPC
  InternetGateway:
    Type: AWS::EC2::InternetGateway
  VPCGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway
  SubnetA:
    Type: AWS::EC2::Subnet
    Properties:
      AvailabilityZone: !Select 
        - 0
        - !GetAZs 
      VpcId: !Ref VPC
      CidrBlock: 10.0.0.0/24
      MapPublicIpOnLaunch: true
  RouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
  InternetRoute:
    Type: AWS::EC2::Route
    DependsOn: InternetGateway
    Properties:
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway
      RouteTableId: !Ref RouteTable
  SubnetARouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref RouteTable
      SubnetId: !Ref SubnetA
  InstanceSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: "Internet Group"
      GroupDescription: "SSH in, all traffic out."
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: '22'
          ToPort: '22'
          CidrIp:  !Sub ${WorkstationIp}/32
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
  ElasticIP:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc
      InstanceId: !Ref Linux
  Linux:
    Type: 'AWS::EC2::Instance'
    Properties:
      SubnetId: !Ref SubnetA
      ImageId: !FindInMap
        - RegionMap
        - !Ref 'AWS::Region'
        - ami
      InstanceType:
        Ref: InstanceTypeParameter
      KeyName: !Ref Key
      SecurityGroupIds:
        - Ref: InstanceSecurityGroup
      BlockDeviceMappings:
        - DeviceName: /dev/xvda
          Ebs:
            VolumeSize: 250
      Tags:
        - Key: Name
          Value: Linux Server

      UserData:
        Fn::Base64:
          Fn::Sub: |
            #cloud-boothook
            #!/bin/bash
            # Wait for network connectivity
            until ping -c1 www.google.com &amp;&gt;/dev/null; do
                echo "Waiting for network ..."
                sleep 1
            done
            # Update all packages
            sudo yum update -y
            # Install useful tools
            sudo yum install jq wget curl awscli -y
            # Install Kubernetes cli tools
            curl -o kubectl https://amazon-eks.s3.us-west-2.amazonaws.com/1.21.2/2021-07-05/bin/linux/amd64/kubectl
            chmod +x ./kubectl
            sudo mv kubectl /usr/local/bin
            curl -o aws-iam-authenticator https://amazon-eks.s3.us-west-2.amazonaws.com/1.21.2/2021-07-05/bin/linux/amd64/aws-iam-authenticator
            chmod +x ./aws-iam-authenticator
            sudo mv aws-iam-authenticator /usr/local/bin
            curl --silent --location "https://github.com/weaveworks/eksctl/releases/latest/download/eksctl_$(uname -s)_amd64.tar.gz" | tar xz -C /tmp
            sudo mv /tmp/eksctl /usr/local/bin
            # Install Linux Tentacle
            sudo wget https://rpm.octopus.com/tentacle.repo -O /etc/yum.repos.d/tentacle.repo
            sudo yum install tentacle -y
            sudo /opt/octopus/tentacle/Tentacle create-instance --instance "Tentacle" --config "/etc/octopus/Tentacle/tentacle-Tentacle.config"
            sudo /opt/octopus/tentacle/Tentacle new-certificate --instance "Tentacle" --if-blank
            sudo /opt/octopus/tentacle/Tentacle configure --instance "Tentacle" --app "/home/Octopus/Applications" --noListen "True" --reset-trust
            sudo /opt/octopus/tentacle/Tentacle register-worker --instance "Tentacle" --server "${OctopusURL}" --name "$(hostname)" --comms-style "TentacleActive" --server-comms-port "10943" --apiKey "${OctopusAPI}" --space "${OctopusSpace}" --workerpool "${OctopusWorkerPool}"
            sudo /opt/octopus/tentacle/Tentacle service --install --start --instance "Tentacle"
Outputs:
  PublicIp:
    Value:
      Fn::GetAtt:                          
        - Linux
        - PublicIp
    Description: Server's PublicIp Address
</code></pre>

<p>这个模板创建了许多资源，所以让我们来分解一下。</p>

<p>可用的实例类型在名为<code>InstanceType</code>的参数中定义。虽然工作人员通常不需要安装在高性能机器上，但不同EC2实例的网络功能可能需要选择特定的实例类型:</p>

<pre><code class="language-yaml">Parameters:
  InstanceTypeParameter:
    Type: String
    Default: t3a.medium
    AllowedValues:
    - c1.medium
    - c1.xlarge
    - c3.2xlarge
    # ...
</code></pre>

<p>为了增加安全性，只有您的本地工作站可以SSH到EC2实例。你可以<a href="https://www.google.com/search?q=what+is+my+ip" rel="nofollow">谷歌你的IP地址</a>并在<code>WorkstationIp</code>参数中定义它:</p>

<pre><code class="language-yaml">  WorkstationIp:
    Type: String
    Description: The IP address of the workstation that can RDP into the instance.
</code></pre>

<p>名为<code>Key</code>的参数定义了分配给EC2实例的SSH密钥。此CloudFormation模板不创建键，因此必须指定一个现有键:</p>

<pre><code class="language-yaml">  Key:
    Type: String
    Description: The key used to access the instance.
</code></pre>

<p>工人连接到的Octopus实例的URL在<code>OctopusURL</code>参数中定义。注意，这个模板创建了一个轮询工作器，这意味着Octopus实例必须是可公开访问的:</p>

<pre><code class="language-yaml">  OctopusURL:
    Type: String
    Description: The URL of the Octopus instance to connect to.
</code></pre>

<p>用于验证Octopus服务器的API密钥在<code>OctopusAPI</code>参数中定义:</p>

<pre><code class="language-yaml">  OctopusAPI:
    Type: String
    Description: The Octopus API key.
</code></pre>

<p>用于注册工人的Octopus空间在<code>OctopusSpace</code>参数中定义:</p>

<pre><code class="language-yaml">  OctopusSpace:
    Type: String
    Description: The Octopus space.
</code></pre>

<p>用于放置工人的工人池的名称在<code>OctopusWorkerPool</code>参数中定义:</p>

<pre><code class="language-yaml">  OctopusWorkerPool:
    Type: String
    Description: The Octopus worker pool.
</code></pre>

<p>AWS中的每个可用性区域都有自己唯一的AMI IDs。<code>Mappings</code>部分将<a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/ecs-optimized_AMI.html" rel="nofollow"> Amazon ECS优化的AMI </a>映射到每个地区。</p>

<p>您使用ECS优化的AMI，因为它已经安装了Docker，这对于在<a href="https://octopus.com/docs/projects/steps/execution-containers-for-workers">执行容器</a>中运行部署非常有用:</p>

<pre><code class="language-yaml">Mappings:
  RegionMap:
    eu-north-1:
      ami: ami-0f541966b45340fce
    ap-south-1:
      ami: ami-00c7dbcc1310fd066
    eu-west-3:
      ami: ami-0bce8e5f8fd912af2
    # ...
</code></pre>

<p>所有EC2实例必须放在一个虚拟私有云(VPC)中，用一个<a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-vpc.html" rel="nofollow"> AWS <span> EC2 </span> VPC </a>资源创建。</p>

<p>您定义了一个无类域间路由(CIDR)块<code>10.0.0.0/16</code>，这意味着分配给VPC的所有子网必须具有以<code>10.0</code>开头的IP地址:</p>

<pre><code class="language-yaml">  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      Tags:
        - Key: Name
          Value: Linux VPC
</code></pre>

<p>互联网网关提供与互联网之间的连接。它由<a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-internetgateway.html" rel="nofollow">AWS<span>EC2</span>internet gateway</a>资源表示:</p>

<pre><code class="language-yaml">  InternetGateway:
    Type: AWS::EC2::InternetGateway
</code></pre>

<p>互联网网关使用<a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-vpc-gateway-attachment.html" rel="nofollow">AWS<span>EC2</span>VPCGatewayAttachment</a>资源连接到VPC:</p>

<pre><code class="language-yaml">  VPCGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway
</code></pre>

<p>使用<a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-subnet.html" rel="nofollow"> AWS <span> EC2 </span>子网</a>资源将子网连接到VPC。通过使用<code>!Select</code>函数从<code>!GetAZs</code>数组返回第一个项目，可以避免对可用性区域进行硬编码。</p>

<p>CIDR块被设置为<code>10.0.0.0/24</code>，表示该子网中资源的IP地址都以<code>10.0.0</code>开头。将<code>MapPublicIpOnLaunch</code>设置为<code>true</code>意味着放置在该子网中的任何EC2实例都会收到一个动态的公共IP地址，允许您通过SSH访问它们:</p>

<pre><code class="language-yaml">  SubnetA:
    Type: AWS::EC2::Subnet
    Properties:
      AvailabilityZone: !Select 
        - 0
        - !GetAZs 
      VpcId: !Ref VPC
      CidrBlock: 10.0.0.0/24
      MapPublicIpOnLaunch: true
</code></pre>

<p>路由表定义了与该VPC相关的流量的网络规则，并由一个<a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-subnetroutetableassociation.html" rel="nofollow">AWS<span>EC2</span>route table</a>资源定义:</p>

<pre><code class="language-yaml">  RouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
</code></pre>

<p>外部互联网流量通过由<a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-route.html" rel="nofollow"> AWS <span> EC2 </span> Route </a>资源表示的路由被定向到互联网网关。CIDR块<code>0.0.0.0/0</code>匹配所有IPv4地址，这意味着此规则匹配所有未由处理VPC内部流量的默认规则配置的流量:</p>

<pre><code class="language-yaml">  InternetRoute:
    Type: AWS::EC2::Route
    DependsOn: InternetGateway
    Properties:
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway
      RouteTableId: !Ref RouteTable
</code></pre>

<p>路由表与使用<a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/Welcome.html" rel="nofollow">AWS<span>EC2</span>SubnetRouteTableAssociation</a>资源的子网相关联:</p>

<pre><code class="language-yaml">  SubnetARouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref RouteTable
      SubnetId: !Ref SubnetA
</code></pre>

<p>为了允许您的本地工作站SSH到EC2实例，一个安全组被配置为向来自您的本地IP地址的任何流量开放端口22。安全组还允许将流量发送到任何目的地。安全组由<a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-ec2-security-group.html" rel="nofollow">AWS<span>EC2</span>security group</a>资源表示。</p>

<p>因为您配置了轮询触手，它建立了从Worker到Octopus服务器的出站连接，所以不需要打开任何端口来允许从Octopus到EC2实例的流量。安全组允许Octopus服务器响应工人提出的请求。</p>

<p>如果您配置了一个监听触手，Octopus在那里建立了到Worker的网络连接，那么您必须向与您的托管实例相关联的<a href="https://octopus.com/docs/octopus-cloud/static-ip">静态IP列表或者您的自托管Octopus实例的IP地址打开端口10933。</a></p>

<p>不过，轮询触角更容易通过防火墙进行配置，这就是这里显示的解决方案:</p>

<pre><code class="language-yaml">  InstanceSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: "Internet Group"
      GroupDescription: "SSH in, all traffic out."
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: '22'
          ToPort: '22'
          CidrIp:  !Sub ${WorkstationIp}/32
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
</code></pre>

<p>为了方便起见，您可以为EC2实例分配一个静态(或弹性)IP地址。如果没有静态IP地址，EC2实例在关闭并再次启动时会收到一个新的随机公共IP地址。静态地址消除了在登录EC2之前确认IP地址的需要。</p>

<p>弹性IP地址由<a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-ec2-eip.html" rel="nofollow"> AWS <span> EC2 </span> EIP </a>资源表示:</p>

<pre><code class="language-yaml">  ElasticIP:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc
      InstanceId: !Ref Linux
</code></pre>

<p>前面所有的资源都需要为您提供一个放置EC2实例和配置其网络的位置。最后的资源是EC2实例本身，由<a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-ec2-instance.html" rel="nofollow"> AWS <span> EC2 </span>实例</a>资源表示。</p>

<p>该资源引用来自<code>Mappings</code>部分的AMI IDs，加入子网，链接到安全组，并使用SSH密钥进行配置。它还定义了一个比默认情况下提供的更大的硬盘:</p>

<pre><code class="language-yaml">  Linux:
    Type: 'AWS::EC2::Instance'
    Properties:
      SubnetId: !Ref SubnetA
      ImageId: !FindInMap
        - RegionMap
        - !Ref 'AWS::Region'
        - ami
      InstanceType:
        Ref: InstanceTypeParameter
      KeyName: !Ref Key
      SecurityGroupIds:
        - Ref: InstanceSecurityGroup
      BlockDeviceMappings:
        - DeviceName: /dev/xvda
          Ebs:
            VolumeSize: 250
      Tags:
        - Key: Name
          Value: Linux Server
</code></pre>

<p><a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/user-data.html" rel="nofollow">用户数据脚本</a>在提供实例后运行。在这里，您可以安装部署通常需要的任何专用工具，安装Octopus触手，并将触手配置为工作器。</p>

<p>需要注意的一个问题是，当执行这个脚本时，网络可能不可用。这已经在StackOverflow 上<a href="https://stackoverflow.com/questions/54050975/aws-ec2-yum-update-does-not-work-in-autoscaling-launchconfig-userdata" rel="nofollow">讨论过了。</a></p>

<p>为了确保任何后续命令都可以访问网络，您必须进入一个循环，等待ping一个已知且可靠的站点(如Google)成功:</p>

<pre><code class="language-yaml">      UserData:
        Fn::Base64:
          Fn::Sub: |
            #cloud-boothook
            #!/bin/bash
            # Wait for network connectivity
            until ping -c1 www.google.com &amp;&gt;/dev/null; do
                echo "Waiting for network ..."
                sleep 1
            done
</code></pre>

<p>应用所有操作系统更新，并安装AWS CLI、jq、wget和curl等常用工具:</p>

<pre><code class="language-yaml">            # Update all packages
            sudo yum update -y
            # Install useful tools
            sudo yum install jq wget curl awscli -y
</code></pre>

<p>部署到Kubernetes集群要求<code>kubectl</code>在<code>PATH</code>上可用。EKS集群需要一个名为<code>aws-iam-authenticator</code>的附加二进制文件来执行身份验证。<code>eksctl</code>工具提供了一种创建EKS集群的简单方法。这些可执行文件被下载并放置在path中，以便Octopus部署可以使用它们:</p>

<pre><code class="language-yaml">            # Install Kubernetes cli tools
            curl -o kubectl https://amazon-eks.s3.us-west-2.amazonaws.com/1.21.2/2021-07-05/bin/linux/amd64/kubectl
            chmod +x ./kubectl
            sudo mv kubectl /usr/local/bin
            curl -o aws-iam-authenticator https://amazon-eks.s3.us-west-2.amazonaws.com/1.21.2/2021-07-05/bin/linux/amd64/aws-iam-authenticator
            chmod +x ./aws-iam-authenticator
            sudo mv aws-iam-authenticator /usr/local/bin
            curl --silent --location "https://github.com/weaveworks/eksctl/releases/latest/download/eksctl_$(uname -s)_amd64.tar.gz" | tar xz -C /tmp
            sudo mv /tmp/eksctl /usr/local/bin
</code></pre>

<p>然后你安装章鱼触手:</p>

<pre><code class="language-yaml">            # Install Linux Tentacle
            sudo wget https://rpm.octopus.com/tentacle.repo -O /etc/yum.repos.d/tentacle.repo
            sudo yum install tentacle -y
</code></pre>

<p>然后部署一个Worker，以轮询模式连接到您的Octopus实例。</p>

<p>当您在Linux中手动配置一个触手时，显示了下面的脚本。要重新创建这些命令，请运行一个手动的触手安装，并复制根据您的输入生成的脚本输出:</p>

<pre><code class="language-yaml">            sudo /opt/octopus/tentacle/Tentacle create-instance --instance "Tentacle" --config "/etc/octopus/Tentacle/tentacle-Tentacle.config"
            sudo /opt/octopus/tentacle/Tentacle new-certificate --instance "Tentacle" --if-blank
            sudo /opt/octopus/tentacle/Tentacle configure --instance "Tentacle" --app "/home/Octopus/Applications" --noListen "True" --reset-trust
            sudo /opt/octopus/tentacle/Tentacle register-worker --instance "Tentacle" --server "${OctopusURL}" --name "$(hostname)" --comms-style "TentacleActive" --server-comms-port "10943" --apiKey "${OctopusAPI}" --space "${OctopusSpace}" --workerpool "${OctopusWorkerPool}"
            sudo /opt/octopus/tentacle/Tentacle service --install --start --instance "Tentacle"
</code></pre>

<p>输出捕获分配给EC2实例的公共静态IP地址:</p>

<pre><code class="language-yaml">Outputs:
  PublicIp:
    Value:
      Fn::GetAtt:                          
        - Linux
        - PublicIp
    Description: Server's PublicIp Address
</code></pre>

<p>在这个模板被部署之后，一个新的Worker出现在您的Octopus实例中，准备开始处理部署:</p>

<p><a href="#" data-featherlight="https://i.octopus.com/blog/2022-q2/creating-aws-cf-octopus-worker-cloudformation/octopus-worker.png" class="zoom" data-title=""><img src="../Images/f0459d7b26422abc5682c7995d3211c8.png" class="img-fluid center" alt="Octopus Worker" data-original-src="https://i.octopus.com/blog/2022-q2/creating-aws-cf-octopus-worker-cloudformation/octopus-worker.png"/>T2】</a></p>

<h2 id="conclusion">结论</h2>

<p>将Workers部署为EC2实例允许您将部署任务卸载到专用虚拟机，并且可以通过在更接近被修改的AWS资源的地方执行部署来提高部署的效率。</p>

<p>在本文中，您了解了一个CloudFormation模板，该模板在一个VPC中部署了一个EC2实例，该实例具有公共互联网访问权限，并且具有安装和配置Octopus触手作为工作器的初始化脚本。</p>

<p>我们还有其他关于云形成的帖子，你可能也会觉得有帮助。</p>

<p>阅读我们的<a href="https://octopus.com/blog/tag/Runbooks%20Series"> Runbooks系列</a>的其余部分。</p>

<p>愉快的部署！</p>

                    
                    
</body>
</html>