# 变量编辑器:旅程-章鱼部署

> 原文：<https://octopus.com/blog/variable-editor-improvements>

[![Octo-Scientist improving variables](img/9ea1e54f77b090f0958421349445a6ae.png)](#)

作为 Octopus 4.0 中 UI 改进的一部分，我们抓住机会[重新设计了变量编辑器](https://octopus.com/blog/octopus-v4-variable-editor)。这对我们的许多用户来说是一个痛点，也是一个强烈要求的改变。让我带您浏览一下我们对变量编辑器所做的更改！

## 旧的变量编辑器

变量编辑器过去看起来像这样:

[![Old Variable Editor](img/95287544d439be4ee2a8189b16c69d77.png)](#)

它是基于 [SlickGrid](https://github.com/mleibman/SlickGrid) 的，在重新设计的过程中，它有一些我们想要解决的问题:

*   没有对变量进行分组或排序。
*   通常需要两次点击来突出显示文本的一部分。
*   过滤器不容易被发现或应用。
*   有必要进入一个弹出窗口来编辑变量范围。

到目前为止，旧的变量编辑器最大的缺点是很难扩展。这是一个很少被关注的代码领域，任何改变都是有风险的。

## 新的变量编辑器

在 4.0 中，我们提供了新的变量编辑器。它看起来像这样:

[![Variable Editor - 4.0](img/1268d4cfeb26117fda309b584acaf61e.png)](#)

它在以下方面对旧的变量编辑器进行了改进:

*   一键聚焦和选择文本的能力。
*   变量按名称自动分组。
*   过滤器易于发现和使用。
*   可以在没有弹出窗口的情况下编辑范围。
*   向变量添加描述的能力。
*   使用虚拟化支持大量变量。

然而，这种实现仍然存在一些重大问题:

*   用户无法调整列的大小。
*   滚动时渲染很慢，让体验感觉反应迟钝。

我们决定不推迟发布 4.0 来修复这些问题，而是专注于尽快修复它们。

## 可调整大小的列

在旧的变量编辑器中，用户可以调整表列的大小。当您想要调整列的大小时，这对于长变量名或值非常有用，以便您可以看到更多信息。对于我们的许多用户来说，忽略这个特性是有问题的。新的变量编辑器中更大的字体使问题变得更糟，留下更少的空间来显示关键信息。

在 4.0.11 版本中，我们提供了一个变量编辑器，您可以在其中调整列的大小。

![Resizeable columns](img/45eaa2e35df9726624afb07e9d5e4cc4.png)

这些可调整大小的列是在 [react-dnd](https://github.com/react-dnd/react-dnd) 库的帮助下实现的，其工作原理是在调整大小后对列应用一个百分比宽度。与固定宽度相比，使用百分比宽度的优势在于，当用户调整浏览器窗口大小时，它会自动响应。

滚动是变量编辑器最初版本的一个大问题，它不仅仅影响大型变量集。

![Slow scrolling performance](img/40e6e508c85a0dcf261ce80b94fee87a.png)

问题是呈现一行是一个相对昂贵的操作。它昂贵的一个主要原因是因为我们在 Scope 列中使用的特定组件。需要测量这些芯片的宽度，以计算我们可以在可用空间中显示多少芯片。

该单元的每次渲染包括:

1.  渲染*所有*的筹码。
2.  测量所有芯片的*(这涉及到昂贵的浏览器回流)。*
3.  仅重新渲染我们可以在“显示更多”按钮旁边放置的芯片。

当变量编辑器中的每一行滚动到视图中时，都会发生这种情况，因为我们正在使用虚拟化，这是渲染缓慢的主要原因。这种方法的一种替代方法是不进行虚拟化而提前渲染所有行，但是这使得初始渲染非常慢。对于一个大的变量集，这变得非常慢，甚至比滚动性能更糟糕。

为了解决这个问题，我们对渲染和测量这些组件的方式进行了大量优化。我们比我们需要的更频繁地测量了许多东西，并且我们能够最小化一些回流的成本。这些变化最终对性能产生了显著的影响。

我们还发现，随着用户滚动，我们不必要地重新呈现了比我们需要的更多的组件。我们通过使用[不可变数据结构](https://reactjs.org/docs/optimizing-performance.html#using-immutable-data-structures)和在几个关键组件中实现 [shouldComponentUpdate](https://reactjs.org/docs/react-component.html#shouldcomponentupdate) ,专注于在滚动时只呈现最少的内容。

这些变化使得 Chrome 和 FireFox 的滚动性能都可以接受。

![Improved scrolling performance](img/93d01459e26f15c96e09c8af5462bf60.png)

IE11 和 Edge 似乎有不同的性能特征，我们仍然对这些浏览器的滚动性能不满意(尽管它现在的性能比以前明显好了)。到目前为止，我们还没有找出这些差异的根本原因，但这是一项正在进行的调查。目前，我们已经通过对较小的变量集禁用虚拟化来缓解这个问题，这些变量集可以在合理的时间内执行初始渲染。

## 延迟加载变量集

如果从项目中查看“库变量集”页面，您可以看到每个包含的库变量集中的变量集合，这些变量被分组到可扩展的部分中。

[![Library variable sets](img/cd6ca535f228ebca08c74aad135ed21c.png)](#)

加载此页面时，每个库变量集都是从单独的请求中从服务器加载的。如果您有大量的库变量集，那么这是有问题的，因为它可能会达到浏览器的请求限制，并且整个页面需要很长时间来加载。即使我们以更有效的方式加载库变量集，如果包含大量的库变量集，加载该页面的所有数据仍然需要很长时间。

我们决定更改在此页面上加载数据的方式，使其行为更像 Environments 页面，其中每个环境的内容仅在您展开该环境时加载。此外，我们通过向 API 添加一个新的端点来优化发出请求的方式，该端点允许您同时加载多个变量集。

所有变量的过滤都发生在客户端，所以我们仍然需要让用户能够搜索所有包含的变量集中的所有变量。幸运的是，我们在页面顶部有一个`Expand All`按钮，它有加载所有变量集的副作用。如果一个用户想要在所有的变量集中搜索一个特定的变量，那么他们可以首先搜索变量集的`Expand All`，然后应用他们的过滤器。

## 可变分组 UX

作为这一变化的一部分，我们希望改变用户对变量的思考方式。在旧的变量编辑器中，每个变量都有一个名称和值。如果您想在不同的范围(例如，不同的环境)中更改变量的值，那么您需要创建一个全新的变量，并确保它与另一个变量同名。

| 可变的 | 价值 | 范围 |
| --- | --- | --- |
| 网站端口 | 1000 | 发展 |
| 网站端口 | 2000 | 试验 |
| 网站端口 | 3000 | 生产 |

我们向用户介绍的新模型是一个变量可以有多个值。用户可以声明他们希望在不同的范围内使用哪些值。因为所有的值都与同一个变量相关联，所以它们在执行时将使用同一个变量名。

| 可变的 | 价值观念 |
| --- | --- |
| 网站端口 | (1000 用于开发)，(2000 用于测试)，(3000 用于生产) |

我们从改变 UI 来反映这个新模型开始，这意味着我们可以保持 API 的向后兼容性。这意味着我们只是在 UI 中按名称对变量进行分组，这让许多用户起初感到困惑。

【T2 ![Original variable groups](img/fff7ce3e4c04bc30aefdb2895177671b.png)

一个常见的抱怨是某些变量的名称丢失了。很容易理解为什么用户会这样认为，因为乍一看，新的变量编辑器和旧的变量编辑器之间的主要功能差异似乎是变量名有时会丢失。

我们在这个设计上迭代了几次，得出了一个新的设计，它强调我们显示了变量的多个值和范围。现在，对于每个有多个值的变量，变量编辑器中都有一个单独的“标题”行。这也解决了我们的另一个问题；我们现在有了一个合适的位置来放置一个溢出菜单，该菜单包含特定于整个变量的操作，而不是单个值。

[![Improved variable groups](img/b005ea491b38bf255ca390bfd7367270.png)](#)

## 变量警告

新的变量编辑器有许多不同的警告和消息，为用户提供更多关于变量状态的信息，并指导他们设计可维护的变量。

### 缺少变量范围

最初，我们想添加一个警告，当用户缺少特定范围的变量值时显示出来。例如，如果您有一个具有开发和测试值的变量，但没有生产值，那么您可能会认为在生产过程中部署会失败，因为缺少变量值。

[![Missing scope warning](img/01678780682033f5dc0712a9aba7e62e.png)](#)

这个警告最终变得过于复杂而难以实现。考虑这样一种情况，您有一个带有通道的项目，并且这些通道使用不同的生命周期。我们需要检查每个通道中的每个环境都有一个值。

当您考虑到有多种方法来确定变量值的范围，从而在每个可能的部署范围内产生一个有效值时，事情就变得更加复杂了。实现这一点的一种常见方法是使用单个未划分范围的值，该值适用于没有明确限定范围的值的任何环境。然而，还有其他方法可以达到同样的效果。例如，您可以拥有一个使用该变量的特定部署步骤的值，而不是一个未划分范围的值。

我们最终在变量编辑器的初始版本发布之前移除了这个特性，因为它被证明在不产生大量误报的情况下很难实现。

### 空值

我们提供了新的变量编辑器，能够在变量值为空时显示警告。

[![Empty value warning](img/4d5deee949d07759b18fc02cc595a34e.png)](#)

我们认为用户很少会真的想这么做。然而，比我们预期的更多的用户以有效的方式使用空值。对于这些用户来说，警告指示器最终是一个糟糕的视觉指示器。这让他们觉得自己做错了，也增加了很多视觉噪音。也没有办法抑制这个警告，这意味着他们将永远被一个无用的警告所困。我们仍然认为能够过滤没有值的变量值是有价值的，所以我们决定删除警告指示器。

[![Empty value without warning](img/bef740e569e59b161f48455ba14a0f51.png)](#)

## 新功能

作为我们在 2018.2 中对 AWS 支持的改进的一部分，我们添加了对 AWS 帐户的一级支持作为一种新类型的变量。使用新的变量编辑器，这是一个相对容易添加的扩展，其工作方式与证书相同。

[![AWS Account variables](img/de121c938eba5fb41634ce83f5d4767d.png)](#)

## 变量统一

我们开始考虑变量编辑器下一步的发展方向，我们正在考虑的下一个主要项目已经被内部命名为“变量统一”项目。

围绕这个项目的一部分将会涉及到什么，有一些想法，但是我们想做的一件事是在定义租户变量时重用变量编辑器。目前，我们正在使用一个定制的租户变量 UI 组件，但是我们没有理由不使用变量编辑器来代替它。这将解决 UI 这一部分的许多突出的性能和可用性问题。

我们还想重温变量模板的工作原理，以及我们如何改善变量体验，让用户相信他们已经为部署指定了所有正确的变量。作为其中的一部分，我们可能会更改我们的变量 API 来反映新的变量模型，其中一个变量可以包含多个值。事实上，我们刚刚完成了客户端代码的重构，这样它就可以一致地使用这个新的变量和值模型。

## 下一步是什么？

变量编辑器在过去的六个月里已经走过了很长的路，这感觉就像是它旅程的开始。您希望在变量编辑器的下一个版本中看到什么？